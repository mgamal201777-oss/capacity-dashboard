<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Partner Capacity Dashboard - Jan 2026 vs Feb 2026</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Custom Tooltip Styles */
        .kpi-tooltip-wrapper {
            position: relative;
            cursor: pointer;
        }
        .kpi-tooltip-wrapper .kpi-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            min-width: 280px;
            max-width: 320px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #f8fafc;
            padding: 14px 16px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.6;
            text-align: left;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
            z-index: 1000;
            transition: all 0.25s ease;
        }
        .kpi-tooltip-wrapper .kpi-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: #334155;
        }
        .kpi-tooltip-wrapper:hover .kpi-tooltip {
            visibility: visible;
            opacity: 1;
            bottom: calc(100% + 8px);
        }
        .kpi-tooltip .tooltip-title {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .kpi-tooltip .tooltip-calc {
            background: rgba(255,255,255,0.1);
            padding: 8px 10px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }
        .kpi-tooltip .tooltip-highlight {
            color: #fbbf24;
            font-weight: 600;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 20px 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1f4e78;
            margin-bottom: 5px;
        }

        .header-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            transition: border 0.2s;
        }

        .search-box:focus {
            border-color: #3b82f6;
        }

        .section-slicer-bar {
            display: none;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 12px;
            margin-top: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        .section-slicer-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 13px;
            margin-right: 4px;
        }

        .section-slicer-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #f8fafc;
            color: #1f2937;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .section-slicer-btn:hover {
            border-color: #3b82f6;
            color: #1d4ed8;
            background: #eff6ff;
        }

        .blurred-row {
            filter: blur(2px);
            opacity: 0.45;
            transition: filter 0.2s ease, opacity 0.2s ease;
        }

        .tooltip-btn {
            position: relative;
        }

        .tooltip-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 10px);
            transform: translateX(-50%);
            background: #0f172a;
            color: #f8fafc;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
        }

        .tooltip-btn::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: calc(100% + 2px);
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 50;
        }

        .tooltip-btn:hover::after,
        .tooltip-btn:hover::before {
            opacity: 1;
        }

        /* Card tooltips - allow text wrapping */
        .tooltip-card {
            position: relative;
        }
        .tooltip-card::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 8px);
            transform: translateX(-50%);
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            white-space: normal;
            width: max-content;
            max-width: 220px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.35);
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 100;
        }
        .tooltip-card::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: calc(100% + 0px);
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #7c3aed transparent transparent transparent;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 100;
        }
        .tooltip-card:hover::after,
        .tooltip-card:hover::before {
            opacity: 1;
        }

        /* Teal card tooltips for Riders Slab section */
        .tooltip-card-teal {
            position: relative;
        }
        .tooltip-card-teal::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 8px);
            transform: translateX(-50%);
            background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            white-space: normal;
            width: max-content;
            max-width: 220px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 8px 20px rgba(15, 118, 110, 0.35);
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 100;
        }
        .tooltip-card-teal::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: calc(100% + 0px);
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #0f766e transparent transparent transparent;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 100;
        }
        .tooltip-card-teal:hover::after,
        .tooltip-card-teal:hover::before {
            opacity: 1;
        }

        /* Sky card tooltips for Top/Bottom Partners section */
        .tooltip-card-sky {
            position: relative;
        }
        .tooltip-card-sky::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 8px);
            transform: translateX(-50%);
            background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
            white-space: normal;
            width: max-content;
            max-width: 220px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.35);
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 100;
        }
        .tooltip-card-sky::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: calc(100% + 0px);
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #0284c7 transparent transparent transparent;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 100;
        }
        .tooltip-card-sky:hover::after,
        .tooltip-card-sky:hover::before {
            opacity: 1;
        }

        .tooltip-btn-green::after {
            background: #065f46;
            box-shadow: 0 8px 18px rgba(6, 95, 70, 0.28);
        }

        .tooltip-btn-green::before {
            border-color: #065f46 transparent transparent transparent;
        }

        .tooltip-btn-blue::after {
            background: #1d4ed8;
            box-shadow: 0 8px 18px rgba(29, 78, 216, 0.28);
        }

        .tooltip-btn-blue::before {
            border-color: #1d4ed8 transparent transparent transparent;
        }

        .tooltip-btn-purple::after {
            background: #6d28d9;
            box-shadow: 0 8px 18px rgba(109, 40, 217, 0.28);
        }

        .tooltip-btn-purple::before {
            border-color: #6d28d9 transparent transparent transparent;
        }

        .tooltip-btn-teal::after {
            background: #0f766e;
            box-shadow: 0 8px 18px rgba(15, 118, 110, 0.28);
        }

        .tooltip-btn-teal::before {
            border-color: #0f766e transparent transparent transparent;
        }

        .tooltip-btn-sky::after {
            background: #0ea5e9;
            box-shadow: 0 8px 18px rgba(14, 165, 233, 0.28);
        }

        .tooltip-btn-sky::before {
            border-color: #0ea5e9 transparent transparent transparent;
        }

        .tabs {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0 30px;
            overflow-x: auto;
        }

        .tab-list {
            display: flex;
            gap: 20px;
            list-style: none;
            min-width: max-content;
        }

        .tab-item {
            padding: 16px 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-item:hover {
            color: #3b82f6;
        }

        .tab-item.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .content {
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .share-slicer-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.2s;
        }

        .share-slicer-btn.active {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.2);
        }

        .slab-slicer-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.2s;
        }

        .slab-slicer-btn.active {
            background: #1e5a8e;
            color: white;
            border-color: #1e5a8e;
            box-shadow: 0 4px 10px rgba(30, 90, 142, 0.2);
        }

        /* Slicer panel animations */
        .slicer-panel {
            animation: none;
        }
        .slicer-panel-animate {
            animation: slicerFadeIn 0.35s ease-out;
        }
        
        @keyframes slicerFadeIn {
            0% {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes slicerSlideIn {
            0% {
                opacity: 0;
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Tier Tables Slicer Button Styles */
        .tier-table-slicer-btn:hover {
            background: #e0e7ff !important;
            border-color: #818cf8 !important;
            color: #3730a3 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(79, 70, 229, 0.2);
        }
        .tier-table-slicer-btn.active {
            background: #1e3a8a !important;
            color: white !important;
            border-color: #1e3a8a !important;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.35);
        }

        /* Advanced Donut Meter Styles */
        .donut-meter-container {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 16px 22px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 20px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1), inset 0 2px 0 rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease, filter 0.4s ease;
            opacity: 0;
            transform: translateY(30px) scale(0.9);
        }
        .donut-meter-container.animate-in {
            animation: donutFlyIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes donutFlyIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.9); }
            60% { opacity: 1; transform: translateY(-8px) scale(1.03); }
            80% { transform: translateY(4px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .donut-meter-container:hover {
            transform: translateY(-4px) scale(1.02) !important;
            box-shadow: 0 12px 36px rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.9);
            opacity: 1 !important;
            filter: none !important;
        }
        .donut-meter-container.fr-theme {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .donut-meter-container.dc-theme {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        /* KPI Card PPT-style fly-in animation */
        .kpi-card-animated {
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            transition: all 0.3s ease;
        }
        .kpi-card-animated.fly-in {
            animation: kpiCardFlyIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes kpiCardFlyIn {
            0% { opacity: 0; transform: translateY(35px) scale(0.9); }
            60% { opacity: 1; transform: translateY(-10px) scale(1.04); }
            80% { transform: translateY(5px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .kpi-card-animated:hover {
            transform: translateY(-3px) scale(1.02) !important;
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }
        .donut-meter {
            position: relative;
            width: 100px;
            height: 100px;
            flex-shrink: 0;
        }
        .donut-meter svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .donut-meter .donut-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 7;
        }
        .donut-meter .donut-progress {
            fill: none;
            stroke-width: 7;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
            stroke-dashoffset: 87.96;
        }
        .donut-meter-container.animate-in .donut-progress {
            animation: donutProgress 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            animation-delay: 0.3s;
        }
        @keyframes donutProgress {
            from { stroke-dashoffset: 87.96; }
        }
        .donut-meter .donut-progress.fr-stroke {
            stroke: url(#frGradient);
        }
        .donut-meter .donut-progress.dc-stroke {
            stroke: url(#dcGradient);
        }
        .donut-meter .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .donut-meter .donut-value {
            font-size: 20px;
            font-weight: 800;
            color: #1f2937;
            line-height: 1;
        }
        .donut-meter .donut-label {
            font-size: 10px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 3px;
        }
        .donut-meter-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .donut-meter-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .donut-meter-title .kpi-badge {
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
        }
        .donut-meter-subtitle {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }
        .donut-dual-wrapper {
            display: flex;
            gap: 12px;
        }
        .donut-single {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .donut-single .donut-meter {
            width: 88px;
            height: 88px;
        }
        .donut-single .donut-sub-label {
            font-size: 10px;
            color: #6b7280;
            font-weight: 600;
        }

        /* Partner Age Table Row Focus Effect */
        #partnerAgeTable tbody tr {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #partnerAgeTable tbody tr:hover {
            background: #f0f9ff !important;
        }
        #partnerAgeTable tbody tr:hover td:first-child {
            background: #f0f9ff !important;
        }
        #partnerAgeTable.has-focus tbody tr {
            opacity: 0.35;
            filter: blur(1px);
        }
        #partnerAgeTable.has-focus tbody tr.row-focused {
            opacity: 1;
            filter: none;
            background: #dbeafe !important;
            box-shadow: 0 0 0 2px #3b82f6;
            position: relative;
            z-index: 1;
        }
        #partnerAgeTable.has-focus tbody tr.row-focused td:first-child {
            background: #dbeafe !important;
        }
        #partnerAgeTable tbody tr.row-focused td:first-child::before {
            content: '👉';
            position: absolute;
            left: -24px;
            font-size: 14px;
        }
        #partnerAgeTable tbody tr td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background: inherit;
        }
        #partnerAgeTable thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 12;
        }

        /* City-wise Table Row Focus Effect */
        #cityWiseTable tbody tr {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #cityWiseTable tbody tr:hover {
            background: #f0fdf4 !important;
        }
        #cityWiseTable.has-focus tbody tr {
            opacity: 0.35;
            filter: blur(1px);
        }
        #cityWiseTable.has-focus tbody tr.row-focused {
            opacity: 1;
            filter: none;
            background: #dcfce7 !important;
            box-shadow: 0 0 0 2px #22c55e;
            position: relative;
            z-index: 1;
        }
        #cityWiseTable tbody tr.row-focused td:first-child::before {
            content: '👉';
            position: absolute;
            left: -24px;
            font-size: 14px;
        }
        #cityWiseTable tbody tr td:first-child {
            position: relative;
        }

        .slab-table-increased span {
            background: transparent !important;
            color: #059669 !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-weight: 700 !important;
        }

        .slab-table-decreased span {
            background: transparent !important;
            color: #dc2626 !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-weight: 700 !important;
        }

        /* Ensure tab content stays centered */
        .tab-content {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Framework & Methodology - Advanced Layout */
        .framework-hero {
            background: linear-gradient(135deg, #1e3a8a 0%, #6d28d9 100%);
            border-radius: 16px;
            padding: 22px 24px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            box-shadow: 0 10px 24px rgba(30, 58, 138, 0.25);
            margin-bottom: 16px;
        }
        .framework-hero-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .framework-hero-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }
        .framework-hero-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .framework-pill {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .framework-grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin: 14px 0 18px;
        }
        .framework-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }
        .framework-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .framework-card h4 {
            margin: 0 0 8px;
            font-size: 13px;
            color: #111827;
        }
        .framework-card p {
            margin: 0;
            font-size: 12px;
            color: #4b5563;
            line-height: 1.6;
        }
        .framework-card ul {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
            color: #4b5563;
            line-height: 1.7;
        }
        .framework-card.accent-blue {
            border-top: 3px solid #3b82f6;
            background: #eff6ff;
        }
        .framework-card.accent-teal {
            border-top: 3px solid #14b8a6;
            background: #ecfeff;
        }
        .framework-card.accent-amber {
            border-top: 3px solid #f59e0b;
            background: #fff7ed;
        }
        .framework-card.accent-emerald {
            border-top: 3px solid #10b981;
            background: #ecfdf5;
        }
        .framework-chip-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .framework-chip {
            background: #dcfce7;
            color: #166534;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 999px;
        }
        .framework-flow {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 18px;
        }
        .flow-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }
        .flow-title {
            font-size: 14px;
            font-weight: 800;
            color: #4c1d95;
        }
        .flow-subtitle {
            font-size: 11px;
            color: #6b7280;
        }
        .flow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
        }
        .flow-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .flow-card.accent-purple {
            border-left: 4px solid #8b5cf6;
        }
        .flow-step {
            font-size: 11px;
            font-weight: 700;
            color: #6d28d9;
            margin-bottom: 6px;
        }
        .flow-text {
            font-size: 12px;
            color: #374151;
            line-height: 1.5;
        }
        /* Advanced Flow Chart Styles */
        .flow-timeline {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            margin: 20px 0;
            position: relative;
        }
        .flow-timeline-item {
            flex: 1;
            min-width: 160px;
            max-width: 220px;
            position: relative;
            padding: 0 8px;
        }
        .flow-timeline-item::after {
            content: '→';
            position: absolute;
            right: -8px;
            top: 28px;
            font-size: 20px;
            color: #a78bfa;
            font-weight: 700;
            z-index: 2;
        }
        .flow-timeline-item:last-child::after {
            display: none;
        }
        .flow-step-card {
            background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%);
            border: 2px solid #c4b5fd;
            border-radius: 14px;
            padding: 16px;
            position: relative;
            transition: all 0.3s ease;
            height: 100%;
        }
        .flow-step-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.25);
            border-color: #8b5cf6;
        }
        .flow-step-num {
            position: absolute;
            top: -12px;
            left: 16px;
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.4);
        }
        .flow-step-title {
            font-size: 13px;
            font-weight: 700;
            color: #5b21b6;
            margin: 8px 0 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .flow-step-desc {
            font-size: 12px;
            color: #4c1d95;
            line-height: 1.6;
        }
        .flow-callouts-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .flow-callout-advanced {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 14px;
            padding: 18px 20px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
            transition: all 0.3s ease;
        }
        .flow-callout-advanced:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.25);
        }
        .flow-callout-advanced.red {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }
        .flow-callout-advanced.red:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.25);
        }
        .flow-callout-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        .flow-callout-advanced .flow-callout-icon {
            background: rgba(245, 158, 11, 0.2);
        }
        .flow-callout-advanced.red .flow-callout-icon {
            background: rgba(239, 68, 68, 0.2);
        }
        .flow-callout-content h4 {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin: 0 0 6px;
        }
        .flow-callout-advanced.red .flow-callout-content h4 {
            color: #991b1b;
        }
        .flow-callout-content p {
            font-size: 13px;
            color: #78350f;
            line-height: 1.6;
            margin: 0;
        }
        .flow-callout-advanced.red .flow-callout-content p {
            color: #7f1d1d;
        }
        .framework-footer-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .framework-footer-card-advanced {
            background: white;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .framework-footer-card-advanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        .framework-footer-card-advanced.blue::before {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
        }
        .framework-footer-card-advanced.green::before {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }
        .framework-footer-card-advanced.purple::before {
            background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%);
        }
        .framework-footer-card-advanced:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }
        .framework-footer-card-advanced .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 14px;
        }
        .framework-footer-card-advanced.blue .card-icon { background: #dbeafe; }
        .framework-footer-card-advanced.green .card-icon { background: #d1fae5; }
        .framework-footer-card-advanced.purple .card-icon { background: #ede9fe; }
        .framework-footer-card-advanced h4 {
            margin: 0 0 10px;
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
        }
        .framework-footer-card-advanced p {
            margin: 0 0 12px;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.7;
        }
        .framework-footer-card-advanced .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .framework-footer-card-advanced .card-tag {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .framework-footer-card-advanced.blue .card-tag { background: #dbeafe; color: #1e40af; }
        .framework-footer-card-advanced.green .card-tag { background: #d1fae5; color: #065f46; }
        .framework-footer-card-advanced.purple .card-tag { background: #ede9fe; color: #5b21b6; }

        /* Executive Summary - Advanced Layout */
        .exec-hero {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #312e81 100%);
            border-radius: 16px;
            padding: 24px 28px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
            margin-bottom: 20px;
        }
        .exec-hero-left h1 {
            font-size: 24px;
            font-weight: 800;
            margin: 0 0 6px;
        }
        .exec-hero-left p {
            font-size: 13px;
            opacity: 0.85;
            margin: 0;
        }
        .exec-hero-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .exec-hero-stat {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            min-width: 100px;
        }
        .exec-hero-stat .value {
            font-size: 22px;
            font-weight: 800;
        }
        .exec-hero-stat .label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .exec-hero-stat.negative .value { color: #fca5a5; }
        .exec-hero-stat.positive .value { color: #86efac; }
        .exec-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        .exec-kpi-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .exec-kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .exec-kpi-card.blue { border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
        .exec-kpi-card.green { border-left-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        .exec-kpi-card.red { border-left-color: #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        .exec-kpi-card.amber { border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
        .exec-kpi-card.purple { border-left-color: #8b5cf6; background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%); }
        .exec-kpi-card.teal { border-left-color: #14b8a6; background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); }
        .exec-kpi-card .icon { font-size: 20px; margin-bottom: 8px; }
        .exec-kpi-card .value { font-size: 26px; font-weight: 800; color: #1f2937; margin-bottom: 4px; }
        .exec-kpi-card .label { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; }
        .exec-kpi-card .change { font-size: 12px; margin-top: 6px; font-weight: 600; }
        .exec-kpi-card .change.up { color: #059669; }
        .exec-kpi-card .change.down { color: #dc2626; }
        .exec-section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .exec-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        .exec-card h3 {
            font-size: 15px;
            font-weight: 700;
            margin: 0 0 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .exec-card ul {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            line-height: 1.9;
            color: #374151;
        }
        .exec-card ul li strong { color: #111827; }
        .exec-card.strategy { border-top: 4px solid #f59e0b; background: linear-gradient(180deg, #fffbeb 0%, white 30%); }
        .exec-card.strategy h3 { color: #92400e; }
        .exec-card.highlights { border-top: 4px solid #10b981; background: linear-gradient(180deg, #ecfdf5 0%, white 30%); }
        .exec-card.highlights h3 { color: #065f46; }
        .exec-card.concerns { border-top: 4px solid #ef4444; background: linear-gradient(180deg, #fef2f2 0%, white 30%); }
        .exec-card.concerns h3 { color: #991b1b; }
        .exec-card.targets { border-top: 4px solid #8b5cf6; background: linear-gradient(180deg, #faf5ff 0%, white 30%); }
        .exec-card.targets h3 { color: #5b21b6; }
        .exec-mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        .exec-mini-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .exec-mini-card .num { font-size: 20px; font-weight: 800; color: #1e293b; }
        .exec-mini-card .txt { font-size: 10px; color: #64748b; margin-top: 4px; text-transform: uppercase; }
        .exec-footer-note {
            background: linear-gradient(135deg, #1e3a5f 0%, #312e81 100%);
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            font-size: 13px;
            line-height: 1.7;
            margin-top: 20px;
        }
        .exec-footer-note strong { color: #fcd34d; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Success Metrics Toggle Animations */
        .success-metrics-toggle {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .success-metrics-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }
        .success-metrics-toggle.active {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.35);
        }

        @keyframes metricsSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes metricsFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .metrics-animate-in {
            animation: metricsSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .metrics-fade-in {
            animation: metricsFadeIn 0.4s ease-out forwards;
        }

        .summary-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .summary-header {
            background: #1e5a8e;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            text-align: center;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            border-bottom: 2px solid #1e5a8e;
        }

        .summary-cell {
            padding: 20px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-cell:last-child {
            border-right: none;
        }

        .summary-label {
            font-size: 13px;
            color: white;
            background: #1e5a8e;
            padding: 8px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
        }

        .summary-value.negative {
            color: #dc2626;
        }

        .summary-value.positive {
            color: #059669;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 14px;
        }

        .kpi-card {
            background: white;
            border-radius: 10px;
            padding: 14px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .kpi-card.warning {
            border-left-color: #f59e0b;
        }

        .kpi-card.danger {
            border-left-color: #ef4444;
        }

        .kpi-card.success {
            border-left-color: #10b981;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .kpi-title {
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            font-size: 24px;
            opacity: 0.3;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .kpi-subtitle {
            color: #6b7280;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-subtitle.positive {
            color: #10b981;
        }

        .kpi-subtitle.negative {
            color: #ef4444;
        }

        .kpi-subtitle.neutral {
            color: #0ea5e9;
            font-weight: 700;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(420px, 1fr));
            grid-auto-flow: row;
            align-items: stretch;
            gap: 14px;
            margin-bottom: 16px;
        }

        @media (max-width: 1100px) {
            .chart-grid {   
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }

        .compliance-charts-frame {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            padding: 0;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #1e7e34;
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
        }

        tr:hover {
            background: #f9fafb;
        }

        .city-table-highlight td {
            color: #0f172a;
        }

        .city-table-highlight td:nth-child(6),
        .city-table-highlight td:nth-child(7) {
            font-weight: 700;
        }

        .city-table-highlight .total-row {
            background: #e0f2fe;
            font-weight: 700;
        }

        .city-table-highlight .total-row td {
            color: #0b3a63;
        }

        .pct-positive {
            color: #059669;
            font-weight: 700;
        }

        .pct-negative {
            color: #dc2626;
            font-weight: 700;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .executive-section {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .executive-section h2 {
            font-size: 26px;
            color: #1e7e34;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .exec-summary-hero {
            margin-bottom: 24px;
        }

        .exec-summary-title {
            font-size: 18px;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .exec-summary-subtitle {
            font-size: 12px;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 14px;
        }

        .exec-section-title {
            font-size: 13px;
            color: #1f4e78;
            font-weight: 700;
            margin: 16px 0 10px;
        }

        .exec-donut-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 6px;
        }

        .exec-donut-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 14px;
            text-align: center;
            min-width: 180px;
            flex: 1 1 180px;
        }

        .exec-donut {
            width: 86px;
            height: 86px;
            border-radius: 50%;
            background: conic-gradient(#22c55e calc(var(--p) * 1%), #e5e7eb 0);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            position: relative;
        }

        .exec-donut::after {
            content: '';
            width: 62px;
            height: 62px;
            background: #ffffff;
            border-radius: 50%;
            position: absolute;
        }

        .exec-donut-value {
            position: relative;
            z-index: 1;
            font-size: 14px;
            font-weight: 800;
            color: #0f172a;
        }

        .exec-donut-text {
            font-size: 11px;
            color: #475569;
            line-height: 1.35;
        }

        .info-box {
            border-left: 6px solid #10b981;
            background: #d1fae5;
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #065f46;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .info-box ul {
            list-style: none;
            color: #047857;
        }

        .info-box li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .info-box li:before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .warning-box {
            border-left: 6px solid #f59e0b;
            background: #fef3c7;
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: #92400e;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .warning-box ul {
            list-style: none;
            color: #78350f;
        }

        .warning-box li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .warning-box li:before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .action-box {
            border-left: 6px solid #3b82f6;
            background: #dbeafe;
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .action-box h3 {
            color: #1e40af;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .action-box ol {
            list-style: none;
            counter-reset: item;
            color: #1e3a8a;
        }

        .action-box li {
            margin-bottom: 10px;
            padding-left: 30px;
            position: relative;
        }

        .action-box li:before {
            content: counter(item) ".";
            counter-increment: item;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .highlight-box {
            border-left: 6px solid #10b981;
            background: #d1fae5;
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .highlight-box h3 {
            color: #065f46;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .highlight-box ul {
            list-style: none;
            color: #047857;
        }

        .highlight-box li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .highlight-box li:before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .lowlight-box {
            border-left: 6px solid #dc2626;
            background: #fee2e2;
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .lowlight-box h3 {
            color: #991b1b;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .lowlight-box ul {
            list-style: none;
            color: #7f1d1d;
        }

        .lowlight-box li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .lowlight-box li:before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            padding: 25px;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
            background: white;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        #leftChartCards, #rightChartCards {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (max-width: 680px) {
            #leftChartCards, #rightChartCards {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
            }
            #leftChartCards > div, #rightChartCards > div {
                padding: 6px 8px !important;
            }
            #leftChartCards > div > div:nth-child(2),
            #rightChartCards > div > div:nth-child(2) {
                font-size: 14px !important;
            }
        }
    

/* Compact tables for wide datasets */
.compact-table { table-layout: fixed; }
.compact-table th, .compact-table td { padding: 10px 12px; white-space: normal; word-break: break-word; }
/* For tables that require the Status column to stay on one line without clipping,
   wrap the table in a div.table-container.nowrap-table and add class nowrap-status
   to the table. This keeps other tables unchanged. */
.nowrap-table { overflow: auto; }
.nowrap-table table.nowrap-status { table-layout: auto; }
.nowrap-table table.nowrap-status th:last-child,
.nowrap-table table.nowrap-status td:last-child {
    white-space: nowrap;
    word-break: normal;
}

/* Terminated Partners Table - Professional Column Widths */
.terminated-table {
    table-layout: fixed;
    width: 100%;
}
.terminated-table th:nth-child(1),
.terminated-table td:nth-child(1) { width: 15%; }
.terminated-table th:nth-child(2),
.terminated-table td:nth-child(2) { width: 20%; }
.terminated-table th:nth-child(3),
.terminated-table td:nth-child(3) { width: 12%; }
.terminated-table th:nth-child(4),
.terminated-table td:nth-child(4) { width: 26%; }
.terminated-table th:nth-child(5),
.terminated-table td:nth-child(5) { width: 27%; }

        /* Monthly insights (new tab) */
        .month-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .month-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            outline: none;
        }
        .month-select:focus {
            border-color: #3b82f6;
        }

        .chart-info-panel {
            margin-top: 10px;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 12px;
            color: #1f2937;
        }
        .chart-info-title {
            font-weight: 700;
            margin-bottom: 6px;
            color: #1e40af;
        }
        .chart-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 3px 0;
        }
        .chart-info-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chart-info-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            display: inline-block;
        }
        .chart-info-empty {
            color: #6b7280;
            font-style: italic;
        }
        .chart-toggle {
            display: flex;
            gap: 8px;
            margin: 8px 0 10px 0;
        }
        .chart-toggle-btn {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #374151;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .chart-toggle-btn.active {
            background: #1e40af;
            border-color: #1e40af;
            color: #ffffff;
        }

                /* Subtle badge for Overall = 100% */
                .overall-badge {
                    display: inline-block;
                    margin-left: 6px;
                    padding: 2px 6px;
                    font-size: 12px;
                    line-height: 1;
                    border-radius: 9999px;
                    background: #f3f4f6; /* gray-100 */
                    color: #6b7280;      /* gray-500 */
                    border: 1px solid #e5e7eb; /* gray-200 */
                    font-weight: 600;
                }

</style>
</head>
<body>
    <script>
        (function () {
            const PASSCODE = "71290";
            document.documentElement.style.visibility = "hidden";
            const entered = prompt("Enter passcode:");
            if (entered !== PASSCODE) {
                document.documentElement.innerHTML = "<head><title>Access denied</title></head><body style='font-family: Arial, sans-serif; padding: 40px; background: #f9fafb; color: #1f2937;'><h2>Access denied</h2><p>Incorrect passcode.</p></body>";
                if (window.stop) window.stop();
                return;
            }
            document.documentElement.style.visibility = "visible";
        })();
    </script>
<div class="header">
<h1>Partner Capacity Dashboard</h1>
<div class="header-subtitle">January 2026 vs February 2026 Analysis</div>
<div class="header-buttons">
<button class="btn" onclick="window.print()">
<span>🖨️</span> Print
            </button>
<button class="btn" onclick="exportToCSV()">
<span>📥</span> Export CSV
            </button>
</div>
<div id="monthOverviewSlicer" class="section-slicer-bar">
    <span class="section-slicer-title">Jump to section:</span>
    <button class="section-slicer-btn" data-target="monthOverviewPerformanceBreakdown">📈 Performance Breakdown</button>
    <button class="section-slicer-btn" data-target="monthOverviewPerfScale">📌 Performance &amp; Scale Summary</button>
    <button class="section-slicer-btn" data-target="monthOverviewFrDc">📊 FR &amp; Driver Card Compliance</button>
    <button class="section-slicer-btn" data-target="monthOverviewCityTier">🏙️ City Tier Performance</button>
    <button class="section-slicer-btn" data-target="monthOverviewTargetMovement">🎯 Target Movement Analysis</button>
    <button class="section-slicer-btn" data-target="monthOverviewTopBottom">📌 Top &amp; Bottom Partners Overview</button>
    <button class="section-slicer-btn" data-target="monthOverviewSuccessMetrics">✅ February 2026 Success Metrics</button>
</div>
<div id="monthlyInsightsSlicer" class="section-slicer-bar">
    <span class="section-slicer-title">Jump to section:</span>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="monthlyOverviewSection">📊 Monthly Overview &amp; Trends</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="vehicleTypeMonthlySection">🚗🏍️ Vehicle Type Breakdown</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="partnerMovementSection">📊 Partner Movement Analysis</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="partnerAgeSection">👥 New vs Old Partners Analysis</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="cityWiseSection">🏙️ City-wise Target Distribution</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="tierCitySection">📊 Tier City Overview (T1 vs T2)</button>
    <button class="section-slicer-btn monthly-slicer-btn" data-target="monthlyWillingSection">📊 Partner Willing Analysis</button>
</div>
</div>
<div class="tabs">
<ul class="tab-list">
<li class="tab-item active" onclick="switchTab('executive', this)">📋 Executive Summary</li>
<li class="tab-item" onclick="switchTab('framework', this)">🔬 Framework &amp; Methodology</li>
<li class="tab-item" onclick="switchTab('overview', this)">📊 Month Overview</li>
<li class="tab-item" onclick="switchTab('monthly', this)">🗓️ Monthly Insights (6 Months Overview)</li>
<li class="tab-item" onclick="switchTab('adjustment', this)">🔧 Target Adjustment Analysis</li>
<li class="tab-item" onclick="switchTab('strategy', this)">🎯 Future Strategy &amp; Roadmap</li>
<li class="tab-item" onclick="switchTab('dailyView', this)">📊 Capacity Achievement "Daily View"</li>
</ul>
</div>
<div class="content">
<!-- FRAMEWORK & METHODOLOGY TAB -->
<div class="tab-content" id="framework">
<h2 style="margin-bottom: 25px; color: #1f4e78; font-size: 26px;">📋 Framework &amp; Methodology</h2>
<div class="framework-hero">
    <div>
        <div class="framework-hero-title">Framework &amp; Methodology</div>
        <div class="framework-hero-subtitle">How monthly capacity targets are built, protected, and aligned.</div>
    </div>
    <div class="framework-hero-pills">
        <span class="framework-pill">Model: Multi-layer rules</span>
        <span class="framework-pill">Cycle: Jan -> Feb</span>
        <span class="framework-pill">Signals: Perf + FR + Ops</span>
    </div>
</div>

<div class="framework-grid-3">
    <div class="framework-card accent-blue">
        <h4>Background</h4>
        <p>Targets are built monthly to match demand, protect quality, and keep partner capacity healthy using performance and compliance signals.</p>
    </div>
    <div class="framework-card accent-teal">
        <h4>Context (Feb 2026)</h4>
        <p>Stabilize good partners, reduce more from average/bad, protect new partners, and allow limited PMM exceptions.</p>
    </div>
    <div class="framework-card accent-amber">
        <h4>Challenges</h4>
        <p>Keep good partner capacity stable with a 13% overall cut; driver card constraints shift some share to average/bad.</p>
    </div>
</div>

<div class="framework-grid-2">
    <div class="framework-card accent-emerald">
        <h4>Strategic Goals</h4>
        <div class="framework-chip-row">
            <span class="framework-chip">Demand Coverage</span>
            <span class="framework-chip">Quality &amp; Compliance</span>
            <span class="framework-chip">Risk Mitigation</span>
            <span class="framework-chip">Budget Adherence</span>
        </div>
    </div>
    <div class="framework-card">
        <h4>Model Layers</h4>
        <p>Baseline (size, performance, FR) -> New Partner Protection -> Termination/Blocking -> Quality Brakes -> Manual Adjustment.</p>
    </div>
</div>

<div class="framework-flow">
    <div class="flow-header">
        <div class="flow-title">Calculation Flow (Feb) <span style="font-size: 0.65em; font-weight: 500; margin-left: 24px; color: #475569;">For more info about the rules check out this link</span> <a href="https://km.sankuai.com/collabpage/2747350482" target="_blank" style="font-size: 0.6em; font-weight: 700; color: #7c3aed; text-decoration: none; margin-left: 10px; padding: 8px 18px; background: linear-gradient(90deg, #f3e8ff 0%, #ede9fe 100%); border-radius: 8px; transition: all 0.2s; border: 1px solid #c4b5fd; display: inline-flex; align-items: center; gap: 6px;">Capacity target rules details <span style="font-size: 1.1em;">→</span></a></div>
        <div class="flow-subtitle">Short, auditable path from Jan baseline to Feb targets</div>
    </div>
    <!-- Advanced Flow Timeline -->
    <div class="flow-timeline">
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">1</div>
                <div class="flow-step-title">📍 Start Point</div>
                <div class="flow-step-desc">Jan final target per partner serves as the baseline for Feb calculations.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">2</div>
                <div class="flow-step-title">⚙️ Base Multipliers</div>
                <div class="flow-step-desc">Performance, FR%, and ops factors reduce low performers and protect high performers.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">3</div>
                <div class="flow-step-title">🛡️ Protected Partners</div>
                <div class="flow-step-desc">≤1 month: T1 min 20, T2 min 15 (18 partners). &lt;3 months: min by tier (150 partners). Zero after factors → restore safe minimum.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">4</div>
                <div class="flow-step-title">⚠️ Term & Warnings</div>
                <div class="flow-step-desc">Terminated = 0 (3 partners). Warning letters (34): Bad/Avg → 50% of Jan, Good → 90%.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">5</div>
                <div class="flow-step-title">📸 FR% Fine-Tune</div>
                <div class="flow-step-desc">Apply FR% slabs by performance tier to fine-tune output and reward compliance.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">6</div>
                <div class="flow-step-title">✏️ Manual Override</div>
                <div class="flow-step-desc">PMM/ops exceptions for contracts, launches, staffing, or data issues.</div>
            </div>
        </div>
        <div class="flow-timeline-item">
            <div class="flow-step-card">
                <div class="flow-step-num">7</div>
                <div class="flow-step-title">🎯 Align to Feb Plan</div>
                <div class="flow-step-desc">Scale to Feb national total, then apply city-level scaling factors.</div>
            </div>
        </div>
    </div>

    <!-- Advanced Callouts -->
    <div class="flow-callouts-advanced">
        <div class="flow-callout-advanced red">
            <div class="flow-callout-icon">🚫</div>
            <div class="flow-callout-content">
                <h4>Compliance Blocked Riders</h4>
                <p>Waiting for final list from compliance team. PMMs confirm recovery plans; actions follow on flagged risks. Critical for maintaining fleet quality standards.</p>
            </div>
        </div>
        <div class="flow-callout-advanced">
            <div class="flow-callout-icon">🪪</div>
            <div class="flow-callout-content">
                <h4>Driver Card Slab</h4>
                <p>Not a core factor (overall rate 40.5%). Used to keep targets stable with smaller cuts for good/average partners >80%. Ensures compliance-ready capacity.</p>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Footer Cards -->
<div class="framework-footer-advanced">
    <div class="framework-footer-card-advanced blue">
        <div class="card-icon">🏗️</div>
        <h4>Model Structure</h4>
        <p>Baseline + protection + controls + manual review produce explainable targets per partner and city. Transparent, auditable, and defensible.</p>
        <div class="card-tags">
            <span class="card-tag">Baseline</span>
            <span class="card-tag">Protection</span>
            <span class="card-tag">Controls</span>
        </div>
    </div>
    <div class="framework-footer-card-advanced green">
        <div class="card-icon">🔄</div>
        <h4>Flexibility</h4>
        <p>Monthly tuning of coefficients and thresholds keeps alignment with CPO, service, and partner mix goals. Adapts to market conditions.</p>
        <div class="card-tags">
            <span class="card-tag">Monthly Tuning</span>
            <span class="card-tag">CPO Alignment</span>
            <span class="card-tag">Adaptive</span>
        </div>
    </div>
    <div class="framework-footer-card-advanced purple">
        <div class="card-icon">🔐</div>
        <h4>Governance</h4>
        <p>Manual overrides are limited and audited to keep results consistent and defensible. SOP + maker/checker ensures accountability.</p>
        <div class="card-tags">
            <span class="card-tag">Audit Trail</span>
            <span class="card-tag">Maker/Checker</span>
            <span class="card-tag">SOP</span>
        </div>
    </div>
</div>
</div>
<!-- OVERVIEW TAB -->
<div class="tab-content" id="overview">
<h2 style="margin-bottom: 12px; color: #1f4e78; font-size: 20px;">Business Metrics Dashboard</h2>

<!-- Executive Briefing — Collapsed Side-by-Side Cards -->
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
  <div style="display: flex; align-items: center; gap: 8px;">
    <span style="font-size: 15px;">📊</span>
    <span style="font-size: 13px; font-weight: 700; color: #475569;">Executive Briefing</span>
    <span id="briefingAutoLabel" style="font-size: 9px; font-weight: 600; color: #6366f1; background: #eef2ff; padding: 2px 8px; border-radius: 10px; animation: briefingPulse 2s ease-in-out infinite;">● AUTO</span>
  </div>
  <button id="briefingPinBtn" onclick="pinBriefingCards()" style="display: flex; align-items: center; gap: 6px; padding: 5px 14px; border: 1.5px solid #cbd5e1; border-radius: 8px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); color: #475569; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none;" onmouseover="this.style.borderColor='#94a3b8'; this.style.background='linear-gradient(135deg, #f1f5f9, #e2e8f0)'" onmouseout="if(!window._briefingPinned){this.style.borderColor='#cbd5e1'; this.style.background='linear-gradient(135deg, #f8fafc, #f1f5f9)'}">
    <span id="briefingPinIcon" style="font-size: 12px;">📌</span>
    <span id="briefingPinText">Keep Open</span>
  </button>
</div>
<style>
@keyframes briefingPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
</style>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">

  <!-- Card 1: Highlights, Lowlights & Notes -->
  <div id="highlightsCard" style="border-radius: 14px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1.5px solid #e0e7ef; background: #fff;">
        <div id="highlightsHeader" onclick="toggleBriefingCards()" style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #1e40af 100%); padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; user-select: none;">
      <span id="highlightsArrow" style="width: 28px; height: 28px; background: rgba(255,255,255,0.13); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0; color: white; font-weight: 700; transition: transform 0.3s;">▶</span>
      <span style="color: white; font-size: 14px; font-weight: 700; flex: 1;">📋 Highlights, Lowlights & Notes</span>
      <span id="highlightsBadge" style="color: rgba(255,255,255,0.45); font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 20px; transition: all 0.2s;">Expand ▾</span>
    </div>
    <div id="highlightsBody" style="max-height: 0; overflow: hidden;">
      <div style="padding: 18px 20px 20px; background: linear-gradient(180deg, #f8fafc, #ffffff);">

      <!-- Notes Section -->
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 26px; height: 26px; background: linear-gradient(135deg, #6366f1, #818cf8); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px;">📌</span>
          <span style="font-size: 13px; font-weight: 700; color: #312e81;">Need to Know</span>
        </div>
        <div data-i18n-html="notes-content" style="background: #eef2ff; border-left: 3px solid #6366f1; border-radius: 0 8px 8px 0; padding: 10px 14px; font-size: 11.5px; color: #3730a3; line-height: 1.65;">
          <div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 5px;">
            <span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span>
            <span>Dashboard reflects <strong>first version</strong> of capacity target — mid-month adjustments may apply.</span>
          </div>
          <div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 5px;">
            <span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span>
            <span>Partner data is based on <strong>last week of prior month</strong> (e.g., Feb target uses late-Jan active partner data).</span>
          </div>
          <div style="display: flex; align-items: flex-start; gap: 6px;">
            <span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span>
            <span>Performance MoM comparison is <strong>target vs. target</strong>, not actual performance — partner categories may shift between months.</span>
          </div>
        </div>
      </div>

      <!-- Highlights Section -->
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 26px; height: 26px; background: linear-gradient(135deg, #059669, #34d399); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px;">✅</span>
          <span style="font-size: 13px; font-weight: 700; color: #065f46;">Highlights</span>
        </div>
        <div data-i18n-html="highlights-cards" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;">
            <span style="font-weight: 700;">🛡️ Good partners protected</span><br>Lowest target reduction at only <strong>6.6%</strong> — prioritized in allocation rules.
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;">
            <span style="font-weight: 700;">📉 Bad partners minimized</span><br>Count dropped <strong>73 → 20</strong> MoM; target cut from <strong>808 → 370</strong>.
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;">
            <span style="font-weight: 700;">⚖️ Average partners stable</span><br>Target maintained at same level MoM with <strong>+1.0%</strong> change.
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;">
            <span style="font-weight: 700;">🤖 Manual adjustments halved</span><br>Reduced by <strong>50.4%</strong> — rules automation improving.
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5; grid-column: 1 / -1;">
            <span style="font-weight: 700;">🎯 FR achievement rate at 92.4%</span> — strong face recognition rate against target.
          </div>
        </div>
      </div>

      <!-- Lowlights Section -->
      <div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 26px; height: 26px; background: linear-gradient(135deg, #dc2626, #f87171); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px;">⚠️</span>
          <span style="font-size: 13px; font-weight: 700; color: #991b1b;">Lowlights</span>
        </div>
        <div data-i18n-html="lowlights-cards" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #991b1b; line-height: 1.5;">
            <span style="font-weight: 700;">😞 Partner experience impact</span><br>Target declining for <strong>3rd consecutive month</strong> affects partner sentiment. Additionally, <strong>70 partners phased out</strong> adds to negative experience.
          </div>
          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #991b1b; line-height: 1.5;">
            <span style="font-weight: 700;">🪪 Low driver card rate</span><br>Driver card rate at <strong>40.5%</strong> — limiting full rule application and requiring exceptions.
          </div>
        </div>
      </div>

    </div>
    </div>
  </div>

  <!-- Card 2: Key Challenges & Outcomes -->
  <div id="challengesCard" style="border-radius: 14px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1.5px solid #e0e7ef; background: #fff;">
        <div id="challengesHeader" onclick="toggleBriefingCards()" style="background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 50%, #7c3aed 100%); padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; user-select: none;">
      <span id="challengesArrow" style="width: 28px; height: 28px; background: rgba(255,255,255,0.13); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0; color: white; font-weight: 700; transition: transform 0.3s;">▶</span>
      <span style="color: white; font-size: 14px; font-weight: 700; flex: 1;">⚡ Key Challenges & Outcomes</span>
      <span id="challengesBadge" style="color: rgba(255,255,255,0.45); font-size: 10px; font-weight: 600; background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 20px; transition: all 0.2s;">Expand ▾</span>
    </div>
    <div id="challengesBody" style="max-height: 0; overflow: hidden;">
      <div style="padding: 18px 20px 20px; background: linear-gradient(180deg, #f8fafc, #ffffff);">

      <!-- Challenge 1 -->
      <div style="background: #fff; border: 1.5px solid #e9d5ff; border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 24px; height: 24px; background: linear-gradient(135deg, #7c3aed, #a78bfa); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: 800;">1</span>
          <span style="font-size: 12.5px; font-weight: 700; color: #5b21b6;">Maintain avg scale with -13% target reduction</span>
        </div>
        <div data-i18n-html="challenge1-content" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
          <div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Challenge</div>
            <div style="font-size: 11px; color: #78350f; line-height: 1.5;">Achieve scale target despite <strong>+13% overall reduction</strong> in capacity.</div>
          </div>
          <div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Solution</div>
            <div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">Identified & phased out <strong>low-compliance partners</strong> to protect avg scale.</div>
          </div>
          <div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Outcome</div>
            <div style="font-size: 11px; color: #064e3b; line-height: 1.5;">Avg scale <strong>35.1 / 36 target</strong> — <span style="font-weight: 700; color: #059669;">98% achievement</span>.</div>
          </div>
        </div>
      </div>

      <!-- Challenge 2 -->
      <div style="background: #fff; border: 1.5px solid #e9d5ff; border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 24px; height: 24px; background: linear-gradient(135deg, #7c3aed, #a78bfa); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: 800;">2</span>
          <span style="font-size: 12.5px; font-weight: 700; color: #5b21b6;">Preserve good partners target under reduction pressure</span>
        </div>
        <div data-i18n-html="challenge2-content" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
          <div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Challenge</div>
            <div style="font-size: 11px; color: #78350f; line-height: 1.5;">Keep high-quality partners at prior-month level despite overall <strong>target cuts</strong>.</div>
          </div>
          <div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Solution</div>
            <div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">Rules <strong>prioritize good partners first</strong> — absorb reduction from lower tiers.</div>
          </div>
          <div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Outcome</div>
            <div style="font-size: 11px; color: #064e3b; line-height: 1.5;">Good partners target <strong>-6.6%</strong> (only from city-level constraints); <span style="font-weight: 700; color: #059669;">on track</span> — most reduction tied to DC issue.</div>
          </div>
        </div>
      </div>

      <!-- Challenge 3 -->
      <div style="background: #fff; border: 1.5px solid #e9d5ff; border-radius: 12px; padding: 16px; position: relative;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="width: 24px; height: 24px; background: linear-gradient(135deg, #7c3aed, #a78bfa); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: 800;">3</span>
          <span style="font-size: 12.5px; font-weight: 700; color: #5b21b6;">Driver card constraints limiting rule execution</span>
        </div>
        <div data-i18n-html="challenge3-content" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
          <div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Challenge</div>
            <div style="font-size: 11px; color: #78350f; line-height: 1.5;">Low driver card rate (<strong>40.5%</strong>) prevents full rule application — forced <strong>manual exceptions</strong>.</div>
          </div>
          <div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Solution</div>
            <div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">Coordinating with <strong>CH/PMM</strong> to align partners on driver card issuance timeline.</div>
          </div>
          <div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;">
            <div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">Outcome</div>
            <div style="font-size: 11px; color: #064e3b; line-height: 1.5;">Assigned <strong>conservative targets</strong> until commitment shown; <span style="font-weight: 700; color: #d97706;">reassessment next month</span>.</div>
          </div>
        </div>
      </div>

    </div>
    </div>
  </div>

</div>
<!-- End Executive Briefing -->

<script>
// Auto-cycling executive briefing cards with pin-to-keep-open
let briefingExpanded = false;
window._briefingPinned = false;
let briefingAutoTimer = null;
let briefingAutoHoverCount = 0;

function setBriefingState(expanded) {
    briefingExpanded = expanded;
    const hBody = document.getElementById('highlightsBody');
    const cBody = document.getElementById('challengesBody');
    const hArrow = document.getElementById('highlightsArrow');
    const cArrow = document.getElementById('challengesArrow');
    const hBadge = document.getElementById('highlightsBadge');
    const cBadge = document.getElementById('challengesBadge');

    if (expanded) {
        hBody.style.maxHeight = hBody.scrollHeight + 'px';
        cBody.style.maxHeight = cBody.scrollHeight + 'px';
        hArrow.textContent = '▼';
        cArrow.textContent = '▼';
        hBadge.textContent = 'Collapse ▴';
        cBadge.textContent = 'Collapse ▴';
    } else {
        hBody.style.maxHeight = '0';
        cBody.style.maxHeight = '0';
        hArrow.textContent = '▶';
        cArrow.textContent = '▶';
        hBadge.textContent = 'Expand ▾';
        cBadge.textContent = 'Expand ▾';
    }
}

function startBriefingAuto() {
    if (briefingAutoTimer) clearInterval(briefingAutoTimer);
    briefingAutoHoverCount = 0;

    // In AUTO mode: keep collapsed by default and only expand when hovering the header.
    if (!window._briefingPinned) setBriefingState(false);

    if (window._briefingAutoHoverBound) return;
    const hHeader = document.getElementById('highlightsHeader');
    const cHeader = document.getElementById('challengesHeader');
    if (!hHeader || !cHeader) return;

    const onEnter = () => {
        if (window._briefingPinned) return;
        briefingAutoHoverCount++;
        setBriefingState(true);
    };

    const onLeave = () => {
        if (window._briefingPinned) return;
        briefingAutoHoverCount = Math.max(0, briefingAutoHoverCount - 1);

        // Small delay prevents flicker when moving between headers.
        setTimeout(() => {
            if (window._briefingPinned) return;
            if (briefingAutoHoverCount === 0) setBriefingState(false);
        }, 40);
    };

    hHeader.addEventListener('mouseenter', onEnter);
    hHeader.addEventListener('mouseleave', onLeave);
    cHeader.addEventListener('mouseenter', onEnter);
    cHeader.addEventListener('mouseleave', onLeave);

    window._briefingAutoHoverBound = true;
}

function pinBriefingCards() {
    window._briefingPinned = !window._briefingPinned;
    const btn = document.getElementById('briefingPinBtn');
    const icon = document.getElementById('briefingPinIcon');
    const text = document.getElementById('briefingPinText');
    const autoLabel = document.getElementById('briefingAutoLabel');
    const isZh = localStorage.getItem('dashboard_lang_pref_v1') === 'zh';

    if (window._briefingPinned) {
        // Pin = keep expanded, stop auto
        setBriefingState(true);
        icon.textContent = '🔒';
        text.textContent = isZh ? '已固定展开' : 'Pinned Open';
        btn.style.borderColor = '#6366f1';
        btn.style.background = 'linear-gradient(135deg, #eef2ff, #e0e7ff)';
        btn.style.color = '#4f46e5';
        autoLabel.textContent = isZh ? '■ 已固定' : '■ PINNED';
        autoLabel.style.color = '#059669';
        autoLabel.style.background = '#d1fae5';
        autoLabel.style.animation = 'none';
    } else {
        // Unpin = resume auto
        setBriefingState(false);
        icon.textContent = '📌';
        text.textContent = isZh ? '保持展开' : 'Keep Open';
        btn.style.borderColor = '#cbd5e1';
        btn.style.background = 'linear-gradient(135deg, #f8fafc, #f1f5f9)';
        btn.style.color = '#475569';
        autoLabel.textContent = isZh ? '● 自动' : '● AUTO';
        autoLabel.style.color = '#6366f1';
        autoLabel.style.background = '#eef2ff';
        autoLabel.style.animation = 'briefingPulse 2s ease-in-out infinite';
        startBriefingAuto();
    }
}

function toggleBriefingCards() {
    if (window._briefingPinned) {
        // If pinned, clicking header unpins and collapses
        window._briefingPinned = false;
        setBriefingState(false);
        const icon = document.getElementById('briefingPinIcon');
        const text = document.getElementById('briefingPinText');
        const btn = document.getElementById('briefingPinBtn');
        const autoLabel = document.getElementById('briefingAutoLabel');
        const isZh = localStorage.getItem('dashboard_lang_pref_v1') === 'zh';
        icon.textContent = '📌';
        text.textContent = isZh ? '保持展开' : 'Keep Open';
        btn.style.borderColor = '#cbd5e1';
        btn.style.background = 'linear-gradient(135deg, #f8fafc, #f1f5f9)';
        btn.style.color = '#475569';
        autoLabel.textContent = isZh ? '● 自动' : '● AUTO';
        autoLabel.style.color = '#6366f1';
        autoLabel.style.background = '#eef2ff';
        autoLabel.style.animation = 'briefingPulse 2s ease-in-out infinite';
        startBriefingAuto();
    } else {
        // If auto mode, clicking header pins open
        pinBriefingCards();
    }
}

// Start auto-cycling on load
startBriefingAuto();
</script>

<div class="kpi-grid">
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">Total Riders</span>
<span class="kpi-icon">👥</span>
</div>
<div class="kpi-value">19,365</div>
<div class="kpi-subtitle negative">↓ -3,088 (MoM -13.8%)</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Active Partners</span>
<span class="kpi-icon">🎯</span>
</div>
<div class="kpi-value">551</div>
<div class="kpi-subtitle">out of 643 partners</div>
</div>
<div class="kpi-card success">
<div class="kpi-header">
<span class="kpi-title">Good Partners</span>
<span class="kpi-icon">📈</span>
</div>
<div class="kpi-value">252</div>
<div class="kpi-subtitle negative">↓ -17 (MoM -6.3%)</div>
<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Jan: 269 → Feb: 252</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">At-Risk Partners (bad partners)</span>
<span class="kpi-icon">⚠️</span>
</div>
<div class="kpi-value negative">20</div>
<div class="kpi-subtitle positive">↓ -53 (MoM -72.6%)</div>
<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Jan: 73 → Feb: 20</div>
</div>
</div>
<div class="kpi-grid">
<div class="kpi-card warning">
<div class="kpi-header">
<span class="kpi-title">Zero-Target Partners</span>
<span class="kpi-icon">⭕</span>
</div>
<div class="kpi-value">92</div>
<div class="kpi-subtitle"><span style="color: #dc2626; font-weight: 600;">3 Terminated</span>, <span style="color: #d97706; font-weight: 600;">70 Phased Out</span>, <span style="color: #6b7280; font-weight: 600;">19 No Jan Target</span></div>
<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Partners not given target in Feb</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Avg Scale per Partner</span>
<span class="kpi-icon">📊</span>
</div>
<div class="kpi-value">35.1</div>
<div class="kpi-subtitle negative">↓ -0.8 (MoM -2.2%)</div>
<div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Jan: 35.9 → Feb: 35.1</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Highest Partner Total Capacity</span>
<span class="kpi-icon">🏆</span>
</div>
<div class="kpi-value">200</div>
<div class="kpi-subtitle">highest net target given to a partner (60 riders)</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">Highest Partner with Capacity Reduction</span>
<span class="kpi-icon">📉</span>
</div>
<div class="kpi-value negative">-85</div>
<div class="kpi-subtitle">lowest total target given to a partner (10 riders)</div>
</div>
</div>
<h3 id="monthOverviewPerformanceBreakdown" style="margin: 14px 0 10px; color: #1f4e78; font-size: 17px;">Performance Breakdown</h3>
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 7px 14px; background: linear-gradient(90deg, #eff6ff, #faf5ff); border-left: 3px solid #6366f1; border-radius: 0 6px 6px 0;">
<span style="font-size: 12px;">📌</span>
<p style="margin: 0; font-size: 11.5px; color: #4b5563; line-height: 1.4;"><span style="font-weight: 700; color: #4338ca;">Note:</span> The target change shown per category reflects the <span style="font-weight: 700; color: #1e40af;">overall capacity reduction</span>, not a per-performance-level adjustment. Partners may have a <span style="font-weight: 700; color: #b45309;">different assessment</span> month-over-month (e.g. shifted from Good to Average), so the numbers also reflect partner movement across categories.</p>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
<div style="background: white; border: 2px solid #10b981; border-radius: 10px; padding: 14px 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
<h4 style="font-size: 16px; margin-bottom: 8px; color: #10b981;">Good Partners</h4>
<div style="color: #6b7280; line-height: 1.7;">
<p style="font-size: 13px; margin: 2px 0;"><strong>Partners:</strong> 252 (47.2%)</p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;"><strong>Feb Target:</strong> 10,192 (53.7%)
<span style="font-size: 11px; font-weight: 700; color: #dc2626; background: #fee2e2; padding: 1px 6px; border-radius: 999px;">MoM -17.5%</span></p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
<strong>Scale:</strong> 45.9 → 40.4
<span style="font-size: 11px; font-weight: 700; color: #dc2626; background: #fee2e2; padding: 1px 6px; border-radius: 999px;">-12.0%</span>
</p>
</div>
</div>
<div style="background: white; border: 2px solid #f59e0b; border-radius: 10px; padding: 14px 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
<h4 style="font-size: 16px; margin-bottom: 8px; color: #f59e0b;">Average Partners</h4>
<div style="color: #6b7280; line-height: 1.7;">
<p style="font-size: 13px; margin: 2px 0;"><strong>Partners:</strong> 262 (49.1%)</p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;"><strong>Feb Target:</strong> 8,414 (44.3%)
<span style="font-size: 11px; font-weight: 700; color: #16a34a; background: #dcfce7; padding: 1px 6px; border-radius: 999px;">MoM +1.0%</span></p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
<strong>Scale:</strong> 30.4 → 32.1
<span style="font-size: 11px; font-weight: 700; color: #16a34a; background: #dcfce7; padding: 1px 6px; border-radius: 999px;">+5.6%</span>
</p>
</div>
</div>
<div style="background: white; border: 2px solid #dc2626; border-radius: 10px; padding: 14px 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
<h4 style="font-size: 16px; margin-bottom: 8px; color: #dc2626;">Bad Partners</h4>
<div style="color: #6b7280; line-height: 1.7;">
<p style="font-size: 13px; margin: 2px 0;"><strong>Partners:</strong> 20 (3.7%)</p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;"><strong>Feb Target:</strong> 370 (1.9%)
<span style="font-size: 11px; font-weight: 700; color: #dc2626; background: #fee2e2; padding: 1px 6px; border-radius: 999px;">MoM -75.9%</span></p>
<p style="font-size: 13px; margin: 2px 0; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
<strong>Scale:</strong> 21.0 → 18.5
<span style="font-size: 11px; font-weight: 700; color: #dc2626; background: #fee2e2; padding: 1px 6px; border-radius: 999px;">-11.9%</span>
</p>
</div>
</div>
</div>

<!-- Final Capacity Target Section -->
<div style="background: white; border-radius: 12px; padding: 0; margin-bottom: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 16px rgba(0,0,0,0.06); overflow: hidden;">
    <!-- Header Bar -->
    <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 50%, #7c3aed 100%); padding: 14px 24px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">📋</div>
            <div>
                <span style="color: white; font-size: 16px; font-weight: 700; letter-spacing: 0.3px;">Final Capacity Target — Our Rules vs Last Month Achievement (Performance breakdown)</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 5px 14px;">
            <span style="font-size: 11px; color: rgba(255,255,255,0.7);">Total Delta</span>
            <span style="font-size: 14px; font-weight: 800; color: #fbbf24;">-3,366</span>
        </div>
    </div>

    <!-- Highlight Note -->
    <div style="display: flex; align-items: flex-start; gap: 10px; padding: 10px 24px; background: linear-gradient(90deg, #eff6ff, #faf5ff); border-bottom: 1px solid #e5e7eb;">
        <span style="font-size: 14px; margin-top: 1px;">💡</span>
        <p style="margin: 0; font-size: 12px; line-height: 1.8;">
            <span style="font-weight: 700; color: #1e40af;">Note:</span>
            <span style="color: #4b5563;"> Target is assigned only to</span>
            <span style="font-weight: 700; color: #7c3aed; background: #f3e8ff; padding: 1px 8px; border-radius: 4px; margin: 0 2px;">last week active partners</span>
            <span style="color: #4b5563;">of the month — inactive partners are excluded.</span>
            <span style="color: #94a3b8; margin: 0 4px;">|</span>
            <span style="color: #4b5563;">This table shows the</span>
            <span style="font-weight: 700; color: #0369a1; background: #e0f2fe; padding: 1px 8px; border-radius: 4px; margin: 0 2px;">capacity rules impact</span>
            <span style="color: #4b5563;">on target assignment per performance level (Good, Average, Bad).</span>
            <span style="color: #94a3b8; margin: 0 4px;">|</span>
            <span style="color: #4b5563;">Targets are based on each partner's</span>
            <span style="font-weight: 700; color: #b45309; background: #fef3c7; padding: 1px 8px; border-radius: 4px; margin: 0 2px;">latest assessment</span>
            <span style="color: #4b5563;">— some partners may have shifted category since last month.</span>
        </p>
    </div>

    <!-- Summary KPI Strip -->
    <div style="display: flex; justify-content: center; gap: 16px; padding: 14px 24px; background: #f8fafc; border-bottom: 1px solid #f1f5f9;">
        <div style="display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 20px; padding: 6px 16px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: #6366f1;"></span>
            <span style="font-size: 11px; color: #6b7280;">Last Month Total</span>
            <span style="font-size: 13px; font-weight: 800; color: #1e293b;">22,342</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 20px; padding: 6px 16px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: #2563eb;"></span>
            <span style="font-size: 11px; color: #6b7280;">New Month Total</span>
            <span style="font-size: 13px; font-weight: 800; color: #1e293b;">18,976</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 20px; padding: 6px 16px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: #dc2626;"></span>
            <span style="font-size: 11px; color: #6b7280;">Net Delta</span>
            <span style="font-size: 13px; font-weight: 800; color: #dc2626;">-3,366</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 20px; padding: 6px 16px;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: #0ea5e9;"></span>
            <span style="font-size: 11px; color: #6b7280;">Partners with Target</span>
            <span style="font-size: 13px; font-weight: 800; color: #1e293b;">534</span>
        </div>
    </div>

    <!-- Data Table -->
    <div style="padding: 16px 24px 20px;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
            <thead>
                <tr>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: left; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;">Category</th>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: center; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;"># of Partners<br>with Target</th>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: center; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;">Last Month Final Target</th>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: center; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;">New Month Final Target</th>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: center; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;">Delta</th>
                    <th style="padding: 12px 16px; background: linear-gradient(135deg, #1e293b, #334155); color: white; text-align: center; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #475569;">MoM %</th>
                </tr>
            </thead>
            <tbody>
                <!-- Good Row -->
                <tr style="background: #f0fdf4; transition: background 0.2s;" onmouseover="this.style.background='#dcfce7'" onmouseout="this.style.background='#f0fdf4'">
                    <td style="padding: 14px 16px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: #10b981; box-shadow: 0 0 6px rgba(16,185,129,0.4);"></span>
                            <span style="font-weight: 700; color: #065f46; font-size: 13px;">Good</span>
                        </div>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #1e293b; background: #e0f2fe; padding: 3px 12px; border-radius: 6px; font-size: 13px;">252</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">10,914</td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 700; color: #1e293b; border-bottom: 1px solid #e5e7eb;">10,192</td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; background: #fee2e2; padding: 3px 10px; border-radius: 6px; font-size: 12px;">-722</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; font-size: 12px;">-6.6%</span>
                    </td>
                </tr>
                <!-- Average Row -->
                <tr style="background: #fffbeb; transition: background 0.2s;" onmouseover="this.style.background='#fef3c7'" onmouseout="this.style.background='#fffbeb'">
                    <td style="padding: 14px 16px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b; box-shadow: 0 0 6px rgba(245,158,11,0.4);"></span>
                            <span style="font-weight: 700; color: #92400e; font-size: 13px;">Average</span>
                        </div>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #1e293b; background: #e0f2fe; padding: 3px 12px; border-radius: 6px; font-size: 13px;">262</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">10,620</td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 700; color: #1e293b; border-bottom: 1px solid #e5e7eb;">8,414</td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; background: #fee2e2; padding: 3px 10px; border-radius: 6px; font-size: 12px;">-2,206</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; font-size: 12px;">-20.8%</span>
                    </td>
                </tr>
                <!-- Bad Row -->
                <tr style="background: #fef2f2; transition: background 0.2s;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
                    <td style="padding: 14px 16px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: #dc2626; box-shadow: 0 0 6px rgba(220,38,38,0.4);"></span>
                            <span style="font-weight: 700; color: #991b1b; font-size: 13px;">Bad</span>
                        </div>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #1e293b; background: #e0f2fe; padding: 3px 12px; border-radius: 6px; font-size: 13px;">20</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">808</td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 700; color: #1e293b; border-bottom: 1px solid #e5e7eb;">370</td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; background: #fee2e2; padding: 3px 10px; border-radius: 6px; font-size: 12px;">-438</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <span style="font-weight: 700; color: #dc2626; font-size: 12px;">-54.2%</span>
                    </td>
                </tr>
                <!-- Total Row -->
                <tr style="background: linear-gradient(90deg, #f1f5f9, #eef2ff); transition: background 0.2s;">
                    <td style="padding: 14px 16px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #7c3aed); box-shadow: 0 0 6px rgba(99,102,241,0.4);"></span>
                            <span style="font-weight: 800; color: #1e293b; font-size: 14px;">Total</span>
                        </div>
                    </td>
                    <td style="padding: 14px 16px; text-align: center;">
                        <span style="font-weight: 800; color: white; background: linear-gradient(135deg, #2563eb, #7c3aed); padding: 4px 14px; border-radius: 6px; font-size: 14px; box-shadow: 0 2px 6px rgba(99,102,241,0.3);">534</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 800; color: #1e293b; font-size: 14px;">22,342</td>
                    <td style="padding: 14px 16px; text-align: center; font-weight: 800; color: #1e293b; font-size: 14px;">18,976</td>
                    <td style="padding: 14px 16px; text-align: center;">
                        <span style="font-weight: 800; color: white; background: linear-gradient(135deg, #dc2626, #b91c1c); padding: 4px 14px; border-radius: 6px; font-size: 13px; box-shadow: 0 2px 6px rgba(220,38,38,0.3);">-3,366</span>
                    </td>
                    <td style="padding: 14px 16px; text-align: center;">
                        <span style="font-weight: 800; color: #dc2626; font-size: 13px;">-15.1%</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Manual Adjustment Summary Panel - NPS Style -->
<div style="background: white; border-radius: 0; padding: 0; margin-bottom: 16px; border: 1px solid #e5e7eb;">
    <!-- Header -->
    <div style="background: linear-gradient(90deg, #0d9488 0%, #14b8a6 100%); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 6px; height: 28px; background: white; border-radius: 4px;"></div>
            <span style="color: white; font-size: 18px; font-weight: 700; letter-spacing: 0.5px;">Manual Adjustment Summary - Feb 2026</span>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 14px; height: 14px; background: #10b981; border-radius: 3px;"></span><span style="color: white; font-size: 11px;">Capacity Added</span></div>
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 14px; height: 14px; background: #fbbf24; border-radius: 3px;"></span><span style="color: white; font-size: 11px;">Unchanged</span></div>
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 14px; height: 14px; background: #f87171; border-radius: 3px;"></span><span style="color: white; font-size: 11px;">Capacity Reduced</span></div>
        </div>
    </div>
    
    <!-- KPI Badges Strip -->
    <div style="display: flex; justify-content: center; gap: 10px; padding: 10px 20px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap;">
        <div class="tooltip-card" data-tooltip="MoM change in adjusted partners. Jan: 123 → Feb: 61 → (61−123)/123 = −50.4%" style="display: flex; align-items: center; gap: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 25px; padding: 8px 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">MoM Partners</span>
            <span style="color: #dc2626; font-weight: 700; font-size: 14px;">-50.4%</span>
            <span style="color: #dc2626; font-size: 12px;">▼</span>
        </div>
        <div class="tooltip-card" data-tooltip="Net capacity change as % of total target assigned to adjusted partners. Net change (423−596) = −173 ÷ Total given target (2,012) = −8.6%" style="display: flex; align-items: center; gap: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 25px; padding: 8px 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">Net Impact</span>
            <span style="color: #dc2626; font-weight: 700; font-size: 14px;">-8.6%</span>
            <span style="color: #dc2626; font-size: 12px;">▼</span>
        </div>
        <div class="tooltip-card" data-tooltip="Total unique partners with manual capacity adjustments applied in Feb 2026. Down from 123 in Jan (−62 partners)." style="display: flex; align-items: center; gap: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 25px; padding: 8px 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">Partners Adjusted</span>
            <span style="color: #0d9488; font-weight: 700; font-size: 14px;">61</span>
            <span style="color: #0d9488; font-size: 12px;">▲</span>
        </div>
        <div class="tooltip-card" data-tooltip="Total absolute capacity units moved. 423 added + 596 reduced = 1,019 total capacity movements." style="display: flex; align-items: center; gap: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 25px; padding: 8px 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">Total Moved</span>
            <span style="color: #0d9488; font-weight: 700; font-size: 14px;">1,019</span>
            <span style="color: #0d9488; font-size: 12px;">▲</span>
        </div>
        <div class="tooltip-card" data-tooltip="Most common reason for manual adjustments: Driver Card issues — 23 partners (37.7% of all adjustments)." style="display: flex; align-items: center; gap: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 25px; padding: 8px 20px; cursor: pointer;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">Top Issue</span>
            <span style="color: #dc2626; font-weight: 700; font-size: 14px;">Driver Card</span>
            <span style="color: #dc2626; font-size: 12px;">⚠</span>
        </div>
    </div>
    
    <!-- Main Metrics Section -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; padding: 16px 24px; background: white;">
        <!-- Adjusted Partners Score -->
        <div style="text-align: center; border-right: 1px solid #e5e7eb; padding-right: 30px;">
            <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 8px;">
                <div style="width: 5px; height: 20px; background: #0d9488; border-radius: 3px;"></div>
                <span style="font-size: 15px; font-weight: 600; color: #374151; font-style: italic;">Adjusted Partners</span>
            </div>
            <div style="display: flex; align-items: flex-start; justify-content: center; gap: 6px;">
                <span style="font-size: 48px; font-weight: 300; color: #0d9488; line-height: 1;">61</span>
                <span style="color: #dc2626; font-size: 14px; margin-top: 8px;">▼</span>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">Jan: 123 → Feb: 61</div>
                <div style="font-size: 12px; color: #475569;"><strong>-62 partners</strong> month-over-month</div>
            </div>
        </div>
        
        <!-- Net Capacity Change Score -->
        <div style="text-align: center; border-right: 1px solid #e5e7eb; padding: 0 30px;">
            <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-bottom: 8px;">
                <div style="width: 5px; height: 20px; background: #6366f1; border-radius: 3px;"></div>
                <span style="font-size: 15px; font-weight: 600; color: #374151; font-style: italic;">Net Capacity Change</span>
            </div>
            <div style="display: flex; align-items: flex-start; justify-content: center; gap: 6px;">
                <span style="font-size: 48px; font-weight: 300; color: #dc2626; line-height: 1;">-173</span>
                <span style="color: #dc2626; font-size: 14px; margin-top: 8px;">▼</span>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">Calculation = Added - Reduced</div>
                <div style="font-size: 12px; color: #475569;"><strong>+423</strong> added - <strong>596</strong> reduced</div>
            </div>
        </div>
        
        <!-- Category Breakdown -->
        <div style="padding-left: 30px;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 15px; font-weight: 600; color: #374151; font-style: italic;">Capacity Movement Breakdown</span>
            </div>
            <!-- Stacked Bar -->
            <div style="display: flex; height: 40px; border-radius: 6px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="width: 41.5%; background: linear-gradient(180deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-weight: 700; font-size: 14px;">423</span>
                </div>
                <div style="width: 58.5%; background: linear-gradient(180deg, #f87171 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-weight: 700; font-size: 14px;">596</span>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 24px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span><span style="font-size: 12px; color: #64748b;">Added (41.5%)</span></div>
                <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; background: #f87171; border-radius: 2px;"></span><span style="font-size: 12px; color: #64748b;">Reduced (58.5%)</span></div>
            </div>
            <!-- Top Driver Alert -->
            <div style="background: #fef2f2; border: 2px dashed #fca5a5; border-radius: 8px; padding: 12px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 16px;">⚠️</span>
                    <span style="font-size: 13px; font-weight: 700; color: #dc2626;">TOP DRIVER</span>
                </div>
                <div style="font-size: 16px; font-weight: 700; color: #991b1b;">Driver Card Issues</div>
                <div style="font-size: 13px; color: #b91c1c; margin-top: 4px;"><strong>23</strong> partners (37.7%)</div>
            </div>
        </div>
    </div>
</div>

<!-- How We Reduced Manual Adjustment — Collapsed Section -->
<details style="margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.06); border: 1px solid #e2e8f0;">
    <summary style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 40%, #4338ca 100%); padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 14px; list-style: none; user-select: none;">
        <span style="width: 32px; height: 32px; background: rgba(255,255,255,0.12); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; color: white; font-weight: 700;">▶</span>
        <span style="color: white; font-size: 15px; font-weight: 700; flex: 1;">How We Reduced Manual Adjustments — Feb Approach</span>
        <span style="color: rgba(255,255,255,0.5); font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 20px;">Click to expand ▾</span>
    </summary>
    <div style="background: linear-gradient(180deg, #f8fafc, #ffffff); padding: 20px 24px 24px;">
        <!-- Intro -->
        <p style="font-size: 13px; color: #475569; margin: 0 0 18px; line-height: 1.5; padding: 10px 16px; background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 0 8px 8px 0;">
            We reduced manual edits by <strong style="color: #1e40af;">tightening rules</strong>, <strong style="color: #7c3aed;">requiring evidence</strong>, and <strong style="color: #0d9488;">aligning stakeholders early</strong> — so targets follow one consistent logic.
        </p>

        <!-- 3 Rule Cards in Flow -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; position: relative;">

            <!-- Flow Connector Arrows -->
            <div style="position: absolute; top: 50%; left: 33.33%; transform: translate(-50%, -50%); z-index: 2; width: 28px; height: 28px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(99,102,241,0.4);">
                <span style="color: white; font-size: 14px; font-weight: 800;">→</span>
            </div>
            <div style="position: absolute; top: 50%; left: 66.66%; transform: translate(-50%, -50%); z-index: 2; width: 28px; height: 28px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(99,102,241,0.4);">
                <span style="color: white; font-size: 14px; font-weight: 800;">→</span>
            </div>

            <!-- Rule 1 -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px 0 0 12px; padding: 18px; border-right: 1px dashed #d1d5db; position: relative;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #0ea5e9, #38bdf8); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; flex-shrink: 0;">1</div>
                    <span style="font-size: 13px; font-weight: 700; color: #0c4a6e;">Same-Level Shift Rules</span>
                </div>
                <!-- Shift Diagram -->
                <div style="background: #f0f9ff; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px;">
                    <div style="display: flex; flex-direction: column; gap: 5px; font-size: 11px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 10px;">Good</span>
                            <span style="color: #94a3b8;">→</span>
                            <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">Good only</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 10px;">Average</span>
                            <span style="color: #94a3b8;">→</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">Average or Good</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 10px;">Bad</span>
                            <span style="color: #94a3b8;">→</span>
                            <span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">Bad or higher</span>
                        </div>
                    </div>
                </div>
                <div style="font-size: 11px; color: #475569; line-height: 1.5;">
                    <div style="margin-bottom: 4px;"><span style="font-weight: 700; color: #0369a1;">Purpose:</span> Keep growth on strong partners & protect avg scale.</div>
                    <div><span style="font-weight: 700; color: #16a34a;">Result:</span> Fewer random reductions; PMMs push delivery or reassign within tier.</div>
                </div>
            </div>

            <!-- Rule 2 -->
            <div style="background: white; border: 1px solid #e5e7eb; padding: 18px; border-right: 1px dashed #d1d5db; position: relative;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #7c3aed, #a78bfa); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; flex-shrink: 0;">2</div>
                    <span style="font-size: 13px; font-weight: 700; color: #4c1d95;">No Removal Without Proof</span>
                </div>
                <!-- Evidence Required Visual -->
                <div style="background: #faf5ff; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px;">
                        <span style="font-size: 20px;">🚫</span>
                        <span style="color: #6b7280; font-size: 18px;">→</span>
                        <span style="font-size: 20px;">📄</span>
                        <span style="color: #6b7280; font-size: 18px;">→</span>
                        <span style="font-size: 20px;">✅</span>
                    </div>
                    <div style="font-size: 10px; color: #7c3aed; font-weight: 600;">No ad-hoc removal → Provide evidence → Approved</div>
                </div>
                <div style="font-size: 11px; color: #475569; line-height: 1.5;">
                    <div style="margin-bottom: 4px;"><span style="font-weight: 700; color: #7c3aed;">Rule:</span> PMMs need valid proof (screenshot/record) to remove any target.</div>
                    <div style="margin-bottom: 4px;"><span style="font-weight: 700; color: #0369a1;">Purpose:</span> Eliminate decisions not backed by data.</div>
                    <div><span style="font-weight: 700; color: #16a34a;">Result:</span> Adjustments drop — all exceptions are controlled & traceable.</div>
                </div>
            </div>

            <!-- Rule 3 -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 12px 12px 0; padding: 18px; position: relative;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #0d9488, #2dd4bf); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; flex-shrink: 0;">3</div>
                    <span style="font-size: 13px; font-weight: 700; color: #134e4a;">Upfront Alignment & PMM Ownership</span>
                </div>
                <!-- Wiki Checklist Visual -->
                <div style="background: #f0fdfa; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px;">
                    <div style="font-size: 10px; font-weight: 700; color: #0d9488; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Pre-cycle session → Share wiki:</div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155;">
                            <span style="color: #10b981;">✓</span> Target rules & logic
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155;">
                            <span style="color: #10b981;">✓</span> Stratification metrics & criteria
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155;">
                            <span style="color: #10b981;">✓</span> Examples & common cases
                        </div>
                    </div>
                </div>
                <!-- PMM Ownership -->
                <div style="background: #eff6ff; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; border-left: 3px solid #3b82f6;">
                    <div style="font-size: 10px; font-weight: 700; color: #1d4ed8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">After alignment → PMM authority:</div>
                    <div style="font-size: 11px; color: #334155; line-height: 1.5;">
                        PMMs can request adjustments <strong>without pre-approval</strong> — as long as they follow the shared rules and support Keeta's monthly target. Frontline teams are closest to reality and partners.
                    </div>
                </div>
                <div style="font-size: 11px; color: #475569; line-height: 1.5;">
                    <div style="margin-bottom: 4px;"><span style="font-weight: 700; color: #0369a1;">Purpose:</span> Align first, then empower — fewer blockers, faster decisions.</div>
                    <div><span style="font-weight: 700; color: #16a34a;">Result:</span> PMMs act confidently within clear rules — less back-and-forth, more ownership.</div>
                </div>
            </div>
        </div>

        <!-- Real Example: Push-back on Zero Target Request -->
        <div style="margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #dc2626, #f59e0b); padding: 10px 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 16px;">⚠️</span>
                <span style="color: white; font-size: 13px; font-weight: 700;">Real Example — Push-back on removing a good partner's target</span>
            </div>
            <div style="padding: 10px 20px 6px; background: #fefce8; border-bottom: 1px solid #fde68a;">
                <p style="margin: 0; font-size: 12px; color: #92400e; line-height: 1.5;">
                    <span style="font-weight: 700; color: #b91c1c;">Context:</span> A PMM requested to set a <strong>good-performing partner's target to zero</strong> based on city-level cancellation rate. We refused — the partner had <strong>100% FR, 100 Driver Card</strong> and was rated <strong>Good</strong> across all 8 metrics over 3 months. Removing their target would violate our data-driven rules. The case was escalated and resolved through a meeting.
                </p>
            </div>
            <!-- Chat Thread -->
            <div style="background: #f8fafc; padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; max-height: 480px; overflow-y: auto;">

                <!-- Ruaa 09:09 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">R</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Ruaa Alabdulrahman</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 09:09 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            performance all month is below city average <span style="color: #2563eb; font-weight: 600;">@Adeel Ahmed</span> <span style="background: #dbeafe; color: #1e40af; padding: 1px 6px; border-radius: 4px; font-weight: 600;">@Mohamed Gamal</span>
                        </div>
                    </div>
                </div>

                <!-- Mohamed 10:02 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0ea5e9, #38bdf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">M</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Mohamed Gamal</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:02 AM</span>
                        </div>
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #1e3a5f; line-height: 1.6; max-width: 85%;">
                            <span style="color: #2563eb; font-weight: 600;">@Ruaa Alabdulrahman</span><br>
                            Performance used for three month and they are good performance with 100% FR, 100 Driver card, what's the logic to give them zero target?<br><br>
                            <span style="color: #2563eb; font-weight: 600;">@Adeel Ahmed</span> ^
                        </div>
                    </div>
                </div>

                <!-- Ruaa 10:13 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">R</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Ruaa Alabdulrahman</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:13 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 1px 6px; border-radius: 4px; font-weight: 600;">@Mohamed Gamal</span> shared above their Jan overall performance ^
                        </div>
                    </div>
                </div>

                <!-- Mohamed 10:30 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0ea5e9, #38bdf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">M</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Mohamed Gamal</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:30 AM</span>
                        </div>
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #1e3a5f; line-height: 1.6; max-width: 85%;">
                            Yes, as mentioned above, we are considering 3 months performance assessment not MTD, we explained this
                        </div>
                    </div>
                </div>

                <!-- Mohamed 10:32 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0ea5e9, #38bdf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">M</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Mohamed Gamal</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:32 AM</span>
                        </div>
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #1e3a5f; line-height: 1.6; max-width: 85%;">
                            The option we can do is to reduce their target a bit and give the reduction target to same level partners (good one)
                        </div>
                    </div>
                </div>

                <!-- Ruaa 10:56 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">R</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Ruaa Alabdulrahman</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:56 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            in 3 months they been average with a constants high cancelation and Al Ahsa overall cancelation is very high so we need to reduce those who contribute the majority of the city cancelation thu have low capacity
                        </div>
                    </div>
                </div>

                <!-- Mohamed 10:58 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0ea5e9, #38bdf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">M</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Mohamed Gamal</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 10:58 AM</span>
                        </div>
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #1e3a5f; line-height: 1.6; max-width: 85%;">
                            Kindly note that the performance level has a score with 8 metrics not only cancellation rate, if you a confusion on that level, pls arrange for a meeting to discuss further, for now let's pls work on the data we added<br><br>
                            thank you
                        </div>
                    </div>
                </div>

                <!-- Ruaa 11:02 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">R</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Ruaa Alabdulrahman</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 11:02 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 1px 6px; border-radius: 4px; font-weight: 600;">@Mohamed Gamal</span> you asked for justification im justifying my actions if i need to raise a request ill. Im well aware of the 8 matrics as ill follow up on daily.
                        </div>
                    </div>
                </div>

                <!-- Mohamed 11:05 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0ea5e9, #38bdf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">M</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Mohamed Gamal</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-27 11:05 AM</span>
                        </div>
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #1e3a5f; line-height: 1.6; max-width: 85%;">
                            The justification is against our data statement, we can't terminate good partners without valid reason<br><br>
                            <span style="color: #2563eb; font-weight: 600;">@Adeel Ahmed</span> If you have time, let's discuss this today me, you, and Ruaa
                        </div>
                    </div>
                </div>

                <!-- Ruaa 01-28 09:17 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">R</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">Ruaa Alabdulrahman</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-28 09:17 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            CC: <span style="color: #2563eb; font-weight: 600;">@王奉策(Chandler Wa...</span>
                        </div>
                    </div>
                </div>

                <!-- Chandler 01-28 09:38 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0d9488, #2dd4bf); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">C</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">王奉策 (Chandler)</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-28 09:38 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            <span style="color: #2563eb; font-weight: 600;">@Adeel Ahmed</span> check this, driver card is priority
                        </div>
                    </div>
                </div>

                <!-- Chandler 01-28 09:39 -->
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #0d9488, #2dd4bf); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;">C</div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px;">
                            <span style="font-size: 12px; font-weight: 700; color: #1e293b;">王奉策 (Chandler)</span>
                            <span style="font-size: 10px; color: #94a3b8;">01-28 09:39 AM</span>
                        </div>
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0 10px 10px 10px; padding: 10px 14px; font-size: 12px; color: #334155; line-height: 1.6; max-width: 85%;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 1px 6px; border-radius: 4px; font-weight: 600;">@Mohamed Gamal</span> fyi, in KAS, cost is first, compliance is second, customer experience is third, all others are rest
                        </div>
                    </div>
                </div>

                <!-- Reactions -->
                <div style="display: flex; align-items: center; gap: 6px; padding-left: 42px;">
                    <span style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 2px 10px; font-size: 11px; color: #2563eb; font-weight: 600;">👍 Mohamed Gamal, Adeel Ahmed</span>
                </div>
            </div>

            <!-- Outcome Footer -->
            <div style="background: linear-gradient(90deg, #f0fdf4, #ecfdf5); padding: 10px 20px; border-top: 1px solid #bbf7d0; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 14px;">✅</span>
                <p style="margin: 0; font-size: 12px; color: #166534; line-height: 1.4;">
                    <span style="font-weight: 700;">Outcome:</span> Request to zero the target was <strong>rejected</strong>. The partner kept their target with a minor reduction, redistributed to same-tier (Good) partners — fully aligned with our rules.
                    <a href="https://km.sankuai.com/collabpage/2744845954" target="_blank" style="margin-left: 8px; font-size: 11px; font-weight: 700; color: #2563eb; background: #eff6ff; padding: 2px 10px; border-radius: 12px; border: 1px solid #bfdbfe; text-decoration: none;">📄 View full case details →</a>
                </p>
            </div>
        </div>

    </div>
</details>

 <div class="chart-grid">
 <div class="chart-container">
 <div id="leftChartCards" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px;">
    <div class="tooltip-card" data-tooltip="Net impact after manual adjustment across all segments. Computed as After Manual Total minus Rule Total (18,976 − 19,242 = −266 riders)." style="background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:1px solid #bfdbfe;border-radius:8px;padding:8px 10px;cursor:pointer;">
     <div style="font-size:9px;color:#1e3a8a;font-weight:700;text-transform:uppercase;letter-spacing:.3px;">Net Manual Impact</div>
     <div id="overviewInsightNet" style="font-size:16px;font-weight:800;color:#1e40af;line-height:1.2;margin-top:2px;">—</div>
     <div id="overviewInsightNetSub" style="font-size:10px;color:#475569;margin-top:1px;">—</div>
   </div>
    <div class="tooltip-card" data-tooltip="Segment with the largest shift after manual adjustment. Bad segment increased by +226 riders (+157%), while Good segment decreased." style="background:linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%);border:1px solid #fde68a;border-radius:8px;padding:8px 10px;cursor:pointer;">
     <div style="font-size:9px;color:#92400e;font-weight:700;text-transform:uppercase;letter-spacing:.3px;">Largest Segment Shift</div>
     <div id="overviewInsightShift" style="font-size:16px;font-weight:800;color:#b45309;line-height:1.2;margin-top:2px;">—</div>
     <div id="overviewInsightShiftSub" style="font-size:10px;color:#475569;margin-top:1px;">—</div>
   </div>
 </div>
 <h3 class="chart-title">Feb Target vs After Manual Adjustment (Good / Average / Bad Partners)</h3>
 <p data-i18n-html="desc-manualadj" style="color: #6b7280; font-size: 12px; margin: 0 0 8px 0; font-style: italic;">Capacity targets for partners by performance segment (Good / Average / Bad) before and after PMM manual adjustments; shows how manual overrides impacted our rule-based targets.</p>
 <canvas id="manualAdjustChart"></canvas>
 </div>
 <div class="chart-container">
 <div id="rightChartCards" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px;">
    <div class="tooltip-card" data-tooltip="Partners whose target increased vs previous month. Share is calculated out of 551 partners with target in Feb." style="background:linear-gradient(135deg,#ecfdf5 0%,#d1fae5 100%);border:1px solid #a7f3d0;border-radius:8px;padding:8px 10px;cursor:pointer;">
     <div style="font-size:9px;color:#065f46;font-weight:700;text-transform:uppercase;letter-spacing:.3px;">Increase Partners</div>
     <div id="overviewInsightInc" style="font-size:16px;font-weight:800;color:#047857;line-height:1.2;margin-top:2px;">—</div>
     <div id="overviewInsightIncSub" style="font-size:10px;color:#475569;margin-top:1px;">—</div>
   </div>
    <div class="tooltip-card" data-tooltip="Partners whose target decreased vs previous month. Share is calculated out of 551 partners with target in Feb." style="background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);border:1px solid #fecaca;border-radius:8px;padding:8px 10px;cursor:pointer;">
     <div style="font-size:9px;color:#991b1b;font-weight:700;text-transform:uppercase;letter-spacing:.3px;">Decrease Partners</div>
     <div id="overviewInsightDec" style="font-size:16px;font-weight:800;color:#dc2626;line-height:1.2;margin-top:2px;">—</div>
     <div id="overviewInsightDecSub" style="font-size:10px;color:#475569;margin-top:1px;">—</div>
   </div>
 </div>
 <h3 class="chart-title">Partner Capacity Changes</h3>
 <p data-i18n-html="desc-distdir" style="color: #6b7280; font-size: 12px; margin: 0 0 8px 0; font-style: italic;">Distribution of 551 partners with active targets showing capacity direction: increases, unchanged, or decreases vs previous month.</p>
 <canvas id="changesChart"></canvas>
 </div>
 </div>
<!-- PERFORMANCE & SCALE SUMMARY SECTION -->
<div id="monthOverviewPerfScale" style="margin-top: 20px; margin-bottom: 20px;">
<h3 style="color: #1f4e78; margin-bottom: 12px; font-size: 18px; border-bottom: 2px solid #0ea5e9; padding-bottom: 8px;">
    📌 Performance & Scale Summary (Jan vs Feb)
</h3>
<!-- PS Summary Cards -->
<div id="psSummaryCardsContainer" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
    <div id="psSummaryCard1" class="ps-summary-card tooltip-card" data-tooltip="Total partners with active capacity target in Feb. Tracks overall partner base." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; animation: psCardSlideIn 0.5s ease forwards;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #0ea5e9, #06b6d4); border-radius: 12px 12px 0 0;"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">👥</div>
            <div style="min-width: 0;">
                <div id="psCard1Label" style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Partners with Target</div>
                <div style="display: flex; align-items: baseline; gap: 4px; flex-wrap: wrap;">
                    <span id="psCard1Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">551</span>
                    <span id="psCard1MoM" style="font-size: 11px; font-weight: 700; color: #dc2626;">-11.8%</span>
                </div>
                <div id="psCard1Sub" style="font-size: 11px; color: #6b7280;">Jan 625 → Feb 551</div>
            </div>
        </div>
    </div>
    <div id="psSummaryCard2" class="ps-summary-card tooltip-card" data-tooltip="Total capacity target value in Feb. Shows overall target volume." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; animation: psCardSlideIn 0.5s ease 0.1s forwards;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 12px 12px 0 0;"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">🎯</div>
            <div style="min-width: 0;">
                <div id="psCard2Label" style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Target</div>
                <div style="display: flex; align-items: baseline; gap: 4px; flex-wrap: wrap;">
                    <span id="psCard2Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">19,365</span>
                    <span id="psCard2MoM" style="font-size: 11px; font-weight: 700; color: #dc2626;">-13.7%</span>
                </div>
                <div id="psCard2Sub" style="font-size: 11px; color: #6b7280;">Jan 22,453 → Feb 19,365</div>
            </div>
        </div>
    </div>
    <div id="psSummaryCard3" class="ps-summary-card tooltip-card" data-tooltip="Average scale per partner in Feb. Measures capacity density." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; animation: psCardSlideIn 0.5s ease 0.2s forwards;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 12px 12px 0 0;"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">📊</div>
            <div style="min-width: 0;">
                <div id="psCard3Label" style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Avg Scale</div>
                <div style="display: flex; align-items: baseline; gap: 4px; flex-wrap: wrap;">
                    <span id="psCard3Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">35.1</span>
                    <span id="psCard3MoM" style="font-size: 11px; font-weight: 700; color: #dc2626;">-2.2%</span>
                </div>
                <div id="psCard3Sub" style="font-size: 11px; color: #6b7280;">Jan 35.9 → Feb 35.1</div>
            </div>
        </div>
    </div>
    <div id="psSummaryCard4" class="ps-summary-card tooltip-card" data-tooltip="Delivery riders across all partners in Feb. Tracks rider availability." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; animation: psCardSlideIn 0.5s ease 0.3s forwards;">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #8b5cf6, #a78bfa); border-radius: 12px 12px 0 0;"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">🚴</div>
            <div style="min-width: 0;">
                <div id="psCard4Label" style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Riders</div>
                <div style="display: flex; align-items: baseline; gap: 4px; flex-wrap: wrap;">
                    <span id="psCard4Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">20,489</span>
                    <span id="psCard4MoM" style="font-size: 11px; font-weight: 700; color: #dc2626;">-12.8%</span>
                </div>
                <div id="psCard4Sub" style="font-size: 11px; color: #6b7280;">Jan 23,511 → Feb 20,489</div>
            </div>
        </div>
    </div>
</div>
<!-- Dynamic context note -->
<div id="psContextNote" style="text-align: center; padding: 6px 14px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; margin-bottom: 8px; font-size: 12px; color: #0369a1; font-weight: 500; border: 1px solid #bae6fd; transition: all 0.3s ease;">
    🧭 Filter by period, performance, or scale to view avg scale & capacity breakdown. Overall avg scale is always included.
</div>

<!-- Section View Toggles -->
<div style="display: flex; justify-content: center; gap: 16px; margin: 18px 0 14px 0; flex-wrap: wrap;">
    <button class="ps-view-toggle tooltip-btn tooltip-btn-sky active" data-view="summary" data-tooltip="Executive summary of avg scale & capacity changes between Jan and Feb; filter by period, performance, and scale." style="padding: 12px 26px; border: 3px solid #0ea5e9; border-radius: 12px; background: #0ea5e9; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(14,165,233,0.25);">
        Avg Scale & Capacity Summary
    </button>
    <button class="ps-view-toggle tooltip-btn tooltip-btn-sky" data-view="breakdown" data-tooltip="Detailed breakdown of performance & scale segments (Jan vs Feb) to compare mix shifts." style="padding: 12px 26px; border: 3px solid #e5e7eb; border-radius: 12px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        Performance & Scale Breakdown
    </button>
    <button class="ps-view-toggle tooltip-btn tooltip-btn-sky" data-view="target-breakdown" data-tooltip="Capacity target breakdown by performance level (Good/Average/Bad) with New vs Old partner split comparison." style="padding: 12px 26px; border: 3px solid #e5e7eb; border-radius: 12px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        Performance Target Breakdown
    </button>
    <button class="ps-view-toggle tooltip-btn tooltip-btn-sky" data-view="vehicle-type" data-tooltip="Target breakdown by vehicle type (Cars vs Bikes) with city-level comparison across Jan and Feb." style="padding: 12px 26px; border: 3px solid #e5e7eb; border-radius: 12px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        🚗 Vehicle Type Breakdown
    </button>
</div>

<!-- Summary View -->
<div id="psSummaryView" style="display: block;">

    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 14px;">
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Period:</span>
            <button class="ps-summary-period-btn active" data-period="total" style="padding: 6px 12px; border: 2px solid #0ea5e9; border-radius: 8px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Total</button>
            <button class="ps-summary-period-btn" data-period="new1" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New &lt;1M</button>
            <button class="ps-summary-period-btn" data-period="new3" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New &lt;3M</button>
            <button class="ps-summary-period-btn" data-period="old3" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Old &gt;3M</button>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Performance:</span>
            <button class="ps-summary-perf-btn" data-perf="all" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">All</button>
            <button class="ps-summary-perf-btn" data-perf="good" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Good</button>
            <button class="ps-summary-perf-btn" data-perf="average" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Average</button>
            <button class="ps-summary-perf-btn" data-perf="bad" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Bad</button>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Scale:</span>
            <button class="ps-summary-scale-btn" data-scale="all" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">All</button>
            <button class="ps-summary-scale-btn" data-scale="big" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Big</button>
            <button class="ps-summary-scale-btn" data-scale="mid" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Mid</button>
            <button class="ps-summary-scale-btn" data-scale="small" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Small</button>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 18px; height: 320px;">
        <h4 id="psAvgScaleTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 10px 0;">Avg Scale Overview (Total Partners)</h4>
        <canvas id="psAvgScaleChart"></canvas>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 10px 0 12px 0;">
        <button class="ps-summary-view-btn tooltip-btn tooltip-btn-sky active" data-view="both" data-tooltip="Shows both riders breakdown and avg scale together for a full comparison (Jan vs Feb)." style="padding: 6px 14px; border: 2px solid #0ea5e9; border-radius: 8px; background: #0ea5e9; color: white; font-weight: 700; cursor: pointer; font-size: 12px;">Riders breakdown & Avg Scale</button>
        <button class="ps-summary-view-btn tooltip-btn tooltip-btn-sky" data-view="riders" data-tooltip="Focuses only on riders breakdown by category for Jan vs Feb." style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px;">Riders breakdown</button>
        <button class="ps-summary-view-btn tooltip-btn tooltip-btn-sky" data-view="avgscale" data-tooltip="Focuses only on avg scale (partners with target) for Jan vs Feb." style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px;">Avg Scale</button>
    </div>

    <div id="psRidersView" class="chart-container" style="margin-bottom: 18px; display: none; height: 320px;">
        <h4 id="psRidersBreakdownTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 10px 0;">Riders Breakdown Overview (Total Partners)</h4>
        <canvas id="psRidersBreakdownChart"></canvas>
    </div>

    <div id="psAvgScaleView" class="chart-container" style="margin-bottom: 18px; display: none; height: 320px;">
        <h4 id="psAvgScaleOverallTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 10px 0;">Avg Scale Overview (Partners with Target)</h4>
        <canvas id="psAvgScaleOverallChart"></canvas>
    </div>

    <div id="psBothView" style="display: block; margin-bottom: 18px;">
        <div style="display: flex; flex-wrap: wrap; gap: 18px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 320px; height: 280px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 10px 0;">Riders breakdown (Jan vs Feb)</h4>
                <canvas id="psCombinedRidersChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 320px; height: 280px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 10px 0;">Avg Scale (Partners with Target)</h4>
                <canvas id="psCombinedAvgScaleChart"></canvas>
            </div>
        </div>
    </div>

    <button onclick="toggleTable(this, 'psSummaryTable')" style="width: 100%; padding: 10px 16px; background: #0ea5e9; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="psSummaryTable" style="display: none; margin-top: 12px;">
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0ea5e9; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Metric</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                    </tr>
                </thead>
                <tbody id="psSummaryTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Breakdown View -->
<div id="psBreakdownView" style="display: none;">
    
    <h4 id="psBreakdownTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 15px 0;">📊 Breakdown Overview (Total Partners)</h4>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Period:</span>
            <button class="ps-period-btn active" data-period="total" style="padding: 6px 12px; border: 2px solid #3b82f6; border-radius: 8px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Total</button>
            <button class="ps-period-btn" data-period="new1" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New &lt;1M</button>
            <button class="ps-period-btn" data-period="new3" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New &lt;3M</button>
            <button class="ps-period-btn" data-period="old3" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Old &gt;3M</button>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Performance:</span>
            <button class="ps-perf-btn" data-perf="all" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">All</button>
            <button class="ps-perf-btn" data-perf="good" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Good</button>
            <button class="ps-perf-btn" data-perf="average" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Average</button>
            <button class="ps-perf-btn" data-perf="bad" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Bad</button>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Scale:</span>
            <button class="ps-scale-btn" data-scale="all" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">All</button>
            <button class="ps-scale-btn" data-scale="big" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Big</button>
            <button class="ps-scale-btn" data-scale="mid" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Mid</button>
            <button class="ps-scale-btn" data-scale="small" style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Small</button>
        </div>
    </div>

    <!-- KPI Cards with Mini Charts Grid -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 18px;">
        <!-- Total Partners Card -->
        <div class="chart-container" style="padding: 15px; border-radius: 12px; border-left: 4px solid #3b82f6;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div>
                    <div id="psKpiTotalPartnersLabel" style="font-size: 12px; color: #64748b; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span>👥 Total Active Partners</span>
                        <span class="kpi-tooltip-wrapper" style="display: inline-flex; align-items: center;">
                            <span style="width: 18px; height: 18px; border-radius: 6px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; line-height: 1;">i</span>
                            <div class="kpi-tooltip">
                                <div class="tooltip-title">👥 Total Active Partners</div>
                                <div>Partners with delivery riders active in the <span class="tooltip-highlight">last 7 days</span> of the month.</div>
                            </div>
                        </span>
                    </div>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 4px;">
                        <span id="psKpiTotalPartnersDec" style="font-size: 20px; font-weight: 700; color: #3b82f6;">851</span>
                        <span style="font-size: 11px; color: #94a3b8;">Jan</span>
                        <span style="font-size: 16px; color: #64748b;">→</span>
                        <span id="psKpiTotalPartnersJan" style="font-size: 20px; font-weight: 700; color: #10b981;">687</span>
                        <span style="font-size: 11px; color: #94a3b8;">Feb</span>
                    </div>
                    <div id="psKpiTotalPartnersMom" style="font-size: 12px; font-weight: 700; color: #dc2626; margin-top: 2px;">-19.3% MoM</div>
                </div>
            </div>
            <div style="height: 100px;">
                <canvas id="psBreakdownChart1"></canvas>
            </div>
        </div>

        <!-- Partners with Target Card -->
        <div class="chart-container" style="padding: 15px; border-radius: 12px; border-left: 4px solid #8b5cf6;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div>
                    <div id="psKpiActivePartnersLabel" style="font-size: 12px; color: #64748b; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <span>🎯 Total Partners With Target</span>
                        <span class="kpi-tooltip-wrapper" style="display: inline-flex; align-items: center;">
                            <span style="width: 18px; height: 18px; border-radius: 6px; background: #f5f3ff; border: 1px solid #ddd6fe; color: #5b21b6; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; line-height: 1;">i</span>
                            <div class="kpi-tooltip">
                                <div class="tooltip-title">🎯 Total Partners With Target</div>
                                <div>Partners that were <span class="tooltip-highlight">assigned a capacity target</span> for the month.</div>
                            </div>
                        </span>
                    </div>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 4px;">
                        <span id="psKpiActivePartnersDec" style="font-size: 20px; font-weight: 700; color: #8b5cf6;">674</span>
                        <span style="font-size: 11px; color: #94a3b8;">Jan</span>
                        <span style="font-size: 16px; color: #64748b;">→</span>
                        <span id="psKpiActivePartnersJan" style="font-size: 20px; font-weight: 700; color: #10b981;">625</span>
                        <span style="font-size: 11px; color: #94a3b8;">Feb</span>
                    </div>
                    <div id="psKpiActivePartnersMom" style="font-size: 12px; font-weight: 700; color: #dc2626; margin-top: 2px;">-7.3% MoM</div>
                </div>
            </div>
            <div style="height: 100px;">
                <canvas id="psBreakdownChart2"></canvas>
            </div>
        </div>

        <!-- Target Total Card -->
        <div class="chart-container" style="padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div>
                    <div style="font-size: 12px; color: #64748b; font-weight: 600;">🎯 Capacity Target Total</div>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 4px;">
                        <span id="psKpiTargetDec" style="font-size: 20px; font-weight: 700; color: #f59e0b;">24,182</span>
                        <span style="font-size: 11px; color: #94a3b8;">Jan</span>
                        <span style="font-size: 16px; color: #64748b;">→</span>
                        <span id="psKpiTargetJan" style="font-size: 20px; font-weight: 700; color: #10b981;">22,453</span>
                        <span style="font-size: 11px; color: #94a3b8;">Feb</span>
                    </div>
                    <div id="psKpiTargetMom" style="font-size: 12px; font-weight: 700; color: #dc2626; margin-top: 2px;">-7.1% MoM</div>
                </div>
            </div>
            <div style="height: 100px;">
                <canvas id="psBreakdownChart3"></canvas>
            </div>
        </div>

        <!-- Avg Scale Card -->
        <div class="chart-container" style="padding: 15px; border-radius: 12px; border-left: 4px solid #10b981;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <div>
                    <div style="font-size: 12px; color: #64748b; font-weight: 600;">📈 Average Scale</div>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-top: 4px;">
                        <span id="psKpiAvgScaleDec" style="font-size: 20px; font-weight: 700; color: #10b981;">35.9</span>
                        <span style="font-size: 11px; color: #94a3b8;">Jan</span>
                        <span style="font-size: 16px; color: #64748b;">→</span>
                        <span id="psKpiAvgScaleJan" style="font-size: 20px; font-weight: 700; color: #10b981;">35.9</span>
                        <span style="font-size: 11px; color: #94a3b8;">Feb</span>
                    </div>
                    <div id="psKpiAvgScaleMom" style="font-size: 12px; font-weight: 700; color: #f59e0b; margin-top: 2px;">0.0% MoM</div>
                </div>
            </div>
            <div style="height: 100px;">
                <canvas id="psBreakdownChart4"></canvas>
            </div>
        </div>
    </div>

    <button onclick="toggleTable(this, 'psBreakdownTable')" style="width: 100%; padding: 10px 16px; background: #64748b; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="psBreakdownTable" style="display: none; margin-top: 12px;">
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #64748b; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Metric</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                    </tr>
                </thead>
                <tbody id="psBreakdownTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Performance Target Breakdown View -->
<div id="psTargetBreakdownView" style="display: none;">
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">View:</span>
            <button class="ps-target-view-btn active" data-view="partners" style="padding: 6px 14px; border: 2px solid #f59e0b; border-radius: 8px; background: #f59e0b; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Partner Count</button>
            <button class="ps-target-view-btn" data-view="target" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Target Value</button>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">Partner Type:</span>
            <button class="ps-target-type-btn active" data-type="all" style="padding: 6px 14px; border: 2px solid #f59e0b; border-radius: 8px; background: #f59e0b; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">All Partners</button>
            <button class="ps-target-type-btn" data-type="new" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New (<3M)</button>
            <button class="ps-target-type-btn" data-type="old" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Old (≥3M)</button>
            <button class="ps-target-type-btn" data-type="compare" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">New vs Old</button>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 18px; height: 320px;">
        <h4 id="psTargetBreakdownTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 10px 0;">Performance Target Breakdown - Partner Count (All Partners)</h4>
        <canvas id="psTargetBreakdownChart"></canvas>
    </div>

    <button onclick="toggleTable(this, 'psTargetBreakdownTable')" style="width: 100%; padding: 10px 16px; background: #f59e0b; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="psTargetBreakdownTable" style="display: none; margin-top: 12px;">
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f59e0b; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Performance Level</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">New Partners</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Old Partners</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #10b981;">Good Partners</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">41</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">211</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">252</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #f59e0b;">Average Partners</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">57</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">205</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">262</td>
                    </tr>
                    <tr style="background: #fef2f2;">
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #ef4444;">Bad Partners</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">12</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">8</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">20</td>
                    </tr>
                    <tr style="background: #e0f2fe; font-weight: bold;">
                        <td style="padding: 10px; border: 1px solid #d1d5db;">Total</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">110</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">424</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">534</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #10b981;">Good Partners Target</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">1,100</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">9,092</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">10,192</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #f59e0b;">Average Partners Target</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">1,260</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">7,154</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">8,414</td>
                    </tr>
                    <tr style="background: #fef2f2;">
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: 600; color: #ef4444;">Bad Partners Target</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">213</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">157</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">370</td>
                    </tr>
                    <tr style="background: #e0f2fe; font-weight: bold;">
                        <td style="padding: 10px; border: 1px solid #d1d5db;">Total Target</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">2,573</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">16,403</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">18,976</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vehicle Type Breakdown View -->
<div id="psVehicleTypeView" style="display: none;">
    
    <!-- Donut Meters Section -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 24px;">
        <!-- Dec Donut -->
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; padding: 20px 30px; min-width: 280px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
            <h4 style="margin: 0 0 12px 0; color: #0c4a6e; font-size: 15px;">📅 January 2026</h4>
            <div style="position: relative; width: 160px; height: 160px; margin: 0 auto;">
                <canvas id="vehicleDonutDec"></canvas>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 22px; font-weight: 700; color: #1e40af;" id="vehicleDonutDecTotal">22,453</div>
                    <div style="font-size: 11px; color: #64748b;">Total Target</div>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px;">
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #3b82f6;" id="vehicleDecCars">17,446</div>
                    <div style="font-size: 11px; color: #6b7280;">🚗 Cars (<span id="vehicleDecCarsPct">77.7%</span>)</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #10b981;" id="vehicleDecBikes">5,007</div>
                    <div style="font-size: 11px; color: #6b7280;">🏍️ Bikes (<span id="vehicleDecBikesPct">22.3%</span>)</div>
                </div>
            </div>
        </div>
        
        <!-- Jan Donut -->
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; padding: 20px 30px; min-width: 280px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
            <h4 style="margin: 0 0 12px 0; color: #166534; font-size: 15px;">📅 February 2026</h4>
            <div style="position: relative; width: 160px; height: 160px; margin: 0 auto;">
                <canvas id="vehicleDonutJan"></canvas>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 22px; font-weight: 700; color: #166534;" id="vehicleDonutJanTotal">19,365</div>
                    <div style="font-size: 11px; color: #64748b;">Total Target</div>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px;">
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #3b82f6;" id="vehicleJanCars">14,443</div>
                    <div style="font-size: 11px; color: #6b7280;">🚗 Cars (<span id="vehicleJanCarsPct">74.6%</span>)</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #10b981;" id="vehicleJanBikes">4,922</div>
                    <div style="font-size: 11px; color: #6b7280;">🏍️ Bikes (<span id="vehicleJanBikesPct">25.4%</span>)</div>
                </div>
            </div>
        </div>
        
        <!-- Change Summary Card -->
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 20px 30px; min-width: 220px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
            <h4 style="margin: 0 0 16px 0; color: #92400e; font-size: 15px;">📊 MoM Change</h4>
            <div style="margin-bottom: 16px;">
                <div style="font-size: 24px; font-weight: 700; color: #dc2626;" id="vehicleTotalChange">-3,088</div>
                <div style="font-size: 12px; color: #78350f;">Total Target (<span id="vehicleTotalChangePct">-13.8%</span>)</div>
            </div>
            <div style="display: flex; justify-content: center; gap: 16px;">
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: 700; color: #dc2626;" id="vehicleCarsChange">-3,003</div>
                    <div style="font-size: 10px; color: #78350f;">🚗 Cars (<span id="vehicleCarsChangePct">-17.2%</span>)</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: 700; color: #dc2626;" id="vehicleBikesChange">-85</div>
                    <div style="font-size: 10px; color: #78350f;">🏍️ Bikes (<span id="vehicleBikesChangePct">-1.7%</span>)</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Filter Slicers -->
    <div style="margin-bottom: 16px;">
        <!-- City Level Filter -->
        <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">🏙️ City Level:</span>
            <button class="vehicle-city-level-btn active" data-level="all" style="padding: 6px 14px; border: 2px solid #10b981; border-radius: 8px; background: #10b981; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">All Cities</button>
            <button class="vehicle-city-level-btn" data-level="t1" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T1 Cities</button>
            <button class="vehicle-city-level-btn" data-level="t2" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T2 Cities</button>
            <button class="vehicle-city-level-btn" data-level="t1vst2" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T1 vs T2</button>
        </div>
        <!-- Individual City Filter -->
        <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; color: #374151; font-size: 12px;">📍 City:</span>
            <button class="vehicle-city-btn" data-city="Riyadh" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Riyadh</button>
            <button class="vehicle-city-btn" data-city="Jeddah" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jeddah</button>
            <button class="vehicle-city-btn" data-city="Dammam" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Dammam</button>
            <button class="vehicle-city-btn" data-city="Madinah" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Madinah</button>
            <button class="vehicle-city-btn" data-city="Makkah" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Makkah</button>
            <button class="vehicle-city-btn" data-city="Al Ahsa" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Al Ahsa</button>
            <button class="vehicle-city-btn" data-city="Al Kharj" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Al Kharj</button>
            <button class="vehicle-city-btn" data-city="Abha" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Abha</button>
            <button class="vehicle-city-btn" data-city="Taif" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Taif</button>
            <button class="vehicle-city-btn" data-city="Buraydah" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Buraydah</button>
            <button class="vehicle-city-btn" data-city="Jubail" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jubail</button>
            <button class="vehicle-city-btn" data-city="Tabuk" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Tabuk</button>
            <button class="vehicle-city-btn" data-city="Hail" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Hail</button>
            <button class="vehicle-city-btn" data-city="Yanbu" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Yanbu</button>
            <button class="vehicle-city-btn" data-city="Hafar Al Batin" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Hafar Al Batin</button>
            <button class="vehicle-city-btn" data-city="Jazan" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jazan</button>
            <button class="vehicle-city-btn" data-city="Najran" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Najran</button>
        </div>
        <!-- View Toggle -->
        <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center;">
            <span style="font-weight: 600; color: #374151; font-size: 13px;">📊 View:</span>
            <button class="vehicle-view-btn active" data-view="comparison" style="padding: 6px 14px; border: 2px solid #10b981; border-radius: 8px; background: #10b981; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Jan vs Feb</button>
            <button class="vehicle-view-btn" data-view="trend" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Trend Line</button>
        </div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container" style="margin-bottom: 18px; height: 340px;">
        <h4 id="vehicleChartTitle" style="text-align: center; color: #1f4e78; font-size: 16px; margin: 0 0 10px 0;">Vehicle Type Target Comparison - All Cities</h4>
        <canvas id="vehicleTypeChart"></canvas>
    </div>
    
    <!-- T1 vs T2 Dual Chart Container (hidden by default) -->
    <div id="vehicleT1vsT2Container" style="display: none; gap: 20px; margin-bottom: 18px;">
        <div class="chart-container" style="flex: 1; min-width: 300px; height: 300px;">
            <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 10px 0;">🏙️ T1 Cities (Major)</h4>
            <canvas id="vehicleT1Chart"></canvas>
        </div>
        <div class="chart-container" style="flex: 1; min-width: 300px; height: 300px;">
            <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 10px 0;">🌆 T2 Cities (Emerging)</h4>
            <canvas id="vehicleT2Chart"></canvas>
        </div>
    </div>

    <!-- City Level Table -->
    <button onclick="toggleTable(this, 'vehicleCityTable')" style="width: 100%; padding: 10px 16px; background: #10b981; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view city-level detailed data ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="vehicleCityTable" style="display: none; margin-top: 12px;">
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0;">
                    <tr style="background: #10b981; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;" rowspan="2">City</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;" colspan="2">January 2026</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;" colspan="2">February 2026</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;" colspan="2">Change</th>
                    </tr>
                    <tr style="background: #059669; color: white;">
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🚗 Cars</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🏍️ Bikes</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🚗 Cars</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🏍️ Bikes</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🚗 Cars</th>
                        <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">🏍️ Bikes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Riyadh</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">8,103</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,925</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">6,704</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,957</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-1,399</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+32</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Jeddah</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">2,469</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,625</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,900</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,554</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-569</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-71</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Dammam</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">2,205</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">436</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">1,770</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">357</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-435</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-79</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Madinah</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">929</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">266</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">841</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">290</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-88</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+24</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Makkah</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">738</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">336</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">540</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">395</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-198</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+59</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Al Ahsa</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">712</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">146</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">695</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">123</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-17</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-23</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Al Kharj</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">380</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">347</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-33</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Abha</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">316</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">23</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">279</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">18</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-37</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-5</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Taif</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">277</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">68</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">205</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">87</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-72</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+19</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Buraydah</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">232</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">64</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">218</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">35</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-14</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-29</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Jubail</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">224</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">20</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">210</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">20</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-14</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #6b7280;">0</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Tabuk</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">242</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">10</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">186</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">16</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-56</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+6</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Hail</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">199</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">186</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-13</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Yanbu</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">154</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">55</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">128</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">43</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-26</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-12</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Hafar Al Batin</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">103</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">25</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">97</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">12</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-6</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-13</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Jazan</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">85</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">10</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">64</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">10</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #dc2626;">-21</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #6b7280;">0</td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                        <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: 600;">Najran</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">76</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">78</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; color: #10b981;">+2</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">-</td>
                    </tr>
                    <tr style="background: #10b981; color: white; font-weight: bold;">
                        <td style="padding: 10px; border: 1px solid #d1d5db;">Grand Total</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">17,446</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">5,007</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">14,446</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">4,919</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">-3,000</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">-88</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- FR & DRIVER CARD COMBINED ANALYSIS SECTION -->
<div style="margin-top: 20px; margin-bottom: 20px;">
<h3 id="monthOverviewFrDc" style="color: #1f4e78; margin-bottom: 10px; font-size: 18px; border-bottom: 2px solid #3b82f6; padding-bottom: 8px;">
    📊 FR & Driver Card Compliance Analysis
</h3>

<!-- Overview Info Box -->
<div class="info-box" style="background: #f0fdf4; border-left: 4px solid #059669; margin-bottom: 12px; padding: 8px 12px;">
    <p style="margin: 0; font-size: 12px; color: #065f46;">
        <strong>📋 Overview:</strong> Analyze partner distribution by Face Recognition (FR) and Driver Card compliance rates across all segments. <span style="color: #6b7280; font-style: italic;">(Data updated till 25th Feb 2026)</span>
    </p>
</div>

<!-- Analysis Type Toggle Buttons (Compliance vs Target Range) -->
<div style="display: flex; justify-content: center; gap: 12px; margin: 12px 0; padding: 0;">
    <button class="analysis-type-toggle tooltip-btn tooltip-btn-green active" data-type="compliance" data-tooltip="Partner counts by compliance range for FR/Driver Card." style="padding: 8px 24px; border: 2px solid #059669; border-radius: 10px; background: #059669; color: white; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 3px 8px rgba(5, 150, 105, 0.3);">
        <span style="display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 15px;">📈</span>
            <span>Compliance Distribution</span>
        </span>
    </button>
    <button class="analysis-type-toggle tooltip-btn tooltip-btn-green" data-type="target-range" data-tooltip="Target changes across compliance ranges (Jan → Feb) for FR/Driver Card." style="padding: 8px 24px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 15px;">📊</span>
            <span>Target Range Impact</span>
        </span>
    </button>
    <button class="analysis-type-toggle tooltip-btn tooltip-btn-green" data-type="city-wise" data-tooltip="City averages and range distributions with risk highlights." style="padding: 8px 24px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <span style="display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 15px;">🏙️</span>
            <span>City-wise Analysis</span>
        </span>
    </button>
</div>

<!-- COMPLIANCE ANALYSIS VIEW (Pie Charts) -->
<div id="complianceAnalysisView" style="display: block;">

<!-- Compliance Metric Toggle Buttons with Donut Meters -->
<div style="display: flex; justify-content: center; align-items: center; gap: 14px; margin: 12px 0; padding: 0; flex-wrap: wrap;">
    <!-- FR Donut Meter -->
    <div id="frAvgCard" class="donut-meter-container fr-theme">
        <div class="donut-meter-info">
            <div class="donut-meter-title">
                <span>📸 AVG FR RATE</span>
                <span class="kpi-badge">KPI</span>
            </div>
            <div id="frAvgSubtitle" class="donut-meter-subtitle">All / With Target</div>
        </div>
        <div class="donut-dual-wrapper">
            <div class="donut-single">
                <div class="donut-meter" id="frDonutAll">
                    <svg viewBox="0 0 36 36">
                        <defs>
                            <linearGradient id="frGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6"/>
                                <stop offset="100%" style="stop-color:#1d4ed8"/>
                            </linearGradient>
                        </defs>
                        <circle class="donut-bg" cx="18" cy="18" r="14"/>
                        <circle class="donut-progress fr-stroke" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="24.7"/>
                    </svg>
                    <div class="donut-center">
                        <div class="donut-value" id="frDonutAllValue">71.9%</div>
                        <div class="donut-label">All</div>
                    </div>
                </div>
            </div>
            <div class="donut-single">
                <div class="donut-meter" id="frDonutTarget">
                    <svg viewBox="0 0 36 36">
                        <circle class="donut-bg" cx="18" cy="18" r="14"/>
                        <circle class="donut-progress fr-stroke" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="23.0"/>
                    </svg>
                    <div class="donut-center">
                        <div class="donut-value" id="frDonutTargetValue">73.8%</div>
                        <div class="donut-label">Target</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="metric-toggle-btn active" data-metric="fr" style="padding: 8px 24px; border: 2px solid #3b82f6; border-radius: 10px; background: #3b82f6; color: white; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3); position: relative; overflow: hidden;">
        <span style="position: relative; z-index: 1; display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 15px;">📸</span>
            <span>FR Rate Distribution</span>
        </span>
    </button>
    <button class="metric-toggle-btn" data-metric="dc" style="padding: 8px 24px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; overflow: hidden;">
        <span style="position: relative; z-index: 1; display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 15px;">🪪</span>
            <span>Driver Card Rate Distribution</span>
        </span>
    </button>
    
    <!-- DC Donut Meter -->
    <div id="dcAvgCard" class="donut-meter-container dc-theme" style="opacity: 0.6;">
        <div class="donut-dual-wrapper">
            <div class="donut-single">
                <div class="donut-meter" id="dcDonutAll">
                    <svg viewBox="0 0 36 36">
                        <defs>
                            <linearGradient id="dcGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10b981"/>
                                <stop offset="100%" style="stop-color:#059669"/>
                            </linearGradient>
                        </defs>
                        <circle class="donut-bg" cx="18" cy="18" r="14"/>
                        <circle class="donut-progress dc-stroke" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="64.3"/>
                    </svg>
                    <div class="donut-center">
                        <div class="donut-value" id="dcDonutAllValue">26.9%</div>
                        <div class="donut-label">All</div>
                    </div>
                </div>
            </div>
            <div class="donut-single">
                <div class="donut-meter" id="dcDonutTarget">
                    <svg viewBox="0 0 36 36">
                        <circle class="donut-bg" cx="18" cy="18" r="14"/>
                        <circle class="donut-progress dc-stroke" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="62.7"/>
                    </svg>
                    <div class="donut-center">
                        <div class="donut-value" id="dcDonutTargetValue">28.7%</div>
                        <div class="donut-label">Target</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="donut-meter-info">
            <div class="donut-meter-title">
                <span>🪪 AVG DC RATE</span>
                <span class="kpi-badge">KPI</span>
            </div>
            <div id="dcAvgSubtitle" class="donut-meter-subtitle">All / With Target</div>
        </div>
    </div>
</div>

<!-- Compliance Dynamic Title -->
<h4 id="metricTitle" style="text-align: center; color: #1f4e78; font-size: 15px; margin: 10px 0 8px 0; font-weight: 600;">Face Recognition (FR) Rate - All Partners vs Partners with Target</h4>

<!-- Compliance Filters - Side by Side -->
<div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: flex-start; margin: 8px 0 10px 0;">
    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 90px;">Comparison:</span>
        <button class="fr-filter-btn active" data-filter="comparison" style="padding: 5px 10px; border: 2px solid #3b82f6; border-radius: 6px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">All vs With Target</button>
    </div>
    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 90px;">All Partners:</span>
        <button class="fr-filter-btn" data-filter="all" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">All (643)</button>
        <button class="fr-filter-btn" data-filter="new" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">New (158)</button>
        <button class="fr-filter-btn" data-filter="old" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Old (485)</button>
        <button class="fr-filter-btn" data-filter="both" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">New vs Old</button>
    </div>
    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 90px;">With Target:</span>
        <button class="fr-filter-btn" data-filter="all-target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">All (551)</button>
        <button class="fr-filter-btn" data-filter="new-target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">New (127)</button>
        <button class="fr-filter-btn" data-filter="old-target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Old (424)</button>
        <button class="fr-filter-btn" data-filter="both-target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">New vs Old</button>
    </div>
    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 90px;">Performance:</span>
        <button class="fr-perf-filter-btn" data-perf="all" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">All (534)</button>
        <button class="fr-perf-filter-btn" data-perf="good" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Good (252)</button>
        <button class="fr-perf-filter-btn" data-perf="average" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Average (262)</button>
        <button class="fr-perf-filter-btn" data-perf="bad" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Bad (20)</button>
    </div>
</div>

<!-- Compliance Charts Wrapper -->
<div id="complianceChartsWrapper" class="compliance-charts-frame" style="max-width: 1200px; margin: 0 auto;">
<!-- Single Chart View (All, New, Old, All Target, New Target, Old Target) -->
<div id="frChartSingle" style="display: block; margin: 0 auto; max-width: 900px;">
    <canvas id="frChart" style="max-height: 520px;"></canvas>
</div>
<!-- Dual Chart View (New vs Old) -->
<div id="frChartDual" style="display: none; gap: 12px; margin-top: 8px; max-width: 1200px; margin-left: auto; margin-right: auto;">
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">New Partners (158)</h4>
        <canvas id="frChartNew"></canvas>
    </div>
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">Old Partners (485)</h4>
        <canvas id="frChartOld"></canvas>
    </div>
</div>
<!-- Dual Chart View (New vs Old - With Target) -->
<div id="frChartDualTarget" style="display: none; gap: 12px; margin-top: 8px; max-width: 1200px; margin-left: auto; margin-right: auto;">
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">New Partners with Target (127)</h4>
        <canvas id="frChartNewTarget"></canvas>
    </div>
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">Old Partners with Target (424)</h4>
        <canvas id="frChartOldTarget"></canvas>
    </div>
</div>
<!-- Dual Chart View (All vs With Target) -->
<div id="frChartComparison" style="display: none; gap: 12px; margin-top: 8px; max-width: 1200px; margin-left: auto; margin-right: auto;">
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">All Partners (643)</h4>
        <canvas id="frChartTotal"></canvas>
    </div>
    <div style="flex: 1; background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #111827; text-align: center;">Partners with Target (551)</h4>
        <canvas id="frChartTargetActive"></canvas>
    </div>
</div>
<!-- End Compliance Charts Wrapper -->
</div>
</div>

<!-- TARGET RANGE IMPACT VIEW (Bar/Trend Charts) -->
<div id="targetRangeView" style="display: none;">
<div class="info-box" style="background: #eff6ff; border-left: 4px solid #3b82f6; margin-bottom: 12px; padding: 8px 12px;">
    <p style="margin: 0; font-size: 12px; color: #1e40af;">
        <strong>Overview:</strong> Shows how FR/Driver Card compliance ranges shift partner targets from Jan 2026 to Feb 2026, split by new (&lt;3 months) and old (≥3 months) partners.
    </p>
</div>

<!-- Target Range Metric Toggle Buttons + KPI Cards -->
<div style="display: flex; align-items: stretch; justify-content: space-between; gap: 12px; margin: 12px 0; padding: 0; flex-wrap: wrap;">
    <div id="impactPartnersCard" class="kpi-card-animated" style="flex: 1; min-width: 230px; background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%); border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px 16px; box-shadow: 0 8px 18px rgba(59, 130, 246, 0.12);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #6366f1;">Partners Overview</div>
            <div style="font-size: 10px; font-weight: 700; color: #1f2937; background: rgba(99,102,241,0.12); padding: 3px 8px; border-radius: 999px;">KPI</div>
        </div>
        <div id="impactPartnersValue" style="margin-top: 6px; font-size: 20px; font-weight: 800; color: #1f2937;">--</div>
        <div id="impactPartnersSub" style="margin-top: 4px; font-size: 12px; color: #6b7280;">--</div>
        <div id="impactPartnersSplit" style="margin-top: 6px; font-size: 11px; color: #374151; font-weight: 600;">--</div>
    </div>
    <div style="display: flex; justify-content: center; gap: 14px; flex: 2; min-width: 360px; align-items: center;">
        <button class="impact-metric-toggle active" data-metric="fr" style="padding: 8px 24px; border: 2px solid #3b82f6; border-radius: 10px; background: #3b82f6; color: white; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 3px 8px rgba(59, 130, 246, 0.3);">
            <span style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 15px;">📸</span>
                <span>FR Range Impact</span>
            </span>
        </button>
        <button class="impact-metric-toggle" data-metric="dc" style="padding: 8px 24px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <span style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 15px;">🪪</span>
                <span>Driver Card Range Impact</span>
            </span>
        </button>
    </div>
    <div id="impactTargetsCard" class="kpi-card-animated" style="flex: 1; min-width: 230px; background: linear-gradient(135deg, #ecfeff 0%, #f8fafc 100%); border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px 16px; box-shadow: 0 8px 18px rgba(14, 165, 233, 0.12);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #0ea5e9;">Target Movement</div>
            <div style="font-size: 10px; font-weight: 700; color: #1f2937; background: rgba(14,165,233,0.12); padding: 3px 8px; border-radius: 999px;">KPI</div>
        </div>
        <div id="impactTargetsValue" style="margin-top: 6px; font-size: 18px; font-weight: 800; color: #1f2937;">--</div>
        <div id="impactTargetsSub" style="margin-top: 4px; font-size: 12px; color: #6b7280;">--</div>
        <div id="impactTargetsChange" style="margin-top: 6px; font-size: 11px; color: #374151; font-weight: 600;">--</div>
    </div>
</div>

<!-- Target Range Dynamic Title -->
<h4 id="impactTitle" style="text-align: center; color: #1f4e78; font-size: 15px; margin: 10px 0 8px 0; font-weight: 600;">Face Recognition (FR) All Partners Summary - Target Changes Across Ranges</h4>

<!-- Target Range Filter Buttons -->
<div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: flex-start; margin: 8px 0 10px 0;">
    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 50px;">View:</span>
        <button class="impact-filter-btn active" data-filter="all" style="padding: 5px 10px; border: 2px solid #3b82f6; border-radius: 6px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);">📊 All Partners (643)</button>
        <button class="impact-filter-btn" data-filter="withtarget" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">✅ With Target (551)</button>
        <button class="impact-filter-btn" data-filter="new" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">🆕 New Partners (158)</button>
        <button class="impact-filter-btn" data-filter="old" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">👥 Old Partners (485)</button>
        <button class="impact-filter-btn" data-filter="both" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">⚖️ New vs Old</button>
    </div>
    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap;">
        <span style="font-weight: 600; color: #374151; min-width: 90px;">Performance:</span>
        <button class="impact-perf-filter-btn" data-perf="all" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">All (551)</button>
        <button class="impact-perf-filter-btn" data-perf="good" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Good (252)</button>
        <button class="impact-perf-filter-btn" data-perf="average" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Average (262)</button>
        <button class="impact-perf-filter-btn" data-perf="bad" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px; transition: all 0.2s;">Bad (20)</button>
    </div>
</div>

<!-- Single Chart View -->
<div id="impactChartSingle" style="display: block; margin-bottom: 12px;">
    <canvas id="impactChartSingleCanvas"></canvas>
</div>

<!-- Overall Chart View -->
<div id="impactChartOverall" style="display: none; margin-bottom: 12px;">
    <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <h4 style="color: #1f4e78; margin: 0 0 8px 0; font-size: 14px;">📈 All Partners Summary - Partners Count by Range</h4>
        <canvas id="impactChartOverallCanvas"></canvas>
    </div>
</div>

<!-- Partners with Target Chart View -->
<div id="impactChartWithTarget" style="display: none; margin-bottom: 12px;">
    <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
        <h4 style="color: #1f4e78; margin: 0 0 8px 0; font-size: 14px;">✓ Partners with Target Summary - Active Partners Count by Range</h4>
        <canvas id="impactChartWithTargetCanvas"></canvas>
    </div>
</div>

<!-- Dual Chart View (New vs Old) -->
<div id="impactChartDual" style="display: none; gap: 14px; margin-bottom: 12px; width: 100%; box-sizing: border-box; flex-direction: row; align-items: stretch;">
    <div style="flex: 1; min-width: 0;">
        <div class="chart-container" style="overflow: hidden; height: 100%;">
            <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 15px 0;">New Partners (<3 months)</h4>
            <canvas id="impactChartNewBar" style="display: block;"></canvas>
        </div>
    </div>
    <div style="flex: 1; min-width: 0;">
        <div class="chart-container" style="overflow: hidden; height: 100%;">
            <h4 style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 15px 0;">Old Partners (≥3 months)</h4>
            <canvas id="impactChartOldBar" style="display: block;"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Tables (moved here) -->
<div id="impactDetailedTablesMount"></div>
</div>

<!-- CITY-WISE ANALYSIS VIEW -->
<div id="cityWiseView" style="display: none;">
    <div class="info-box" style="background: #f8fafc; border-left: 4px solid #8b5cf6; margin-bottom: 10px; padding: 8px 12px;">
        <p style="margin: 0; font-size: 12px; color: #4c1d95;">
            <strong>Overview:</strong> City-level FR/Driver Card performance with risk highlights. Bar colors reflect risk: <strong>High</strong> (red), <strong>Moderate</strong> (amber), <strong>Low</strong> (green). Rule: <strong>FR &lt; 85%</strong> = High risk, <strong>DC &lt; 30%</strong> = High risk; Moderate/Low are above these thresholds.
        </p>
    </div>

    <div style="display: flex; align-items: stretch; justify-content: space-between; gap: 10px; margin: 8px 0 10px 0; flex-wrap: wrap;">
        <div id="cityWiseAvgCard" class="kpi-card-animated" style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #eef2ff, #f8fafc); border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);">
            <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #6366f1;">Overall Average</div>
            <div id="cityWiseAvgCardValue" style="margin-top: 4px; font-size: 18px; font-weight: 800; color: #1f2937;">--</div>
            <div id="cityWiseAvgCardSub" style="margin-top: 2px; font-size: 11px; color: #6b7280;">Avg rate based on filter</div>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; flex: 2; min-width: 360px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 700; color: #374151; font-size: 12px;">Metric:</span>
                <button class="citywise-metric-btn active" data-metric="fr" style="padding: 6px 14px; min-width: 140px; border: 2px solid #3b82f6; border-radius: 8px; background: #3b82f6; color: white; font-weight: 700; cursor: pointer; font-size: 11px;">FR Rate & Target</button>
                <button class="citywise-metric-btn" data-metric="dc" style="padding: 6px 14px; min-width: 140px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 11px;">Driver Card Rate & Target</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #374151; font-size: 11px;">View:</span>
                    <button class="citywise-view-btn active" data-view="overview" style="padding: 5px 10px; border: 2px solid #8b5cf6; border-radius: 6px; background: #8b5cf6; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">Overall</button>
                    <button class="citywise-view-btn" data-view="range" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Range + Target</button>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #374151; font-size: 11px;">Tier:</span>
                    <button class="citywise-tier-btn active" data-tier="all" style="padding: 5px 10px; border: 2px solid #0ea5e9; border-radius: 6px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">All</button>
                    <button class="citywise-tier-btn" data-tier="t1" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1 Cities</button>
                    <button class="citywise-tier-btn" data-tier="t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T2 Cities</button>
                    <button class="citywise-view-btn" data-view="t1t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1 vs T2</button>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; color: #374151; font-size: 11px;">City:</span>
                    <select id="cityWiseCitySelect" style="padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-weight: 600; font-size: 11px;"></select>
                </div>
            </div>
        </div>
        <div id="cityWiseRiskCard" class="kpi-card-animated" style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #ecfeff, #f8fafc); border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);">
            <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: #0ea5e9;">Risk Count (Cities)</div>
            <div id="cityWiseRiskCardValue" style="margin-top: 4px; font-size: 16px; font-weight: 800; color: #1f2937;">High: -- | Low: --</div>
            <div id="cityWiseRiskCardSub" style="margin-top: 2px; font-size: 11px; color: #6b7280;">Based on current filter</div>
        </div>
    </div>

    <h4 id="cityWiseTitle" style="text-align: center; color: #1f4e78; font-size: 15px; margin: 10px 0 8px 0; font-weight: 600;">City-wise Compliance Overview (FR)</h4>

    <div id="cityWiseOverviewSection" class="chart-container" style="margin-bottom: 12px;">
        <canvas id="cityWiseOverviewChart"></canvas>
    </div>

    <div id="cityWiseTierOverviewSection" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityWiseT1Title" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T1 Cities</h4>
                <canvas id="cityWiseT1OverviewChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityWiseT2Title" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T2 Cities</h4>
                <canvas id="cityWiseT2OverviewChart"></canvas>
            </div>
        </div>
    </div>

    <div id="cityWiseRangeSection" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityWiseRangeTitle" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">Partners with Target by Range</h4>
                <canvas id="cityWiseRangeChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityWiseTargetRangeTitle" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">Target Range by City</h4>
                <canvas id="cityWiseTargetRangeChart"></canvas>
            </div>
        </div>
    </div>

    <button onclick="toggleTable(this, 'cityWiseDetailsTable')" style="width: 100%; padding: 10px 16px; background: #f97316; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view city details ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="cityWiseDetailsTable" style="display: none; margin-top: 12px;">
        <div id="cityWiseOverallTable" class="table-container" style="margin-bottom: 16px;">
            <h4 id="cityWiseOverallTableTitle" style="margin: 0 0 8px 0; color: #1f4e78; font-size: 14px;">City Overall Compliance (All Cities)</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f97316; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;"># of partners with target</th>
                        <th id="cityWiseOverallMetricHeader" style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Avg FR Rate %</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Risk</th>
                    </tr>
                </thead>
                <tbody id="cityWiseOverallTableBody"></tbody>
            </table>
        </div>
        <div id="cityWiseRangeTables" style="display: none;">
            <div class="table-container" style="margin-bottom: 16px;">
                <h4 id="cityWiseRangeTableTitle" style="margin: 0 0 8px 0; color: #1f4e78; font-size: 14px;">Partners with Target by Range (All Cities)</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f97316; color: white;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">0-20%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">20-30%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">30-40%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">40-50%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">50-60%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">60-80%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">>80%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Total</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="cityWiseRangeTableBody"></tbody>
                </table>
            </div>
            <div class="table-container">
                <h4 id="cityWiseTargetRangeTableTitle" style="margin: 0 0 8px 0; color: #1f4e78; font-size: 14px;">Target Range by City (All Cities)</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f97316; color: white;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">0-20%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">20-30%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">30-40%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">40-50%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">50-60%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">60-80%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">>80%</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Total</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="cityWiseTargetRangeTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- CITY TIER ANALYSIS SECTION -->
<div id="monthOverviewCityTier" style="margin-top: 20px; margin-bottom: 20px;">
<h3 style="color: #1f4e78; margin-bottom: 10px; font-size: 18px; border-bottom: 2px solid #0ea5e9; padding-bottom: 8px;">
    🏙️ City Tier Performance Analysis (Jan vs Feb)
</h3>

<!-- Summary Cards Section -->
<div id="cityTierSummaryCardsContainer" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px;">
    <div id="cityTierSummaryCard1" class="city-tier-summary-card tooltip-card" data-tooltip="City with the most partners with target in Feb. Tracks which city leads in partner capacity." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #0ea5e9, #06b6d4);"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); display: flex; align-items: center; justify-content: center; font-size: 16px;">🏆</div>
            <div>
                <div style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Highest City</div>
                <div id="summaryCard1Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">Riyadh</div>
                <div id="summaryCard1Sub" style="font-size: 11px; color: #6b7280;">200 partners (Feb)</div>
            </div>
        </div>
    </div>
    <div id="cityTierSummaryCard2" class="city-tier-summary-card tooltip-card" data-tooltip="City with the fewest partners with target in Feb. Highlights underrepresented areas." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); display: flex; align-items: center; justify-content: center; font-size: 16px;">📉</div>
            <div>
                <div style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Lowest City</div>
                <div id="summaryCard2Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">Jazan</div>
                <div id="summaryCard2Sub" style="font-size: 11px; color: #6b7280;">3 partners (Feb)</div>
            </div>
        </div>
    </div>
    <div id="cityTierSummaryCard3" class="city-tier-summary-card tooltip-card" data-tooltip="Total partners with an active target in Feb across all cities. MoM% shows month-over-month change." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #10b981, #34d399);"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); display: flex; align-items: center; justify-content: center; font-size: 16px;">📊</div>
            <div>
                <div style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total (Feb)</div>
                <div id="summaryCard3Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">551</div>
                <div id="summaryCard3Sub" style="font-size: 11px; color: #6b7280;">partners with target</div>
            </div>
        </div>
    </div>
    <div id="cityTierSummaryCard4" class="city-tier-summary-card tooltip-card" data-tooltip="City with the largest MoM% swing in partner count. Flags rapid growth or decline areas." style="background: white; border-radius: 12px; padding: 12px 14px; border: 1px solid #e5e7eb; box-shadow: 0 3px 12px rgba(0,0,0,0.06); position: relative; overflow: visible; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #8b5cf6, #a78bfa);"></div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); display: flex; align-items: center; justify-content: center; font-size: 16px;">📈</div>
            <div>
                <div style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Biggest MoM Change</div>
                <div id="summaryCard4Value" style="font-size: 18px; font-weight: 800; color: #1f4e78;">Jazan</div>
                <div id="summaryCard4Sub" style="font-size: 11px; color: #6b7280;">-40.0% MoM</div>
            </div>
        </div>
    </div>
</div>

<style>
.city-tier-summary-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.12);
}
.city-tier-summary-card.preparing {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
}
@keyframes cardFlyIn {
    0% { opacity: 0; transform: translateY(30px) scale(0.9); }
    60% { opacity: 1; transform: translateY(-5px) scale(1.02); }
    80% { transform: translateY(3px) scale(0.99); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}
.city-tier-summary-card.fly-in {
    animation: cardFlyIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
/* PS Summary Cards */
@keyframes psCardSlideIn {
    0% { opacity: 0; transform: translateY(24px) scale(0.92); }
    50% { opacity: 0.8; transform: translateY(-4px) scale(1.02); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}
.ps-summary-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.12);
}
.ps-summary-card.ps-card-updating {
    opacity: 0;
    transform: translateY(16px) scale(0.94);
}
@keyframes psCardFlyIn {
    0% { opacity: 0; transform: translateY(24px) scale(0.9); }
    55% { opacity: 1; transform: translateY(-4px) scale(1.02); }
    80% { transform: translateY(2px) scale(0.99); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}
.ps-summary-card.ps-card-fly-in {
    animation: psCardFlyIn 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
.city-tier-summary-card .card-value-transition {
    transition: all 0.3s ease;
}
</style>

<div style="display: flex; justify-content: center; gap: 10px; margin: 8px 0 12px 0; flex-wrap: wrap;">
    <button class="city-tier-view-toggle tooltip-btn tooltip-btn-blue active" data-view="city" data-tooltip="City-level comparison of Jan vs Feb by selected metric." style="padding: 7px 14px; border: 2px solid #0ea5e9; border-radius: 8px; background: #0ea5e9; color: white; font-weight: 700; cursor: pointer; font-size: 12px;">City Level Summary</button>
    <button class="city-tier-view-toggle tooltip-btn tooltip-btn-blue" data-view="tier" data-tooltip="Tier breakdown showing Jan vs Feb by city tier." style="padding: 7px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px;">City Tier Breakdown</button>
    <button class="city-tier-view-toggle tooltip-btn tooltip-btn-blue" data-view="performance" data-tooltip="Distribution of partner performance across cities." style="padding: 7px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px;">Performance Distribution</button>
    <button class="city-tier-view-toggle tooltip-btn tooltip-btn-blue" data-view="scale" data-tooltip="Distribution of partner scale across cities." style="padding: 7px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px;">Scale Distribution</button>
</div>

<!-- City Level Summary View -->
<div id="cityTierCityView" style="display: block;">
    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px;">
        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151; font-size: 12px;">Metric:</span>
            <button class="city-tier-metric-btn active" data-metric="partners" style="padding: 5px 10px; border: 2px solid #0ea5e9; border-radius: 6px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 11px;"># of partners with target</button>
            <button class="city-tier-metric-btn" data-metric="target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Total target</button>
            <button class="city-tier-metric-btn" data-metric="avg" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Avg scale</button>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 12px;">
        <h4 id="cityTierCityTitle" style="text-align: center; color: #1f4e78; font-size: 14px; margin: 0 0 8px 0;">City Comparison (Jan vs Feb)</h4>
        <canvas id="cityTierCityChart"></canvas>
    </div>

    <div id="cityTierCityNote" class="info-box" style="background: #f0f9ff; border-left: 4px solid #0ea5e9; margin-bottom: 10px; padding: 8px 12px;">
        <p style="margin: 0; font-size: 12px; color: #0f4a6e;">
            <strong>Note:</strong> Use slicers to compare Jan vs Feb by city and tier, with MoM% changes highlighted.
        </p>
    </div>

    <button onclick="toggleTable(this, 'cityTierCityTable')" style="width: 100%; padding: 8px 12px; background: #0ea5e9; border: none; color: white; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="cityTierCityTable" style="display: none; margin-top: 8px;">
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0ea5e9; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                    </tr>
                </thead>
                <tbody id="cityTierCityTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- City Tier Breakdown View -->
<div id="cityTierBreakdownView" style="display: none;">
    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px;">
        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151; font-size: 11px;">Tier:</span>
            <button class="city-tier-tier-btn active" data-tier="t1" style="padding: 5px 10px; border: 2px solid #0ea5e9; border-radius: 6px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">T1</button>
            <button class="city-tier-tier-btn" data-tier="t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T2</button>
            <button class="city-tier-tier-btn" data-tier="both" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1 vs T2</button>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151; font-size: 11px;">City:</span>
            <select id="cityTierCitySelectSingle" style="padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-weight: 600; font-size: 11px;">
                <option value="all">All (Tier summary)</option>
            </select>
            <select id="cityTierCitySelectT1" style="display: none; padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-weight: 600; font-size: 11px;">
                <option value="all">T1 (Tier summary)</option>
            </select>
            <select id="cityTierCitySelectT2" style="display: none; padding: 4px 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-weight: 600; font-size: 11px;">
                <option value="all">T2 (Tier summary)</option>
            </select>
            <button id="cityTierClearCityFilter" style="padding: 5px 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 11px;">Clear</button>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151; font-size: 11px;">Breakdown:</span>
            <button class="city-tier-breakdown-btn active" data-breakdown="overview" style="padding: 5px 10px; border: 2px solid #0ea5e9; border-radius: 6px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">Overview</button>
            <button class="city-tier-breakdown-btn" data-breakdown="city" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">City Level</button>
            <button class="city-tier-breakdown-btn" data-breakdown="performance" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Performance</button>
            <button class="city-tier-breakdown-btn" data-breakdown="scale" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Scale</button>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151; font-size: 11px;">Metric:</span>
            <button class="city-tier-breakdown-metric-btn active" data-metric="partners" style="padding: 5px 10px; border: 2px solid #0ea5e9; border-radius: 6px; background: #0ea5e9; color: white; font-weight: 600; cursor: pointer; font-size: 11px;"># of partners with target</button>
            <button class="city-tier-breakdown-metric-btn" data-metric="target" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Total target</button>
            <button class="city-tier-breakdown-metric-btn" data-metric="avg" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Avg scale</button>
        </div>
    </div>

    <div id="cityTierBreakdownSingle" class="chart-container" style="margin-bottom: 12px;">
        <h4 id="cityTierBreakdownTitle" style="text-align: center; color: #1f4e78; font-size: 14px; margin: 0 0 8px 0;">Tier Breakdown (Jan vs Feb)</h4>
        <canvas id="cityTierBreakdownChart"></canvas>
    </div>

    <div id="cityTierBreakdownDual" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityTierBreakdownTitleT1" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T1 Breakdown (Jan vs Feb)</h4>
                <canvas id="cityTierBreakdownChartT1"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 id="cityTierBreakdownTitleT2" style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T2 Breakdown (Jan vs Feb)</h4>
                <canvas id="cityTierBreakdownChartT2"></canvas>
            </div>
        </div>
    </div>

    <div id="cityTierBreakdownNote" class="info-box" style="background: #f8fafc; border-left: 4px solid #64748b; margin-bottom: 10px; padding: 8px 12px;">
        <p style="margin: 0; font-size: 12px; color: #475569;">
            <strong>Tip:</strong> Choose a tier and breakdown type. MoM% is shown on Feb values only.
        </p>
    </div>

    <button onclick="toggleTable(this, 'cityTierBreakdownTable')" style="width: 100%; padding: 8px 12px; background: #64748b; border: none; color: white; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="cityTierBreakdownTable" style="display: none; margin-top: 8px;">
        <div id="cityTierBreakdownSingleTable" class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #64748b; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Category</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                    </tr>
                </thead>
                <tbody id="cityTierBreakdownTableBody"></tbody>
            </table>
        </div>
        <div id="cityTierBreakdownDualTable" style="display: none;">
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                <div class="table-container" style="flex: 1; min-width: 320px;">
                    <h5 style="margin: 0 0 8px 0; color: #1f4e78;">T1 Details</h5>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #64748b; color: white;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Category</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                            </tr>
                        </thead>
                        <tbody id="cityTierBreakdownTableBodyT1"></tbody>
                    </table>
                </div>
                <div class="table-container" style="flex: 1; min-width: 320px;">
                    <h5 style="margin: 0 0 8px 0; color: #1f4e78;">T2 Details</h5>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #64748b; color: white;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Category</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                            </tr>
                        </thead>
                        <tbody id="cityTierBreakdownTableBodyT2"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- City Performance Distribution View -->
<div id="cityTierPerformanceView" style="display: none;">
    <div style="display: flex; justify-content: center; gap: 8px; margin: 4px 0 10px 0; flex-wrap: wrap;">
        <span style="font-weight: 600; color: #374151; font-size: 11px;">Breakdown:</span>
        <button class="city-tier-performance-filter active" data-filter="total" style="padding: 5px 10px; border: 2px solid #22c55e; border-radius: 6px; background: #22c55e; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">Total</button>
        <button class="city-tier-performance-filter" data-filter="t1" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1</button>
        <button class="city-tier-performance-filter" data-filter="t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T2</button>
        <button class="city-tier-performance-filter" data-filter="t1t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1 vs T2</button>
    </div>

    <div id="cityTierPerformanceSingle" class="chart-container" style="margin-bottom: 12px;">
        <h4 style="text-align: center; color: #1f4e78; font-size: 14px; margin: 0 0 8px 0;">City Performance Distribution (Partners with Target)</h4>
        <canvas id="cityTierPerformanceChart"></canvas>
    </div>
    <div id="cityTierPerformanceSplit" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T1 Cities</h4>
                <canvas id="cityTierPerformanceChartT1"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T2 Cities</h4>
                <canvas id="cityTierPerformanceChartT2"></canvas>
            </div>
        </div>
    </div>

    <div id="cityTierPerformanceNote" class="info-box" style="background: #f0fdf4; border-left: 4px solid #22c55e; margin-bottom: 10px; padding: 8px 12px;">
        <p style="margin: 0; font-size: 12px; color: #166534;">
            <strong>Insight:</strong> Distribution of Good / Average / Bad partners by city with % share. Use this to spot risk-heavy cities quickly.
        </p>
    </div>

    <button onclick="toggleTable(this, 'cityTierPerformanceTable')" style="width: 100%; padding: 8px 12px; background: #22c55e; border: none; color: white; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view performance details ▼</span>
        <span style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="cityTierPerformanceTable" style="display: none; margin-top: 8px;">
        <!-- Legend/Note Section -->
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; margin-bottom: 10px;">
            <div style="font-weight: 700; color: #1f4e78; margin-bottom: 6px; font-size: 12px;">📊 Highlight Legend & Risk Explanation</div>
            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #dcfce7; border: 2px solid #16a34a; border-radius: 3px;"></span>
                    <span style="font-size: 12px; color: #374151;">Top 3 Good Performance (Best cities with highest % of Good partners)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #fee2e2; border: 2px solid #dc2626; border-radius: 3px;"></span>
                    <span style="font-size: 12px; color: #374151;">Top 3 Bad Performance (Cities with highest % of Bad partners - needs attention)</span>
                </div>
            </div>
            <div style="font-weight: 600; color: #475569; font-size: 12px; margin-bottom: 6px;">Risk Level Definitions:</div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px;">
                <div><span style="color: #16a34a; font-weight: 700;">● Low Risk:</span> Good % ≥ 50% (Healthy performance distribution)</div>
                <div><span style="color: #f59e0b; font-weight: 700;">● Moderate Risk:</span> Good % 30-49% (Needs monitoring)</div>
                <div><span style="color: #dc2626; font-weight: 700;">● High Risk:</span> Good % < 30% OR Bad % ≥ 20% (Requires immediate action)</div>
            </div>
        </div>
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #22c55e; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Performance</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Partners with Target</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan target total</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb target total</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Change #</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Change %</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">City Share %</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Risk</th>
                    </tr>
                </thead>
                <tbody id="cityTierPerformanceTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- City Scale Distribution View -->
<div id="cityTierScaleView" style="display: none;">
    <div style="display: flex; justify-content: center; gap: 8px; margin: 4px 0 10px 0; flex-wrap: wrap;">
        <span style="font-weight: 600; color: #374151; font-size: 11px;">Breakdown:</span>
        <button class="city-tier-scale-filter active" data-filter="total" style="padding: 5px 10px; border: 2px solid #8b5cf6; border-radius: 6px; background: #8b5cf6; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">Total</button>
        <button class="city-tier-scale-filter" data-filter="t1" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1</button>
        <button class="city-tier-scale-filter" data-filter="t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T2</button>
        <button class="city-tier-scale-filter" data-filter="t1t2" style="padding: 5px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">T1 vs T2</button>
    </div>

    <div id="cityTierScaleSingle" class="chart-container" style="margin-bottom: 12px;">
        <h4 style="text-align: center; color: #1f4e78; font-size: 14px; margin: 0 0 8px 0;">City Scale Distribution (Partners with Target)</h4>
        <canvas id="cityTierScaleChart"></canvas>
    </div>
    <div id="cityTierScaleSplit" style="display: none; margin-bottom: 12px;">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T1 Cities</h4>
                <canvas id="cityTierScaleChartT1"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; min-width: 300px;">
                <h4 style="text-align: center; color: #1f4e78; font-size: 13px; margin: 0 0 8px 0;">T2 Cities</h4>
                <canvas id="cityTierScaleChartT2"></canvas>
            </div>
        </div>
    </div>

    <div id="cityTierScaleNote" class="info-box" style="background: #f5f3ff; border-left: 4px solid #8b5cf6; margin-bottom: 10px; padding: 8px 12px;">
        <p style="margin: 0; font-size: 12px; color: #5b21b6;">
            <strong>Insight:</strong> Distribution of Big / Mid / Small scale partners by city with % share. Understand partner scale mix across cities.
        </p>
    </div>

    <button onclick="toggleTable(this, 'cityTierScaleTable')" style="width: 100%; padding: 8px 12px; background: #8b5cf6; border: none; color: white; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view scale details ▼</span>
        <span style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="cityTierScaleTable" style="display: none; margin-top: 8px;">
        <!-- Legend/Note Section -->
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; margin-bottom: 10px;">
            <div style="font-weight: 700; color: #1f4e78; margin-bottom: 6px; font-size: 12px;">📊 Highlight Legend & Scale Explanation</div>
            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #ede9fe; border: 2px solid #8b5cf6; border-radius: 3px;"></span>
                    <span style="font-size: 12px; color: #374151;">Top 3 Big Partners (Cities with highest % of Big scale partners)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 16px; height: 16px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 3px;"></span>
                    <span style="font-size: 12px; color: #374151;">Top 3 Small Partners (Cities with highest % of Small scale partners)</span>
                </div>
            </div>
            <div style="font-weight: 600; color: #475569; font-size: 12px; margin-bottom: 6px;">Scale Definitions:</div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px;">
                <div><span style="color: #7c3aed; font-weight: 700;">● Big:</span> High capacity partners (Top tier)</div>
                <div><span style="color: #0ea5e9; font-weight: 700;">● Mid:</span> Medium capacity partners</div>
                <div><span style="color: #f59e0b; font-weight: 700;">● Small:</span> Lower capacity partners</div>
            </div>
        </div>
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #8b5cf6; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">City</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Scale</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Partners with Target</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan target total</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb target total</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Change #</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Change %</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">City Share %</th>
                    </tr>
                </thead>
                <tbody id="cityTierScaleTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- TARGET MOVEMENT ANALYSIS SECTION -->
<div id="monthOverviewTargetMovement" style="margin-top: 50px; margin-bottom: 50px;">
<h3 style="color: #1f4e78; margin-bottom: 20px; font-size: 22px; border-bottom: 3px solid #7c3aed; padding-bottom: 10px;">
    🎯 Target Movement Analysis (Jan vs Feb)
</h3>

<!-- Summary Cards Row -->
<div id="targetMovementSummaryCards" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
    <div class="tooltip-card" data-tooltip="MoM change in total partners with target (Jan: 625 → Feb: 551)" style="flex: 1; min-width: 130px; max-width: 165px; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(124, 58, 237, 0.1); border: 1px solid #ddd6fe; border-top: 3px solid #7c3aed; position: relative;">
        <div style="font-size: 11px; color: #7c3aed; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px;">MoM Partners</div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span id="tmCardMoMPartners" style="font-size: 20px; font-weight: 800; color: #7c3aed;">-11.8%</span>
            <span id="tmCardMoMPartnersArrow" style="font-size: 12px; color: #dc2626;">▼</span>
        </div>
    </div>
    <div class="tooltip-card" data-tooltip="Increased − Decreased: 153 − 284 = -131 (more decreases than increases)" style="flex: 1; min-width: 130px; max-width: 165px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #3b82f6; position: relative;">
        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Net Movement</div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span id="tmCardNetImpact" style="font-size: 18px; font-weight: 700; color: #1f2937;">-131</span>
            <span id="tmCardNetImpactArrow" style="font-size: 12px; color: #dc2626;">▼</span>
        </div>
    </div>
    <div class="tooltip-card" data-tooltip="Partners with increased target: Jan 212 → Feb 153 | Change: -59 (-27.8%)" style="flex: 1; min-width: 130px; max-width: 165px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #16a34a; position: relative;">
        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Increased</div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span id="tmCardIncreased" style="font-size: 18px; font-weight: 700; color: #1f2937;">153</span>
            <span id="tmCardIncreasedMoM" style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -27.8%</span>
        </div>
    </div>
    <div class="tooltip-card" data-tooltip="Partners with decreased target: Jan 240 → Feb 284 | Change: +44 (+18.3%)" style="flex: 1; min-width: 130px; max-width: 165px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #dc2626; position: relative;">
        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Decreased</div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span id="tmCardDecreased" style="font-size: 18px; font-weight: 700; color: #1f2937;">284</span>
            <span id="tmCardDecreasedMoM" style="font-size: 11px; font-weight: 600; color: #16a34a;">MoM +18.3%</span>
        </div>
    </div>
    <div class="tooltip-card" data-tooltip="Partners with no change: Jan 173 → Feb 114 | Change: -59 (-34.1%)" style="flex: 1; min-width: 130px; max-width: 165px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #f59e0b; position: relative;">
        <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">No Change</div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span id="tmCardNoChange" style="font-size: 18px; font-weight: 700; color: #1f2937;">114</span>
            <span id="tmCardNoChangeMoM" style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -34.1%</span>
        </div>
    </div>
</div>

<!-- Target Increase/Decrease Overview -->
<div style="margin-bottom: 24px;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 14px;">
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 700; color: #374151;">View:</span>
            <button class="target-move-view-btn tooltip-btn tooltip-btn-purple active" data-view="overall" data-tooltip="Overall view compares Jan vs Feb totals for partners with target, and splits movement into Increase, Decrease, and No Change so you can see net direction at a glance." style="padding: 6px 12px; border: 2px solid #7c3aed; border-radius: 8px; background: #7c3aed; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Overall</button>
            <button id="breakdownViewBtn" class="target-move-view-btn tooltip-btn tooltip-btn-purple" data-view="breakdown" data-tooltip="Breakdown view drills into the movement type and shows how Good/Average/Bad segments shifted from Jan to Feb, with MoM labels on Feb values for quick read." style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;"><span id="breakdownArrow" style="margin-right: 4px; transition: transform 0.2s;">◀</span>Breakdown</button>
        </div>
        <div id="breakdownFilterContainer" style="display: none; align-items: center; gap: 8px; flex-wrap: nowrap; border-left: 2px solid #e5e7eb; padding-left: 12px;">
            <span style="font-weight: 600; color: #374151;">Breakdown:</span>
            <button class="target-move-breakdown-btn tooltip-btn tooltip-btn-purple active" data-breakdown="increased" data-tooltip="Partners whose targets increased. Use this to see which performance segments drove growth from Jan to Feb." style="padding: 6px 12px; border: 2px solid #7c3aed; border-radius: 8px; background: #7c3aed; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Total Increased</button>
            <button class="target-move-breakdown-btn tooltip-btn tooltip-btn-purple" data-breakdown="decreased" data-tooltip="Partners whose targets decreased. Highlights segments contributing to the drop and where reductions are concentrated." style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Total Decreased</button>
            <button class="target-move-breakdown-btn tooltip-btn tooltip-btn-purple" data-breakdown="nochange" data-tooltip="Partners with no target change. Useful for stability analysis and identifying segments with steady targets." style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">No Change</button>
        </div>
    </div>

    <!-- Side by Side Container -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
        <!-- Overall Section -->
        <div id="targetMovementOverallSection" style="flex: 1; min-width: 400px;">
            <h4 style="color: #1f4e78; margin: 0 0 12px 0; font-size: 16px;">📈 Overall</h4>

            <div style="background: #ede9fe; border-left: 4px solid #7c3aed; border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; min-height: 36px; display: flex; align-items: center;">
                <p style="color: #4c1d95; margin: 0; font-size: 12px;"><strong>Note:</strong> MoM% shown on Feb values. Bars: Jan vs Feb comparison.</p>
            </div>

            <div class="chart-container" style="margin-bottom: 16px; height: 340px;">
                <canvas id="targetMovementSummaryChart"></canvas>
            </div>
        </div>

        <!-- Breakdown Section -->
        <div id="targetMovementBreakdownSection" style="flex: 1; min-width: 400px;">
            <h4 style="color: #1f4e78; margin: 0 0 12px 0; font-size: 16px;">🧩 Breakdown</h4>

            <div id="targetMovementInsight" style="background: #ede9fe; border-left: 4px solid #7c3aed; border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; min-height: 36px; display: flex; align-items: center;">
                <p style="color: #4c1d95; margin: 0; font-size: 12px;"></p>
            </div>

            <div class="chart-container" style="margin-bottom: 16px; height: 340px;">
                <h4 id="targetMovementBreakdownTitle" style="text-align: center; color: #1f4e78; font-size: 14px; margin: 0 0 8px 0;">Breakdown (Jan vs Feb)</h4>
                <canvas id="targetMovementBreakdownChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Riders Slab Distribution -->
<div>
    <h4 style="color: #1f4e78; margin: 0 0 16px 0; font-size: 16px;">📊 Riders Slab Distribution (Jan vs Feb)</h4>
    
    <!-- Summary Cards Row -->
    <div id="ridersSlabSummaryCards" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 18px;">
        <div class="tooltip-card-teal" data-tooltip="Total partners: Jan 625 → Feb 551 | Change: -74 (-11.8%)" style="flex: 1; min-width: 155px; max-width: 180px; background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(15, 118, 110, 0.1); border: 1px solid #99f6e4; border-top: 3px solid #0f766e; position: relative;">
            <div style="font-size: 11px; color: #0f766e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px;">Total Partners</div>
            <div style="display: flex; align-items: baseline; gap: 6px; white-space: nowrap;">
                <span style="font-size: 20px; font-weight: 800; color: #0f766e;">551</span>
                <span style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -11.8% ▼</span>
            </div>
        </div>
        <div class="tooltip-card-teal" data-tooltip="Small scale (1-19 riders): Jan 181 → Feb 141 | Change: -40 (-22.1%)" style="flex: 1; min-width: 155px; max-width: 180px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #3b82f6; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Small Scale</div>
            <div style="display: flex; align-items: baseline; gap: 6px; white-space: nowrap;">
                <span style="font-size: 18px; font-weight: 700; color: #1f2937;">141</span>
                <span style="font-size: 10px; color: #6b7280;">partners</span>
                <span style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -22.1%</span>
            </div>
        </div>
        <div class="tooltip-card-teal" data-tooltip="Mid scale (20-49 riders): Jan 328 → Feb 316 | Change: -12 (-3.7%)" style="flex: 1; min-width: 155px; max-width: 180px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #f59e0b; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Mid Scale</div>
            <div style="display: flex; align-items: baseline; gap: 6px; white-space: nowrap;">
                <span style="font-size: 18px; font-weight: 700; color: #1f2937;">316</span>
                <span style="font-size: 10px; color: #6b7280;">partners</span>
                <span style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -3.7%</span>
            </div>
        </div>
        <div class="tooltip-card-teal" data-tooltip="Large scale (50+ riders): Jan 116 → Feb 94 | Change: -22 (-19.0%)" style="flex: 1; min-width: 155px; max-width: 180px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #10b981; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Large Scale</div>
            <div style="display: flex; align-items: baseline; gap: 6px; white-space: nowrap;">
                <span style="font-size: 18px; font-weight: 700; color: #1f2937;">94</span>
                <span style="font-size: 10px; color: #6b7280;">partners</span>
                <span style="font-size: 11px; font-weight: 600; color: #dc2626;">MoM -19.0%</span>
            </div>
        </div>
        <div class="tooltip-card-teal" data-tooltip="Most common target range in Feb: 20-30 riders with 160 partners" style="flex: 1; min-width: 155px; max-width: 180px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #8b5cf6; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Peak Slab</div>
            <div style="display: flex; align-items: baseline; gap: 6px; white-space: nowrap;">
                <span style="font-size: 14px; font-weight: 700; color: #1f2937;">20-30</span>
                <span style="font-size: 10px; color: #6b7280;">160 partners</span>
            </div>
        </div>
    </div>
    
    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 14px;">
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;">
            <span style="font-weight: 600; color: #374151;">View:</span>
            <button class="riders-slab-view-btn tooltip-btn tooltip-btn-teal active" data-view="total" data-tooltip="All partners with a target, shown by riders slab to compare Jan vs Feb distribution." style="padding: 6px 12px; border: 2px solid #0f766e; border-radius: 8px; background: #0f766e; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">Total with Target</button>
            <button class="riders-slab-view-btn tooltip-btn tooltip-btn-teal" data-view="increased" data-tooltip="Only partners whose targets increased; shows which rider slabs gained the most." style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Increased Target</button>
            <button class="riders-slab-view-btn tooltip-btn tooltip-btn-teal" data-view="decreased" data-tooltip="Only partners whose targets decreased; highlights slabs with the biggest declines." style="padding: 6px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">Decreased Target</button>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 16px; height: 320px;">
        <h4 id="ridersSlabTitle" style="text-align: center; color: #1f4e78; font-size: 15px; margin: 0 0 10px 0;">Riders Slab Distribution (Jan vs Feb)</h4>
        <canvas id="ridersSlabChart"></canvas>
    </div>

    <button onclick="toggleTable(this, 'ridersSlabTable')" style="width: 100%; padding: 10px 16px; background: #0f766e; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Click to view detailed data ▼</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">Collapsed</span>
    </button>
    <div id="ridersSlabTable" style="display: none; margin-top: 12px;">
        <div class="table-container">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #0f766e; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Slab</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Jan</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Feb</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">MoM %</th>
                    </tr>
                </thead>
                <tbody id="ridersSlabTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
</div>

    <!-- TOP/BOTTOM PARTNERS OVERVIEW SECTION -->
    <div id="monthOverviewTopBottom" style="margin-top: 50px; margin-bottom: 50px;">
    <h3 style="color: #1f4e78; margin-bottom: 20px; font-size: 22px; border-bottom: 3px solid #0ea5e9; padding-bottom: 10px;">
        📌 Top & Bottom Partners Overview (Jan vs Feb)
    </h3>

    <!-- Summary Cards Row -->
    <div id="partnersOverviewSummaryCards" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 18px;">
        <div class="tooltip-card-sky" data-tooltip="Number of partners shown in selected view" style="flex: 1; min-width: 120px; max-width: 150px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1); border: 1px solid #bae6fd; border-top: 3px solid #0ea5e9; position: relative;">
            <div style="font-size: 11px; color: #0ea5e9; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px;">Partners</div>
            <div style="display: flex; align-items: baseline; gap: 6px;">
                <span id="poCardPartners" style="font-size: 20px; font-weight: 800; color: #0284c7;">20</span>
            </div>
        </div>
        <div id="poCardTotalTargetContainer" class="tooltip-card-sky" data-tooltip="Total target riders across all partners in Feb" style="flex: 1; min-width: 120px; max-width: 150px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #3b82f6; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Total Target</div>
            <div style="display: flex; align-items: baseline; gap: 6px;">
                <span id="poCardTotalTarget" style="font-size: 18px; font-weight: 700; color: #1f2937;">3,833</span>
                <span id="poCardTargetPct" style="font-size: 11px; font-weight: 600; color: #0284c7;">19.8%</span>
            </div>
        </div>
        <div class="tooltip-card-sky" data-tooltip="Partners with Good performance rating in Feb" style="flex: 1; min-width: 120px; max-width: 150px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #16a34a; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Good Perf.</div>
            <div style="display: flex; align-items: baseline; gap: 6px;">
                <span id="poCardGood" style="font-size: 18px; font-weight: 700; color: #16a34a;">14</span>
                <span style="font-size: 10px; color: #6b7280;">partners</span>
            </div>
        </div>
        <div class="tooltip-card-sky" data-tooltip="Partners with Average performance rating in Feb" style="flex: 1; min-width: 120px; max-width: 150px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #f59e0b; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Avg Perf.</div>
            <div style="display: flex; align-items: baseline; gap: 6px;">
                <span id="poCardAvg" style="font-size: 18px; font-weight: 700; color: #f59e0b;">6</span>
                <span style="font-size: 10px; color: #6b7280;">partners</span>
            </div>
        </div>
        <div class="tooltip-card-sky" data-tooltip="Average Face Recognition Rate / Driver Card % across partners in Feb" style="flex: 1; min-width: 140px; max-width: 170px; background: white; border-radius: 10px; padding: 12px 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; border-top: 3px solid #8b5cf6; position: relative;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">Avg FR / DC %</div>
            <div style="display: flex; align-items: baseline; gap: 4px;">
                <span id="poCardAvgFR" style="font-size: 16px; font-weight: 700; color: #1f2937;">96.1%</span>
                <span style="font-size: 12px; color: #6b7280;">/</span>
                <span id="poCardAvgDC" style="font-size: 16px; font-weight: 700; color: #1f2937;">40.0%</span>
            </div>
        </div>
    </div>

    <div style="display: flex; justify-content: center; gap: 12px; margin: 10px 0 18px 0; flex-wrap: wrap;">
        <button class="partners-overview-btn tooltip-btn tooltip-btn-sky active" data-view="top" data-tooltip="Top 20 partners by rider count, showing Jan vs Feb targets, riders, performance, and compliance." style="padding: 10px 18px; border: 2px solid #0ea5e9; border-radius: 10px; background: #0ea5e9; color: white; font-weight: 700; cursor: pointer; font-size: 13px;">Top 20 Biggest Partners</button>
        <button class="partners-overview-btn tooltip-btn tooltip-btn-sky" data-view="bottom" data-tooltip="Bottom 20 partners by rider count, highlighting low-scale partners and their Jan vs Feb target movement." style="padding: 10px 18px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px;">Bottom 20 Smallest Partners</button>
        <button class="partners-overview-btn tooltip-btn tooltip-btn-sky" data-view="ranked" data-tooltip="Top 20 partners ranked by the highest number of covered cities across the Kingdom, reflecting the widest geographic reach." style="padding: 10px 18px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 13px;">Top 20 Ranked Partners</button>
    </div>

    <div class="table-container" style="margin-bottom: 14px; overflow-x: auto;">
        <table id="partnersOverviewTable" style="width: 100%; border-collapse: collapse; min-width: 1200px;">
            <thead id="partnersOverviewTableHead">
                <tr style="background: #0ea5e9; color: white;">
                    <th rowspan="2" style="padding: 10px; text-align: center; border: 1px solid #d1d5db; min-width: 40px; vertical-align: middle;">#</th>
                    <th rowspan="2" style="padding: 10px; text-align: left; border: 1px solid #d1d5db; min-width: 200px; vertical-align: middle;">Partner</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;"># of cities</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">New/Old</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Delivery riders</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Total target</th>
                    <th rowspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db; vertical-align: middle;">MoM %<br>(Target)</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Performance</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Avg FR %</th>
                    <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Avg Driver Card %</th>
                </tr>
                <tr style="background: #0284c7; color: white;">
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                    <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                </tr>
            </thead>
            <tbody id="partnersOverviewTableBody"></tbody>
        </table>
    </div>

    <div id="partnersOverviewNote" style="background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 8px; padding: 12px;">
        <p style="color: #0c4a6e; margin: 0; font-size: 13px;">
            <strong>📋 Note:</strong> Table compares Jan vs Feb per partner. MoM% shown for Total Target only. Total target reflects riders across all covered cities. Performance is based on highest-target city. FR & Driver Card rates are averaged across cities.
        </p>
    </div>
    </div>

<div style="margin-top: 40px;">
<h3 id="monthOverviewSuccessMetrics" style="color: #1f4e78; margin-bottom: 20px; font-size: 22px; border-bottom: 3px solid #059669; padding-bottom: 10px;">
                    ✅ February 2026 Success Metrics
                </h3>
<div class="info-box" style="background: #f0fdf4; border-left: 4px solid #059669; margin-bottom: 18px;">
<p style="margin: 0; font-size: 14px; color: #065f46;">
<strong>Performance Breakdown:</strong> Toggle between Capacity Target & Avg Scale, and Next Month Target to review achievement, gaps, % by segment, and strategic planning.
                    </p>
</div>

<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
    <button class="success-metrics-toggle active" data-metric="capacity" style="padding: 8px 16px; border: 2px solid #059669; border-radius: 10px; background: #059669; color: white; font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.4s ease;">Capacity Target & Avg Scale</button>
    <button class="success-metrics-toggle" data-metric="nextmonth" style="padding: 8px 16px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.4s ease;">🎯 Next Month Target</button>
    <button class="success-metrics-toggle" data-metric="okrs" style="padding: 8px 16px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #6b7280; font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.4s ease;">📋 2026 OKRs Summary (Not yet ready)</button>
</div>

<!-- OKRs Summary Section -->
<div id="okrsSummarySection" style="display: none;">
    <!-- Executive Summary -->
    <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: white;">
        <h4 style="margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
            <span>🎯</span> Q1 2026 Strategic Mandate
        </h4>
        <p style="margin: 0; font-size: 13px; line-height: 1.6; opacity: 0.95;">
            Cut cost per order while growing dependable supply. Gate capacity by compliance first, shift targets toward high-performers, run 3-month bands for stability, and execute 30/60/90 turnarounds for weak partners. Consolidate scale to lift average riders per partner, cap single-partner exposure per city, and use long-term assessment + incentives to raise willingness where it matters.
        </p>
    </div>

    <!-- Team Objectives Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100%, 1fr)); gap: 16px;">

        <!-- O1: Cost Reduction via Scale Growth -->
        <div class="okr-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleOkrCard(this)" style="width: 100%; padding: 14px 18px; background: linear-gradient(90deg, #5a7c91 0%, #7494a8 100%); border: none; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; margin-right: 10px;">O1</span> Reduce CPO via Scale Growth (Q1) — Target: 0.39 SAR/order</span>
                <span style="font-size: 18px; transition: transform 0.3s;">▼</span>
            </button>
            <div class="okr-card-content" style="padding: 16px; display: none;">
                <div style="background: #f0f4f7; border-left: 4px solid #5a7c91; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #3d5a6f;"><strong>Team Objective:</strong> Reduce 0.444 SAR per order in Q1</p>
                </div>

                <!-- KR1 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR1: Raise avg riders/partner from ~33 → ≥45</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Reallocate from small/weak partners (<20 riders) to reliable partners. Lock 3-month bands; retain ≥70% of peak gains. Protect priority cities.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">35.9 avg scale target</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #fef3c7;"><strong>35.9</strong> (79.8% to target)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR2 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR2: Deliver ≥0.39 SAR/order CPO reduction from scale</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Concentrate capacity on Good & compliant partners. Enforce SOP + maker/checker to cut overrides (willingness & special cases with proof process).</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;"><strong>Good:</strong> 55.2% share | <strong>Avg:</strong> 37.7% | <strong>Bad:</strong> 7.1%</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR3 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR3: Frontline engagement (PMM/CH)</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Assign avg scale/partner target to PMM by performance level. Push alignment with partners to prepare riders accordingly.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Monthly (until Mar 31)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">Target assigned per city to share with CH</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">Partners count shared with PMM/CH to reach avg scale target</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- O2: Compliance & Experience -->
        <div class="okr-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleOkrCard(this)" style="width: 100%; padding: 14px 18px; background: linear-gradient(90deg, #8b7eb8 0%, #a89dc7 100%); border: none; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; margin-right: 10px;">O2</span> Improve Compliance & Experience (Q1) — Target: 25% → 80%</span>
                <span style="font-size: 18px; transition: transform 0.3s;">▼</span>
            </button>
            <div class="okr-card-content" style="padding: 16px; display: none;">
                <div style="background: #f6f4fa; border-left: 4px solid #8b7eb8; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #5c4f82;"><strong>Team Objective:</strong> Raise compliance rate from 25% to 80% in Q1</p>
                </div>

                <!-- KR -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR: Good/strong partners carry ≥58-60% of capacity target; Bad partners ≤5%</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Use weighted operational metrics. Add driver card to performance assessment. Assign highest capacity to highest compliant partners (FR, driver card, etc.).</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">28.7% driver card rate</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">Driver card in ops metrics from Jan 19. Will use in March target. <strong>Good: 55%</strong> (from 55% target) | <strong>Bad: 7%</strong> (vs 5% target)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- O3: Long-term Assessment & Willingness -->
        <div class="okr-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleOkrCard(this)" style="width: 100%; padding: 14px 18px; background: linear-gradient(90deg, #5c9ca8 0%, #7ab5c0 100%); border: none; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; margin-right: 10px;">O3</span> Long-term Assessment & Willingness (Q1)</span>
                <span style="font-size: 18px; transition: transform 0.3s;">▼</span>
            </button>
            <div class="okr-card-content" style="padding: 16px; display: none;">
                <div style="background: #f0f7f9; border-left: 4px solid #5c9ca8; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #3e6d78;"><strong>Team Objective:</strong> Ensure capacity fulfillment via long-term partner assessment</p>
                </div>

                <!-- KR1 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR1: Build V1 new partners assessment model</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Benchmark competitors, design new assessment, align with Keeta CPO target, finalize criteria/rewards structure.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Plan: Feb 28; Pilot: Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #fef3c7;">Pending — Start after March capacity target (2nd week Feb)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR2 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR2: Publish assessment plan; pilot T2 cities</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Determine T2 cities for pilot phase of new assessment.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Plan: Feb 28; Pilot: Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #fef3c7;">Pending — Start after March capacity target (2nd week Feb)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR3 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR3: Partner willingness +≥8-10pp vs Jan in pilots</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Establish incentives for partners with highest growth potential based on total riders including other platforms.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">Willingness data from Monthly Insights (Jan)</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR4 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR4: Deliver evaluation & product alignment</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Evaluate partners stratification, align on execution process.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 15</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- O4: Allocation Accuracy & Fulfillment -->
        <div class="okr-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleOkrCard(this)" style="width: 100%; padding: 14px 18px; background: linear-gradient(90deg, #4d9a7e 0%, #6bb59a 100%); border: none; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; margin-right: 10px;">O4</span> Allocation Accuracy & Fulfillment (Q1) — Target: ≥100% FR</span>
                <span style="font-size: 18px; transition: transform 0.3s;">▼</span>
            </button>
            <div class="okr-card-content" style="padding: 16px; display: none;">
                <div style="background: #f0f7f4; border-left: 4px solid #4d9a7e; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #366b56;"><strong>Team Objective:</strong> Iterate target allocation mechanism; reduce PMM adjustment to 10%; achieve ≥100% monthly capacity FR</p>
                </div>

                <!-- KR1 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR1: Reduce manual adjustment by 10%</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Pre-planning alignment; parameterized gates; data-driven insights. Quick audits and consistent review. SOP + willingness tracker for special cases.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #fef3c7;">In progress — Collecting data</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR2 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR2: March capacity FR 98-100%</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Apply capacity target rules for high FR%. Focus on high FR partners and reward with capacity target.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #dcfce7;"><strong>96%</strong> FR (based on Jan 1 data: 73.8%). Push for 100%</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KR3 -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR3: Promote ≥20 partners to ≥150 riders</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Scale top performers; mid → big path for compliant partners using monthly compliance targets + high quality metrics.</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; background: #fef3c7;">7.1% target reduction in Jan — Will prioritize in Feb</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- O5: Concentration Risk -->
        <div class="okr-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
            <button onclick="toggleOkrCard(this)" style="width: 100%; padding: 14px 18px; background: linear-gradient(90deg, #d4a154 0%, #e4bb7a 100%); border: none; color: white; font-weight: 700; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                <span><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; margin-right: 10px;">O5</span> Manage Concentration Risk (Q1)</span>
                <span style="font-size: 18px; transition: transform 0.3s;">▼</span>
            </button>
            <div class="okr-card-content" style="padding: 16px; display: none;">
                <div style="background: #faf6ed; border-left: 4px solid #d4a154; padding: 12px; border-radius: 0 8px 8px 0; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #7a5c2e;"><strong>Team Objective:</strong> Reduce group-wide risks & ensure fulfillment stability</p>
                </div>

                <!-- KR -->
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <h5 style="margin: 0; font-size: 13px; color: #1f2937;">KR: Single-partner share ≤X% per city; remediate any breach within cycle</h5>
                    </div>
                    <div style="padding: 12px;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #4b5563;"><strong>How:</strong> Map current city data and set metrics. Set city caps in model with alert + reallocation rules. Review capacity growth factor for enhancement.</p>
                        <p style="margin: 0 0 10px 0; font-size: 11px; color: #b45309; background: #fef3c7; padding: 8px; border-radius: 4px;"><strong>⚠️ Potential conflict:</strong> Balance between concentration risk goal and avg scale increase goal</p>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">Deadline</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Jan)</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">O Progress (Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #e5e7eb;">Mar 31</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="successMetricsCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; margin-bottom: 18px;"></div>

<div class="highlight-box" id="successMetricsInsights">
    <h4 style="color: #065f46; margin-bottom: 12px;">💡 Key Observations</h4>
    <ul style="margin: 0; padding-left: 20px;">
        <li style="margin-bottom: 8px;">Loading insights...</li>
    </ul>
</div>
</div>

</div>

<!-- DETAILED TABLES SECTION (Target Range Only) -->
<div id="detailedTablesSection" style="display: none;">

<!-- FR DETAILED TABLES -->
<div id="frDetailedTablesWrapper" style="margin-bottom: 20px;">
    <button onclick="toggleTable(this, 'frDetailedTables')" style="width: 100%; padding: 12px 20px; background: #3b82f6; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ FR Range Impact - Detailed Data (New / Old / Consolidated)</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 4px;">Click to expand</span>
    </button>
    <div id="frDetailedTables" style="display: none; margin-top: 15px;">
        
        <!-- New Partners FR Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 New Partners (&lt;3 months) - FR Range Impact</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #1e5a8e; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">FR% Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">16</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">16</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">305</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">359</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+54</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+17.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1.0%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">91</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-91</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">195</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">19</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-176</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-90.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36.7%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">227</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-227</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">2</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">642</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-642</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">56.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">14</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">7</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,596</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">115</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-1,481</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-92.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">71.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">71.8%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">125</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">103</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,898</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">2,469</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+571</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+30.1%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">95.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">96.0%</td>
                        </tr>
                        <tr style="background: #e0f2fe; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">158</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">127</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">4,954</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">2,962</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-1,992</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-40.2%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">83.2%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">82.2%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Old Partners FR Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 Old Partners (≥3 months) - FR Range Impact</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #1e5a8e; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">FR% Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">113</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">10</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-103</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-91.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0.0%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">90</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-90</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">26.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">239</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-239</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,004</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-1,004</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">990</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">11</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-979</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-98.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">52.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">52.9%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">22</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">16</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">6,870</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">513</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-6,357</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-92.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">73.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">74.2%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">460</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">406</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">8,193</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">15,869</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+7,676</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+93.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">96.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">96.6%</td>
                        </tr>
                        <tr style="background: #e0f2fe; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">485</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">424</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">17,499</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">16,403</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-1,096</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-6.3%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">95.1%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">95.4%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Consolidated FR Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 All Partners - FR Range Impact (Consolidated)</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #1e5a8e; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">FR% Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg FR % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">17</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">17</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">418</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">369</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-49</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-11.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1.0%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">181</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-181</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">26.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">434</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">19</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-415</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-95.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36.7%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,231</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">0</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-1,231</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-100%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">—</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,632</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">11</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-1,621</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-99.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">55.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">52.9%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">23</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">8,466</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">628</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-7,838</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-92.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">72.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">73.5%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">585</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">509</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">10,091</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">18,338</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+8,247</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+81.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">96.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">96.5%</td>
                        </tr>
                        <tr style="background: #e0f2fe; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">643</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">551</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">22,453</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">19,365</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-3,088</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center; background: #fee2e2; color: #991b1b;">-13.8%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">92.2%</td>
                            <td style="padding: 10px; border: 1px solid #3b82f6; text-align: center;">92.4%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- EXPANDABLE DETAILED TABLES FOR FR & DRIVER CARD -->
<h4 style="color: #1f4e78; margin: 40px 0 15px 0; font-size: 18px;">📋 Detailed Data Tables</h4>

<!-- DRIVER CARD DETAILED TABLES -->
<div id="dcDetailedTablesWrapper" style="margin-bottom: 30px; display: none;">
    <button onclick="toggleTable(this, 'dcDetailedTables')" style="width: 100%; padding: 12px 20px; background: #f97316; border: none; color: white; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 14px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
        <span>▼ Driver Card Range Impact - Detailed Data (New / Old / Consolidated)</span>
        <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 4px;">Click to expand</span>
    </button>
    <div id="dcDetailedTables" style="display: none; margin-top: 15px;">
        
        <!-- New Partners Driver Card Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 New Partners (&lt;3 months) - Driver Card Range Impact</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #ea580c; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Driver Card % Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">88</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">60</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3,073</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,360</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-1,713</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-55.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3.1%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3.5%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">9</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">8</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">475</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">249</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-226</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-47.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.3%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">2</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">2</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">207</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">70</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-137</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-66.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">38.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">38.8%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">5</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">5</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">136</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">78</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-58</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-42.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43.2%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">7</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">7</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">129</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+86</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+200%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.7%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">9</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">9</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">238</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">201</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-37</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-15.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">71.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">71.0%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">38</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">782</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">875</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+93</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+11.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">94.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">95.6%</td>
                        </tr>
                        <tr style="background: #fef3c7; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">158</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">127</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">4,954</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">2,962</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-1,992</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-40.2%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">34.2%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">40.6%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Old Partners Driver Card Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 Old Partners (≥3 months) - Driver Card Range Impact</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #ea580c; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Driver Card % Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">229</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">177</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">10,053</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">6,987</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-3,066</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-30.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">5.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">6.0%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">36</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">35</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,325</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,318</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-7</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-0.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.4%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">35</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">32</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">781</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,248</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+467</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+59.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">34.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">34.8%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">21</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">20</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">623</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">722</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+99</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+15.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">44.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">45.0%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">25</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">23</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">795</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">849</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+54</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+6.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.7%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">34</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">34</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">889</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,201</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+312</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+35.1%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">68.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">68.8%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">105</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">103</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3,033</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">4,078</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+1,045</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+34.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">93.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">93.8%</td>
                        </tr>
                        <tr style="background: #fef3c7; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">485</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">424</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">17,499</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">16,403</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-1,096</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-6.3%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">36.6%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">40.5%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Consolidated Driver Card Table -->
        <div style="margin-bottom: 25px;">
            <h5 style="color: #1f4e78; margin-bottom: 10px; font-size: 16px;">📋 All Partners - Driver Card Range Impact (Consolidated)</h5>
            <div style="overflow-x: auto; border: 2px solid #e5e7eb; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead style="background: #ea580c; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Driver Card % Range</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Partners Count</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Active Partners</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Jan Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Feb Target</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change #</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Change %</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (All)</th>
                            <th style="padding: 10px; border: 1px solid #d1d5db; text-align: center;">Avg DC % (Target)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">0-20%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">317</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">237</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">13,126</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">8,347</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-4,779</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-36.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">4.6%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">5.4%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">20-30%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">45</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,800</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,567</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-233</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 700;">-12.9%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">24.4%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">30-40%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">37</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">34</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">988</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,318</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+330</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+33.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">35.0%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">35.1%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">40-50%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">26</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">25</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">759</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">800</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+41</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+5.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">44.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">44.7%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">50-60%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">32</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">30</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">838</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">978</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+140</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+16.7%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.5%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">53.7%</td>
                        </tr>
                        <tr style="background: #ffffff;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">60-80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">43</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,127</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">1,402</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+275</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+24.4%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">69.3%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">69.3%</td>
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">&gt;80%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">143</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">139</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">3,815</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">4,953</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+1,138</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 700;">+29.8%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">94.2%</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">94.3%</td>
                        </tr>
                        <tr style="background: #fef3c7; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">Total/Avg</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">643</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">551</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">22,453</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">19,365</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-3,088</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center; background: #fee2e2; color: #991b1b;">-13.8%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">36.0%</td>
                            <td style="padding: 10px; border: 1px solid #f97316; text-align: center;">40.5%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

 </div>

</div>
<!-- END OVERVIEW TAB -->
</div>
<div class="tab-content active" id="executive">
<!-- Executive Summary - Advanced Management View -->
<div class="exec-hero">
    <div class="exec-hero-left">
        <h1>📋 Executive Summary</h1>
        <p>February 2026 Partner Capacity Analysis — High-Level Management View</p>
    </div>
    <div class="exec-hero-right">
        <div class="exec-hero-stat negative">
            <div class="value">-13.8%</div>
            <div class="label">MoM Change</div>
        </div>
        <div class="exec-hero-stat">
            <div class="value">19,365</div>
            <div class="label">Total Riders</div>
        </div>
        <div class="exec-hero-stat">
            <div class="value">551</div>
            <div class="label">Active Partners</div>
        </div>
    </div>
</div>

<!-- KPI Cards Grid -->
<div class="exec-kpi-grid">
    <div class="exec-kpi-card blue">
        <div class="icon">🚴</div>
        <div class="value">19,365</div>
        <div class="label">Total Riders (Feb)</div>
        <div class="change down">↓ 3,088 from Jan (22,453)</div>
    </div>
    <div class="exec-kpi-card green">
        <div class="icon">👥</div>
        <div class="value">551</div>
        <div class="label">Partners with Target</div>
        <div class="change">of 643 total partners</div>
    </div>
    <div class="exec-kpi-card amber">
        <div class="icon">📊</div>
        <div class="value">35.1</div>
        <div class="label">Avg Target/Partner</div>
        <div class="change">Stable vs January</div>
    </div>
    <div class="exec-kpi-card purple">
        <div class="icon">🆕</div>
        <div class="value">23</div>
        <div class="label">New Partners</div>
        <div class="change">17 out of assessment</div>
    </div>
    <div class="exec-kpi-card red">
        <div class="icon">⚠️</div>
        <div class="value">92</div>
        <div class="label">Zero-Target Partners</div>
        <div class="change down">3 Term, 70 Phased, 19 No Jan</div>
    </div>
    <div class="exec-kpi-card teal">
        <div class="icon">✅</div>
        <div class="value">252</div>
        <div class="label">Good Partners</div>
        <div class="change down">↓ 17.5% capacity vs Jan</div>
    </div>
</div>

<!-- Section Grid: Strategy + Highlights + Concerns -->
<div class="exec-section-grid">
    <div class="exec-card strategy">
        <h3>📈 February 2026 Capacity Strategy</h3>
        <ul data-i18n-html="exec-strategy-list">
            <li><strong>Re-balancing:</strong> Strategic redistribution, not uniform cuts</li>
            <li><strong>Overall Reduction:</strong> 13.8% below Jan (-3,088 riders)</li>
            <li><strong>Headcount Alignment:</strong> Restructure base for high avg scale</li>
            <li><strong>FR% Primary Gate:</strong> Low FR = no growth; severe = zero target</li>
            <li><strong>Performance-Based:</strong> Quality + scale → allocation</li>
            <li><strong>New Partner Protection:</strong> Shield new partners from sharp cuts</li>
        </ul>
        <div class="exec-mini-grid">
            <div class="exec-mini-card"><div class="num">-13.8%</div><div class="txt">Overall</div></div>
            <div class="exec-mini-card"><div class="num">92</div><div class="txt">Zero Target</div></div>
            <div class="exec-mini-card"><div class="num">FR%</div><div class="txt">Primary Gate</div></div>
        </div>
    </div>
    <div class="exec-card highlights">
        <h3>✅ Positive Highlights</h3>
        <ul data-i18n-html="exec-highlights-list">
            <li><strong>Bad Partners ↓72.6%:</strong> Dropped from 73 → 20 partners</li>
            <li><strong>Average Partners Stable:</strong> 262 partners at 8,414 riders (+1.0%)</li>
            <li><strong>Avg Target Held:</strong> 35.1 riders/partner despite reduction</li>
            <li><strong>Quality Improvement:</strong> Portfolio mix shifting toward compliance</li>
        </ul>
        <div class="exec-mini-grid">
            <div class="exec-mini-card" style="background: #d1fae5;"><div class="num" style="color: #059669;">-53</div><div class="txt">Bad Partners</div></div>
            <div class="exec-mini-card" style="background: #d1fae5;"><div class="num" style="color: #059669;">+1.0%</div><div class="txt">Avg Partners</div></div>
            <div class="exec-mini-card" style="background: #d1fae5;"><div class="num" style="color: #059669;">35.1</div><div class="txt">Avg Target</div></div>
        </div>
    </div>
    <div class="exec-card concerns">
        <h3>⚠️ Concerns &amp; Risks</h3>
        <ul data-i18n-html="exec-concerns-list">
            <li><strong>Overall Decline:</strong> Total capacity down 13.8% (-3,088)</li>
            <li><strong>Good Partners Down:</strong> target reduction by 6.6%</li>
            <li><strong>Zero-Target Impact:</strong> 70 partners phased partners with no allocation (Impact on partner experience)</li>
            <li><strong>Capacity Contraction:</strong> Fleet size reduction pressure</li>
        </ul>
        <div class="exec-mini-grid">
            <div class="exec-mini-card" style="background: #fee2e2;"><div class="num" style="color: #dc2626;">-3,088</div><div class="txt">Riders</div></div>
            <div class="exec-mini-card" style="background: #fee2e2;"><div class="num" style="color: #dc2626;">-17.5%</div><div class="txt">Good Cap.</div></div>
            <div class="exec-mini-card" style="background: #fee2e2;"><div class="num" style="color: #dc2626;">92</div><div class="txt">Zero Target</div></div>
        </div>
    </div>
    <div class="exec-card targets">
        <h3>🎯 Q1 2026 Success Targets</h3>
        <ul data-i18n-html="exec-targets-list">
            <li><strong>Avg riders/partner:</strong> Raise from ~33 to ≥45</li>
            <li><strong>Stability:</strong> Lock 3-month bands; ≥70% peak retention</li>
            <li><strong>CPO impact:</strong> ≥0.39 SAR/order reduction</li>
            <li><strong>Controls:</strong> SOP + maker/checker; -10% manual adj.</li>
            <li><strong>Mix shift:</strong> Good 58-60%; Bad 5%; add driver card</li>
            <li><strong>Compliance:</strong> FR 98-100% by March</li>
            <li><strong>Scale top:</strong> ≥20 partners to ≥150 riders</li>
        </ul>
        <div class="exec-mini-grid">
            <div class="exec-mini-card" style="background: #ede9fe;"><div class="num" style="color: #7c3aed;">≥45</div><div class="txt">Avg Target</div></div>
            <div class="exec-mini-card" style="background: #ede9fe;"><div class="num" style="color: #7c3aed;">58-60%</div><div class="txt">Good Share</div></div>
            <div class="exec-mini-card" style="background: #ede9fe;"><div class="num" style="color: #7c3aed;">98%+</div><div class="txt">FR Target</div></div>
        </div>
    </div>
</div>

<!-- Footer Note -->
<div class="exec-footer-note" data-i18n-html="exec-footer-note">
    <strong>💡 Strategy Logic:</strong> Scale reliable partners, tighten controls, and shift mix toward compliant segments to raise output and reduce CPO. Focus on headcount alignment to maintain high average scale for partner profitability while protecting priority cities and high-quality performers.
</div>
</div><div class="tab-content" id="strategy">
<h2 style="margin-bottom: 25px; color: #1f4e78; font-size: 26px;">🎯 Future Strategy &amp; Roadmap</h2>
<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 30px; margin-bottom: 30px; color: white; text-align: center;">
<h3 style="color: white; font-size: 24px; margin-bottom: 10px;">📅 Planning Horizon</h3>
<p style="font-size: 16px; margin: 0;">
<strong>Next Implementation Phase:</strong> February 2026 or Post-Ramadan (depending on timing)
                </p>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
<div style="background: #dbeafe; border-left: 6px solid #3b82f6; border-radius: 12px; padding: 25px;">
<div style="display: flex; align-items: center; margin-bottom: 15px;">
<span style="font-size: 32px; margin-right: 15px;">🔧</span>
<h3 style="color: #1e40af; font-size: 18px; margin: 0;">1. Refine Logic &amp; Factors</h3>
</div>
<ul style="color: #1e3a8a; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Adjust performance and FR thresholds based on January results</li>
<li>Fine-tune coefficients using real performance data</li>
<li>Optimize balance between quality gates and growth targets</li>
</ul>
</div>
<div style="background: #d1fae5; border-left: 6px solid #10b981; border-radius: 12px; padding: 25px;">
<div style="display: flex; align-items: center; margin-bottom: 15px;">
<span style="font-size: 32px; margin-right: 15px;">🏙️</span>
<h3 style="color: #065f46; font-size: 18px; margin: 0;">2. City-Tier Minimums &amp; Order Targets</h3>
</div>
<ul style="color: #047857; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Set differentiated minimum targets per city tier (T1 vs T2)</li>
<li>Ensure city-level capacity aligns with demand</li>
<li>Balance service level requirements with budget constraints</li>
</ul>
</div>
<div style="background: #fef3c7; border-left: 6px solid #f59e0b; border-radius: 12px; padding: 25px;">
<div style="display: flex; align-items: center; margin-bottom: 15px;">
<span style="font-size: 32px; margin-right: 15px;">📋</span>
<h3 style="color: #92400e; font-size: 18px; margin: 0;">3. Partner Willingness &amp; Commitment</h3>
</div>
<ul style="color: #78350f; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Introduce PMM-recorded partner willingness sheet</li>
<li>Track recruitment plans and fleet investment commitments</li>
<li>Integrate as model signal post-Ramadan (when demand stabilizes)</li>
</ul>
</div>
<div style="background: #ede9fe; border-left: 6px solid #8b5cf6; border-radius: 12px; padding: 25px;">
<div style="display: flex; align-items: center; margin-bottom: 15px;">
<span style="font-size: 32px; margin-right: 15px;">🤝</span>
<h3 style="color: #5b21b6; font-size: 18px; margin: 0;">4. Long-Term Strategic Partnerships</h3>
</div>
<ul style="color: #6b21a8; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Share capacity targets 2–3 months in advance for key partners</li>
<li>Enable early hiring and operational planning</li>
<li>Build longer-term, win-win partnership relationships</li>
</ul>
</div>
</div>
<div style="background: white; border: 3px solid #ef4444; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
<div style="display: flex; align-items: center; margin-bottom: 20px;">
<span style="font-size: 40px; margin-right: 15px;">🛡️</span>
<h3 style="color: #dc2626; font-size: 22px; margin: 0;">5. Partner Retention Focus (Critical Priority)</h3>
</div>
<div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
<p style="color: #991b1b; font-size: 15px; margin: 0; line-height: 1.8;">
<strong>⚠️ Priority Goal:</strong> Prevent loss of good, compliant partners due to unrealistic capacity reductions
                    </p>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<h4 style="color: #1f4e78; margin-bottom: 10px;">✅ Protection Strategies</h4>
<ul style="color: #374151; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Provide reasonable, profitable targets for quality partners</li>
<li>Ensure targets support sustainable partner economics</li>
<li>Regular follow-up on partner concerns and feedback</li>
<li>Quick resolution of operational blockers</li>
</ul>
</div>
<div>
<h4 style="color: #1f4e78; margin-bottom: 10px;">🎯 Success Metrics</h4>
<ul style="color: #374151; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li>Partner satisfaction and engagement levels</li>
<li>Retention rate of "Good" performing partners</li>
<li>Partner profitability and earning potential</li>
<li>Long-term partnership commitment indicators</li>
</ul>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; color: white;">
<h3 style="color: white; font-size: 22px; margin-bottom: 20px; text-align: center;">📊 Implementation Timeline</h3>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
<div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
<div style="font-size: 36px; margin-bottom: 10px;">📅</div>
<h4 style="color: white; font-size: 16px; margin-bottom: 10px;">Phase 1: Immediate</h4>
<p style="font-size: 13px; margin: 0;">
                            Logic refinement<br/>Partner retention focus
                        </p>
</div>
<div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
<div style="font-size: 36px; margin-bottom: 10px;">🗓️</div>
<h4 style="color: white; font-size: 16px; margin-bottom: 10px;">Phase 2: Post-Ramadan</h4>
<p style="font-size: 13px; margin: 0;">
                            City-tier targets<br/>Willingness tracking
                        </p>
</div>
<div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 20px; text-align: center;">
<div style="font-size: 36px; margin-bottom: 10px;">📆</div>
<h4 style="color: white; font-size: 16px; margin-bottom: 10px;">Phase 3: Long-term</h4>
<p style="font-size: 13px; margin: 0;">
                            Strategic partnerships<br/>Advance planning (2-3 months)
                        </p>
</div>
</div>
</div>
<div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 25px; margin-top: 30px;">
<h4 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">🎯 Strategic Outcomes</h4>
<div style="color: #1e3a8a; font-size: 14px; line-height: 2.0;">
<p style="margin-bottom: 10px;">By implementing these initiatives, we aim to achieve:</p>
<ul style="margin: 0; padding-left: 20px;">
<li><strong>Enhanced Predictability:</strong> Partners can plan ahead with confidence</li>
<li><strong>Improved Retention:</strong> Keep quality partners engaged and profitable</li>
<li><strong>Better Alignment:</strong> Partner capacity matches actual demand and capability</li>
<li><strong>Stronger Partnerships:</strong> Move from transactional to strategic relationships</li>
<li><strong>Operational Excellence:</strong> Right capacity, right place, right time</li>
</ul>
</div>
</div>
</div>
<!-- MONTHLY INSIGHTS TAB -->
<div class="tab-content" id="monthly">
<h2 style="margin-bottom: 15px; color: #1f4e78; font-size: 24px;">🗓️ Monthly insights (6 months comparison)</h2>
<div class="header-subtitle" style="margin-bottom: 15px;">Sep 2025 – Feb 2026 Structure (capacity target monthly overview)</div>
<div class="month-controls">
<button class="btn" onclick="changeMonth(-1)"><span>⬅️</span> Prev</button>
<select class="month-select" id="monthSelect" onchange="updateMonthlyView(this.value)">
<option value="All">🗓️ All months</option>
<option value="Aug-25">Aug-25</option>
<option value="Sep-25">Sep-25</option>
<option value="Oct-25">Oct-25</option>
<option value="Nov-25">Nov-25</option>
<option value="Dec-25">Dec-25</option>
<option value="Jan-26">Jan-26</option>
<option value="Feb-26">Feb-26</option>
</select>
<button class="btn" onclick="changeMonth(1)">Next <span>➡️</span></button>
</div>
<div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: stretch;">
<span style="font-weight: 700; color: #1f4e78; font-size: 14px; margin-right: 4px; align-self: center;">What's inside:</span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">📊 Overview & Trends</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">KPIs, targets, scale & MoM</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">🚗🏍️ Vehicle Type</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Target split by vehicle</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">📊 Partner Movement</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Joiners, leavers & net flow</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">👥 New vs Old</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Tenure-based contribution</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">🏙️ City Distribution</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Allocation across cities</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">🏢 Tier City (T1 vs T2)</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Tier performance compare</span></span>
<span style="display: inline-flex; flex-direction: column; padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 12px; background: #f8fafc; min-width: 140px;"><span style="font-size: 12.5px; font-weight: 700; color: #1f2937;">🤝 Partner Willingness</span><span style="font-size: 10.5px; color: #6b7280; margin-top: 2px;">Sentiment & growth intent</span></span>
</div>
<h3 id="monthlyOverviewSection" style="margin: 10px 0 14px; color: #1f4e78; font-size: 18px;">📊 Monthly Overview &amp; Trends</h3>
<div id="monthlySectionKpis" class="kpi-grid" style="margin-bottom: 10px;">
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Active Partners (with target)</span>
<span class="kpi-icon">✅</span>
</div>
<div class="kpi-value" id="m_activePartners">—</div>
<div class="kpi-subtitle" id="m_activePartners_sub">—</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Total Partners</span>
<span class="kpi-icon">🏢</span>
</div>
<div class="kpi-value" id="m_totalPartners">—</div>
<div class="kpi-subtitle" id="m_totalPartners_sub">—</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">Total Target</span>
<span class="kpi-icon">🎯</span>
</div>
<div class="kpi-value" id="m_totalTarget">—</div>
<div class="kpi-subtitle" id="m_totalTarget_sub">—</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Average Scale (riders / active partner)</span>
<span class="kpi-icon">📏</span>
</div>
<div class="kpi-value" id="m_avgScale">—</div>
<div class="kpi-subtitle" id="m_avgScale_sub">—</div>
</div>
</div>
<div class="kpi-grid">
<div class="kpi-card success">
<div class="kpi-header">
<span class="kpi-title"># Of Partners with target increase in a month (all)</span>
<span class="kpi-icon">📈</span>
</div>
<div class="kpi-value" id="m_incAny">—</div>
<div class="kpi-subtitle" id="m_incAny_sub">—</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">MoM change (Increase all)</span>
<span class="kpi-icon">🔁</span>
</div>
<div class="kpi-value" id="m_inc40">—</div>
<div class="kpi-subtitle" id="m_inc40_sub">—</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Increase &gt; 20%</span>
<span class="kpi-icon">🔥</span>
</div>
<div class="kpi-value" id="m_inc20">—</div>
<div class="kpi-subtitle" id="m_inc20_sub">—</div>
</div>
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Increase &gt; 30%</span>
<span class="kpi-icon">🚀</span>
</div>
<div class="kpi-value" id="m_inc30">—</div>
<div class="kpi-subtitle" id="m_inc30_sub">—</div>
</div>
</div>
<div class="chart-grid" style="margin-top: 25px;">
<div id="monthlySectionTargetTrend" class="chart-container">
<div style="margin-bottom: 15px;">
<h3 class="chart-title">Monthly trend: Total Target &amp; Total Partners</h3>
<p data-i18n-html="desc-totaltargettrend" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Tracks total capacity targets and number of total partners month-over-month. Shows overall market size and partner base growth trends. Dual-axis visualization with combined insight indicator.</p>
</div>
<canvas id="monthlyTargetTrendChart"></canvas>
<div class="chart-info-panel" id="targetTrendInfo">Hover a month to see details.</div>
</div>
<div id="monthlySectionMoMChange" class="chart-container">
<div style="margin-bottom: 15px;">
<h3 class="chart-title">MoM Change in Total Target (%)</h3>
<p data-i18n-html="desc-momchange" style="color: #6b7280; font-size: 13px; margin: 5px 0 0 0; font-style: italic;">Shows month‑over‑month % change in Total Target based on the Monthly Insights totals. Green = increase vs previous month, Red = decrease. First month is the baseline (no MoM).</p>
</div>
<canvas id="monthlyMoMChangeChartNew"></canvas>
</div>
</div>

<!-- VEHICLE TYPE BREAKDOWN SECTION -->
<div id="vehicleTypeMonthlySection" class="chart-container" style="margin-top: 25px;">
<h3 style="margin: 0 0 15px 0; color: #1f4e78; font-size: 18px;">🚗🏍️ Monthly Target by Vehicle Type (Cars vs Bikes)</h3>
<p data-i18n-html="desc-vehiclebreakdown" style="color: #6b7280; font-size: 13px; margin: 0 0 15px 0; font-style: italic;">Shows capacity target breakdown by vehicle type across months. Cars dominate but Bikes share is growing (15.8% → 25.4%). Toggle between Monthly overview and City-level breakdown.</p>

<!-- View Toggle -->
<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
    <button class="vehicle-monthly-view-btn active" data-view="monthly" onclick="switchVehicleMonthlyView('monthly')" style="padding: 8px 16px; border: 2px solid #3b82f6; border-radius: 8px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 13px;">📅 Monthly View</button>
    <button class="vehicle-monthly-view-btn" data-view="city" onclick="switchVehicleMonthlyView('city')" style="padding: 8px 16px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 13px;">🏙️ City View</button>
</div>

<!-- Monthly View Panel -->
<div id="vehicleMonthlyViewPanel" style="display: block;">
    <!-- Vehicle Monthly View Slicers -->
    <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
        <button class="vehicle-monthly-trend-btn active" data-trend="combined" onclick="switchVehicleMonthlyTrend('combined')" style="padding: 6px 14px; border: 2px solid #8b5cf6; border-radius: 8px; background: #8b5cf6; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">📊 Cars vs Bikes Evolution</button>
        <button class="vehicle-monthly-trend-btn" data-trend="cars" onclick="switchVehicleMonthlyTrend('cars')" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">🚗 Cars Monthly Trend</button>
        <button class="vehicle-monthly-trend-btn" data-trend="bikes" onclick="switchVehicleMonthlyTrend('bikes')" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">🏍️ Bikes Monthly Trend</button>
    </div>
    
    <!-- KPI Summary Cards -->
    <div id="vehicleMonthlyKpiCards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #3b82f6;">
            <div class="kpi-tooltip">
                <div class="tooltip-title">🚗 Avg Cars Explained</div>
                <div>Average monthly <span class="tooltip-highlight">car-based capacity targets</span> across all cities from September 2025 to February 2026.</div>
                <div class="tooltip-calc">22,493 = 134,957 total ÷ 6 months<br>(27,599 + 28,372 + 28,257 + 18,845 + 17,441 + 14,443) ÷ 6</div>
                <div>Represents <span class="tooltip-highlight">80.5%</span> of total vehicle capacity. Cars remain the dominant vehicle type.</div>
            </div>
            <div style="font-size: 11px; color: #1e40af; font-weight: 600;">🚗 Avg Cars (per month)</div>
            <div style="font-size: 22px; font-weight: 700; color: #1e40af;">22,493</div>
            <div style="font-size: 11px; color: #3b82f6;">80.5% of total</div>
            <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: 134,957</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #10b981;">
            <div class="kpi-tooltip">
                <div class="tooltip-title">🏍️ Avg Bikes Explained</div>
                <div>Average monthly <span class="tooltip-highlight">bike-based capacity targets</span> across all cities from September 2025 to February 2026.</div>
                <div class="tooltip-calc">5,447 = 32,679 total ÷ 6 months<br>(5,194 + 5,634 + 6,580 + 5,337 + 5,012 + 4,922) ÷ 6</div>
                <div>Represents <span class="tooltip-highlight">19.5%</span> of total vehicle capacity. Bikes share is growing steadily.</div>
            </div>
            <div style="font-size: 11px; color: #065f46; font-weight: 600;">🏍️ Avg Bikes (per month)</div>
            <div style="font-size: 22px; font-weight: 700; color: #065f46;">5,447</div>
            <div style="font-size: 11px; color: #10b981;">19.5% of total</div>
            <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: 32,679</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
            <div class="kpi-tooltip">
                <div class="tooltip-title">📈 Bikes Share Growth Explained</div>
                <div><span class="tooltip-highlight">+9.6pp Share Increase:</span> Bikes' share of total capacity grew from 15.8% (Sep) to 25.4% (Feb).</div>
                <div class="tooltip-calc">Share: 25.4% - 15.8% = +9.6 percentage points</div>
                <div><span class="tooltip-highlight">-5.2% Volume Change:</span> Bike count went from 5,194 (Sep) to 4,922 (Feb).</div>
                <div class="tooltip-calc">Volume: (4,922 - 5,194) / 5,194 × 100 = -5.2%</div>
                <div style="margin-top: 6px; font-size: 11px; opacity: 0.85;">Note: Share increased mainly due to cars declining faster (-47.7%) than bikes (-5.2%).</div>
            </div>
            <div style="font-size: 11px; color: #92400e; font-weight: 600;">📈 Bikes Share Growth (Sep→Feb)</div>
            <div style="font-size: 20px; font-weight: 700; color: #b45309;">+9.6pp <span style="font-size: 12px; font-weight: 600;">share increase</span></div>
            <div style="font-size: 13px; color: #d97706; font-weight: 600;">15.8% → 25.4% <span style="font-size: 10px; font-weight: 500;">bikes share</span></div>
            <div style="font-size: 9px; color: #64748b; margin-top: 2px;">Cars declined -47.7% vs Bikes -5.2%</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #8b5cf6;">
            <div class="kpi-tooltip">
                <div class="tooltip-title">📊 Avg Total Explained</div>
                <div>Average monthly <span class="tooltip-highlight">capacity targets for both Cars and Bikes</span> across all 17 cities.</div>
                <div class="tooltip-calc">27,939 = 167,636 total ÷ 6 months</div>
                <div>Period: <span class="tooltip-highlight">September 2025 → February 2026</span></div>
                <div style="margin-top: 6px; font-size: 11px; opacity: 0.85;">Monthly trend: Peaked at 34,837 (Nov) → dropped to 19,365 (Feb) due to seasonal adjustments.</div>
            </div>
            <div style="font-size: 11px; color: #5b21b6; font-weight: 600;">📊 Avg Total (per month)</div>
            <div style="font-size: 22px; font-weight: 700; color: #6d28d9;">27,939</div>
            <div style="font-size: 11px; color: #8b5cf6;">Sep - Feb 2026</div>
            <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: 167,636</div>
        </div>
    </div>
    <div style="height: 280px;">
        <canvas id="vehicleMonthlyChart"></canvas>
    </div>
</div>

<!-- City View Panel -->
<div id="vehicleCityViewPanel" style="display: none;">
    <!-- City Level Filter -->
    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
        <span style="font-weight: 600; color: #374151; font-size: 13px;">🏙️ City Level:</span>
        <button class="vehicle-city-level-monthly-btn active" data-level="all" onclick="filterVehicleCityLevel('all')" style="padding: 6px 14px; border: 2px solid #10b981; border-radius: 8px; background: #10b981; color: white; font-weight: 600; cursor: pointer; font-size: 12px;">All Cities</button>
        <button class="vehicle-city-level-monthly-btn" data-level="t1" onclick="filterVehicleCityLevel('t1')" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T1 Cities</button>
        <button class="vehicle-city-level-monthly-btn" data-level="t2" onclick="filterVehicleCityLevel('t2')" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T2 Cities</button>
        <button class="vehicle-city-level-monthly-btn" data-level="t1vst2" onclick="filterVehicleCityLevel('t1vst2')" style="padding: 6px 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 12px;">T1 vs T2</button>
    </div>
    
    <!-- Individual City Filter (shown when All Cities selected) -->
    <div id="vehicleCityIndividualFilter" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 15px; flex-wrap: wrap;">
        <span style="font-weight: 600; color: #6b7280; font-size: 12px;">📍 City:</span>
        <button class="vehicle-city-monthly-btn active" data-city="all" onclick="filterVehicleCity('all')" style="padding: 4px 10px; border: 2px solid #8b5cf6; border-radius: 6px; background: #8b5cf6; color: white; font-weight: 600; cursor: pointer; font-size: 11px;">All</button>
        <button class="vehicle-city-monthly-btn" data-city="Riyadh" onclick="filterVehicleCity('Riyadh')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Riyadh</button>
        <button class="vehicle-city-monthly-btn" data-city="Jeddah" onclick="filterVehicleCity('Jeddah')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jeddah</button>
        <button class="vehicle-city-monthly-btn" data-city="Dammam" onclick="filterVehicleCity('Dammam')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Dammam</button>
        <button class="vehicle-city-monthly-btn" data-city="Madinah" onclick="filterVehicleCity('Madinah')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Madinah</button>
        <button class="vehicle-city-monthly-btn" data-city="Makkah" onclick="filterVehicleCity('Makkah')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Makkah</button>
        <button class="vehicle-city-monthly-btn" data-city="Al Ahsa" onclick="filterVehicleCity('Al Ahsa')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Al Ahsa</button>
        <button class="vehicle-city-monthly-btn" data-city="Al Kharj" onclick="filterVehicleCity('Al Kharj')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Al Kharj</button>
        <button class="vehicle-city-monthly-btn" data-city="Abha" onclick="filterVehicleCity('Abha')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Abha</button>
        <button class="vehicle-city-monthly-btn" data-city="Taif" onclick="filterVehicleCity('Taif')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Taif</button>
        <button class="vehicle-city-monthly-btn" data-city="Buraydah" onclick="filterVehicleCity('Buraydah')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Buraydah</button>
        <button class="vehicle-city-monthly-btn" data-city="Jubail" onclick="filterVehicleCity('Jubail')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jubail</button>
        <button class="vehicle-city-monthly-btn" data-city="Tabuk" onclick="filterVehicleCity('Tabuk')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Tabuk</button>
        <button class="vehicle-city-monthly-btn" data-city="Hail" onclick="filterVehicleCity('Hail')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Hail</button>
        <button class="vehicle-city-monthly-btn" data-city="Yanbu" onclick="filterVehicleCity('Yanbu')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Yanbu</button>
        <button class="vehicle-city-monthly-btn" data-city="Hafar Al Batin" onclick="filterVehicleCity('Hafar Al Batin')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Hafar Al Batin</button>
        <button class="vehicle-city-monthly-btn" data-city="Jazan" onclick="filterVehicleCity('Jazan')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Jazan</button>
        <button class="vehicle-city-monthly-btn" data-city="Najran" onclick="filterVehicleCity('Najran')" style="padding: 4px 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; color: #6b7280; font-weight: 600; cursor: pointer; font-size: 11px;">Najran</button>
    </div>
    
    <!-- Dynamic KPI Cards for City View -->
    <div id="vehicleCityKpiCards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        <!-- Will be populated dynamically -->
    </div>
    
    <!-- Vehicle Share Insights Panel (Donut Meters) - Only for All Cities, T1, T2 views -->
    <div id="vehicleShareInsightsPanel" style="display: none; margin-bottom: 20px;">
        <!-- Will be populated dynamically with donut meters -->
    </div>
    
    <!-- Single chart container -->
    <div id="vehicleSingleChartContainer" style="height: 280px;">
        <canvas id="vehicleCityChart"></canvas>
    </div>
    
    <!-- T1 vs T2 Side by Side container -->
    <div id="vehicleT1T2Container" style="display: none; gap: 15px;">
        <div style="flex: 1; background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 8px 0; color: #1e40af; font-size: 13px; text-align: center;">🏙️ T1 Cities (7 cities)</h4>
            <div style="height: 220px;"><canvas id="vehicleMonthlyT1Chart"></canvas></div>
        </div>
        <div style="flex: 1; background: #f0fdf4; padding: 12px; border-radius: 10px; border: 1px solid #d1fae5;">
            <h4 style="margin: 0 0 8px 0; color: #047857; font-size: 13px; text-align: center;">🌆 T2 Cities (10 cities)</h4>
            <div style="height: 220px;"><canvas id="vehicleMonthlyT2Chart"></canvas></div>
        </div>
    </div>
</div>

<!-- Expandable Data Table -->
<div style="margin-top: 20px;">
    <button onclick="toggleTable(this, 'vehicleMonthlyDataTable')" style="width: 100%; padding: 10px 15px; background: #f0f9ff; border: 2px solid #3b82f6; color: #1e40af; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 13px; text-align: left;">▼ Click to view detailed data table ▼</button>
    <div id="vehicleMonthlyDataTable" style="display: none; margin-top: 10px; max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
        <div id="vehicleTableContainer"></div>
    </div>
</div>
</div>
<!-- END VEHICLE TYPE BREAKDOWN SECTION -->

<div class="chart-grid">
<div id="monthlySectionAvgScale" class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 6px; flex-wrap: wrap;">
        <button class="slab-slicer-btn active" data-target="avgScale" data-view="perf">Performance</button>
        <button class="slab-slicer-btn" data-target="avgScale" data-view="size">Size</button>
    </div>
</div>
<div data-panel="avgScale" data-view="perf">
    <h3 class="chart-title">Average Scale by Performance Level</h3>
    <p data-i18n-html="desc-avgridersperf" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Average riders per partner by performance level (Good/Average/Bad) across months.</p>
    <div class="chart-toggle" id="avgScalePerfToggle">
        <button class="chart-toggle-btn active" data-view="trend">Trend</button>
        <button class="chart-toggle-btn" data-view="comparison">Comparison</button>
    </div>
    <canvas id="avgScalePerfChart"></canvas>
    <div class="chart-info-panel" id="avgScalePerfInfo">Hover a month to see details.</div>
</div>
<div data-panel="avgScale" data-view="size" style="display: none;">
    <h3 class="chart-title">Average Scale by Size Level</h3>
    <p data-i18n-html="desc-avgridersize" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Average riders per partner by size level (Big/Mid/Small) across months.</p>
    <div class="chart-toggle" id="avgScaleSizeToggle">
        <button class="chart-toggle-btn active" data-view="trend">Trend</button>
        <button class="chart-toggle-btn" data-view="comparison">Comparison</button>
    </div>
    <canvas id="avgScaleSizeChart"></canvas>
    <div class="chart-info-panel" id="avgScaleSizeInfo">Hover a month to see details.</div>
    <!-- Expandable Table for Size Level -->
    <div style="margin-top: 15px;">
    <button onclick="toggleTable(this, 'avgScaleSizeTable')" style="width: 100%; padding: 10px 15px; background: #f0f9ff; border: 2px solid #3b82f6; color: #1e40af; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 13px; text-align: left;">▼ Click to view detailed data ▼</button>
    <div id="avgScaleSizeTable" style="display: none; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
    <thead style="position: sticky; top: 0; background: #3b82f6; color: white;">
    <tr>
    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Month</th>
    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Big</th>
    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Mid</th>
    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Small</th>
    </tr>
    </thead>
    <tbody>
    <tr style="background: #f9fafb;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Aug-25</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #f3f4f6;">101.6</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #f3f4f6;">56.7</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #f3f4f6;">34.5</td>
    </tr>
    <tr style="background: #ffffff;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Sep-25</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 600;">↑ 122.0</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 600;">↑ 61.0</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 600;">↑ 35.3</td>
    </tr>
    <tr style="background: #f9fafb;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Oct-25</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 106.8</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 55.0</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 29.9</td>
    </tr>
    <tr style="background: #ffffff;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Nov-25</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 105.4</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 50.9</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 28.0</td>
    </tr>
    <tr style="background: #f9fafb;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Dec-25</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 77.5</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 36.9</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 19.5</td>
    </tr>
    <tr style="background: #ffffff;">
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">Jan-26</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #fee2e2; color: #991b1b; font-weight: 600;">↓ 62.1</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 600;">↑ 38.8</td>
    <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dcfce7; color: #166534; font-weight: 600;">↑ 26.0</td>
    </tr>
    </tbody>
    </table>
    </div>
    </div>
</div>
</div>
<div class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 6px; flex-wrap: wrap;">
        <button class="slab-slicer-btn active" data-target="monthlyExtras" data-view="mom">Avr scale overview</button>
        <button class="slab-slicer-btn" data-target="monthlyExtras" data-view="top">Top & Bottom partners with target</button>
    </div>
</div>
<div id="monthlySectionAvgScaleTrend" data-panel="monthlyExtras" data-view="mom">
    <h3 class="chart-title">Monthly trend: Average Scale</h3>
    <p data-i18n-html="desc-avgridersmonth" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Average riders per active partner each month. Indicates typical partner capacity and operational efficiency trends. Declining trend shows efficiency optimization efforts.</p>
    <canvas id="monthlyAvgScaleChart" style="margin-top: 10px;"></canvas>
    <div class="chart-info-panel" id="avgScaleOverviewInfo">Hover a month to see details.</div>
</div>
<div id="monthlySectionTopBottom" data-panel="monthlyExtras" data-view="top" style="display: none;">
    <h3 class="chart-title">📊 Top Movers - Biggest &amp; Smallest Partners by Riders</h3>
    <p data-i18n-html="desc-topmovers" style="color: #6b7280; font-size: 13px; margin: 5px 0 15px 0; font-style: italic;">
                            Shows Top 20 partners with highest rider count and Bottom 20 with lowest rider count.
                            Includes actual riders and total target.
                        </p>
    <div style="margin-bottom: 15px;">
    <label for="topMoversMonthSelect" style="font-weight: 600; margin-right: 10px;">Select Month:</label>
    <select id="topMoversMonthSelect" onchange="updateTopMoversTable(this.value)" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
    <option value="Sep">Sep-25</option>
    <option value="Oct">Oct-25</option>
    <option value="Nov">Nov-25</option>
    <option value="Dec">Dec-25</option>
    <option value="Jan">Jan-26</option>
    <option selected="" value="Feb">Feb-26</option>
    </select>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
    <div>
    <h4 style="color: #059669; margin-bottom: 10px; font-size: 15px;">🏆 Top 20 Biggest Partners (by Riders)</h4>
    <div class="table-container" style="margin: 0; max-height: 400px; overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
    <thead style="position: sticky; top: 0; background: #059669; z-index: 10;">
    <tr style="color: white;">
    <th style="padding: 6px; border: 1px solid #ddd;">#</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Partner</th>
    <th style="padding: 6px; border: 1px solid #ddd;">New/Old</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Actual Riders</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Target</th>
    </tr>
    </thead>
    <tbody id="topIncreasesTableBody"></tbody>
    </table>
    </div>
    </div>
    <div>
    <h4 style="color: #dc2626; margin-bottom: 10px; font-size: 15px;">📉 Bottom 20 Smallest Partners (by Riders)</h4>
    <div class="table-container" style="margin: 0; max-height: 400px; overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
    <thead style="position: sticky; top: 0; background: #dc2626; z-index: 10;">
    <tr style="color: white;">
    <th style="padding: 6px; border: 1px solid #ddd;">#</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Partner</th>
    <th style="padding: 6px; border: 1px solid #ddd;">New/Old</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Actual Riders</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Target</th>
    </tr>
    </thead>
    <tbody id="topDecreasesTableBody"></tbody>
    </table>
    </div>
    </div>
    </div>
    <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
    <p style="margin: 0; font-size: 12px; color: #78350f;">
    <strong>💡 Note:</strong> Biggest partners = highest actual rider count. Smallest partners = lowest rider count. <strong>New partners</strong> = less than 3 months since their first delivery date with Keeta.
                            </p>
    </div>
    <div style="margin-top: 15px;">
    <h4 style="color: #0284c7; margin-bottom: 10px; font-size: 15px;">🏅 Top 20 Ranked Partners (by City Coverage)</h4>
    <div class="table-container" style="margin: 0; max-height: 400px; overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
    <thead style="position: sticky; top: 0; background: #0284c7; z-index: 10;">
    <tr style="color: white;">
    <th style="padding: 6px; border: 1px solid #ddd;">#</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Partner</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Cities</th>
    <th style="padding: 6px; border: 1px solid #ddd;">New/Old</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Actual Riders</th>
    <th style="padding: 6px; border: 1px solid #ddd;">Target</th>
    </tr>
    </thead>
    <tbody id="topRankedTableBody"></tbody>
    </table>
    </div>
    <div style="margin-top: 8px; padding: 8px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 4px;">
    <p style="margin: 0; font-size: 11px; color: #0c4a6e;">
    <strong>📊</strong> Ranked by highest number of covered cities across the Kingdom (Feb only).
    </p>
    </div>
    </div>
</div>
</div>
</div>
<div class="chart-grid">
<div class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="font-size: 16px; font-weight: 600; color: #111827;">Partners Share (Performance &amp; Size)</div>
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
        <button class="share-slicer-btn active" data-target="partnersShare" data-view="performance">Performance</button>
        <button class="share-slicer-btn" data-target="partnersShare" data-view="size">Size</button>
    </div>
</div>
<div id="partnersSharePerformance">
    <div style="margin-bottom: 15px;">
        <h3 class="chart-title">Partners performance mix (Good / Average / Bad)</h3>
        <p data-i18n-html="desc-perfmix" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Distribution of partners by achievement level. Good (≥80% FR), Average (50-80% FR), Bad (&lt;50% FR). Shows quality composition evolution.</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center;">
            <span style="font-size: 12px; font-weight: 600; color: #374151;">Quick Metrics:</span>
            <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">✓ Good Quality Trending</span>
            <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">⚠ Watch Average Decline</span>
        </div>
    </div>
    <canvas id="monthlyPerformanceMixChart"></canvas>
</div>
<div id="partnersShareSize" style="display: none;">
    <div style="margin-bottom: 15px;">
        <h3 class="chart-title">Partners size mix (Big / Mid / Small)</h3>
        <p data-i18n-html="desc-partnerdist" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Partner distribution by target size. Big partners show strong growth, Mid stable, Small declining. Strategic diversification needed.</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center;">
            <span style="font-size: 12px; font-weight: 600; color: #374151;">Distribution Trend:</span>
            <span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">📦 Big: Growing Base</span>
            <span style="background: #fecaca; color: #991b1b; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">📍 Small: Monitor</span>
        </div>
    </div>
    <canvas id="monthlySizeMixChart"></canvas>
</div>
</div>
<div class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="font-size: 16px; font-weight: 600; color: #111827;">Total Target Share (Performance &amp; Size)</div>
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
        <button class="share-slicer-btn active" data-target="totalTargetShare" data-view="performance">Performance</button>
        <button class="share-slicer-btn" data-target="totalTargetShare" data-view="size">Size</button>
    </div>
</div>
<div id="totalTargetSharePerformance">
    <div style="margin-bottom: 15px;">
        <h3 class="chart-title">Total Riders Share by Performance Level (Good / Average / Bad)</h3>
        <p data-i18n-html="desc-ridersshareperf" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Distribution of total target riders share with % across performance levels. Shows capacity concentration by quality tier.</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center;">
            <span style="font-size: 12px; font-weight: 600; color: #374151;">Capacity Allocation:</span>
            <span style="background: #e0f2fe; color: #1e40af; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">⭐ Share by Quality</span>
        </div>
    </div>
    <canvas id="monthlyRidersPerformanceMixChart"></canvas>
</div>
<div id="totalTargetShareSize" style="display: none;">
    <div style="margin-bottom: 15px;">
        <h3 class="chart-title">Total Riders Share by Size Level (Big / Mid / Small)</h3>
        <p data-i18n-html="desc-riderssharesize" style="color: #6b7280; font-size: 13px; margin: 5px 0 10px 0; font-style: italic;">Distribution of total target riders share with % across partner size levels. Shows concentration risk and diversification.</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center;">
            <span style="font-size: 12px; font-weight: 600; color: #374151;">Concentration Risk:</span>
            <span style="background: #f3e8ff; color: #6b21a8; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">📊 Share by Size</span>
        </div>
    </div>
    <canvas id="monthlyRidersSizeMixChart"></canvas>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function setupButtonSlicer(targetKey, perfId, sizeId) {
        const buttons = Array.from(document.querySelectorAll(`.share-slicer-btn[data-target="${targetKey}"]`));
        const perf = document.getElementById(perfId);
        const size = document.getElementById(sizeId);
        if (!buttons.length || !perf || !size) return;

        function apply(view, animate) {
            // Hide both first
            perf.style.display = 'none';
            size.style.display = 'none';
            
            // Remove animation class
            perf.classList.remove('slicer-panel');
            size.classList.remove('slicer-panel');
            
            // Show the selected one with animation
            const target = (view === 'performance') ? perf : size;
            target.style.display = 'block';
            
            // Trigger animation if not initial load - use rAF to avoid forced reflow
            if (animate) {
                target.classList.remove('slicer-panel-animate');
                requestAnimationFrame(function() { target.classList.add('slicer-panel-animate'); });
            }
            
            buttons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
            if (window.monthlyCharts && Array.isArray(window.monthlyCharts)) {
                // Only resize charts that are currently visible
                window.monthlyCharts.forEach(c => { try { if (c && c.canvas && c.canvas.offsetParent) c.resize(); } catch(e) {} });
            }
            // Resize Total Target Share charts
            if (targetKey === 'totalTargetShare') {
                setTimeout(function() {
                    if (view === 'performance' && window.m_ridersPerfMix) {
                        try { window.m_ridersPerfMix.resize(); } catch(e) {}
                    }
                    if (view === 'size' && window.m_ridersSizeMix) {
                        try { window.m_ridersSizeMix.resize(); } catch(e) {}
                    }
                }, 50);
            }
            // Resize Partners Share charts
            if (targetKey === 'partnersShare') {
                setTimeout(function() {
                    if (view === 'performance' && window.m_perfMix) {
                        try { window.m_perfMix.resize(); } catch(e) {}
                    }
                    if (view === 'size' && window.m_sizeMix) {
                        try { window.m_sizeMix.resize(); } catch(e) {}
                    }
                }, 50);
            }
        }

        buttons.forEach(b => {
            b.addEventListener('click', function() {
                apply(this.dataset.view, true);
            });
        });

        const defaultBtn = buttons.find(b => b.classList.contains('active')) || buttons[0];
        apply(defaultBtn.dataset.view || 'performance', false);
    }

    setupButtonSlicer('partnersShare', 'partnersSharePerformance', 'partnersShareSize');
    setupButtonSlicer('totalTargetShare', 'totalTargetSharePerformance', 'totalTargetShareSize');

    function setupPanelSlicer(targetKey, defaultView) {
        const buttons = Array.from(document.querySelectorAll(`.slab-slicer-btn[data-target="${targetKey}"]`));
        const panels = Array.from(document.querySelectorAll(`[data-panel="${targetKey}"]`));
        if (!buttons.length || !panels.length) return;

        function apply(view, animate) {
            buttons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
            
            // Hide all panels first and remove animation class
            panels.forEach(p => {
                p.style.display = 'none';
                p.classList.remove('slicer-panel');
            });
            
            // Show the selected panel with animation
            panels.forEach(p => {
                if (p.dataset.view === view) {
                    p.style.display = 'block';
                    if (animate) {
                        // Use rAF to avoid forced reflow
                        p.classList.remove('slicer-panel-animate');
                        requestAnimationFrame(function() { p.classList.add('slicer-panel-animate'); });
                    }
                }
            });
            
            if (targetKey === 'willingness') {
                if (view === 'bars' && window.m_willingVsNotWilling) window.m_willingVsNotWilling.resize();
                if (view === 'trend' && window.m_willingnessTrend) window.m_willingnessTrend.resize();
            }
            if (targetKey === 'growth') {
                if (view === 'increase' && window.m_growthCategory) window.m_growthCategory.resize();
                if (view === 'decrease' && window.m_decreaseCategory) window.m_decreaseCategory.resize();
            }
            if (targetKey === 'avgScale') {
                if (view === 'perf' && window.m_avgScalePerf) window.m_avgScalePerf.resize();
                if (view === 'size' && window.m_avgScaleSize) window.m_avgScaleSize.resize();
            }
            if (targetKey === 'monthlyExtras') {
                if (view === 'mom' && window.m_mom) window.m_mom.resize();
            }
        }

        buttons.forEach(b => b.addEventListener('click', () => apply(b.dataset.view, true)));
        const activeBtn = buttons.find(b => b.classList.contains('active'));
        apply(activeBtn ? activeBtn.dataset.view : defaultView, false);
    }

    setupPanelSlicer('willingness', 'trend');
    setupPanelSlicer('growth', 'increase');
    setupPanelSlicer('avgScale', 'perf');
    setupPanelSlicer('monthlyExtras', 'mom');

    // Tier Tables Slicer Setup
    (function() {
        const buttons = document.querySelectorAll('.tier-table-slicer-btn');
        const panels = document.querySelectorAll('.tier-table-panel');
        
        function applyTierTableView(view, animate) {
            // Update button styles
            buttons.forEach(btn => {
                const isActive = btn.dataset.view === view;
                btn.classList.toggle('active', isActive);
                btn.style.background = isActive ? '#1e3a8a' : 'white';
                btn.style.color = isActive ? 'white' : '#374151';
                btn.style.borderColor = isActive ? '#1e3a8a' : '#d1d5db';
            });
            
            // Show/hide panels with animation
            panels.forEach(panel => {
                const isActive = panel.dataset.panel === view;
                panel.style.display = isActive ? 'block' : 'none';
                
                if (isActive && animate) {
                    panel.classList.remove('slicer-panel-animate');
                    requestAnimationFrame(function() { panel.classList.add('slicer-panel-animate'); });
                }
            });
        }
        
        buttons.forEach(btn => btn.addEventListener('click', () => applyTierTableView(btn.dataset.view, true)));
        applyTierTableView('tierOverview', false); // default view
    })();
});
</script>
<div id="monthlyHighlightsSection" class="highlight-box">
<h3>Highlights &amp; takeaways (selected month)</h3>
<ul id="monthlyHighlights">
<li>—</li>
</ul>
</div>

<!-- PARTNER MOVEMENT ANALYSIS SECTION -->
<div id="partnerMovementSection" style="margin-top: 35px;">
<details id="partnerMovementDetails" open style="background: #f8fafc; border: 2px solid #0891b2; border-radius: 10px; padding: 14px;">
    <summary style="cursor: pointer; font-size: 18px; font-weight: 700; color: #0891b2; display: flex; align-items: center; gap: 10px; list-style: none;">
        <span id="partnerMovementArrow" style="font-size: 18px; color: #0891b2;">▶</span>
        <span>📊 Partner Movement Analysis (Increase / Decrease / No Change) — click to expand/collapse</span>
    </summary>
<div style="margin-top: 14px;">
<p data-i18n-html="desc-movement" style="color: #6b7280; font-size: 13px; margin: 0 0 15px 0; font-style: italic;">Track partner target capacity movements: partners who increased, decreased, or maintained their targets across 6 months. Segmented by quality performance (Good ≥80% FR, Average 50-80% FR, Bad &lt;50% FR).</p>

<div id="partnerMovementTakeaway" style="margin-bottom: 20px; padding: 12px; background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border-left: 4px solid #06b6d4; border-radius: 6px;">
    <p style="margin: 0; font-size: 13px; color: #0e7490; font-weight: 600;">📊 Key Insight: <span id="partnerMovementInsight">Average of 195 partners increased targets monthly, while 243 decreased. December saw the sharpest decline (79 increases vs 457 decreases). February closed with 136 increases vs 284 decreases.</span></p>
</div>

<div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <label style="font-weight: 600; color: #1f2937;">Filter by:</label>
    <div id="movementQualityFilter" style="display: flex; gap: 8px;">
        <button class="movement-quality-chip active" data-quality="allPartners" style="padding: 8px 16px; border: 2px solid #06b6d4; background: #06b6d4; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">All Partners</button>
        <button class="movement-quality-chip" data-quality="all" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">All Partners with Performance</button>
        <button class="movement-quality-chip" data-quality="good" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">Good Partners</button>
        <button class="movement-quality-chip" data-quality="average" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">Average Partners</button>
        <button class="movement-quality-chip" data-quality="bad" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">Bad Partners</button>
    </div>
</div>

<div class="chart-grid" style="margin-bottom: 20px;">
    <div class="chart-container">
        <h3 class="chart-title">Partner Movement by Type (Trend)</h3>
        <canvas id="partnerMovementTrendChart"></canvas>
    </div>
    <div class="chart-container">
        <h3 class="chart-title">Quality Distribution by Movement Type</h3>
        <canvas id="partnerMovementQualityChart"></canvas>
    </div>
</div>

<div style="margin-bottom: 15px; padding: 12px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 6px;">
    <p style="margin: 0; font-size: 13px; color: #15803d; font-weight: 500;">ℹ️ <strong>Note:</strong> Table shows partners who completed assessment during each month. Partners without assessment data (new sign-ups, incomplete metrics) are excluded from these numbers.</p>
</div>

<details style="margin-bottom: 20px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">
    <summary style="cursor: pointer; font-size: 14px; font-weight: 600; color: #0891b2; display: flex; align-items: center; gap: 8px; list-style: none;">
        <span style="font-size: 14px;">▶</span>
        <span>📋 View Detailed Movement Table — click to expand</span>
    </summary>
    <div style="overflow-x: auto; margin-top: 12px;">
        <table id="partnerMovementTable" style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;font-size:12px;">
            <thead style="background: #0891b2; color: white;">
                <tr>
                    <th rowspan="2" style="padding: 10px; border: 1px solid #e5e7eb; text-align: left;">Month</th>
                    <th colspan="3" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #10b981;">Total Increase</th>
                    <th colspan="3" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #ef4444;">Total Decrease</th>
                    <th colspan="3" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; background: #6b7280;">No change</th>
                    <th rowspan="2" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">Subtotal</th>
                </tr>
                <tr>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #059669;">Good</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #059669;">Average</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #059669;">Bad</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dc2626;">Good</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dc2626;">Average</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #dc2626;">Bad</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #9ca3af;">Good</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #9ca3af;">Average</th>
                    <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; background: #9ca3af;">Bad</th>
                </tr>
            </thead>
            <tbody id="partnerMovementTableBody">
            </tbody>
        </table>
    </div>
</details>
</div>
</details>
</div>

<!-- NEW VS OLD PARTNERS ANALYSIS SECTION -->
<div id="partnerAgeSection" style="margin-top: 35px;">
<details id="partnerAgeDetails" open style="background: #f8fafc; border: 2px solid #1e3a8a; border-radius: 10px; padding: 14px;">
    <summary style="cursor: pointer; font-size: 18px; font-weight: 700; color: #1e3a8a; display: flex; align-items: center; gap: 10px; list-style: none;">
        <span id="partnerAgeArrow" style="font-size: 18px; color: #1e3a8a;">▶</span>
        <span>👥 New vs Old Partners Analysis (by Partner Age) — click to expand/collapse</span>
    </summary>
<div style="margin-top: 14px;">
<p data-i18n-html="desc-tenure" style="color: #6b7280; font-size: 13px; margin: 0 0 15px 0; font-style: italic;">Analyze partner composition by tenure: newly onboarded (&lt;1 month), recently added (&lt;3 months), and established (&gt;3 months). Compare capacity (Target), engagement (Active Count), scale efficiency (Avg Scale), and quality breakdown across all 6 months. Green/Red arrows show month-over-month trends.</p>

<div id="partnerAgeTakeaway" style="margin-bottom: 20px; padding: 12px; background: linear-gradient(135deg, #eff6ff 0%, #e0f2fe 100%); border-left: 4px solid #2563eb; border-radius: 6px;">
    <p style="margin: 0; font-size: 13px; color: #1e40af; font-weight: 600;">📊 Key Insight: <span id="partnerAgeInsight">Loading...</span></p>
</div>

<div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
<label style="font-weight: 600; color: #1f2937;">Compare Months:</label>
<select id="partnerAgeMonthFilter1" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
<option value="">-- Month 1 --</option>
<option value="0">Sep-25</option>
<option value="1">Oct-25</option>
<option value="2">Nov-25</option>
<option value="3">Dec-25</option>
<option value="4">Jan-26</option>
<option value="5">Feb-26</option>
</select>
<select id="partnerAgeMonthFilter2" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
<option value="">-- Month 2 --</option>
<option value="0">Sep-25</option>
<option value="1">Oct-25</option>
<option value="2">Nov-25</option>
<option value="3">Dec-25</option>
<option value="4">Jan-26</option>
<option value="5" selected>Feb-26</option>
</select>
<button id="partnerAgeCompareBtn" style="padding: 8px 20px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Compare</button>
<button id="partnerAgeResetBtn" style="padding: 8px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Reset to All Months</button>
</div>

<div style="margin-bottom: 20px;">
<label style="font-weight: 600; color: #1f2937; display: block; margin-bottom: 10px;">Filter by Partner Age:</label>
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <button class="age-category-chip active" data-category="all" style="padding: 8px 16px; border: 2px solid #1e3a8a; background: #1e3a8a; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">All Categories</button>
    <button class="age-category-chip" data-category="New <1 month" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">New &lt;1 month</button>
    <button class="age-category-chip" data-category="New <3 months" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">New &lt;3 months</button>
    <button class="age-category-chip" data-category="Old >3 months" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">Old &gt;3 months</button>
</div>
</div>

<div class="chart-grid" style="margin-bottom: 20px;">
<div class="chart-container">
<h3 class="chart-title">Total Partners by Age (Trend)</h3>
<canvas id="partnerAgeTrendChart"></canvas>
</div>
<div class="chart-container">
<h3 class="chart-title">Avg Scale by Partner Age (Trend)</h3>
<canvas id="partnerAgeScaleChart"></canvas>
</div>
</div>

<div style="overflow-x: auto; margin-bottom: 20px;">
<table id="partnerAgeTable" style="width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
<tbody></tbody>
</table>
</div>
</div>
</details>
</div>
<script>
// Arrow toggles for Monthly Insights expandable sections
(function() {
    const sections = [
        { detailsId: 'partnerMovementDetails', arrowId: 'partnerMovementArrow' },
        { detailsId: 'partnerAgeDetails', arrowId: 'partnerAgeArrow' },
        { detailsId: 'cityWiseDetails', arrowId: 'cityWiseArrow' },
        { detailsId: 'tierCityDetails', arrowId: 'tierCityArrow' },
    ];
    sections.forEach(({ detailsId, arrowId }) => {
        const detailsEl = document.getElementById(detailsId);
        const arrowEl = document.getElementById(arrowId);
        if (detailsEl && arrowEl) {
            const setArrow = () => { arrowEl.textContent = detailsEl.open ? '▼' : '▶'; };
            detailsEl.addEventListener('toggle', setArrow);
            setArrow();
        }
    });
})();
</script>

<!-- CITY-WISE PERFORMANCE SECTION -->
<div id="cityWiseSection" style="margin-top: 35px;">
<details id="cityWiseDetails" open style="background: #f8fafc; border: 2px solid #059669; border-radius: 10px; padding: 14px;">
    <summary style="cursor: pointer; font-size: 18px; font-weight: 700; color: #059669; display: flex; align-items: center; gap: 10px; list-style: none;">
        <span id="cityWiseArrow" style="font-size: 18px; color: #059669;">▶</span>
        <span>🏙️ City-wise Target Distribution (with MoM trends) — click to expand/collapse</span>
    </summary>
<div style="margin-top: 14px;">
<p data-i18n-html="desc-cityanalysis" style="color: #6b7280; font-size: 13px; margin: 0 0 15px 0; font-style: italic;">City-level analysis showing total target riders and active partners (with targets) across all 6 months (Sep–Feb). Green/Red arrows indicate month-over-month percentage changes. Filter by two months to compare city performance trends.</p>

<div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
<label style="font-weight: 600; color: #1f2937;">Compare Months:</label>
<select id="cityMonthFilter1" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
<option value="">-- Month 1 --</option>
<option value="0">Sep-25</option>
<option value="1">Oct-25</option>
<option value="2">Nov-25</option>
<option value="3">Dec-25</option>
<option value="4">Jan-26</option>
<option value="5">Feb-26</option>
</select>
<select id="cityMonthFilter2" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
<option value="">-- Month 2 --</option>
<option value="0">Sep-25</option>
<option value="1">Oct-25</option>
<option value="2">Nov-25</option>
<option value="3">Dec-25</option>
<option value="4">Jan-26</option>
<option value="5" selected>Feb-26</option>
</select>
<button id="cityCompareBtn" style="padding: 8px 20px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Compare</button>
</div>

<div style="margin-bottom: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
<label style="font-weight: 600; color: #1f2937; display: block; margin-bottom: 12px;">Filter by City (Slicer):</label>

<div style="margin-bottom: 15px;">
<div style="font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 8px;">🔵 T1 Cities (Major Markets)</div>
<div id="t1CityChips" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
<button class="city-chip" data-city="Riyadh" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Riyadh</button>
<button class="city-chip" data-city="Jeddah" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Jeddah</button>
<button class="city-chip" data-city="Dammam" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Dammam</button>
<button class="city-chip" data-city="Medina" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Medina</button>
<button class="city-chip" data-city="Makkah" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Makkah</button>
<button class="city-chip" data-city="Al Kharj" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Al Kharj</button>
<button class="city-chip" data-city="Al Ahsa" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Al Ahsa</button>
</div>
</div>

<div>
<div style="font-weight: 600; font-size: 13px; color: #374151; margin-bottom: 8px;">🟢 T2 Cities (Secondary Markets)</div>
<div id="t2CityChips" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
<button class="city-chip" data-city="Abha" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Abha</button>
<button class="city-chip" data-city="Buraydah" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Buraydah</button>
<button class="city-chip" data-city="Hafar Al Batin" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Hafar Al Batin</button>
<button class="city-chip" data-city="Hail" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Hail</button>
<button class="city-chip" data-city="Jazan" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Jazan</button>
<button class="city-chip" data-city="Jubail" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Jubail</button>
<button class="city-chip" data-city="Najran" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Najran</button>
<button class="city-chip" data-city="Tabuk" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Tabuk</button>
<button class="city-chip" data-city="Taif" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Taif</button>
<button class="city-chip" data-city="Yanbu" style="padding: 6px 12px; background: #e5e7eb; color: #1f2937; border: 2px solid #d1d5db; border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;">Yanbu</button>
</div>
</div>

<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
<button id="cityFilterBtn" style="padding: 8px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Apply Filter</button>
<button id="cityFilterResetBtn" style="padding: 8px 20px; background: #9ca3af; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Clear All</button>
</div>
</div>

<div class="chart-grid" style="margin-bottom: 20px;">
<div class="chart-container">
<h3 class="chart-title">Total Target by City (Trend)</h3>
<canvas id="cityTargetTrendChart"></canvas>
</div>
<div class="chart-container">
<h3 class="chart-title">Active Partners by City (Trend)</h3>
<canvas id="cityPartnersChart"></canvas>
</div>
</div>

<div id="avgScaleCardsRow" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px;">
  <div id="cardHighestScale" style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 12px;">
    <div style="font-size:10px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Highest Avg Scale</div>
    <div style="font-size:18px;font-weight:700;color:#065f46;margin:2px 0;" id="cardHighVal">—</div>
    <div style="font-size:11px;color:#374151;" id="cardHighCity">—</div>
    <div style="font-size:11px;font-weight:600;margin-top:2px;" id="cardHighMom">—</div>
  </div>
  <div id="cardLowestScale" style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px 12px;">
    <div style="font-size:10px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Lowest Avg Scale</div>
    <div style="font-size:18px;font-weight:700;color:#991b1b;margin:2px 0;" id="cardLowVal">—</div>
    <div style="font-size:11px;color:#374151;" id="cardLowCity">—</div>
    <div style="font-size:11px;font-weight:600;margin-top:2px;" id="cardLowMom">—</div>
  </div>
  <div id="cardBestMom" style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:10px 12px;">
    <div style="font-size:10px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Best MoM Improver</div>
    <div style="font-size:18px;font-weight:700;color:#1e40af;margin:2px 0;" id="cardBestMomVal">—</div>
    <div style="font-size:11px;color:#374151;" id="cardBestMomCity">—</div>
    <div style="font-size:11px;color:#6b7280;" id="cardBestMomScale">—</div>
  </div>
  <div id="cardWorstMom" style="background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:10px 12px;">
    <div style="font-size:10px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.5px;">Steepest MoM Decline</div>
    <div style="font-size:18px;font-weight:700;color:#92400e;margin:2px 0;" id="cardWorstMomVal">—</div>
    <div style="font-size:11px;color:#374151;" id="cardWorstMomCity">—</div>
    <div style="font-size:11px;color:#6b7280;" id="cardWorstMomScale">—</div>
  </div>
</div>
<div class="chart-container" style="margin-bottom: 16px;">
<h3 class="chart-title">City-wise Avg Scale Trend (Target ÷ Partners)</h3>
<canvas id="cityCombinedTrendChart" style="max-height: 320px;"></canvas>
</div>

<div class="table-container" style="margin-bottom: 20px;">
<h4 style="color: #1f2937; margin: 0 0 10px 0;">City-wise Monthly Target & Partners Overview</h4>
<p data-i18n-html="desc-allcities" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Complete view of all cities across 6 months showing partner counts and total target capacity. MoM % change calculated from previous month.</p>
<table id="cityWiseTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
</div>
</div>
</details>
</div>

<!-- TIER CITY (T1 vs T2) EXPANDABLE SECTION -->
<div id="tierCitySection" style="margin-top: 35px;">
<details id="tierCityDetails" open style="background: #f8fafc; border: 2px solid #1e3a8a; border-radius: 10px; padding: 14px;">
    <summary style="cursor: pointer; font-size: 18px; font-weight: 700; color: #1e3a8a; display: flex; align-items: center; gap: 10px; list-style: none;">
        <span id="tierCityArrow" style="font-size: 18px; color: #1e3a8a;">▶</span>
        <span>📊 Tier City Overview (T1 vs T2) — click to expand/collapse</span>
    </summary>
<div style="margin-top: 14px;">
<div class="info-box" style="background: #e0f2fe; border-left: 4px solid #2563eb; margin-bottom: 12px;">
                    <p style="margin: 0; font-size: 14px; color: #1d4ed8;">
                        <strong>Takeaway:</strong> T1 drives ~90.2% of targets while T2 holds ~9.8% in Feb. T1 shows a sharper pullback in Feb while T2 stays relatively flat; maintain T2 density (avg scale ~21.0) and prioritize T1 recovery.
                    </p>
                </div>
                <div class="info-box" style="background: #fef3c7; border-left: 4px solid #f59e0b; margin-bottom: 18px;">
                    <p style="margin: 0; font-size: 13px; color: #92400e;">
                        <strong>📌 Highlighted Arrows:</strong> Green ↑ or Red ↓ with percentage show <strong>month-over-month change</strong> for each metric within the same tier (T1 compared to previous T1, T2 to previous T2). This helps identify growth or decline trends for each tier independently.
</p>
</div>

<!-- Tier Filter Slicer -->
<div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <label style="font-weight: 600; color: #1f2937;">Filter by Tier:</label>
                    <div id="tierFilterContainer" style="display: flex; gap: 8px;">
                        <button class="tier-filter-chip" data-tier="both" style="padding: 8px 16px; border: 2px solid #3b82f6; background: #3b82f6; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">Both (T1 & T2)</button>
                        <button class="tier-filter-chip" data-tier="t1" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">T1 Only</button>
                        <button class="tier-filter-chip" data-tier="t2" style="padding: 8px 16px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px;">T2 Only</button>
                    </div>
                </div>

<div class="chart-grid" style="margin-bottom: 16px;">
<div class="chart-container">
<h3 class="chart-title">T1 vs T2 Total Target (with combined trend)</h3>
<canvas id="tierTargetChart"></canvas>
</div>
<div class="chart-container">
<h3 class="chart-title">Partners with Target (T1/T2) + Total Trend</h3>
<canvas id="tierPartnersChart"></canvas>
</div>
</div>

<!-- Tier Tables Slicer Navigation -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px;">
                        <button class="tier-table-slicer-btn" data-view="tierOverview" style="padding: 10px 18px; background: #1e3a8a; color: white; border: 2px solid #1e3a8a; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease;">📋 Tier Overview</button>
                        <button class="tier-table-slicer-btn" data-view="partnerPerf" style="padding: 10px 18px; background: white; color: #374151; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease;">👥 Partners — Performance</button>
                        <button class="tier-table-slicer-btn" data-view="partnerScale" style="padding: 10px 18px; background: white; color: #374151; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease;">📊 Partners — Scale</button>
                        <button class="tier-table-slicer-btn" data-view="targetPerf" style="padding: 10px 18px; background: white; color: #374151; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease;">🎯 Target — Performance</button>
                        <button class="tier-table-slicer-btn" data-view="targetScale" style="padding: 10px 18px; background: white; color: #374151; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease;">📈 Target — Scale</button>
                    </div>
                </div>

                <!-- Panel 1: Tier Overview by Month -->
                <div class="tier-table-panel slicer-panel" data-panel="tierOverview" style="display: block;">
                    <div class="table-container" style="margin-bottom: 16px;">
                        <h4 style="color: #1f2937; margin: 0 0 5px 0;">Tier Overview by Month (counts shown with share%)</h4>
                        <p data-i18n-html="desc-tieroverview" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Comprehensive view of T1 vs T2 cities showing monthly targets, active partners, partners with targets, and average scale. Weighted Avg Scale represents overall market capacity efficiency. Last row shows 6-month averages.</p>
                        <table id="tierOverviewTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
                    </div>
                </div>

                <!-- Panel 2: Partners with Target — Performance Split -->
                <div class="tier-table-panel" data-panel="partnerPerf" style="display: none;">
                    <div class="table-container" style="margin-bottom: 16px;">
                        <h4 style="color: #1f2937; margin: 0 0 5px 0;">Partners with Target — Performance Split (good / average / bad)</h4>
                        <p data-i18n-html="desc-tierperfmix" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Distribution of partners with targets by performance level across T1 and T2 cities. Good (≥80% FR), Average (50-80% FR), Bad (&lt;50% FR). Shows quality mix differences between tier cities.</p>
                        <table id="tierPerfTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
                    </div>
                </div>

                <!-- Panel 3: Partners with Target — Scale Split -->
                <div class="tier-table-panel" data-panel="partnerScale" style="display: none;">
                    <div class="table-container" style="margin-bottom: 16px;">
                        <h4 style="color: #1f2937; margin: 0 0 5px 0;">Partners with Target — Scale Split (big / mid / small)</h4>
                        <p data-i18n-html="desc-tiersizemix" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Partner count distribution by size level (Big/Mid/Small) for T1 vs T2 cities. Big partners have high order proportion (&gt;0.7) and scale; Small have low proportion (&lt;0.1) or riders; Mid are in between. Reveals partner base structure differences.</p>
                        <table id="tierScaleTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
                    </div>
                </div>

                <!-- Panel 4: Total Target — Performance Split -->
                <div class="tier-table-panel" data-panel="targetPerf" style="display: none;">
                    <div class="table-container" style="margin-bottom: 12px;">
                        <h4 style="color: #1f2937; margin: 0 0 5px 0;">Total Target — Performance Split (with share%)</h4>
                        <p data-i18n-html="desc-tierperfvol" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Distribution of total target riders by performance level (Good/Average/Bad) across T1 and T2 cities. Shows how capacity volume is distributed across quality tiers and city types.</p>
                        <table id="tierTargetPerfTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
                    </div>
                </div>

                <!-- Panel 5: Total Target — Scale Split -->
                <div class="tier-table-panel" data-panel="targetScale" style="display: none;">
                    <div class="table-container" style="margin-bottom: 8px;">
                        <h4 style="color: #1f2937; margin: 0 0 5px 0;">Total Target — Scale Split (with share%)</h4>
                        <p data-i18n-html="desc-tiersizevol" style="color: #6b7280; font-size: 12px; margin: 0 0 10px 0; font-style: italic;">Distribution of total target riders by partner size level (Big/Mid/Small) for T1 vs T2 cities. Reveals how capacity volume concentrates across different partner scales and tier types.</p>
                        <table id="tierTargetScaleTable" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table>
                    </div>
                </div>
</div>
</details>
</div>
<!-- PARTNER WILLING ANALYSIS SECTION -->
<div style="margin-top: 20px;">
<h3 id="monthlyWillingSection" style="color: #1f4e78; margin-bottom: 10px; font-size: 18px; border-bottom: 3px solid #3b82f6; padding-bottom: 6px;">
                    📊 Partner Willing Analysis (Monthly Comparison)
                </h3>
<div class="info-box" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6; margin-bottom: 12px; border-radius: 0 8px 8px 0; padding: 8px 14px;">
<p data-i18n-html="willingness-definition" style="margin: 0; font-size: 14px; color: #1e40af; line-height: 1.6;">
<strong style="color: #1e3a5f;">📋 Definition:</strong> "Willing Partners" are those who <span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-weight: 600;">increased their capacity target</span> compared to the previous month.
                        "Not-Willing Partners" have <span style="background: #fee2e2; color: #b91c1c; padding: 2px 8px; border-radius: 4px; font-weight: 600;">decreased or maintained</span> the same target (Target Increase ≤ 0).
                    </p>
</div>

<!-- Summary KPI Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 10px; margin-bottom: 14px;">
    <!-- Latest Month Willing % -->
    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; padding: 12px 14px; border: 1px solid #a7f3d0; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 10px; color: #059669; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Feb-26 Willing %</div>
                <div style="font-size: 22px; font-weight: 800; color: #065f46; margin: 3px 0;">24.6%</div>
            </div>
            <div style="background: #fee2e2; color: #dc2626; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 700;">↓ -8.1pp</div>
        </div>
        <div style="margin-top: 4px; display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 10px; color: #6b7280;">vs Jan-26:</span>
            <span style="font-size: 11px; font-weight: 600; color: #374151;">32.7%</span>
            <svg width="40" height="16" style="margin-left: auto;">
                <polyline points="0,8 8,6 16,12 24,4 32,10 40,14" fill="none" stroke="#059669" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </div>
    </div>
    
    <!-- Latest Month Willing Count -->
    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px; padding: 12px 14px; border: 1px solid #bbf7d0; box-shadow: 0 2px 6px rgba(34, 197, 94, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 10px; color: #16a34a; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Feb-26 Willing</div>
                <div style="font-size: 22px; font-weight: 800; color: #15803d; margin: 3px 0;">130</div>
            </div>
            <div style="background: #fee2e2; color: #dc2626; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 700;">↓ -35.3%</div>
        </div>
        <div style="margin-top: 4px; display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 10px; color: #6b7280;">vs Jan-26:</span>
            <span style="font-size: 11px; font-weight: 600; color: #374151;">201</span>
            <svg width="40" height="16" style="margin-left: auto;">
                <polyline points="0,4 8,2 16,1 24,12 32,6 40,10" fill="none" stroke="#16a34a" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </div>
    </div>
    
    <!-- Latest Month Not-Willing Count -->
    <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 10px; padding: 12px 14px; border: 1px solid #fecaca; box-shadow: 0 2px 6px rgba(239, 68, 68, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 10px; color: #dc2626; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Feb-26 Not-Willing</div>
                <div style="font-size: 22px; font-weight: 800; color: #b91c1c; margin: 3px 0;">398</div>
            </div>
            <div style="background: #dcfce7; color: #16a34a; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 700;">↓ -3.6%</div>
        </div>
        <div style="margin-top: 4px; display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 10px; color: #6b7280;">vs Jan-26:</span>
            <span style="font-size: 11px; font-weight: 600; color: #374151;">413</span>
            <svg width="40" height="16" style="margin-left: auto;">
                <polyline points="0,6 8,5 16,4 24,2 32,5 40,6" fill="none" stroke="#dc2626" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </div>
    </div>
    
    <!-- New Partners -->
    <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 10px; padding: 12px 14px; border: 1px solid #bfdbfe; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 10px; color: #2563eb; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Feb-26 New Partners</div>
                <div style="font-size: 22px; font-weight: 800; color: #1e40af; margin: 3px 0;">23</div>
            </div>
            <div style="background: #dcfce7; color: #16a34a; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 700;">↑ +109.1%</div>
        </div>
        <div style="margin-top: 4px; display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 10px; color: #6b7280;">vs Jan-26:</span>
            <span style="font-size: 11px; font-weight: 600; color: #374151;">11</span>
            <svg width="40" height="16" style="margin-left: auto;">
                <polyline points="0,4 8,2 16,1 24,12 32,14 40,8" fill="none" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </div>
    </div>
    
    <!-- 5-Month Average -->
    <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 10px; padding: 12px 14px; border: 1px solid #e9d5ff; box-shadow: 0 2px 6px rgba(139, 92, 246, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 10px; color: #7c3aed; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">5-Mo Avg Willing %</div>
                <div style="font-size: 22px; font-weight: 800; color: #6d28d9; margin: 3px 0;">30.0%</div>
            </div>
            <div style="background: #f3e8ff; color: #7c3aed; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 700;">AVG</div>
        </div>
        <div style="margin-top: 4px; display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 10px; color: #6b7280;">Range:</span>
            <span style="font-size: 11px; font-weight: 600; color: #374151;">12.8% - 40.5%</span>
        </div>
    </div>
</div>

<!-- Enhanced Summary Table -->
<div class="table-container" style="margin-bottom: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 12px rgba(0,0,0,0.08);">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: linear-gradient(135deg, #1e5a8e 0%, #1e3a5f 100%);">
<th style="padding: 9px 12px; text-align: left; border: none; color: white; font-size: 12px; font-weight: 700;">Month</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">Total Partners</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">✓ Willing (>0)</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">✗ Not-Willing (≤0)</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">🆕 New Partners</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">Willing %</th>
<th style="padding: 9px 12px; text-align: center; border: none; color: white; font-size: 12px; font-weight: 700;">Not-Willing %</th>
</tr>
</thead>
<tbody>
<tr style="background: #f8fafc; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">
    <span style="display: inline-flex; align-items: center; gap: 6px;">
        <span style="background: #e0e7ff; color: #4338ca; padding: 1px 6px; border-radius: 4px; font-size: 10px;">BASE</span>
        Sep-25
    </span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center; font-weight: 600; font-size: 13px;">615</td>
<td colspan="5" style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #64748b; font-style: italic; background: #f8fafc; font-size: 12px;">
    <span style="display: inline-flex; align-items: center; gap: 5px;">
        <svg width="14" height="14" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="7" cy="7" r="5"/><line x1="7" y1="4" x2="7" y2="7"/><line x1="7" y1="7" x2="9" y2="9"/></svg>
        Baseline month (no comparison data)
    </span>
</td>
</tr>

<!-- Oct-25 Row -->
<tr style="background: #ffffff; transition: all 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#ffffff'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">Oct-25</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="font-weight: 700; font-size: 13px;">697</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600;">↑ +13.3%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #065f46; display: inline-block; min-width: 40px; font-size: 12px;">213</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #b91c1c; display: inline-block; min-width: 40px; font-size: 12px;">356</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #1e40af; display: inline-block; min-width: 40px; font-size: 12px;">128</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <span style="font-weight: 700; color: #059669; font-size: 13px;">37.4%</span>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 37.4%; height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <span style="font-weight: 700; color: #dc2626; font-size: 13px;">62.6%</span>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 62.6%; height: 100%; background: linear-gradient(90deg, #f87171 0%, #dc2626 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
</tr>

<!-- Nov-25 Row -->
<tr style="background: #f8fafc; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">Nov-25</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="font-weight: 700; font-size: 13px;">767</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600;">↑ +10.0%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #065f46; display: inline-block; min-width: 40px; font-size: 12px;">259</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600; margin-top: 2px;">↑ +21.6%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #b91c1c; display: inline-block; min-width: 40px; font-size: 12px;">381</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↑ +7.0%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #1e40af; display: inline-block; min-width: 40px; font-size: 12px;">127</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↓ -0.8%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #059669; font-size: 13px;">40.5%</span>
            <span style="background: #dcfce7; color: #16a34a; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↑ +3.1pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 40.5%; height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #dc2626; font-size: 13px;">59.5%</span>
            <span style="background: #dcfce7; color: #16a34a; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↓ -3.1pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 59.5%; height: 100%; background: linear-gradient(90deg, #f87171 0%, #dc2626 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
</tr>

<!-- Dec-25 Row -->
<tr style="background: #ffffff; transition: all 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='#ffffff'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">Dec-25</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="font-weight: 700; font-size: 13px;">674</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600;">↓ -12.1%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #065f46; display: inline-block; min-width: 40px; font-size: 12px;">81</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↓ -68.7%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #b91c1c; display: inline-block; min-width: 40px; font-size: 12px;">554</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↑ +45.4%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #1e40af; display: inline-block; min-width: 40px; font-size: 12px;">39</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↓ -69.3%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #059669; font-size: 13px;">12.8%</span>
            <span style="background: #fee2e2; color: #dc2626; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↓ -27.7pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 12.8%; height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #dc2626; font-size: 13px;">87.2%</span>
            <span style="background: #fee2e2; color: #dc2626; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↑ +27.7pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 87.2%; height: 100%; background: linear-gradient(90deg, #f87171 0%, #dc2626 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
</tr>

<!-- Jan-26 Row -->
<tr style="background: #f8fafc; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">Jan-26</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="font-weight: 700; font-size: 13px;">625</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600;">↓ -7.3%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #065f46; display: inline-block; min-width: 40px; font-size: 12px;">201</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600; margin-top: 2px;">↑ +148.1%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #b91c1c; display: inline-block; min-width: 40px; font-size: 12px;">413</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600; margin-top: 2px;">↓ -25.5%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #1e40af; display: inline-block; min-width: 40px; font-size: 12px;">11</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↓ -71.8%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #059669; font-size: 13px;">32.7%</span>
            <span style="background: #dcfce7; color: #16a34a; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↑ +19.9pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 32.7%; height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #dc2626; font-size: 13px;">67.3%</span>
            <span style="background: #dcfce7; color: #16a34a; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↓ -19.9pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 67.3%; height: 100%; background: linear-gradient(90deg, #f87171 0%, #dc2626 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
</tr>

<!-- Feb-26 Row (Latest) -->
<tr style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); transition: all 0.2s; border-left: 4px solid #eab308;" onmouseover="this.style.boxShadow='inset 0 0 0 2px #fbbf24'" onmouseout="this.style.boxShadow='none'">
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #1e3a5f; font-size: 12px;">
    <span style="display: inline-flex; align-items: center; gap: 6px;">
        <span style="background: #fbbf24; color: #78350f; padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 700;">LATEST</span>
        Feb-26
    </span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="font-weight: 700; font-size: 13px;">551</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600;">↓ -11.8%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #065f46; display: inline-block; min-width: 40px; font-size: 12px;">130</span>
    <span style="display: block; font-size: 9px; color: #dc2626; font-weight: 600; margin-top: 2px;">↓ -35.3%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #b91c1c; display: inline-block; min-width: 40px; font-size: 12px;">398</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600; margin-top: 2px;">↓ -3.6%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 4px 10px; border-radius: 6px; font-weight: 700; color: #1e40af; display: inline-block; min-width: 40px; font-size: 12px;">23</span>
    <span style="display: block; font-size: 9px; color: #16a34a; font-weight: 600; margin-top: 2px;">↑ +109.1%</span>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #059669; font-size: 13px;">24.6%</span>
            <span style="background: #fee2e2; color: #dc2626; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↓ -8.1pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 24.6%; height: 100%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
<td style="padding: 7px 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-weight: 700; color: #dc2626; font-size: 13px;">75.4%</span>
            <span style="background: #fee2e2; color: #dc2626; padding: 1px 5px; border-radius: 8px; font-size: 8px; font-weight: 700;">↑ +8.1pp</span>
        </div>
        <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
            <div style="width: 75.4%; height: 100%; background: linear-gradient(90deg, #f87171 0%, #dc2626 100%); border-radius: 2px;"></div>
        </div>
    </div>
</td>
</tr>

<!-- Average Row -->
<tr style="background: linear-gradient(135deg, #1e5a8e 0%, #1e3a5f 100%); color: white;">
<td style="padding: 9px 12px; border: none; font-weight: 700; border-radius: 0 0 0 10px; font-size: 12px;">
    <span style="display: inline-flex; align-items: center; gap: 6px;">
        <svg width="14" height="14" fill="white"><rect x="2" y="5" width="10" height="3" rx="1"/><rect x="5" y="2" width="4" height="10" rx="1"/></svg>
        Average (Oct-25 - Feb-26)
    </span>
</td>
<td style="padding: 9px 12px; border: none; text-align: center; font-weight: 700; font-size: 14px;">663</td>
<td style="padding: 9px 12px; border: none; text-align: center; font-weight: 700; font-size: 14px;">177</td>
<td style="padding: 9px 12px; border: none; text-align: center; font-weight: 700; font-size: 14px;">420</td>
<td style="padding: 9px 12px; border: none; text-align: center; font-weight: 700; font-size: 14px;">66</td>
<td style="padding: 9px 12px; border: none; text-align: center;">
    <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 5px; font-weight: 700; font-size: 13px;">30.0%</span>
</td>
<td style="padding: 9px 12px; border: none; text-align: center; border-radius: 0 0 10px 0;">
    <span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 5px; font-weight: 700; font-size: 13px;">70.0%</span>
</td>
</tr>
</tbody>
</table>
</div>
<!-- Charts Grid -->
<div class="chart-grid">
<div class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 6px; flex-wrap: wrap;">
        <button class="slab-slicer-btn active" data-target="willingness" data-view="trend">Trend %</button>
        <button class="slab-slicer-btn" data-target="willingness" data-view="bars">Willing vs Not</button>
    </div>
</div>
<div data-panel="willingness" data-view="bars">
    <h3 class="chart-title">Monthly Willing vs Not-Willing Partners</h3>
    <p data-i18n-html="desc-willingbars" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Stacked bars show monthly willing vs not‑willing partners (counts). Use the filter to switch to % trend.</p>
    <canvas id="willingVsNotWillingChart"></canvas>
</div>
<div data-panel="willingness" data-view="trend" style="display: none;">
    <h3 class="chart-title">Partner Willingness Trend (%)</h3>
    <p data-i18n-html="desc-willinglines" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Line trend shows willingness share over time (percent). Use the filter to switch to counts.</p>
    <canvas id="willingnessTrendChart"></canvas>
</div>
</div>
<div class="chart-container">
<div style="text-align: center; margin-bottom: 12px;">
    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 6px; flex-wrap: wrap;">
        <button class="slab-slicer-btn active" data-target="growth" data-view="increase">Increase</button>
        <button class="slab-slicer-btn" data-target="growth" data-view="decrease">Decrease</button>
    </div>
</div>
<div data-panel="growth" data-view="increase">
    <h3 class="chart-title">Growth Category Breakdown (Increase Slabs)</h3>
    <p data-i18n-html="desc-growthdist" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Partners by % target increase (0%, 1-10%, 11-20%, 21-30%, &gt;30%). Line shows total partners with any increase.</p>
    <canvas id="growthCategoryChart"></canvas>
</div>
<div data-panel="growth" data-view="decrease" style="display: none;">
    <h3 class="chart-title">Growth Category Breakdown (Decrease Slabs)</h3>
    <p data-i18n-html="desc-decreasedist" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Partners by % target decrease (0%, -1 to -10%, -11 to -20%, -21 to -30%, &lt;-30%). Line shows total partners with any decrease.</p>
    <canvas id="decreaseCategoryChart"></canvas>
</div>
</div>
</div>
<!-- MoM Chart with proper percentages -->
<div class="chart-grid">
<div class="chart-container">
<h3 class="chart-title">Partner Size Breakdown - Willingness by Target Size</h3>
<div class="table-container compact-table nowrap-table" style="margin: 0; max-height: 500px; overflow: auto;">
<table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1800px;">
<thead style="position: sticky; top: 0; background: #1e5a8e; z-index: 10;">
<tr style="color: white;">
<th style="padding: 12px 16px; border: 1px solid #ddd; text-align: left; width: 160px; background: #1e5a8e; white-space: nowrap;">Size</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Oct-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; color: #1e5a8e; font-weight: 700;">Nov-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Dec-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; color: #1e5a8e; font-weight: 700;">Jan-26</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Feb-26</th>
</tr>
<tr style="color: white; background: #1e5a8e;">
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: left;"></th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Big</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Mid</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Small</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Big</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Mid</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Small</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Big</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Mid</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Small</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Big</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Mid</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Small</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Big</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Mid</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Small</th>
</tr>
</thead>
<tbody>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">Total</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">213 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">28 <span style="color: #dc2626; font-weight: 600;">↓ (13.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">116 <span style="color: #059669; font-weight: 600;">↑ (54.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">69 <span style="color: #059669; font-weight: 600;">↑ (32.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">258 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">24 <span style="color: #dc2626; font-weight: 600;">↓ (9.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">129 <span style="color: #059669; font-weight: 600;">↑ (50.0%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">105 <span style="color: #059669; font-weight: 600;">↑ (40.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">79 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">7 <span style="color: #dc2626; font-weight: 600;">↓ (8.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">32 <span style="color: #059669; font-weight: 600;">↑ (40.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">40 <span style="color: #059669; font-weight: 600;">↑ (50.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">201 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">22 <span style="color: #dc2626; font-weight: 600;">↓ (10.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">96 <span style="color: #059669; font-weight: 600;">↑ (47.8%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">83 <span style="color: #059669; font-weight: 600;">↑ (41.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">129 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">13 <span style="color: #dc2626; font-weight: 600;">↓ (10.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">62 <span style="color: #059669; font-weight: 600;">↑ (48.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">54 <span style="color: #059669; font-weight: 600;">↑ (41.9%)</span></td>
</tr>
<tr style="background: #f9fafb;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">≥1%-≤10%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">60 (28.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">11 <span style="color: #059669; font-weight: 600;">↑ (39.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">37 <span style="color: #059669; font-weight: 600;">↑ (31.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 (17.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">73 (28.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">16 <span style="color: #059669; font-weight: 600;">↑ (66.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">47 <span style="color: #059669; font-weight: 600;">↑ (36.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 <span style="color: #dc2626; font-weight: 600;">↓ (9.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">22 (27.8%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">4 <span style="color: #059669; font-weight: 600;">↑ (57.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 <span style="color: #059669; font-weight: 600;">↑ (37.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">6 (15.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">79 (39.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">16 (72.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">40 (41.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">23 (27.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">46 (35.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">8 <span style="color: #059669; font-weight: 600;">↑ (61.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">27 <span style="color: #059669; font-weight: 600;">↑ (43.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">11 <span style="color: #dc2626; font-weight: 600;">↓ (20.4%)</span></td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">>10%-<20%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">86 <span style="color: #059669; font-weight: 600;">↑ (40.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 <span style="color: #059669; font-weight: 600;">↑ (42.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">47 <span style="color: #059669; font-weight: 600;">↑ (40.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">27 <span style="color: #059669; font-weight: 600;">↑ (39.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">112 <span style="color: #059669; font-weight: 600;">↑ (43.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">4 (16.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">59 <span style="color: #059669; font-weight: 600;">↑ (45.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">49 <span style="color: #059669; font-weight: 600;">↑ (46.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">31 <span style="color: #059669; font-weight: 600;">↑ (39.2%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 <span style="color: #059669; font-weight: 600;">↑ (42.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">13 <span style="color: #059669; font-weight: 600;">↑ (40.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">15 <span style="color: #059669; font-weight: 600;">↑ (37.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">58 (28.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">5 (22.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">30 (31.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">23 (27.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">51 <span style="color: #059669; font-weight: 600;">↑ (39.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">4 <span style="color: #059669; font-weight: 600;">↑ (30.8%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">22 <span style="color: #059669; font-weight: 600;">↑ (35.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">25 <span style="color: #059669; font-weight: 600;">↑ (46.3%)</span></td>
</tr>
<tr style="background: #f9fafb;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">≥20%-≤30%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">30 <span style="color: #dc2626; font-weight: 600;">↓ (14.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 <span style="color: #dc2626; font-weight: 600;">↓ (10.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">15 <span style="color: #dc2626; font-weight: 600;">↓ (12.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 (17.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">35 <span style="color: #dc2626; font-weight: 600;">↓ (13.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">4 (16.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 <span style="color: #dc2626; font-weight: 600;">↓ (9.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">19 (18.1%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">14 (17.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">5 (15.6%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">9 <span style="color: #dc2626;">(22.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">28 (13.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">1 (4.5%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">14 (14.6%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">13 (15.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">16 (12.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">1 <span style="color: #dc2626; font-weight: 600;">↓ (7.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">5 <span style="color: #dc2626; font-weight: 600;">↓ (8.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 (18.5%)</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">>30%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">37 (17.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 <span style="color: #dc2626; font-weight: 600;">↓ (7.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">17 <span style="color: #dc2626; font-weight: 600;">↓ (14.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">18 (26.1%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">38 <span style="color: #dc2626; font-weight: 600;">↓ (14.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">11 <span style="color: #dc2626; font-weight: 600;">↓ (8.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">27 (25.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">12 (15.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 <span style="color: #dc2626; font-weight: 600;">↓ (6.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 (25.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">36 (17.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 (12.5%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">24 (28.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">16 (12.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">8 <span style="color: #dc2626; font-weight: 600;">↓ (12.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">8 (14.8%)</td>
</tr>
</tbody>
</table>
</div>
<div class="header-subtitle" style="margin-top: 10px;">
Shows willingness to increase targets by partner size reveals which size segments drive growth across all months.
</div>
</div>
<div class="chart-container">
<h3 class="chart-title">Partner Performance Breakdown - Willingness by Target Size</h3>
<div class="table-container compact-table nowrap-table" style="margin: 0; max-height: 500px; overflow: auto;">
<table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1800px;">
<thead style="position: sticky; top: 0; background: #1e5a8e; z-index: 10;">
<tr style="color: white;">
<th style="padding: 12px 16px; border: 1px solid #ddd; text-align: left; width: 160px; background: #1e5a8e; white-space: nowrap;">Performance</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Oct-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; color: #1e5a8e; font-weight: 700;">Nov-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Dec-25</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; color: #1e5a8e; font-weight: 700;">Jan-26</th>
<th colspan="4" style="padding: 12px 16px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; color: #1e5a8e; font-weight: 700;">Feb-26</th>
</tr>
<tr style="color: white; background: #1e5a8e;">
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: left;"></th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Good</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Average</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Bad</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Good</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Average</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Bad</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Good</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Average</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Bad</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Good</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Average</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Bad</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Overall</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Good</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Average</th>
<th style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; width: 110px;">Bad</th>
</tr>
</thead>
<tbody>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">Total</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">213 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">28 <span style="color: #dc2626; font-weight: 600;">↓ (13.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">116 <span style="color: #059669; font-weight: 600;">↑ (54.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">69 <span style="color: #059669; font-weight: 600;">↑ (32.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">258 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">24 <span style="color: #dc2626; font-weight: 600;">↓ (9.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">129 <span style="color: #059669; font-weight: 600;">↑ (50.0%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">105 <span style="color: #059669; font-weight: 600;">↑ (40.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">79 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">7 <span style="color: #dc2626; font-weight: 600;">↓ (8.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">32 <span style="color: #059669; font-weight: 600;">↑ (40.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">40 <span style="color: #059669; font-weight: 600;">↑ (50.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">201 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">109 (54.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">77 (38.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">15 (7.5%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; font-weight: 700; background: #e3f2fd;">129 <span class="overall-badge">(100%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">82 <span style="color: #059669; font-weight: 600;">↑ (63.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">46 <span style="color: #059669; font-weight: 600;">↑ (35.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #ecfdf5;">1 <span style="color: #dc2626; font-weight: 600;">↓ (0.8%)</span></td>
</tr>
<tr style="background: #f9fafb;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">≥1%-≤10%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">60 (28.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 <span style="color: #059669; font-weight: 600;">↑ (35.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">35 <span style="color: #059669; font-weight: 600;">↑ (30.2%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">15 <span style="color: #dc2626;">(21.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">73 (28.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">7 (29.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">41 <span style="color: #059669; font-weight: 600;">↑ (31.8%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">25 (23.8%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">22 (27.8%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 <span style="color: #059669; font-weight: 600;">↑ (42.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">13 <span style="color: #059669; font-weight: 600;">↑ (40.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">6 (15.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">79 (39.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">46 (42.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">29 (37.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">4 (26.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">46 (35.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">32 <span style="color: #059669; font-weight: 600;">↑ (39.0%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">14 <span style="color: #059669; font-weight: 600;">↑ (30.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">>10%-<20%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">86 <span style="color: #059669; font-weight: 600;">↑ (40.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">13 <span style="color: #059669; font-weight: 600;">↑ (46.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">45 <span style="color: #059669; font-weight: 600;">↑ (38.8%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">28 <span style="color: #059669; font-weight: 600;">↑ (40.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">112 <span style="color: #059669; font-weight: 600;">↑ (43.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 <span style="color: #059669; font-weight: 600;">↑ (50.0%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">60 <span style="color: #059669; font-weight: 600;">↑ (46.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">40 <span style="color: #059669; font-weight: 600;">↑ (38.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">31 <span style="color: #059669; font-weight: 600;">↑ (39.2%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 (28.6%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">14 <span style="color: #059669; font-weight: 600;">↑ (43.8%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">15 <span style="color: #059669; font-weight: 600;">↑ (37.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">58 (28.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">32 (29.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">20 (26.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">6 (40.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">51 <span style="color: #059669; font-weight: 600;">↑ (39.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">33 <span style="color: #059669; font-weight: 600;">↑ (40.2%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">18 <span style="color: #059669; font-weight: 600;">↑ (39.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
</tr>
<tr style="background: #f9fafb;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">≥20%-≤30%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">30 <span style="color: #dc2626; font-weight: 600;">↓ (14.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 (10.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">19 (16.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">8 <span style="color: #dc2626; font-weight: 600;">↓ (11.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">35 <span style="color: #dc2626; font-weight: 600;">↓ (13.6%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 <span style="color: #dc2626; font-weight: 600;">↓ (12.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">16 <span style="color: #dc2626; font-weight: 600;">↓ (12.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">16 (15.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">14 (17.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 (28.6%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 <span style="color: #dc2626; font-weight: 600;">↓ (9.4%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">9 <span style="color: #dc2626;">(22.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">28 (13.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">15 (13.8%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">11 (14.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 (13.3%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">16 (12.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 <span style="color: #dc2626; font-weight: 600;">↓ (12.2%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">6 <span style="color: #dc2626; font-weight: 600;">↓ (13.0%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 10px 12px; border: 1px solid #ddd; font-weight: 700; white-space: nowrap;">>30%</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">37 (17.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 <span style="color: #dc2626; font-weight: 600;">↓ (7.1%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">17 <span style="color: #dc2626; font-weight: 600;">↓ (14.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">18 (26.1%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">38 <span style="color: #dc2626; font-weight: 600;">↓ (14.7%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 <span style="color: #dc2626; font-weight: 600;">↓ (8.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">12 <span style="color: #dc2626; font-weight: 600;">↓ (9.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">24 <span style="color: #dc2626;">(22.9%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">12 (15.2%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">0 (0.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">2 <span style="color: #dc2626; font-weight: 600;">↓ (6.3%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">10 (25.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">36 (17.9%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">16 (14.7%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">17 (22.1%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">3 (20.0%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap; background: #e3f2fd;">16 (12.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">7 <span style="color: #dc2626; font-weight: 600;">↓ (8.5%)</span></td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">8 (17.4%)</td>
<td style="padding: 10px 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">1 <span style="color: #059669; font-weight: 600;">↑ (100.0%)</span></td>
</tr>
</tbody>
</table>
</div>
<div class="header-subtitle" style="margin-top: 10px;">
Shows willingness to increase targets by partner performance reveals which level segments drive growth across all months.
</div>
</div></div>
</div>
<!-- RIDERS SLAB DISTRIBUTION CHART & TABLE -->
<div style="margin-top: 30px;">
<div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
    <button class="slab-slicer-btn active" data-target="ridersSlab" data-view="total">Total</button>
    <button class="slab-slicer-btn" data-target="ridersSlab" data-view="increased">Increased</button>
    <button class="slab-slicer-btn" data-target="ridersSlab" data-view="decreased">Decreased</button>
</div>
<div class="chart-container" id="ridersSlabPanelTotal" style="margin-top: 20px;">
<h3 class="chart-title">Partners by Riders Slab Distribution</h3>
<p data-i18n-html="desc-riderslab" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Number of partners in each rider count range across all months. Helps identify capacity distribution patterns.</p>

<!-- Interactive Bar Chart -->
<div style="position: relative; width: 100%; height: 350px; margin-bottom: 20px;">
<canvas id="ridersSlabTrendChart"></canvas>
</div>

<!-- Expandable Table -->
<div style="margin-top: 15px;">
<button id="toggleRidersTable" style="padding: 8px 16px; background: #1e5a8e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">▶ Show Table Details</button>
</div>
<div id="ridersTableContainer" class="table-container compact-table nowrap-table" style="margin: 10px 0 0 0; max-height: 350px; overflow-y: auto; display: none;">
<table style="width: 100%; border-collapse: collapse; font-size: 12px;">
<thead style="position: sticky; top: 0; background: #1e5a8e; z-index: 10;">
<tr style="color: white;">
<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Month</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥1-&lt;20</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥20-&lt;30</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥30-&lt;50</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥50-&lt;80</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥80-&lt;100</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥100-&lt;150</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥150-&lt;200</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥200-&lt;300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">≥300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">Total</th>
</tr>
</thead>
<tbody>
<tr style="background: #f0f9ff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Sep-25</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">58 <span style="color: #dc2626; font-weight: 600;">↓ (9.4%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">145 <span style="color: #059669; font-weight: 600;">↑ (23.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">176 <span style="color: #059669; font-weight: 600;">↑ (28.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">136 <span style="color: #059669; font-weight: 600;">↑ (22.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">36 (5.9%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">34 (5.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">14 <span style="color: #dc2626; font-weight: 600;">↓ (2.3%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">11 <span style="color: #dc2626; font-weight: 600;">↓ (1.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">5 <span style="color: #dc2626; font-weight: 600;">↓ (0.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">615</td>
</tr>
<tr style="background: #f0f9ff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Oct-25</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">95 <span style="color: #dc2626; font-weight: 600;">↓ (13.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">158 <span style="color: #059669; font-weight: 600;">↑ (22.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">201 <span style="color: #059669; font-weight: 600;">↑ (28.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">138 <span style="color: #059669; font-weight: 600;">↑ (19.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">38 (5.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">40 (5.7%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">13 <span style="color: #dc2626; font-weight: 600;">↓ (1.9%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">9 <span style="color: #dc2626; font-weight: 600;">↓ (1.3%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">5 <span style="color: #dc2626; font-weight: 600;">↓ (0.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">697</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Nov-25</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">119 <span style="color: #dc2626; font-weight: 600;">↓ (15.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">193 <span style="color: #059669; font-weight: 600;">↑ (25.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">221 <span style="color: #059669; font-weight: 600;">↑ (28.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">136 <span style="color: #059669; font-weight: 600;">↑ (17.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">37 (4.8%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">35 (4.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">14 <span style="color: #dc2626; font-weight: 600;">↓ (1.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">7 <span style="color: #dc2626; font-weight: 600;">↓ (0.9%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">5 <span style="color: #dc2626; font-weight: 600;">↓ (0.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">767</td>
</tr>
<tr style="background: #f0f9ff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Dec-25</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">183 <span style="color: #059669; font-weight: 600;">↑ (27.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">182 <span style="color: #059669; font-weight: 600;">↑ (27.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">181 <span style="color: #059669; font-weight: 600;">↑ (26.9%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">75 (11.1%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">20 <span style="color: #dc2626; font-weight: 600;">↓ (3.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">21 <span style="color: #dc2626; font-weight: 600;">↓ (3.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">8 <span style="color: #dc2626; font-weight: 600;">↓ (1.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">4 <span style="color: #dc2626; font-weight: 600;">↓ (0.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 <span style="color: #dc2626; font-weight: 600;">↓ (0.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">674</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Jan-26</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">181 <span style="color: #dc2626; font-weight: 600;">↓ (29.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">156 <span style="color: #dc2626; font-weight: 600;">↓ (25.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">172 <span style="color: #dc2626; font-weight: 600;">↓ (27.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">63 <span style="color: #dc2626; font-weight: 600;">↓ (10.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">23 <span style="color: #059669; font-weight: 600;">↑ (3.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">19 <span style="color: #dc2626; font-weight: 600;">↓ (3.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">7 <span style="color: #dc2626; font-weight: 600;">↓ (1.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">4 (0.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">625</td>
</tr>
<tr style="background: #f0f9ff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Feb-26</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">141 <span style="color: #dc2626; font-weight: 600;">↓ (25.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">160 <span style="color: #059669; font-weight: 600;">↑ (29.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">156 <span style="color: #dc2626; font-weight: 600;">↓ (28.3%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">49 <span style="color: #dc2626; font-weight: 600;">↓ (8.9%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">25 <span style="color: #059669; font-weight: 600;">↑ (4.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">13 <span style="color: #dc2626; font-weight: 600;">↓ (2.4%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">6 <span style="color: #dc2626; font-weight: 600;">↓ (1.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 <span style="color: #dc2626; font-weight: 600;">↓ (0.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700;">551</td>
</tr>
</tbody>
</table>
</div>
</div>

<script>
// Toggle Riders Table
document.getElementById('toggleRidersTable').addEventListener('click', function() {
    const container = document.getElementById('ridersTableContainer');
    const btn = this;
    if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '▼ Hide Table Details';
    } else {
        container.style.display = 'none';
        btn.textContent = '▶ Show Table Details';
    }
});

// Riders Slab Distribution Chart - Initialize after DOM is ready
setTimeout(function() {
    const ridersCanvas = document.getElementById('ridersSlabTrendChart');
    if (ridersCanvas && typeof Chart !== 'undefined') {
        const ridersCtx = ridersCanvas.getContext('2d');
        const totalChart = new Chart(ridersCtx, {
            type: 'line',
            data: {
                labels: ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'],
                datasets: [
                    {
                        label: '≥1-<20',
                        data: [58, 95, 119, 183, 181, 141],
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#dc2626',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥20-<30',
                        data: [145, 158, 193, 182, 156, 160],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥30-<50',
                        data: [176, 201, 221, 181, 172, 156],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥50-<80',
                        data: [136, 138, 136, 75, 63, 49],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥80-<100',
                        data: [36, 38, 37, 20, 23, 25],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥100-<150',
                        data: [34, 40, 35, 21, 19, 13],
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#ec4899',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥150-<200',
                        data: [14, 13, 14, 8, 7, 6],
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#f97316',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥200-<300',
                        data: [11, 9, 7, 4, 4, 1],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#06b6d4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '≥300',
                        data: [5, 5, 5, 0, 0, 0],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: { size: 11 },
                            padding: 10,
                            boxWidth: 12,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const monthIndex = context.dataIndex;
                                const totals = [615, 697, 767, 674, 625, 551];
                                const value = context.parsed.y || 0;
                                const pct = totals[monthIndex] ? ((value / totals[monthIndex]) * 100).toFixed(1) : '0.0';
                                return `${context.dataset.label}: ${value} (${pct}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: { size: 9, weight: 'bold' },
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        clamp: true,
                        clip: false,
                        formatter: function(value, context) {
                            const monthIndex = context.dataIndex;
                            const totals = [615, 697, 767, 674, 625, 551];
                            const pct = ((value / totals[monthIndex]) * 100).toFixed(1);
                            return value + '\n(' + pct + '%)';
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 11 } },
                        title: {
                            display: true,
                            text: 'Number of Partners',
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    x: {
                        ticks: { font: { size: 11 } },
                        title: {
                            display: true,
                            text: 'Month',
                            font: { size: 12, weight: 'bold' }
                        }
                    }
                }
            }
        });
        window.ridersSlabCharts = window.ridersSlabCharts || {};
        window.ridersSlabCharts.total = totalChart;
    }
}, 100);

// Riders Slab Increased/Decreased Charts + Slicer
setTimeout(function() {
    if (typeof Chart === 'undefined') return;

    function parseSlabTable(tableEl) {
        if (!tableEl) return null;
        const headerCells = Array.from(tableEl.querySelectorAll('thead th'));
        const datasetLabels = headerCells.slice(1, -1).map(th => th.textContent.trim());
        const rows = Array.from(tableEl.querySelectorAll('tbody tr'));
        const labels = [];
        const totals = [];
        const series = datasetLabels.map(() => []);

        function firstInt(text) {
            const m = String(text || '').match(/-?\d+/);
            return m ? parseInt(m[0], 10) : 0;
        }

        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            if (!cells.length) return;
            labels.push(cells[0].textContent.trim());
            const totalCell = cells[cells.length - 1];
            const totalVal = firstInt(totalCell.textContent);
            totals.push(totalVal);
            datasetLabels.forEach((_, i) => {
                const cell = cells[i + 1];
                const val = firstInt(cell ? cell.textContent : '');
                series[i].push(val);
            });
        });

        return { labels, datasetLabels, series, totals };
    }

    function buildSlabChart(canvasId, parsed, colors) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !parsed) return null;

        const datasets = parsed.datasetLabels.map((label, i) => ({
            label,
            data: parsed.series[i],
            borderColor: colors[i % colors.length],
            backgroundColor: 'rgba(0,0,0,0)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: colors[i % colors.length],
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }));

        return new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { labels: parsed.labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 11 }, padding: 10, boxWidth: 12, usePointStyle: true }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const total = parsed.totals[idx] || 0;
                                const value = context.parsed.y || 0;
                                const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${context.dataset.label}: ${value} (${pct}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: { size: 9, weight: 'bold' },
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        clamp: true,
                        clip: false,
                        formatter: function(value, context) {
                            const idx = context.dataIndex;
                            const total = parsed.totals[idx] || 0;
                            const raw = (context.parsed && context.parsed.y !== undefined) ? context.parsed.y : value;
                            const val = Number.isFinite(Number(raw)) ? Number(raw) : 0;
                            const pct = total ? ((val / total) * 100).toFixed(1) : '0.0';
                            return val + '\n(' + pct + '%)';
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 11 } },
                        title: { display: true, text: 'Number of Partners', font: { size: 12, weight: 'bold' } }
                    },
                    x: {
                        ticks: { font: { size: 11 } },
                        title: { display: true, text: 'Month', font: { size: 12, weight: 'bold' } }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    const colors = ['#dc2626', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#06b6d4', '#6366f1'];
    const incTable = document.querySelector('#increasedTableContainer table');
    const decTable = document.querySelector('#decreasedTableContainer table');
    const incParsed = parseSlabTable(incTable);
    const decParsed = parseSlabTable(decTable);

    window.ridersSlabCharts = window.ridersSlabCharts || {};
    window.ridersSlabCharts.increased = buildSlabChart('ridersSlabIncreasedChart', incParsed, colors);
    window.ridersSlabCharts.decreased = buildSlabChart('ridersSlabDecreasedChart', decParsed, colors);

    const buttons = Array.from(document.querySelectorAll('.slab-slicer-btn[data-target="ridersSlab"]'));
    function apply(view) {
        const total = document.getElementById('ridersSlabPanelTotal');
        const inc = document.getElementById('ridersSlabPanelIncreased');
        const dec = document.getElementById('ridersSlabPanelDecreased');
        if (total) total.style.display = (view === 'total') ? 'block' : 'none';
        if (inc) inc.style.display = (view === 'increased') ? 'block' : 'none';
        if (dec) dec.style.display = (view === 'decreased') ? 'block' : 'none';
        buttons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
        if (window.ridersSlabCharts) {
            // Only resize charts that are currently visible
            Object.values(window.ridersSlabCharts).forEach(c => { try { if (c && c.canvas && c.canvas.offsetParent) c.resize(); } catch(e) {} });
        }
    }

    buttons.forEach(b => b.addEventListener('click', function() { apply(this.dataset.view); }));
    const defaultBtn = buttons.find(b => b.classList.contains('active')) || buttons[0];
    if (defaultBtn) apply(defaultBtn.dataset.view || 'total');
}, 140);
</script>

<!-- INCREASED TARGET BY RIDERS SLAB -->
<div class="chart-container" id="ridersSlabPanelIncreased" style="margin-top: 30px; display: none;">
<h3 class="chart-title">Partners with Increased Target by Riders Slab Distribution</h3>
<p data-i18n-html="desc-slabincr" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Number of partners who increased their targets, categorized by rider count range. Shows growth momentum across different partner sizes.</p>

<div style="position: relative; width: 100%; height: 350px; margin: 5px 0 20px 0;">
<canvas id="ridersSlabIncreasedChart"></canvas>
</div>

<div style="margin-top: 15px;">
<button id="toggleIncreasedTable" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">▶ Show Table Details</button>
</div>
<div id="increasedTableContainer" class="table-container compact-table nowrap-table" style="margin: 10px 0 0 0; max-height: 350px; overflow-y: auto; display: none;">
<table class="slab-table-increased" style="width: 100%; border-collapse: collapse; font-size: 12px;">
<thead style="position: sticky; top: 0; background: #059669; z-index: 10;">
<tr style="color: white;">
<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Month</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=1 - &lt;20</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=20 - &lt;30</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=30 - &lt;50</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=50 - &lt;80</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=80 - &lt;100</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=100 - &lt;150</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=150 - &lt;200</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=200 - &lt;300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">>=300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #047857;">Total</th>
</tr>
</thead>
<tbody>
<tr style="background: #f0fdf4;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Sep</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">171 (44.9%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">99 (26.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">77 (20.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">26 (6.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">4 (1.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">3 (0.8%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.3%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">381</td>
</tr>
<tr style="background: #f0fdf4;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Oct</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">238 (69.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">47 (13.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">43 (12.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">11 (3.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (0.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">341</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Nov</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">282 (73.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">64 (16.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">31 (8.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">8 (2.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.3%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">386</td>
</tr>
<tr style="background: #f0fdf4;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Dec</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">85 (70.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">21 (17.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">12 (10.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">2 (1.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">120</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Jan</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">200 (94.3%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">8 (3.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">3 (1.4%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">1 (0.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">212</td></td>
</tr>
<tr style="background: #f0fdf4;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Feb</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">139 (90.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">12 (7.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #059669; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">1 (0.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #0284c7; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">1 (0.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #d1fae5;">153</td>
</tr>
</tbody>
</table>
</div>
</div>

<script>
document.getElementById('toggleIncreasedTable').addEventListener('click', function() {
    const container = document.getElementById('increasedTableContainer');
    const btn = this;
    if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '▼ Hide Table Details';
    } else {
        container.style.display = 'none';
        btn.textContent = '▶ Show Table Details';
    }
});
</script>

<!-- DECREASED TARGET BY RIDERS SLAB -->
<div class="chart-container" id="ridersSlabPanelDecreased" style="margin-top: 30px; display: none;">
<h3 class="chart-title">Partners with Decreased Target by Riders Slab Distribution</h3>
<p data-i18n-html="desc-slabdecr" style="color: #6b7280; font-size: 12px; margin: 5px 0 10px 0; font-style: italic;">Number of partners who decreased their targets, categorized by rider count range. Identifies areas requiring attention and support.</p>

<div style="position: relative; width: 100%; height: 350px; margin: 5px 0 20px 0;">
<canvas id="ridersSlabDecreasedChart"></canvas>
</div>

<div style="margin-top: 15px;">
<button id="toggleDecreasedTable" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">▶ Show Table Details</button>
</div>
<div id="decreasedTableContainer" class="table-container compact-table nowrap-table" style="margin: 10px 0 0 0; max-height: 350px; overflow-y: auto; display: none;">
<table class="slab-table-decreased" style="width: 100%; border-collapse: collapse; font-size: 12px;">
<thead style="position: sticky; top: 0; background: #dc2626; z-index: 10;">
<tr style="color: white;">
<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Month</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;0 &amp; &gt;-20</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-20 &amp; &gt;-30</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-30 &amp; &gt;-50</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=50 &amp; &gt;-80</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-80 &amp; &gt;-100</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-100 &amp; &gt;-150</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-150 &amp; &gt;-200</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-200 &amp; &gt;-300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">&lt;=-300</th>
<th style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #b91c1c;">Total</th>
</tr>
</thead>
<tbody>
<tr style="background: #fef2f2;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Sep</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">88 (71.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">17 (13.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">12 (9.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (1.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (1.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (1.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.8%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">124</td>
</tr>
<tr style="background: #fef2f2;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Oct</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">127 (78.4%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">17 (10.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">10 (6.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">4 (2.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.6%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (1.2%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">162</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Nov</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">145 (77.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">22 (11.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">9 (4.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">9 (4.8%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.5%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">188</td>
</tr>
<tr style="background: #fef2f2;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Dec</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">317 (69.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">65 (14.2%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">41 (9.0%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #fb923c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">21 (4.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">6 (1.3%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">4 (0.9%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">2 (0.4%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.2%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.2%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">458</td>
</tr>
<tr style="background: #ffffff;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Jan</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">221 (92.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">11 (4.6%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">6 (2.5%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.4%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.4%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">240</td>
</tr>
<tr style="background: #fef2f2;">
<td style="padding: 8px; border: 1px solid #ddd; font-weight: 700;">Feb</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">255 (89.8%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #ea580c; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">19 (6.7%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span style="background: #f97316; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">6 (2.1%)</span></td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">3 (1.1%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">1 (0.4%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">0 (0.0%)</td>
<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 700; background: #fecaca;">284</td>
</tr>
</tbody>
</table>
</div>
</div>

<script>
document.getElementById('toggleDecreasedTable').addEventListener('click', function() {
    const container = document.getElementById('decreasedTableContainer');
    const btn = this;
    if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = '▼ Hide Table Details';
    } else {
        container.style.display = 'none';
        btn.textContent = '▶ Show Table Details';
    }
});
</script>

</div>

<!-- Key Insights -->
<div class="highlight-box" style="margin-top: 30px;">
<h3 style="color: #1f4e78; margin-bottom: 15px;">💡 Key Insights &amp; Takeaways</h3>
<div data-i18n-html="willingness-key-insights">
<p style="margin-bottom: 12px; line-height: 1.6;">
<strong>📈 Overall Trend:</strong> Partner willingness started at 37.4% in October (213 willing partners), 
                            improved in November (40.5%, 259 partners), but plummeted in December to the lowest point at 12.8% (81 willing partners). 
                            January showed strong recovery to 32.7% (201 partners), but February declined again to 24.6% (130 partners), indicating fluctuating engagement patterns.
                        </p>
<p style="margin-bottom: 12px; line-height: 1.6;">
<strong>🎯 Best Performance:</strong> November demonstrated the highest willingness rate at 40.5%, with 259 out of 640 
                            sub-total partners willing to increase targets. October followed with 37.4% willingness (213 partners).
                        </p>
<p style="margin-bottom: 12px; line-height: 1.6;">
<strong>⚠️ December Challenge:</strong> December saw the most dramatic drop with only 12.8% willingness (81 partners), 
                            and 554 partners (87.2%) not willing to increase targets. This represents the most significant resistance to growth 
                            observed across all months.
                        </p>
<p style="margin-bottom: 12px; line-height: 1.6;">
<strong>🔥 January Recovery &amp; February Decline:</strong> January demonstrated a remarkable 20% recovery jump to 32.7% willingness (201 partners), rising from December's 12.8% low. 
                            However, February declined to 24.6% (130 partners willing out of 528 sub-total), showing continued volatility in partner engagement.
                        </p>
<p style="margin-bottom: 12px; line-height: 1.6;">
<strong>📊 Partner Base Dynamics:</strong> Total partners contracted from peak of 767 (November) to 551 (February), representing significant portfolio consolidation. 
                            Average willingness across Oct-Feb was 30.0% for willing partners vs 70.0% not-willing, showing persistent engagement challenges.
                        </p>
<p style="margin-bottom: 0; line-height: 1.6;">
<strong>💼 Strategic Recommendation:</strong> Address the February decline by implementing targeted retention and growth incentives. The fluctuation between January's recovery and February's drop suggests 
                            partners respond inconsistently to interventions. Focus on sustaining engagement momentum while addressing root causes of the repeated declines.
                        </p>
</div>
</div>
<!-- JANUARY SUCCESS METRICS TABLE -->
</div>
<!-- TARGET ADJUSTMENT ANALYSIS TAB -->
<!-- EXECUTIVE SUMMARY TAB -->

<!-- FUTURE STRATEGY & ROADMAP TAB -->

</div>
<!-- TARGET ADJUSTMENT ANALYSIS TAB - COMPLETELY REBUILT -->
<div class="tab-content" id="adjustment">
<h2 style="margin-bottom: 25px; color: #1f4e78; font-size: 26px;">🔧 Target Adjustment Analysis - February 2026</h2>
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; margin-bottom: 30px; color: white;">
<h3 style="color: white; font-size: 22px; margin-bottom: 15px;">📊 Strategic Capacity Reduction via Manual Adjustments</h3>
<p style="font-size: 15px; line-height: 1.8; margin: 0;">
This analysis examines manual target adjustments for February 2026. <strong>61 partners received manual adjustments</strong>, resulting in strategic capacity reduction: net <span style="color: #fca5a5;">-173 riders (-8.6%)</span> through +423 additions and -596 reductions. Primary drivers: driver card compliance issues and capacity rebalancing. <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px;">MoM: Partners <span style="color: #fca5a5;">↓50.4%</span> (123→61)</span>
</p>
</div>
<!-- KPI Cards -->
<div class="kpi-grid">
<div class="kpi-card">
<div class="kpi-header">
<span class="kpi-title">Total Partners</span>
<span class="kpi-icon">👥</span>
</div>
<div class="kpi-value">61</div>
<div class="kpi-subtitle">MoM: <span style="color: #dc2626;">↓50.4%</span> (was 123)</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">Given Target</span>
<span class="kpi-icon">📋</span>
</div>
<div class="kpi-value">2,012</div>
<div class="kpi-subtitle">MoM: <span style="color: #dc2626;">↓52.3%</span> (was 4,221)</div>
</div>
<div class="kpi-card danger">
<div class="kpi-header">
<span class="kpi-title">Adjusted Target</span>
<span class="kpi-icon">📉</span>
</div>
<div class="kpi-value">1,839</div>
<div class="kpi-subtitle negative">-173 (-8.6%)</div>
</div>
<div class="kpi-card warning">
<div class="kpi-header">
<span class="kpi-title">Adjustments (Total capacity moved)</span>
<span class="kpi-icon">🔄</span>
</div>
<div class="kpi-value">1,019</div>
<div class="kpi-subtitle">MoM: <span style="color: #dc2626;">↓47.7%</span> (was ±1,949)</div>
</div>
</div>
<!-- TOTAL CAPACITY MOVED EXPLANATION -->
<div style="background: #fee2e2; border-left: 3px solid #dc2626; border-radius: 6px; padding: 10px 15px; margin-bottom: 20px; font-size: 12px;">
<p style="margin: 0; color: #991b1b; line-height: 1.5;">
<strong style="font-size: 12px;">💡 Total Capacity Moved (1,019):</strong> 
<span style="color: #16a34a;">Total Additions: 423</span> • <span style="color: #dc2626;">Total Reductions: 596</span> • Total: 423 + 596 = 1,019 • Net: <strong>-173 riders</strong>. 
<em>This represents strategic capacity reduction with focus on driver card compliance.</em> <span style="background: rgba(220,38,38,0.1); padding: 2px 6px; border-radius: 4px;">MoM: ↓49.8% capacity movement</span>
</p>
</div>
<!-- GIVEN VS ADJUSTED DEEP DIVE -->
<h3 style="margin: 40px 0 20px; color: #1f4e78; font-size: 22px;">📊 Given Target vs Adjusted Target - Deep Dive</h3>
<div style="background: white; border: 3px solid #3b82f6; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
<h4 style="color: #1e40af; margin-bottom: 20px; font-size: 18px;">🎯 Target Allocation Comparison</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 25px;">
<div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px;">
<div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">GIVEN TARGET (BEFORE)</div>
<div style="font-size: 32px; font-weight: 700; color: #1e40af; margin-bottom: 8px;">2,012</div>
<div style="font-size: 13px; color: #64748b;">Algorithmic allocation</div>
<div style="font-size: 13px; color: #64748b;">Average: 33.0 per partner</div>
<div style="font-size: 12px; margin-top: 6px;"><span style="color: #dc2626;">↓52.3%</span> vs Jan (4,221)</div>
</div>
<div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 20px; border-radius: 8px;">
<div style="font-size: 14px; color: #dc2626; font-weight: 600; margin-bottom: 8px;">ADJUSTED TARGET (AFTER)</div>
<div style="font-size: 32px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">1,839</div>
<div style="font-size: 13px; color: #64748b;">Manual adjustment</div>
<div style="font-size: 13px; color: #64748b;">Average: 30.1 per partner</div>
<div style="font-size: 12px; margin-top: 6px;"><span style="color: #dc2626;">↓56.7%</span> vs Jan (4,246)</div>
</div>
<div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 20px; border-radius: 8px;">
<div style="font-size: 14px; color: #dc2626; font-weight: 600; margin-bottom: 8px;">NET CHANGE</div>
<div style="font-size: 32px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">-173</div>
<div style="font-size: 13px; color: #64748b;">-8.6% overall</div>
<div style="font-size: 13px; color: #64748b;">+423 added / -596 removed</div>
<div style="font-size: 12px; margin-top: 6px;"><span style="color: #dc2626;">↓792%</span> vs Jan (+25)</div>
</div>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Change Direction</th>
<th># Of Partners with adjustment</th>
<th>% of Total</th>
<th>Total Capacity Moved</th>
<th>Avg Change per Partner</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr style="background: #d1fae5;">
<td><strong>📈 Target Increases</strong></td>
<td style="font-size: 18px; font-weight: 600;">27</td>
<td style="color: #10b981; font-weight: 600;">44.3%</td>
<td style="color: #10b981; font-weight: 600;">+423 riders</td>
<td style="color: #10b981;">+15.7 riders</td>
<td>🟢 Capacity Addition</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>📉 Target Decreases</strong></td>
<td style="font-size: 18px; font-weight: 600;">34</td>
<td style="color: #dc2626; font-weight: 600;">55.7%</td>
<td style="color: #dc2626; font-weight: 600;">-596 riders</td>
<td style="color: #dc2626;">-17.5 riders</td>
<td>🔴 Capacity Reduction</td>
</tr>
<tr style="background: #e5e7eb;">
<td><strong>➡️ No Change</strong></td>
<td style="font-size: 18px; font-weight: 600;">0</td>
<td>0%</td>
<td>0 riders</td>
<td>-</td>
<td>⚪ Kept Original</td>
</tr>
<tr style="background: #fee2e2; font-weight: bold;">
<td>Total/Net</td>
<td>61</td>
<td>100%</td>
<td style="color: #dc2626; font-weight: 700;">-173 riders</td>
<td style="color: #dc2626;">-2.8 avg</td>
<td>🔴 Net Reduction</td>
</tr>
</tbody>
</table>
</div>
</div>
<div style="background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 8px; padding: 15px; margin-bottom: 30px;">
<p style="color: #991b1b; margin: 0; font-size: 14px;"><strong>💡 KEY INSIGHT:</strong> February shows <strong>net capacity reduction (-8.6%)</strong> vs January's slight increase (+0.6%). More partners received decreases (55.7%) than increases (44.3%), with driver card compliance being the primary factor. <span style="background: rgba(220,38,38,0.1); padding: 2px 6px; border-radius: 4px;">MoM: Shift from +25 to -173 net change</span></p>
</div>
<!-- REASON CATEGORIES - BIG HIGHLIGHTED TABLES -->
<h3 style="margin: 40px 0 20px; color: #1f4e78; font-size: 22px;">🎯 ADJUSTMENT REASON CLASSIFICATION</h3>
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 25px; margin-bottom: 25px; color: white;">
<h4 style="color: white; margin-bottom: 15px; font-size: 18px;">📋 Categorized Adjustment Reasons (PMM Comments Analysis)</h4>
<p style="font-size: 14px; line-height: 1.6; margin: 0;">Partners categorized into 12 distinct reason categories based on detailed analysis of PMM adjustment comments. This classification reveals operational gaps, performance patterns, and strategic priorities.</p>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="width: 50px;">Rank</th>
<th>Reason Category</th>
<th>Partners</th>
<th>% of Total</th>
<th>Typical Action</th>
<th>Priority Level</th>
</tr>
</thead>
<tbody>
<tr style="background: #fee2e2;">
<td><strong>1</strong></td>
<td><strong>Driver Card Issues (Low/No Cards)</strong></td>
<td style="font-size: 20px; font-weight: 700; color: #dc2626;">23</td>
<td style="font-size: 18px; font-weight: 700; color: #dc2626;">37.7%</td>
<td>⬇️⬇️ Heavy Reduction</td>
<td><span style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🔴 CRITICAL</span></td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>2</strong></td>
<td><strong>FR/Performance Non-Compliance</strong></td>
<td style="font-size: 20px; font-weight: 700; color: #dc2626;">8</td>
<td style="font-size: 18px; font-weight: 700; color: #dc2626;">13.1%</td>
<td>⬇️⬇️ Target Cut</td>
<td><span style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🔴 COMPLIANCE</span></td>
</tr>
<tr style="background: #fef3c7;">
<td><strong>3</strong></td>
<td><strong>2% Buffer/Demand Gap Coverage</strong></td>
<td style="font-size: 18px; font-weight: 600;">7</td>
<td style="font-size: 16px; font-weight: 600;">11.5%</td>
<td>⬆️ Capacity Buffer</td>
<td><span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🟡 STRATEGIC</span></td>
</tr>
<tr style="background: #e0f2fe;">
<td><strong>4</strong></td>
<td><strong>New Partner Onboarding</strong></td>
<td style="font-size: 16px; font-weight: 600;">5</td>
<td>8.2%</td>
<td>🆕 Initial Setup</td>
<td><span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🔵 SUPPORT</span></td>
</tr>
<tr style="background: #d1fae5;">
<td><strong>5</strong></td>
<td><strong>Capacity Transfer/Redistribution</strong></td>
<td style="font-size: 16px; font-weight: 600;">4</td>
<td>6.6%</td>
<td>↔️ Transfer to capable</td>
<td><span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🟢 REBALANCE</span></td>
</tr>
<tr style="background: #fef3c7;">
<td><strong>6</strong></td>
<td><strong>High Performance Reward</strong></td>
<td style="font-size: 16px; font-weight: 600;">3</td>
<td>4.9%</td>
<td>⬆️ Capacity Increase</td>
<td><span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">🟢 REWARD</span></td>
</tr>
<tr>
<td><strong>7</strong></td>
<td><strong>Partner Inability to Fulfill</strong></td>
<td>2</td>
<td>3.3%</td>
<td>⬇️ Reduce Target</td>
<td>🟠 REVIEW</td>
</tr>
<tr>
<td><strong>8</strong></td>
<td><strong>City Capacity Need</strong></td>
<td>2</td>
<td>3.3%</td>
<td>⬆️ Fill Gap</td>
<td>🔵 STRATEGIC</td>
</tr>
<tr style="background: #e5e7eb;">
<td><strong>9</strong></td>
<td><strong>Other/Mixed Reasons</strong></td>
<td style="font-size: 16px; font-weight: 600;">7</td>
<td>11.5%</td>
<td>🔄 Varied</td>
<td><span style="background: #6b7280; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">⚪ MIXED</span></td>
</tr>
<tr style="background: #1f2937; color: white; font-weight: bold;">
<td colspan="2">TOTAL</td>
<td>61</td>
<td>100.0%</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
<!-- Critical Findings Boxes -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
<div style="background: #fee2e2; border-left: 6px solid #dc2626; border-radius: 12px; padding: 20px;">
<h4 style="color: #991b1b; margin-bottom: 12px; font-size: 16px;">🚨 TOP REDUCTION REASON</h4>
<div style="font-size: 36px; font-weight: 700; color: #dc2626; margin: 10px 0;">50.8%</div>
<p style="color: #7f1d1d; font-size: 13px; margin: 0; line-height: 1.6;">
<strong>31 partners reduced</strong> for driver card issues (37.7%) and FR/performance non-compliance (13.1%). Driver card availability is the #1 adjustment driver in February.
</p>
</div>
<div style="background: #fef3c7; border-left: 6px solid #f59e0b; border-radius: 12px; padding: 20px;">
<h4 style="color: #92400e; margin-bottom: 12px; font-size: 16px;">📊 STRATEGIC ALLOCATIONS</h4>
<div style="font-size: 36px; font-weight: 700; color: #f59e0b; margin: 10px 0;">26.2%</div>
<p style="color: #78350f; font-size: 13px; margin: 0; line-height: 1.6;">
<strong>16 partners</strong> adjusted for strategic reasons: 2% buffer (7), new partner support (5), and capacity transfer (4). Focus on demand coverage and redistribution.
</p>
</div>
</div>
<div style="background: #fee2e2; border-left: 6px solid #dc2626; border-radius: 12px; padding: 20px; margin-top: 20px;">
<h4 style="color: #991b1b; margin-bottom: 12px; font-size: 16px;">🚗 Driver Card Compliance Crisis</h4>
<p style="color: #991b1b; font-size: 14px; margin: 0; line-height: 1.8;">
February shows <strong>driver card issues as the dominant factor</strong> affecting 50.8% of all adjustments (31 partners). This represents a significant shift from January's performance-based adjustments. <span style="background: rgba(220,38,38,0.15); padding: 2px 6px; border-radius: 4px;">MoM: Driver card issues now primary driver vs performance penalties</span>
</p>
</div>

<!-- CITY-LEVEL ANALYSIS -->
<h3 style="margin: 40px 0 20px; color: #1f4e78; font-size: 20px;">🏙️ City-Level Adjustment Analysis</h3>
<div class="table-container">
<table class="compact-table">
<thead>
<tr>
<th>City</th>
<th>Partners</th>
<th>Given Target</th>
<th>Adjusted Target</th>
<th>Net Change</th>
<th>Avg Change</th>
<th>Increases</th>
<th>Decreases</th>
<th>% Change</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr style="background: #fee2e2;">
<td><strong>Riyadh</strong></td>
<td>40</td>
<td>1,769</td>
<td>1,620</td>
<td class="negative" style="font-size: 16px; font-weight: 700;">-149</td>
<td class="negative">-3.7</td>
<td>14</td>
<td style="font-weight: 600;">25</td>
<td class="negative" style="font-weight: 600;">-8.4%</td>
<td>🔴 Major Reduction</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>Jeddah</strong></td>
<td>8</td>
<td>119</td>
<td>0</td>
<td class="negative" style="font-size: 16px; font-weight: 700;">-119</td>
<td class="negative">-14.9</td>
<td>0</td>
<td style="font-weight: 600;">8</td>
<td class="negative" style="font-weight: 600;">-100%</td>
<td>🔴 Complete Removal</td>
</tr>
<tr style="background: #d1fae5;">
<td>Tabuk</td>
<td>2</td>
<td>45</td>
<td>50</td>
<td class="positive">+5</td>
<td class="positive">+2.5</td>
<td style="font-weight: 600;">2</td>
<td>0</td>
<td class="positive">+11.1%</td>
<td>🟢 Growth</td>
</tr>
<tr style="background: #d1fae5;">
<td>Taif</td>
<td>4</td>
<td>35</td>
<td>45</td>
<td class="positive">+10</td>
<td class="positive">+2.5</td>
<td style="font-weight: 600;">3</td>
<td>1</td>
<td class="positive">+28.6%</td>
<td>🟢 Growth</td>
</tr>
<tr style="background: #fef9c3;">
<td>Makkah</td>
<td>2</td>
<td>44</td>
<td>44</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0%</td>
<td>⚪ Balanced</td>
</tr>
<tr style="background: #d1fae5;">
<td>Madinah</td>
<td>2</td>
<td>0</td>
<td>29</td>
<td class="positive" style="font-weight: 600;">+29</td>
<td class="positive">+14.5</td>
<td style="font-weight: 600;">2</td>
<td>0</td>
<td class="positive" style="font-weight: 600;">N/A</td>
<td>🟢 New Activation</td>
</tr>
<tr style="background: #d1fae5;">
<td>Jubail</td>
<td>1</td>
<td>0</td>
<td>25</td>
<td class="positive" style="font-weight: 600;">+25</td>
<td class="positive">+25.0</td>
<td style="font-weight: 600;">1</td>
<td>0</td>
<td class="positive" style="font-weight: 600;">N/A</td>
<td>🟢 New Activation</td>
</tr>
<tr style="background: #d1fae5;">
<td>Al Ahsa</td>
<td>1</td>
<td>0</td>
<td>16</td>
<td class="positive">+16</td>
<td class="positive">+16.0</td>
<td style="font-weight: 600;">1</td>
<td>0</td>
<td class="positive">N/A</td>
<td>🟢 New Activation</td>
</tr>
<tr style="background: #d1fae5;">
<td>Jazan</td>
<td>1</td>
<td>0</td>
<td>10</td>
<td class="positive">+10</td>
<td class="positive">+10.0</td>
<td style="font-weight: 600;">1</td>
<td>0</td>
<td class="positive">N/A</td>
<td>🟢 New Activation</td>
</tr>
<tr style="background: #fee2e2; font-weight: bold;">
<td>TOTAL</td>
<td>61</td>
<td>2,012</td>
<td>1,839</td>
<td class="negative">-173</td>
<td class="negative">-2.8</td>
<td>27</td>
<td>34</td>
<td class="negative">-8.6%</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
<div style="background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 8px; padding: 15px; margin-top: 20px;">
<p style="color: #991b1b; margin: 0; font-size: 14px;"><strong>🔍 Key City Insights:</strong> Riyadh accounts for 65.6% of all adjusted partners (40/61) with net <span style="color: #dc2626; font-weight: 600;">-149 riders (-8.4%)</span>. Jeddah saw complete removal (-119, -100%) of all 8 partners' targets. New city activations: Madinah (+29), Jubail (+25), Al Ahsa (+16), Jazan (+10). <span style="background: rgba(220,38,38,0.1); padding: 2px 6px; border-radius: 4px;">MoM: Significant reduction vs Jan's +18 net in Riyadh</span></p>
</div>
<div class="chart-container" style="margin-top: 30px;">
<h3 class="chart-title">City-Level Target Changes (Top Cities)</h3>
<canvas id="adjustmentCityChart"></canvas>
</div>
<!-- PERFORMANCE IMPACT ANALYSIS -->
<h3 style="margin: 40px 0 20px; color: #1f4e78; font-size: 20px;">📊 Performance Impact Analysis</h3>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
<div style="background: #0f172a; color: white; border-radius: 10px; padding: 12px 14px;">
<div style="font-size: 11px; color: #cbd5f5;">Net Change</div>
<div style="font-size: 18px; font-weight: 700;">-173</div>
<div style="font-size: 11px; color: #fca5a5;">-8.6% vs Jan</div>
</div>
<div style="background: #0b3b2e; color: white; border-radius: 10px; padding: 12px 14px;">
<div style="font-size: 11px; color: #bbf7d0;">Capacity Moved</div>
<div style="font-size: 18px; font-weight: 700;">1,019</div>
<div style="font-size: 11px; color: #fca5a5;">-47.7% vs Jan</div>
</div>
<div style="background: #3f1d0f; color: white; border-radius: 10px; padding: 12px 14px;">
<div style="font-size: 11px; color: #fed7aa;">Driver Card 0-50%</div>
<div style="font-size: 18px; font-weight: 700;">-280 net</div>
<div style="font-size: 11px; color: #fde68a;">44 partners impacted</div>
</div>
<div style="background: #1e293b; color: white; border-radius: 10px; padding: 12px 14px;">
<div style="font-size: 11px; color: #cbd5e1;">High FR (80-100%)</div>
<div style="font-size: 18px; font-weight: 700;">-322 net</div>
<div style="font-size: 11px; color: #fca5a5;">Primary reduction pool</div>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
<!-- Quarterly Performance -->
<div style="background: white; border: 2px solid #cbd5e1; border-radius: 12px; padding: 20px;">
<h4 style="color: #1f4e78; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; justify-content: space-between;">
<span>📅 Quarterly Performance Impact</span>
<svg width="68" height="18" viewBox="0 0 68 18" aria-hidden="true">
<polyline fill="none" stroke="#64748b" stroke-width="2" points="2,6 22,4 44,10 66,14" />
</svg>
</h4>
<div class="table-container">
<table style="font-size: 12px;">
<thead>
<tr>
<th>Performance</th>
<th>Partners</th>
<th>Given</th>
<th>Adjusted</th>
<th>Net (Vs Jan)</th>
<th>Avg</th>
</tr>
</thead>
<tbody>
<tr style="background: #d1fae5;">
<td><strong>Good</strong></td>
<td>43</td>
<td>1,615</td>
<td>1,267</td>
<td class="negative">-348<div style="font-size: 11px; color: #64748b;">Jan -431 | <span style="color: #16a34a;">MoM +19.3% ^</span></div></td>
<td class="negative">-8.1</td>
</tr>
<tr style="background: #fef3c7;">
<td><strong>Average</strong></td>
<td>47</td>
<td>277</td>
<td>247</td>
<td class="negative">-30<div style="font-size: 11px; color: #64748b;">Jan -61 | <span style="color: #16a34a;">MoM +50.8% ^</span></div></td>
<td class="negative">-0.6</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>Bad</strong></td>
<td>25</td>
<td>32</td>
<td>149</td>
<td class="positive">+117<div style="font-size: 11px; color: #64748b;">Jan +322 | <span style="color: #dc2626;">MoM -63.7% v</span></div></td>
<td class="positive">+4.7</td>
</tr>
</tbody>
</table>
</div>
<p style="font-size: 11px; color: #64748b; margin-top: 10px;">⚠️ "Bad" partners remain positive (+117) but below Jan (+322). Good partners improved vs Jan, yet remain net negative.</p>
</div>
<!-- New vs Old -->
<div style="background: white; border: 2px solid #cbd5e1; border-radius: 12px; padding: 20px;">
<h4 style="color: #1f4e78; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; justify-content: space-between;">
<span>🆕 New vs Old Partners</span>
<svg width="68" height="18" viewBox="0 0 68 18" aria-hidden="true">
<polyline fill="none" stroke="#64748b" stroke-width="2" points="2,12 22,10 44,6 66,8" />
</svg>
</h4>
<div class="table-container">
<table style="font-size: 12px;">
<thead>
<tr>
<th>Type</th>
<th>Partners</th>
<th>Given</th>
<th>Adjusted</th>
<th>Net (Vs Jan)</th>
<th>Avg</th>
</tr>
</thead>
<tbody>
<tr style="background: #d1fae5;">
<td><strong>New</strong></td>
<td>13</td>
<td>133</td>
<td>188</td>
<td class="positive">+55<div style="font-size: 11px; color: #64748b;">Jan +149 | <span style="color: #dc2626;">MoM -63.1% v</span></div></td>
<td class="positive">+4.2</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>Old</strong></td>
<td>40</td>
<td>1,801</td>
<td>1,490</td>
<td class="negative">-311<div style="font-size: 11px; color: #64748b;">Jan -319 | <span style="color: #16a34a;">MoM +2.5% ^</span></div></td>
<td class="negative">-7.8</td>
</tr>
</tbody>
</table>
</div>
<p style="font-size: 11px; color: #64748b; margin-top: 10px;">📊 New partner support reduced vs Jan (+55 vs +149). Old partner reductions remain large (-311 vs -319).</p>
</div>
<!-- FR Rate Impact -->
<div style="background: white; border: 2px solid #cbd5e1; border-radius: 12px; padding: 20px;">
<h4 style="color: #1f4e78; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; justify-content: space-between;">
<span>📸 FR Rate Impact</span>
<svg width="68" height="18" viewBox="0 0 68 18" aria-hidden="true">
<polyline fill="none" stroke="#64748b" stroke-width="2" points="2,10 22,14 44,6 66,12" />
</svg>
</h4>
<div class="table-container">
<table style="font-size: 12px;">
<thead>
<tr>
<th>FR Range</th>
<th>Partners</th>
<th>Given</th>
<th>Adjusted</th>
<th>Net (Vs Jan)</th>
<th>Avg</th>
</tr>
</thead>
<tbody>
<tr style="background: #d1fae5;">
<td><strong>0-30%</strong></td>
<td>1</td>
<td>10</td>
<td>15</td>
<td class="positive">+5<div style="font-size: 11px; color: #64748b;">Jan +106 | <span style="color: #dc2626;">MoM -95.3% v</span></div></td>
<td class="positive">+5.0</td>
</tr>
<tr>
<td><strong>30-50%</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0<div style="font-size: 11px; color: #64748b;">Jan +39 | <span style="color: #dc2626;">MoM -100% v</span></div></td>
<td>0.0</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>50-70%</strong></td>
<td>3</td>
<td>22</td>
<td>11</td>
<td class="negative">-11<div style="font-size: 11px; color: #64748b;">Jan -144 | <span style="color: #16a34a;">MoM +92.4% ^</span></div></td>
<td class="negative">-3.7</td>
</tr>
<tr>
<td><strong>70-80%</strong></td>
<td>5</td>
<td>110</td>
<td>182</td>
<td class="positive">+72<div style="font-size: 11px; color: #64748b;">Jan -33 | <span style="color: #16a34a;">MoM +318.2% ^</span></div></td>
<td class="positive">+14.4</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>80-100%</strong></td>
<td>44</td>
<td>1,792</td>
<td>1,470</td>
<td class="negative">-322<div style="font-size: 11px; color: #64748b;">Jan -240 | <span style="color: #dc2626;">MoM -34.2% v</span></div></td>
<td class="negative">-7.3</td>
</tr>
<tr>
<td><strong>No FR rate</strong></td>
<td>8</td>
<td>78</td>
<td>161</td>
<td class="positive">+83<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="positive">+10.4</td>
</tr>
<tr style="background: #e5e7eb; font-weight: 700;">
<td>Total</td>
<td>61</td>
<td>2,012</td>
<td>1,839</td>
<td class="negative">-173<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-2.8</td>
</tr>
</tbody>
</table>
</div>
<p style="font-size: 11px; color: #64748b; margin-top: 10px;">High FR (80-100%) absorbed most cuts (-322 vs Jan -240). Mid-range 70-80% swung from -33 to +72.</p>
</div>
<!-- Driver Card Impact -->
<div style="background: white; border: 2px solid #cbd5e1; border-radius: 12px; padding: 20px;">
<h4 style="color: #1f4e78; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; justify-content: space-between;">
<span>🪪 Driver Card Impact</span>
<svg width="68" height="18" viewBox="0 0 68 18" aria-hidden="true">
<polyline fill="none" stroke="#64748b" stroke-width="2" points="2,8 22,10 44,12 66,6" />
</svg>
</h4>
<div class="table-container">
<table style="font-size: 12px;">
<thead>
<tr>
<th>Range</th>
<th>Partners</th>
<th>Given</th>
<th>Adjusted</th>
<th>Net (Vs Jan)</th>
<th>Avg</th>
</tr>
</thead>
<tbody>
<tr style="background: #fee2e2;">
<td><strong>0-10%</strong></td>
<td>28</td>
<td>898</td>
<td>746</td>
<td class="negative">-152<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-5.4</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>10-30%</strong></td>
<td>8</td>
<td>400</td>
<td>342</td>
<td class="negative">-58<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-7.3</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>30-50%</strong></td>
<td>8</td>
<td>326</td>
<td>256</td>
<td class="negative">-70<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-8.8</td>
</tr>
<tr style="background: #fee2e2;">
<td><strong>50-80%</strong></td>
<td>2</td>
<td>129</td>
<td>100</td>
<td class="negative">-29<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-14.5</td>
</tr>
<tr style="background: #d1fae5;">
<td><strong>80-100%</strong></td>
<td>7</td>
<td>181</td>
<td>234</td>
<td class="positive">+53<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="positive">+7.6</td>
</tr>
<tr>
<td><strong>No DC rate</strong></td>
<td>8</td>
<td>78</td>
<td>161</td>
<td class="positive">+83<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="positive">+10.4</td>
</tr>
<tr style="background: #e5e7eb; font-weight: 700;">
<td>Total</td>
<td>61</td>
<td>2,012</td>
<td>1,839</td>
<td class="negative">-173<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td class="negative">-2.8</td>
</tr>
</tbody>
</table>
</div>
<p style="font-size: 11px; color: #64748b; margin-top: 10px;">Driver card 0-50% accounts for -280 net across 44 partners. Jan values not provided for this table.</p>
</div>
</div>
<div style="background: #ede9fe; border-left: 6px solid #8b5cf6; border-radius: 12px; padding: 20px; margin-top: 20px;">
<h4 style="color: #6b21a8; margin-bottom: 12px; font-size: 16px;">🤔 Counterintuitive Findings Require Investigation</h4>
<div style="color: #6b21a8; font-size: 14px; line-height: 1.8;">
<p><strong>1. "Bad" Quarterly Performance Partners Still Receive Net Increases:</strong><br/>
25 partners classified as "Bad" received +117 net riders (+4.7 avg) while "Good" partners lost -348 net riders (-8.1 avg).</p>
<p><strong>2. FR vs Allocation Mismatch:</strong><br/>
High FR (80-100%) absorbed -322 net cuts while 70-80% gained +72 and No FR rate gained +83. This diverges from quality-first allocation.</p>
<p><strong>3. Driver Card Compliance Concentration:</strong><br/>
Partners with 0-50% driver card compliance account for -280 net change across 44 partners, outweighing any high-compliance gains.</p>
<p><strong>Possible Explanations:</strong><br/>
• Low-performance and low-FR partners may be new partners in ramp-up support programs<br/>
• High-performing partners could be over-allocated in January and corrected in February<br/>
• Driver card compliance gates may override performance metrics in manual adjustments<br/>
• Cross-referencing needed: Are "bad" partners also "new" and low driver card compliance?</p>
</div>
</div>
<!-- STRATEGIC INSIGHTS -->
<details id="strategic-insights" style="margin: 40px 0 20px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 14px; background: #f9fafb;">
<summary style="cursor: pointer; font-size: 20px; font-weight: 700; color: #1f4e78; display: flex; align-items: center; gap: 10px; list-style: none;">
<span id="insightsArrow" style="font-size: 18px; color: #1f4e78;">▶</span>
<span>💡 Strategic Insights &amp; Key Findings — click to expand/collapse</span>
</summary>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px; margin-bottom: 10px;">
<div style="background: white; border-left: 6px solid #dc2626; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #dc2626; margin-bottom: 15px; font-size: 16px;">1️⃣ Driver Card Compliance Crisis (37.7%)</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>23 of 61 partners adjusted</strong> due to driver card availability issues. This is the dominant factor in February, replacing January's performance-based adjustments. Represents a shift in operational priorities.
</p>
</div>
<div style="background: white; border-left: 6px solid #10b981; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #10b981; margin-bottom: 15px; font-size: 16px;">2️⃣ Significant Capacity Reduction (-8.6%)</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>Net change -173 riders (-8.6%)</strong> vs January's +25. 27 partners gained +423 riders, while 34 partners lost -596 riders. This reflects tighter capacity management and performance-based culling.
</p>
</div>
<div style="background: white; border-left: 6px solid #f59e0b; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #f59e0b; margin-bottom: 15px; font-size: 16px;">3️⃣ Compliance-Driven Adjustments (50.8%)</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>Driver card (37.7%) + FR/Performance (13.1%)</strong> = 50.8% of adjustments. Compliance is now the primary adjustment driver. Strategic allocations (buffer, new partner, capacity transfer) account for 26.2%.
</p>
</div>
<div style="background: white; border-left: 6px solid #8b5cf6; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #8b5cf6; margin-bottom: 15px; font-size: 16px;">4️⃣ City-Level Concentration</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>Riyadh: 40 partners (-149 net)</strong><br/>
<strong>Jeddah: 8 partners (-119 net)</strong><br/>
Two cities account for 78.7% of partners and most net reductions. Smaller cities (Tabuk, Taif, Madinah, Jubail, Al Ahsa, Jazan) showing positive net changes.
</p>
</div>
<div style="background: white; border-left: 6px solid #3b82f6; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #3b82f6; margin-bottom: 15px; font-size: 16px;">5️⃣ Old Partner Capacity Reduction</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>40 old partners received -311 net riders</strong> while 13 new partners gained +55 net riders. Established partners face stricter compliance enforcement while new partners receive support for ramp-up.
</p>
</div>
<div style="background: white; border-left: 6px solid #ec4899; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
<h4 style="color: #ec4899; margin-bottom: 15px; font-size: 16px;">6️⃣ Portfolio Streamlining</h4>
<p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0;">
<strong>50.4% fewer partners adjusted</strong> (61 vs 123 in January). Suggests either more focused intervention or reduced partner base. Average adjustment impact: -3.5 riders per partner vs +0.2 in January.
</p>
</div>
</div>
<!-- Collapsed additions: Recommendations + Executive Summary -->
<div style="background: #f0fdf4; border: 3px solid #10b981; border-radius: 12px; padding: 30px; margin-top: 16px;">
<h3 style="color: #065f46; font-size: 20px; margin-bottom: 20px;">🎯 Recommendations</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
<div>
<h4 style="color: #047857; margin-bottom: 12px; font-size: 15px;">📋 Process Improvements</h4>
<ol style="color: #065f46; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li><strong>Driver Card Program:</strong> Address the 37.7% driver card issue rate through partner education and support programs.</li>
<li><strong>Compliance Monitoring:</strong> Implement real-time driver card availability tracking to proactively address issues before target adjustments.</li>
<li><strong>FR% Improvement Program:</strong> Target the 13.1% FR/performance non-compliance with specific intervention plans.</li>
<li><strong>New Partner Onboarding:</strong> Continue supporting new partners (8.2%) with ramp-up programs while monitoring quality metrics.</li>
</ol>
</div>
<div>
<h4 style="color: #047857; margin-bottom: 12px; font-size: 15px;">🔧 Model Enhancements</h4>
<ol style="color: #065f46; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
<li><strong>Add Driver Card Gate:</strong> Integrate driver card availability as hard prerequisite before capacity allocation.</li>
<li><strong>FR% Thresholds:</strong> Set minimum FR% requirement for capacity maintenance (e.g., 50% minimum).</li>
<li><strong>City-Specific Parameters:</strong> Model Riyadh and Jeddah separately given their 78.7% share of adjustments.</li>
<li><strong>New Partner Protection:</strong> Add explicit "new partner ramp-up" period (3-6 months) with modified targets.</li>
<li><strong>2% Buffer Optimization:</strong> Review and potentially automate the 11.5% of 2% buffer adjustments.</li>
<li><strong>Capacity Transfer Rules:</strong> Formalize capacity transfer criteria to reduce manual interventions.</li>
</ol>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 30px; margin-top: 16px; color: white;">
<h3 style="color: white; font-size: 20px; margin-bottom: 15px;">📌 Executive Summary</h3>
<div style="font-size: 14px; line-height: 2.0;">
<p style="margin: 0;">• <strong>Driver card compliance crisis:</strong> 37.7% of adjustments (23 partners) due to driver card availability issues — now #1 driver</p>
<p style="margin: 0;">• <strong>Net -173 riders (-8.6%)</strong> vs January's +25: 27 partners +423, 34 partners -596 — significant capacity reduction</p>
<p style="margin: 0;">• <strong>50.8% compliance-driven</strong> adjustments (driver card 37.7% + FR/performance 13.1%) vs strategic allocations (26.2%)</p>
<p style="margin: 0;">• <strong>Old partners reduced:</strong> 40 old partners lost -311 net riders while 13 new partners gained +55 net</p>
<p style="margin: 0;">• <strong>Riyadh &amp; Jeddah dominate:</strong> 48 partners (78.7%), -268 combined net reduction</p>
<p style="margin: 0;">• <strong>Smaller cities positive:</strong> Tabuk +5, Taif +10, Madinah +29, Jubail +25, Al Ahsa +16, Jazan +10</p>
<p style="margin: 0;">• <strong>50.4% fewer partners adjusted</strong> (61 vs 123): More focused intervention or reduced partner base</p>
</div>
</div>
</details>
<!-- PMM Analysis -->
<details id="pmm-details" style="margin-top: 40px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb;">
<summary style="cursor: pointer; font-size: 20px; font-weight: 700; color: #1f4e78; display: flex; align-items: center; gap: 10px; list-style: none; margin-bottom: 12px;">
<span id="pmmArrow" style="font-size: 18px; color: #1f4e78;">▶</span>
<span>👨‍💼 PMM Adjustment Summary</span>
</summary>
<div style="background: #fef9c3; border: 2px solid #f59e0b; border-radius: 10px; padding: 12px 14px; margin: 0 0 10px 0; font-size: 13px; color: #92400e;">
21 PMMs recorded manual adjustments for 61 partners. Click on each PMM row to expand and view their managed brands. <span style="background: rgba(220,38,38,0.15); padding: 2px 6px; border-radius: 4px;">MoM: ↓50.4% partners adjusted (was 123)</span>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>PMM Name</th>
<th>Partners Managed</th>
<th>Adjustments Made</th>
<th>Adjustment Rate</th>
</tr>
</thead>
<tbody>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Abdul Aziz</span></td>
<td>14<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td>4<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td style="color: #dc2626; font-weight: 600;">28.6%<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Farsan<br>Masar almrafiq<br>Meyzat Al-Takamul<br>Mountain logistics
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Faisal Alghamdi</span></td>
<td>22<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td style="color: #dc2626; font-weight: 600;">9.1%<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
ِAlastool almuntaim<br>alshuhna almumayaza
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Asad Javed</span></td>
<td>15<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td style="color: #dc2626; font-weight: 600;">13.3%<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
ASIL AL-IZZ<br>Delivery heroes limited
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Ali Ibrahim</span></td>
<td>16<div style="font-size: 11px; color: #64748b;">Jan 12 | <span style="color: #16a34a;">MoM +33.3% ^</span></div></td>
<td>4<div style="font-size: 11px; color: #64748b;">Jan 1 | <span style="color: #16a34a;">MoM +300.0% ^</span></div></td>
<td style="color: #dc2626; font-weight: 600;">25.0%<div style="font-size: 11px; color: #64748b;">Jan 8.3% | <span style="color: #16a34a;">MoM +200.0% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Adlek<br>AL-BARAQ AL-KHATEF<br>MAF<br>Sultan abdulaziz saad Albathrah for logistic services
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ 彭兵</span></td>
<td>19<div style="font-size: 11px; color: #64748b;">Jan 7 | <span style="color: #16a34a;">MoM +171.4% ^</span></div></td>
<td>4<div style="font-size: 11px; color: #64748b;">Jan 1 | <span style="color: #16a34a;">MoM +300.0% ^</span></div></td>
<td style="color: #dc2626; font-weight: 600;">21.1%<div style="font-size: 11px; color: #64748b;">Jan 14.3% | <span style="color: #16a34a;">MoM +47.4% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
AREEJ (2)<br>Nebras<br>Step Logistic
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Adilahmed Mohammad</span></td>
<td>23<div style="font-size: 11px; color: #64748b;">Jan 20 | <span style="color: #16a34a;">MoM +15.0% ^</span></div></td>
<td>3<div style="font-size: 11px; color: #64748b;">Jan 5 | <span style="color: #dc2626;">MoM -40.0% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">13.0%<div style="font-size: 11px; color: #64748b;">Jan 25.0% | <span style="color: #dc2626;">MoM -48.0% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
MasarMomaiz Co logistics Services<br>Nukhba<br>YANABEE
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Abdullah Aldweik</span></td>
<td>16<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td>3<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td style="color: #dc2626; font-weight: 600;">18.8%<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Barq AlIbda<br>Tomorrow's Falcons Company<br>Trax
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Anas Ejaz</span></td>
<td>18<div style="font-size: 11px; color: #64748b;">Jan 23 | <span style="color: #dc2626;">MoM -21.7% v</span></div></td>
<td>3<div style="font-size: 11px; color: #64748b;">Jan 4 | <span style="color: #dc2626;">MoM -25.0% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">16.7%<div style="font-size: 11px; color: #64748b;">Jan 17.4% | <span style="color: #dc2626;">MoM -4.0% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
NADA<br>wjahat khaleej<br>Zahra Al Rawda
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Abdulrehman Qureshi</span></td>
<td>20<div style="font-size: 11px; color: #64748b;">Jan 13 | <span style="color: #16a34a;">MoM +53.8% ^</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan 6 | <span style="color: #dc2626;">MoM -66.7% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">10.0%<div style="font-size: 11px; color: #64748b;">Jan 46.2% | <span style="color: #dc2626;">MoM -78.3% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
AHMED SHUAIB GHAZWAN<br>Anan Capital
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Muzammil Ahmed</span></td>
<td>19<div style="font-size: 11px; color: #64748b;">Jan 9 | <span style="color: #16a34a;">MoM +111.1% ^</span></div></td>
<td>4<div style="font-size: 11px; color: #64748b;">Jan 4 | <span style="color: #6b7280;">MoM 0.0% =</span></div></td>
<td style="color: #dc2626; font-weight: 600;">21.1%<div style="font-size: 11px; color: #64748b;">Jan 44.4% | <span style="color: #dc2626;">MoM -52.6% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Bawadir<br>Husool<br>Innovation Gate<br>KAVAA ALTOSEIL
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ 黎嘉豪</span></td>
<td>19<div style="font-size: 11px; color: #64748b;">Jan 30 | <span style="color: #dc2626;">MoM -36.7% v</span></div></td>
<td>6<div style="font-size: 11px; color: #64748b;">Jan 17 | <span style="color: #dc2626;">MoM -64.7% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">31.6%<div style="font-size: 11px; color: #64748b;">Jan 56.7% | <span style="color: #dc2626;">MoM -44.3% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
ABDULMHASSEN AZAIZ BAYJAN AL-ROQI<br>Aibtukir<br>Aldaem Alkhaleejiah<br>E-ter logistics<br>Razan Altabi Logiestics<br>Yuma
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Aamir Ibrahim</span></td>
<td>18<div style="font-size: 11px; color: #64748b;">Jan 37 | <span style="color: #dc2626;">MoM -51.4% v</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan 19 | <span style="color: #dc2626;">MoM -89.5% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">11.1%<div style="font-size: 11px; color: #64748b;">Jan 51.4% | <span style="color: #dc2626;">MoM -78.4% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Masar<br>ZIYAR
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Shahid Ali</span></td>
<td>19<div style="font-size: 11px; color: #64748b;">Jan 28 | <span style="color: #dc2626;">MoM -32.1% v</span></div></td>
<td>3<div style="font-size: 11px; color: #64748b;">Jan 15 | <span style="color: #dc2626;">MoM -80.0% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">15.8%<div style="font-size: 11px; color: #64748b;">Jan 53.6% | <span style="color: #dc2626;">MoM -70.5% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Driver KM logistics<br>Nader logistics<br>services delivery
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Abdul Basitmalik</span></td>
<td>16<div style="font-size: 11px; color: #64748b;">Jan 40 | <span style="color: #dc2626;">MoM -60.0% v</span></div></td>
<td>6<div style="font-size: 11px; color: #64748b;">Jan 19 | <span style="color: #dc2626;">MoM -68.4% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">37.5%<div style="font-size: 11px; color: #64748b;">Jan 47.5% | <span style="color: #dc2626;">MoM -21.1% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Code Car<br>DRER AL-TANAFITHIH<br>Easy Trip For Logistics Services<br>MDT<br>Shdh Logistics<br>Sultan Bin Abdullah
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Junaid Munir</span></td>
<td>14<div style="font-size: 11px; color: #64748b;">Jan 9 | <span style="color: #16a34a;">MoM +55.6% ^</span></div></td>
<td>1<div style="font-size: 11px; color: #64748b;">Jan 3 | <span style="color: #dc2626;">MoM -66.7% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">7.1%<div style="font-size: 11px; color: #64748b;">Jan 33.3% | <span style="color: #dc2626;">MoM -78.6% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Mostaqbal Watan
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Malik Nassar</span></td>
<td>16<div style="font-size: 11px; color: #64748b;">Jan 19 | <span style="color: #dc2626;">MoM -15.8% v</span></div></td>
<td>1<div style="font-size: 11px; color: #64748b;">Jan 1 | <span style="color: #6b7280;">MoM 0.0% =</span></div></td>
<td style="color: #dc2626; font-weight: 600;">6.3%<div style="font-size: 11px; color: #64748b;">Jan 5.3% | <span style="color: #16a34a;">MoM +18.8% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
DTD
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Muhannad Atallah</span></td>
<td>16<div style="font-size: 11px; color: #64748b;">Jan 23 | <span style="color: #dc2626;">MoM -30.4% v</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan 1 | <span style="color: #16a34a;">MoM +100.0% ^</span></div></td>
<td style="color: #dc2626; font-weight: 600;">12.5%<div style="font-size: 11px; color: #64748b;">Jan 4.3% | <span style="color: #16a34a;">MoM +187.5% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
alahdaf aldhahabiya<br>RAYA AL-IMDAD
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Adnan Siddique</span></td>
<td>14<div style="font-size: 11px; color: #64748b;">Jan 18 | <span style="color: #dc2626;">MoM -22.2% v</span></div></td>
<td>4<div style="font-size: 11px; color: #64748b;">Jan 2 | <span style="color: #16a34a;">MoM +100.0% ^</span></div></td>
<td style="color: #dc2626; font-weight: 600;">28.6%<div style="font-size: 11px; color: #64748b;">Jan 11.1% | <span style="color: #16a34a;">MoM +157.1% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services<br>Delivery heroes limited<br>DZL<br>wajihat alruwad almutamayyiz company (Al Taif)
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Mostafa Soliman</span></td>
<td>21<div style="font-size: 11px; color: #64748b;">Jan 26 | <span style="color: #dc2626;">MoM -19.2% v</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan 2 | <span style="color: #6b7280;">MoM 0.0% =</span></div></td>
<td style="color: #dc2626; font-weight: 600;">9.5%<div style="font-size: 11px; color: #64748b;">Jan 7.7% | <span style="color: #16a34a;">MoM +23.8% ^</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
RADHI ABDULSAMEA<br>Rawasy Afaq
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Khalid Ahmad</span></td>
<td>8<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td>2<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
<td style="color: #dc2626; font-weight: 600;">25.0%<div style="font-size: 11px; color: #64748b;">Jan - | <span style="color: #6b7280;">MoM N/A</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Establishment ONE TRIP Express ( Tabuk )<br>KDC Logistics
</div>
</td>
</tr>
<tr onclick="toggleRow(this)" style="cursor: pointer; background: #f3f4f6;">
<td><span style="font-weight: 600;">▶ Mohammad Talha</span></td>
<td>21<div style="font-size: 11px; color: #64748b;">Jan 29 | <span style="color: #dc2626;">MoM -27.6% v</span></div></td>
<td>1<div style="font-size: 11px; color: #64748b;">Jan 2 | <span style="color: #dc2626;">MoM -50.0% v</span></div></td>
<td style="color: #dc2626; font-weight: 600;">4.8%<div style="font-size: 11px; color: #64748b;">Jan 6.9% | <span style="color: #dc2626;">MoM -31.0% v</span></div></td>
</tr>
<tr style="display: none; background: #eff6ff;">
<td colspan="4" style="padding: 15px;">
<div style="font-size: 13px; line-height: 1.8; color: #374151;">
<strong style="color: #1e40af;">Partner brand name with adjustment:</strong><br>
Company AL-DAHAN HIAR INTERNASHONAL Ltd. ( Tabuk )
</div>
</td>
</tr>
<tr style="background: #1f2937; color: white; font-weight: bold;">
<td>TOTAL (Feb)</td>
<td>364<div style="font-size: 11px; color: #cbd5e1; font-weight: 500;">Jan 475 | <span style="color: #fca5a5;">MoM -23.4% v</span></div></td>
<td>61<div style="font-size: 11px; color: #cbd5e1; font-weight: 500;">Jan 123 | <span style="color: #fca5a5;">MoM -50.4% v</span></div></td>
<td>16.8%<div style="font-size: 11px; color: #cbd5e1; font-weight: 500;">Jan 25.9% | <span style="color: #fca5a5;">MoM -35.1% v</span></div></td>
</tr>
</tbody>
</table>
</div>
<script>
// Arrow toggle for PMM section
(function() {
    const detailsEl = document.getElementById('pmm-details');
    const arrowEl = document.getElementById('pmmArrow');
    if (detailsEl && arrowEl) {
        const setArrow = () => { arrowEl.textContent = detailsEl.open ? '▼' : '▶'; };
        detailsEl.addEventListener('toggle', setArrow);
        setArrow();
    }
})();

// toggleRow function for PMM table
function toggleRow(row) {
    const nextRow = row.nextElementSibling;
    if (nextRow && nextRow.style.display === 'none') {
        nextRow.style.display = '';
        row.querySelector('span').textContent = row.querySelector('span').textContent.replace('▶', '▼');
    } else if (nextRow) {
        nextRow.style.display = 'none';
        row.querySelector('span').textContent = row.querySelector('span').textContent.replace('▼', '▶');
    }
}

// Arrow toggle for Strategic Insights
(function() {
    const detailsEl = document.getElementById('strategic-insights');
    const arrowEl = document.getElementById('insightsArrow');
    if (detailsEl && arrowEl) {
        const setArrow = () => { arrowEl.textContent = detailsEl.open ? '▼' : '▶'; };
        detailsEl.addEventListener('toggle', setArrow);
        setArrow();
    }
})();
</script>

<!-- COLLAPSED REASON SEGMENTS SECTION -->
<details id="reason-segment-details" style="margin-top: 40px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb;">
<summary style="cursor: pointer; font-size: 20px; font-weight: 700; color: #1f4e78; display: flex; align-items: center; gap: 10px; list-style: none; margin-bottom: 12px;">
<span id="reasonArrow" style="font-size: 18px; color: #1f4e78;">▶</span>
<span>📋 Reason Segment Selection</span>
</summary>
<div class="table-container">
<table>
<thead>
<tr>
<th>Reason Segment</th>
<th>Partners</th>
<th>% of Total</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr style="background: #d1fae5;">
<td><strong>New partner</strong></td>
<td style="font-weight: 600;">6</td>
<td>9.8%</td>
<td>Newly onboarded partners</td>
</tr>
<tr style="background: #fef3c7;">
<td><strong>Others</strong></td>
<td style="font-size: 18px; font-weight: 600;">49</td>
<td style="font-weight: 600;">80.3%</td>
<td>Miscellaneous reasons not fitting other categories</td>
</tr>
<tr>
<td><strong>The partner has stated their inability to fulfill the capacity</strong></td>
<td>2</td>
<td>3.3%</td>
<td>Cannot meet capacity requirements</td>
</tr>
<tr style="background: #e0f2fe;">
<td><strong>Transfer the capacity from enable partner to this partner</strong></td>
<td style="font-size: 18px; font-weight: 600;">4</td>
<td style="font-weight: 600;">6.6%</td>
<td>Capacity moved from one partner to another</td>
</tr>
<tr style="background: #e5e7eb; font-weight: bold;">
<td>Total</td>
<td>61</td>
<td>100%</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
</details>

<!-- COLLAPSED COMPLETE LIST SECTION -->
<details id="reason-list-details" style="margin-top: 40px; border: 2px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #f9fafb;">
<summary style="cursor: pointer; font-size: 20px; font-weight: 700; color: #1f4e78; display: flex; align-items: center; gap: 10px; list-style: none; margin-bottom: 12px;">
<span id="reasonListArrow" style="font-size: 18px; color: #1f4e78;">▶</span>
<span>📝 Complete List of All PMM Adjustment Reasons</span>
</summary>
<div style="background: #f8fafc; border: 2px solid #cbd5e1; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
<p style="color: #475569; font-size: 13px; margin-bottom: 20px;"><strong>Total Unique Reasons: 37</strong> | Each reason below shows the exact PMM comment with partner count and percentage.</p>
<div class="table-container" style="max-height: 600px; overflow-y: auto;">
<table style="font-size: 13px;">
<thead style="position: sticky; top: 0; background: white; z-index: 10;">
<tr>
<th style="width: 40px;">#</th>
<th style="width: 80px;">Partners</th>
<th style="width: 70px;">%</th>
<th>PMM Reason Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>8</td>
<td>13.1%</td>
<td>Not achieving FR target and drivers card</td>
</tr>
<tr>
<td>2</td>
<td>7</td>
<td>11.5%</td>
<td>2% buffer due to gap in online riders causing bad experience</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>6.6%</td>
<td>driver card rate is low</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>4.9%</td>
<td>they just have 1 driver card, need to reduce the target to control the risk</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>3.3%</td>
<td>100% driver card</td>
</tr>
<tr>
<td>6</td>
<td>2</td>
<td>3.3%</td>
<td>Adjusted target from other partner who is unable to provide driver cards.</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>3.3%</td>
<td>Due to driver Cards issue</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
<td>3.3%</td>
<td>due to kiwa issuses, they can not increase capacity</td>
</tr>
<tr>
<td>9</td>
<td>2</td>
<td>3.3%</td>
<td>they just have 2 driver card, need to reduce the target to control the risk</td>
</tr>
<tr>
<td>10</td>
<td>2</td>
<td>3.3%</td>
<td>this is the extra manpower to cover the risk of high demands.</td>
</tr>
<tr>
<td>11</td>
<td>1</td>
<td>1.6%</td>
<td>0 progress shown for driver cards, 0 proof shared for appointment</td>
</tr>
<tr>
<td>12</td>
<td>1</td>
<td>1.6%</td>
<td>0% driver card</td>
</tr>
<tr>
<td>13</td>
<td>1</td>
<td>1.6%</td>
<td>Driver card 0%</td>
</tr>
<tr>
<td>14</td>
<td>1</td>
<td>1.6%</td>
<td>Driver card 100%</td>
</tr>
<tr>
<td>15</td>
<td>1</td>
<td>1.6%</td>
<td>Fulfill city capacity to save experience.</td>
</tr>
<tr>
<td>16</td>
<td>1</td>
<td>1.6%</td>
<td>High performance partner, high coopreation</td>
</tr>
<tr>
<td>17</td>
<td>1</td>
<td>1.6%</td>
<td>less driver cards, no improvment after 5%</td>
</tr>
<tr>
<td>18</td>
<td>1</td>
<td>1.6%</td>
<td>less driver cards, targeting 15%</td>
</tr>
<tr>
<td>19</td>
<td>1</td>
<td>1.6%</td>
<td>Need immediate courier capacity in Jazan.</td>
</tr>
<tr>
<td>20</td>
<td>1</td>
<td>1.6%</td>
<td>no driver card</td>
</tr>
<tr>
<td>21</td>
<td>1</td>
<td>1.6%</td>
<td>no driver card for car</td>
</tr>
<tr>
<td>22</td>
<td>1</td>
<td>1.6%</td>
<td>no driver cards till date, very low number of driver cards</td>
</tr>
<tr>
<td>23</td>
<td>1</td>
<td>1.6%</td>
<td>Partner has issued driver cards and fully compliant</td>
</tr>
<tr>
<td>24</td>
<td>1</td>
<td>1.6%</td>
<td>Partner shared the Appointment for the driver card they will complete before 24th FEB</td>
</tr>
<tr>
<td>25</td>
<td>1</td>
<td>1.6%</td>
<td>Riders have booked appointments for change licence</td>
</tr>
<tr>
<td>26</td>
<td>1</td>
<td>1.6%</td>
<td>risk partners, who coorpate with hs, and stop operation</td>
</tr>
<tr>
<td>27</td>
<td>1</td>
<td>1.6%</td>
<td>specia case,due to special reason,will protect their capacity three month(2-4)，which align with chandler&amp;iron。</td>
</tr>
<tr>
<td>28</td>
<td>1</td>
<td>1.6%</td>
<td>TGA suspended the bike driver cards.</td>
</tr>
<tr>
<td>29</td>
<td>1</td>
<td>1.6%</td>
<td>Their current evaluation is due to 12 riders being blocked in January because of an operations card issue. They have 15 high-performing and compliant riders, and currently, 100% of these riders are un</td>
</tr>
<tr>
<td>30</td>
<td>1</td>
<td>1.6%</td>
<td>Their driver card just 67, cannot increase 170 within one month</td>
</tr>
<tr>
<td>31</td>
<td>1</td>
<td>1.6%</td>
<td>Their riders all have rider cards, but due to issues with vehicle registration certificates, none of the riders have completed the system update.Their owner strongly appealed</td>
</tr>
<tr>
<td>32</td>
<td>1</td>
<td>1.6%</td>
<td>They don't drver card issuse</td>
</tr>
<tr>
<td>33</td>
<td>1</td>
<td>1.6%</td>
<td>They had an issue with the operations manager, who has been replaced. This company is new, having completed only two months of operation, and should ideally be exempted during its first three months.</td>
</tr>
<tr>
<td>34</td>
<td>1</td>
<td>1.6%</td>
<td>this partner was working in PT project and never worked as full timer, will have 16 full time riders and 6 as PT riders</td>
</tr>
<tr>
<td>35</td>
<td>1</td>
<td>1.6%</td>
<td>Unable to get driver cards.</td>
</tr>
<tr>
<td>36</td>
<td>1</td>
<td>1.6%</td>
<td>will have driver Card before 15th Feb</td>
</tr>
<tr>
<td>37</td>
<td>1</td>
<td>1.6%</td>
<td>(blank)</td>
</tr>
<tr style="background: #e5e7eb; font-weight: bold;">
<td>Total</td>
<td>61</td>
<td>100%</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
</div>
</details>

<script>
// Arrow toggle for Reason Segment Details
document.getElementById('reason-segment-details').addEventListener('toggle', function() {
    const arrow = document.getElementById('reasonArrow');
    if (this.open) {
        arrow.textContent = '▼';
    } else {
        arrow.textContent = '▶';
    }
});

// Arrow toggle for Reason List Details
document.getElementById('reason-list-details').addEventListener('toggle', function() {
    const arrow = document.getElementById('reasonListArrow');
    if (this.open) {
        arrow.textContent = '▼';
    } else {
        arrow.textContent = '▶';
    }
});
</script>

</div>


<div class="tab-content" id="dailyView">
<style>
.daily-view-title { margin-bottom: 8px; color: #1f4e78; font-size: 24px; font-weight: 700; }
.daily-view-subtitle { color: #5a6a7a; font-size: 14px; margin-bottom: 20px; }
.daily-kpi-row { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 22px; }
.daily-kpi-card { flex: 1; min-width: 180px; background: linear-gradient(135deg, #f8fafc 0%, #e8f0fe 100%); border-radius: 12px; padding: 16px 18px; border-left: 4px solid #1f4e78; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; }
.daily-kpi-card .kpi-label { font-size: 12px; color: #637282; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.daily-kpi-card .kpi-value { font-size: 26px; font-weight: 800; color: #1f4e78; line-height: 1.1; }
.daily-kpi-card .kpi-sub { font-size: 11px; color: #8899aa; margin-top: 4px; }
.daily-kpi-card.kpi-green { border-left-color: #27ae60; }
.daily-kpi-card.kpi-green .kpi-value { color: #27ae60; }
.daily-kpi-card.kpi-amber { border-left-color: #f39c12; }
.daily-kpi-card.kpi-amber .kpi-value { color: #e67e22; }
.daily-kpi-card.kpi-red { border-left-color: #e74c3c; }
.daily-kpi-card.kpi-red .kpi-value { color: #e74c3c; }
.daily-kpi-card.kpi-blue { border-left-color: #2980b9; }
.daily-kpi-card.kpi-blue .kpi-value { color: #2980b9; }
.daily-kpi-card .tooltip-daily { visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: #1a2a3a; color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 11.5px; line-height: 1.5; white-space: nowrap; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.25); transition: opacity 0.2s; pointer-events: none; }
.daily-kpi-card .tooltip-daily::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1a2a3a; }
.daily-kpi-card:hover .tooltip-daily { visibility: visible; opacity: 1; }
.daily-slicer { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.daily-slicer-btn { padding: 8px 18px; border: 2px solid #d0dbe8; background: #fff; border-radius: 20px; font-size: 13px; font-weight: 600; color: #4a5a6a; cursor: pointer; transition: all 0.2s; }
.daily-slicer-btn:hover { background: #e8f0fe; border-color: #2980b9; }
.daily-slicer-btn.active { background: #1f4e78; color: #fff; border-color: #1f4e78; }
.daily-slicer-btn[data-cat="good"].active { background: #27ae60; border-color: #27ae60; }
.daily-slicer-btn[data-cat="average"].active { background: #f39c12; border-color: #f39c12; }
.daily-slicer-btn[data-cat="bad"].active { background: #e74c3c; border-color: #e74c3c; }
.daily-slicer-btn[data-cat="new"].active { background: #8e44ad; border-color: #8e44ad; }
.daily-mini-note { margin: -8px 0 14px; padding: 8px 12px; border-left: 4px solid #8e44ad; background: #f7f0fb; border-radius: 8px; font-size: 12px; color: #4b3a5a; }
.daily-mini-note strong { color: #6c2ea8; }
.city-view-section { margin-top: 18px; padding-top: 12px; border-top: 2px dashed #dbe7f3; }
.city-view-title { font-size: 20px; font-weight: 800; color: #1f4e78; margin: 4px 0 10px; }
.city-mini-note { margin: 0 0 14px; padding: 9px 12px; border-left: 4px solid #2980b9; background: #eef6ff; border-radius: 8px; font-size: 12px; color: #2f4f6f; }
.city-mini-note strong { color: #1f4e78; }
.city-slicer { display:flex; align-items:center; gap:10px; margin: 10px 0 14px; flex-wrap: wrap; }
.city-slicer-label { font-size: 12px; font-weight: 700; color: #1f4e78; }
.city-slicer-buttons { display:flex; gap:8px; flex-wrap:wrap; }
.city-slicer-btn { padding: 7px 14px; font-size: 12px; }
.city-slicer-legend { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: -2px 0 12px 0; font-size: 11px; color:#5a6a7a; }
.city-slicer-legend .lg-item { display:flex; align-items:center; gap:5px; }
.city-slicer-legend .lg-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
.city-slicer-legend .lg-good { background:#27ae60; }
.city-slicer-legend .lg-amber { background:#f39c12; }
.city-slicer-legend .lg-red { background:#e74c3c; }
.city-slicer-btn.city-band-all { background: #eef6ff; color: #1f4e78; border-color: #2980b9; }
.city-slicer-btn.city-band-good { background: #edf9f0; color: #1a7a3a; border-color: #27ae60; }
.city-slicer-btn.city-band-amber { background: #fff7ea; color: #b66c06; border-color: #f39c12; }
.city-slicer-btn.city-band-red { background: #fdeeee; color: #b93c2f; border-color: #e74c3c; }
.city-slicer-btn.city-band-all.active { background: #2980b9; color: #fff; border-color: #2980b9; }
.city-slicer-btn.city-band-good.active { background: #27ae60; color: #fff; border-color: #27ae60; }
.city-slicer-btn.city-band-amber.active { background: #f39c12; color: #fff; border-color: #f39c12; }
.city-slicer-btn.city-band-red.active { background: #e74c3c; color: #fff; border-color: #e74c3c; }
.daily-charts-row { display: flex; gap: 18px; margin-bottom: 20px; flex-wrap: wrap; }
.daily-chart-box { flex: 1; min-width: 380px; background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #e8eef4; }
.daily-chart-box-full { width: 100%; background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #e8eef4; margin-bottom: 20px; }
.daily-chart-title { font-size: 14px; font-weight: 700; color: #1f4e78; margin-bottom: 10px; }
.daily-chart-canvas-wrap { position: relative; width: 100%; height: 300px; }
.daily-chart-canvas-wrap-sm { position: relative; width: 100%; height: 250px; }
.daily-details { margin-bottom: 16px; }
.daily-details > summary { font-size: 15px; font-weight: 700; color: #1f4e78; cursor: pointer; padding: 12px 16px; background: linear-gradient(135deg, #f0f5fa 0%, #e2ecf5 100%); border-radius: 10px; border: 1px solid #d0dbe8; user-select: none; list-style: none; display: flex; align-items: center; gap: 8px; }
.daily-details > summary::-webkit-details-marker { display: none; }
.daily-details > summary::before { content: '\25B6'; font-size: 11px; transition: transform 0.2s; }
.daily-details[open] > summary::before { transform: rotate(90deg); }
.daily-details > summary:hover { background: linear-gradient(135deg, #e2ecf5 0%, #d4e2f0 100%); }
.daily-details-content { padding: 16px 8px; }
.daily-insight-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 12px; }
.daily-insight-item { padding: 12px 14px; border-radius: 8px; border-left: 3px solid #2980b9; background: #f8fafc; font-size: 12.5px; line-height: 1.6; color: #3a4a5a; }
.daily-insight-item.insight-good { border-left-color: #27ae60; }
.daily-insight-item.insight-warn { border-left-color: #f39c12; }
.daily-insight-item.insight-bad { border-left-color: #e74c3c; }
.daily-insight-item strong { color: #1f4e78; }
.daily-table-wrap { overflow-x: auto; margin-top: 10px; }
.daily-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.daily-table th { background: #1f4e78; color: #fff; padding: 8px 10px; text-align: center; font-weight: 600; font-size: 11px; white-space: nowrap; position: sticky; top: 0; z-index: 2; }
.daily-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid #e8eef4; white-space: nowrap; }
.daily-table tr:hover { background: #f0f5fa; }
.daily-table .perf-good { color: #27ae60; font-weight: 700; }
.daily-table .perf-average { color: #f39c12; font-weight: 700; }
.daily-table .perf-bad { color: #e74c3c; font-weight: 700; }
.daily-table .ach-green { color: #27ae60; font-weight: 600; }
.daily-table .ach-amber { color: #e67e22; font-weight: 600; }
.daily-table .ach-red { color: #e74c3c; font-weight: 600; }
.daily-table .rank-top { background: #e8f8e8; }
.daily-table .rank-bottom { background: #fde8e8; }
.daily-search-bar { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.daily-search-input { padding: 7px 14px; border: 1px solid #d0dbe8; border-radius: 8px; font-size: 13px; width: 220px; outline: none; }
.daily-search-input:focus { border-color: #2980b9; box-shadow: 0 0 0 2px rgba(41,128,185,0.15); }
.daily-table-info { font-size: 12px; color: #8899aa; }
.daily-highlight-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.daily-highlight-card { flex: 1; min-width: 200px; padding: 14px; border-radius: 10px; font-size: 13px; line-height: 1.5; }
.daily-highlight-card.hl-green { background: #e8f8e8; border: 1px solid #27ae60; color: #1a5c2e; }
.daily-highlight-card.hl-amber { background: #fef6e8; border: 1px solid #f39c12; color: #7a5a10; }
.daily-highlight-card.hl-red { background: #fde8e8; border: 1px solid #e74c3c; color: #7a1a1a; }
.daily-highlight-card strong { font-size: 14px; }
.daily-data-section { margin-bottom: 14px; }
.daily-data-section h4 { font-size: 14px; font-weight: 700; color: #1f4e78; margin: 0 0 8px 0; }
.daily-data-tbl { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 14px; }
.daily-data-tbl th { background: #1f4e78; color: #fff; padding: 7px 10px; text-align: center; font-weight: 600; font-size: 11px; white-space: nowrap; }
.daily-data-tbl td { padding: 6px 8px; text-align: center; border: 1px solid #e0e8f0; white-space: nowrap; font-size: 12px; }
.daily-data-tbl tr:nth-child(even) { background: #f8fafe; }
.daily-data-tbl .lbl-cell { text-align: left; font-weight: 600; color: #1f4e78; background: #f0f5fa; min-width: 110px; }
.daily-data-tbl .ach-val { color: #1a7a3a; font-weight: 700; }
.daily-data-tbl .ach-val-red { color: #c0392b; font-weight: 700; }
.daily-data-tbl .ach-val-amber { color: #d68910; font-weight: 700; }
.daily-data-tbl .hdr-blue th { background: #2980b9; }
.daily-data-tbl .hdr-green th { background: #27ae60; }
.daily-data-tbl .hdr-orange th { background: #f39c12; }
.daily-data-tbl .hdr-red th { background: #e74c3c; }
.daily-data-tbl .hdr-purple th { background: #8e44ad; }
.perf-new { color: #8e44ad; font-weight: 700; }
@media(max-width:768px) {
  .daily-kpi-row { gap: 8px; }
  .daily-kpi-card { min-width: 140px; padding: 10px 12px; }
  .daily-kpi-card .kpi-value { font-size: 20px; }
  .daily-chart-box { min-width: 100%; }
  .daily-chart-canvas-wrap { height: 250px; }
  .daily-chart-canvas-wrap-sm { height: 200px; }
}
</style>

<h2 class="daily-view-title">&#128197; Capacity Target Achievement (Daily View)</h2>
<p class="daily-view-subtitle">February 2026 MTD &nbsp;|&nbsp; Daily performance tracking across all partners with target &nbsp;|&nbsp; Delivery &amp; Online rider capacity target achievement analysis</p>

<!-- Google Sheets Sync Status Banner -->
<div id="syncBanner" style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border:2px solid #66bb6a; border-radius:10px; padding:10px 16px; margin:12px 0 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 8px rgba(102,187,106,0.2);">
  <div style="display:flex; align-items:center; gap:10px;">
    <span id="syncIcon" style="font-size:18px;">🔗</span>
    <span id="syncStatus" style="font-size:13px; font-weight:600; color:#2e7d32;">Connected to Google Sheets</span>
    <span id="syncTime" style="font-size:12px; color:#558b2f; margin-left:8px;"></span>
  </div>
  <button onclick="refreshSheetData()" style="padding:6px 14px; background:#66bb6a; color:#fff; border:none; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s; box-shadow:0 2px 6px rgba(102,187,106,0.3);" onmouseover="this.style.background='#4caf50'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#66bb6a'; this.style.transform='scale(1)'">
    🔄 Refresh Data
  </button>
</div>

<!-- NEW ADVANCED DATA SECTION -->
<div id="advancedDataSection" style="margin-bottom: 30px;">
  <style>
    .adv-toggle-row { display:flex; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
    .adv-toggle-btn { padding:10px 20px; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border:2px solid #1976d2; border-radius:12px; font-size:14px; font-weight:700; color:#0d47a1; cursor:pointer; transition:all 0.3s; box-shadow:0 2px 8px rgba(25,118,210,0.15); }
    .adv-toggle-btn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(25,118,210,0.25); }
    .adv-toggle-btn.active { background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff; border-color:#0d47a1; }
    .adv-sub-slicer { display:flex; gap:8px; margin:12px 0 16px; flex-wrap:wrap; }
    .adv-sub-btn { padding:6px 14px; background:#fff; border:2px solid #bdbdbd; border-radius:8px; font-size:12px; font-weight:600; color:#424242; cursor:pointer; transition:all 0.2s; }
    .adv-sub-btn:hover { border-color:#1976d2; background:#e3f2fd; }
    .adv-sub-btn.active { background:#1976d2; color:#fff; border-color:#0d47a1; }
    .adv-content-box { display:none; background:#fff; border-radius:14px; padding:20px; box-shadow:0 3px 12px rgba(0,0,0,0.08); border:1px solid #e0e0e0; }
    .adv-content-box.active { display:block; animation:fadeInUp 0.4s ease-out; }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
    .adv-cards-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-bottom:18px; }
    .adv-card { background:linear-gradient(135deg, #f8fafc 0%, #e8f4f8 100%); border-radius:12px; padding:16px; border-left:4px solid #1976d2; }
    .adv-card .card-label { font-size:11px; color:#546e7a; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
    .adv-card .card-value { font-size:24px; font-weight:800; color:#0d47a1; line-height:1.1; }
    .adv-card .card-sub { font-size:11px; color:#78909c; margin-top:4px; }
    /* Styled tooltips for cards and rows */
    .adv-card { position: relative; cursor: default; }
    .card-tip-text { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; min-width: 210px; max-width: 270px; background: #1a237e; color: #fff; font-size: 11px; font-weight: 400; line-height: 1.45; padding: 10px 12px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.18); z-index: 100; transition: opacity 0.2s, visibility 0.2s; text-transform: none; letter-spacing: 0; pointer-events: none; text-align: center; }
    .card-tip-text::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1a237e; }
    .adv-card:hover .card-tip-text { visibility: visible; opacity: 1; }
    .row-info-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: rgba(13,71,161,0.1); color: #1565c0; font-size: 10px; font-weight: 700; margin-left: 5px; cursor: help; position: relative; vertical-align: middle; }
    .row-info-icon:hover { background: rgba(13,71,161,0.25); }
    .row-info-icon .row-tip-text { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 6px; min-width: 220px; background: #1a237e; color: #fff; font-size: 11px; font-weight: 400; line-height: 1.4; padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.18); z-index: 100; transition: opacity 0.2s, visibility 0.2s; white-space: normal; pointer-events: none; }
    .row-info-icon .row-tip-text::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1a237e; }
    .row-info-icon:hover .row-tip-text { visibility: visible; opacity: 1; }
    .adv-card.green { border-left-color:#2e7d32; background:linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%); }
    .adv-card.green .card-value { color:#1b5e20; }
    .adv-card.amber { border-left-color:#f57c00; background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
    .adv-card.amber .card-value { color:#e65100; }
    .adv-card.red { border-left-color:#c62828; background:linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); }
    .adv-card.red .card-value { color:#b71c1c; }
    .adv-table-container { margin-bottom:16px; }
    .adv-table-title { font-size:15px; font-weight:700; color:#0d47a1; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .adv-table-wrap { overflow-x:auto; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,0.08); }
    .adv-table { width:100%; border-collapse:collapse; font-size:12px; background:#fff; }
    .adv-table th { background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:#fff; padding:10px 12px; text-align:center; font-weight:700; font-size:11.5px; white-space:nowrap; border-right:1px solid rgba(255,255,255,0.2); position:sticky; left:0; z-index:3; }
    .adv-table th:first-child { position:sticky; left:0; z-index:4; }
    .adv-table td { padding:8px 10px; text-align:center; border:1px solid #e0e0e0; white-space:nowrap; transition:background 0.2s; }
    .adv-table tr:hover td { background:#e3f2fd; }
    .adv-table td:first-child { font-weight:600; text-align:left; background:#f5f5f5; position:sticky; left:0; z-index:2; min-width:150px; }
    .adv-table .period-col { background:#f0f4f8; font-weight:600; }
    .adv-table .val-excellent { color:#2e7d32; font-weight:700; }
    .adv-table .val-good { color:#558b2f; font-weight:600; }
    .adv-table .val-warning { color:#f57c00; font-weight:600; }
    .adv-table .val-critical { color:#c62828; font-weight:700; }
        .partners-strat-table .val-critical,
        .partners-strat-table .bkdn-vlow {
            color:#b71c1c;
            font-weight:800;
        }
        .partners-strat-table .red-flag-cell,
        .city-level-table .red-flag-cell {
            position: relative;
            animation:partnersFlagPulse 0.9s ease-in-out 3;
        }
        .partners-strat-table .red-flag-cell.flag-light,
        .city-level-table .red-flag-cell.flag-light {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%) !important;
            box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.45);
        }
        .partners-strat-table .red-flag-cell.flag-high,
        .city-level-table .red-flag-cell.flag-high {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            box-shadow: inset 0 0 0 1px rgba(183, 28, 28, 0.42);
        }
        .partners-strat-table .red-flag-cell::after,
        .city-level-table .red-flag-cell::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 2px solid rgba(245, 158, 11, 0.35);
            border-radius: 2px;
            pointer-events: none;
            animation:partnersFlagRing 0.9s ease-out 3;
        }
        .partners-strat-table .red-flag-cell.flag-high::after,
        .city-level-table .red-flag-cell.flag-high::after {
            border-color: rgba(220, 38, 38, 0.42);
        }
        @keyframes partnersFlagPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.12); }
        }
        @keyframes partnersFlagRing {
            0% { opacity: 0.9; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.03); }
        }
        @media (prefers-reduced-motion: reduce) {
            .partners-strat-table .val-critical,
            .partners-strat-table .bkdn-vlow,
            .city-level-table .red-flag-cell,
            .city-level-table .red-flag-cell::after,
            .partners-strat-table .red-flag-cell,
            .partners-strat-table .red-flag-cell::after {
                animation: none;
            }
        }
    .adv-legend { display:flex; gap:16px; margin:10px 0 14px; font-size:11px; flex-wrap:wrap; align-items:center; padding:10px 14px; background:#f9fafb; border-radius:8px; border:1px solid #e0e0e0; }
    .adv-legend-item { display:flex; align-items:center; gap:6px; }
    .adv-legend-dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .adv-legend .dot-excellent { background:#2e7d32; }
    .adv-legend .dot-good { background:#558b2f; }
    .adv-legend .dot-warning { background:#f57c00; }
    .adv-legend .dot-critical { background:#c62828; }
    .adv-highlight-box { margin:14px 0; padding:14px 18px; border-radius:10px; border-left:4px solid #1976d2; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 30%, #e3f2fd 100%); font-size:13px; line-height:1.6; color:#0d47a1; }

    /* Comment System Styles */
    .comment-btn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff; border:none; cursor:pointer; font-size:24px; box-shadow:0 4px 16px rgba(25,118,210,0.4); transition:all 0.3s; z-index:999; display:flex; align-items:center; justify-content:center; }
    .comment-btn:hover { transform:scale(1.1); box-shadow:0 6px 24px rgba(25,118,210,0.6); }
    .comment-btn .badge { position:absolute; top:-5px; right:-5px; background:#f44336; color:#fff; border-radius:50%; width:24px; height:24px; font-size:11px; font-weight:700; display:flex; align-items:center; justify-content:center; border:2px solid #fff; }
    .comment-panel { position:fixed; right:-400px; top:0; width:400px; height:100vh; background:#fff; box-shadow:-4px 0 24px rgba(0,0,0,0.2); transition:right 0.3s ease; z-index:1000; display:flex; flex-direction:column; }
    .comment-panel.open { right:0; }
    .comment-header { padding:20px; background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .comment-header h3 { margin:0; font-size:18px; font-weight:700; }
    .comment-close { background:none; border:none; color:#fff; font-size:28px; cursor:pointer; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
    .comment-close:hover { background:rgba(255,255,255,0.2); }
    .comment-list { flex:1; overflow-y:auto; padding:16px; background:#f5f5f5; }
    .comment-item { background:#fff; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow:0 1px 4px rgba(0,0,0,0.1); animation:slideIn 0.3s ease; position:relative; }
    .comment-item.pinned { background:linear-gradient(135deg, #fffbf0 0%, #fff8e1 100%); border-left:4px solid #ffa726; }
    .comment-item.resolved { opacity:0.6; background:#f5f5f5; }
    .comment-item.reply { margin-left:30px; border-left:3px solid #bbdefb; padding-left:10px; }
    @keyframes slideIn { from{opacity:0; transform:translateX(20px);} to{opacity:1; transform:translateX(0);} }
    .comment-user { font-weight:700; color:#1976d2; font-size:13px; margin-bottom:4px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .comment-pin-badge { background:#ffa726; color:#fff; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; }
    .comment-resolved-badge { background:#4caf50; color:#fff; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:600; }
    .comment-edited-badge { background:#9e9e9e; color:#fff; font-size:9px; padding:2px 4px; border-radius:3px; }
    .comment-text { font-size:13px; color:#424242; line-height:1.5; margin-bottom:6px; word-wrap:break-word; }
    .comment-text .mention { color:#1976d2; font-weight:600; background:#e3f2fd; padding:1px 4px; border-radius:3px; }
    .comment-time { font-size:11px; color:#9e9e9e; margin-bottom:8px; }
    .comment-pin-btn { position:absolute; top:8px; right:8px; background:transparent; border:1px solid #e0e0e0; color:#757575; padding:4px 8px; border-radius:6px; font-size:11px; cursor:pointer; transition:all 0.2s; }
    .comment-pin-btn:hover { background:#f5f5f5; border-color:#bdbdbd; }
    .comment-pin-btn.pinned { background:#ffa726; color:#fff; border-color:#ffa726; }
    .comment-pin-btn.pinned:hover { background:#ff9800; }
    .comment-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .comment-reaction-bar { display:flex; gap:4px; margin-right:auto; }
    .comment-reaction { background:#f5f5f5; border:1px solid #e0e0e0; border-radius:12px; padding:3px 8px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:3px; transition:all 0.2s; }
    .comment-reaction:hover { background:#e3f2fd; border-color:#1976d2; }
    .comment-reaction.active { background:#1976d2; color:#fff; border-color:#1976d2; }
    .comment-action-btn { background:none; border:none; color:#757575; font-size:11px; cursor:pointer; padding:4px 8px; border-radius:4px; transition:all 0.2s; }
    .comment-action-btn:hover { background:#f5f5f5; color:#1976d2; }
    .comment-edit-area { margin-top:8px; }
    .comment-edit-area textarea { width:100%; border:1px solid #bdbdbd; border-radius:6px; padding:8px; font-size:13px; font-family:inherit; resize:vertical; min-height:60px; }
    .comment-edit-btns { display:flex; gap:6px; margin-top:6px; }
    .comment-edit-btns button { padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer; border:none; font-weight:600; }
    .comment-save-btn { background:#1976d2; color:#fff; }
    .comment-cancel-btn { background:#e0e0e0; color:#424242; }
    .mention-autocomplete { position:absolute; bottom:120px; left:16px; right:16px; background:#fff; border:1px solid #e0e0e0; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); max-height:150px; overflow-y:auto; z-index:10; }
    .mention-item { padding:8px 12px; cursor:pointer; font-size:13px; border-bottom:1px solid #f5f5f5; }
    .mention-item:hover { background:#e3f2fd; }
    .mention-item:last-child { border-bottom:none; }
    .comment-input-area { padding:16px; background:#fff; border-top:1px solid #e0e0e0; position:relative; }
    .comment-input-area input, .comment-input-area textarea { width:100%; border:1px solid #bdbdbd; border-radius:8px; padding:10px; font-size:13px; font-family:inherit; margin-bottom:10px; }
    .comment-input-area input { height:38px; }
    .comment-input-area textarea { height:80px; resize:none; }
    .comment-reply-header { background:#e3f2fd; padding:8px 12px; border-radius:6px; margin-bottom:10px; font-size:12px; display:flex; justify-content:space-between; align-items:center; }
    .comment-reply-header .reply-to { color:#1976d2; font-weight:600; }
    .comment-reply-header button { background:none; border:none; color:#757575; cursor:pointer; font-size:16px; }
    .comment-context-banner { background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding:12px 16px; margin:-20px -20px 16px -20px; border-bottom:2px solid #66bb6a; font-size:13px; color:#2e7d32; }
    .comment-context-banner strong { display:block; font-size:14px; margin-bottom:4px; color:#1b5e20; }
    .comment-context-banner .context-location { font-size:11px; opacity:0.9; }
    .commentable-section.highlight-pulse { animation:highlightPulse 2s ease-out; }
    @keyframes highlightPulse { 0%{box-shadow:0 0 0 0 rgba(25,118,210,0.7);} 50%{box-shadow:0 0 20px 10px rgba(25,118,210,0.3);} 100%{box-shadow:0 0 0 0 rgba(25,118,210,0);} }
    .comment-input-area button { width:100%; padding:12px; background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:700; cursor:pointer; transition:all 0.3s; }
    .comment-input-area button:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(25,118,210,0.4); }
    .comment-input-area button:disabled { opacity:0.5; cursor:not-allowed; }
    .comment-empty { text-align:center; color:#9e9e9e; padding:40px 20px; font-size:14px; }
    .comment-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:998; display:none; }
    .comment-overlay.show { display:block; }
    .adv-highlight-box strong { font-size:14px; color:#01579b; }
    .adv-highlight-box.green { border-left-color:#2e7d32; background:linear-gradient(135deg, #f1f8e9 0%, #dcedc8 30%, #f1f8e9 100%); color:#1b5e20; }
    .adv-highlight-box.green strong { color:#1b5e20; }
    .adv-highlight-box.amber { border-left-color:#f57c00; background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 30%, #fff3e0 100%); color:#e65100; }
    .adv-highlight-box.amber strong { color:#e65100; }
    .adv-chart-details { margin-top:12px; }
    .adv-chart-details summary { padding:10px 16px; background:linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%); border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; color:#263238; list-style:none; display:flex; align-items:center; gap:8px; }
    .adv-chart-details summary::-webkit-details-marker { display:none; }
    .adv-chart-details summary::before { content:'▶'; font-size:10px; transition:transform 0.2s; }
    .adv-chart-details[open] summary::before { transform:rotate(90deg); }
    .adv-chart-details summary:hover { background:linear-gradient(135deg, #cfd8dc 0%, #b0bec5 100%); }
    .adv-chart-wrap { margin-top:12px; padding:16px; background:#fafafa; border-radius:8px; }
    .adv-chart-canvas { position:relative; height:280px; }
    .adv-expand-btn { padding:6px 14px; background:#fff; border:2px solid #1976d2; border-radius:6px; font-size:11px; font-weight:600; color:#1976d2; cursor:pointer; transition:all 0.2s; margin-top:8px; }
    .adv-expand-btn:hover { background:#1976d2; color:#fff; }
.adv-daily-cols { display:none; }
    .adv-daily-cols.expanded { display:table-cell; }
    .ach-trend { display:block; font-size:10px; font-weight:700; margin-top:2px; line-height:1.1; }
    .ach-trend.up { color:#2e7d32; }
    .ach-trend.down { color:#c62828; }
    .ach-trend.flat { color:#607d8b; }
    .adv-table .bkdn-high { color:#2e7d32; font-weight:700; }
    .adv-table .bkdn-mid { color:#558b2f; font-weight:600; }
    .adv-table .bkdn-low { color:#f57c00; font-weight:600; }
    .adv-table .bkdn-vlow { color:#c62828; font-weight:700; }
    .adv-city-slicer { display:flex; flex-wrap:wrap; gap:6px; margin:10px 0; padding:10px; background:#f5f7fa; border-radius:8px; border:1px solid #e0e0e0; align-items:center; }
    .adv-city-slicer .slicer-label { font-size:11px; font-weight:700; color:#0d47a1; margin-right:6px; }
    .adv-city-chip { padding:4px 10px; border-radius:14px; font-size:10.5px; font-weight:600; cursor:pointer; border:2px solid #bbdefb; background:#fff; color:#1565c0; transition:all 0.2s; user-select:none; }
    .adv-city-chip.active { background:#1565c0; color:#fff; border-color:#1565c0; }
    .adv-city-chip:hover { border-color:#1565c0; }
    .adv-city-chip.tier-btn { background:#e8eaf6; color:#283593; border-color:#9fa8da; font-weight:700; }
    .adv-city-chip.tier-btn.active { background:#283593; color:#fff; border-color:#283593; }
    
    /* Fixed Comment Hub */
    .comment-hub-fixed { position:fixed; top:80px; right:20px; z-index:999; }
    .comment-hub-btn { background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff; border:none; border-radius:50%; width:56px; height:56px; cursor:pointer; box-shadow:0 4px 16px rgba(25,118,210,0.4); display:flex; align-items:center; justify-content:center; font-size:24px; transition:all 0.3s; position:relative; }
    .comment-hub-btn:hover { transform:scale(1.1); box-shadow:0 6px 24px rgba(25,118,210,0.6); }
    .comment-hub-badge { position:absolute; top:-5px; right:-5px; background:#f44336; color:#fff; border-radius:50%; width:22px; height:22px; font-size:11px; font-weight:700; display:flex; align-items:center; justify-content:center; border:2px solid #fff; }
    .comment-hub-tooltip { position:absolute; right:100%; top:50%; transform:translateY(-50%); margin-right:10px; background:#263238; color:#fff; padding:8px 12px; border-radius:6px; font-size:12px; white-space:nowrap; opacity:0; pointer-events:none; transition:opacity 0.2s; }
    .comment-hub-btn:hover .comment-hub-tooltip { opacity:1; }
    
    /* Hover Comment Indicators */
    .commentable-section { position:relative; }
    .comment-indicator { position:absolute; top:8px; right:8px; background:rgba(25,118,210,0.9); color:#fff; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; font-size:14px; display:none; align-items:center; justify-content:center; transition:all 0.2s; z-index:10; box-shadow:0 2px 8px rgba(25,118,210,0.3); }
    .comment-indicator.has-comments { background:#ff9800; }
    .commentable-section:hover .comment-indicator { display:flex; animation:fadeInBounce 0.3s ease; }
    .comment-indicator:hover { transform:scale(1.15); box-shadow:0 3px 12px rgba(25,118,210,0.5); }
    .comment-indicator-badge { position:absolute; top:-4px; right:-4px; background:#f44336; color:#fff; border-radius:50%; width:16px; height:16px; font-size:9px; font-weight:700; display:flex; align-items:center; justify-content:center; border:2px solid #fff; }
    @keyframes fadeInBounce { 0%{opacity:0; transform:scale(0.8);} 60%{transform:scale(1.1);} 100%{opacity:1; transform:scale(1);} }

        .lang-switcher-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.95);
            border: 1px solid #d6e4f0;
            border-radius: 999px;
            padding: 6px 10px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.14);
            backdrop-filter: blur(4px);
        }
        .lang-switcher-icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #0d47a1;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
            user-select: none;
        }
        .lang-switcher-select {
            border: none;
            background: transparent;
            color: #0d47a1;
            font-size: 12px;
            font-weight: 700;
            outline: none;
            cursor: pointer;
            min-width: 92px;
            padding-right: 4px;
        }
  </style>

  <div class="adv-toggle-row">
    <button class="adv-toggle-btn active" data-section="totalOverview" onclick="switchAdvSection('totalOverview', this)">📊 Total Overview</button>
    <button class="adv-toggle-btn" data-section="partnersStrat" onclick="switchAdvSection('partnersStrat', this)">👥 Partners Stratification</button>
    <button class="adv-toggle-btn" data-section="cityLevel" onclick="switchAdvSection('cityLevel', this)">🏙️ City Level Data</button>
  </div>

  <!-- Fixed Comment Hub -->
  <div class="comment-hub-fixed" id="commentHubFixed" style="display:none;">
    <button class="comment-hub-btn" onclick="openCommentHub()">
      💬
      <span class="comment-hub-badge" id="commentHubBadge">0</span>
      <span class="comment-hub-tooltip">View All Comments</span>
    </button>
  </div>

  <!-- TOTAL OVERVIEW SECTION -->
  <div id="totalOverviewContent" class="adv-content-box active">
    <h3 style="margin:0 0 16px 0; font-size:18px; color:#0d47a1; font-weight:700;">📊 Total Overview</h3>
    <div class="adv-cards-row">
      <div class="adv-card amber commentable-section">
        <button class="comment-indicator" onclick="openComments('totalOverview-mtd')" title="Comment on MTD Achievement">
          💬
          <span class="comment-indicator-badge" id="badge-totalOverview-mtd" style="display:none;">0</span>
        </button>
        <div class="card-label">MTD Achievement</div>
        <span class="card-tip-text">Month-to-date achievement rate calculated as Delivery Riders ÷ Target across all partners.</span>
        <div class="card-value">93.1%</div>
        <div class="card-sub">Delivery | Target: 19,430</div>
      </div>
      <div class="adv-card green commentable-section">
        <button class="comment-indicator" onclick="openComments('totalOverview-w1')" title="Comment on W1 Performance">
          💬
          <span class="comment-indicator-badge" id="badge-totalOverview-w1" style="display:none;">0</span>
        </button>
        <div class="card-label">W1 Performance</div>
        <span class="card-tip-text">Week 1 (Feb 1-7) achievement rate. Delivery Riders ÷ Target for the first week of the month.</span>
        <div class="card-value">92.5%</div>
        <div class="card-sub">Feb 1-7 | Stable</div>
      </div>
      <div class="adv-card amber commentable-section">
        <button class="comment-indicator" onclick="openComments('totalOverview-w2')" title="Comment on W2 Performance">
          💬
          <span class="comment-indicator-badge" id="badge-totalOverview-w2" style="display:none;">0</span>
        </button>
        <div class="card-label">W2 Performance</div>
        <span class="card-tip-text">Week 2 (Feb 8-14) achievement rate. Delivery Riders ÷ Target for the second week of the month.</span>
        <div class="card-value">92.4%</div>
        <div class="card-sub">Feb 8-14 | Declining trend</div>
      </div>
      <div class="adv-card commentable-section">
        <button class="comment-indicator" onclick="openComments('totalOverview-gap')" title="Comment on Total GAP">
          💬
          <span class="comment-indicator-badge" id="badge-totalOverview-gap" style="display:none;">0</span>
        </button>
        <div class="card-label">Total GAP</div>
        <span class="card-tip-text">The gap between Target and Online Riders. Calculated as Target − Online Riders.</span>
        <div class="card-value">457</div>
        <div class="card-sub">Riders | Online vs Del</div>
      </div>
    </div>

    <div class="adv-legend">
      <strong>Color Legend:</strong>
      <div class="adv-legend-item"><span class="adv-legend-dot dot-excellent"></span> ≥95% Excellent</div>
      <div class="adv-legend-item"><span class="adv-legend-dot dot-good"></span> 90-94.9% Good</div>
      <div class="adv-legend-item"><span class="adv-legend-dot dot-warning"></span> 85-89.9% Warning</div>
      <div class="adv-legend-item"><span class="adv-legend-dot dot-critical"></span> <85% Critical</div>
    </div>

    <div class="adv-table-container commentable-section">
      <button class="comment-indicator" onclick="openComments('totalOverview-table')" title="Comment on Performance Summary">
        💬
        <span class="comment-indicator-badge" id="badge-totalOverview-table" style="display:none;">0</span>
      </button>
      <div class="adv-table-title">📈 Overall Performance Summary</div>
      <div class="adv-table-wrap">
        <table class="adv-table" id="totalOverviewTable">
          <thead>
            <tr>
              <th>Metric</th>
              <th>MTD</th>
              <th>W1 (Feb 1-7)</th>
              <th>W2 (Feb 8-14)</th>
              <th class="adv-daily-cols">Day 17</th>
              <th class="adv-daily-cols">Day 16</th>
              <th class="adv-daily-cols">Day 15</th>
              <th class="adv-daily-cols">Day 14</th>
              <th class="adv-daily-cols">Day 13</th>
              <th class="adv-daily-cols">Day 12</th>
              <th class="adv-daily-cols">Day 11</th>
              <th class="adv-daily-cols">Day 10</th>
              <th class="adv-daily-cols">Day 9</th>
              <th class="adv-daily-cols">Day 8</th>
              <th class="adv-daily-cols">Day 7</th>
              <th class="adv-daily-cols">Day 6</th>
              <th class="adv-daily-cols">Day 5</th>
              <th class="adv-daily-cols">Day 4</th>
              <th class="adv-daily-cols">Day 3</th>
              <th class="adv-daily-cols">Day 2</th>
              <th class="adv-daily-cols">Day 1</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Target</td>
              <td class="period-col">19,455</td>
              <td class="period-col">19,455</td>
              <td class="period-col">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
              <td class="adv-daily-cols">19,455</td>
            </tr>
            <tr>
              <td>Online Riders</td>
              <td class="period-col">18,556</td>
              <td class="period-col">18,466</td>
              <td class="period-col">18,341</td>
              <td class="adv-daily-cols">19,494</td>
              <td class="adv-daily-cols">18,373</td>
              <td class="adv-daily-cols">18,443</td>
              <td class="adv-daily-cols">18,147</td>
              <td class="adv-daily-cols">18,294</td>
              <td class="adv-daily-cols">18,250</td>
              <td class="adv-daily-cols">18,258</td>
              <td class="adv-daily-cols">10,115</td>
              <td class="adv-daily-cols">18,192</td>
              <td class="adv-daily-cols">18,293</td>
              <td class="adv-daily-cols">18,326</td>
              <td class="adv-daily-cols">18,465</td>
              <td class="adv-daily-cols">18,480</td>
              <td class="adv-daily-cols">18,515</td>
              <td class="adv-daily-cols">18,300</td>
              <td class="adv-daily-cols">18,344</td>
              <td class="adv-daily-cols">18,570</td>
              <td class="adv-daily-cols">17,909</td>
            </tr>
            <tr>
              <td>Delivery Riders</td>
              <td class="period-col">18,081</td>
              <td class="period-col">17,975</td>
              <td class="period-col">17,959</td>
              <td class="adv-daily-cols">18,124</td>
              <td class="adv-daily-cols">18,177</td>
              <td class="adv-daily-cols">18,202</td>
              <td class="adv-daily-cols">17,601</td>
              <td class="adv-daily-cols">17,935</td>
              <td class="adv-daily-cols">17,885</td>
              <td class="adv-daily-cols">17,900</td>
              <td class="adv-daily-cols">17,510</td>
              <td class="adv-daily-cols">17,677</td>
              <td class="adv-daily-cols">17,920</td>
              <td class="adv-daily-cols">17,941</td>
              <td class="adv-daily-cols">18,178</td>
              <td class="adv-daily-cols">18,268</td>
              <td class="adv-daily-cols">18,221</td>
              <td class="adv-daily-cols">17,732</td>
              <td class="adv-daily-cols">17,810</td>
              <td class="adv-daily-cols">17,909</td>
              <td class="adv-daily-cols">17,909</td>
            </tr>
            <tr>
              <td><strong>Achievement %</strong></td>
              <td class="period-col val-good">92.9%</td>
              <td class="period-col val-good">92.4%</td>
              <td class="period-col val-good">92.3%</td>
              <td class="adv-daily-cols val-good">93.2%</td>
              <td class="adv-daily-cols val-good">93.4%</td>
              <td class="adv-daily-cols val-good">93.6%</td>
              <td class="adv-daily-cols val-good">90.5%</td>
              <td class="adv-daily-cols val-good">92.2%</td>
              <td class="adv-daily-cols val-good">91.9%</td>
              <td class="adv-daily-cols val-good">92.0%</td>
              <td class="adv-daily-cols val-good">90.0%</td>
              <td class="adv-daily-cols val-good">90.9%</td>
              <td class="adv-daily-cols val-good">92.1%</td>
              <td class="adv-daily-cols val-good">92.2%</td>
              <td class="adv-daily-cols val-good">93.4%</td>
              <td class="adv-daily-cols val-good">93.9%</td>
              <td class="adv-daily-cols val-good">93.7%</td>
              <td class="adv-daily-cols val-good">91.1%</td>
              <td class="adv-daily-cols val-good">91.5%</td>
              <td class="adv-daily-cols val-good">92.1%</td>
              <td class="adv-daily-cols val-good">92.1%</td>
            </tr>
            <tr>
              <td><strong>Gap</strong></td>
              <td class="period-col">899</td>
              <td class="period-col">989</td>
              <td class="period-col">1,114</td>
              <td class="adv-daily-cols">-39</td>
              <td class="adv-daily-cols">1,082</td>
              <td class="adv-daily-cols">1,012</td>
              <td class="adv-daily-cols">1,308</td>
              <td class="adv-daily-cols">1,161</td>
              <td class="adv-daily-cols">1,205</td>
              <td class="adv-daily-cols">1,197</td>
              <td class="adv-daily-cols">1,340</td>
              <td class="adv-daily-cols">1,263</td>
              <td class="adv-daily-cols">1,162</td>
              <td class="adv-daily-cols">1,129</td>
              <td class="adv-daily-cols">990</td>
              <td class="adv-daily-cols">975</td>
              <td class="adv-daily-cols">940</td>
              <td class="adv-daily-cols">1,155</td>
              <td class="adv-daily-cols">1,111</td>
              <td class="adv-daily-cols">885</td>
              <td class="adv-daily-cols">885</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="adv-expand-btn" onclick="toggleDailyExpand('totalOverviewTable')">📅 Expand Daily View</button>
    </div>

    <div class="adv-highlight-box amber">
      <strong>📊 Key Insights:</strong> MTD achievement at 93.1% remains below the 100% target, showing a slight decline from previous levels. Performance imbalance across weeks: W1 at 92.5% and W2 at 92.4% indicates consistent underperformance with W2 trending lower. Day 1 shows highest GAP (1,370 riders) due to online spike. Daily achievement ranges 90.1%-94.0% - improvement urgently needed to reach ≥95% target. Day 16 at 91.7% continues the below-target trend with GAP increasing to 534 riders.
    </div>

    <div class="commentable-section">
      <button id="comment-indicator-totalOverview-chart" class="comment-indicator" onclick="openComments('totalOverview-chart')" title="Add Comment">
        💬 <span id="badge-totalOverview-chart" class="comment-count-badge"></span>
      </button>
      <details class="adv-chart-details" id="totalOverviewChartDetails">
        <summary>📈 Daily Achievement Trend Chart</summary>
        <div class="adv-chart-wrap">
          <div class="adv-chart-canvas"><canvas id="totalOverviewChart"></canvas></div>
        </div>
      </details>
    </div>
  </div>

  <!-- PARTNERS STRATIFICATION SECTION -->
  <div id="partnersStratContent" class="adv-content-box commentable-section">
    <button id="comment-indicator-partnersStrat" class="comment-indicator" onclick="openComments('partnersStrat')" title="Add Comment">
      💬 <span id="badge-partnersStrat" class="comment-count-badge"></span>
    </button>
    <h3 style="margin:0 0 16px 0; font-size:18px; color:#0d47a1; font-weight:700;">👥 Partners Stratification</h3>
    <div class="adv-sub-slicer">
      <button class="adv-sub-btn active" data-cat="good" onclick="switchPartnerCat('good', this)">✅ Good Partners</button>
      <button class="adv-sub-btn" data-cat="average" onclick="switchPartnerCat('average', this)">⚠️ Average Partners</button>
      <button class="adv-sub-btn" data-cat="bad" onclick="switchPartnerCat('bad', this)">❌ Bad Partners</button>
      <button class="adv-sub-btn" data-cat="inc20" onclick="switchPartnerCat('inc20', this)">📈 Increase >20</button>
      <button class="adv-sub-btn" data-cat="inc1020" onclick="switchPartnerCat('inc1020', this)">📊 Increase 10-20</button>
      <button class="adv-sub-btn" data-cat="inc110" onclick="switchPartnerCat('inc110', this)">📉 Increase 1-10</button>
      <button class="adv-sub-btn" data-cat="inc0" onclick="switchPartnerCat('inc0', this)">↔️ Others (≤0)</button>
    </div>

    <div id="partnerCatContent"></div>
  </div>

  <!-- CITY LEVEL DATA SECTION -->
  <div id="cityLevelContent" class="adv-content-box commentable-section">
    <button id="comment-indicator-cityLevel" class="comment-indicator" onclick="openComments('cityLevel')" title="Add Comment">
      💬 <span id="badge-cityLevel" class="comment-count-badge"></span>
    </button>
    <h3 style="margin:0 0 16px 0; font-size:18px; color:#0d47a1; font-weight:700;">🏙️ City Level Data</h3>
    <div class="adv-sub-slicer">
      <button class="adv-sub-btn active" data-city="gap" onclick="switchCityMetric('gap', this)">📉 GAP % (Del vs Capacity)</button>
      <button class="adv-sub-btn" data-city="ach" onclick="switchCityMetric('ach', this)">📊 Achievement Rate</button>
    </div>

    <div id="cityMetricContent"></div>
  </div>
</div>

<script>
// Data storage
var advDataLoaded = false;

function switchAdvSection(section, btn) {
  document.querySelectorAll('.adv-toggle-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.adv-content-box').forEach(box=>box.classList.remove('active'));
  document.getElementById(section+'Content').classList.add('active');
  
  if(!advDataLoaded) {
    advDataLoaded = true;
    initAdvCharts();
    renderPartnerCat('good');
    renderCityMetric('gap');
  } else if(section === 'partnersStrat') {
    // Find which partner category button is currently active
    var activePartnerBtn = document.querySelector('#partnersStratContent .adv-sub-btn.active');
    var activeCat = activePartnerBtn ? activePartnerBtn.getAttribute('data-cat') : 'good';
    console.log('🔄 Restoring partner category:', activeCat);
    renderPartnerCat(activeCat);
  } else if(section === 'cityLevel') {
    // Find which city metric button is currently active
    var activeCityBtn = document.querySelector('#cityLevelContent .adv-sub-btn.active');
    var activeMetric = activeCityBtn ? activeCityBtn.getAttribute('data-city') : 'gap';
    renderCityMetric(activeMetric);
  }
}

function toggleDailyExpand(tableId) {
  var table = document.getElementById(tableId);
  var dailyCols = table.querySelectorAll('.adv-daily-cols');
  var isExpanded = dailyCols[0].classList.contains('expanded');
  
  dailyCols.forEach(col => {
    if(isExpanded) {
      col.classList.remove('expanded');
    } else {
      col.classList.add('expanded');
    }
  });
  
  var btn = table.parentElement.querySelector('.adv-expand-btn');
  btn.textContent = isExpanded ? '📅 Expand Daily View' : '📅 Collapse Daily View';
}

function switchPartnerCat(cat, btn) {
  document.querySelectorAll('#partnersStratContent .adv-sub-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderPartnerCat(cat);
}

function switchCityMetric(metric, btn) {
  document.querySelectorAll('#cityLevelContent .adv-sub-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCityMetric(metric);
}

function getColorClass(val) {
  var v = parseFloat(val);
  if(v >= 95) return 'val-excellent';
  if(v >= 90) return 'val-good';
  if(v >= 85) return 'val-warning';
  return 'val-critical';
}

function getGapColorClass(val) {
  var v = Math.abs(parseFloat(val));
  if(v <= 1.0) return 'val-excellent';
  if(v <= 2.0) return 'val-good';
  if(v <= 3.0) return 'val-warning';
  return 'val-critical';
}

function getDailyFlagIndexes(values, mode) {
    if(!Array.isArray(values) || values.length === 0) return {};

    var clean = values.map(function(v) {
        var n = parseFloat(v);
        return isNaN(n) ? null : n;
    });

    var valid = clean.filter(function(v) { return v !== null; });
    if(valid.length === 0) return {};

    var avg = valid.reduce(function(a, b) { return a + b; }, 0) / valid.length;
    var avgAbs = valid.reduce(function(a, b) { return a + Math.abs(b); }, 0) / valid.length;
    var candidates = [];

    for(var i=0; i<clean.length; i++) {
        var v = clean[i];
        if(v === null) continue;

        var severity = 0;
        if(mode === 'high') {
            severity = v - avg;
        } else if(mode === 'abs-high') {
            severity = Math.abs(v) - avgAbs;
        } else {
            severity = avg - v;
        }

        if(severity > 0) {
            candidates.push({ idx: i, score: severity, value: v });
        }
    }

    if(candidates.length === 0) return {};

    candidates.sort(function(a, b) {
        if(b.score !== a.score) return b.score - a.score;
        if(mode === 'low') return a.value - b.value;
        if(mode === 'high') return b.value - a.value;
        return Math.abs(b.value) - Math.abs(a.value);
    });

    var dynamicMax = Math.max(1, Math.round(valid.length * 0.2));
    var maxFlags = Math.min(4, dynamicMax);
    var chosen = candidates.slice(0, Math.min(maxFlags, candidates.length));
    var flagged = {};
    chosen.forEach(function(item) { flagged[item.idx] = true; });
    return flagged;
}

function getAchievementFlagClass(value) {
    var v = parseFloat(value);
    if (isNaN(v)) return 'flag-light';
    if (v < 85) return 'flag-high';
    return 'flag-light';
}

function getGapFlagClass(value) {
    var v = Math.abs(parseFloat(value));
    if (isNaN(v)) return 'flag-light';
    if (v > 3.0) return 'flag-high';
    return 'flag-light';
}

function getBreakdownFlagClass(pct, isNegRow) {
    var v = parseFloat(pct);
    if (isNaN(v)) return 'flag-light';
    if (isNegRow) {
        return v > 20 ? 'flag-high' : 'flag-light';
    }
    return v < 40 ? 'flag-high' : 'flag-light';
}

var advChartInited = false;
var totalOverviewChartInstance = null;

function initAdvCharts() {
  var ctx = document.getElementById('totalOverviewChart');
  if(!ctx) return;
  
  // Destroy existing chart if it exists
  if (totalOverviewChartInstance) {
    totalOverviewChartInstance.destroy();
  }
  
  advChartInited = true;
  ctx = ctx.getContext('2d');
  
  // Use Google Sheets data if available, otherwise use hardcoded fallback
  var chartData = [93.3,93.6,93.7,90.6,92.3,92.0,92.1,90.1,91.0,92.2,92.3,93.6,94.0,93.8,91.3,91.7];
  var chartNumDays = 16;
  
  if (sheetDataCache && sheetDataCache.totalOverview && sheetDataCache.totalOverview.achievementDaily) {
    chartData = sheetDataCache.totalOverview.achievementDaily.map(function(v) {
      return parseFloat(v.toString().replace('%', ''));
    }).slice().reverse();
    chartNumDays = chartData.length;
  }
  
  totalOverviewChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: generateDayLabels(chartNumDays),
      datasets: [{
        label: 'Achievement %',
        data: chartData,
        borderColor: '#1976d2',
        backgroundColor: 'rgba(25,118,210,0.1)',
        tension: 0.3,
        fill: true,
        borderWidth: 3,
        pointRadius: 4,
        pointBackgroundColor: '#1976d2'
      },{
        label: '95% Target',
        data: Array(chartNumDays).fill(95),
        borderColor: '#2e7d32',
        borderWidth: 2,
        borderDash: [5,5],
        pointRadius: 0,
        fill: false
      },{
        label: '90% threshold',
        data: Array(chartNumDays).fill(90),
        borderColor: '#f57c00',
        borderWidth: 2,
        borderDash: [5,5],
        pointRadius: 0,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false },
        datalabels: {
          display: function(ctx) { return ctx.datasetIndex === 0; },
          anchor: 'end',
          align: 'top',
          offset: 4,
          color: '#1565c0',
          font: { weight: 'bold', size: 10 },
          formatter: function(v) { return v.toFixed(1) + '%'; }
        }
      },
      scales: {
        y: { beginAtZero: false, min: 85, max: 105, ticks: { callback: v=>v+'%' } }
      }
    }
  });
}

// ============== GOOGLE SHEETS INTEGRATION ==============
var SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOw50dUYapa3fCtvsW_dxvCQ-eqBymvrTymNJuv82imwbGhdfFu4kHJogQmyQLwOgAY9tGhAx6gbri/pub?output=csv';
var sheetDataCache = null;
var lastFetchTime = null;
var numDaysAvailable = 16; // Default to 16, will be updated from sheet data

// Update sync status UI
function updateSyncStatus(status, message, time) {
  var banner = document.getElementById('syncBanner');
  var icon = document.getElementById('syncIcon');
  var statusText = document.getElementById('syncStatus');
  var timeText = document.getElementById('syncTime');
  
  if (status === 'syncing') {
    banner.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
    banner.style.borderColor = '#ff9800';
    icon.innerHTML = '⏳';
    statusText.innerHTML = message || 'Syncing with Google Sheets...';
    statusText.style.color = '#e65100';
  } else if (status === 'success') {
    banner.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
    banner.style.borderColor = '#66bb6a';
    icon.innerHTML = '✅';
    statusText.innerHTML = message || 'Connected to Google Sheets';
    statusText.style.color = '#2e7d32';
    if (time) timeText.innerHTML = 'Last updated: ' + time;
  } else if (status === 'error') {
    banner.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
    banner.style.borderColor = '#ef5350';
    icon.innerHTML = '⚠️';
    statusText.innerHTML = message || 'Error syncing data';
    statusText.style.color = '#c62828';
  }
}

// Parse CSV text into array of rows
function parseCSV(csvText) {
  var rows = [];
  var lines = csvText.trim().split('\n');
  for (var i = 0; i < lines.length; i++) {
    var cells = lines[i].split(',');
    rows.push(cells.map(function(cell) { return cell.trim(); }));
  }
  return rows;
}

// Helper: Extract all available daily values from row starting at column 8
function extractDailyValues(row, startCol) {
  var values = [];
  var emptyCount = 0;
  var maxEmptyBeforeStop = 3; // Allow up to 3 consecutive empty cells
  
  // Skip initial empty cells and find where data actually starts
  var actualStart = startCol;
  for (var i = startCol; i < row.length && i < startCol + 5; i++) {
    if (row[i] !== '' && row[i] !== undefined && row[i] !== null) {
      actualStart = i;
      break;
    }
  }
  
  // Extract data, allowing for some empty cells in between
  for (var i = actualStart; i < row.length; i++) {
    if (row[i] === '' || row[i] === undefined || row[i] === null) {
      emptyCount++;
      if (emptyCount >= maxEmptyBeforeStop) break; // Stop after consecutive empties
    } else {
      emptyCount = 0; // Reset counter when we find data
      values.push(row[i]);
    }
  }
  
  console.log('📊 Extracted', values.length, 'daily values from column', actualStart);
  return values;
}

// Helper: Generate dynamic day labels for charts
function generateDayLabels(numDays) {
  var labels = [];
  for (var i = 1; i <= numDays; i++) {
    labels.push('Day ' + i);
  }
  return labels;
}

// Helper: Generate short day labels for charts (D1, D2, etc.)
function generateShortDayLabels(numDays) {
  var labels = [];
  for (var i = 1; i <= numDays; i++) {
    labels.push('D' + i);
  }
  return labels;
}

// Helper: Format number with commas
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Parse the sheet rows into dashboard data structure
function parseSheetData(rows) {
  console.log('📊 Parsing sheet data, total rows:', rows ? rows.length : 0);
  if (!rows || rows.length < 80) {
    console.error('❌ Insufficient data rows. Expected at least 80, got:', rows ? rows.length : 0);
    return null;
  }
  
  try {
  
  var data = {
    totalOverview: {},
    partners: {
      good: {},
      avg: {},
      bad: {},
      inc20: {},
      inc1020: {},
      inc110: {},
      inc0: {}
    },
    cities: {
      gap: {},
      achievement: {}
    }
  };
  
    // Parse Total Overview (rows 3-7, 0-indexed)
    console.log('📈 Parsing Total Overview...');
    var totalRow = rows[3];
    if (!totalRow || totalRow.length < 10) {
      console.error('❌ Invalid totalRow:', totalRow);
      return null;
    }
    // Target row has extra "Total target" label in col[3], so MTD is col[4]
    data.totalOverview.targetMTD = totalRow[4];
    data.totalOverview.targetW1 = totalRow[5];
    data.totalOverview.targetW2 = totalRow[5]; // W2 same as W1 for target
    data.totalOverview.targetDaily = extractDailyValues(totalRow, 9);
    
    // Determine number of days from the first data row
    numDaysAvailable = data.totalOverview.targetDaily.length;
    data.numDays = numDaysAvailable;
    console.log('✅ Total Overview parsed. Days available:', numDaysAvailable);
  
  var achieveOnlineRow = rows[4];
  data.totalOverview.onlineMTD = achieveOnlineRow[3];
  data.totalOverview.onlineW1 = achieveOnlineRow[4];
  data.totalOverview.onlineW2 = achieveOnlineRow[5];
  data.totalOverview.onlineDaily = extractDailyValues(achieveOnlineRow, 9);
  
  var achieveDeliveryRow = rows[5];
  data.totalOverview.deliveryMTD = achieveDeliveryRow[3];
  data.totalOverview.deliveryW1 = achieveDeliveryRow[4];
  data.totalOverview.deliveryW2 = achieveDeliveryRow[5];
  data.totalOverview.deliveryDaily = extractDailyValues(achieveDeliveryRow, 9);
  
  var achievementRateRow = rows[6];
  data.totalOverview.achievementDaily = extractDailyValues(achievementRateRow, 9);
  data.totalOverview.mtd = achievementRateRow[3];
  data.totalOverview.w1 = achievementRateRow[4];
  data.totalOverview.w2 = achievementRateRow[5];
  
  var gapRow = rows[7];
  data.totalOverview.gapMTD = gapRow[3];
  data.totalOverview.gapW1 = gapRow[4];
  data.totalOverview.gapW2 = gapRow[5];
  data.totalOverview.gapDaily = extractDailyValues(gapRow, 9);
  
        // Parse Partners Stratification (dynamic row detection to survive sheet row inserts)
        console.log('👥 Parsing Partners Stratification...');
        function norm(v) { return String(v || '').toLowerCase().replace(/\s+/g, ' ').trim(); }
        function findCategoryStart(labelKey) {
            var key = norm(labelKey);
            for (var r = 0; r < rows.length; r++) {
                var col1 = norm(rows[r] && rows[r][1]);
                var col2 = norm(rows[r] && rows[r][2]);
                if (col1.indexOf(key) !== -1 && col2.indexOf('total target') !== -1) {
                    return r;
                }
            }
            return -1;
        }

        var partnerStarts = {
            good: findCategoryStart('good partners'),
            avg: findCategoryStart('average partners'),
            bad: findCategoryStart('bad partners'),
            inc20: findCategoryStart('increase >20'),
            inc1020: findCategoryStart('increase 10-20'),
            inc110: (function(){
                var idx = findCategoryStart('increase >=1 - <=10');
                if (idx === -1) idx = findCategoryStart('increase 1-10');
                return idx;
            })(),
            inc0: (function(){
                var idx = findCategoryStart('others (<=0)');
                if (idx === -1) idx = findCategoryStart('others ≤0');
                return idx;
            })()
        };

        parsePartnerCategory(rows, partnerStarts.good !== -1 ? partnerStarts.good : 8, data.partners.good, '✅ Good Partners');
        parsePartnerCategory(rows, partnerStarts.avg !== -1 ? partnerStarts.avg : 19, data.partners.avg, '⚡ Average Partners');
        parsePartnerCategory(rows, partnerStarts.bad !== -1 ? partnerStarts.bad : 30, data.partners.bad, '❌ Bad Partners');
        parsePartnerCategory(rows, partnerStarts.inc20 !== -1 ? partnerStarts.inc20 : 41, data.partners.inc20, '📈 Increase >20%');
        parsePartnerCategory(rows, partnerStarts.inc1020 !== -1 ? partnerStarts.inc1020 : 52, data.partners.inc1020, '📊 Increase 10-20%');
        parsePartnerCategory(rows, partnerStarts.inc110 !== -1 ? partnerStarts.inc110 : 63, data.partners.inc110, '📉 Increase 1-10%');
        parsePartnerCategory(rows, partnerStarts.inc0 !== -1 ? partnerStarts.inc0 : 74, data.partners.inc0, '🔻 Others (≤0%)');
  
  console.log('🏙️ Parsing City Level Data...');
    // Parse City Level Data with dynamic section anchors
  var cityNames = ['Al Ahsa', 'Dammam', 'Hafar Albatin', 'Jubail', 'Riyadh', 'Al Kharj', 
                   'Buraydah', 'Hail', 'Jeddah', 'Madinah', 'Tabuk', 'Yanbu', 
                   'Abha', 'Jazan', 'Makkah', 'Najran', 'Taif'];
  
    function normCity(s) { return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim(); }
    function findCityRowByName(name) {
        var n = normCity(name);
        for (var r = 0; r < rows.length; r++) {
            if (normCity(rows[r] && rows[r][2]) === n) return r;
        }
        return -1;
    }

    var citySectionStart = -1;
    for (var i = 0; i < rows.length; i++) {
        if (normCity(rows[i] && rows[i][0]) === 'city level data') {
            citySectionStart = i;
            break;
        }
    }

    if (citySectionStart !== -1) {
        // GAP rows start at citySectionStart (first row already contains Al Ahsa)
        for (var c = 0; c < cityNames.length; c++) {
            var cityRow = rows[citySectionStart + c];
            if (!cityRow) continue;
            if (!data.cities.gap[cityNames[c]]) data.cities.gap[cityNames[c]] = {};
            data.cities.gap[cityNames[c]].mtd = cityRow[3];
            data.cities.gap[cityNames[c]].w1 = cityRow[4];
            data.cities.gap[cityNames[c]].w2 = cityRow[5];
            data.cities.gap[cityNames[c]].daily = extractDailyValues(cityRow, 8);
        }

        // Achievement block starts where col1 has achievement label and col2 matches first city
        var achStart = -1;
        for (var r = citySectionStart; r < rows.length; r++) {
            var col1 = normCity(rows[r] && rows[r][1]);
            var col2 = normCity(rows[r] && rows[r][2]);
            if (col1.indexOf('ach') !== -1 && col2 === normCity(cityNames[0])) {
                achStart = r;
                break;
            }
        }
        if (achStart === -1) {
            // Safe fallback: 17 GAP rows after citySectionStart
            achStart = citySectionStart + 17;
        }
        console.log('🔍 City Achievement achStart:', achStart, 'finder matched:', achStart !== citySectionStart + 17);

        for (var c = 0; c < cityNames.length; c++) {
            var cityRowAch = rows[achStart + c];
            if (!cityRowAch) continue;
            if (!data.cities.achievement[cityNames[c]]) data.cities.achievement[cityNames[c]] = {};
            data.cities.achievement[cityNames[c]].mtd = cityRowAch[3];
            data.cities.achievement[cityNames[c]].w1 = cityRowAch[4];
            data.cities.achievement[cityNames[c]].w2 = cityRowAch[5];
            data.cities.achievement[cityNames[c]].daily = extractDailyValues(cityRowAch, 8);
            if (c === 0) {
                console.log('🔍 City Achievement Daily Values for', cityNames[c], ':', data.cities.achievement[cityNames[c]].daily.length, 'days');
            }
        }
    }
  
  console.log('✅ Sheet data parsed successfully!');
  return data;
  
  } catch (error) {
    console.error('❌ Error parsing sheet data:', error);
    console.error('Error stack:', error.stack);
    return null;
  }
}

// Helper to parse a partner category section
function parsePartnerCategory(rows, startRow, category, titlePrefix) {
  console.log('🔍 Parsing category at row', startRow, ':', titlePrefix);
  
  // Validate rows exist with all 11 rows needed
  for (var i = 0; i < 11; i++) {
    if (!rows[startRow + i] || rows[startRow + i].length < 4) {
      console.error('❌ Invalid row at index', startRow + i, '- row:', rows[startRow + i]);
      return;
    }
  }
  
  var targetRow = rows[startRow];
  var numPartnersRow = rows[startRow + 1];
  var onlineRow = rows[startRow + 2];
  var deliveryRow = rows[startRow + 3];
  var achievementRow = rows[startRow + 4];
  var gapRow = rows[startRow + 5];
  var rate100Row = rows[startRow + 6];
  var rate95Row = rows[startRow + 7];
  var rate90Row = rows[startRow + 8];
  var rate80Row = rows[startRow + 9];
  var rateLess80Row = rows[startRow + 10];
  
  console.log('✅ Category rows validated, numPartners:', numPartnersRow[3]);
  
  function toNum(v) { var n = parseFloat(String(v).replace(/,/g,'')); return isNaN(n) ? 0 : n; }
  function toNumArr(arr) { return arr.map(toNum); }

  category.title = titlePrefix + ' (' + numPartnersRow[3] + ')';
  category.target = toNum(targetRow[3]);
  category.mtd = toNum(achievementRow[3]);
  category.w1 = toNum(achievementRow[4]);
  category.w2 = toNum(achievementRow[5]);
  category.gapValue = toNum(gapRow[3]);
  category.daily = extractDailyValues(achievementRow, 9).map(toNum);
  
  console.log('📊', titlePrefix, '- Daily values extracted:', category.daily.length);
  
  // Breakdown arrays (19 elements: MTD, W1, W2, then daily values) — all converted to numbers
  category.targetValues = toNumArr([targetRow[3], targetRow[4], targetRow[5]].concat(extractDailyValues(targetRow, 9)));
  category.numPartners = toNumArr([numPartnersRow[3], numPartnersRow[4], numPartnersRow[5]].concat(extractDailyValues(numPartnersRow, 9)));
  category.deliveryRiders = toNumArr([deliveryRow[3], deliveryRow[4], deliveryRow[5]].concat(extractDailyValues(deliveryRow, 9)));
  category.onlineRiders = toNumArr([onlineRow[3], onlineRow[4], onlineRow[5]].concat(extractDailyValues(onlineRow, 9)));
  category.achievementRate = toNumArr([achievementRow[3], achievementRow[4], achievementRow[5]].concat(extractDailyValues(achievementRow, 9)));
  category.gapArray = toNumArr([gapRow[3], gapRow[4], gapRow[5]].concat(extractDailyValues(gapRow, 9)));
  
  // Performance tiers — all converted to numbers
  category.rate100 = toNumArr([rate100Row[3], rate100Row[4], rate100Row[5]].concat(extractDailyValues(rate100Row, 9)));
  category.rate95 = toNumArr([rate95Row[3], rate95Row[4], rate95Row[5]].concat(extractDailyValues(rate95Row, 9)));
  category.rate90 = toNumArr([rate90Row[3], rate90Row[4], rate90Row[5]].concat(extractDailyValues(rate90Row, 9)));
  category.rate80 = toNumArr([rate80Row[3], rate80Row[4], rate80Row[5]].concat(extractDailyValues(rate80Row, 9)));
  category.rateLess80 = toNumArr([rateLess80Row[3], rateLess80Row[4], rateLess80Row[5]].concat(extractDailyValues(rateLess80Row, 9)));
  
  console.log('✅', titlePrefix, 'parsed successfully');
}

// Fetch data from Google Sheets
function fetchSheetData(callback) {
  console.log('🔄 Starting Google Sheets fetch...');
  // Add cache-busting parameter to force fresh data
  var cacheBustUrl = SHEET_CSV_URL + '&t=' + Date.now();
  console.log('📍 URL:', cacheBustUrl);
  updateSyncStatus('syncing', 'Fetching data from Google Sheets...');
  
  fetch(cacheBustUrl)
    .then(function(response) {
      console.log('📡 Fetch response status:', response.status, response.statusText);
      if (!response.ok) throw new Error('Failed to fetch sheet: ' + response.status);
      return response.text();
    })
    .then(function(csvText) {
      console.log('📄 CSV received, length:', csvText.length, 'chars');
      var rows = parseCSV(csvText);
      console.log('📋 CSV parsed into', rows.length, 'rows');
      var parsedData = parseSheetData(rows);
      if (parsedData) {
        console.log('✅ Data parsing successful!');
        sheetDataCache = parsedData;
        lastFetchTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        updateSyncStatus('success', 'Data synced successfully', lastFetchTime);
      } else {
        console.error('❌ Data parsing returned null');
        updateSyncStatus('error', 'Failed to parse data - check console for details');
      }
      if (callback) callback(parsedData);
    })
    .catch(function(error) {
      console.error('❌ Google Sheets fetch error:', error);
      console.error('Error details:', error.message);
      updateSyncStatus('error', 'Failed to sync - using fallback data');
      if (callback) callback(null);
    });
}

// Render Total Overview Table from sheet data
function renderTotalOverviewTable() {
  if (!sheetDataCache || !sheetDataCache.totalOverview) {
    console.warn('⚠️ No sheet data available for Total Overview table');
    return;
  }
  
  var tov = sheetDataCache.totalOverview;
  var numDays = tov.targetDaily ? tov.targetDaily.length : 16;
  
  // Get table and check expanded state
  var table = document.getElementById('totalOverviewTable');
  if (!table) return;
  
  var wasExpanded = false;
  var firstDailyCol = table.querySelector('.adv-daily-cols');
  wasExpanded = firstDailyCol && firstDailyCol.classList.contains('expanded');
  
  // Render thead with dynamic day columns
  var thead = table.querySelector('thead');
  var theadHtml = '<tr><th>Metric</th><th>MTD</th><th>W1 (Feb 1-7)</th><th>W2 (Feb 8-14)</th>';
  for (var i = numDays; i >= 1; i--) {
    theadHtml += '<th class="adv-daily-cols">Day ' + i + '</th>';
  }
  theadHtml += '</tr>';
  thead.innerHTML = theadHtml;
  
  // Render tbody
  var tbody = table.querySelector('tbody');
  
  function fmt(val) {
    if (!val && val !== 0) return '-';
    var s = String(val).replace('%', '');
    if (s.match(/^\d+$/)) return parseInt(s).toLocaleString();
    if (s.match(/^\d+\.\d+$/)) return parseFloat(s).toLocaleString();
    return val;
  }
  
  function fmtPct(val) {
    var v = parseFloat(String(val).replace('%', ''));
    return isNaN(v) ? '-' : v.toFixed(1) + '%';
  }

    function fmtTrendPct(curr, prev, label) {
        if (isNaN(curr) || isNaN(prev) || prev === 0) return '';
        var delta = ((curr - prev) / Math.abs(prev)) * 100;
        if (!isFinite(delta)) return '';
        var cls = delta > 0 ? 'up' : (delta < 0 ? 'down' : 'flat');
        var arrow = delta > 0 ? '▲' : (delta < 0 ? '▼' : '▶');
        return '<span class="ach-trend ' + cls + '">' + arrow + ' ' + Math.abs(delta).toFixed(1) + '% ' + label + '</span>';
    }
  
  // Achievement daily flag indexes (worst cells)
  var achDailyVals = (tov.achievementDaily || []).map(function(v){ return parseFloat(String(v).replace('%','')); });
  var achFlags = getDailyFlagIndexes(achDailyVals, 'low');
  
  // Gap daily flag indexes (worst cells - highest absolute gap)
  var gapDailyVals = (tov.gapDaily || []).map(function(v){ return parseFloat(String(v).replace(/[%,]/g,'')); });
  var gapFlags = getDailyFlagIndexes(gapDailyVals, 'abs-high');
  
  var html = '';
  
  // Row 1: Target
  html += '<tr><td>Target</td>';
  html += '<td class="period-col">' + fmt(tov.targetMTD) + '</td>';
  html += '<td class="period-col">' + fmt(tov.targetW1) + '</td>';
  html += '<td class="period-col">' + fmt(tov.targetW2) + '</td>';
  for (var i = 0; i < numDays; i++) {
    html += '<td class="adv-daily-cols">' + fmt(tov.targetDaily[i]) + '</td>';
  }
  html += '</tr>';
  
  // Row 2: Online Riders
  html += '<tr><td>Online Riders</td>';
    var onlineMTD = parseFloat(String(tov.onlineMTD).replace(/[%,]/g,''));
    var onlineW1 = parseFloat(String(tov.onlineW1).replace(/[%,]/g,''));
    var onlineW2 = parseFloat(String(tov.onlineW2).replace(/[%,]/g,''));
    html += '<td class="period-col">' + fmt(tov.onlineMTD) + '</td>';
    html += '<td class="period-col">' + fmt(tov.onlineW1) + '</td>';
    html += '<td class="period-col">' + fmt(tov.onlineW2) + fmtTrendPct(onlineW2, onlineW1, 'WoW') + '</td>';
  for (var i = 0; i < numDays; i++) {
        var onlineDailyVal = parseFloat(String(tov.onlineDaily[i]).replace(/[%,]/g,''));
        var prevOnlineDailyVal = (i < numDays - 1) ? parseFloat(String(tov.onlineDaily[i + 1]).replace(/[%,]/g,'')) : NaN;
        html += '<td class="adv-daily-cols">' + fmt(tov.onlineDaily[i]) + fmtTrendPct(onlineDailyVal, prevOnlineDailyVal, 'DoD') + '</td>';
  }
  html += '</tr>';
  
  // Row 3: Delivery Riders
  html += '<tr><td>Delivery Riders</td>';
    var deliveryMTD = parseFloat(String(tov.deliveryMTD).replace(/[%,]/g,''));
    var deliveryW1 = parseFloat(String(tov.deliveryW1).replace(/[%,]/g,''));
    var deliveryW2 = parseFloat(String(tov.deliveryW2).replace(/[%,]/g,''));
    html += '<td class="period-col">' + fmt(tov.deliveryMTD) + '</td>';
    html += '<td class="period-col">' + fmt(tov.deliveryW1) + '</td>';
    html += '<td class="period-col">' + fmt(tov.deliveryW2) + fmtTrendPct(deliveryW2, deliveryW1, 'WoW') + '</td>';
  for (var i = 0; i < numDays; i++) {
        var deliveryDailyVal = parseFloat(String(tov.deliveryDaily[i]).replace(/[%,]/g,''));
        var prevDeliveryDailyVal = (i < numDays - 1) ? parseFloat(String(tov.deliveryDaily[i + 1]).replace(/[%,]/g,'')) : NaN;
        html += '<td class="adv-daily-cols">' + fmt(tov.deliveryDaily[i]) + fmtTrendPct(deliveryDailyVal, prevDeliveryDailyVal, 'DoD') + '</td>';
  }
  html += '</tr>';
  
  // Row 4: Achievement %
  html += '<tr><td><strong>Achievement %</strong> <span class="row-info-icon">❗<span class="row-tip-text">Achievement %: The achievement rate from Delivery Riders ÷ Target</span></span></td>';
    var mtdAch = parseFloat(String(tov.mtd).replace('%',''));
    var w1Ach = parseFloat(String(tov.w1).replace('%',''));
    var w2Ach = parseFloat(String(tov.w2).replace('%',''));
    html += '<td class="period-col ' + getColorClass(tov.mtd) + '">' + fmtPct(tov.mtd) + '</td>';
    html += '<td class="period-col ' + getColorClass(tov.w1) + '">' + fmtPct(tov.w1) + '</td>';
    html += '<td class="period-col ' + getColorClass(tov.w2) + '">' + fmtPct(tov.w2) + fmtTrendPct(w2Ach, w1Ach, 'WoW') + '</td>';
  for (var i = 0; i < numDays; i++) {
    var achVal = parseFloat(String(tov.achievementDaily[i]).replace('%',''));
    var cls = 'adv-daily-cols ' + getColorClass(achVal);
    if (achFlags[i]) cls += ' red-flag-cell ' + getAchievementFlagClass(achVal);
        var prevAchVal = (i < numDays - 1) ? parseFloat(String(tov.achievementDaily[i + 1]).replace('%','')) : NaN;
        html += '<td class="' + cls + '">' + fmtPct(tov.achievementDaily[i]) + fmtTrendPct(achVal, prevAchVal, 'DoD') + '</td>';
  }
  html += '</tr>';
  
  // Row 5: Gap
  html += '<tr><td><strong>Gap</strong> <span class="row-info-icon">❗<span class="row-tip-text">Gap: The gap for Target − Online Riders</span></span></td>';
  html += '<td class="period-col">' + fmt(tov.gapMTD) + '</td>';
  html += '<td class="period-col">' + fmt(tov.gapW1) + '</td>';
  html += '<td class="period-col">' + fmt(tov.gapW2) + '</td>';
  for (var i = 0; i < numDays; i++) {
    var gVal = parseFloat(String(tov.gapDaily[i]).replace(/[%,]/g,''));
    var cls = 'adv-daily-cols';
    if (gapFlags[i]) cls += ' red-flag-cell ' + getGapFlagClass(gVal);
    html += '<td class="' + cls + '">' + fmt(tov.gapDaily[i]) + '</td>';
  }
  
  tbody.innerHTML = html;
  
  // Restore expanded state after re-rendering
  if (wasExpanded) {
    var dailyCols = table.querySelectorAll('.adv-daily-cols');
    dailyCols.forEach(function(col) {
      col.classList.add('expanded');
    });
    // Update button text
    var btn = table.closest('.adv-table-wrap').parentElement.querySelector('.adv-expand-btn');
    if (btn) btn.textContent = '📅 Collapse Daily View';
  }
  
  // Update summary cards from sheet data
  try {
    var cardsRow = document.querySelector('#totalOverviewContent .adv-cards-row');
    if (cardsRow) {
      var cards = cardsRow.querySelectorAll('.adv-card');
      var mtdVal = parseFloat(String(tov.mtd).replace(/[%,]/g, ''));
      var w1Val = parseFloat(String(tov.w1).replace(/[%,]/g, ''));
      var w2Val = parseFloat(String(tov.w2).replace(/[%,]/g, ''));
      var gapVal = parseFloat(String(tov.gapMTD).replace(/[%,]/g, ''));
      var targetVal = fmt(tov.targetMTD);

      function cardColor(v) { return v >= 95 ? 'green' : v >= 90 ? 'amber' : 'red'; }

      // Card 0: MTD Achievement
      if (cards[0]) {
        cards[0].className = 'adv-card ' + cardColor(mtdVal) + ' commentable-section';
        cards[0].querySelector('.card-value').textContent = mtdVal.toFixed(1) + '%';
        cards[0].querySelector('.card-sub').textContent = 'Target: ' + targetVal;
      }
      // Card 1: W1 Performance
      if (cards[1]) {
        cards[1].className = 'adv-card ' + cardColor(w1Val) + ' commentable-section';
        cards[1].querySelector('.card-value').textContent = w1Val.toFixed(1) + '%';
      }
      // Card 2: W2 Performance
      if (cards[2]) {
        cards[2].className = 'adv-card ' + cardColor(w2Val) + ' commentable-section';
        cards[2].querySelector('.card-value').textContent = w2Val.toFixed(1) + '%';
      }
      // Card 3: Total GAP
      if (cards[3]) {
        cards[3].querySelector('.card-value').textContent = isNaN(gapVal) ? fmt(tov.gapMTD) : Math.round(gapVal).toLocaleString();
      }
    }
  } catch(cardErr) {
    console.warn('⚠️ Card update failed:', cardErr);
  }

  console.log('✅ Total Overview table & cards rendered from sheet data (days: ' + numDays + ', expanded: ' + wasExpanded + ')');
}

// Manual refresh button handler
function refreshSheetData() {
  fetchSheetData(function(data) {
    if (data) {
      // Render Total Overview table
      renderTotalOverviewTable();
      
      // Reinitialize Total Overview chart with new data
      initAdvCharts();
      
      // Refresh current view
      var activeSection = document.querySelector('.adv-content-box.active');
      if (activeSection) {
        var sectionId = activeSection.id;
        if (sectionId === 'totalOverview') {
          // Total Overview already refreshed above
        } else if (sectionId === 'partnersStrat') {
          // Refresh partners stratification
          var activeCat = document.querySelector('.adv-sub-btn.active');
          if (activeCat) {
            var cat = activeCat.getAttribute('onclick').match(/'([^']+)'/)[1];
            renderPartnerCat(cat);
          }
        } else if (sectionId === 'cityLevel') {
          // Refresh city level
          var activeMetric = document.querySelector('.adv-sub-btn.active');
          if (activeMetric) {
            var metric = activeMetric.getAttribute('onclick').match(/'([^']+)'/)[1];
            renderCityMetric(metric);
          }
        }
      }
    }
  });
}

// Initialize data fetch on page load
window.addEventListener('load', function() {
  setTimeout(function() {
    fetchSheetData(function(data) {
      if (!data) return;
      // Render Total Overview table with fresh data
      renderTotalOverviewTable();
      
      // Re-render current section with fresh sheet data
      initAdvCharts();
      var activeContent = document.querySelector('.adv-content-box.active');
      if (activeContent) {
        if (activeContent.id === 'partnersStratContent') {
          var activeBtn = document.querySelector('#partnersStratContent .adv-sub-btn.active');
          var activeCat = activeBtn ? activeBtn.getAttribute('data-cat') : 'good';
          renderPartnerCat(activeCat);
        } else if (activeContent.id === 'cityLevelContent') {
          var activeBtn = document.querySelector('#cityLevelContent .adv-sub-btn.active');
          var activeMetric = activeBtn ? activeBtn.getAttribute('data-city') : 'gap';
          renderCityMetric(activeMetric);
        }
      }
    });
  }, 1000);
});

function renderPartnerCat(cat) {
  try { _renderPartnerCatInner(cat); } catch(e) {
    console.error('❌ renderPartnerCat crashed:', e);
    var el = document.getElementById('partnerCatContent');
    if(el) el.innerHTML = '<div style="padding:30px;color:#dc2626;font-weight:700;">⚠️ Render error: '+e.message+'<br><small>Check browser console for details. Try clicking Refresh Data.</small></div>';
  }
}
function _renderPartnerCatInner(cat) {
  // Start with fallback data
  var data = { good: {
    title: '✅ Good Partners (249)',
    target: '10,079',
    mtd: '94.4%',
    w1: '95.0%',
    w2: '94.2%',
    gap: '212',
    count: 249,
    insight: 'Good partners maintain strong performance above 94%, with W1 at 95.0% slightly declining to W2 at 94.2%. 43% of partners achieving ≥100%, and 81% above 90%. Only 6% fall below 80%, indicating solid fundamentals with minor decline trend.',
    data: [[10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079,10079],
           [249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249,249],
           [9725,9809,9666,10353,9779,9799,9644,9713,9708,9669,9606,9620,9634,9656,9731,9708,9707,9585,9603],
           [9513,9573,9492,9653,9690,9686,9384,9549,9550,9498,9310,9380,9474,9493,9608,9596,9584,9312,9361],
           [94.4,95.0,94.2,95.8,96.1,96.1,93.1,94.7,94.8,94.2,92.4,93.1,94.0,94.2,95.3,95.2,95.1,92.4,92.9],
           [351,270,413,-274,300,280,435,366,371,410,473,459,445,423,348,371,372,494,476]],
    breakdown: [[43,108,85,119,120,130,86,101,101,97,70,72,77,82,96,97,100,70,75],
                [64,158,136,167,175,181,131,157,151,146,113,119,130,131,156,152,154,110,132],
                [81,201,195,202,208,216,186,200,198,200,179,184,187,197,204,208,204,175,185],
                [93,232,232,232,232,233,224,234,234,232,225,228,230,231,238,233,236,226,227],
                [6,15,12,17,14,16,20,12,10,14,16,14,15,13,9,11,8,21,18]],
    daily: [95.8,96.1,96.1,93.1,94.7,94.8,94.2,92.4,93.1,94.0,94.2,95.3,95.2,95.1,92.4,92.9]
  }, average: {
    title: '⚠️ Average Partners (261)',
    target: '8,346',
    mtd: '92.0%',
    w1: '92.9%',
    w2: '91.5%',
    gap: '227',
    count: 261,
    insight: 'Average partners show declining trend from W1 (92.9%) to W2 (91.5%), dropping below target. Only 37% achieving ≥100%, with 12.5% below 80%. Performance concentration in 90-95% range suggests need for targeted improvement interventions. Day 16 at 90.3% signals continued weakness.',
    data: [[8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346,8346],
           [261,261,261,261,261,261,261,261,261,261,261,261,261,261,261,261,261,261,261],
           [7912,7993,7828,8565,7993,7997,7831,7899,7836,7831,7743,7786,7821,7805,7851,7882,7908,7796,7807],
           [7685,7751,7635,7923,7895,7883,7557,7709,7637,7653,7461,7533,7622,7602,7693,7784,7753,7527,7534],
           [92.0,92.9,91.5,94.9,94.6,94.5,90.5,92.4,91.5,91.7,89.4,90.3,91.3,91.1,92.2,93.3,92.9,90.2,90.3],
           [433,353,518,-219,353,349,515,447,510,515,603,560,525,541,495,464,438,550,539]],
    breakdown: [[37,97,80,119,116,110,64,85,95,88,54,72,74,78,94,98,91,62,71],
                [51.3,134,122,148,159,151,96,127,134,123,96,105,113,113,137,148,144,109,107],
                [68.5,179,174,184,191,191,157,180,172,176,150,161,170,173,189,189,188,166,154],
                [85.0,222,223,227,233,231,212,218,216,216,215,217,219,221,225,234,229,219,223],
                [12.5,33,32,25,24,27,41,35,38,38,36,39,33,32,30,26,26,36,31]],
    daily: [94.9,94.6,94.5,90.5,92.4,91.5,91.7,89.4,90.3,91.3,91.1,92.2,93.3,92.9,90.2,90.3]
  }, bad: {
    title: '❌ Bad Partners (20)',
    target: '370',
    mtd: '93.0%',
    w1: '92.7%',
    w2: '93.4%',
    gap: '8',
    count: 20,
    insight: 'Bad partners show improvement from W1 (92.7%) to W2 (93.4%), positive momentum. Despite "bad" classification, 56% achieve ≥100%, indicating potential for rehabilitation. Only 19.3% below 80% - relatively small absolute numbers allow focused intervention. Day 16 at 93.8% shows continued upward trajectory.',
    data: [[370,370,370,370,370,370,370,370,370,370,370,370,370,370,370,370,370,370,370],
           [20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],
           [353,355,351,374,349,352,351,355,347,354,350,343,351,351,351,356,355,352,352],
           [345,343,346,346,341,337,341,349,341,347,335,337,347,344,350,355,351,345,347],
           [93.0,92.7,93.4,93.5,92.2,91.1,92.2,94.3,92.2,93.8,90.5,91.1,93.8,93.0,94.6,95.9,94.9,93.2,93.8],
           [17,15,19,-4,21,18,19,15,23,16,20,27,19,19,19,14,15,18,18]],
    breakdown: [[56,11,10,11,14,13,11,9,9,11,8,11,10,8,10,12,12,10,7],
                [58.6,12,11,12,14,13,11,11,9,12,9,11,10,9,10,12,13,10,8],
                [73.6,15,14,16,14,14,14,15,15,15,13,12,16,13,13,15,14,13,13],
                [80.7,16,18,17,15,15,16,17,16,17,17,17,17,18,18,19,18,17,20],
                [19.3,4,2,3,5,5,4,3,4,3,3,3,3,2,2,1,2,3,0]],
    daily: [93.5,92.2,91.1,92.2,94.3,92.2,93.8,90.5,91.1,93.8,93.0,94.6,95.9,94.9,93.2,93.8]
  }, inc20: {
    title: '📈 Increase >20 (18 partners)',
    target: '612',
    mtd: '86.0%',
    w1: '57.6%',
    w2: '83.0%',
    gap: '11',
    count: 18,
    insight: 'Partners with >20 increase show remarkable recovery from W1 (57.6%) to W2 (83.0%), massive 42% improvement. Day 16 reaches 92.0%, approaching target. Only 21% achieve ≥100%, suggesting initially aggressive targets. 44% above 80% shows targets becoming more achievable with time. Notable turnaround story requires continued monitoring.',
    data: [[612,612,612,612,612,612,612,612,612,612,612,612,612,612,612,612,612,612,612],
           [18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18],
           [537,356,520,257,302,348,370,372,397,443,458,474,511,534,550,550,562,576,578],
           [526,352,508,253,299,348,364,370,396,437,440,458,500,519,544,549,547,554,563],
           [86.0,57.6,83.0,41.3,48.9,56.9,59.5,60.5,64.7,71.4,71.9,74.8,81.7,84.8,88.9,89.7,89.4,90.5,92.0],
           [90,281,117,380,335,289,267,265,240,194,179,163,126,103,87,87,75,61,59]],
    breakdown: [[21,4,5,1,4,5,5,3,3,6,3,6,6,4,5,7,5,6,7],
                [35,6,10,3,5,7,6,6,7,10,6,8,10,9,12,13,10,13,10],
                [38,7,12,3,5,7,7,7,9,10,10,10,11,13,14,14,12,13,13],
                [44,8,14,5,6,8,8,8,9,11,10,11,13,14,15,16,16,15,16],
                [56,10,4,13,12,10,9,10,9,7,7,6,5,4,3,2,2,3,2]],
    daily: [41.3,48.9,56.9,59.5,60.5,64.7,71.4,71.9,74.8,81.7,84.8,88.9,89.7,89.4,90.5,92.0]
  }, inc1020: {
    title: '📊 Increase 10-20 (19 partners)',
    target: '541',
    mtd: '85.6%',
    w1: '74.2%',
    w2: '82.2%',
    gap: '12',
    count: 19,
    insight: 'Moderate increase group shows strong improvement W1→W2 (74.2% to 82.2%), gaining 10.8 points. Day 16 reaches 86.9%, continuing positive momentum. 29% achieve ≥100%, with 61% above 80% indicates progressively manageable targets. Significant recovery trajectory warrants acknowledgment - second-best improvement story.',
    data: [[541,541,541,541,541,541,541,541,541,541,541,541,541,541,541,541,541,541,541],
           [19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19],
           [475,410,456,389,412,406,403,412,427,424,430,441,453,459,465,471,473,474,485],
           [463,401,445,385,402,397,388,408,418,411,413,426,444,441,456,467,467,459,470],
           [85.6,74.2,82.2,71.2,74.3,73.4,71.7,75.4,77.3,76.0,76.3,78.7,82.1,81.5,84.3,86.3,86.3,84.8,86.9],
           [64,131,85,152,129,135,138,129,114,117,111,100,88,82,76,70,68,67,56]],
    breakdown: [[29,5,5,5,6,5,4,6,7,5,5,2,3,3,6,8,7,5,7],
                [37,7,7,7,8,6,6,8,8,6,6,2,7,4,9,10,10,6,8],
                [48,9,12,8,9,8,8,10,11,10,10,10,12,10,13,13,14,13,13],
                [61,12,14,10,11,11,11,11,14,13,14,13,13,14,14,16,16,14,15],
                [39,7,5,9,8,8,8,8,5,6,5,6,5,5,5,3,3,5,4]],
    daily: [71.2,74.3,73.4,71.7,75.4,77.3,76.0,76.3,78.7,82.1,81.5,84.3,86.3,86.3,84.8,86.9]
  }, inc110: {
    title: '📉 Increase 1-10 (118 partners)',
    target: '4,082',
    mtd: '90.9%',
    w1: '90.7%',
    w2: '91.3%',
    gap: '72',
    count: 118,
    insight: 'Minor increase group maintains stable performance (W1: 90.7%, W2: 91.3%), slight upward trend. Day 16 at 90.5% near group average. 24% achieve ≥100%, 64% above 90%, 82% above 80%. Small target increases appear well-managed with consistent execution. Reliability in this segment noteworthy despite modest achievement levels.',
    data: [[4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082,4082],
           [118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118],
           [3784,3762,3794,3789,3744,3756,3732,3779,3767,3769,3763,3752,3780,3788,3811,3833,3833,3793,3800],
           [3713,3704,3726,3697,3718,3716,3656,3733,3715,3692,3651,3664,3713,3739,3757,3785,3775,3680,3695],
           [90.9,90.7,91.3,90.6,91.1,91.0,89.6,91.5,91.0,90.4,89.4,89.8,91.0,91.6,92.0,92.7,92.5,90.2,90.5],
           [293,320,288,293,338,326,350,303,315,313,319,330,302,294,271,249,249,289,282]],
    breakdown: [[24,28,28,25,32,35,25,26,28,27,21,25,26,31,31,32,29,22,25],
                [41,48,47,42,51,54,45,52,51,44,39,44,46,46,48,56,52,42,43],
                [64,75,74,68,75,77,73,79,77,77,66,70,76,76,74,81,78,70,70],
                [82,96,102,96,97,96,91,100,97,98,95,97,101,103,107,105,104,97,101],
                [16,19,14,19,19,19,24,15,17,17,17,18,16,14,10,13,11,19,15]],
    daily: [90.6,91.1,91.0,89.6,91.5,91.0,90.4,89.4,89.8,91.0,91.6,92.0,92.7,92.5,90.2,90.5]
  }, inc0: {
    title: '↔️ Others (≤0) (401 partners)',
    target: '14,195',
    mtd: '94.2%',
    w1: '95.2%',
    w2: '93.6%',
    gap: '362',
    count: 401,
    insight: 'Partners with flat/reduced targets show declining trend (W1: 95.2% to W2: 93.6%), -1.6 points drop. Day 16 at 91.2% continues downward trajectory, concerning pattern. 46% achieve ≥100%, highest overall. 91% above 80%. May indicate capacity adjustment or operational challenges offsetting target reduction benefit. Requires investigation despite reduced targets.',
    data: [[14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195,14195],
           [401,401,401,401,401,401,401,401,401,401,401,401,401,401,401,401,401,401,401],
           [13741,13937,13571,15059,13915,13933,13642,13731,13659,13622,13464,13525,13549,13545,13639,13626,13647,13457,13481],
           [13379,13517,13280,13789,13758,13741,13193,13424,13356,13360,13006,13129,13263,13242,13421,13467,13432,13039,13082],
           [94.2,95.2,93.6,97.1,96.9,96.8,92.9,94.6,94.1,94.1,91.6,92.5,93.4,93.3,94.5,94.9,94.6,91.9,92.2],
           [453,258,624,-864,280,262,553,464,536,573,731,670,646,650,556,569,548,738,714]],
    breakdown: [[46,185,144,222,214,214,135,166,174,167,109,128,132,135,165,171,171,119,126],
                [63,251,217,280,291,286,190,237,239,233,176,189,200,203,248,250,253,185,201],
                [78,313,301,328,331,337,278,309,301,308,270,280,288,299,323,324,320,277,275],
                [91,365,361,372,374,374,353,361,359,359,352,357,356,359,365,370,368,356,359],
                [7,30,30,23,22,26,38,32,33,35,36,35,33,30,29,25,25,38,33]],
    daily: [97.1,96.9,96.8,92.9,94.6,94.1,94.1,91.6,92.5,93.4,93.3,94.5,94.9,94.6,91.9,92.2]
  }};
  
  // Safe Google Sheets override — uses sheet data when valid, falls back to hardcoded
  var d = data[cat]; // Start with hardcoded fallback
  try {
    if (sheetDataCache && sheetDataCache.partners) {
      var catMap = { good:'good', average:'avg', bad:'bad', inc20:'inc20', inc1020:'inc1020', inc110:'inc110', inc0:'inc0' };
      var sheetKey = catMap[cat];
      var sc = sheetKey && sheetDataCache.partners[sheetKey];
      if (sc && typeof sc.mtd === 'number' && !isNaN(sc.mtd) && sc.targetValues && sc.targetValues.length > 0) {
                var sheetBreakdown = [sc.rate100, sc.rate95, sc.rate90, sc.rate80, sc.rateLess80];
                var fallbackBreakdown = d.breakdown;
                var partnerCount = (sc.numPartners && sc.numPartners.length > 0) ? sc.numPartners[0] : 0;
                var hasValidBreakdown = sheetBreakdown.every(function(row) {
                    return Array.isArray(row) && row.length >= 3 && row.every(function(v) {
                        return typeof v === 'number' && !isNaN(v) && v >= 0;
                    });
                });

                if (hasValidBreakdown && partnerCount > 0) {
                    hasValidBreakdown = sheetBreakdown.every(function(row) {
                        if (row[0] > partnerCount) return false; // MTD is now a count
                        for (var i = 1; i < row.length; i++) {
                            if (row[i] > partnerCount) return false; // Count cannot exceed total partners
                        }
                        return true;
                    });
                }

                if (!hasValidBreakdown) {
                    console.warn('⚠️ Invalid/missing slab breakdown for', cat, '- using hardcoded fallback slabs');
                }

        console.log('📊 Overriding', cat, 'with Google Sheets data');
        d = {
          title: sc.title || d.title,
          target: sc.target.toLocaleString(),
          mtd: sc.mtd.toFixed(1) + '%',
          w1: sc.w1.toFixed(1) + '%',
          w2: sc.w2.toFixed(1) + '%',
          gap: Math.abs(sc.gapValue).toLocaleString(),
          count: sc.numPartners[0],
          insight: d.insight,
          data: [sc.targetValues, sc.numPartners, sc.onlineRiders, sc.deliveryRiders, sc.achievementRate, sc.gapArray],
                    breakdown: hasValidBreakdown ? sheetBreakdown : fallbackBreakdown,
          daily: sc.daily
        };
      } else {
        console.log('⚠️ Sheet data for', cat, 'not valid, using hardcoded fallback');
      }
    }
  } catch(overrideErr) {
    console.warn('⚠️ Sheet override failed for', cat, '- using hardcoded fallback:', overrideErr);
    d = data[cat];
  }
  
  if (!d) {
    console.error('❌ No data found for category:', cat);
    document.getElementById('partnerCatContent').innerHTML = '<div style="padding:40px; text-align:center; color:#999;">No data available for this category. Please refresh or check console for errors.</div>';
    return;
  }
  
  console.log('📊 Rendering', cat, 'with data rows:', d.data ? d.data.length : 'undefined');
  
  var html = '<div class="adv-cards-row">';
  html += '<div class="adv-card '+((parseFloat(d.mtd)>=95)?'green':(parseFloat(d.mtd)>=90)?'amber':'red')+'"><div class="card-label">MTD Achievement</div><span class="card-tip-text">Month-to-date achievement rate. Delivery Riders ÷ Target for this partner group.</span><div class="card-value">'+d.mtd+'</div><div class="card-sub">Target: '+d.target+'</div></div>';
  html += '<div class="adv-card '+((parseFloat(d.w1)>=95)?'green':(parseFloat(d.w1)>=90)?'amber':'red')+'"><div class="card-label">W1 Performance</div><span class="card-tip-text">Week 1 (Feb 1-7) achievement rate. Delivery Riders ÷ Target for the first week.</span><div class="card-value">'+d.w1+'</div><div class="card-sub">Feb 1-7</div></div>';
  html += '<div class="adv-card '+((parseFloat(d.w2)>=95)?'green':(parseFloat(d.w2)>=90)?'amber':'red')+'"><div class="card-label">W2 Performance</div><span class="card-tip-text">Week 2 (Feb 8-14) achievement rate. Delivery Riders ÷ Target for the second week.</span><div class="card-value">'+d.w2+'</div><div class="card-sub">Feb 8-14</div></div>';
  html += '<div class="adv-card"><div class="card-label">Total GAP</div><span class="card-tip-text">The gap between Target and Online Riders. Calculated as Target − Online Riders.</span><div class="card-value">'+d.gap+'</div><div class="card-sub">Riders</div></div>';
  html += '</div>';
  
  html += '<div class="adv-legend"><strong>Color Legend:</strong>';
  html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-excellent"></span> ≥95% Excellent</div>';
  html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-good"></span> 90-94.9% Good</div>';
  html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-warning"></span> 85-89.9% Warning</div>';
  html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-critical"></span> <85% Critical</div>';
  html += '</div>';
  
  // Determine number of daily columns from data
  var numDays = (d.daily && d.daily.length > 0) ? d.daily.length : numDaysAvailable;

    function fmtTrendPct(curr, prev, label) {
        if (isNaN(curr) || isNaN(prev) || prev === 0) return '';
        var delta = ((curr - prev) / Math.abs(prev)) * 100;
        if (!isFinite(delta)) return '';
        var cls = delta > 0 ? 'up' : (delta < 0 ? 'down' : 'flat');
        var arrow = delta > 0 ? '▲' : (delta < 0 ? '▼' : '▶');
        return '<span class="ach-trend ' + cls + '">' + arrow + ' ' + Math.abs(delta).toFixed(1) + '% ' + label + '</span>';
    }
  
    html += '<div class="adv-table-container"><div class="adv-table-title">'+d.title+' Performance</div><div class="adv-table-wrap"><table class="adv-table partners-strat-table" id="partner'+cat+'Table"><thead><tr><th>Metric</th><th>MTD</th><th>W1</th><th>W2</th>';
  for(var i=numDays; i>=1; i--) html+='<th class="adv-daily-cols">Day '+i+'</th>';
  html += '</tr></thead><tbody>';
  
  var rows = ['Target','Number of Partners','Online Riders','Delivery Riders','Achievement %','Gap'];
  var totalRows = Math.min(rows.length, d.data.length);
  for(var r=0; r<totalRows; r++) {
    var isAch = (r===4);
    var isGap = (r===5);
        var isOnline = (r===2);
        var isDelivery = (r===3);
        var isTrendRow = isAch || isGap || isOnline || isDelivery;
    var isBold = isAch || isGap;
    var rowLabel = rows[r];
    if(isAch) rowLabel = '<strong>'+rows[r]+'</strong> <span class="row-info-icon">❗<span class="row-tip-text">Achievement %: The achievement rate from Delivery Riders ÷ Target</span></span>';
    else if(isGap) rowLabel = '<strong>'+rows[r]+'</strong> <span class="row-info-icon">❗<span class="row-tip-text">Gap: The gap for Target − Online Riders</span></span>';
    html += '<tr><td>'+rowLabel+'</td>';
    var rowDailyFlags = isAch ? getDailyFlagIndexes(d.data[r].slice(3), 'low') : (isGap ? getDailyFlagIndexes(d.data[r].slice(3), 'abs-high') : {});
    for(var c=0; c<3; c++) {
      var val = d.data[r][c];
      var cls = 'period-col';
      if(isAch && c>0) { cls += ' '+getColorClass(val); }
            var displayVal = (typeof val === 'number' && isAch ? val.toFixed(1)+'%' : (typeof val === 'number' ? val.toLocaleString() : val));
            if (isTrendRow && c === 2) displayVal += fmtTrendPct(val, d.data[r][1], 'WoW');
            html += '<td class="'+cls+'">'+displayVal+'</td>';
    }
    for(var c=3; c<d.data[r].length; c++) {
      var val = d.data[r][c];
      var cls = 'adv-daily-cols';
      if(isAch) {
        cls += ' '+getColorClass(val);
        if(rowDailyFlags[c-3]) cls += ' red-flag-cell ' + getAchievementFlagClass(val);
      }
      if(isGap && rowDailyFlags[c-3]) {
        cls += ' red-flag-cell ' + getGapFlagClass(val);
      }
            var dailyDisplayVal = (typeof val === 'number' && isAch ? val.toFixed(1)+'%' : (typeof val === 'number' ? val.toLocaleString() : val));
            if (isAch) {
                var prevDailyVal = (c < d.data[r].length - 1) ? d.data[r][c + 1] : NaN;
                dailyDisplayVal += fmtTrendPct(val, prevDailyVal, 'DoD');
            }
            if (isGap || isOnline || isDelivery) {
                var prevGapDailyVal = (c < d.data[r].length - 1) ? d.data[r][c + 1] : NaN;
                dailyDisplayVal += fmtTrendPct(val, prevGapDailyVal, 'DoD');
            }
            html += '<td class="'+cls+'">'+dailyDisplayVal+'</td>';
    }
    html += '</tr>';
  }
  
  // Achievement breakdown rows
  var breakdownRows = ['achievement rate ≥100%','achievement rate >=95% - <100%','achievement rate >=90% - <95%','achievement rate >=80% - <90%','achievement rate <80%'];
  var totalP = d.count;
    function getBkdnColorByRow(rowIdx) {
        if (rowIdx === 0) return 'bkdn-high'; // >=100% positive
        if (rowIdx === 1) return 'bkdn-mid';  // >=95% - <100% good
        if (rowIdx === 2) return 'bkdn-low';  // >=90% - <95% warning
        if (rowIdx === 3) return 'bkdn-low';  // >=80% - <90% warning
        return 'bkdn-vlow';                    // <80% concern
  }
  for(var b=0; b<5; b++) {
    var isNeg = (b === 4); // <80% row
        var breakdownDailyFlags = getDailyFlagIndexes(d.breakdown[b].slice(3), isNeg ? 'high' : 'low');
    html += '<tr><td>'+breakdownRows[b]+'</td>';
    // MTD column (index 0) is a count; show count + % of total partners
    var mtdVal = d.breakdown[b][0];
    var mtdPct = (mtdVal/totalP*100);
        var mtdCls = getBkdnColorByRow(b);
        html += '<td class="period-col '+mtdCls+'">'+mtdVal+' <span style="font-size:10px;opacity:0.85">('+mtdPct.toFixed(1)+'%)</span></td>';
    // W1 and W2 columns (index 1,2) are counts
    for(var c=1; c<3; c++) {
      var val = d.breakdown[b][c];
      var pct = (val/totalP*100);
            var cls = getBkdnColorByRow(b);
            html += '<td class="period-col '+cls+'">'+val+' <span style="font-size:10px;opacity:0.85">('+pct.toFixed(1)+'%)</span></td>';
    }
    for(var c=3; c<d.breakdown[b].length; c++) {
      var val = d.breakdown[b][c];
      var pct = (val/totalP*100);
            var cls = getBkdnColorByRow(b);
            html += '<td class="adv-daily-cols '+cls+(breakdownDailyFlags[c-3] ? ' red-flag-cell ' + getBreakdownFlagClass(pct, isNeg) : '')+'">'+val+' <span style="font-size:10px;opacity:0.85">('+pct.toFixed(1)+'%)</span></td>';
    }
    html += '</tr>';
  }
  
  html += '</tbody></table></div><button class="adv-expand-btn" onclick="toggleDailyExpand(\'partner'+cat+'Table\')">📅 Expand Daily View</button></div>';
  
  var color = (parseFloat(d.mtd)>=95)?'green':(parseFloat(d.mtd)>=90)?'amber':'amber';
  html += '<div class="adv-highlight-box '+color+'"><strong>📊 Key Insights:</strong> '+d.insight+'</div>';
  
  html += '<details class="adv-chart-details"><summary>📈 Daily Trend Chart</summary><div class="adv-chart-wrap"><div class="adv-chart-canvas"><canvas id="partner'+cat+'Chart"></canvas></div></div></details>';
  
  document.getElementById('partnerCatContent').innerHTML = html;
  
  setTimeout(function(){
    var ctx = document.getElementById('partner'+cat+'Chart');
    if(!ctx) return;
    ctx = ctx.getContext('2d');
    var chartDailyData = d.daily ? d.daily.slice().reverse() : [];
    var chartNumDays = chartDailyData.length || numDaysAvailable;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: generateShortDayLabels(chartNumDays),
        datasets: [{
          label: 'Achievement %',
          data: chartDailyData,
          borderColor: '#1976d2',
          backgroundColor: 'rgba(25,118,210,0.1)',
          tension: 0.3,
          fill: true,
          borderWidth: 3,
          pointRadius: 4
        },{
          label: '95% Target',
          data: Array(chartNumDays).fill(95),
          borderColor: '#2e7d32',
          borderWidth: 2,
          borderDash: [5,5],
          pointRadius: 0,
          fill: false
        },{
          label: '90% Threshold',
          data: Array(chartNumDays).fill(90),
          borderColor: '#f57c00',
          borderWidth: 2,
          borderDash: [5,5],
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: 'index', intersect: false },
          datalabels: {
            display: function(ctx) { return ctx.datasetIndex === 0; },
            anchor: 'end',
            align: 'top',
            offset: 4,
            color: '#1565c0',
            font: { weight: 'bold', size: 10 },
            formatter: function(v) { return v.toFixed(1) + '%'; }
          }
        },
        scales: {
          y: { beginAtZero: false, min: 85, max: 105, ticks: { callback: v=>v+'%' } }
        }
      }
    });
  }, 100);
}

function renderCityMetric(metric) {
  var cities = ['Al Ahsa','Dammam','Hafar Albatin','Jubail','Riyadh','Al Kharj','Buraydah','Hail','Jeddah','Madinah','Tabuk','Yanbu','Abha','Jazan','Makkah','Najran','Taif'];
  
  var gapData = {
    mtd: [1.1,1.8,1.2,1.8,3.3,1.6,1.4,1.6,1.9,1.7,1.6,2.5,1.7,1.8,2.1,1.6,1.8],
    w1: [-0.9,-2.2,-1.5,-2.0,-3.4,-2.0,-1.6,-1.5,-1.5,-1.7,-1.9,-3.6,-1.6,-1.3,-2.2,-1.2,-1.6],
    w2: [-1.0,-1.5,-0.8,-1.9,-2.8,-1.7,-0.6,-2.6,-1.9,-1.5,-2.0,-2.5,-2.0,-2.7,-1.8,-1.2,-1.8],
    daily: [[-2.9,-0.1,-0.1,-1.6,-0.4,-0.7,-0.3,-2.2,-1.4,-0.8,-0.8,-0.8,-0.8,-0.8,-0.8,-0.8],
            [-8.8,-0.4,-0.5,-2.6,-1.0,-0.5,-1.3,-2.2,-2.0,-1.4,-1.4,-1.4,-1.4,-1.4,-1.4,-1.4],
            [-8.7,-1.0,0.0,0.0,0.0,0.0,-1.0,-1.0,0.0,-1.0,-1.0,-1.0,-1.0,-1.0,-1.0,-1.0],
            [-6.0,-0.9,-1.4,0.0,-0.9,-0.9,-3.7,-2.8,-2.8,-0.9,-0.9,-0.9,-0.9,-0.9,-0.9,-0.9],
            [-8.0,-1.4,-1.9,-4.1,-2.9,-3.1,-2.5,-3.9,-3.3,-2.4,-2.4,-2.4,-2.4,-2.4,-2.4,-2.4],
            [-8.3,-0.7,0.0,-1.3,-1.3,-0.7,-1.7,-4.0,-2.0,-1.0,-1.0,-1.0,-1.0,-1.0,-1.0,-1.0],
            [-7.4,0.0,-0.4,-1.6,-0.8,-0.4,-0.4,-1.2,-2.5,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-3.5,-1.2,0.0,-0.6,-1.2,0.0,-4.1,-4.7,0.0,-2.3,-2.3,-2.3,-2.3,-2.3,-2.3,-2.3],
            [-4.9,-0.8,-0.6,-1.5,-1.0,-0.8,-1.2,-2.5,-2.4,-1.8,-1.8,-1.8,-1.8,-1.8,-1.8,-1.8],
            [-5.1,-0.4,-1.2,-1.4,-1.4,-1.3,-1.0,-1.9,-1.7,-1.5,-1.5,-1.5,-1.5,-1.5,-1.5,-1.5],
            [-8.7,-0.5,0.0,-1.4,-0.5,-1.0,-1.0,-1.9,-1.4,-2.4,-2.4,-2.4,-2.4,-2.4,-2.4,-2.4],
            [-12.3,-0.6,-2.9,-4.1,-1.2,-0.6,-3.5,-2.3,-4.7,-1.8,-1.8,-1.8,-1.8,-1.8,-1.8,-1.8],
            [-3.4,-1.9,-1.1,-1.1,0.0,-1.5,-2.3,-1.5,-1.1,-2.3,-2.3,-2.3,-2.3,-2.3,-2.3,-2.3],
            [-3.8,0.0,0.0,-1.3,-1.3,-1.3,-1.3,0.0,-2.6,-3.8,-3.8,-3.8,-3.8,-3.8,-3.8,-3.8],
            [-8.7,-1.0,-0.8,-1.9,-0.9,-1.4,-1.0,-3.2,-2.2,-1.6,-1.6,-1.6,-1.6,-1.6,-1.6,-1.6],
            [-5.6,0.0,0.0,0.0,-1.4,0.0,-1.4,-5.6,-1.4,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-2.8,-0.7,-1.0,-1.7,-1.4,-2.1,-1.4,-1.4,-3.1,-1.7,-1.7,-1.7,-1.7,-1.7,-1.7,-1.7]]
  };
  
  var achData = {
    mtd: [93.3,95.1,100.0,97.4,90.6,100.5,98.4,95.0,94.7,95.3,95.9,89.5,98.6,98.6,94.5,97.5,96.7],
    w1: [94.2,95.6,100.1,97.5,89.3,103.5,99.1,98.4,93.9,96.2,95.3,88.4,100.9,93.4,94.0,101.4,92.5],
    w2: [92.1,94.6,99.0,93.1,89.3,98.4,97.1,91.4,92.7,93.7,95.7,90.8,96.3,100.2,92.9,92.7,98.9],
    daily: [[93.8,93.0,94.8,93.6,95.1,94.8,94.7,90.5,91.4,92.1,92.1,92.1,92.1,92.1,92.1,92.1],
            [95.7,96.0,96.7,92.9,96.0,96.4,95.6,93.1,94.0,94.8,94.8,94.8,94.8,94.8,94.8,94.8],
            [100.0,98.1,99.0,101.9,100.0,101.0,101.0,99.0,101.0,98.1,98.1,98.1,98.1,98.1,98.1,98.1],
            [97.2,99.1,99.5,100.5,97.2,98.6,90.2,89.3,90.7,95.3,95.3,95.3,95.3,95.3,95.3,95.3],
            [90.1,90.8,90.8,87.4,89.0,88.0,89.2,87.2,88.2,90.2,90.2,90.2,90.2,90.2,90.2,90.2],
            [104.3,104.3,104.7,103.0,103.0,103.3,101.7,98.7,98.0,97.7,97.7,97.7,97.7,97.7,97.7,97.7],
            [101.2,99.6,99.6,97.9,97.5,98.8,99.2,98.4,96.7,96.3,96.3,96.3,96.3,96.3,96.3,96.3],
            [99.4,98.8,100.0,98.3,98.8,98.3,95.3,94.2,97.1,88.4,88.4,88.4,88.4,88.4,88.4,88.4],
            [95.2,95.2,95.0,91.1,93.4,94.2,93.1,90.8,92.0,93.2,93.2,93.2,93.2,93.2,93.2,93.2],
            [99.2,98.2,97.9,95.0,95.4,93.8,94.0,93.4,93.8,93.7,93.7,93.7,93.7,93.7,93.7,93.7],
            [93.7,96.1,97.6,95.2,95.2,94.7,94.7,95.2,95.2,96.1,96.1,96.1,96.1,96.1,96.1,96.1],
            [88.9,88.3,88.3,85.4,90.1,90.6,87.1,90.1,88.9,92.4,92.4,92.4,92.4,92.4,92.4,92.4],
            [106.1,102.7,102.3,98.9,99.6,98.9,98.1,97.7,97.7,95.1,95.1,95.1,95.1,95.1,95.1,95.1],
            [89.7,91.0,88.5,87.2,93.6,101.3,102.6,105.1,103.8,97.4,97.4,97.4,97.4,97.4,97.4,97.4],
            [93.4,94.1,95.0,92.2,94.5,94.3,94.6,91.5,92.0,93.1,93.1,93.1,93.1,93.1,93.1,93.1],
            [104.2,101.4,102.8,101.4,101.4,101.4,97.2,87.5,91.7,93.1,93.1,93.1,93.1,93.1,93.1,93.1],
            [88.5,90.6,89.9,91.3,93.4,96.2,97.6,99.3,96.9,99.7,99.7,99.7,99.7,99.7,99.7,99.7]]
  };
  
  // Safe Google Sheets override for city data — falls back to hardcoded on any error
  try {
    if (sheetDataCache && sheetDataCache.cities) {
      function cityToNum(v) { var n = parseFloat(String(v).replace(/,/g,'')); return isNaN(n) ? 0 : n; }
      var sheetGap = sheetDataCache.cities.gap;
      var sheetAch = sheetDataCache.cities.achievement;
      if (sheetGap && Object.keys(sheetGap).length >= 17) {
        var newGap = { mtd: [], w1: [], w2: [], daily: [] };
        var valid = true;
        for (var ci = 0; ci < cities.length; ci++) {
          var cd = sheetGap[cities[ci]];
          if (!cd) { valid = false; break; }
          newGap.mtd.push(cityToNum(cd.mtd));
          newGap.w1.push(cityToNum(cd.w1));
          newGap.w2.push(cityToNum(cd.w2));
          newGap.daily.push(cd.daily ? cd.daily.map(cityToNum) : []);
        }
        if (valid && newGap.mtd.length === 17) {
          console.log('📊 Overriding city GAP data with Google Sheets');
          gapData = newGap;
        }
      }
      if (sheetAch && Object.keys(sheetAch).length > 0) {
        var newAch = { mtd: [], w1: [], w2: [], daily: [] };
        var valid = true;
        for (var ci = 0; ci < cities.length; ci++) {
          var cd = sheetAch[cities[ci]];
          if (!cd) {
            // Fallback to hardcoded for this city
            newAch.mtd.push(achData.mtd[ci] || 0);
            newAch.w1.push(achData.w1[ci] || 0);
            newAch.w2.push(achData.w2[ci] || 0);
            newAch.daily.push(achData.daily[ci] || []);
            continue;
          }
          newAch.mtd.push(cityToNum(cd.mtd));
          newAch.w1.push(cityToNum(cd.w1));
          newAch.w2.push(cityToNum(cd.w2));
          newAch.daily.push(cd.daily ? cd.daily.map(cityToNum) : []);
        }
        console.log('📊 Overriding city Achievement data with Google Sheets - cities found:', Object.keys(sheetAch).length, 'daily[0] length:', newAch.daily[0]?.length);
        achData = newAch;
      }
    }
  } catch(cityOverrideErr) {
    console.warn('⚠️ City data override failed - using hardcoded fallback:', cityOverrideErr);
  }
  
  var data = (metric==='gap') ? gapData : achData;
  var title = (metric==='gap') ? '📉 City GAP % (Delivery vs Capacity)' : '📊 City Achievement Rate';
  var insight = (metric==='gap') ? 'GAP analysis shows Yanbu with highest MTD gap (2.5%), Riyadh (3.3%), and Dammam (1.8%). Negative W1/W2 values indicate delivery exceeded capacity in weekly windows. Day 1 shows extreme spikes (Yanbu -12.3%, multiple cities <-8%) suggesting initialization issues. Most cities stabilize at <-2% daily gap by Day 3. Day 16 shows consistent negative gaps across all cities (Jazan -3.8%, Riyadh/Tabuk -2.4%), indicating sustained over-delivery vs capacity.' : 'Achievement rates show strong performers: Al Kharj (100.5%), Hafar Albatin (100.0%), Abha (98.6%), Jazan (98.6%), and Buraydah (98.4%) consistently above 95%. Riyadh struggles at 90.6% MTD with W1=W2=89.3%, indicating systemic underperformance. Yanbu lowest at 89.5% MTD. Day 16 performance: Taif leads (99.7%), Hafar Albatin (98.1%), Jazan (97.4%). Hail drops significantly to 88.4%, requiring immediate attention.';
  
  var bestCity = '', bestVal = (metric==='ach' ? -999 : 999), worstCity = '', worstVal = (metric==='ach' ? 999 : 0);
  for(var i=0; i<cities.length; i++) {
    var val = data.mtd[i];
    if(metric==='ach') {
      if(val>bestVal) { bestVal=val; bestCity=cities[i]; }
      if(val<worstVal) { worstVal=val; worstCity=cities[i]; }
    } else {
      var absVal = Math.abs(val);
      if(absVal<Math.abs(bestVal)) { bestVal=val; bestCity=cities[i]; }
      if(absVal>Math.abs(worstVal)) { worstVal=val; worstCity=cities[i]; }
    }
  }
  
  var html = '<div class="adv-cards-row">';
  html += '<div class="adv-card green"><div class="card-label">Best City</div><span class="card-tip-text">City with the '+(metric==='gap'?'lowest GAP (closest to target)':'highest achievement rate')+' this month.</span><div class="card-value">'+bestCity+'</div><div class="card-sub">'+bestVal.toFixed(1)+(metric==='ach'?'%':'%')+'</div></div>';
  html += '<div class="adv-card red"><div class="card-label">Worst City</div><span class="card-tip-text">City with the '+(metric==='gap'?'highest GAP (furthest from target)':'lowest achievement rate')+' requiring attention.</span><div class="card-value">'+worstCity+'</div><div class="card-sub">'+worstVal.toFixed(1)+(metric==='ach'?'%':'%')+'</div></div>';
  html += '<div class="adv-card"><div class="card-label">Cities Tracked</div><span class="card-tip-text">Total number of cities being tracked across Saudi Arabia.</span><div class="card-value">17</div><div class="card-sub">Across KSA</div></div>';
  html += '<div class="adv-card"><div class="card-label">Avg '+(metric==='gap'?'GAP':'Achievement')+'</div><span class="card-tip-text">Average '+(metric==='gap'?'GAP percentage':'achievement rate')+' across all 17 cities for the month.</span><div class="card-value">'+(data.mtd.reduce((a,b)=>a+b,0)/17).toFixed(1)+(metric==='ach'?'%':'%')+'</div><div class="card-sub">MTD Average</div></div>';
  html += '</div>';
  
  if(metric==='ach') {
    html += '<div class="adv-legend"><strong>Color Legend:</strong>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-excellent"></span> ≥95% Excellent</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-good"></span> 90-94.9% Good</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-warning"></span> 85-89.9% Warning</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-critical"></span> <85% Critical</div>';
    html += '</div>';
  } else {
    html += '<div class="adv-legend"><strong>Color Legend (GAP %):</strong>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-excellent"></span> ≤1.0% Excellent</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-good"></span> 1.1-2.0% Good</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-warning"></span> 2.1-3.0% Warning</div>';
    html += '<div class="adv-legend-item"><span class="adv-legend-dot dot-critical"></span> >3.0% Critical</div>';
    html += '</div>';
  }
  
  // Determine number of daily columns from data
  var numDays = (data.daily && data.daily[0] && data.daily[0].length > 0) ? data.daily[0].length : numDaysAvailable;
  console.log('🔍 renderCityMetric', metric, '- numDays:', numDays, 'data.daily[0].length:', data.daily[0]?.length);

    function fmtTrendPct(curr, prev, label) {
        if (isNaN(curr) || isNaN(prev) || prev === 0) return '';
        var delta = ((curr - prev) / Math.abs(prev)) * 100;
        if (!isFinite(delta)) return '';
        var cls = delta > 0 ? 'up' : (delta < 0 ? 'down' : 'flat');
        var arrow = delta > 0 ? '▲' : (delta < 0 ? '▼' : '▶');
        return '<span class="ach-trend ' + cls + '">' + arrow + ' ' + Math.abs(delta).toFixed(1) + '% ' + label + '</span>';
    }
  
    html += '<div class="adv-table-container"><div class="adv-table-title">'+title+'</div><div class="adv-table-wrap"><table class="adv-table city-level-table" id="city'+metric+'Table"><thead><tr><th>City</th><th>MTD</th><th>W1</th><th>W2</th>';
  for(var i=numDays; i>=1; i--) html+='<th class="adv-daily-cols">Day '+i+'</th>';
  html += '</tr></thead><tbody>';
  
  for(var c=0; c<cities.length; c++) {
        var cityDaily = (data.daily[c] || []).slice(0, numDays);
        var cityDailyFlags = getDailyFlagIndexes(cityDaily, metric==='gap' ? 'abs-high' : 'low');
    html += '<tr><td>'+cities[c]+'</td>';
        var mtdCellVal = data.mtd[c].toFixed(1) + '%';
        var w1CellVal = data.w1[c].toFixed(1) + '%';
        var w2CellVal = data.w2[c].toFixed(1) + '%';
            if (metric === 'ach' || metric === 'gap') {
            w2CellVal += fmtTrendPct(data.w2[c], data.w1[c], 'WoW');
        }
        html += '<td class="period-col '+(metric==='ach'?getColorClass(data.mtd[c]):getGapColorClass(data.mtd[c]))+'">'+mtdCellVal+'</td>';
        html += '<td class="period-col '+(metric==='ach'?getColorClass(data.w1[c]):getGapColorClass(data.w1[c]))+'">'+w1CellVal+'</td>';
        html += '<td class="period-col '+(metric==='ach'?getColorClass(data.w2[c]):getGapColorClass(data.w2[c]))+'">'+w2CellVal+'</td>';
        for(var d=0; d<numDays; d++) {
            var dailyVal = cityDaily[d];
            var dailyClass = (metric==='ach'?getColorClass(dailyVal):getGapColorClass(dailyVal));
            var cityFlagClass = metric==='ach' ? getAchievementFlagClass(dailyVal) : getGapFlagClass(dailyVal);
                        var dailyCellVal = dailyVal.toFixed(1) + '%';
                        if (metric === 'ach' || metric === 'gap') {
                            var prevDailyVal = (d < numDays - 1) ? cityDaily[d + 1] : NaN;
                            dailyCellVal += fmtTrendPct(dailyVal, prevDailyVal, 'DoD');
                        }
                        html += '<td class="adv-daily-cols '+dailyClass+(cityDailyFlags[d] ? ' red-flag-cell ' + cityFlagClass : '')+'">'+dailyCellVal+'</td>';
    }
    html += '</tr>';
  }
  
  html += '</tbody></table></div><button class="adv-expand-btn" onclick="toggleDailyExpand(\'city'+metric+'Table\')">📅 Expand Daily View</button></div>';
  
  html += '<div class="adv-highlight-box amber"><strong>📊 Key Insights:</strong> '+insight+'</div>';
  
  cityChartData[metric] = data;
  
  html += '<details class="adv-chart-details" open><summary>📈 City Comparison Chart</summary>';
  html += '<div class="adv-city-slicer" id="citySlicer'+metric+'">';
  html += '<span class="slicer-label">Filter:</span>';
  html += '<span class="adv-city-chip tier-btn" onclick="toggleCityTier(\'T1\',\''+metric+'\')">T1 Cities</span>';
  html += '<span class="adv-city-chip tier-btn" onclick="toggleCityTier(\'T2\',\''+metric+'\')">T2 Cities</span>';
  html += '<span style="width:1px;height:20px;background:#ccc;margin:0 4px;"></span>';
  var cityTiers = {0:'T1',1:'T1',2:'T2',3:'T2',4:'T1',5:'T1',6:'T2',7:'T2',8:'T1',9:'T1',10:'T2',11:'T2',12:'T2',13:'T2',14:'T1',15:'T2',16:'T2'};
  for(var ci=0; ci<cities.length; ci++) {
    var isDefault = (cities[ci]==='Riyadh');
    html += '<span class="adv-city-chip'+(isDefault?' active':'')+'" data-city-idx="'+ci+'" data-tier="'+cityTiers[ci]+'" onclick="toggleCityChip(this,\''+metric+'\')">'+cities[ci]+'</span>';
  }
  html += '</div>';
  html += '<div class="adv-chart-wrap"><div class="adv-chart-canvas"><canvas id="city'+metric+'Chart"></canvas></div></div></details>';
  
  document.getElementById('cityMetricContent').innerHTML = html;
  
  setTimeout(function(){
    renderCityChart(metric, data, cities);
  }, 100);
}

var cityChartInstances = {};

function renderCityChart(metric, data, cities) {
  var ctx = document.getElementById('city'+metric+'Chart');
  if(!ctx) return;
  if(cityChartInstances[metric]) { cityChartInstances[metric].destroy(); }
  ctx = ctx.getContext('2d');
  
  var slicer = document.getElementById('citySlicer'+metric);
  var activeChips = slicer.querySelectorAll('.adv-city-chip:not(.tier-btn).active');
  var selectedIndices = [];
  activeChips.forEach(function(chip){ selectedIndices.push(parseInt(chip.getAttribute('data-city-idx'))); });
  
  var allColors = ['#1976d2','#2e7d32','#f57c00','#c62828','#7b1fa2','#0097a7','#fbc02d','#455a64','#d81b60','#00695c','#ff6f00','#4527a0','#00838f','#bf360c','#1b5e20','#6a1b9a','#e65100'];
  var datasets = [];
  for(var s=0; s<selectedIndices.length; s++) {
    var ci = selectedIndices[s];
    datasets.push({
      label: cities[ci],
      data: data.daily[ci].slice().reverse(),
      borderColor: allColors[ci%allColors.length],
      backgroundColor: allColors[ci%allColors.length]+'33',
      tension: 0.2,
      borderWidth: 2,
      pointRadius: 3
    });
  }
  
  var chartNumDays = (data.daily && data.daily[0]) ? data.daily[0].length : numDaysAvailable;
  cityChartInstances[metric] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: generateShortDayLabels(chartNumDays),
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } },
        tooltip: { mode: 'index', intersect: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          offset: 4,
          color: function(ctx) { return ctx.dataset.borderColor; },
          font: { weight: 'bold', size: 9 },
          formatter: function(v) { return v.toFixed(1) + '%'; }
        }
      },
      scales: {
        y: { beginAtZero: false, ticks: { callback: function(v){return v+'%';} } }
      }
    }
  });
}

// Store city data globally for chart re-rendering
var cityChartData = {};
var cityNames = ['Al Ahsa','Dammam','Hafar Albatin','Jubail','Riyadh','Al Kharj','Buraydah','Hail','Jeddah','Madinah','Tabuk','Yanbu','Abha','Jazan','Makkah','Najran','Taif'];

function toggleCityChip(chip, metric) {
  chip.classList.toggle('active');
  renderCityChart(metric, cityChartData[metric], cityNames);
}

function toggleCityTier(tier, metric) {
  var slicer = document.getElementById('citySlicer'+metric);
  var tierChips = slicer.querySelectorAll('.adv-city-chip[data-tier="'+tier+'"]:not(.tier-btn)');
  var allActive = true;
  tierChips.forEach(function(c){ if(!c.classList.contains('active')) allActive=false; });
  tierChips.forEach(function(c){
    if(allActive) c.classList.remove('active');
    else c.classList.add('active');
  });
  // Toggle the tier button visual
  var tierBtns = slicer.querySelectorAll('.tier-btn');
  tierBtns.forEach(function(b){
    if(b.textContent.indexOf(tier) >= 0) b.classList.toggle('active');
  });
  renderCityChart(metric, cityChartData[metric], cityNames);
}

// Render chart when details is toggled open
var ovChartDet = document.getElementById('totalOverviewChartDetails');
if(ovChartDet) {
  ovChartDet.addEventListener('toggle', function() {
    if(this.open) setTimeout(initAdvCharts, 50);
  });
}
</script>

<!-- End of removed legacy sections -->
</div>

<!-- End of Tab -->
<div class="footer">
        January 2026 vs February 2026 Analysis | Partner Capacity Management Dashboard
    </div>
<script>
        try { if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') { Chart.register(ChartDataLabels); } } catch(e) {}

        // Tab switching
        function switchTab(tabName, el) {
            const tabs = document.querySelectorAll('.tab-content');
            const tabItems = document.querySelectorAll('.tab-item');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabItems.forEach(item => item.classList.remove('active'));

            const target = document.getElementById(tabName);
            if (target) target.classList.add('active');
            if (el) el.classList.add('active');

            const monthOverviewSlicer = document.getElementById('monthOverviewSlicer');
            if (monthOverviewSlicer) {
                monthOverviewSlicer.style.display = tabName === 'overview' ? 'flex' : 'none';
            }
            const monthlyInsightsSlicer = document.getElementById('monthlyInsightsSlicer');
            if (monthlyInsightsSlicer) {
                monthlyInsightsSlicer.style.display = tabName === 'monthly' ? 'flex' : 'none';
            }

            // Fix Chart.js sizing when switching to hidden tabs
            window.dispatchEvent(new Event('resize'));
            
            // Show/hide comment hub based on active tab
            var commentHub = document.getElementById('commentHubFixed');
            if(commentHub) {
                commentHub.style.display = tabName === 'dailyView' ? 'block' : 'none';
            }

            if (tabName === 'dailyView') {
                setTimeout(function() { window.dispatchEvent(new Event('resize')); }, 100);
            }
            if (tabName === 'monthly') {
                setTimeout(() => {
                    if (window.monthlyCharts && Array.isArray(window.monthlyCharts)) {
                        window.monthlyCharts.forEach(c => { try { c.resize(); } catch(e) {} });
                    }
                }, 60);
            }
            // Re-apply language translation after tab switch
            if (window.dashboardScheduleLanguage) window.dashboardScheduleLanguage();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const monthOverviewSlicer = document.getElementById('monthOverviewSlicer');
            if (monthOverviewSlicer) {
                monthOverviewSlicer.style.display = document.getElementById('overview')?.classList.contains('active') ? 'flex' : 'none';
            }
            const monthlyInsightsSlicer = document.getElementById('monthlyInsightsSlicer');
            if (monthlyInsightsSlicer) {
                monthlyInsightsSlicer.style.display = document.getElementById('monthly')?.classList.contains('active') ? 'flex' : 'none';
            }

            document.querySelectorAll('.section-slicer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const overviewTabItem = Array.from(document.querySelectorAll('.tab-item'))
                        .find(item => (item.getAttribute('onclick') || '').includes("'overview'"));

                    if (!document.getElementById('overview')?.classList.contains('active')) {
                        switchTab('overview', overviewTabItem);
                    }

                    setTimeout(() => {
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 80);
                });
            });

            document.querySelectorAll('.monthly-slicer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const monthlyTabItem = Array.from(document.querySelectorAll('.tab-item'))
                        .find(item => (item.getAttribute('onclick') || '').includes("'monthly'"));

                    if (!document.getElementById('monthly')?.classList.contains('active')) {
                        switchTab('monthly', monthlyTabItem);
                    }

                    setTimeout(() => {
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 80);
                });
            });
        });
// Table filtering
        function filterTable() {
            const input = document.getElementById('searchBox');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('cityTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                tr[i].style.display = found ? '' : 'none';
            }
        }

        
        // Export all tables to a single CSV file
        function exportToCSV() {
            const tables = Array.from(document.querySelectorAll('table'));
            if (!tables.length) {
                alert('No tables found to export.');
                return;
            }

            function findTableTitle(table) {
                // Search backward for the nearest heading (h2/h3/h4)
                let el = table;
                while (el && el !== document.body) {
                    let prev = el.previousElementSibling;
                    while (prev) {
                        if (['H2','H3','H4'].includes(prev.tagName)) {
                            const t = (prev.innerText || '').trim();
                            if (t) return t;
                        }
                        prev = prev.previousElementSibling;
                    }
                    el = el.parentElement;
                }
                return table.getAttribute('id') || 'Table';
            }

            function esc(v) {
                const s = String(v ?? '').replace(/\s+/g, ' ').trim();
                return '"' + s.replace(/"/g, '""') + '"';
            }

            let csv = '';
            tables.forEach((table, idx) => {
                const title = findTableTitle(table) || `Table ${idx+1}`;
                csv += esc(title) + '\n';
                const rows = Array.from(table.rows);
                rows.forEach(row => {
                    const cells = Array.from(row.cells).map(c => esc(c.innerText));
                    csv += cells.join(',') + '\n';
                });
                csv += '\n\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            a.href = url;
            a.download = `Partner_Capacity_Dashboard_${yyyy}-${mm}-${dd}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
// Chart configuration with data labels
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: (value) => value.toLocaleString(),
                    font: {
                        weight: 'bold',
                        size: 11
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };

                // Tier city (T1 vs T2) data & helpers
                let tierFilterSelected = 'both'; // 'both', 't1', or 't2'
                const tierCityData = {
                    months: ['Sep-25','Oct-25','Nov-25','Dec-25','Jan-26','Feb-26'],
                    t1: {
                        target: [28525, 29923, 30928, 21880, 20270, 17473],
                        active: [521, 556, 664, 690, 572, 534],
                        withTarget: [446, 534, 608, 560, 518, 461],
                        avgScale: [64.0, 56.0, 50.9, 39.1, 39.1, 37.9]
                    },
                    t2: {
                        target: [4268, 4083, 3909, 2302, 2183, 1892],
                        active: [241, 195, 216, 161, 115, 109],
                        withTarget: [169, 163, 159, 114, 107, 90],
                        avgScale: [25.3, 25.0, 24.6, 20.2, 20.4, 21.0]
                    },
                    perf: {
                        t1: { good: [115,139,158,178,207,199], average: [153,188,214,230,230,228], bad: [92,116,130,108,72,20] },
                        t2: { good: [45,51,47,45,62,53], average: [54,61,61,55,44,34], bad: [33,27,30,14,1,0] }
                    },
                    size: {
                        t1: { big: [39,49,57,63,57,57], mid: [194,233,255,260,219,219], small: [127,161,190,193,233,171] },
                        t2: { big: [20,25,25,24,24,20], mid: [68,89,84,75,56,63], small: [44,25,29,15,27,4] }
                    },
                    targetPerf: {
                        t1: { good: [9858,9452,9959,9883,10903,8904], average: [11580,13094,12650,8321,7613,7842], bad: [4268,4937,5833,2650,1514,370] },
                        t2: { good: [1371,1631,1459,1136,1446,1288], average: [1318,1501,1501,937,717,572], bad: [822,564,616,229,20,0] }
                    },
                    targetSize: {
                        t1: { big: [6227,6868,7490,5921,4471,1650], mid: [14375,15525,15273,11063,9490,7052], small: [5104,5090,5679,3870,6069,8686] },
                        t2: { big: [970,1038,1152,820,467,131], mid: [1603,2184,1980,1289,1108,781], small: [938,474,444,193,608,854] }
                    }
                };

                function tierFmtNum(n) {
                    try { return Number(n).toLocaleString('en-US'); } catch(e) { return String(n); }
                }
                function tierPct(part, total) {
                    if (!total || !isFinite(part) || !isFinite(total)) return 0;
                    return (part / total) * 100;
                }
                function tierDeltaHtml(curr, prev) {
                    if (prev === undefined || prev === null || prev === 0) return '';
                    const delta = ((curr - prev) / prev) * 100;
                    const arrow = delta >= 0 ? '↑' : '↓';
                    const color = delta >= 0 ? '#059669' : '#b91c1c';
                    return ` <span style="color:${color}; font-weight:700;">${arrow} ${Math.abs(delta).toFixed(1)}%</span>`;
                }

                function buildTierTables() {
                    const months = tierCityData.months;
                    const rows = [];
                    const overviewTable = document.getElementById('tierOverviewTable');
                    const perfTable = document.getElementById('tierPerfTable');
                    const scaleTable = document.getElementById('tierScaleTable');
                    const targetPerfTable = document.getElementById('tierTargetPerfTable');
                    const targetScaleTable = document.getElementById('tierTargetScaleTable');
                    if (!overviewTable || !perfTable || !scaleTable || !targetPerfTable || !targetScaleTable) return;

                    // Overview table header - dynamically build based on filter
                    let headerHtml = '<thead><tr style="background:#1e293b;color:#fff;">'
                        + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;max-width:70px;">Month</th>';
                    
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        headerHtml += '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T1 Target</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T1 Active</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T1 With Target</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T1 Avg Scale</th>';
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        headerHtml += '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T2 Target</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T2 Active</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T2 With Target</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">T2 Avg Scale</th>';
                    }
                    
                    headerHtml += '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">Total Target</th>'
                        + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">Total Active</th>'
                        + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">Total With Target</th>'
                        + '<th style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">Weighted Avg Scale</th>'
                        + '</tr></thead><tbody>';

                    // Correct weighted avg scale values for each month
                    const weightedAvgScaleValues = [53.3, 48.8, 45.4, 35.9, 35.9, 35.1];
                    const totalTargetValues = [], totalActiveValues = [], totalWithValues = [];
                    let totalT1Target = 0, totalT2Target = 0, totalT1Active = 0, totalT2Active = 0, totalT1With = 0, totalT2With = 0, totalT1AvgScale = 0, totalT2AvgScale = 0;
                    months.forEach((m, i) => {
                        const t1Target = tierCityData.t1.target[i];
                        const t2Target = tierCityData.t2.target[i];
                        const t1Active = tierCityData.t1.active[i];
                        const t2Active = tierCityData.t2.active[i];
                        const t1With = tierCityData.t1.withTarget[i];
                        const t2With = tierCityData.t2.withTarget[i];
                        const t1Avg = tierCityData.t1.avgScale[i];
                        const t2Avg = tierCityData.t2.avgScale[i];
                        const totalTarget = t1Target + t2Target;
                        const totalActive = t1Active + t2Active;
                        const totalWith = t1With + t2With;
                        const weightedAvg = weightedAvgScaleValues[i];
                        totalTargetValues.push(totalTarget);
                        totalActiveValues.push(totalActive);
                        totalWithValues.push(totalWith);

                        totalT1Target += t1Target; totalT2Target += t2Target;
                        totalT1Active += t1Active; totalT2Active += t2Active;
                        totalT1With += t1With; totalT2With += t2With;
                        totalT1AvgScale += t1Avg; totalT2AvgScale += t2Avg;

                        let rowHtml = `<tr style="background:${i % 2 === 0 ? '#ffffff' : '#f9fafb'};">`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;white-space:nowrap;max-width:70px;">${m}</td>`;
                        
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                            rowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t1Target)} (${tierPct(t1Target,totalTarget).toFixed(1)}%)${tierDeltaHtml(t1Target, i>0 ? tierCityData.t1.target[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t1Active)} (${tierPct(t1Active,totalActive).toFixed(1)}%)${tierDeltaHtml(t1Active, i>0 ? tierCityData.t1.active[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t1With)} (${tierPct(t1With,totalWith).toFixed(1)}%)${tierDeltaHtml(t1With, i>0 ? tierCityData.t1.withTarget[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${t1Avg.toFixed(1)}${tierDeltaHtml(t1Avg, i>0 ? tierCityData.t1.avgScale[i-1] : null)}</td>`;
                        }
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                            rowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t2Target)} (${tierPct(t2Target,totalTarget).toFixed(1)}%)${tierDeltaHtml(t2Target, i>0 ? tierCityData.t2.target[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t2Active)} (${tierPct(t2Active,totalActive).toFixed(1)}%)${tierDeltaHtml(t2Active, i>0 ? tierCityData.t2.active[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${tierFmtNum(t2With)} (${tierPct(t2With,totalWith).toFixed(1)}%)${tierDeltaHtml(t2With, i>0 ? tierCityData.t2.withTarget[i-1] : null)}</td>`
                                + `<td style="padding:8px;border:1px solid #e5e7eb;white-space:nowrap;">${t2Avg.toFixed(1)}${tierDeltaHtml(t2Avg, i>0 ? tierCityData.t2.avgScale[i-1] : null)}</td>`;
                        }
                        
                        rowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;white-space:nowrap;">${tierFmtNum(totalTarget)} (100%)${tierDeltaHtml(totalTarget, i>0 ? totalTargetValues[i-1] : null)}</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;white-space:nowrap;">${tierFmtNum(totalActive)} (100%)${tierDeltaHtml(totalActive, i>0 ? totalActiveValues[i-1] : null)}</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;white-space:nowrap;">${tierFmtNum(totalWith)} (100%)${tierDeltaHtml(totalWith, i>0 ? totalWithValues[i-1] : null)}</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;white-space:nowrap;">${weightedAvg.toFixed(1)}${tierDeltaHtml(weightedAvg, i>0 ? weightedAvgScaleValues[i-1] : null)}</td>`
                            + `</tr>`;
                        
                        headerHtml += rowHtml;
                    });

                    const countMonths = months.length;
                    const avgT1Target = totalT1Target / countMonths;
                    const avgT2Target = totalT2Target / countMonths;
                    const avgT1Active = totalT1Active / countMonths;
                    const avgT2Active = totalT2Active / countMonths;
                    const avgT1With = totalT1With / countMonths;
                    const avgT2With = totalT2With / countMonths;
                    const avgT1AvgScale = totalT1AvgScale / countMonths;
                    const avgT2AvgScale = totalT2AvgScale / countMonths;
                    const totalTargetAll = avgT1Target + avgT2Target;
                    const totalActiveAll = avgT1Active + avgT2Active;
                    const totalWithAll = avgT1With + avgT2With;
                    // Calculate weighted average scale dynamically
                    let sumWeightedAvg = 0;
                    months.forEach((m, i) => {
                        const t1w = tierCityData.t1.withTarget[i];
                        const t2w = tierCityData.t2.withTarget[i];
                        const totalW = t1w + t2w;
                        if (totalW > 0) {
                            sumWeightedAvg += (t1w * tierCityData.t1.avgScale[i] + t2w * tierCityData.t2.avgScale[i]) / totalW;
                        }
                    });
                    const totalWeightedAvg = sumWeightedAvg / countMonths;
                    
                    // Calculate totals for Total columns
                    let sumTotalTarget = 0, sumTotalActive = 0, sumTotalWith = 0;
                    months.forEach((m, i) => {
                        sumTotalTarget += tierCityData.t1.target[i] + tierCityData.t2.target[i];
                        sumTotalActive += tierCityData.t1.active[i] + tierCityData.t2.active[i];
                        sumTotalWith += tierCityData.t1.withTarget[i] + tierCityData.t2.withTarget[i];
                    });
                    const avgTotalTarget = sumTotalTarget / countMonths;
                    const avgTotalActive = sumTotalActive / countMonths;
                    const avgTotalWith = sumTotalWith / countMonths;

                    let avgRowHtml = `<tr style="background:#e0f2fe;font-weight:700;">
                        <td style="padding:8px;border:1px solid #e5e7eb;max-width:70px;">Avg Sep–Feb</td>`;
                    
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        avgRowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT1Target.toFixed(0))} (${tierPct(avgT1Target,totalTargetAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT1Active.toFixed(0))} (${tierPct(avgT1Active,totalActiveAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT1With.toFixed(0))} (${tierPct(avgT1With,totalWithAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${avgT1AvgScale.toFixed(1)}</td>`;
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        avgRowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT2Target.toFixed(0))} (${tierPct(avgT2Target,totalTargetAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT2Active.toFixed(0))} (${tierPct(avgT2Active,totalActiveAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgT2With.toFixed(0))} (${tierPct(avgT2With,totalWithAll).toFixed(1)}%)</td>`
                            + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${avgT2AvgScale.toFixed(1)}</td>`;
                    }
                    
                    avgRowHtml += `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgTotalTarget.toFixed(0))} (100%)</td>`
                        + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgTotalActive.toFixed(0))} (100%)</td>`
                        + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${tierFmtNum(avgTotalWith.toFixed(0))} (100%)</td>`
                        + `<td style="padding:8px;border:1px solid #e5e7eb;word-wrap:break-word;overflow-wrap:break-word;">${totalWeightedAvg.toFixed(1)}</td>`
                    + `</tr>`;

                    overviewTable.innerHTML = headerHtml + avgRowHtml + '</tbody>';

                    // Performance table (partners with target)
                    const buildPerfRows = () => {
                        let h = '<thead><tr style="background:#0f172a;color:#fff;">'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">Month</th>';
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Good</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Average</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Bad</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Total</th>';
                        }
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Good</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Average</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Bad</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Total</th>';
                        }
                        h += '<th style="padding:8px;border:1px solid #e5e7eb;">Combined</th>'
                            + '</tr></thead><tbody>';
                        let sumT1 = 0, sumT2 = 0;
                        let sumT1G = 0, sumT1A = 0, sumT1B = 0;
                        let sumT2G = 0, sumT2A = 0, sumT2B = 0;
                        months.forEach((m, i) => {
                            const tg = tierCityData.perf.t1.good[i], ta = tierCityData.perf.t1.average[i], tb = tierCityData.perf.t1.bad[i];
                            const t2g = tierCityData.perf.t2.good[i], t2a = tierCityData.perf.t2.average[i], t2b = tierCityData.perf.t2.bad[i];
                            const t1Total = tg + ta + tb;
                            const t2Total = t2g + t2a + t2b;
                            const combined = t1Total + t2Total;
                            sumT1 += t1Total; sumT2 += t2Total;
                            sumT1G += tg; sumT1A += ta; sumT1B += tb;
                            sumT2G += t2g; sumT2A += t2a; sumT2B += t2b;
                            const bg = i % 2 === 0 ? '#ffffff' : '#f9fafb';
                            h += `<tr style="background:${bg};">
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;">${m}</td>`;
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(tg)} (${tierPct(tg,t1Total).toFixed(1)}%)${tierDeltaHtml(tg, i>0 ? tierCityData.perf.t1.good[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(ta)} (${tierPct(ta,t1Total).toFixed(1)}%)${tierDeltaHtml(ta, i>0 ? tierCityData.perf.t1.average[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(tb)} (${tierPct(tb,t1Total).toFixed(1)}%)${tierDeltaHtml(tb, i>0 ? tierCityData.perf.t1.bad[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t1Total)} (100%)${tierDeltaHtml(t1Total, i>0 ? (tierCityData.perf.t1.good[i-1] + tierCityData.perf.t1.average[i-1] + tierCityData.perf.t1.bad[i-1]) : null)}</td>`;
                            }
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(t2g)} (${tierPct(t2g,t2Total).toFixed(1)}%)${tierDeltaHtml(t2g, i>0 ? tierCityData.perf.t2.good[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(t2a)} (${tierPct(t2a,t2Total).toFixed(1)}%)${tierDeltaHtml(t2a, i>0 ? tierCityData.perf.t2.average[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(t2b)} (${tierPct(t2b,t2Total).toFixed(1)}%)${tierDeltaHtml(t2b, i>0 ? tierCityData.perf.t2.bad[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t2Total)} (100%)${tierDeltaHtml(t2Total, i>0 ? (tierCityData.perf.t2.good[i-1] + tierCityData.perf.t2.average[i-1] + tierCityData.perf.t2.bad[i-1]) : null)}</td>`;
                            }
                            h += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(combined)} (100%)${tierDeltaHtml(combined, i>0 ? ((tierCityData.perf.t1.good[i-1] + tierCityData.perf.t1.average[i-1] + tierCityData.perf.t1.bad[i-1]) + (tierCityData.perf.t2.good[i-1] + tierCityData.perf.t2.average[i-1] + tierCityData.perf.t2.bad[i-1])) : null)}</td>
                            </tr>`;
                        });
                    const countMonths = months.length;
                    const avgT1 = sumT1 / countMonths;
                    const avgT2 = sumT2 / countMonths;
                    const avgT1G = sumT1G / countMonths, avgT1A = sumT1A / countMonths, avgT1B = sumT1B / countMonths;
                    const avgT2G = sumT2G / countMonths, avgT2A = sumT2A / countMonths, avgT2B = sumT2B / countMonths;
                    const totalCombined = avgT1 + avgT2;
                    h += `<tr style="background:#e0f2fe;font-weight:700;">
                        <td style="padding:8px;border:1px solid #e5e7eb;">Avg Sep–Feb</td>`;
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1G.toFixed(0))} (${tierPct(avgT1G,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1A.toFixed(0))} (${tierPct(avgT1A,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1B.toFixed(0))} (${tierPct(avgT1B,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1.toFixed(0))} (100%)</td>`;
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2G.toFixed(0))} (${tierPct(avgT2G,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2A.toFixed(0))} (${tierPct(avgT2A,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2B.toFixed(0))} (${tierPct(avgT2B,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2.toFixed(0))} (100%)</td>`;
                    }
                    h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(totalCombined.toFixed(0))} (100%)</td>
                    </tr>`;
                        perfTable.innerHTML = h + '</tbody>';
                    };

                    // Scale table (partners with target)
                    const buildScaleRows = () => {
                        let h = '<thead><tr style="background:#0f172a;color:#fff;">'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">Month</th>';
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Big</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Mid</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Small</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Total</th>';
                        }
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Big</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Mid</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Small</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Total</th>';
                        }
                        h += '<th style="padding:8px;border:1px solid #e5e7eb;">Combined</th>'
                            + '</tr></thead><tbody>';
                        let sumT1 = 0, sumT2 = 0;
                        let sumB1 = 0, sumM1 = 0, sumS1 = 0;
                        let sumB2 = 0, sumM2 = 0, sumS2 = 0;
                        months.forEach((m, i) => {
                            const b1 = tierCityData.size.t1.big[i], m1 = tierCityData.size.t1.mid[i], s1 = tierCityData.size.t1.small[i];
                            const b2 = tierCityData.size.t2.big[i], m2 = tierCityData.size.t2.mid[i], s2 = tierCityData.size.t2.small[i];
                            const t1Total = b1 + m1 + s1;
                            const t2Total = b2 + m2 + s2;
                            const combined = t1Total + t2Total;
                            sumT1 += t1Total; sumT2 += t2Total;
                            sumB1 += b1; sumM1 += m1; sumS1 += s1;
                            sumB2 += b2; sumM2 += m2; sumS2 += s2;
                            const bg = i % 2 === 0 ? '#ffffff' : '#f9fafb';
                            h += `<tr style="background:${bg};">
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;">${m}</td>`;
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b1)} (${tierPct(b1,t1Total).toFixed(1)}%)${tierDeltaHtml(b1, i>0 ? tierCityData.size.t1.big[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(m1)} (${tierPct(m1,t1Total).toFixed(1)}%)${tierDeltaHtml(m1, i>0 ? tierCityData.size.t1.mid[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(s1)} (${tierPct(s1,t1Total).toFixed(1)}%)${tierDeltaHtml(s1, i>0 ? tierCityData.size.t1.small[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t1Total)} (100%)${tierDeltaHtml(t1Total, i>0 ? (tierCityData.size.t1.big[i-1] + tierCityData.size.t1.mid[i-1] + tierCityData.size.t1.small[i-1]) : null)}</td>`;
                            }
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b2)} (${tierPct(b2,t2Total).toFixed(1)}%)${tierDeltaHtml(b2, i>0 ? tierCityData.size.t2.big[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(m2)} (${tierPct(m2,t2Total).toFixed(1)}%)${tierDeltaHtml(m2, i>0 ? tierCityData.size.t2.mid[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(s2)} (${tierPct(s2,t2Total).toFixed(1)}%)${tierDeltaHtml(s2, i>0 ? tierCityData.size.t2.small[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t2Total)} (100%)${tierDeltaHtml(t2Total, i>0 ? (tierCityData.size.t2.big[i-1] + tierCityData.size.t2.mid[i-1] + tierCityData.size.t2.small[i-1]) : null)}</td>`;
                            }
                            h += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(combined)} (100%)${tierDeltaHtml(combined, i>0 ? ((tierCityData.size.t1.big[i-1] + tierCityData.size.t1.mid[i-1] + tierCityData.size.t1.small[i-1]) + (tierCityData.size.t2.big[i-1] + tierCityData.size.t2.mid[i-1] + tierCityData.size.t2.small[i-1])) : null)}</td>
                            </tr>`;
                        });
                    const countMonths = months.length;
                    const avgT1 = sumT1 / countMonths;
                    const avgT2 = sumT2 / countMonths;
                    const avgB1 = sumB1 / countMonths, avgM1 = sumM1 / countMonths, avgS1 = sumS1 / countMonths;
                    const avgB2 = sumB2 / countMonths, avgM2 = sumM2 / countMonths, avgS2 = sumS2 / countMonths;
                    const totalCombined = avgT1 + avgT2;
                    h += `<tr style="background:#e0f2fe;font-weight:700;">
                        <td style="padding:8px;border:1px solid #e5e7eb;">Avg Sep–Feb</td>`;
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB1.toFixed(0))} (${tierPct(avgB1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgM1.toFixed(0))} (${tierPct(avgM1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgS1.toFixed(0))} (${tierPct(avgS1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1.toFixed(0))} (100%)</td>`;
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB2.toFixed(0))} (${tierPct(avgB2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgM2.toFixed(0))} (${tierPct(avgM2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgS2.toFixed(0))} (${tierPct(avgS2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2.toFixed(0))} (100%)</td>`;
                    }
                    h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(totalCombined.toFixed(0))} (100%)</td>
                    </tr>`;
                        scaleTable.innerHTML = h + '</tbody>';
                    };

                    // Target performance table (values)
                    const buildTargetPerf = () => {
                        let h = '<thead><tr style="background:#111827;color:#fff;">'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">Month</th>';
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Good</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Average</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Bad</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Total</th>';
                        }
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Good</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Average</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Bad</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Total</th>';
                        }
                        h += '<th style="padding:8px;border:1px solid #e5e7eb;">Combined</th>'
                            + '</tr></thead><tbody>';
                        let sumT1 = 0, sumT2 = 0;
                        let sumG1 = 0, sumA1 = 0, sumB1 = 0;
                        let sumG2 = 0, sumA2 = 0, sumB2 = 0;
                        months.forEach((m, i) => {
                            const g1 = tierCityData.targetPerf.t1.good[i], a1 = tierCityData.targetPerf.t1.average[i], b1 = tierCityData.targetPerf.t1.bad[i];
                            const g2 = tierCityData.targetPerf.t2.good[i], a2 = tierCityData.targetPerf.t2.average[i], b2 = tierCityData.targetPerf.t2.bad[i];
                            const t1Total = g1 + a1 + b1;
                            const t2Total = g2 + a2 + b2;
                            const combined = t1Total + t2Total;
                            sumT1 += t1Total; sumT2 += t2Total;
                            sumG1 += g1; sumA1 += a1; sumB1 += b1;
                            sumG2 += g2; sumA2 += a2; sumB2 += b2;
                            const bg = i % 2 === 0 ? '#ffffff' : '#f9fafb';
                            h += `<tr style="background:${bg};">
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;">${m}</td>`;
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(g1)} (${tierPct(g1,t1Total).toFixed(1)}%)${tierDeltaHtml(g1, i>0 ? tierCityData.targetPerf.t1.good[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(a1)} (${tierPct(a1,t1Total).toFixed(1)}%)${tierDeltaHtml(a1, i>0 ? tierCityData.targetPerf.t1.average[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b1)} (${tierPct(b1,t1Total).toFixed(1)}%)${tierDeltaHtml(b1, i>0 ? tierCityData.targetPerf.t1.bad[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t1Total)} (100%)${tierDeltaHtml(t1Total, i>0 ? (tierCityData.targetPerf.t1.good[i-1] + tierCityData.targetPerf.t1.average[i-1] + tierCityData.targetPerf.t1.bad[i-1]) : null)}</td>`;
                            }
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(g2)} (${tierPct(g2,t2Total).toFixed(1)}%)${tierDeltaHtml(g2, i>0 ? tierCityData.targetPerf.t2.good[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(a2)} (${tierPct(a2,t2Total).toFixed(1)}%)${tierDeltaHtml(a2, i>0 ? tierCityData.targetPerf.t2.average[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b2)} (${tierPct(b2,t2Total).toFixed(1)}%)${tierDeltaHtml(b2, i>0 ? tierCityData.targetPerf.t2.bad[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t2Total)} (100%)${tierDeltaHtml(t2Total, i>0 ? (tierCityData.targetPerf.t2.good[i-1] + tierCityData.targetPerf.t2.average[i-1] + tierCityData.targetPerf.t2.bad[i-1]) : null)}</td>`;
                            }
                            h += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(combined)} (100%)${tierDeltaHtml(combined, i>0 ? ((tierCityData.targetPerf.t1.good[i-1] + tierCityData.targetPerf.t1.average[i-1] + tierCityData.targetPerf.t1.bad[i-1]) + (tierCityData.targetPerf.t2.good[i-1] + tierCityData.targetPerf.t2.average[i-1] + tierCityData.targetPerf.t2.bad[i-1])) : null)}</td>
                            </tr>`;
                        });
                    const countMonths = months.length;
                    const avgT1 = sumT1 / countMonths;
                    const avgT2 = sumT2 / countMonths;
                    const avgG1 = sumG1 / countMonths, avgA1 = sumA1 / countMonths, avgB1 = sumB1 / countMonths;
                    const avgG2 = sumG2 / countMonths, avgA2 = sumA2 / countMonths, avgB2 = sumB2 / countMonths;
                    const totalCombined = avgT1 + avgT2;
                    h += `<tr style="background:#e0f2fe;font-weight:700;">
                        <td style="padding:8px;border:1px solid #e5e7eb;">Avg Sep–Feb</td>`;
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgG1.toFixed(0))} (${tierPct(avgG1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgA1.toFixed(0))} (${tierPct(avgA1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB1.toFixed(0))} (${tierPct(avgB1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1.toFixed(0))} (100%)</td>`;
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgG2.toFixed(0))} (${tierPct(avgG2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgA2.toFixed(0))} (${tierPct(avgA2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB2.toFixed(0))} (${tierPct(avgB2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2.toFixed(0))} (100%)</td>`;
                    }
                    h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(totalCombined.toFixed(0))} (100%)</td>
                    </tr>`;
                        targetPerfTable.innerHTML = h + '</tbody>';
                    };

                    // Target scale table (values)
                    const buildTargetScale = () => {
                        let h = '<thead><tr style="background:#111827;color:#fff;">'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">Month</th>';
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Big</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Mid</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Small</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T1 Total</th>';
                        }
                        if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                            h += '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Big</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Mid</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Small</th>'
                            + '<th style="padding:8px;border:1px solid #e5e7eb;">T2 Total</th>';
                        }
                        h += '<th style="padding:8px;border:1px solid #e5e7eb;">Combined</th>'
                            + '</tr></thead><tbody>';
                        let sumT1 = 0, sumT2 = 0;
                        let sumB1 = 0, sumM1 = 0, sumS1 = 0;
                        let sumB2 = 0, sumM2 = 0, sumS2 = 0;
                        months.forEach((m, i) => {
                            const b1 = tierCityData.targetSize.t1.big[i], m1 = tierCityData.targetSize.t1.mid[i], s1 = tierCityData.targetSize.t1.small[i];
                            const b2 = tierCityData.targetSize.t2.big[i], m2 = tierCityData.targetSize.t2.mid[i], s2 = tierCityData.targetSize.t2.small[i];
                            const t1Total = b1 + m1 + s1;
                            const t2Total = b2 + m2 + s2;
                            const combined = t1Total + t2Total;
                            sumT1 += t1Total; sumT2 += t2Total;
                            sumB1 += b1; sumM1 += m1; sumS1 += s1;
                            sumB2 += b2; sumM2 += m2; sumS2 += s2;
                            const bg = i % 2 === 0 ? '#ffffff' : '#f9fafb';
                            h += `<tr style="background:${bg};">
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;">${m}</td>`;
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b1)} (${tierPct(b1,t1Total).toFixed(1)}%)${tierDeltaHtml(b1, i>0 ? tierCityData.targetSize.t1.big[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(m1)} (${tierPct(m1,t1Total).toFixed(1)}%)${tierDeltaHtml(m1, i>0 ? tierCityData.targetSize.t1.mid[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(s1)} (${tierPct(s1,t1Total).toFixed(1)}%)${tierDeltaHtml(s1, i>0 ? tierCityData.targetSize.t1.small[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t1Total)} (100%)${tierDeltaHtml(t1Total, i>0 ? (tierCityData.targetSize.t1.big[i-1] + tierCityData.targetSize.t1.mid[i-1] + tierCityData.targetSize.t1.small[i-1]) : null)}</td>`;
                            }
                            if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                                h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(b2)} (${tierPct(b2,t2Total).toFixed(1)}%)${tierDeltaHtml(b2, i>0 ? tierCityData.targetSize.t2.big[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(m2)} (${tierPct(m2,t2Total).toFixed(1)}%)${tierDeltaHtml(m2, i>0 ? tierCityData.targetSize.t2.mid[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(s2)} (${tierPct(s2,t2Total).toFixed(1)}%)${tierDeltaHtml(s2, i>0 ? tierCityData.targetSize.t2.small[i-1] : null)}</td>
                                <td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(t2Total)} (100%)${tierDeltaHtml(t2Total, i>0 ? (tierCityData.targetSize.t2.big[i-1] + tierCityData.targetSize.t2.mid[i-1] + tierCityData.targetSize.t2.small[i-1]) : null)}</td>`;
                            }
                            h += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:700;">${tierFmtNum(combined)} (100%)${tierDeltaHtml(combined, i>0 ? ((tierCityData.targetSize.t1.big[i-1] + tierCityData.targetSize.t1.mid[i-1] + tierCityData.targetSize.t1.small[i-1]) + (tierCityData.targetSize.t2.big[i-1] + tierCityData.targetSize.t2.mid[i-1] + tierCityData.targetSize.t2.small[i-1])) : null)}</td>
                            </tr>`;
                        });
                    const countMonths = months.length;
                    const avgT1 = sumT1 / countMonths;
                    const avgT2 = sumT2 / countMonths;
                    const avgB1 = sumB1 / countMonths, avgM1 = sumM1 / countMonths, avgS1 = sumS1 / countMonths;
                    const avgB2 = sumB2 / countMonths, avgM2 = sumM2 / countMonths, avgS2 = sumS2 / countMonths;
                    const totalCombined = avgT1 + avgT2;
                    h += `<tr style="background:#e0f2fe;font-weight:700;">
                        <td style="padding:8px;border:1px solid #e5e7eb;">Avg Sep–Feb</td>`;
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB1.toFixed(0))} (${tierPct(avgB1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgM1.toFixed(0))} (${tierPct(avgM1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgS1.toFixed(0))} (${tierPct(avgS1,avgT1).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT1.toFixed(0))} (100%)</td>`;
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgB2.toFixed(0))} (${tierPct(avgB2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgM2.toFixed(0))} (${tierPct(avgM2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgS2.toFixed(0))} (${tierPct(avgS2,avgT2).toFixed(1)}%)</td>
                        <td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(avgT2.toFixed(0))} (100%)</td>`;
                    }
                    h += `<td style="padding:8px;border:1px solid #e5e7eb;">${tierFmtNum(totalCombined.toFixed(0))} (100%)</td>
                    </tr>`;
                        targetScaleTable.innerHTML = h + '</tbody>';
                    };

                    buildPerfRows();
                    buildScaleRows();
                    buildTargetPerf();
                    buildTargetScale();
                }

                let tierTargetChart, tierPartnersChart;
                function buildTierCharts() {
                    const months = tierCityData.months;
                    let t1Target = tierFilterSelected === 't2' ? [] : tierCityData.t1.target;
                    let t2Target = tierFilterSelected === 't1' ? [] : tierCityData.t2.target;
                    let totalTarget = months.map((_, i) => (t1Target[i] || 0) + (t2Target[i] || 0));

                    let t1With = tierFilterSelected === 't2' ? [] : tierCityData.t1.withTarget;
                    let t2With = tierFilterSelected === 't1' ? [] : tierCityData.t2.withTarget;
                    let totalWith = months.map((_, i) => (t1With[i] || 0) + (t2With[i] || 0));

                    const targetCtx = document.getElementById('tierTargetChart');
                    const partnersCtx = document.getElementById('tierPartnersChart');
                    if (!targetCtx || !partnersCtx || typeof Chart === 'undefined') return;

                    if (tierTargetChart) tierTargetChart.destroy();
                    if (tierPartnersChart) tierPartnersChart.destroy();

                    let targetDatasets = [];
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        targetDatasets.push({ label: 'T1 Target', data: t1Target, backgroundColor: '#2563eb' });
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        targetDatasets.push({ label: 'T2 Target', data: t2Target, backgroundColor: '#60a5fa' });
                    }
                    targetDatasets.push({ label: 'Total Target (line)', data: totalTarget, type: 'line', borderColor: '#111827', borderWidth: 2.5, tension: 0.25, pointRadius: 4, pointBorderWidth: 0, yAxisID: 'y', fill: false });

                    tierTargetChart = new Chart(targetCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: targetDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true },
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    display: true,
                                    color: (ctx) => ctx.dataset.type === 'line' ? '#0f172a' : '#ffffff',
                                    font: { weight: '700', size: 11 },
                                    anchor: 'center',
                                    align: 'center',
                                    clip: false,
                                    formatter: (value, ctx) => {
                                        if (ctx.dataset.type === 'line') return tierFmtNum(value);
                                        const total = ctx.chart.data.datasets
                                            .filter(ds => !ds.type || ds.type === 'bar')
                                            .reduce((acc, ds) => acc + (ds.data[ctx.dataIndex] || 0), 0);
                                        const pct = tierPct(value, total).toFixed(1);
                                        return `${tierFmtNum(value)}\n(${pct}%)`;
                                    }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });

                    let partnersDatasets = [];
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't1') {
                        partnersDatasets.push({ label: 'T1 Partners with Target', data: t1With, backgroundColor: '#10b981' });
                    }
                    if (tierFilterSelected === 'both' || tierFilterSelected === 't2') {
                        partnersDatasets.push({ label: 'T2 Partners with Target', data: t2With, backgroundColor: '#34d399' });
                    }
                    partnersDatasets.push({ label: 'Total (line)', data: totalWith, type: 'line', borderColor: '#0f172a', borderWidth: 2.5, tension: 0.25, pointRadius: 4, pointBorderWidth: 0, yAxisID: 'y', fill: false });

                    tierPartnersChart = new Chart(partnersCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: partnersDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true },
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    display: true,
                                    color: (ctx) => ctx.dataset.type === 'line' ? '#0f172a' : '#ffffff',
                                    font: { weight: '700', size: 11 },
                                    anchor: 'center',
                                    align: 'center',
                                    clip: false,
                                    formatter: (value, ctx) => {
                                        if (ctx.dataset.type === 'line') return tierFmtNum(value);
                                        const total = ctx.chart.data.datasets
                                            .filter(ds => !ds.type || ds.type === 'bar')
                                            .reduce((acc, ds) => acc + (ds.data[ctx.dataIndex] || 0), 0);
                                        const pct = tierPct(value, total).toFixed(1);
                                        return `${tierFmtNum(value)}\n(${pct}%)`;
                                    }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }

                // City-wise data
                const cityWiseData = {
                    cities: ['Abha', 'Al Ahsa', 'Al Kharj', 'Buraydah', 'Dammam', 'Hafar Al Batin', 'Hail', 'Jazan', 'Jeddah', 'Jubail', 'Makkah', 'Medina', 'Najran', 'Riyadh', 'Tabuk', 'Taif', 'Yanbu'],
                    months: ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'],
                    data: {
                        'Abha': { partners: [29, 27, 26, 19, 18, 15], target: [729, 678, 627, 354, 339, 297] },
                        'Al Ahsa': { partners: [38, 37, 36, 33, 32, 28], target: [1308, 1320, 1279, 936, 858, 818] },
                        'Al Kharj': { partners: [7, 7, 8, 7, 7, 8], target: [550, 590, 530, 386, 380, 347] },
                        'Buraydah': { partners: [18, 19, 19, 16, 13, 10], target: [537, 538, 485, 310, 296, 253] },
                        'Dammam': { partners: [71, 82, 89, 76, 76, 64], target: [3600, 3923, 4042, 2803, 2641, 2127] },
                        'Hafar Al Batin': { partners: [13, 13, 12, 8, 8, 7], target: [297, 307, 257, 124, 128, 109] },
                        'Hail': { partners: [14, 14, 13, 7, 7, 5], target: [340, 334, 360, 208, 199, 186] },
                        'Jazan': { partners: [10, 9, 7, 5, 5, 3], target: [188, 212, 173, 92, 95, 74] },
                        'Jeddah': { partners: [84, 106, 131, 116, 95, 83], target: [5155, 5881, 6283, 4500, 4094, 3454] },
                        'Jubail': { partners: [16, 16, 16, 12, 11, 10], target: [450, 471, 432, 275, 244, 230] },
                        'Makkah': { partners: [45, 54, 57, 50, 47, 41], target: [1777, 1760, 1722, 1165, 1074, 935] },
                        'Medina': { partners: [43, 49, 56, 52, 46, 37], target: [2049, 1997, 2028, 1378, 1195, 1131] },
                        'Najran': { partners: [7, 8, 7, 5, 5, 5], target: [200, 169, 145, 82, 76, 78] },
                        'Riyadh': { partners: [158, 199, 231, 226, 215, 200], target: [14086, 14452, 15044, 10712, 10028, 8661] },
                        'Tabuk': { partners: [21, 19, 19, 13, 13, 11], target: [420, 410, 475, 258, 252, 202] },
                        'Taif': { partners: [27, 24, 27, 18, 16, 14], target: [755, 651, 653, 389, 345, 292] },
                        'Yanbu': { partners: [14, 14, 13, 11, 11, 10], target: [352, 313, 302, 210, 209, 171] }
                    }
                };

                let currentCityFilter = [];
                const t1Cities = ['Riyadh', 'Jeddah', 'Dammam', 'Medina', 'Makkah', 'Al Kharj', 'Al Ahsa'];
                const t2Cities = ['Abha', 'Buraydah', 'Hafar Al Batin', 'Hail', 'Jazan', 'Jubail', 'Najran', 'Tabuk', 'Taif', 'Yanbu'];
                let citySortState = { key: null, dir: 'desc' };

                // Partner Age Analysis Data
                const partnerAgeData = {
                    months: ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'],
                    categories: ['New <1 month', 'New <3 months', 'Old >3 months'],
                    data: {
                        'New <1 month': {
                            count: [130, 166, 113, 173, 63, 27],
                            activeCount: [51, 148, 92, 128, 56, 26],
                            target: [1852, 4864, 2600, 2959, 1380, 583],
                            avgScale: [36.3, 32.9, 28.3, 23.1, 24.6, 22.4],
                            goodPartners: [12, 30, 28, 23, 15, 3],
                            avgPartners: [20, 50, 30, 33, 5, 2],
                            badPartners: [19, 63, 26, 38, 28, 4],
                            goodTarget: [380, 1085, 875, 572, 396, 50],
                            avgTarget: [559, 1578, 850, 729, 115, 67],
                            badTarget: [913, 2106, 702, 824, 659, 77],
                            goodAvgScale: [31.7, 36.2, 31.3, 24.9, 26.4, 16.7],
                            avgAvgScale: [28.0, 31.6, 28.3, 22.1, 23.0, 33.5],
                            badAvgScale: [48.1, 33.4, 27.0, 21.7, 23.5, 19.3],
                            bigPartners: [2, 3, 0, 0, 0, 0],
                            midPartners: [16, 40, 12, 14, 5, 1],
                            smallPartners: [33, 100, 72, 80, 43, 8],
                            bigTarget: [85, 161, 0, 0, 0, 0],
                            midTarget: [455, 1452, 448, 498, 161, 42],
                            smallTarget: [1312, 3156, 1979, 1627, 1009, 152],
                            bigAvgScale: [42.5, 53.7, null, null, 0.0, 0.0],
                            midAvgScale: [28.4, 36.3, 37.3, 35.6, 32.2, 42.0],
                            smallAvgScale: [39.8, 31.6, 27.5, 20.3, 23.5, 19.0]
                        },
                        'New <3 months': {
                            count: [120, 131, 208, 231, 161, 131],
                            activeCount: [86, 105, 174, 175, 144, 101],
                            target: [2584, 3449, 6455, 5198, 3574, 2379],
                            avgScale: [30.0, 32.8, 37.1, 29.7, 24.8, 23.6],
                            goodPartners: [34, 45, 64, 64, 42, 38],
                            avgPartners: [36, 47, 68, 85, 74, 55],
                            badPartners: [16, 13, 41, 26, 28, 8],
                            goodTarget: [1177, 1665, 2729, 2411, 1208, 1050],
                            avgTarget: [1024, 1484, 2304, 2229, 1863, 1193],
                            badTarget: [383, 300, 1397, 558, 503, 136],
                            goodAvgScale: [34.6, 37.0, 42.6, 37.7, 28.8, 27.6],
                            avgAvgScale: [28.4, 31.6, 33.9, 26.2, 25.2, 21.7],
                            badAvgScale: [23.9, 23.1, 34.1, 21.5, 18.0, 17.0],
                            bigPartners: [19, 24, 14, 14, 9, 0],
                            midPartners: [56, 68, 98, 100, 56, 13],
                            smallPartners: [11, 13, 61, 61, 79, 88],
                            bigTarget: [985, 1042, 658, 683, 477, 0],
                            midTarget: [1428, 2060, 4165, 3339, 1677, 506],
                            smallTarget: [171, 347, 1607, 1176, 1420, 1873],
                            bigAvgScale: [51.8, 43.4, 47.0, 48.8, 53.0, 0.0],
                            midAvgScale: [25.5, 30.3, 42.5, 33.4, 29.9, 38.9],
                            smallAvgScale: [15.5, 26.7, 26.3, 19.3, 18.0, 21.3]
                        },
                        'Old >3 months': {
                            count: [512, 454, 559, 447, 463, 485],
                            activeCount: [478, 444, 501, 371, 425, 424],
                            target: [28357, 25693, 25782, 16025, 17499, 16403],
                            avgScale: [59.3, 57.9, 51.5, 43.2, 41.2, 38.7],
                            goodPartners: [114, 115, 113, 136, 212, 211],
                            avgPartners: [151, 152, 177, 167, 195, 205],
                            badPartners: [90, 67, 93, 58, 17, 8],
                            goodTarget: [9672, 8333, 7814, 8036, 10745, 9092],
                            avgTarget: [11315, 11533, 10997, 6300, 6352, 7154],
                            badTarget: [3794, 3095, 4350, 1497, 372, 157],
                            goodAvgScale: [84.8, 72.5, 69.2, 59.1, 50.7, 43.1],
                            avgAvgScale: [74.9, 75.9, 62.1, 37.7, 32.6, 34.9],
                            badAvgScale: [42.2, 46.2, 46.8, 25.8, 21.9, 19.6],
                            bigPartners: [38, 47, 68, 73, 72, 77],
                            midPartners: [190, 214, 229, 221, 214, 268],
                            smallPartners: [127, 73, 86, 67, 138, 79],
                            bigTarget: [6127, 6703, 7984, 6058, 4461, 5351],
                            midTarget: [14095, 14197, 12640, 8515, 8760, 9434],
                            smallTarget: [4559, 2061, 2537, 1260, 4248, 1618],
                            bigAvgScale: [161.2, 142.6, 117.4, 83.0, 62.0, 69.5],
                            midAvgScale: [74.2, 66.3, 55.2, 38.5, 40.9, 35.2],
                            smallAvgScale: [35.9, 28.2, 29.5, 18.8, 30.8, 20.5]
                        }
                    }
                };

                let partnerAgeSortState = { key: null, dir: 'desc' };
                let partnerAgeSelectedMonths = null;


                function buildCityWiseTable(filteredCities = null) {
                    const table = document.getElementById('cityWiseTable');
                    if (!table) return;
                    
                    const activeFilter = filteredCities || (currentCityFilter && currentCityFilter.length ? currentCityFilter : null);
                    const citiesToShow = activeFilter || cityWiseData.cities;

                    const getArrow = (key) => {
                        if (citySortState.key !== key) return '↕';
                        return citySortState.dir === 'asc' ? '↑' : '↓';
                    };

                    const getSortValue = (city, key) => {
                        if (key === 'city') return city.toLowerCase();
                        const [metric, idxStr] = key.split('_');
                        const idx = parseInt(idxStr, 10);
                        const data = cityWiseData.data[city];
                        if (!data || Number.isNaN(idx)) return Number.NEGATIVE_INFINITY;
                        if (metric === 'partners') return data.partners[idx];
                        if (metric === 'target') return data.target[idx];
                        if (metric === 'avgscale') {
                            return data.partners[idx] > 0 ? data.target[idx] / data.partners[idx] : 0;
                        }
                        return Number.NEGATIVE_INFINITY;
                    };

                    let sortedCities = [...citiesToShow];
                    if (citySortState.key) {
                        sortedCities.sort((a, b) => {
                            const aVal = getSortValue(a, citySortState.key);
                            const bVal = getSortValue(b, citySortState.key);
                            const isString = typeof aVal === 'string' || typeof bVal === 'string';
                            if (isString) {
                                return citySortState.dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                            }
                            const aNum = Number.isFinite(aVal) ? aVal : Number.NEGATIVE_INFINITY;
                            const bNum = Number.isFinite(bVal) ? bVal : Number.NEGATIVE_INFINITY;
                            return citySortState.dir === 'asc' ? aNum - bNum : bNum - aNum;
                        });
                    }
                    
                    let html = `<thead><tr style="background:#1e5a8e;color:#fff;"><th class="city-sortable" data-sort-key="city" style="padding:8px;border:1px solid #e5e7eb;cursor:pointer;" rowspan="2">City <span style="font-size:11px;">${getArrow('city')}</span></th>`;
                    
                    cityWiseData.months.forEach(m => {
                        html += `<th style="padding:8px;border:1px solid #e5e7eb;" colspan="3">${m}</th>`;
                    });
                    
                    html += '</tr><tr style="background:#1e5a8e;color:#fff;">';
                    for (let i = 0; i < cityWiseData.months.length; i++) {
                        html += `<th class="city-sortable" data-sort-key="partners_${i}" style="padding:8px;border:1px solid #e5e7eb;font-size:11px;cursor:pointer;">Partners <span style="font-size:10px;">${getArrow(`partners_${i}`)}</span></th>`;
                        html += `<th class="city-sortable" data-sort-key="target_${i}" style="padding:8px;border:1px solid #e5e7eb;font-size:11px;cursor:pointer;">Target <span style="font-size:10px;">${getArrow(`target_${i}`)}</span></th>`;
                        html += `<th class="city-sortable" data-sort-key="avgscale_${i}" style="padding:8px;border:1px solid #e5e7eb;font-size:11px;cursor:pointer;">Avg Scale <span style="font-size:10px;">${getArrow(`avgscale_${i}`)}</span></th>`;
                    }
                    html += '</tr></thead><tbody>';
                    
                    sortedCities.forEach(city => {
                        const cityData = cityWiseData.data[city];
                        html += `<tr style="background:${cityWiseData.cities.indexOf(city) % 2 === 0 ? '#ffffff' : '#f9fafb'};">`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;white-space:nowrap;">${city}</td>`;
                        
                        cityData.partners.forEach((partners, idx) => {
                            const target = cityData.target[idx];
                            const prevTarget = idx > 0 ? cityData.target[idx - 1] : null;
                            const momPct = prevTarget ? (((target - prevTarget) / prevTarget) * 100).toFixed(1) : null;
                            const momHtml = momPct !== null ? ` <span style="color:${parseFloat(momPct) >= 0 ? '#10b981' : '#dc2626'};font-weight:600;font-size:10px;">${parseFloat(momPct) >= 0 ? '↑' : '↓'} ${Math.abs(momPct)}%</span>` : '';
                            
                            const avgScale = partners > 0 ? (target / partners).toFixed(1) : '0.0';
                            const prevPartners = idx > 0 ? cityData.partners[idx - 1] : null;
                            const prevAvgScaleRaw = (prevPartners && prevPartners > 0 && prevTarget) ? (prevTarget / prevPartners) : null;
                            const curAvgScaleRaw = partners > 0 ? target / partners : 0;
                            const prevAvgScaleRounded = prevAvgScaleRaw !== null ? Number(prevAvgScaleRaw.toFixed(1)) : null;
                            const curAvgScaleRounded = Number(curAvgScaleRaw.toFixed(1));
                            const avgScaleMom = prevAvgScaleRounded !== null && prevAvgScaleRounded !== 0
                                ? (((curAvgScaleRounded - prevAvgScaleRounded) / prevAvgScaleRounded) * 100).toFixed(1)
                                : null;
                            const avgScaleMomHtml = avgScaleMom !== null ? ` <span style="color:${parseFloat(avgScaleMom) >= 0 ? '#10b981' : '#dc2626'};font-weight:600;font-size:10px;">${parseFloat(avgScaleMom) >= 0 ? '↑' : '↓'} ${Math.abs(avgScaleMom)}%</span>` : '';
                            
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${partners}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${target.toLocaleString()}${momHtml}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${avgScale}${avgScaleMomHtml}</td>`;
                        });
                        
                        html += '</tr>';
                    });
                    
                    // Grand Total row
                    html += `<tr style="background:#e5e7eb;font-weight:bold;">`;
                    html += `<td style="padding:8px;border:1px solid #e5e7eb;">Grand Total</td>`;
                    
                    cityWiseData.months.forEach((m, idx) => {
                        let totalPartners = 0, totalTarget = 0, prevTotalTarget = 0, prevTotalPartners = 0;
                        citiesToShow.forEach(city => {
                            totalPartners += cityWiseData.data[city].partners[idx];
                            totalTarget += cityWiseData.data[city].target[idx];
                            if (idx > 0) {
                                prevTotalTarget += cityWiseData.data[city].target[idx - 1];
                                prevTotalPartners += cityWiseData.data[city].partners[idx - 1];
                            }
                        });
                        
                        const momPct = idx > 0 ? (((totalTarget - prevTotalTarget) / prevTotalTarget) * 100).toFixed(1) : null;
                        const momHtml = momPct !== null ? ` <span style="color:${parseFloat(momPct) >= 0 ? '#10b981' : '#dc2626'};font-weight:600;font-size:10px;">${parseFloat(momPct) >= 0 ? '↑' : '↓'} ${Math.abs(momPct)}%</span>` : '';
                        
                        const totalAvgScale = totalPartners > 0 ? (totalTarget / totalPartners).toFixed(1) : '0.0';
                        const prevAvgScaleRaw = (idx > 0 && prevTotalPartners > 0) ? (prevTotalTarget / prevTotalPartners) : null;
                        const curAvgScaleRaw = totalPartners > 0 ? totalTarget / totalPartners : 0;
                        const prevAvgScaleRounded = prevAvgScaleRaw !== null ? Number(prevAvgScaleRaw.toFixed(1)) : null;
                        const curAvgScaleRounded = Number(curAvgScaleRaw.toFixed(1));
                        const avgScaleMom = prevAvgScaleRounded !== null && prevAvgScaleRounded !== 0
                            ? (((curAvgScaleRounded - prevAvgScaleRounded) / prevAvgScaleRounded) * 100).toFixed(1)
                            : null;
                        const avgScaleMomHtml = avgScaleMom !== null ? ` <span style="color:${parseFloat(avgScaleMom) >= 0 ? '#10b981' : '#dc2626'};font-weight:600;font-size:10px;">${parseFloat(avgScaleMom) >= 0 ? '↑' : '↓'} ${Math.abs(avgScaleMom)}%</span>` : '';
                        
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${totalPartners}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${totalTarget.toLocaleString()}${momHtml}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${totalAvgScale}${avgScaleMomHtml}</td>`;
                    });
                    
                    html += '</tr></tbody>';
                    table.innerHTML = html;

                    // Attach sorting handlers
                    table.querySelectorAll('.city-sortable').forEach(th => {
                        th.addEventListener('click', () => {
                            const key = th.getAttribute('data-sort-key');
                            if (citySortState.key === key) {
                                citySortState.dir = citySortState.dir === 'asc' ? 'desc' : 'asc';
                            } else {
                                citySortState.key = key;
                                citySortState.dir = 'desc';
                            }
                            buildCityWiseTable(activeFilter);
                        });
                    });
                }

                let cityTargetChart, cityPartnersChart, cityCombinedTrendChart;
                let selectedMonths = null; // Track selected months
                let selectedCities = []; // Track selected cities

                function buildCityCharts(monthIndices = null, filteredCities = null) {
                    const trendCtx = document.getElementById('cityTargetTrendChart');
                    const partnersCtx = document.getElementById('cityPartnersChart');
                    const combinedCtx = document.getElementById('cityCombinedTrendChart');
                    if (!trendCtx || !partnersCtx || !combinedCtx || typeof Chart === 'undefined') return;
                    
                    // Destroy existing charts if they exist
                    if (cityTargetChart) cityTargetChart.destroy();
                    if (cityPartnersChart) cityPartnersChart.destroy();
                    if (cityCombinedTrendChart) cityCombinedTrendChart.destroy();
                    
                    // If monthIndices not provided, use all months
                    if (!monthIndices) monthIndices = [0, 1, 2, 3, 4, 5];
                    
                    const monthLabels = monthIndices.map(i => cityWiseData.months[i]);
                    
                    const datasets = [];
                    const colors = ['#1e3a8a', '#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe'];
                    const citiesToShow = filteredCities || cityWiseData.cities;
                    
                    citiesToShow.forEach((city, idx) => {
                        const tierTag = t1Cities.includes(city) ? 'T1' : 'T2';
                        const selectedData = monthIndices.map(i => cityWiseData.data[city].target[i]);
                        datasets.push({
                            label: `${tierTag} · ${city}`,
                            data: selectedData,
                            borderColor: colors[idx % colors.length],
                            backgroundColor: colors[idx % colors.length] + '20',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        });
                    });
                    
                    cityTargetChart = new Chart(trendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: monthLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true }, // show only the hovered city
                            plugins: {
                                legend: { position: 'right', maxWidth: 150 },
                                tooltip: {
                                    mode: 'nearest',
                                    intersect: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`
                                    }
                                },
                                datalabels: {
                                    // show first (Aug) and last (Jan) points only
                                    display: (ctx) => ctx.dataIndex === 0 || ctx.dataIndex === ctx.dataset.data.length - 1,
                                    align: 'end',
                                    anchor: 'end',
                                    backgroundColor: 'rgba(255,255,255,0.9)',
                                    borderRadius: 4,
                                    padding: 4,
                                    color: '#111827',
                                    font: { size: 11, weight: '600' }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() }, grid: { color: 'rgba(107,114,128,0.15)', lineWidth: 1, drawBorder: false } },
                                x: { grid: { color: 'rgba(107,114,128,0.12)', lineWidth: 1, drawBorder: false } }
                            }
                        }
                    });
                    
                    const partnerDatasets = [];
                    citiesToShow.forEach((city, idx) => {
                        const tierTag = t1Cities.includes(city) ? 'T1' : 'T2';
                        const selectedData = monthIndices.map(i => cityWiseData.data[city].partners[i]);
                        partnerDatasets.push({
                            label: `${tierTag} · ${city}`,
                            data: selectedData,
                            borderColor: colors[idx % colors.length],
                            backgroundColor: colors[idx % colors.length] + '20',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        });
                    });
                    
                    cityPartnersChart = new Chart(partnersCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: monthLabels,
                            datasets: partnerDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true }, // show only the hovered city
                            plugins: {
                                legend: { position: 'right', maxWidth: 150 },
                                tooltip: {
                                    mode: 'nearest',
                                    intersect: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`
                                    }
                                },
                                datalabels: {
                                    // show first (Aug) and last (Jan) points only
                                    display: (ctx) => ctx.dataIndex === 0 || ctx.dataIndex === ctx.dataset.data.length - 1,
                                    align: 'end',
                                    anchor: 'end',
                                    backgroundColor: 'rgba(255,255,255,0.9)',
                                    borderRadius: 4,
                                    padding: 4,
                                    color: '#111827',
                                    font: { size: 11, weight: '600' }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() }, grid: { color: 'rgba(107,114,128,0.15)', lineWidth: 1, drawBorder: false } },
                                x: { grid: { color: 'rgba(107,114,128,0.12)', lineWidth: 1, drawBorder: false } }
                            }
                        }
                    });

                    // Build Avg Scale line per city
                    const calcMomSeries = (series) => series.map((val, idx) => {
                        if (idx === 0) return null;
                        const prev = series[idx - 1];
                        if (!prev) return null;
                        return Number((((val - prev) / prev) * 100).toFixed(1));
                    });

                    const avgScaleDatasets = [];
                    citiesToShow.forEach((city, idx) => {
                        const tierTag = t1Cities.includes(city) ? 'T1' : 'T2';
                        const cData = cityWiseData.data[city];
                        const targetSeries = monthIndices.map(i => cData.target[i]);
                        const partnersSeries = monthIndices.map(i => cData.partners[i]);
                        const avgScaleSeries = targetSeries.map((t, j) => partnersSeries[j] > 0 ? Number((t / partnersSeries[j]).toFixed(1)) : 0);
                        const momSeries = calcMomSeries(avgScaleSeries);

                        avgScaleDatasets.push({
                            label: `${tierTag} · ${city}`,
                            data: avgScaleSeries,
                            borderColor: colors[idx % colors.length],
                            backgroundColor: colors[idx % colors.length] + '20',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            _momSeries: momSeries
                        });
                    });

                    // --- Populate summary cards ---
                    const latestIdx = monthIndices[monthIndices.length - 1];
                    const prevIdx = monthIndices.length >= 2 ? monthIndices[monthIndices.length - 2] : null;
                    const cityScaleInfo = citiesToShow.map(city => {
                        const cD = cityWiseData.data[city];
                        const t = cD.target[latestIdx], p = cD.partners[latestIdx];
                        const scale = p > 0 ? Number((t / p).toFixed(1)) : 0;
                        let mom = null;
                        if (prevIdx !== null) {
                            const tP = cD.target[prevIdx], pP = cD.partners[prevIdx];
                            const prevScale = pP > 0 ? Number((tP / pP).toFixed(1)) : 0;
                            if (prevScale > 0) mom = Number((((scale - prevScale) / prevScale) * 100).toFixed(1));
                        }
                        const tier = t1Cities.includes(city) ? 'T1' : 'T2';
                        return { city, tier, scale, mom };
                    });
                    const fmtMom = (m) => { if (m === null) return '—'; const s = m >= 0 ? '+' : ''; return `MoM ${s}${m}%`; };
                    const momColor = (m) => m === null ? '#6b7280' : m >= 0 ? '#059669' : '#dc2626';

                    const highest = [...cityScaleInfo].sort((a, b) => b.scale - a.scale)[0];
                    if (highest) {
                        document.getElementById('cardHighVal').textContent = highest.scale.toFixed(1);
                        document.getElementById('cardHighCity').textContent = `${highest.tier} · ${highest.city}`;
                        const el = document.getElementById('cardHighMom');
                        el.textContent = fmtMom(highest.mom); el.style.color = momColor(highest.mom);
                    }
                    const lowest = [...cityScaleInfo].sort((a, b) => a.scale - b.scale)[0];
                    if (lowest) {
                        document.getElementById('cardLowVal').textContent = lowest.scale.toFixed(1);
                        document.getElementById('cardLowCity').textContent = `${lowest.tier} · ${lowest.city}`;
                        const el = document.getElementById('cardLowMom');
                        el.textContent = fmtMom(lowest.mom); el.style.color = momColor(lowest.mom);
                    }
                    const withMom = cityScaleInfo.filter(c => c.mom !== null);
                    const best = [...withMom].sort((a, b) => b.mom - a.mom)[0];
                    if (best) {
                        document.getElementById('cardBestMomVal').textContent = `+${best.mom}%`;
                        document.getElementById('cardBestMomCity').textContent = `${best.tier} · ${best.city}`;
                        document.getElementById('cardBestMomScale').textContent = `Scale: ${best.scale.toFixed(1)}`;
                    }
                    const worst = [...withMom].sort((a, b) => a.mom - b.mom)[0];
                    if (worst) {
                        document.getElementById('cardWorstMomVal').textContent = `${worst.mom}%`;
                        document.getElementById('cardWorstMomCity').textContent = `${worst.tier} · ${worst.city}`;
                        document.getElementById('cardWorstMomScale').textContent = `Scale: ${worst.scale.toFixed(1)}`;
                    }

                    cityCombinedTrendChart = new Chart(combinedCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: monthLabels,
                            datasets: avgScaleDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true },
                            layout: {
                                padding: { top: 14, left: 18, right: 18 }
                            },
                            plugins: {
                                legend: { position: 'right', maxWidth: 150 },
                                tooltip: {
                                    mode: 'nearest',
                                    intersect: true,
                                    callbacks: {
                                        label: (ctx) => {
                                            const label = ctx.dataset.label || '';
                                            const val = ctx.parsed.y;
                                            const mom = ctx.dataset._momSeries ? ctx.dataset._momSeries[ctx.dataIndex] : null;
                                            let valStr = val.toFixed(1);
                                            if (mom !== null && mom !== undefined) {
                                                const sign = mom >= 0 ? '+' : '';
                                                valStr += ` (MoM ${sign}${mom.toFixed(1)}%)`;
                                            }
                                            return `${label}: ${valStr}`;
                                        }
                                    }
                                },
                                datalabels: {
                                    display: (ctx) => ctx.dataIndex === 0 || ctx.dataIndex === ctx.dataset.data.length - 1,
                                    align: (ctx) => {
                                        if (ctx.dataIndex === 0) return 'right';
                                        if (ctx.dataIndex === ctx.dataset.data.length - 1) return 'left';
                                        return 'top';
                                    },
                                    anchor: 'center',
                                    offset: (ctx) => (ctx.dataIndex === 0 || ctx.dataIndex === ctx.dataset.data.length - 1 ? 8 : 4),
                                    clamp: true,
                                    clip: false,
                                    backgroundColor: 'rgba(255,255,255,0.9)',
                                    borderRadius: 4,
                                    padding: 4,
                                    color: '#111827',
                                    font: { size: 11, weight: '600' },
                                    formatter: (val) => {
                                        if (val === null || val === undefined) return '';
                                        return Number(val).toFixed(1);
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(107,114,128,0.15)', lineWidth: 1, drawBorder: false },
                                    ticks: { color: '#4b5563', callback: (v) => Number(v).toFixed(1) },
                                    title: { display: true, text: 'Avg Scale (Target ÷ Partners)', color: '#92400e', font: { size: 10, weight: '600' } }
                                },
                                x: { grid: { color: 'rgba(107,114,128,0.12)', lineWidth: 1, drawBorder: false } }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }

                function setupCityWiseTableFocus() {
                    const table = document.getElementById('cityWiseTable');
                    if (!table) return;
                    
                    table.addEventListener('click', function(e) {
                        const row = e.target.closest('tbody tr');
                        if (!row) return;
                        
                        // If clicking the same focused row, remove focus
                        if (row.classList.contains('row-focused')) {
                            row.classList.remove('row-focused');
                            table.classList.remove('has-focus');
                        } else {
                            // Remove focus from all rows
                            table.querySelectorAll('tbody tr.row-focused').forEach(r => r.classList.remove('row-focused'));
                            // Add focus to clicked row
                            row.classList.add('row-focused');
                            table.classList.add('has-focus');
                        }
                    });
                    
                    // Click outside table to clear focus
                    document.addEventListener('click', function(e) {
                        if (!table.contains(e.target)) {
                            table.querySelectorAll('tbody tr.row-focused').forEach(r => r.classList.remove('row-focused'));
                            table.classList.remove('has-focus');
                        }
                    });
                }

                function initCityWiseSection() {
                    buildCityWiseTable();
                    buildCityCharts();
                    setupCityWiseTableFocus();
                    
                    document.getElementById('cityCompareBtn')?.addEventListener('click', () => {
                        const m1Idx = parseInt(document.getElementById('cityMonthFilter1').value);
                        const m2Idx = parseInt(document.getElementById('cityMonthFilter2').value);
                        if (isNaN(m1Idx) || isNaN(m2Idx)) {
                            alert('Please select both months to compare');
                            return;
                        }
                        
                        const m1Month = cityWiseData.months[m1Idx];
                        const m2Month = cityWiseData.months[m2Idx];
                        const table = document.getElementById('cityWiseTable');
                        if (!table) return;
                        
                        // Build comparison table with only two months
                        let html = '<thead><tr style="background:#059669;color:#fff;"><th style="padding:8px;border:1px solid #e5e7eb;">City</th>';
                        html += `<th style="padding:8px;border:1px solid #e5e7eb;" colspan="3">${m1Month}</th>`;
                        html += `<th style="padding:8px;border:1px solid #e5e7eb;" colspan="3">${m2Month}</th>`;
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;" colspan="2">Change</th>';
                        html += '</tr><tr style="background:#059669;color:#fff;">';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;"></th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Partners</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Target</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Avg</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Partners</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Target</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">Avg</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;"># Change</th>';
                        html += '<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">% Change</th>';
                        html += '</tr></thead><tbody>';
                        
                        const citiesToDisplay = selectedCities.length > 0 ? selectedCities : cityWiseData.cities;
                        
                        citiesToDisplay.forEach(city => {
                            const cityData = cityWiseData.data[city];
                            const p1 = cityData.partners[m1Idx];
                            const t1 = cityData.target[m1Idx];
                            const avg1 = (t1 / p1).toFixed(1);
                            const p2 = cityData.partners[m2Idx];
                            const t2 = cityData.target[m2Idx];
                            const avg2 = (t2 / p2).toFixed(1);
                            
                            const changeNum = t2 - t1;
                            const changePct = ((changeNum / t1) * 100).toFixed(1);
                            const changeColor = changeNum >= 0 ? '#10b981' : '#dc2626';
                            const changeArrow = changeNum >= 0 ? '↑' : '↓';
                            
                            html += `<tr style="background:${cityWiseData.cities.indexOf(city) % 2 === 0 ? '#ffffff' : '#f9fafb'};">`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;white-space:nowrap;">${city}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${p1}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${t1.toLocaleString()}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${avg1}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${p2}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${t2.toLocaleString()}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;">${avg2}</td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;"><span style="color:${changeColor};font-weight:600;">${changeArrow} ${Math.abs(changeNum).toLocaleString()}</span></td>`;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;"><span style="color:${changeColor};font-weight:600;">${changeArrow} ${Math.abs(changePct)}%</span></td>`;
                            html += '</tr>';
                        });
                        
                        // Grand Total row
                        let totalP1 = 0, totalT1 = 0, totalP2 = 0, totalT2 = 0;
                        citiesToDisplay.forEach(city => {
                            totalP1 += cityWiseData.data[city].partners[m1Idx];
                            totalT1 += cityWiseData.data[city].target[m1Idx];
                            totalP2 += cityWiseData.data[city].partners[m2Idx];
                            totalT2 += cityWiseData.data[city].target[m2Idx];
                        });
                        
                        const totalAvg1 = (totalT1 / totalP1).toFixed(1);
                        const totalAvg2 = (totalT2 / totalP2).toFixed(1);
                        const totalChangeNum = totalT2 - totalT1;
                        const totalChangePct = ((totalChangeNum / totalT1) * 100).toFixed(1);
                        const totalChangeColor = totalChangeNum >= 0 ? '#10b981' : '#dc2626';
                        const totalChangeArrow = totalChangeNum >= 0 ? '↑' : '↓';
                        
                        html += `<tr style="background:#e5e7eb;font-weight:bold;">`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;">Grand Total</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalP1}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalT1.toLocaleString()}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalAvg1}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalP2}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalT2.toLocaleString()}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;">${totalAvg2}</td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;"><span style="color:${totalChangeColor};font-weight:600;">${totalChangeArrow} ${Math.abs(totalChangeNum).toLocaleString()}</span></td>`;
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;"><span style="color:${totalChangeColor};font-weight:600;">${totalChangeArrow} ${Math.abs(totalChangePct)}%</span></td>`;
                        html += '</tr></tbody>';
                        
                        table.innerHTML = html;
                        
                        // Store selected months and rebuild charts with both month and city filters
                        selectedMonths = [m1Idx, m2Idx];
                        buildCityCharts(null, selectedCities.length > 0 ? selectedCities : null);
                    });
                    
                    // Add reset button functionality
                    const resetBtn = document.createElement('button');
                    resetBtn.id = 'cityResetBtn';
                    resetBtn.textContent = 'Reset to All Months';
                    resetBtn.style.cssText = 'padding:8px 20px;background:#6b7280;color:white;border:none;border-radius:6px;font-weight:600;cursor:pointer;margin-left:10px;';
                    document.getElementById('cityCompareBtn')?.parentNode?.appendChild(resetBtn);
                    
                    document.getElementById('cityResetBtn')?.addEventListener('click', () => {
                        // Reset dropdowns to default state
                        document.getElementById('cityMonthFilter1').value = '';
                        document.getElementById('cityMonthFilter2').value = '';
                        
                        selectedMonths = null;
                        buildCityWiseTable();
                        buildCityCharts();
                    });
                    
                    // City slicer chip functionality
                    document.querySelectorAll('.city-chip').forEach(chip => {
                        chip.addEventListener('click', function() {
                            const city = this.getAttribute('data-city');
                            
                            if (selectedCities.includes(city)) {
                                selectedCities = selectedCities.filter(c => c !== city);
                                this.style.background = '#e5e7eb';
                                this.style.color = '#1f2937';
                                this.style.borderColor = '#d1d5db';
                            } else {
                                selectedCities.push(city);
                                this.style.background = '#3b82f6';
                                this.style.color = 'white';
                                this.style.borderColor = '#3b82f6';
                            }
                        });
                    });
                    
                    // Apply Filter button
                    document.getElementById('cityFilterBtn')?.addEventListener('click', () => {
                        if (selectedCities.length === 0) {
                            alert('Please select at least one city');
                            return;
                        }
                        
                        currentCityFilter = selectedCities;
                        buildCityWiseTable(selectedCities);
                        // Apply both month filter (if set) and city filter
                        if (selectedMonths) {
                            buildCityCharts(selectedMonths, selectedCities);
                        } else {
                            buildCityCharts(null, selectedCities);
                        }
                    });
                    
                    // Clear All button
                    document.getElementById('cityFilterResetBtn')?.addEventListener('click', () => {
                        selectedCities = [];
                        currentCityFilter = [];
                        
                        // Reset all chip styles
                        document.querySelectorAll('.city-chip').forEach(chip => {
                            chip.style.background = '#e5e7eb';
                            chip.style.color = '#1f2937';
                            chip.style.borderColor = '#d1d5db';
                        });
                        
                        buildCityWiseTable();
                        // If month filter was applied, keep showing only those months with all cities
                        if (selectedMonths) {
                            buildCityCharts(selectedMonths);
                        } else {
                            buildCityCharts();
                        }
                    });
                }

                // Partner Movement Analysis Section
                let partnerMovementTrendChart, partnerMovementQualityChart;
                
                const partnerMovementData = {
                    months: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
                    // All Partners overall totals (not broken by quality)
                    allPartners: {
                        total: [615, 697, 767, 674, 625, 551],
                        increase: [381, 341, 386, 120, 212, 153],
                        decrease: [124, 162, 188, 458, 240, 284],
                        noChange: [110, 194, 193, 96, 173, 114]
                    },
                    // By quality breakdown
                    increase: {
                        good: [97, 92, 122, 44, 109, 82],
                        average: [93, 82, 95, 27, 79, 47],
                        bad: [70, 56, 44, 8, 15, 7]
                    },
                    decrease: {
                        good: [28, 38, 30, 132, 78, 109],
                        average: [62, 81, 93, 230, 123, 163],
                        bad: [34, 42, 65, 95, 39, 12]
                    },
                    noChange: {
                        good: [35, 45, 53, 47, 82, 61],
                        average: [52, 60, 87, 28, 72, 52],
                        bad: [21, 86, 51, 19, 19, 1]
                    }
                };

                let currentMovementQuality = 'allPartners';

                function buildPartnerMovementCharts(quality = 'allPartners') {
                    const trendCtx = document.getElementById('partnerMovementTrendChart');
                    const qualityCtx = document.getElementById('partnerMovementQualityChart');
                    
                    if (!trendCtx || !qualityCtx) return;
                    
                    if (partnerMovementTrendChart) partnerMovementTrendChart.destroy();
                    if (partnerMovementQualityChart) partnerMovementQualityChart.destroy();
                    
                    // Calculate totals based on quality filter
                    let increaseTotals, decreaseTotals, noChangeTotals, totalPartners;
                    
                    if (quality === 'allPartners') {
                        // Use overall totals from allPartners data
                        increaseTotals = partnerMovementData.allPartners.increase;
                        decreaseTotals = partnerMovementData.allPartners.decrease;
                        noChangeTotals = partnerMovementData.allPartners.noChange;
                        totalPartners = partnerMovementData.allPartners.total;
                    } else {
                        const getTotals = (type) => {
                            return partnerMovementData.months.map((_, idx) => {
                                if (quality === 'all') {
                                    return partnerMovementData[type].good[idx] + 
                                           partnerMovementData[type].average[idx] + 
                                           partnerMovementData[type].bad[idx];
                                } else {
                                    return partnerMovementData[type][quality][idx];
                                }
                            });
                        };
                        
                        increaseTotals = getTotals('increase');
                        decreaseTotals = getTotals('decrease');
                        noChangeTotals = getTotals('noChange');
                        // Calculate totals for percentage
                        totalPartners = partnerMovementData.months.map((_, idx) => {
                            return increaseTotals[idx] + decreaseTotals[idx] + noChangeTotals[idx];
                        });
                    }
                    
                    // Get quality label for tooltips
                    const getQualityLabel = () => {
                        if (quality === 'allPartners') return '';
                        if (quality === 'all') return '';
                        return quality.charAt(0).toUpperCase() + quality.slice(1) + ' ';
                    };
                    const qualityLabel = getQualityLabel();
                    
                    // Trend Chart
                    partnerMovementTrendChart = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: partnerMovementData.months,
                            datasets: [
                                {
                                    label: qualityLabel + 'Partners Increased',
                                    data: increaseTotals,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                },
                                {
                                    label: qualityLabel + 'Partners Decreased',
                                    data: decreaseTotals,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                },
                                {
                                    label: qualityLabel + 'Partners No Change',
                                    data: noChangeTotals,
                                    borderColor: '#6b7280',
                                    backgroundColor: 'rgba(107, 114, 128, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            ...chartOptions,
                            plugins: {
                                ...chartOptions.plugins,
                                title: {
                                    display: true,
                                    text: quality === 'allPartners' ? 'All Partners' : quality === 'all' ? 'All Quality Levels' : `${quality.charAt(0).toUpperCase() + quality.slice(1)} Partners Only`
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const monthIdx = context.dataIndex;
                                            const total = totalPartners[monthIdx];
                                            const pct = ((value / total) * 100).toFixed(1);
                                            return `${context.dataset.label}: ${value} (${pct}% of total)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Number of Partners' }
                                }
                            }
                        }
                    });
                    
                    // Quality Distribution Chart (Stacked Bar)
                    let datasets = [];
                    
                    // For 'allPartners', show movement type distribution instead of quality distribution
                    if (quality === 'allPartners') {
                        datasets = [
                            {
                                label: 'Increased',
                                data: partnerMovementData.allPartners.increase,
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Decreased',
                                data: partnerMovementData.allPartners.decrease,
                                backgroundColor: '#ef4444'
                            },
                            {
                                label: 'No Change',
                                data: partnerMovementData.allPartners.noChange,
                                backgroundColor: '#6b7280'
                            }
                        ];
                    } else {
                        if (quality === 'all' || quality === 'good') {
                            datasets.push({
                                label: 'Good',
                                data: [
                                    partnerMovementData.increase.good[0] + partnerMovementData.decrease.good[0] + partnerMovementData.noChange.good[0],
                                    partnerMovementData.increase.good[1] + partnerMovementData.decrease.good[1] + partnerMovementData.noChange.good[1],
                                    partnerMovementData.increase.good[2] + partnerMovementData.decrease.good[2] + partnerMovementData.noChange.good[2],
                                    partnerMovementData.increase.good[3] + partnerMovementData.decrease.good[3] + partnerMovementData.noChange.good[3],
                                    partnerMovementData.increase.good[4] + partnerMovementData.decrease.good[4] + partnerMovementData.noChange.good[4],
                                    partnerMovementData.increase.good[5] + partnerMovementData.decrease.good[5] + partnerMovementData.noChange.good[5]
                                ],
                                backgroundColor: '#10b981'
                            });
                        }
                        if (quality === 'all' || quality === 'average') {
                            datasets.push({
                                label: 'Average',
                                data: [
                                    partnerMovementData.increase.average[0] + partnerMovementData.decrease.average[0] + partnerMovementData.noChange.average[0],
                                    partnerMovementData.increase.average[1] + partnerMovementData.decrease.average[1] + partnerMovementData.noChange.average[1],
                                    partnerMovementData.increase.average[2] + partnerMovementData.decrease.average[2] + partnerMovementData.noChange.average[2],
                                    partnerMovementData.increase.average[3] + partnerMovementData.decrease.average[3] + partnerMovementData.noChange.average[3],
                                    partnerMovementData.increase.average[4] + partnerMovementData.decrease.average[4] + partnerMovementData.noChange.average[4],
                                    partnerMovementData.increase.average[5] + partnerMovementData.decrease.average[5] + partnerMovementData.noChange.average[5]
                                ],
                                backgroundColor: '#f59e0b'
                            });
                        }
                        if (quality === 'all' || quality === 'bad') {
                            datasets.push({
                                label: 'Bad',
                                data: [
                                    partnerMovementData.increase.bad[0] + partnerMovementData.decrease.bad[0] + partnerMovementData.noChange.bad[0],
                                    partnerMovementData.increase.bad[1] + partnerMovementData.decrease.bad[1] + partnerMovementData.noChange.bad[1],
                                    partnerMovementData.increase.bad[2] + partnerMovementData.decrease.bad[2] + partnerMovementData.noChange.bad[2],
                                    partnerMovementData.increase.bad[3] + partnerMovementData.decrease.bad[3] + partnerMovementData.noChange.bad[3],
                                    partnerMovementData.increase.bad[4] + partnerMovementData.decrease.bad[4] + partnerMovementData.noChange.bad[4],
                                    partnerMovementData.increase.bad[5] + partnerMovementData.decrease.bad[5] + partnerMovementData.noChange.bad[5]
                                ],
                                backgroundColor: '#ef4444'
                            });
                        }
                    }
                    
                    partnerMovementQualityChart = new Chart(qualityCtx, {
                        type: 'bar',
                        data: {
                            labels: partnerMovementData.months,
                            datasets: datasets
                        },
                        options: {
                            ...chartOptions,
                            plugins: {
                                ...chartOptions.plugins,
                                title: {
                                    display: true,
                                    text: quality === 'allPartners' ? 'Movement Distribution - All Partners' : quality === 'all' ? 'Quality Distribution - All Partners' : `${quality.charAt(0).toUpperCase() + quality.slice(1)} Partners Only`
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const monthIdx = context.dataIndex;
                                            const total = totalPartners[monthIdx];
                                            const pct = ((value / total) * 100).toFixed(1);
                                            return `${context.dataset.label}: ${value} (${pct}% of total)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    display: true,
                                    color: 'white',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    },
                                    anchor: 'center',
                                    align: 'center',
                                    formatter: (value) => {
                                        return value > 0 ? value : '';
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: true },
                                y: { 
                                    stacked: true,
                                    beginAtZero: true,
                                    title: { display: true, text: 'Number of Partners' }
                                }
                            }
                        }
                    });
                }

                // Quality filter chip handler
                document.addEventListener('DOMContentLoaded', function() {
                    // Build Partner Movement table with percentages and MoM
                    function buildPartnerMovementTable() {
                        const tbody = document.getElementById('partnerMovementTableBody');
                        if (!tbody) return;
                        
                        tbody.innerHTML = '';
                        
                        const subtotals = [492, 582, 640, 630, 616, 534];
                        
                        partnerMovementData.months.forEach((month, idx) => {
                            const bg = idx % 2 === 0 ? '#f9fafb' : '#ffffff';
                            let html = `<tr style="background: ${bg};">
                                <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${month}</td>`;
                            
                            // Total Increase columns (Good, Average, Bad)
                            [partnerMovementData.increase.good[idx], partnerMovementData.increase.average[idx], partnerMovementData.increase.bad[idx]].forEach((val, col) => {
                                const pct = ((val / subtotals[idx]) * 100).toFixed(1);
                                let momColor = '#6b7280';
                                let momVal = '—';
                                
                                if (idx > 0) {
                                    const prevVal = col === 0 ? partnerMovementData.increase.good[idx-1] : col === 1 ? partnerMovementData.increase.average[idx-1] : partnerMovementData.increase.bad[idx-1];
                                    let momPct;
                                    if (prevVal === 0) {
                                        momPct = val > 0 ? 100 : 0;
                                    } else {
                                        momPct = (((val - prevVal) / prevVal) * 100);
                                    }
                                    momColor = momPct >= 0 ? '#10b981' : '#ef4444';
                                    momVal = momPct.toFixed(1);
                                }
                                
                                html += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div>${val} (${pct}%)</div>
                                    <div style="font-size: 11px; color: ${momColor}; font-weight: 600;">${momVal !== '—' ? (momVal >= 0 ? '+' : '') + momVal + '%' : momVal}</div>
                                </td>`;
                            });
                            
                            // Total Decrease columns (Good, Average, Bad)
                            [partnerMovementData.decrease.good[idx], partnerMovementData.decrease.average[idx], partnerMovementData.decrease.bad[idx]].forEach((val, col) => {
                                const pct = ((val / subtotals[idx]) * 100).toFixed(1);
                                let momColor = '#6b7280';
                                let momVal = '—';
                                
                                if (idx > 0) {
                                    const prevVal = col === 0 ? partnerMovementData.decrease.good[idx-1] : col === 1 ? partnerMovementData.decrease.average[idx-1] : partnerMovementData.decrease.bad[idx-1];
                                    let momPct;
                                    if (prevVal === 0) {
                                        momPct = val > 0 ? 100 : 0;
                                    } else {
                                        momPct = (((val - prevVal) / prevVal) * 100);
                                    }
                                    momColor = momPct >= 0 ? '#10b981' : '#ef4444';
                                    momVal = momPct.toFixed(1);
                                }
                                
                                html += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div>${val} (${pct}%)</div>
                                    <div style="font-size: 11px; color: ${momColor}; font-weight: 600;">${momVal !== '—' ? (momVal >= 0 ? '+' : '') + momVal + '%' : momVal}</div>
                                </td>`;
                            });
                            
                            // No Change columns (Good, Average, Bad)
                            [partnerMovementData.noChange.good[idx], partnerMovementData.noChange.average[idx], partnerMovementData.noChange.bad[idx]].forEach((val, col) => {
                                const pct = ((val / subtotals[idx]) * 100).toFixed(1);
                                let momColor = '#6b7280';
                                let momVal = '—';
                                
                                if (idx > 0) {
                                    const prevVal = col === 0 ? partnerMovementData.noChange.good[idx-1] : col === 1 ? partnerMovementData.noChange.average[idx-1] : partnerMovementData.noChange.bad[idx-1];
                                    let momPct;
                                    if (prevVal === 0) {
                                        momPct = val > 0 ? 100 : 0;
                                    } else {
                                        momPct = (((val - prevVal) / prevVal) * 100);
                                    }
                                    momColor = momPct >= 0 ? '#10b981' : '#ef4444';
                                    momVal = momPct.toFixed(1);
                                }
                                
                                html += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div>${val} (${pct}%)</div>
                                    <div style="font-size: 11px; color: ${momColor}; font-weight: 600;">${momVal !== '—' ? (momVal >= 0 ? '+' : '') + momVal + '%' : momVal}</div>
                                </td>`;
                            });
                            
                            // Subtotal
                            html += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;">${subtotals[idx]}</td></tr>`;
                            tbody.innerHTML += html;
                        });
                        
                        // Add average row
                        const avgIncrease = {
                            good: 98, average: 82, bad: 35
                        };
                        const avgDecrease = {
                            good: 62, average: 117, bad: 46
                        };
                        const avgNoChange = {
                            good: 46, average: 50, bad: 28
                        };
                        const avgSubtotal = 564;
                        
                        let avgHtml = `<tr style="background: #0891b2; color: white; font-weight: 700;">
                            <td style="padding: 10px; border: 1px solid #e5e7eb;">Avr (Aug-Feb)</td>`;
                        
                        [avgIncrease.good, avgIncrease.average, avgIncrease.bad].forEach(val => {
                            const pct = ((val / avgSubtotal) * 100).toFixed(1);
                            avgHtml += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${val} (${pct}%)</td>`;
                        });
                        
                        [avgDecrease.good, avgDecrease.average, avgDecrease.bad].forEach(val => {
                            const pct = ((val / avgSubtotal) * 100).toFixed(1);
                            avgHtml += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${val} (${pct}%)</td>`;
                        });
                        
                        [avgNoChange.good, avgNoChange.average, avgNoChange.bad].forEach(val => {
                            const pct = ((val / avgSubtotal) * 100).toFixed(1);
                            avgHtml += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${val} (${pct}%)</td>`;
                        });
                        
                        avgHtml += `<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${avgSubtotal}</td></tr>`;
                        tbody.innerHTML += avgHtml;
                    }
                    
                    buildPartnerMovementTable();
                    
                    const qualityChips = document.querySelectorAll('.movement-quality-chip');
                    qualityChips.forEach(chip => {
                        chip.addEventListener('click', function() {
                            qualityChips.forEach(c => {
                                c.style.background = 'white';
                                c.style.color = '#374151';
                                c.style.borderColor = '#d1d5db';
                                c.classList.remove('active');
                            });
                            
                            this.style.background = '#06b6d4';
                            this.style.color = 'white';
                            this.style.borderColor = '#06b6d4';
                            this.classList.add('active');
                            
                            const quality = this.getAttribute('data-quality');
                            currentMovementQuality = quality;
                            buildPartnerMovementCharts(quality);
                        });
                    });
                    
                    // Initialize charts
                    setTimeout(() => {
                        buildPartnerMovementCharts('allPartners');
                    }, 500);
                });

                let partnerAgeTrendChart, partnerAgeScaleChart;
                let selectedAgeCategory = 'all';

                function buildPartnerAgeTable(monthIndices = null, categoryFilter = 'all') {
                    const table = document.getElementById('partnerAgeTable');
                    if (!table) return;
                    
                    const displayMonths = monthIndices || [5, 4, 3, 2, 1, 0];
                    const categoriesToShow = categoryFilter === 'all' ? partnerAgeData.categories : [categoryFilter];

                    const getArrow = (key) => {
                        if (partnerAgeSortState.key !== key) return '↕';
                        return partnerAgeSortState.dir === 'asc' ? '↑' : '↓';
                    };

                    let html = `<thead><tr style="background:#6b21a8;color:#fff;"><th class="pa-sortable" data-sort-key="metric" style="padding:10px;border:1px solid #e5e7eb;cursor:pointer;position:sticky;left:0;z-index:12;background:#6b21a8;min-width:200px;" rowspan="2">Metric <span style="font-size:11px;">${getArrow('metric')}</span></th>`;
                    
                    const colsPerMonth = (categoriesToShow.length * 2) + 1; // Each category has 2 cols (value + MoM%) + 1 Total/Avr
                    displayMonths.forEach(idx => {
                        html += `<th style="padding:8px;border:1px solid #e5e7eb;font-size:12px;text-align:center;" colspan="${colsPerMonth}">${partnerAgeData.months[idx]}</th>`;
                    });
                    html += '</tr>';
                    
                    html += '<tr style="background:#6b21a8;color:#fff;">';
                    displayMonths.forEach(() => {
                        categoriesToShow.forEach(cat => {
                            const shortName = cat.split(' ')[0] + ' ' + cat.split(' ')[1];
                            html += `<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;">${shortName}</th>`;
                            html += `<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;background:#8b5cf6;">MoM%</th>`;
                        });
                        html += `<th style="padding:8px;border:1px solid #e5e7eb;font-size:11px;background:#059669;color:#ffffff;font-weight:700;">Total/Avr</th>`;
                    });
                    html += '</tr></thead><tbody>';

                    const metrics = [
                        { key: 'count', label: 'Total Active Partners' },
                        { key: 'activeCount', label: 'Total Partners With Target' },
                        { key: 'target', label: 'Target Total' },
                        { key: 'avgScale', label: 'Avg Scale' },
                        { key: 'goodPartners', label: '# of Good Partners with Target' },
                        { key: 'avgPartners', label: '# of Average Partners with Target' },
                        { key: 'badPartners', label: '# of Bad Partners with Target' },
                        { key: 'goodTarget', label: 'Good Partners Target' },
                        { key: 'avgTarget', label: 'Average Partners Target' },
                        { key: 'badTarget', label: 'Bad Partners Target' },
                        { key: 'goodAvgScale', label: 'Good Partners Avg Scale' },
                        { key: 'avgAvgScale', label: 'Average Partners Avg Scale' },
                        { key: 'badAvgScale', label: 'Bad Partners Avg Scale' },
                        { key: 'bigPartners', label: '# of Big Partners with Target' },
                        { key: 'midPartners', label: '# of Mid Partners with Target' },
                        { key: 'smallPartners', label: '# of Small Partners with Target' },
                        { key: 'bigTarget', label: 'Big Partners Target' },
                        { key: 'midTarget', label: 'Mid Partners Target' },
                        { key: 'smallTarget', label: 'Small Partners Target' },
                        { key: 'bigAvgScale', label: 'Big Partners Avg Scale' },
                        { key: 'midAvgScale', label: 'Mid Partners Avg Scale' },
                        { key: 'smallAvgScale', label: 'Small Partners Avg Scale' }
                    ];

                    let sortedMetrics = [...metrics];
                    if (partnerAgeSortState.key) {
                        sortedMetrics.sort((a, b) => {
                            const aVal = a.label.toLowerCase();
                            const bVal = b.label.toLowerCase();
                            return partnerAgeSortState.dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                        });
                    }

                    sortedMetrics.forEach((metric, metricIdx) => {
                        let borderColor = '';
                        if (metric.key === 'goodAvgScale') borderColor = '#10b981';
                        else if (metric.key === 'avgAvgScale') borderColor = '#f59e0b';
                        else if (metric.key === 'badAvgScale') borderColor = '#ef4444';
                        else if (metric.key === 'bigAvgScale') borderColor = '#6366f1';
                        else if (metric.key === 'midAvgScale') borderColor = '#8b5cf6';
                        else if (metric.key === 'smallAvgScale') borderColor = '#ec4899';
                        
                        const borderStyle = borderColor ? `border-left: 4px solid ${borderColor};` : '';
                        html += `<tr style="background:${metricIdx % 2 === 0 ? '#ffffff' : '#f9fafb'};${borderStyle}">`;
                        const rowBg = metricIdx % 2 === 0 ? '#ffffff' : '#f9fafb';
                        html += `<td style="padding:8px;border:1px solid #e5e7eb;font-weight:600;white-space:nowrap;font-size:13px;position:sticky;left:0;z-index:2;background:${rowBg};">${metric.label}</td>`;
                        
                        displayMonths.forEach((monthIdx) => {
                            let monthTotal = 0;
                            let categoryCount = 0;
                            const isQualityMetric = metric.key.includes('goodTarget') || metric.key.includes('avgTarget') || metric.key.includes('badTarget') || 
                                                   metric.key.includes('goodAvgScale') || metric.key.includes('avgAvgScale') || metric.key.includes('badAvgScale') ||
                                                   metric.key.includes('bigTarget') || metric.key.includes('midTarget') || metric.key.includes('smallTarget') ||
                                                   metric.key.includes('bigAvgScale') || metric.key.includes('midAvgScale') || metric.key.includes('smallAvgScale');
                            
                            categoriesToShow.forEach(cat => {
                                const data = partnerAgeData.data[cat];
                                const current = data[metric.key][monthIdx];
                                const prev = monthIdx > 0 ? data[metric.key][monthIdx - 1] : null;
                                
                                monthTotal += current;
                                categoryCount++;
                                
                                const value = typeof current === 'number' && current % 1 !== 0 ? current.toFixed(1) : current;
                                const momPct = prev ? (((current - prev) / prev) * 100).toFixed(1) : '—';
                                const momHtml = momPct !== '—' ? `<span style="color:${parseFloat(momPct) >= 0 ? '#10b981' : '#dc2626'};font-weight:600;">${parseFloat(momPct) >= 0 ? '↑' : '↓'} ${Math.abs(momPct)}%</span>` : '—';

                                let displayValue = value;
                                if (metric.key === 'goodAvgScale' || metric.key === 'avgAvgScale' || metric.key === 'badAvgScale' ||
                                    metric.key === 'bigAvgScale' || metric.key === 'midAvgScale' || metric.key === 'smallAvgScale') {
                                    let bgColor, textColor;
                                    if (metric.key === 'goodAvgScale') {
                                        bgColor = '#dbeafe';
                                        textColor = '#1e40af';
                                    } else if (metric.key === 'avgAvgScale') {
                                        bgColor = '#fef3c7';
                                        textColor = '#92400e';
                                    } else if (metric.key === 'badAvgScale') {
                                        bgColor = '#fee2e2';
                                        textColor = '#991b1b';
                                    } else if (metric.key === 'bigAvgScale') {
                                        bgColor = '#e0e7ff';
                                        textColor = '#3730a3';
                                    } else if (metric.key === 'midAvgScale') {
                                        bgColor = '#ede9fe';
                                        textColor = '#5b21b6';
                                    } else {
                                        bgColor = '#fce7f3';
                                        textColor = '#9f1239';
                                    }
                                    displayValue = `<span style="background:${bgColor};color:${textColor};padding:4px 8px;border-radius:12px;font-weight:600;font-size:12px;">${typeof value === 'number' && value > 100 ? value.toLocaleString() : value}</span>`;
                                } else {
                                    displayValue = typeof value === 'number' && value > 100 ? value.toLocaleString() : value;
                                }

                                html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;font-size:12px;">${displayValue}</td>`;
                                html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;background:#f3f4f6;font-size:11px;">${momHtml}</td>`;
                            });

                            // Calculate Total or Average based on metric type
                            let finalValue;
                            if (metric.key === 'avgScale') {
                                // For overall AvgScale: weighted average = Total Target / Total Active Partners
                                let totalTarget = 0;
                                let totalActivePartners = 0;
                                categoriesToShow.forEach(cat => {
                                    totalTarget += partnerAgeData.data[cat]['target'][monthIdx];
                                    totalActivePartners += partnerAgeData.data[cat]['activeCount'][monthIdx];
                                });
                                finalValue = totalActivePartners > 0 ? totalTarget / totalActivePartners : 0;
                            } else if (metric.key.includes('AvgScale')) {
                                // For AvgScale metrics: calculate as Total Target / Total Partners
                                let targetKey, partnersKey;
                                if (metric.key === 'goodAvgScale') {
                                    targetKey = 'goodTarget';
                                    partnersKey = 'goodPartners';
                                } else if (metric.key === 'avgAvgScale') {
                                    targetKey = 'avgTarget';
                                    partnersKey = 'avgPartners';
                                } else if (metric.key === 'badAvgScale') {
                                    targetKey = 'badTarget';
                                    partnersKey = 'badPartners';
                                } else if (metric.key === 'bigAvgScale') {
                                    targetKey = 'bigTarget';
                                    partnersKey = 'bigPartners';
                                } else if (metric.key === 'midAvgScale') {
                                    targetKey = 'midTarget';
                                    partnersKey = 'midPartners';
                                } else if (metric.key === 'smallAvgScale') {
                                    targetKey = 'smallTarget';
                                    partnersKey = 'smallPartners';
                                }
                                
                                let totalTarget = 0;
                                let totalPartners = 0;
                                categoriesToShow.forEach(cat => {
                                    totalTarget += partnerAgeData.data[cat][targetKey][monthIdx];
                                    totalPartners += partnerAgeData.data[cat][partnersKey][monthIdx];
                                });
                                finalValue = totalPartners > 0 ? totalTarget / totalPartners : 0;
                            } else if (isQualityMetric && metric.key.includes('Target')) {
                                // For Target metrics: calculate average
                                finalValue = categoryCount > 0 ? monthTotal / categoryCount : 0;
                            } else {
                                // For regular metrics: use sum
                                finalValue = monthTotal;
                            }
                            
                            // Apply decimal formatting only for Avg Scale metrics
                            let totalValue;
                            if (metric.key.includes('AvgScale') || metric.key === 'avgScale') {
                                totalValue = typeof finalValue === 'number' && finalValue % 1 !== 0 ? finalValue.toFixed(1) : finalValue;
                            } else {
                                totalValue = typeof finalValue === 'number' ? Math.round(finalValue) : finalValue;
                            }
                            const totalDisplayValue = typeof totalValue === 'number' && totalValue > 100 ? totalValue.toLocaleString() : totalValue;
                            html += `<td style="padding:8px;border:1px solid #e5e7eb;text-align:center;white-space:nowrap;background:#d1fae5;color:#065f46;font-weight:700;font-size:14px;">${totalDisplayValue}</td>`;
                        });
                        
                        html += '</tr>';
                    });

                    html += '</tbody>';
                    table.innerHTML = html;

                    // Attach sorting handlers
                    table.querySelectorAll('.pa-sortable').forEach(th => {
                        th.addEventListener('click', () => {
                            const key = th.getAttribute('data-sort-key');
                            if (partnerAgeSortState.key === key) {
                                partnerAgeSortState.dir = partnerAgeSortState.dir === 'asc' ? 'desc' : 'asc';
                            } else {
                                partnerAgeSortState.key = key;
                                partnerAgeSortState.dir = 'desc';
                            }
                            buildPartnerAgeTable(displayMonths, categoryFilter);
                        });
                    });
                }

                function buildPartnerAgeCharts(monthIndices = null, categoryFilter = 'all') {
                    const trendCtx = document.getElementById('partnerAgeTrendChart');
                    const scaleCtx = document.getElementById('partnerAgeScaleChart');
                    if (!trendCtx || !scaleCtx || typeof Chart === 'undefined') return;
                    
                    const categoriesToShow = categoryFilter === 'all' ? partnerAgeData.categories : [categoryFilter];

                    if (partnerAgeTrendChart) partnerAgeTrendChart.destroy();
                    if (partnerAgeScaleChart) partnerAgeScaleChart.destroy();

                    if (!monthIndices) monthIndices = [0, 1, 2, 3, 4, 5];

                    const selectedMonths = monthIndices.map(i => partnerAgeData.months[i]);
                    const colors = ['#8b5cf6', '#a78bfa', '#c4b5fd'];

                    // Trend Chart - Total Active Partners
                    const trendDatasets = [];
                    categoriesToShow.forEach((cat, idx) => {
                        const selectedData = monthIndices.map(i => partnerAgeData.data[cat].count[i]);
                        trendDatasets.push({
                            label: cat,
                            data: selectedData,
                            borderColor: colors[idx],
                            backgroundColor: colors[idx] + '20',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        });
                    });

                    partnerAgeTrendChart = new Chart(trendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: selectedMonths,
                            datasets: trendDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true },
                            plugins: {
                                legend: { position: 'right', maxWidth: 150 },
                                tooltip: {
                                    mode: 'nearest',
                                    intersect: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`
                                    }
                                },
                                datalabels: {
                                    display: true,
                                    align: 'end',
                                    anchor: 'end',
                                    backgroundColor: 'rgba(255,255,255,0.9)',
                                    borderRadius: 4,
                                    padding: 4,
                                    color: function(ctx) { return ctx.dataset.borderColor; },
                                    font: { size: 10, weight: '600' }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() }, grid: { color: 'rgba(107,114,128,0.15)', lineWidth: 1, drawBorder: false } },
                                x: { grid: { color: 'rgba(107,114,128,0.12)', lineWidth: 1, drawBorder: false } }
                            }
                        }
                    });

                    // Scale Chart - Avg Scale
                    const scaleDatasets = [];
                    categoriesToShow.forEach((cat, idx) => {
                        const selectedData = monthIndices.map(i => partnerAgeData.data[cat].avgScale[i]);
                        scaleDatasets.push({
                            label: cat,
                            data: selectedData,
                            borderColor: colors[idx],
                            backgroundColor: colors[idx] + '20',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false
                        });
                    });

                    partnerAgeScaleChart = new Chart(scaleCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: selectedMonths,
                            datasets: scaleDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            interaction: { mode: 'nearest', intersect: true },
                            plugins: {
                                legend: { position: 'right', maxWidth: 150 },
                                tooltip: {
                                    mode: 'nearest',
                                    intersect: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`
                                    }
                                },
                                datalabels: {
                                    display: true,
                                    align: 'end',
                                    anchor: 'end',
                                    backgroundColor: 'rgba(255,255,255,0.9)',
                                    borderRadius: 4,
                                    padding: 4,
                                    color: function(ctx) { return ctx.dataset.borderColor; },
                                    font: { size: 10, weight: '600' }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (v) => v.toFixed(1) }, grid: { color: 'rgba(107,114,128,0.15)', lineWidth: 1, drawBorder: false } },
                                x: { grid: { color: 'rgba(107,114,128,0.12)', lineWidth: 1, drawBorder: false } }
                            }
                        }
                    });
                }

                function setupPartnerAgeTableFocus() {
                    const table = document.getElementById('partnerAgeTable');
                    if (!table) return;
                    
                    table.addEventListener('click', function(e) {
                        const row = e.target.closest('tbody tr');
                        if (!row) return;
                        
                        // If clicking the same focused row, remove focus
                        if (row.classList.contains('row-focused')) {
                            row.classList.remove('row-focused');
                            table.classList.remove('has-focus');
                        } else {
                            // Remove focus from all rows
                            table.querySelectorAll('tbody tr.row-focused').forEach(r => r.classList.remove('row-focused'));
                            // Add focus to clicked row
                            row.classList.add('row-focused');
                            table.classList.add('has-focus');
                        }
                    });
                    
                    // Click outside table to clear focus
                    document.addEventListener('click', function(e) {
                        if (!table.contains(e.target)) {
                            table.querySelectorAll('tbody tr.row-focused').forEach(r => r.classList.remove('row-focused'));
                            table.classList.remove('has-focus');
                        }
                    });
                }

                function initPartnerAgeSection() {
                    buildPartnerAgeTable();
                    buildPartnerAgeCharts();
                    setupPartnerAgeTableFocus();

                    // Update takeaway
                    const latestNew1 = partnerAgeData.data['New <1 month'].count[5];
                    const latestNew3 = partnerAgeData.data['New <3 months'].count[5];
                    const latestOld = partnerAgeData.data['Old >3 months'].count[5];
                    const latestNewScale = partnerAgeData.data['New <1 month'].avgScale[5];
                    const latestOldScale = partnerAgeData.data['Old >3 months'].avgScale[5];
                    
                    const insight = `In Feb, new partners (<1 month: ${latestNew1}, <3 months: ${latestNew3}) are ramping with lower scale (${latestNewScale}), while established partners (>3 months: ${latestOld}) show declining scale (${latestOldScale}) despite higher volume. Focus on retaining & scaling established base.`;
                    document.getElementById('partnerAgeInsight').textContent = insight;

                    document.getElementById('partnerAgeCompareBtn')?.addEventListener('click', () => {
                        const m1 = document.getElementById('partnerAgeMonthFilter1').value;
                        const m2 = document.getElementById('partnerAgeMonthFilter2').value;
                        
                        if (m1 === '' || m2 === '') {
                            alert('Please select both months to compare');
                            return;
                        }

                        const m1Idx = parseInt(m1);
                        const m2Idx = parseInt(m2);

                        partnerAgeSelectedMonths = [m1Idx, m2Idx];
                        buildPartnerAgeTable([m1Idx, m2Idx], selectedAgeCategory);
                        buildPartnerAgeCharts(null, selectedAgeCategory);
                    });
                    
                    document.getElementById('partnerAgeResetBtn')?.addEventListener('click', () => {
                        // Reset dropdowns to default state
                        document.getElementById('partnerAgeMonthFilter1').value = '';
                        document.getElementById('partnerAgeMonthFilter2').value = '';
                        
                        partnerAgeSelectedMonths = null;
                        buildPartnerAgeTable(null, selectedAgeCategory);
                        buildPartnerAgeCharts(null, selectedAgeCategory);
                    });

                    // Age category filter chips
                    document.querySelectorAll('.age-category-chip').forEach(chip => {
                        chip.addEventListener('click', function() {
                            // Update active state
                            document.querySelectorAll('.age-category-chip').forEach(c => {
                                c.style.background = 'white';
                                c.style.color = '#374151';
                                c.style.borderColor = '#d1d5db';
                                c.classList.remove('active');
                            });
                            this.style.background = '#1e3a8a';
                            this.style.color = 'white';
                            this.style.borderColor = '#1e3a8a';
                            this.classList.add('active');

                            // Get selected category
                            selectedAgeCategory = this.getAttribute('data-category');
                            
                            // Rebuild table and charts with filter
                            const currentMonths = partnerAgeSelectedMonths || null;
                            buildPartnerAgeTable(currentMonths, selectedAgeCategory);
                            buildPartnerAgeCharts(null, selectedAgeCategory);
                        });
                    });
                }

                function initTierCitySection() {
                    buildTierTables();
                    buildTierCharts();
                    
                    // Add tier filter event listeners
                    const tierFilterChips = document.querySelectorAll('.tier-filter-chip');
                    tierFilterChips.forEach(chip => {
                        chip.addEventListener('click', () => {
                            tierFilterSelected = chip.getAttribute('data-tier');
                            
                            // Update chip styling
                            tierFilterChips.forEach(c => {
                                if (c === chip) {
                                    c.style.background = '#3b82f6';
                                    c.style.color = 'white';
                                    c.style.borderColor = '#3b82f6';
                                } else {
                                    c.style.background = 'white';
                                    c.style.color = '#374151';
                                    c.style.borderColor = '#d1d5db';
                                }
                            });
                            
                            // Rebuild tables and charts
                            buildTierTables();
                            buildTierCharts();
                        });
                    });
                }

        // Initialize Charts
        window.onload = function() {
            function createBarMomLabelPlugin(janData, febData, fontSize) {
                return {
                    id: 'barMomLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const showJan = chart.isDatasetVisible(0);
                        const showFeb = chart.isDatasetVisible(1);
                        ctx.save();
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';

                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            if (!chart.isDatasetVisible(datasetIndex)) return;
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const val = dataset.data[index];
                                if (val === null || val === undefined) return;
                                const x = bar.x;
                                const y = bar.y - 4;
                                const valText = Number(val).toLocaleString();

                                if (datasetIndex === 0 && showJan) {
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x, y);
                                    return;
                                }

                                if (datasetIndex === 1 && showFeb) {
                                    if (showJan) {
                                        const mom = psFormatMoM(janData[index], febData[index]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        const label = `${valText} (${sign}${mom}%)`;
                                        ctx.fillStyle = psMoMColor(mom);
                                        ctx.fillText(label, x, y);
                                    } else {
                                        ctx.fillStyle = '#111827';
                                        ctx.fillText(valText, x, y);
                                    }
                                }
                            });
                        });
                        ctx.restore();
                    }
                };
            }

            // Partner Scale Chart - REMOVED (chart element deleted)
            // const scaleJan = [6677, 10598, 4938, 240];
            // const scaleFeb = [3643, 9982, 5351, 389];
            // const scaleMomPlugin = createBarMomLabelPlugin(scaleJan, scaleFeb, 9);
            // new Chart(document.getElementById('scaleChart').getContext('2d'), {...});

            // Compliance Rate Distribution Chart
            const complianceLabels = ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'];
            const complianceColors = ['#ef4444', '#f97316', '#fb923c', '#f59e0b', '#84cc16', '#22c55e', '#10b981'];
            
            // FR Rate Data - All Partners
            const frAllData = [17, 1, 1, 0, 3, 36, 585];
            const frNewData = [16, 0, 1, 0, 2, 14, 125];
            const frOldData = [1, 1, 0, 0, 1, 22, 460];
            
            // FR Rate Data - Partners with Target
            const frAllDataActive = [17, 0, 1, 0, 1, 23, 509];
            const frNewDataActive = [16, 0, 1, 0, 0, 7, 103];
            const frOldDataActive = [1, 0, 0, 0, 1, 16, 406];
            
            // Driver Card Rate Data - All Partners
            const dcAllData = [317, 45, 37, 26, 32, 43, 143];
            const dcNewData = [88, 9, 2, 5, 7, 9, 38];
            const dcOldData = [229, 36, 35, 21, 25, 34, 105];
            
            // Driver Card Rate Data - Partners with Target
            const dcAllDataActive = [237, 43, 34, 25, 30, 43, 139];
            const dcNewDataActive = [60, 8, 2, 5, 7, 9, 36];
            const dcOldDataActive = [177, 35, 32, 20, 23, 34, 103];

            // FR Rate Data by Performance Level (Partners with Target)
            const frPerfData = {
                all: [17, 0, 1, 0, 1, 23, 509],
                good: [0, 0, 0, 0, 0, 5, 247],
                average: [0, 0, 0, 0, 0, 15, 247],
                bad: [2, 0, 1, 0, 1, 3, 13]
            };
            
            // DC Rate Data by Performance Level (Partners with Target)
            const dcPerfData = {
                all: [237, 43, 34, 25, 30, 43, 139],
                good: [112, 17, 14, 9, 10, 22, 68],
                average: [100, 26, 20, 14, 19, 18, 65],
                bad: [10, 0, 0, 2, 1, 2, 5]
            };
            
            // FR Target Data by Performance Level
            const frPerfTargetData = {
                all: { total: 10192 + 8414 + 370, good: 10192, average: 8414, bad: 370 },
                good: [0, 0, 0, 0, 0, 182, 10010],
                average: [0, 0, 0, 0, 0, 396, 8018],
                bad: [35, 0, 19, 0, 11, 50, 255]
            };
            
            // DC Target Data by Performance Level
            const dcPerfTargetData = {
                all: { total: 10192 + 8414 + 370, good: 10192, average: 8414, bad: 370 },
                good: [4600, 762, 537, 341, 449, 735, 2768],
                average: [3270, 805, 781, 420, 514, 587, 2037],
                bad: [178, 0, 0, 39, 15, 50, 88]
            };
            
            // Average rates by performance level
            const frPerfAvgRates = {
                all: { value: '92.4%', label: 'All with Target' },
                good: { value: '96.5%', label: 'Good Partners' },
                average: { value: '92.0%', label: 'Average Partners' },
                bad: { value: '72.9%', label: 'Bad Partners' }
            };
            
            const dcPerfAvgRates = {
                all: { value: '40.5%', label: 'All with Target' },
                good: { value: '42.8%', label: 'Good Partners' },
                average: { value: '39.0%', label: 'Average Partners' },
                bad: { value: '33.5%', label: 'Bad Partners' }
            };
            
            let currentPerfFilter = 'all'; // Default performance filter

            let activeMetric = 'fr'; // Default to FR
            let currentFilter = 'comparison'; // Default filter
            
            // Average Rate Data for KPI Cards
            const avgRateData = {
                fr: {
                    all: { value: '92.2%', label: 'All Partners' },
                    new: { value: '83.2%', label: 'New Partners' },
                    old: { value: '95.1%', label: 'Old Partners' },
                    both: { value: '83.2% / 95.1%', label: 'New / Old Partners' },
                    'all-target': { value: '92.4%', label: 'All with Target' },
                    'new-target': { value: '82.2%', label: 'New with Target' },
                    'old-target': { value: '95.4%', label: 'Old with Target' },
                    'both-target': { value: '82.2% / 95.4%', label: 'New / Old with Target' },
                    'comparison': { value: '92.2% / 92.4%', label: 'All / With Target' }
                },
                dc: {
                    all: { value: '36.0%', label: 'All Partners' },
                    new: { value: '34.2%', label: 'New Partners' },
                    old: { value: '36.6%', label: 'Old Partners' },
                    both: { value: '34.2% / 36.6%', label: 'New / Old Partners' },
                    'all-target': { value: '40.5%', label: 'All with Target' },
                    'new-target': { value: '40.6%', label: 'New with Target' },
                    'old-target': { value: '40.5%', label: 'Old with Target' },
                    'both-target': { value: '40.6% / 40.5%', label: 'New / Old with Target' },
                    'comparison': { value: '36.0% / 40.5%', label: 'All / With Target' }
                }
            };
            
            // Function to update donut meter
            function updateDonutMeter(donutId, valueId, percentage) {
                const donut = document.querySelector(`#${donutId} .donut-progress`);
                const valueEl = document.getElementById(valueId);
                if (donut && valueEl) {
                    const circumference = 87.96; // 2 * PI * 14
                    const offset = circumference - (percentage / 100) * circumference;
                    donut.style.strokeDashoffset = offset;
                    valueEl.textContent = percentage.toFixed(1) + '%';
                }
            }
            
            // Function to update KPI cards (donut meters)
            function updateAvgKpiCards(filter, metric) {
                const frCard = document.getElementById('frAvgCard');
                const frSubtitle = document.getElementById('frAvgSubtitle');
                const dcCard = document.getElementById('dcAvgCard');
                const dcSubtitle = document.getElementById('dcAvgSubtitle');
                
                // Get data
                const frData = avgRateData.fr[filter] || avgRateData.fr.all;
                const dcData = avgRateData.dc[filter] || avgRateData.dc.all;
                
                // Parse percentages from value strings
                const parsePercentages = (valueStr) => {
                    const parts = valueStr.replace(/%/g, '').split('/').map(s => parseFloat(s.trim()));
                    return parts;
                };
                
                const frPercentages = parsePercentages(frData.value);
                const dcPercentages = parsePercentages(dcData.value);
                
                // Update FR donut meters
                if (frPercentages.length === 2) {
                    updateDonutMeter('frDonutAll', 'frDonutAllValue', frPercentages[0]);
                    updateDonutMeter('frDonutTarget', 'frDonutTargetValue', frPercentages[1]);
                    document.querySelector('#frDonutAll').parentElement.style.display = 'flex';
                    document.querySelector('#frDonutTarget').parentElement.style.display = 'flex';
                    document.getElementById('frDonutAllValue').parentElement.querySelector('.donut-label').textContent = 'All';
                    document.getElementById('frDonutTargetValue').parentElement.querySelector('.donut-label').textContent = 'Target';
                } else {
                    updateDonutMeter('frDonutAll', 'frDonutAllValue', frPercentages[0]);
                    document.querySelector('#frDonutAll').parentElement.style.display = 'flex';
                    document.querySelector('#frDonutTarget').parentElement.style.display = 'none';
                }
                frSubtitle.textContent = frData.label;
                
                // Update DC donut meters
                if (dcPercentages.length === 2) {
                    updateDonutMeter('dcDonutAll', 'dcDonutAllValue', dcPercentages[0]);
                    updateDonutMeter('dcDonutTarget', 'dcDonutTargetValue', dcPercentages[1]);
                    document.querySelector('#dcDonutAll').parentElement.style.display = 'flex';
                    document.querySelector('#dcDonutTarget').parentElement.style.display = 'flex';
                } else {
                    updateDonutMeter('dcDonutAll', 'dcDonutAllValue', dcPercentages[0]);
                    document.querySelector('#dcDonutAll').parentElement.style.display = 'flex';
                    document.querySelector('#dcDonutTarget').parentElement.style.display = 'none';
                }
                dcSubtitle.textContent = dcData.label;
                
                // Update card highlight based on active metric
                if (metric === 'fr') {
                    frCard.style.opacity = '1';
                    frCard.style.transform = 'scale(1.02)';
                    dcCard.style.opacity = '0.6';
                    dcCard.style.transform = 'scale(1)';
                } else {
                    dcCard.style.opacity = '1';
                    dcCard.style.transform = 'scale(1.02)';
                    frCard.style.opacity = '0.6';
                    frCard.style.transform = 'scale(1)';
                }
            }
            
            let frChartInstance = null;
            let frChartNewInstance = null;
            let frChartOldInstance = null;
            let frChartNewTargetInstance = null;
            let frChartOldTargetInstance = null;
            let frChartTotalInstance = null;
            let frChartTargetActiveInstance = null;

            function createComplianceChart(canvasId, data, labels) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return null;
                const total = data.reduce((sum, v) => sum + v, 0);
                const formatPct = (value) => {
                    if (!total) return '0';
                    const pct = (value / total) * 100;
                    const fixed = pct.toFixed(1);
                    return fixed.endsWith('.0') ? fixed.slice(0, -2) : fixed;
                };
                return new Chart(canvas.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: labels.map((l, i) => `${l}: ${data[i]} (${formatPct(data[i])}%)`),
                        datasets: [{ data: data, backgroundColor: complianceColors }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            datalabels: { color: '#fff', font: { weight: 'bold', size: 12 }, formatter: (v) => v },
                            legend: { position: 'right' }
                        }
                    }
                });
            }
            
            function getDataForMetric() {
                if (activeMetric === 'fr') {
                    return {
                        all: frAllData,
                        new: frNewData,
                        old: frOldData,
                        allActive: frAllDataActive,
                        newActive: frNewDataActive,
                        oldActive: frOldDataActive
                    };
                } else {
                    return {
                        all: dcAllData,
                        new: dcNewData,
                        old: dcOldData,
                        allActive: dcAllDataActive,
                        newActive: dcNewDataActive,
                        oldActive: dcOldDataActive
                    };
                }
            }
            
            function updateChartForFilter(filter) {
                const data = getDataForMetric();
                
                // Destroy all existing charts
                if (frChartInstance) frChartInstance.destroy();
                if (frChartNewInstance) frChartNewInstance.destroy();
                if (frChartOldInstance) frChartOldInstance.destroy();
                if (frChartNewTargetInstance) frChartNewTargetInstance.destroy();
                if (frChartOldTargetInstance) frChartOldTargetInstance.destroy();
                if (frChartTotalInstance) frChartTotalInstance.destroy();
                if (frChartTargetActiveInstance) frChartTargetActiveInstance.destroy();

                const singleView = document.getElementById('frChartSingle');
                const dualView = document.getElementById('frChartDual');
                const dualViewTarget = document.getElementById('frChartDualTarget');
                const comparisonView = document.getElementById('frChartComparison');

                // Switch views based on filter
                if (filter === 'both') {
                    singleView.style.display = 'none';
                    dualView.style.display = 'flex';
                    dualViewTarget.style.display = 'none';
                    comparisonView.style.display = 'none';
                    
                    frChartNewInstance = createComplianceChart('frChartNew', data.new, complianceLabels);
                    frChartOldInstance = createComplianceChart('frChartOld', data.old, complianceLabels);
                } else if (filter === 'both-target') {
                    singleView.style.display = 'none';
                    dualView.style.display = 'none';
                    dualViewTarget.style.display = 'flex';
                    comparisonView.style.display = 'none';
                    
                    frChartNewTargetInstance = createComplianceChart('frChartNewTarget', data.newActive, complianceLabels);
                    frChartOldTargetInstance = createComplianceChart('frChartOldTarget', data.oldActive, complianceLabels);
                } else if (filter === 'comparison') {
                    singleView.style.display = 'none';
                    dualView.style.display = 'none';
                    dualViewTarget.style.display = 'none';
                    comparisonView.style.display = 'flex';
                    
                    frChartTotalInstance = createComplianceChart('frChartTotal', data.all, complianceLabels);
                    frChartTargetActiveInstance = createComplianceChart('frChartTargetActive', data.allActive, complianceLabels);
                } else {
                    singleView.style.display = 'block';
                    dualView.style.display = 'none';
                    dualViewTarget.style.display = 'none';
                    comparisonView.style.display = 'none';
                    
                    let chartData = data.all;
                    if (filter === 'new') chartData = data.new;
                    else if (filter === 'old') chartData = data.old;
                    else if (filter === 'all-target') chartData = data.allActive;
                    else if (filter === 'new-target') chartData = data.newActive;
                    else if (filter === 'old-target') chartData = data.oldActive;
                    
                    frChartInstance = createComplianceChart('frChart', chartData, complianceLabels);
                }
            }

            // Initialize chart with default filter
            updateChartForFilter(currentFilter);
            updateAvgKpiCards(currentFilter, activeMetric);
            
            // Trigger fly-in animation for donut meters
            setTimeout(() => {
                const frCard = document.getElementById('frAvgCard');
                const dcCard = document.getElementById('dcAvgCard');
                if (frCard) {
                    frCard.classList.add('animate-in');
                    frCard.style.opacity = '1';
                    frCard.style.filter = 'none';
                }
                setTimeout(() => {
                    if (dcCard) {
                        dcCard.classList.add('animate-in');
                        // Initial state: DC card blurred since FR is active by default
                        setTimeout(() => {
                            dcCard.style.opacity = '0.5';
                            dcCard.style.filter = 'blur(1px)';
                            dcCard.style.transform = 'scale(0.95)';
                        }, 700); // After animation completes
                    }
                }, 200); // Stagger DC card animation
            }, 100);
            
            // Metric Toggle Button Logic
            const metricBtns = document.querySelectorAll('.metric-toggle-btn');
            const metricTitle = document.getElementById('metricTitle');
            
            metricBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.getAttribute('data-metric');
                    activeMetric = metric;
                    
                    // Update button styles with new clean design
                    metricBtns.forEach(b => {
                        if (b === this) {
                            b.style.background = '#3b82f6';
                            b.style.color = 'white';
                            b.style.borderColor = '#3b82f6';
                            b.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                            b.classList.add('active');
                        } else {
                            b.style.background = 'white';
                            b.style.color = '#6b7280';
                            b.style.borderColor = '#e5e7eb';
                            b.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                            b.classList.remove('active');
                        }
                    });
                    
                    // Update title
                    if (metric === 'fr') {
                        metricTitle.textContent = 'Face Recognition (FR) Rate - All Active Partners vs Partners with Target';
                        // Highlight FR card, blur DC card
                        const frCard = document.getElementById('frAvgCard');
                        const dcCard = document.getElementById('dcAvgCard');
                        if (frCard) {
                            frCard.style.opacity = '1';
                            frCard.style.filter = 'none';
                            frCard.style.transform = 'scale(1)';
                        }
                        if (dcCard) {
                            dcCard.style.opacity = '0.5';
                            dcCard.style.filter = 'blur(1px)';
                            dcCard.style.transform = 'scale(0.95)';
                        }
                    } else {
                        metricTitle.textContent = 'Driver Card Rate - All Active Partners vs Partners with Target';
                        // Highlight DC card, blur FR card
                        const frCard = document.getElementById('frAvgCard');
                        const dcCard = document.getElementById('dcAvgCard');
                        if (dcCard) {
                            dcCard.style.opacity = '1';
                            dcCard.style.filter = 'none';
                            dcCard.style.transform = 'scale(1)';
                        }
                        if (frCard) {
                            frCard.style.opacity = '0.5';
                            frCard.style.filter = 'blur(1px)';
                            frCard.style.transform = 'scale(0.95)';
                        }
                    }
                    
                    // Update KPI cards highlight
                    updateAvgKpiCards(currentFilter, metric);
                    
                    // Refresh chart with current filter
                    updateChartForFilter(currentFilter);
                });
            });

            // FR Filter button logic
            const filterBtns = document.querySelectorAll('.fr-filter-btn');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    currentFilter = filter; // Store current filter
                    
                    // Update button styles
                    filterBtns.forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                        b.classList.remove('active');
                    });
                    this.style.background = '#3b82f6';
                    this.style.color = 'white';
                    this.style.borderColor = '#3b82f6';
                    this.classList.add('active');
                    
                    // Reset Performance filter buttons to inactive state
                    const perfFilterBtns = document.querySelectorAll('.fr-perf-filter-btn');
                    perfFilterBtns.forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                        b.classList.remove('active');
                    });
                    currentPerfFilter = 'all';

                    // Update KPI cards
                    updateAvgKpiCards(filter, activeMetric);
                    
                    // Update chart based on current metric and filter
                    updateChartForFilter(filter);
                });
            });

            // Performance Filter button logic for Compliance Distribution
            const perfFilterBtns = document.querySelectorAll('.fr-perf-filter-btn');
            
            perfFilterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const perf = this.getAttribute('data-perf');
                    currentPerfFilter = perf;
                    
                    // Update button styles
                    perfFilterBtns.forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                        b.classList.remove('active');
                    });
                    this.style.background = '#059669';
                    this.style.color = 'white';
                    this.style.borderColor = '#059669';
                    this.classList.add('active');
                    
                    // Reset other filter buttons to inactive state
                    const filterBtns = document.querySelectorAll('.fr-filter-btn');
                    filterBtns.forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                        b.classList.remove('active');
                    });
                    currentFilter = 'all';
                    
                    // Update KPI cards with performance data
                    updatePerfKpiCards(perf, activeMetric);
                    
                    // Update chart with performance data
                    updateChartForPerfFilter(perf);
                });
            });
            
            // Function to update KPI cards for performance filter
            function updatePerfKpiCards(perf, metric) {
                const frSubtitle = document.getElementById('frAvgSubtitle');
                const dcSubtitle = document.getElementById('dcAvgSubtitle');
                
                const frData = frPerfAvgRates[perf] || frPerfAvgRates.all;
                const dcData = dcPerfAvgRates[perf] || dcPerfAvgRates.all;
                
                // Parse and update FR donut
                const frPct = parseFloat(frData.value.replace('%', ''));
                updateDonutMeter('frDonutAll', 'frDonutAllValue', frPct);
                document.querySelector('#frDonutTarget').parentElement.style.display = 'none';
                frSubtitle.textContent = frData.label;
                
                // Parse and update DC donut
                const dcPct = parseFloat(dcData.value.replace('%', ''));
                updateDonutMeter('dcDonutAll', 'dcDonutAllValue', dcPct);
                document.querySelector('#dcDonutTarget').parentElement.style.display = 'none';
                dcSubtitle.textContent = dcData.label;
            }
            
            // Function to update chart for performance filter
            function updateChartForPerfFilter(perf) {
                const metric = activeMetric;
                const data = metric === 'fr' ? frPerfData[perf] : dcPerfData[perf];
                const title = metric === 'fr' 
                    ? `Face Recognition (FR) Rate - ${perf === 'all' ? 'All Partners with Target' : perf.charAt(0).toUpperCase() + perf.slice(1) + ' Partners'}`
                    : `Driver Card Rate - ${perf === 'all' ? 'All Partners with Target' : perf.charAt(0).toUpperCase() + perf.slice(1) + ' Partners'}`;
                
                const metricTitle = document.getElementById('metricTitle');
                if (metricTitle) metricTitle.textContent = title;
                
                // Hide dual views, show single
                document.getElementById('frChartSingle').style.display = 'block';
                document.getElementById('frChartDual').style.display = 'none';
                document.getElementById('frChartDualTarget').style.display = 'none';
                document.getElementById('frChartComparison').style.display = 'none';
                
                // Destroy existing charts and create new one
                if (frChartInstance) frChartInstance.destroy();
                if (frChartNewInstance) frChartNewInstance.destroy();
                if (frChartOldInstance) frChartOldInstance.destroy();
                if (frChartNewTargetInstance) frChartNewTargetInstance.destroy();
                if (frChartOldTargetInstance) frChartOldTargetInstance.destroy();
                if (frChartTotalInstance) frChartTotalInstance.destroy();
                if (frChartTargetActiveInstance) frChartTargetActiveInstance.destroy();
                
                // Create new chart with performance data
                frChartInstance = createComplianceChart('frChart', data, complianceLabels);
            }

            // Performance & Scale Summary Section
            const psSummaryRows = [
                { label: 'Total partners with target', dec: 625, jan: 551 },
                { label: 'Total capacity target', dec: 22453, jan: 19365 },
                { label: 'Avg scale per partner', dec: 35.9, jan: 35.1 },
                { label: 'Delivery riders all partners', dec: 23511, jan: 20489 },
                { label: 'Delivery riders partners with target', dec: 22448, jan: 19127 },
                { label: 'Delivery rider avg scale (Total active)', dec: 34.2, jan: 31.9 },
                { label: 'Delivery rider avg scale (Partners with target)', dec: 35.9, jan: 34.7 },
                { label: 'Online riders all partners', dec: 24428, jan: 21116 },
                { label: 'Online riders partners with target', dec: 23298, jan: 19689 },
                { label: 'Online riders avg scale (Total active)', dec: 35.6, jan: 32.8 },
                { label: 'Online riders avg scale (Partners with target)', dec: 39.1, jan: 38.3 }
            ];

            const psBreakdownData = {
                overall: [
                    { label: 'Total partners count', dec: { new1: 63, new3: 161, old3: 463, total: 687 }, jan: { new1: 27, new3: 131, old3: 485, total: 643 } },
                    { label: 'Total active partners count', dec: { new1: 56, new3: 144, old3: 425, total: 625 }, jan: { new1: 26, new3: 101, old3: 424, total: 551 } },
                    { label: 'Target total', dec: { new1: 1380, new3: 3574, old3: 17499, total: 22453 }, jan: { new1: 583, new3: 2379, old3: 16403, total: 19365 } },
                    { label: 'Avg scale', dec: { new1: 24.6, new3: 24.8, old3: 41.2, total: 35.9 }, jan: { new1: 22.4, new3: 23.6, old3: 38.7, total: 35.1 } }
                ],
                performance: {
                    good: [
                        { label: 'Good partners with target', dec: { new1: 15, new3: 42, old3: 212, total: 269 }, jan: { new1: 3, new3: 38, old3: 211, total: 252 } },
                        { label: 'Good partners target', dec: { new1: 396, new3: 1208, old3: 10745, total: 12349 }, jan: { new1: 50, new3: 1050, old3: 9092, total: 10192 } },
                        { label: 'Good partners avg scale', dec: { new1: 26.4, new3: 28.8, old3: 50.7, total: 45.9 }, jan: { new1: 16.7, new3: 27.6, old3: 43.1, total: 40.4 } }
                    ],
                    average: [
                        { label: 'Average partners with target', dec: { new1: 5, new3: 74, old3: 195, total: 274 }, jan: { new1: 2, new3: 55, old3: 205, total: 262 } },
                        { label: 'Average partners target', dec: { new1: 115, new3: 1863, old3: 6352, total: 8330 }, jan: { new1: 67, new3: 1193, old3: 7154, total: 8414 } },
                        { label: 'Average partners avg scale', dec: { new1: 23.0, new3: 25.2, old3: 32.6, total: 30.4 }, jan: { new1: 33.5, new3: 21.7, old3: 34.9, total: 32.1 } }
                    ],
                    bad: [
                        { label: 'Bad partners with target', dec: { new1: 28, new3: 28, old3: 17, total: 73 }, jan: { new1: 4, new3: 8, old3: 8, total: 20 } },
                        { label: 'Bad partners target', dec: { new1: 659, new3: 503, old3: 372, total: 1534 }, jan: { new1: 77, new3: 136, old3: 157, total: 370 } },
                        { label: 'Bad partners avg scale', dec: { new1: 23.5, new3: 18.0, old3: 21.9, total: 21.0 }, jan: { new1: 19.3, new3: 17.0, old3: 19.6, total: 18.5 } }
                    ]
                },
                scale: {
                    big: [
                        { label: '# of big partners with target', dec: { new1: 0, new3: 9, old3: 72, total: 81 }, jan: { new1: 0, new3: 0, old3: 77, total: 77 } },
                        { label: 'Big partners target', dec: { new1: 0, new3: 477, old3: 4461, total: 4938 }, jan: { new1: 0, new3: 0, old3: 5351, total: 5351 } },
                        { label: 'Big partners avg scale', dec: { new1: 0.0, new3: 53.0, old3: 62.0, total: 61.0 }, jan: { new1: 0.0, new3: 0.0, old3: 69.5, total: 69.5 } }
                    ],
                    mid: [
                        { label: '# of mid partners with target', dec: { new1: 5, new3: 56, old3: 214, total: 275 }, jan: { new1: 1, new3: 13, old3: 268, total: 282 } },
                        { label: 'Mid partners target', dec: { new1: 161, new3: 1677, old3: 8760, total: 10598 }, jan: { new1: 42, new3: 506, old3: 9434, total: 9982 } },
                        { label: 'Mid partners avg scale', dec: { new1: 32.2, new3: 29.9, old3: 40.9, total: 38.5 }, jan: { new1: 42.0, new3: 38.9, old3: 35.2, total: 35.4 } }
                    ],
                    small: [
                        { label: '# of small partners with target', dec: { new1: 43, new3: 79, old3: 138, total: 260 }, jan: { new1: 8, new3: 88, old3: 79, total: 175 } },
                        { label: 'Small partners target', dec: { new1: 1009, new3: 1420, old3: 4248, total: 6677 }, jan: { new1: 152, new3: 1873, old3: 1618, total: 3643 } },
                        { label: 'Small partners avg scale', dec: { new1: 23.5, new3: 18.0, old3: 30.8, total: 25.7 }, jan: { new1: 19.0, new3: 21.3, old3: 20.5, total: 20.8 } }
                    ]
                }
            };

            let psAvgScaleChartInstance = null;
            let psRidersBreakdownChartInstance = null;
            let psAvgScaleOverallChartInstance = null;
            let psCombinedRidersChartInstance = null;
            let psCombinedAvgScaleChartInstance = null;
            let psBreakdownChartInstance = null;
            let psSummaryPeriod = 'total';
            let psSummaryPerf = 'all';
            let psSummaryScale = 'all';
            let psSummaryView = 'both';
            let psPeriod = 'total';
            let psPerf = 'all';
            let psScale = 'all';

            const psFormatMoM = (dec, jan) => {
                if (!dec) return '0.0';
                return (((jan - dec) / dec) * 100).toFixed(1);
            };

            const psMoMClass = (mom) => (parseFloat(mom) >= 0 ? '#16a34a' : '#dc2626');
            const psMoMColor = (mom) => {
                const val = parseFloat(mom);
                if (val > 0) return '#16a34a';
                if (val < 0) return '#dc2626';
                return '#f59e0b';
            };

            function psRenderSummaryTable() {
                const tbody = document.getElementById('psSummaryTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                psSummaryRows.forEach((row, idx) => {
                    const mom = psFormatMoM(row.dec, row.jan);
                    const tr = document.createElement('tr');
                    tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${row.label}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${row.dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${row.jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${psMoMClass(mom)};">${mom}%</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function psPrettyPeriodLabel(period) {
                return period === 'new1' ? 'New Partners <1M'
                    : period === 'new3' ? 'New Partners <3M'
                    : period === 'old3' ? 'Old Partners >3M'
                    : 'Total Partners';
            }

            function psPrettyPerfLabel(perf) {
                if (perf === 'good') return 'Good Partners with Target';
                if (perf === 'average') return 'Average Partners with Target';
                if (perf === 'bad') return 'Bad Partners with Target';
                return '';
            }

            function psPrettyScaleLabel(scale) {
                if (scale === 'big') return 'Big Partners with Target';
                if (scale === 'mid') return 'Mid Partners with Target';
                if (scale === 'small') return 'Small Partners with Target';
                return '';
            }

            function psGetAvgScaleMap() {
                return {
                    overall: { label: 'Total Partners with Target Avg Scale', metric: psBreakdownData.overall[3] },
                    good: { label: 'Good Partners with Target Avg Scale', metric: psBreakdownData.performance.good[2] },
                    average: { label: 'Average Partners with Target Avg Scale', metric: psBreakdownData.performance.average[2] },
                    bad: { label: 'Bad Partners with Target Avg Scale', metric: psBreakdownData.performance.bad[2] },
                    big: { label: 'Big Partners with Target Avg Scale', metric: psBreakdownData.scale.big[2] },
                    mid: { label: 'Mid Partners with Target Avg Scale', metric: psBreakdownData.scale.mid[2] },
                    small: { label: 'Small Partners with Target Avg Scale', metric: psBreakdownData.scale.small[2] }
                };
            }

            function psGetAvgScaleKeys() {
                if (psSummaryPerf !== 'all') return ['overall', psSummaryPerf];
                if (psSummaryScale !== 'all') return ['overall', psSummaryScale];
                return ['overall', 'good', 'average', 'bad', 'big', 'mid', 'small'];
            }

            function psRenderAvgScaleChart() {
                const canvas = document.getElementById('psAvgScaleChart');
                if (!canvas) return;
                if (psAvgScaleChartInstance) { try { psAvgScaleChartInstance.destroy(); } catch(e) {} }

                const avgMap = psGetAvgScaleMap();
                const keys = psGetAvgScaleKeys();
                const labels = keys.map(k => avgMap[k].label);
                const decData = keys.map(k => avgMap[k].metric.dec[psSummaryPeriod]);
                const janData = keys.map(k => avgMap[k].metric.jan[psSummaryPeriod]);

                const periodLabel = psPrettyPeriodLabel(psSummaryPeriod);
                const titleParts = [periodLabel];
                if (psSummaryPerf !== 'all') titleParts.push(psPrettyPerfLabel(psSummaryPerf));
                if (psSummaryScale !== 'all') titleParts.push(psPrettyScaleLabel(psSummaryScale));
                const avgTitle = document.getElementById('psAvgScaleTitle');
                if (avgTitle) avgTitle.textContent = `Avg Scale Overview (${titleParts.join(' • ')})`;

                const momLabelsByIndex = {
                    id: 'momLabelsByIndex',
                    afterDatasetsDraw(chart) {
                        const { ctx, data } = chart;
                        const showJan = chart.isDatasetVisible(0);
                        const showFeb = chart.isDatasetVisible(1);
                        ctx.save();
                        ctx.font = 'bold 9px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';

                        data.datasets.forEach((dataset, datasetIndex) => {
                            if (!chart.isDatasetVisible(datasetIndex)) return;
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const val = dataset.data[index];
                                if (val === null || val === undefined) return;
                                const x = bar.x;
                                const y = bar.y - 4;
                                const valText = Number(val).toLocaleString();

                                if (datasetIndex === 1 && showJan && showFeb) {
                                    const mom = psFormatMoM(decData[index], janData[index]);
                                    const sign = parseFloat(mom) > 0 ? '+' : '';
                                    const momText = ` (${sign}${mom}%)`;
                                    const valWidth = ctx.measureText(valText).width;
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x - (ctx.measureText(momText).width / 2), y);
                                    ctx.fillStyle = psMoMColor(mom);
                                    ctx.fillText(momText, x + (valWidth / 2), y);
                                } else {
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x, y);
                                }
                            });
                        });
                        ctx.restore();
                    }
                };

                psAvgScaleChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Jan', data: decData, backgroundColor: '#60a5fa' },
                            { label: 'Feb', data: janData, backgroundColor: '#34d399' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart',
                            delay: (context) => context.dataIndex * 80 + context.datasetIndex * 120
                        },
                        transitions: {
                            active: { animation: { duration: 300 } },
                            resize: { animation: { duration: 0 } },
                            show: { animations: { colors: { from: 'transparent' }, visible: { type: 'boolean', duration: 500 } } },
                            hide: { animations: { colors: { to: 'transparent' }, visible: { type: 'boolean', easing: 'linear', fn: v => v | 0 } } }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [momLabelsByIndex]
                });
            }

            function psGetSummaryRowByLabel(label) {
                return psSummaryRows.find(r => r.label === label);
            }

            function psHexToRgba(hex, alpha) {
                const cleaned = hex.replace('#', '');
                const bigint = parseInt(cleaned, 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            function psRenderRidersBreakdownChart(canvasId, targetVarSetter) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                if (targetVarSetter.current) { try { targetVarSetter.current.destroy(); } catch(e) {} }

                const ridersMetrics = [
                    { label: 'Capacity Target', rowLabel: 'Total capacity target', color: '#3b82f6' },
                    { label: 'Delivery Riders (with target)', rowLabel: 'Delivery riders partners with target', color: '#f97316' },
                    { label: 'Online Riders (with target)', rowLabel: 'Online riders partners with target', color: '#10b981' }
                ];

                const datasets = ridersMetrics.map(metric => {
                    const row = psGetSummaryRowByLabel(metric.rowLabel);
                    if (!row) return null;
                    return {
                        label: metric.label,
                        data: [row.dec, row.jan],
                        backgroundColor: psHexToRgba(metric.color, 0.85),
                        borderColor: metric.color,
                        borderWidth: 1.5
                    };
                }).filter(Boolean);

                const momLabelsByIndex = {
                    id: 'momLabelsByIndex',
                    afterDatasetsDraw(chart) {
                        const { ctx, data } = chart;
                        const showJan = chart.isDatasetVisible(0);
                        const showFeb = chart.isDatasetVisible(1);
                        ctx.save();
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';

                        data.datasets.forEach((dataset, datasetIndex) => {
                            if (!chart.isDatasetVisible(datasetIndex)) return;
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const val = dataset.data[index];
                                if (val === null || val === undefined) return;
                                const x = bar.x;
                                const y = bar.y - 4;
                                const valText = Number(val).toLocaleString();

                                if (index === 1 && showJan && showFeb) {
                                    const mom = psFormatMoM(dataset.data[0], dataset.data[1]);
                                    const sign = parseFloat(mom) > 0 ? '+' : '';
                                    const momText = ` (${sign}${mom}%)`;
                                    const valWidth = ctx.measureText(valText).width;
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x - (ctx.measureText(momText).width / 2), y);
                                    ctx.fillStyle = psMoMColor(mom);
                                    ctx.fillText(momText, x + (valWidth / 2), y);
                                } else {
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x, y);
                                }
                            });
                        });
                        ctx.restore();
                    }
                };

                targetVarSetter.current = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb'],
                        datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart',
                            delay: (context) => context.dataIndex * 100 + context.datasetIndex * 150
                        },
                        transitions: {
                            active: { animation: { duration: 300 } },
                            resize: { animation: { duration: 0 } },
                            show: { animations: { colors: { from: 'transparent' }, visible: { type: 'boolean', duration: 500 } } },
                            hide: { animations: { colors: { to: 'transparent' }, visible: { type: 'boolean', easing: 'linear', fn: v => v | 0 } } }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [momLabelsByIndex]
                });
            }

            function psRenderAvgScaleOverallChart(canvasId, targetVarSetter) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                if (targetVarSetter.current) { try { targetVarSetter.current.destroy(); } catch(e) {} }

                const capacityRow = psGetSummaryRowByLabel('Avg scale per partner');
                const deliveryRow = psGetSummaryRowByLabel('Delivery rider avg scale (Partners with target)');
                const onlineRow = psGetSummaryRowByLabel('Online riders avg scale (Partners with target)');

                const datasets = [
                    capacityRow ? { label: 'Capacity Target', data: [capacityRow.dec, capacityRow.jan], backgroundColor: '#3b82f6', borderColor: '#1d4ed8', borderWidth: 1.5 } : null,
                    deliveryRow ? { label: 'Delivery Riders (with target)', data: [deliveryRow.dec, deliveryRow.jan], backgroundColor: '#f97316', borderColor: '#ea580c', borderWidth: 1.5 } : null,
                    onlineRow ? { label: 'Online Riders (with target)', data: [onlineRow.dec, onlineRow.jan], backgroundColor: '#10b981', borderColor: '#059669', borderWidth: 1.5 } : null
                ].filter(Boolean);

                const momLabelsByIndex = {
                    id: 'momLabelsByIndex',
                    afterDatasetsDraw(chart) {
                        const { ctx, data } = chart;
                        const showJan = chart.isDatasetVisible(0);
                        const showFeb = chart.isDatasetVisible(1);
                        ctx.save();
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';

                        data.datasets.forEach((dataset, datasetIndex) => {
                            if (!chart.isDatasetVisible(datasetIndex)) return;
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const val = dataset.data[index];
                                if (val === null || val === undefined) return;
                                const x = bar.x;
                                const y = bar.y - 4;
                                const valText = Number(val).toLocaleString();

                                if (index === 1 && showJan && showFeb) {
                                    const mom = psFormatMoM(dataset.data[0], dataset.data[1]);
                                    const sign = parseFloat(mom) > 0 ? '+' : '';
                                    const momText = ` (${sign}${mom}%)`;
                                    const valWidth = ctx.measureText(valText).width;
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x - (ctx.measureText(momText).width / 2), y);
                                    ctx.fillStyle = psMoMColor(mom);
                                    ctx.fillText(momText, x + (valWidth / 2), y);
                                } else {
                                    ctx.fillStyle = '#111827';
                                    ctx.fillText(valText, x, y);
                                }
                            });
                        });
                        ctx.restore();
                    }
                };

                targetVarSetter.current = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb'],
                        datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart',
                            delay: (context) => context.dataIndex * 100 + context.datasetIndex * 150
                        },
                        transitions: {
                            active: { animation: { duration: 300 } },
                            resize: { animation: { duration: 0 } },
                            show: { animations: { colors: { from: 'transparent' }, visible: { type: 'boolean', duration: 500 } } },
                            hide: { animations: { colors: { to: 'transparent' }, visible: { type: 'boolean', easing: 'linear', fn: v => v | 0 } } }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [momLabelsByIndex]
                });
            }

            function psGetMetrics() {
                if (psPerf !== 'all') return psBreakdownData.performance[psPerf];
                if (psScale !== 'all') return psBreakdownData.scale[psScale];
                return psBreakdownData.overall;
            }

            let psBreakdownChart1Instance = null;
            let psBreakdownChart2Instance = null;
            let psBreakdownChart3Instance = null;
            let psBreakdownChart4Instance = null;

            function psRenderMiniChart(canvasId, dec, jan, color, chartInstanceRef) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                if (chartInstanceRef.current) { try { chartInstanceRef.current.destroy(); } catch(e) {} }
                
                const mom = psFormatMoM(dec, jan);
                const momColor = psMoMColor(mom);
                
                chartInstanceRef.current = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb'],
                        datasets: [{
                            data: [dec, jan],
                            backgroundColor: [color + '99', color],
                            borderColor: [color, color],
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart',
                            delay: (context) => context.dataIndex * 150
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 10,
                                callbacks: {
                                    label: ctx => ctx.parsed.y.toLocaleString()
                                }
                            },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: { 
                                display: false,
                                beginAtZero: true
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { font: { size: 10, weight: '600' }, color: '#64748b' }
                            }
                        }
                    }
                });
            }

            function psUpdateBreakdown() {
                const metrics = psGetMetrics();
                const labels = metrics.map(m => m.label);
                const decData = metrics.map(m => m.dec[psPeriod]);
                const janData = metrics.map(m => m.jan[psPeriod]);

                const titleParts = [];
                const periodLabel = psPrettyPeriodLabel(psPeriod);
                titleParts.push(periodLabel);
                if (psPerf !== 'all') titleParts.push(psPrettyPerfLabel(psPerf));
                if (psScale !== 'all') titleParts.push(psPrettyScaleLabel(psScale));
                const breakdownTitle = document.getElementById('psBreakdownTitle');
                if (breakdownTitle) breakdownTitle.textContent = `📊 Breakdown Overview (${titleParts.join(' • ')})`;

                // Update KPI Cards
                const updateKpi = (prefix, dec, jan) => {
                    const decEl = document.getElementById(`psKpi${prefix}Dec`);
                    const janEl = document.getElementById(`psKpi${prefix}Jan`);
                    const momEl = document.getElementById(`psKpi${prefix}Mom`);
                    if (decEl) decEl.textContent = dec.toLocaleString();
                    if (janEl) janEl.textContent = jan.toLocaleString();
                    if (momEl) {
                        const mom = psFormatMoM(dec, jan);
                        const sign = parseFloat(mom) > 0 ? '+' : '';
                        momEl.textContent = `${sign}${mom}% MoM`;
                        momEl.style.color = psMoMColor(mom);
                    }
                };

                // Update labels based on filter context
                const activeLabel = document.getElementById('psKpiActivePartnersLabel');
                const totalLabel = document.getElementById('psKpiTotalPartnersLabel');
                
                if (decData.length >= 4) {
                    // Overall view (4 metrics: partners count, active partners, target, avg scale)
                                        if (totalLabel) {
                                                totalLabel.innerHTML = `
                                                    <span>👥 Total Active Partners</span>
                                                    <span class="kpi-tooltip-wrapper" style="display: inline-flex; align-items: center;">
                                                        <span style="width: 18px; height: 18px; border-radius: 6px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; line-height: 1;">i</span>
                                                        <div class="kpi-tooltip">
                                                            <div class="tooltip-title">👥 Total Active Partners</div>
                                                            <div>Partners with delivery riders active in the <span class="tooltip-highlight">last 7 days</span> of the month.</div>
                                                        </div>
                                                    </span>
                                                `;
                                        }
                                        if (activeLabel) {
                                                activeLabel.innerHTML = `
                                                    <span>🎯 Total Partners With Target</span>
                                                    <span class="kpi-tooltip-wrapper" style="display: inline-flex; align-items: center;">
                                                        <span style="width: 18px; height: 18px; border-radius: 6px; background: #f5f3ff; border: 1px solid #ddd6fe; color: #5b21b6; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; line-height: 1;">i</span>
                                                        <div class="kpi-tooltip">
                                                            <div class="tooltip-title">🎯 Total Partners With Target</div>
                                                            <div>Partners that were <span class="tooltip-highlight">assigned a capacity target</span> for the month.</div>
                                                        </div>
                                                    </span>
                                                `;
                                        }
                    updateKpi('TotalPartners', decData[0], janData[0]);
                    updateKpi('ActivePartners', decData[1], janData[1]);
                    updateKpi('Target', decData[2], janData[2]);
                    updateKpi('AvgScale', decData[3], janData[3]);
                    
                    // Render mini charts
                    psRenderMiniChart('psBreakdownChart1', decData[0], janData[0], '#3b82f6', { get current() { return psBreakdownChart1Instance; }, set current(v) { psBreakdownChart1Instance = v; } });
                    psRenderMiniChart('psBreakdownChart2', decData[1], janData[1], '#8b5cf6', { get current() { return psBreakdownChart2Instance; }, set current(v) { psBreakdownChart2Instance = v; } });
                    psRenderMiniChart('psBreakdownChart3', decData[2], janData[2], '#f59e0b', { get current() { return psBreakdownChart3Instance; }, set current(v) { psBreakdownChart3Instance = v; } });
                    psRenderMiniChart('psBreakdownChart4', decData[3], janData[3], '#10b981', { get current() { return psBreakdownChart4Instance; }, set current(v) { psBreakdownChart4Instance = v; } });
                } else if (decData.length === 3) {
                    // Performance or Scale filtered view (3 metrics: partners with target, target value, avg scale)
                    if (totalLabel) totalLabel.textContent = '👥 Partners with Target';
                    if (activeLabel) activeLabel.textContent = '🎯 Capacity Target Value';
                    updateKpi('TotalPartners', decData[0], janData[0]); // # of partners with target
                    updateKpi('ActivePartners', decData[1], janData[1]); // Target value (NOT partners count!)
                    updateKpi('Target', decData[1], janData[1]); // Target value
                    updateKpi('AvgScale', decData[2], janData[2]); // Avg scale
                    
                    psRenderMiniChart('psBreakdownChart1', decData[0], janData[0], '#3b82f6', { get current() { return psBreakdownChart1Instance; }, set current(v) { psBreakdownChart1Instance = v; } });
                    psRenderMiniChart('psBreakdownChart2', decData[1], janData[1], '#8b5cf6', { get current() { return psBreakdownChart2Instance; }, set current(v) { psBreakdownChart2Instance = v; } });
                    psRenderMiniChart('psBreakdownChart3', decData[1], janData[1], '#f59e0b', { get current() { return psBreakdownChart3Instance; }, set current(v) { psBreakdownChart3Instance = v; } });
                    psRenderMiniChart('psBreakdownChart4', decData[2], janData[2], '#10b981', { get current() { return psBreakdownChart4Instance; }, set current(v) { psBreakdownChart4Instance = v; } });
                }

                const tbody = document.getElementById('psBreakdownTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    metrics.forEach((m, idx) => {
                        const dec = m.dec[psPeriod];
                        const jan = m.jan[psPeriod];
                        const mom = psFormatMoM(dec, jan);
                        const tr = document.createElement('tr');
                        tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                        tr.innerHTML = `
                            <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${m.label}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${psMoMClass(mom)};">${mom}%</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            // Init + Toggle Handlers
            let psCurrentView = 'summary';
            
            function psUpdateSummaryCards(animate) {
                const card1 = document.getElementById('psSummaryCard1');
                const card2 = document.getElementById('psSummaryCard2');
                const card3 = document.getElementById('psSummaryCard3');
                const card4 = document.getElementById('psSummaryCard4');
                const note = document.getElementById('psContextNote');
                if (!card1) return;
                const cards = [card1, card2, card3, card4];
                
                const psSetCard = (card, icon, label, value, mom, sub, tooltip, delay) => {
                    const momVal = parseFloat(mom);
                    const momColor = momVal > 0 ? '#16a34a' : (momVal < 0 ? '#dc2626' : '#f59e0b');
                    const momSign = momVal > 0 ? '+' : '';
                    card.querySelector('[id$=\"Label\"]').textContent = label;
                    card.querySelector('[id$=\"Value\"]').textContent = value;
                    const momEl = card.querySelector('[id$=\"MoM\"]');
                    momEl.textContent = momSign + mom + '%';
                    momEl.style.color = momColor;
                    card.querySelector('[id$=\"Sub\"]').textContent = sub;
                    card.setAttribute('data-tooltip', tooltip);
                    // Update icon
                    const iconDiv = card.querySelector('div[style*=\"border-radius: 10px\"]');
                    if (iconDiv) iconDiv.textContent = icon;
                };
                
                // Animate cards
                if (animate) {
                    cards.forEach(c => { c.classList.remove('ps-card-fly-in'); c.classList.add('ps-card-updating'); });
                    setTimeout(() => {
                        psPopulateCards(psSetCard, cards, note);
                        cards.forEach((c, i) => {
                            setTimeout(() => {
                                c.classList.remove('ps-card-updating');
                                c.classList.add('ps-card-fly-in');
                            }, i * 80);
                        });
                    }, 200);
                } else {
                    psPopulateCards(psSetCard, cards, note);
                }
            }
            
            function psPopulateCards(setCard, cards, note) {
                const fmtN = (n) => typeof n === 'number' ? (n % 1 !== 0 ? n.toFixed(1) : n.toLocaleString()) : n;
                const fmtMoM = (d, j) => { if (!d) return '0.0'; return (((j - d) / d) * 100).toFixed(1); };
                
                if (psCurrentView === 'summary') {
                    // Avg Scale & Capacity Summary view — filter-aware using psBreakdownData
                    let metrics, catLabel;
                    if (psSummaryPerf !== 'all') {
                        metrics = psBreakdownData.performance[psSummaryPerf];
                        catLabel = psPrettyPerfLabel(psSummaryPerf);
                    } else if (psSummaryScale !== 'all') {
                        metrics = psBreakdownData.scale[psSummaryScale];
                        catLabel = psPrettyScaleLabel(psSummaryScale);
                    } else {
                        metrics = psBreakdownData.overall;
                        catLabel = 'Total Partners with Target';
                    }
                    const period = psSummaryPeriod;
                    const periodLabel = psPrettyPeriodLabel(period);
                    // metrics[0] = partners count, metrics[1] = target, metrics[2] = avg scale (index 3 for overall)
                    const partnersM = metrics[metrics.length >= 4 ? 1 : 0];
                    const targetM = metrics[metrics.length >= 4 ? 2 : 1];
                    const avgScaleM = metrics[metrics.length >= 4 ? 3 : 2];

                    const pDec = partnersM.dec[period], pJan = partnersM.jan[period];
                    const tDec = targetM.dec[period], tJan = targetM.jan[period];
                    const aDec = avgScaleM.dec[period], aJan = avgScaleM.jan[period];

                    // Card 1: Partners Count
                    setCard(cards[0], '\ud83d\udc65', catLabel.replace(/ with Target/i,'') + ' Count', fmtN(pJan), fmtMoM(pDec, pJan),
                        'Jan ' + fmtN(pDec) + ' \u2192 Feb ' + fmtN(pJan),
                        partnersM.label + ' (' + periodLabel + '). Jan ' + fmtN(pDec) + ' \u2192 Feb ' + fmtN(pJan) + ' (' + fmtMoM(pDec, pJan) + '% MoM).');
                    // Card 2: Total Target
                    setCard(cards[1], '\ud83c\udfaf', catLabel.replace(/ with Target/i,'') + ' Target', fmtN(tJan), fmtMoM(tDec, tJan),
                        'Jan ' + fmtN(tDec) + ' \u2192 Feb ' + fmtN(tJan),
                        targetM.label + ' (' + periodLabel + '). Jan ' + fmtN(tDec) + ' \u2192 Feb ' + fmtN(tJan) + ' (' + fmtMoM(tDec, tJan) + '% MoM).');
                    // Card 3: Avg Scale
                    setCard(cards[2], '\ud83d\udcca', catLabel.replace(/ with Target/i,'') + ' Avg Scale', fmtN(aJan), fmtMoM(aDec, aJan),
                        'Jan ' + fmtN(aDec) + ' \u2192 Feb ' + fmtN(aJan),
                        avgScaleM.label + ' (' + periodLabel + '). Jan ' + fmtN(aDec) + ' \u2192 Feb ' + fmtN(aJan) + ' (' + fmtMoM(aDec, aJan) + '% MoM).');
                    // Card 4: Overall Avg Scale (always from overall data for comparison)
                    const overallAvg = psBreakdownData.overall[3];
                    const oaDec = overallAvg.dec[period], oaJan = overallAvg.jan[period];
                    setCard(cards[3], '\ud83d\udeb4', 'Overall Avg Scale', fmtN(oaJan), fmtMoM(oaDec, oaJan),
                        'Jan ' + fmtN(oaDec) + ' \u2192 Feb ' + fmtN(oaJan),
                        'Overall avg scale for reference (' + periodLabel + '). Jan ' + fmtN(oaDec) + ' \u2192 Feb ' + fmtN(oaJan) + ' (' + fmtMoM(oaDec, oaJan) + '% MoM).');
                    // Build context note
                    const noteParts = [periodLabel];
                    if (psSummaryPerf !== 'all') noteParts.push(psPrettyPerfLabel(psSummaryPerf));
                    if (psSummaryScale !== 'all') noteParts.push(psPrettyScaleLabel(psSummaryScale));
                    if (note) note.textContent = '\ud83e\udded Showing: ' + noteParts.join(' \u2022 ') + '. Cards reflect the selected period & category with overall avg scale for comparison.';
                    
                } else if (psCurrentView === 'breakdown') {
                    // Performance & Scale Breakdown view
                    const metrics = psGetMetrics();
                    const periodLabel = psPrettyPeriodLabel(psPeriod);
                    let filterLabel = periodLabel;
                    if (psPerf !== 'all') filterLabel += ' \u2022 ' + psPrettyPerfLabel(psPerf);
                    if (psScale !== 'all') filterLabel += ' \u2022 ' + psPrettyScaleLabel(psScale);
                    
                    if (metrics.length >= 4) {
                        const d0 = metrics[0].dec[psPeriod], j0 = metrics[0].jan[psPeriod];
                        const d1 = metrics[1].dec[psPeriod], j1 = metrics[1].jan[psPeriod];
                        const d2 = metrics[2].dec[psPeriod], j2 = metrics[2].jan[psPeriod];
                        const d3 = metrics[3].dec[psPeriod], j3 = metrics[3].jan[psPeriod];
                        setCard(cards[0], '\ud83d\udc65', 'Total Active Partners', fmtN(j0), fmtMoM(d0, j0),
                            'Jan ' + fmtN(d0) + ' \u2192 Feb ' + fmtN(j0),
                            'Total active partners (' + filterLabel + '). Jan ' + fmtN(d0) + ' \u2192 Feb ' + fmtN(j0) + '.');
                        setCard(cards[1], '\u2705', 'Total Partners With Target', fmtN(j1), fmtMoM(d1, j1),
                            'Jan ' + fmtN(d1) + ' \u2192 Feb ' + fmtN(j1),
                            'Active partners with target (' + filterLabel + '). Jan ' + fmtN(d1) + ' \u2192 Feb ' + fmtN(j1) + '.');
                        setCard(cards[2], '\ud83c\udfaf', 'Total Target', fmtN(j2), fmtMoM(d2, j2),
                            'Jan ' + fmtN(d2) + ' \u2192 Feb ' + fmtN(j2),
                            'Capacity target (' + filterLabel + '). Jan ' + fmtN(d2) + ' \u2192 Feb ' + fmtN(j2) + '.');
                        setCard(cards[3], '\ud83d\udcca', 'Avg Scale', fmtN(j3), fmtMoM(d3, j3),
                            'Jan ' + fmtN(d3) + ' \u2192 Feb ' + fmtN(j3),
                            'Avg scale (' + filterLabel + '). Jan ' + fmtN(d3) + ' \u2192 Feb ' + fmtN(j3) + '.');
                    } else if (metrics.length === 3) {
                        const d0 = metrics[0].dec[psPeriod], j0 = metrics[0].jan[psPeriod];
                        const d1 = metrics[1].dec[psPeriod], j1 = metrics[1].jan[psPeriod];
                        const d2 = metrics[2].dec[psPeriod], j2 = metrics[2].jan[psPeriod];
                        setCard(cards[0], '\ud83d\udc65', '# with Target', fmtN(j0), fmtMoM(d0, j0),
                            'Jan ' + fmtN(d0) + ' \u2192 Feb ' + fmtN(j0),
                            'Partners with target (' + filterLabel + '). Jan ' + fmtN(d0) + ' \u2192 Feb ' + fmtN(j0) + '.');
                        setCard(cards[1], '\ud83c\udfaf', 'Target Value', fmtN(j1), fmtMoM(d1, j1),
                            'Jan ' + fmtN(d1) + ' \u2192 Feb ' + fmtN(j1),
                            'Target value (' + filterLabel + '). Jan ' + fmtN(d1) + ' \u2192 Feb ' + fmtN(j1) + '.');
                        setCard(cards[2], '\ud83d\udcca', 'Avg Scale', fmtN(j2), fmtMoM(d2, j2),
                            'Jan ' + fmtN(d2) + ' \u2192 Feb ' + fmtN(j2),
                            'Avg scale (' + filterLabel + '). Jan ' + fmtN(d2) + ' \u2192 Feb ' + fmtN(j2) + '.');
                        // Card 4: MoM highlight
                        const moms = [{ lbl: metrics[0].label.split(' ')[0], m: parseFloat(fmtMoM(d0, j0)) }, { lbl: 'Target', m: parseFloat(fmtMoM(d1, j1)) }, { lbl: 'Scale', m: parseFloat(fmtMoM(d2, j2)) }];
                        const biggest = moms.reduce((a, b) => Math.abs(b.m) > Math.abs(a.m) ? b : a);
                        setCard(cards[3], '\ud83d\udcc8', 'Biggest MoM Shift', biggest.lbl, biggest.m.toFixed(1),
                            biggest.m.toFixed(1) + '% MoM change',
                            'Largest MoM% shift in ' + filterLabel + ': ' + biggest.lbl + ' at ' + biggest.m.toFixed(1) + '%.');
                    }
                    if (note) note.textContent = '\ud83e\udded Breakdown: ' + filterLabel + '. Select period, performance, or scale filters to drill down.';
                    
                } else if (psCurrentView === 'target-breakdown') {
                    // Performance Target Breakdown view
                    const data = psTargetBreakdownData[psTargetViewMode];
                    const typeLabel = psTargetTypeMode === 'all' ? 'All' : (psTargetTypeMode === 'new' ? 'New (<3M)' : (psTargetTypeMode === 'old' ? 'Old (\u22653M)' : 'New vs Old'));
                    const modeLabel = psTargetViewMode === 'partners' ? 'Count' : 'Target';
                    
                    if (psTargetTypeMode === 'compare') {
                        const nT = data.new.good + data.new.average + data.new.bad;
                        const oT = data.old.good + data.old.average + data.old.bad;
                        setCard(cards[0], '\ud83d\udc65', 'Total (' + modeLabel + ')', fmtN(nT + oT), '0.0',
                            'New: ' + fmtN(nT) + ' | Old: ' + fmtN(oT),
                            'Total across New+Old partners. New: ' + fmtN(nT) + ', Old: ' + fmtN(oT) + '.');
                        cards[0].querySelector('[id$=\"MoM\"]').textContent = 'N:' + fmtN(nT) + ' O:' + fmtN(oT);
                        cards[0].querySelector('[id$=\"MoM\"]').style.color = '#6366f1';
                        setCard(cards[1], '\u2705', 'Good', fmtN(data.new.good + data.old.good), '0.0',
                            'New: ' + fmtN(data.new.good) + ' | Old: ' + fmtN(data.old.good),
                            'Good partners. New: ' + fmtN(data.new.good) + ', Old: ' + fmtN(data.old.good) + '.');
                        cards[1].querySelector('[id$=\"MoM\"]').textContent = 'N:' + fmtN(data.new.good) + ' O:' + fmtN(data.old.good);
                        cards[1].querySelector('[id$=\"MoM\"]').style.color = '#10b981';
                        setCard(cards[2], '\u26a0\ufe0f', 'Average', fmtN(data.new.average + data.old.average), '0.0',
                            'New: ' + fmtN(data.new.average) + ' | Old: ' + fmtN(data.old.average),
                            'Average partners. New: ' + fmtN(data.new.average) + ', Old: ' + fmtN(data.old.average) + '.');
                        cards[2].querySelector('[id$=\"MoM\"]').textContent = 'N:' + fmtN(data.new.average) + ' O:' + fmtN(data.old.average);
                        cards[2].querySelector('[id$=\"MoM\"]').style.color = '#f59e0b';
                        setCard(cards[3], '\u274c', 'Bad', fmtN(data.new.bad + data.old.bad), '0.0',
                            'New: ' + fmtN(data.new.bad) + ' | Old: ' + fmtN(data.old.bad),
                            'Bad partners. New: ' + fmtN(data.new.bad) + ', Old: ' + fmtN(data.old.bad) + '.');
                        cards[3].querySelector('[id$=\"MoM\"]').textContent = 'N:' + fmtN(data.new.bad) + ' O:' + fmtN(data.old.bad);
                        cards[3].querySelector('[id$=\"MoM\"]').style.color = '#dc2626';
                    } else {
                        const src = data[psTargetTypeMode];
                        const total = src.good + src.average + src.bad;
                        const goodPct = total ? ((src.good / total) * 100).toFixed(1) : '0.0';
                        const avgPct = total ? ((src.average / total) * 100).toFixed(1) : '0.0';
                        const badPct = total ? ((src.bad / total) * 100).toFixed(1) : '0.0';
                        setCard(cards[0], '\ud83d\udc65', 'Total (' + modeLabel + ')', fmtN(total), '0.0',
                            typeLabel + ' partners',
                            'Total ' + modeLabel.toLowerCase() + ' for ' + typeLabel + ' partners: ' + fmtN(total) + '.');
                        cards[0].querySelector('[id$=\"MoM\"]').textContent = typeLabel;
                        cards[0].querySelector('[id$=\"MoM\"]').style.color = '#6366f1';
                        setCard(cards[1], '\u2705', 'Good', fmtN(src.good), goodPct,
                            goodPct + '% of total',
                            'Good partners ' + modeLabel.toLowerCase() + ': ' + fmtN(src.good) + ' (' + goodPct + '%).');
                        cards[1].querySelector('[id$=\"MoM\"]').textContent = goodPct + '%';
                        cards[1].querySelector('[id$=\"MoM\"]').style.color = '#10b981';
                        setCard(cards[2], '\u26a0\ufe0f', 'Average', fmtN(src.average), avgPct,
                            avgPct + '% of total',
                            'Average partners ' + modeLabel.toLowerCase() + ': ' + fmtN(src.average) + ' (' + avgPct + '%).');
                        cards[2].querySelector('[id$=\"MoM\"]').textContent = avgPct + '%';
                        cards[2].querySelector('[id$=\"MoM\"]').style.color = '#f59e0b';
                        setCard(cards[3], '\u274c', 'Bad', fmtN(src.bad), badPct,
                            badPct + '% of total',
                            'Bad partners ' + modeLabel.toLowerCase() + ': ' + fmtN(src.bad) + ' (' + badPct + '%).');
                        cards[3].querySelector('[id$=\"MoM\"]').textContent = badPct + '%';
                        cards[3].querySelector('[id$=\"MoM\"]').style.color = '#dc2626';
                    }
                    if (note) note.textContent = '\ud83e\udded Performance Target: ' + modeLabel + ' view \u2022 ' + typeLabel + '. Switch view (Count/Target) or partner type for details.';
                    
                } else if (psCurrentView === 'vehicle-type') {
                    // Vehicle Type Breakdown view
                    let data, cityLabel;
                    if (vehicleCityLevel === 't1') {
                        data = getVehicleTierData('t1'); cityLabel = 'T1 Cities';
                    } else if (vehicleCityLevel === 't2') {
                        data = getVehicleTierData('t2'); cityLabel = 'T2 Cities';
                    } else if (vehicleCityLevel === 't1vst2') {
                        data = vehicleCityData.all; cityLabel = 'All (T1 vs T2)';
                    } else if (vehicleSelectedCity !== 'all') {
                        data = vehicleCityData[vehicleSelectedCity] || vehicleCityData.all; cityLabel = vehicleSelectedCity;
                    } else {
                        data = vehicleCityData.all; cityLabel = 'All Cities';
                    }
                    const decT = data.dec.cars + data.dec.bikes;
                    const janT = data.jan.cars + data.jan.bikes;
                    const totalMoM = fmtMoM(decT, janT);
                    const carsMoM = fmtMoM(data.dec.cars, data.jan.cars);
                    const bikesMoM = fmtMoM(data.dec.bikes, data.jan.bikes);
                    const carsPct = janT ? ((data.jan.cars / janT) * 100).toFixed(1) : '0.0';
                    const bikesPct = janT ? ((data.jan.bikes / janT) * 100).toFixed(1) : '0.0';
                    
                    setCard(cards[0], '\ud83d\ude97', 'Total Target', fmtN(janT), totalMoM,
                        'Jan ' + fmtN(decT) + ' \u2192 Feb ' + fmtN(janT),
                        'Total target for ' + cityLabel + '. Jan ' + fmtN(decT) + ' \u2192 Feb ' + fmtN(janT) + ' (' + totalMoM + '% MoM).');
                    setCard(cards[1], '\ud83d\ude99', 'Cars Target', fmtN(data.jan.cars) + ' (' + carsPct + '%)', carsMoM,
                        'Jan ' + fmtN(data.dec.cars) + ' \u2192 Feb ' + fmtN(data.jan.cars),
                        'Cars target for ' + cityLabel + ': ' + fmtN(data.jan.cars) + ' (' + carsPct + '%). Jan ' + fmtN(data.dec.cars) + ' \u2192 Feb (' + carsMoM + '% MoM).');
                    setCard(cards[2], '\ud83c\udfcd\ufe0f', 'Bikes Target', fmtN(data.jan.bikes) + ' (' + bikesPct + '%)', bikesMoM,
                        'Jan ' + fmtN(data.dec.bikes) + ' \u2192 Feb ' + fmtN(data.jan.bikes),
                        'Bikes target for ' + cityLabel + ': ' + fmtN(data.jan.bikes) + ' (' + bikesPct + '%). Jan ' + fmtN(data.dec.bikes) + ' \u2192 Feb (' + bikesMoM + '% MoM).');
                    // Card 4: MoM Change summary
                    const totalChange = janT - decT;
                    const changeSign = totalChange >= 0 ? '+' : '';
                    setCard(cards[3], '\ud83d\udcc9', 'MoM Change', changeSign + fmtN(totalChange), totalMoM,
                        'Cars: ' + fmtN(data.jan.cars - data.dec.cars) + ' | Bikes: ' + fmtN(data.jan.bikes - data.dec.bikes),
                        'MoM change for ' + cityLabel + ': ' + changeSign + fmtN(totalChange) + ' (' + totalMoM + '%). Cars: ' + fmtN(data.jan.cars - data.dec.cars) + ', Bikes: ' + fmtN(data.jan.bikes - data.dec.bikes) + '.');
                    if (note) note.textContent = '\ud83e\udded Vehicle Type: ' + cityLabel + '. Filter by city tier or individual city to compare Cars vs Bikes distribution.';
                }
            }
            
            psRenderSummaryTable();
            psRenderAvgScaleChart();
            psRenderRidersBreakdownChart('psRidersBreakdownChart', { get current() { return psRidersBreakdownChartInstance; }, set current(v) { psRidersBreakdownChartInstance = v; } });
            psRenderAvgScaleOverallChart('psAvgScaleOverallChart', { get current() { return psAvgScaleOverallChartInstance; }, set current(v) { psAvgScaleOverallChartInstance = v; } });
            psRenderRidersBreakdownChart('psCombinedRidersChart', { get current() { return psCombinedRidersChartInstance; }, set current(v) { psCombinedRidersChartInstance = v; } });
            psRenderAvgScaleOverallChart('psCombinedAvgScaleChart', { get current() { return psCombinedAvgScaleChartInstance; }, set current(v) { psCombinedAvgScaleChartInstance = v; } });
            psUpdateBreakdown();

            document.querySelectorAll('.ps-view-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    document.querySelectorAll('.ps-view-toggle').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                        b.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                    });
                    this.style.background = '#0ea5e9';
                    this.style.color = 'white';
                    this.style.borderColor = '#0ea5e9';
                    this.style.boxShadow = '0 4px 10px rgba(14,165,233,0.25)';
                    document.getElementById('psSummaryView').style.display = view === 'summary' ? 'block' : 'none';
                    document.getElementById('psBreakdownView').style.display = view === 'breakdown' ? 'block' : 'none';
                    document.getElementById('psTargetBreakdownView').style.display = view === 'target-breakdown' ? 'block' : 'none';
                    document.getElementById('psVehicleTypeView').style.display = view === 'vehicle-type' ? 'block' : 'none';
                    if (view === 'target-breakdown') {
                        renderPsTargetBreakdownChart();
                    }
                    if (view === 'vehicle-type') {
                        initVehicleTypeCharts();
                    }
                    psCurrentView = view;
                    psUpdateSummaryCards(true);
                });
            });

            document.querySelectorAll('.ps-summary-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psSummaryPeriod = this.getAttribute('data-period');
                    document.querySelectorAll('.ps-summary-period-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#0ea5e9';
                    this.style.color = 'white';
                    this.style.borderColor = '#0ea5e9';
                    psRenderAvgScaleChart();
                    psUpdateSummaryCards(true);
                });
            });

            document.querySelectorAll('.ps-summary-perf-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psSummaryPerf = this.getAttribute('data-perf');
                    if (psSummaryPerf !== 'all') {
                        psSummaryScale = 'all';
                        document.querySelectorAll('.ps-summary-scale-btn').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#6b7280';
                            b.style.borderColor = '#e5e7eb';
                        });
                        const scaleAll = document.querySelector('.ps-summary-scale-btn[data-scale="all"]');
                        if (scaleAll) {
                            scaleAll.style.background = '#0ea5e9';
                            scaleAll.style.color = 'white';
                            scaleAll.style.borderColor = '#0ea5e9';
                        }
                    }
                    document.querySelectorAll('.ps-summary-perf-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#0ea5e9';
                    this.style.color = 'white';
                    this.style.borderColor = '#0ea5e9';
                    psRenderAvgScaleChart();
                    psUpdateSummaryCards(true);
                });
            });

            document.querySelectorAll('.ps-summary-scale-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psSummaryScale = this.getAttribute('data-scale');
                    if (psSummaryScale !== 'all') {
                        psSummaryPerf = 'all';
                        document.querySelectorAll('.ps-summary-perf-btn').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#6b7280';
                            b.style.borderColor = '#e5e7eb';
                        });
                        const perfAll = document.querySelector('.ps-summary-perf-btn[data-perf="all"]');
                        if (perfAll) {
                            perfAll.style.background = '#0ea5e9';
                            perfAll.style.color = 'white';
                            perfAll.style.borderColor = '#0ea5e9';
                        }
                    }
                    document.querySelectorAll('.ps-summary-scale-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#0ea5e9';
                    this.style.color = 'white';
                    this.style.borderColor = '#0ea5e9';
                    psRenderAvgScaleChart();
                    psUpdateSummaryCards(true);
                });
            });

            function psUpdateSummaryView() {
                const ridersView = document.getElementById('psRidersView');
                const avgView = document.getElementById('psAvgScaleView');
                const bothView = document.getElementById('psBothView');
                if (ridersView) ridersView.style.display = psSummaryView === 'riders' ? 'block' : 'none';
                if (avgView) avgView.style.display = psSummaryView === 'avgscale' ? 'block' : 'none';
                if (bothView) bothView.style.display = psSummaryView === 'both' ? 'block' : 'none';
                
                // Re-render charts to trigger animations on view switch
                if (psSummaryView === 'riders') {
                    psRenderRidersBreakdownChart('psRidersBreakdownChart', { get current() { return psRidersBreakdownChartInstance; }, set current(v) { psRidersBreakdownChartInstance = v; } });
                } else if (psSummaryView === 'avgscale') {
                    psRenderAvgScaleOverallChart('psAvgScaleOverallChart', { get current() { return psAvgScaleOverallChartInstance; }, set current(v) { psAvgScaleOverallChartInstance = v; } });
                } else if (psSummaryView === 'both') {
                    psRenderRidersBreakdownChart('psCombinedRidersChart', { get current() { return psCombinedRidersChartInstance; }, set current(v) { psCombinedRidersChartInstance = v; } });
                    psRenderAvgScaleOverallChart('psCombinedAvgScaleChart', { get current() { return psCombinedAvgScaleChartInstance; }, set current(v) { psCombinedAvgScaleChartInstance = v; } });
                }
            }

            document.querySelectorAll('.ps-summary-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psSummaryView = this.getAttribute('data-view');
                    document.querySelectorAll('.ps-summary-view-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#0ea5e9';
                    this.style.color = 'white';
                    this.style.borderColor = '#0ea5e9';
                    psUpdateSummaryView();
                });
            });

            psUpdateSummaryView();

            document.querySelectorAll('.ps-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psPeriod = this.getAttribute('data-period');
                    document.querySelectorAll('.ps-period-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#3b82f6';
                    this.style.color = 'white';
                    this.style.borderColor = '#3b82f6';
                    psUpdateBreakdown();
                    psUpdateSummaryCards(true);
                });
            });

            document.querySelectorAll('.ps-perf-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psPerf = this.getAttribute('data-perf');
                    if (psPerf !== 'all') {
                        psScale = 'all';
                        document.querySelectorAll('.ps-scale-btn').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#6b7280';
                            b.style.borderColor = '#e5e7eb';
                        });
                        document.querySelector('.ps-scale-btn[data-scale="all"]').style.background = '#3b82f6';
                        document.querySelector('.ps-scale-btn[data-scale="all"]').style.color = 'white';
                        document.querySelector('.ps-scale-btn[data-scale="all"]').style.borderColor = '#3b82f6';
                    }
                    document.querySelectorAll('.ps-perf-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#3b82f6';
                    this.style.color = 'white';
                    this.style.borderColor = '#3b82f6';
                    psUpdateBreakdown();
                    psUpdateSummaryCards(true);
                });
            });

            document.querySelectorAll('.ps-scale-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psScale = this.getAttribute('data-scale');
                    if (psScale !== 'all') {
                        psPerf = 'all';
                        document.querySelectorAll('.ps-perf-btn').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#6b7280';
                            b.style.borderColor = '#e5e7eb';
                        });
                        document.querySelector('.ps-perf-btn[data-perf="all"]').style.background = '#3b82f6';
                        document.querySelector('.ps-perf-btn[data-perf="all"]').style.color = 'white';
                        document.querySelector('.ps-perf-btn[data-perf="all"]').style.borderColor = '#3b82f6';
                    }
                    document.querySelectorAll('.ps-scale-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#3b82f6';
                    this.style.color = 'white';
                    this.style.borderColor = '#3b82f6';
                    psUpdateBreakdown();
                    psUpdateSummaryCards(true);
                });
            });

            // Performance Target Breakdown Data
            const psTargetBreakdownData = {
                partners: {
                    new: { good: 41, average: 57, bad: 12, total: 110 },
                    old: { good: 211, average: 205, bad: 8, total: 424 },
                    all: { good: 252, average: 262, bad: 20, total: 534 }
                },
                target: {
                    new: { good: 1100, average: 1260, bad: 213, total: 2573 },
                    old: { good: 9092, average: 7154, bad: 157, total: 16403 },
                    all: { good: 10192, average: 8414, bad: 370, total: 18976 }
                }
            };
            
            let psTargetBreakdownChartInstance = null;
            let psTargetViewMode = 'partners';
            let psTargetTypeMode = 'all';
            
            function renderPsTargetBreakdownChart() {
                const canvas = document.getElementById('psTargetBreakdownChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                if (psTargetBreakdownChartInstance) {
                    try { psTargetBreakdownChartInstance.destroy(); } catch(e) {}
                }
                
                const dataSource = psTargetBreakdownData[psTargetViewMode];
                const labels = ['Good', 'Average', 'Bad'];
                const titlePrefix = psTargetViewMode === 'partners' ? 'Partner Count' : 'Target Value';
                
                let datasets = [];
                let title = '';
                
                // Color scheme
                const colors = {
                    new: { line: '#3b82f6', fill: 'rgba(59, 130, 246, 0.15)', point: '#2563eb' },
                    old: { line: '#10b981', fill: 'rgba(16, 185, 129, 0.15)', point: '#059669' },
                    all: { line: '#f59e0b', fill: 'rgba(245, 158, 11, 0.15)', point: '#d97706' }
                };
                
                if (psTargetTypeMode === 'compare') {
                    // New vs Old comparison
                    title = `Performance Target Breakdown - ${titlePrefix} (New vs Old Partners)`;
                    
                    const gradientNew = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientNew.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                    gradientNew.addColorStop(0.5, 'rgba(59, 130, 246, 0.2)');
                    gradientNew.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
                    
                    const gradientOld = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientOld.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                    gradientOld.addColorStop(0.5, 'rgba(16, 185, 129, 0.2)');
                    gradientOld.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
                    
                    datasets = [{
                        label: 'New Partners (<3M)',
                        data: [dataSource.new.good, dataSource.new.average, dataSource.new.bad],
                        borderColor: colors.new.line,
                        backgroundColor: gradientNew,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.new.point,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }, {
                        label: 'Old Partners (≥3M)',
                        data: [dataSource.old.good, dataSource.old.average, dataSource.old.bad],
                        borderColor: colors.old.line,
                        backgroundColor: gradientOld,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.old.point,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }];
                } else {
                    // Single type view
                    const typeLabel = psTargetTypeMode === 'all' ? 'All Partners' : (psTargetTypeMode === 'new' ? 'New Partners (<3M)' : 'Old Partners (≥3M)');
                    title = `Performance Target Breakdown - ${titlePrefix} (${typeLabel})`;
                    
                    const colorSet = colors[psTargetTypeMode];
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, colorSet.fill.replace('0.15', '0.4'));
                    gradient.addColorStop(0.5, colorSet.fill.replace('0.15', '0.2'));
                    gradient.addColorStop(1, colorSet.fill.replace('0.15', '0.02'));
                    
                    datasets = [{
                        label: typeLabel,
                        data: [dataSource[psTargetTypeMode].good, dataSource[psTargetTypeMode].average, dataSource[psTargetTypeMode].bad],
                        borderColor: colorSet.line,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colorSet.point,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: colorSet.point,
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }];
                }
                
                document.getElementById('psTargetBreakdownTitle').textContent = title;
                
                psTargetBreakdownChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 50, right: 30, left: 10 } },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 25,
                                    font: { size: 12, weight: '600' }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                padding: 14,
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                borderColor: '#f59e0b',
                                borderWidth: 1,
                                displayColors: true,
                                usePointStyle: true,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((sum, v) => sum + v, 0);
                                        const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                        const suffix = psTargetViewMode === 'partners' ? ' partners' : ' riders';
                                        return `  ${context.dataset.label}: ${context.parsed.y.toLocaleString()}${suffix} (${pct}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: 8,
                                font: { size: 10, weight: 'bold' },
                                color: '#1f2937',
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                borderRadius: 4,
                                padding: { top: 2, bottom: 2, left: 5, right: 5 },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return value.toLocaleString() + ' (' + pct + '%)';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grace: '15%',
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.06)',
                                    drawBorder: false
                                },
                                ticks: { 
                                    callback: (value) => value.toLocaleString(), 
                                    font: { size: 11 },
                                    padding: 8
                                },
                                title: { 
                                    display: true, 
                                    text: psTargetViewMode === 'partners' ? 'Number of Partners' : 'Target Riders', 
                                    font: { size: 12, weight: 'bold' },
                                    padding: { bottom: 10 }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 12, weight: '600' },
                                    padding: 8
                                },
                                title: { 
                                    display: true, 
                                    text: 'Performance Level', 
                                    font: { size: 12, weight: 'bold' },
                                    padding: { top: 10 }
                                }
                            }
                        }
                    }
                });
            }
            
            // Performance Target View toggle (Partner Count / Target Value)
            document.querySelectorAll('.ps-target-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psTargetViewMode = this.getAttribute('data-view');
                    document.querySelectorAll('.ps-target-view-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#f59e0b';
                    this.style.color = 'white';
                    this.style.borderColor = '#f59e0b';
                    renderPsTargetBreakdownChart();
                    psUpdateSummaryCards(true);
                });
            });
            
            // Performance Target Type toggle (All / New / Old / Compare)
            document.querySelectorAll('.ps-target-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    psTargetTypeMode = this.getAttribute('data-type');
                    document.querySelectorAll('.ps-target-type-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#f59e0b';
                    this.style.color = 'white';
                    this.style.borderColor = '#f59e0b';
                    renderPsTargetBreakdownChart();
                    psUpdateSummaryCards(true);
                });
            });

            // Vehicle Type Breakdown Data by City
            const vehicleCityData = {
                all: { dec: { cars: 17446, bikes: 5007 }, jan: { cars: 14443, bikes: 4922 } },
                Riyadh: { dec: { cars: 8103, bikes: 1925 }, jan: { cars: 6701, bikes: 1960 } },
                Jeddah: { dec: { cars: 2469, bikes: 1625 }, jan: { cars: 1900, bikes: 1554 } },
                Dammam: { dec: { cars: 2205, bikes: 436 }, jan: { cars: 1769, bikes: 358 } },
                Madinah: { dec: { cars: 929, bikes: 266 }, jan: { cars: 841, bikes: 290 } },
                Makkah: { dec: { cars: 738, bikes: 336 }, jan: { cars: 540, bikes: 395 } },
                'Al Ahsa': { dec: { cars: 712, bikes: 146 }, jan: { cars: 695, bikes: 123 } },
                'Al Kharj': { dec: { cars: 380, bikes: 0 }, jan: { cars: 347, bikes: 0 } },
                Abha: { dec: { cars: 316, bikes: 23 }, jan: { cars: 279, bikes: 18 } },
                Taif: { dec: { cars: 277, bikes: 68 }, jan: { cars: 204, bikes: 88 } },
                Buraydah: { dec: { cars: 232, bikes: 64 }, jan: { cars: 218, bikes: 35 } },
                Jubail: { dec: { cars: 224, bikes: 20 }, jan: { cars: 210, bikes: 20 } },
                Tabuk: { dec: { cars: 242, bikes: 10 }, jan: { cars: 186, bikes: 16 } },
                Hail: { dec: { cars: 199, bikes: 0 }, jan: { cars: 186, bikes: 0 } },
                Yanbu: { dec: { cars: 154, bikes: 55 }, jan: { cars: 128, bikes: 43 } },
                'Hafar Al Batin': { dec: { cars: 103, bikes: 25 }, jan: { cars: 97, bikes: 12 } },
                Jazan: { dec: { cars: 85, bikes: 10 }, jan: { cars: 64, bikes: 10 } },
                Najran: { dec: { cars: 76, bikes: 0 }, jan: { cars: 78, bikes: 0 } }
            };
            
            // T1 and T2 city mappings for Vehicle Type
            const vehicleT1Cities = ['Riyadh', 'Jeddah', 'Dammam', 'Madinah', 'Makkah', 'Al Ahsa', 'Al Kharj'];
            const vehicleT2Cities = ['Abha', 'Taif', 'Buraydah', 'Jubail', 'Tabuk', 'Hail', 'Yanbu', 'Hafar Al Batin', 'Jazan', 'Najran'];
            
            // Calculate aggregated data for T1 and T2
            function getVehicleTierData(tier) {
                const cities = tier === 't1' ? vehicleT1Cities : vehicleT2Cities;
                let decCars = 0, decBikes = 0, janCars = 0, janBikes = 0;
                cities.forEach(city => {
                    const d = vehicleCityData[city];
                    if (d) {
                        decCars += d.dec.cars;
                        decBikes += d.dec.bikes;
                        janCars += d.jan.cars;
                        janBikes += d.jan.bikes;
                    }
                });
                return { dec: { cars: decCars, bikes: decBikes }, jan: { cars: janCars, bikes: janBikes } };
            }
            
            let vehicleDonutDecChart = null;
            let vehicleDonutJanChart = null;
            let vehicleTypeChartInstance = null;
            let vehicleT1ChartInstance = null;
            let vehicleT2ChartInstance = null;
            let vehicleViewMode = 'comparison';
            let vehicleSelectedCity = 'all';
            let vehicleCityLevel = 'all';
            
            function initVehicleTypeCharts() {
                let data;
                let cityLabel;
                
                if (vehicleCityLevel === 't1') {
                    // Show city-level breakdown for T1 cities
                    renderVehicleTierCitiesChart('t1', 'T1 Cities (Major)');
                    return;
                } else if (vehicleCityLevel === 't2') {
                    // Show city-level breakdown for T2 cities
                    renderVehicleTierCitiesChart('t2', 'T2 Cities (Emerging)');
                    return;
                } else if (vehicleCityLevel === 't1vst2') {
                    // Handle T1 vs T2 separately
                    updateVehicleT1vsT2View();
                    return;
                } else if (vehicleSelectedCity !== 'all') {
                    data = vehicleCityData[vehicleSelectedCity] || vehicleCityData.all;
                    cityLabel = vehicleSelectedCity;
                } else {
                    data = vehicleCityData.all;
                    cityLabel = 'All Cities';
                }
                
                // Show single chart, hide dual
                document.getElementById('vehicleTypeChart').parentElement.style.display = 'block';
                document.getElementById('vehicleT1vsT2Container').style.display = 'none';
                
                const decTotal = data.dec.cars + data.dec.bikes;
                const janTotal = data.jan.cars + data.jan.bikes;
                const decCarsPct = decTotal ? ((data.dec.cars / decTotal) * 100).toFixed(1) : 0;
                const decBikesPct = decTotal ? ((data.dec.bikes / decTotal) * 100).toFixed(1) : 0;
                const janCarsPct = janTotal ? ((data.jan.cars / janTotal) * 100).toFixed(1) : 0;
                const janBikesPct = janTotal ? ((data.jan.bikes / janTotal) * 100).toFixed(1) : 0;
                
                // Update KPI values
                document.getElementById('vehicleDonutDecTotal').textContent = decTotal.toLocaleString();
                document.getElementById('vehicleDecCars').textContent = data.dec.cars.toLocaleString();
                document.getElementById('vehicleDecBikes').textContent = data.dec.bikes.toLocaleString();
                document.getElementById('vehicleDecCarsPct').textContent = decCarsPct + '%';
                document.getElementById('vehicleDecBikesPct').textContent = decBikesPct + '%';
                
                document.getElementById('vehicleDonutJanTotal').textContent = janTotal.toLocaleString();
                document.getElementById('vehicleJanCars').textContent = data.jan.cars.toLocaleString();
                document.getElementById('vehicleJanBikes').textContent = data.jan.bikes.toLocaleString();
                document.getElementById('vehicleJanCarsPct').textContent = janCarsPct + '%';
                document.getElementById('vehicleJanBikesPct').textContent = janBikesPct + '%';
                
                // Update change values with percentages
                const totalChange = janTotal - decTotal;
                const carsChange = data.jan.cars - data.dec.cars;
                const bikesChange = data.jan.bikes - data.dec.bikes;
                const totalChangePct = decTotal ? ((totalChange / decTotal) * 100).toFixed(1) : 0;
                const carsChangePct = data.dec.cars ? ((carsChange / data.dec.cars) * 100).toFixed(1) : 0;
                const bikesChangePct = data.dec.bikes ? ((bikesChange / data.dec.bikes) * 100).toFixed(1) : 0;
                
                document.getElementById('vehicleTotalChange').textContent = (totalChange >= 0 ? '+' : '') + totalChange.toLocaleString();
                document.getElementById('vehicleTotalChange').style.color = totalChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleTotalChangePct').textContent = (totalChange >= 0 ? '+' : '') + totalChangePct + '%';
                document.getElementById('vehicleCarsChange').textContent = (carsChange >= 0 ? '+' : '') + carsChange.toLocaleString();
                document.getElementById('vehicleCarsChange').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleCarsChangePct').textContent = (carsChange >= 0 ? '+' : '') + carsChangePct + '%';
                document.getElementById('vehicleCarsChangePct').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChange').textContent = (bikesChange >= 0 ? '+' : '') + bikesChange.toLocaleString();
                document.getElementById('vehicleBikesChange').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChangePct').textContent = (bikesChange >= 0 ? '+' : '') + bikesChangePct + '%';
                document.getElementById('vehicleBikesChangePct').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                
                // Render Donut charts
                renderVehicleDonut('vehicleDonutDec', data.dec.cars, data.dec.bikes);
                renderVehicleDonut('vehicleDonutJan', data.jan.cars, data.jan.bikes);
                
                // Render main chart
                renderVehicleTypeChart(data, cityLabel);
            }
            
            function updateVehicleT1vsT2View() {
                const t1Data = getVehicleTierData('t1');
                const t2Data = getVehicleTierData('t2');
                const allData = vehicleCityData.all;
                
                // Hide single chart, show dual
                document.getElementById('vehicleTypeChart').parentElement.style.display = 'none';
                document.getElementById('vehicleT1vsT2Container').style.display = 'flex';
                
                // Update KPIs with combined data
                const decTotal = allData.dec.cars + allData.dec.bikes;
                const janTotal = allData.jan.cars + allData.jan.bikes;
                const decCarsPct = decTotal ? ((allData.dec.cars / decTotal) * 100).toFixed(1) : 0;
                const decBikesPct = decTotal ? ((allData.dec.bikes / decTotal) * 100).toFixed(1) : 0;
                const janCarsPct = janTotal ? ((allData.jan.cars / janTotal) * 100).toFixed(1) : 0;
                const janBikesPct = janTotal ? ((allData.jan.bikes / janTotal) * 100).toFixed(1) : 0;
                
                document.getElementById('vehicleDonutDecTotal').textContent = decTotal.toLocaleString();
                document.getElementById('vehicleDecCars').textContent = allData.dec.cars.toLocaleString();
                document.getElementById('vehicleDecBikes').textContent = allData.dec.bikes.toLocaleString();
                document.getElementById('vehicleDecCarsPct').textContent = decCarsPct + '%';
                document.getElementById('vehicleDecBikesPct').textContent = decBikesPct + '%';
                
                document.getElementById('vehicleDonutJanTotal').textContent = janTotal.toLocaleString();
                document.getElementById('vehicleJanCars').textContent = allData.jan.cars.toLocaleString();
                document.getElementById('vehicleJanBikes').textContent = allData.jan.bikes.toLocaleString();
                document.getElementById('vehicleJanCarsPct').textContent = janCarsPct + '%';
                document.getElementById('vehicleJanBikesPct').textContent = janBikesPct + '%';
                
                // Update change values with percentages
                const totalChange = janTotal - decTotal;
                const carsChange = allData.jan.cars - allData.dec.cars;
                const bikesChange = allData.jan.bikes - allData.dec.bikes;
                const totalChangePct = decTotal ? ((totalChange / decTotal) * 100).toFixed(1) : 0;
                const carsChangePct = allData.dec.cars ? ((carsChange / allData.dec.cars) * 100).toFixed(1) : 0;
                const bikesChangePct = allData.dec.bikes ? ((bikesChange / allData.dec.bikes) * 100).toFixed(1) : 0;
                
                document.getElementById('vehicleTotalChange').textContent = (totalChange >= 0 ? '+' : '') + totalChange.toLocaleString();
                document.getElementById('vehicleTotalChange').style.color = totalChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleTotalChangePct').textContent = (totalChange >= 0 ? '+' : '') + totalChangePct + '%';
                document.getElementById('vehicleCarsChange').textContent = (carsChange >= 0 ? '+' : '') + carsChange.toLocaleString();
                document.getElementById('vehicleCarsChange').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleCarsChangePct').textContent = (carsChange >= 0 ? '+' : '') + carsChangePct + '%';
                document.getElementById('vehicleCarsChangePct').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChange').textContent = (bikesChange >= 0 ? '+' : '') + bikesChange.toLocaleString();
                document.getElementById('vehicleBikesChange').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChangePct').textContent = (bikesChange >= 0 ? '+' : '') + bikesChangePct + '%';
                document.getElementById('vehicleBikesChangePct').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                
                // Render Donut charts
                renderVehicleDonut('vehicleDonutDec', allData.dec.cars, allData.dec.bikes);
                renderVehicleDonut('vehicleDonutJan', allData.jan.cars, allData.jan.bikes);
                
                // Render T1 chart with city breakdown
                renderVehicleTierChart('vehicleT1Chart', 't1');
                // Render T2 chart with city breakdown
                renderVehicleTierChart('vehicleT2Chart', 't2');
            }
            
            function renderVehicleTierChart(canvasId, tier) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (canvasId === 'vehicleT1Chart' && vehicleT1ChartInstance) {
                    try { vehicleT1ChartInstance.destroy(); } catch(e) {}
                }
                if (canvasId === 'vehicleT2Chart' && vehicleT2ChartInstance) {
                    try { vehicleT2ChartInstance.destroy(); } catch(e) {}
                }
                
                const cities = tier === 't1' ? vehicleT1Cities : vehicleT2Cities;
                
                // Build city data with totals for sorting
                const cityDataArray = cities.map(city => {
                    const d = vehicleCityData[city];
                    return { 
                        city, 
                        decCars: d ? d.dec.cars : 0,
                        decBikes: d ? d.dec.bikes : 0,
                        janCars: d ? d.jan.cars : 0,
                        janBikes: d ? d.jan.bikes : 0,
                        avgTotal: d ? ((d.dec.cars + d.dec.bikes + d.jan.cars + d.jan.bikes) / 2) : 0
                    };
                });
                
                // Sort by average total (highest to lowest)
                cityDataArray.sort((a, b) => b.avgTotal - a.avgTotal);
                
                const sortedCities = cityDataArray.map(c => c.city);
                const cityLabels = sortedCities.map(city => city.length > 8 ? city.substring(0, 6) + '..' : city);
                
                // Calculate totals for trend line
                const decTotals = cityDataArray.map(c => c.decCars + c.decBikes);
                const janTotals = cityDataArray.map(c => c.janCars + c.janBikes);
                
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: cityLabels,
                        datasets: [
                            {
                                label: '🚗 Cars (Jan)',
                                data: cityDataArray.map(c => c.decCars),
                                backgroundColor: 'rgba(59, 130, 246, 0.9)',
                                borderColor: '#2563eb',
                                borderWidth: 1,
                                stack: 'dec',
                                order: 2
                            },
                            {
                                label: '🏍️ Bikes (Jan)',
                                data: cityDataArray.map(c => c.decBikes),
                                backgroundColor: 'rgba(16, 185, 129, 0.9)',
                                borderColor: '#059669',
                                borderWidth: 1,
                                stack: 'dec',
                                order: 2
                            },
                            {
                                label: '🚗 Cars (Feb)',
                                data: cityDataArray.map(c => c.janCars),
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                stack: 'jan',
                                order: 2
                            },
                            {
                                label: '🏍️ Bikes (Feb)',
                                data: cityDataArray.map(c => c.janBikes),
                                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                                borderColor: '#10b981',
                                borderWidth: 1,
                                stack: 'jan',
                                order: 2
                            },
                            {
                                label: '📈 Jan Total',
                                data: decTotals,
                                type: 'line',
                                borderColor: '#1f2937',
                                backgroundColor: '#1f2937',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: '#1f2937',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 1,
                                fill: false,
                                tension: 0.3,
                                order: 1
                            },
                            {
                                label: '📈 Feb Total',
                                data: janTotals,
                                type: 'line',
                                borderColor: '#6b7280',
                                backgroundColor: '#6b7280',
                                borderWidth: 2,
                                borderDash: [4, 4],
                                pointRadius: 4,
                                pointBackgroundColor: '#6b7280',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 1,
                                fill: false,
                                tension: 0.3,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 35 } },
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top', 
                                labels: { font: { size: 8 }, boxWidth: 10, padding: 6 } 
                            },
                            tooltip: { 
                                backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                padding: 12,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: (items) => sortedCities[items[0].dataIndex],
                                    afterTitle: (items) => {
                                        const idx = items[0].dataIndex;
                                        const city = cityDataArray[idx];
                                        return `Jan Total: ${(city.decCars + city.decBikes).toLocaleString()} | Feb Total: ${(city.janCars + city.janBikes).toLocaleString()}`;
                                    },
                                    label: (context) => {
                                        const label = context.dataset.label || '';
                                        return `${label}: ${context.raw.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: (context) => context.datasetIndex <= 3,
                                anchor: 'center',
                                align: 'center',
                                font: { size: 6, weight: 'bold' },
                                color: '#111827',
                                textStrokeColor: 'rgba(255,255,255,0.8)',
                                textStrokeWidth: 2,
                                formatter: (value, context) => {
                                    const idx = context.dataIndex;
                                    const city = cityDataArray[idx];
                                    const total = context.datasetIndex < 2 ? 
                                        (city.decCars + city.decBikes) : (city.janCars + city.janBikes);
                                    const pct = total ? ((value / total) * 100).toFixed(0) : '0';
                                    return (value >= 1000 ? (value/1000).toFixed(1) + 'k' : value) + '\n(' + pct + '%)';
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { font: { size: 8 }, maxRotation: 45, minRotation: 0 }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grace: '15%',
                                ticks: { 
                                    callback: (value) => value >= 1000 ? (value/1000) + 'k' : value,
                                    font: { size: 9 }
                                },
                                title: { display: true, text: 'Target Riders', font: { weight: 'bold', size: 9 } }
                            }
                        }
                    },
                    plugins: [{
                        id: 'trendLabels',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            const meta4 = chart.getDatasetMeta(4);
                            const meta5 = chart.getDatasetMeta(5);
                            
                            ctx.save();
                            ctx.font = 'bold 8px Arial';
                            ctx.textAlign = 'center';
                            
                            // Only draw Jan trend labels if dataset is visible
                            if (!meta4.hidden) {
                                meta4.data.forEach((point, i) => {
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText(decTotals[i] >= 1000 ? (decTotals[i]/1000).toFixed(1) + 'k' : decTotals[i], point.x - 8, point.y - 6);
                                });
                            }
                            
                            // Only draw Feb trend labels if dataset is visible
                            if (!meta5.hidden) {
                                meta5.data.forEach((point, i) => {
                                    ctx.fillStyle = '#6b7280';
                                    ctx.fillText(janTotals[i] >= 1000 ? (janTotals[i]/1000).toFixed(1) + 'k' : janTotals[i], point.x + 8, point.y - 6);
                                });
                            }
                            
                            ctx.restore();
                        }
                    }]
                });
                
                if (canvasId === 'vehicleT1Chart') vehicleT1ChartInstance = chart;
                if (canvasId === 'vehicleT2Chart') vehicleT2ChartInstance = chart;
            }
            
            function renderVehicleDonut(canvasId, cars, bikes) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (canvasId === 'vehicleDonutDec' && vehicleDonutDecChart) {
                    try { vehicleDonutDecChart.destroy(); } catch(e) {}
                }
                if (canvasId === 'vehicleDonutJan' && vehicleDonutJanChart) {
                    try { vehicleDonutJanChart.destroy(); } catch(e) {}
                }
                
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cars', 'Bikes'],
                        datasets: [{
                            data: [cars, bikes],
                            backgroundColor: ['#3b82f6', '#10b981'],
                            borderColor: ['#2563eb', '#059669'],
                            borderWidth: 2,
                            hoverOffset: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const pct = total ? ((context.raw / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${context.raw.toLocaleString()} (${pct}%)`;
                                    }
                                }
                            },
                            datalabels: { display: false }
                        }
                    }
                });
                
                if (canvasId === 'vehicleDonutDec') vehicleDonutDecChart = chart;
                if (canvasId === 'vehicleDonutJan') vehicleDonutJanChart = chart;
            }
            
            function renderVehicleTierCitiesChart(tier, tierLabel) {
                const cities = tier === 't1' ? vehicleT1Cities : vehicleT2Cities;
                const tierData = getVehicleTierData(tier);
                
                // Show single chart, hide dual
                document.getElementById('vehicleTypeChart').parentElement.style.display = 'block';
                document.getElementById('vehicleT1vsT2Container').style.display = 'none';
                
                // Update KPIs with tier totals
                const decTotal = tierData.dec.cars + tierData.dec.bikes;
                const janTotal = tierData.jan.cars + tierData.jan.bikes;
                const decCarsPct = decTotal ? ((tierData.dec.cars / decTotal) * 100).toFixed(1) : 0;
                const decBikesPct = decTotal ? ((tierData.dec.bikes / decTotal) * 100).toFixed(1) : 0;
                const janCarsPct = janTotal ? ((tierData.jan.cars / janTotal) * 100).toFixed(1) : 0;
                const janBikesPct = janTotal ? ((tierData.jan.bikes / janTotal) * 100).toFixed(1) : 0;
                
                document.getElementById('vehicleDonutDecTotal').textContent = decTotal.toLocaleString();
                document.getElementById('vehicleDecCars').textContent = tierData.dec.cars.toLocaleString();
                document.getElementById('vehicleDecBikes').textContent = tierData.dec.bikes.toLocaleString();
                document.getElementById('vehicleDecCarsPct').textContent = decCarsPct + '%';
                document.getElementById('vehicleDecBikesPct').textContent = decBikesPct + '%';
                
                document.getElementById('vehicleDonutJanTotal').textContent = janTotal.toLocaleString();
                document.getElementById('vehicleJanCars').textContent = tierData.jan.cars.toLocaleString();
                document.getElementById('vehicleJanBikes').textContent = tierData.jan.bikes.toLocaleString();
                document.getElementById('vehicleJanCarsPct').textContent = janCarsPct + '%';
                document.getElementById('vehicleJanBikesPct').textContent = janBikesPct + '%';
                
                // Update change values
                const totalChange = janTotal - decTotal;
                const carsChange = tierData.jan.cars - tierData.dec.cars;
                const bikesChange = tierData.jan.bikes - tierData.dec.bikes;
                const totalChangePct = decTotal ? ((totalChange / decTotal) * 100).toFixed(1) : 0;
                const carsChangePct = tierData.dec.cars ? ((carsChange / tierData.dec.cars) * 100).toFixed(1) : 0;
                const bikesChangePct = tierData.dec.bikes ? ((bikesChange / tierData.dec.bikes) * 100).toFixed(1) : 0;
                
                document.getElementById('vehicleTotalChange').textContent = (totalChange >= 0 ? '+' : '') + totalChange.toLocaleString();
                document.getElementById('vehicleTotalChange').style.color = totalChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleTotalChangePct').textContent = (totalChange >= 0 ? '+' : '') + totalChangePct + '%';
                document.getElementById('vehicleCarsChange').textContent = (carsChange >= 0 ? '+' : '') + carsChange.toLocaleString();
                document.getElementById('vehicleCarsChange').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleCarsChangePct').textContent = (carsChange >= 0 ? '+' : '') + carsChangePct + '%';
                document.getElementById('vehicleCarsChangePct').style.color = carsChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChange').textContent = (bikesChange >= 0 ? '+' : '') + bikesChange.toLocaleString();
                document.getElementById('vehicleBikesChange').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                document.getElementById('vehicleBikesChangePct').textContent = (bikesChange >= 0 ? '+' : '') + bikesChangePct + '%';
                document.getElementById('vehicleBikesChangePct').style.color = bikesChange >= 0 ? '#10b981' : '#dc2626';
                
                // Render Donut charts
                renderVehicleDonut('vehicleDonutDec', tierData.dec.cars, tierData.dec.bikes);
                renderVehicleDonut('vehicleDonutJan', tierData.jan.cars, tierData.jan.bikes);
                
                // Build city-level data with sorting (highest to lowest)
                const cityDataArray = cities.map(city => {
                    const d = vehicleCityData[city];
                    return { 
                        city, 
                        decCars: d ? d.dec.cars : 0,
                        decBikes: d ? d.dec.bikes : 0,
                        janCars: d ? d.jan.cars : 0,
                        janBikes: d ? d.jan.bikes : 0,
                        avgTotal: d ? ((d.dec.cars + d.dec.bikes + d.jan.cars + d.jan.bikes) / 2) : 0
                    };
                });
                
                // Sort by average total (highest to lowest)
                cityDataArray.sort((a, b) => b.avgTotal - a.avgTotal);
                
                const sortedCities = cityDataArray.map(c => c.city);
                const cityLabels = sortedCities.map(city => city.length > 10 ? city.substring(0, 8) + '..' : city);
                
                // Destroy existing chart
                if (vehicleTypeChartInstance) {
                    try { vehicleTypeChartInstance.destroy(); } catch(e) {}
                    vehicleTypeChartInstance = null;
                }
                
                const canvas = document.getElementById('vehicleTypeChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                if (vehicleViewMode === 'comparison') {
                    // Stacked bar chart showing Cars and Bikes for each city with trend line
                    document.getElementById('vehicleChartTitle').textContent = `City & Vehicle Breakdown - ${tierLabel}`;
                    
                    // Calculate totals for trend line
                    const decTotals = cityDataArray.map(c => c.decCars + c.decBikes);
                    const janTotals = cityDataArray.map(c => c.janCars + c.janBikes);
                    
                    vehicleTypeChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: cityLabels,
                            datasets: [
                                {
                                    label: '🚗 Cars (Jan)',
                                    data: cityDataArray.map(c => c.decCars),
                                    backgroundColor: 'rgba(59, 130, 246, 0.9)',
                                    borderColor: '#2563eb',
                                    borderWidth: 1,
                                    stack: 'dec',
                                    order: 2
                                },
                                {
                                    label: '🏍️ Bikes (Jan)',
                                    data: cityDataArray.map(c => c.decBikes),
                                    backgroundColor: 'rgba(16, 185, 129, 0.9)',
                                    borderColor: '#059669',
                                    borderWidth: 1,
                                    stack: 'dec',
                                    order: 2
                                },
                                {
                                    label: '🚗 Cars (Feb)',
                                    data: cityDataArray.map(c => c.janCars),
                                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                    borderColor: '#3b82f6',
                                    borderWidth: 1,
                                    stack: 'jan',
                                    order: 2
                                },
                                {
                                    label: '🏍️ Bikes (Feb)',
                                    data: cityDataArray.map(c => c.janBikes),
                                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                                    borderColor: '#10b981',
                                    borderWidth: 1,
                                    stack: 'jan',
                                    order: 2
                                },
                                {
                                    label: '📈 Jan Trend',
                                    data: decTotals,
                                    type: 'line',
                                    borderColor: '#1f2937',
                                    backgroundColor: '#1f2937',
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#1f2937',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    fill: false,
                                    tension: 0.3,
                                    order: 1
                                },
                                {
                                    label: '📈 Feb Trend',
                                    data: janTotals,
                                    type: 'line',
                                    borderColor: '#6b7280',
                                    backgroundColor: '#6b7280',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointRadius: 5,
                                    pointBackgroundColor: '#6b7280',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    fill: false,
                                    tension: 0.3,
                                    order: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: { padding: { top: 40 } },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    position: 'top',
                                    labels: { font: { size: 9 }, boxWidth: 12, padding: 8 }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                    padding: 12,
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        title: (items) => sortedCities[items[0].dataIndex],
                                        afterTitle: (items) => {
                                            const idx = items[0].dataIndex;
                                            const city = cityDataArray[idx];
                                            return `Jan Total: ${(city.decCars + city.decBikes).toLocaleString()} | Feb Total: ${(city.janCars + city.janBikes).toLocaleString()}`;
                                        },
                                        label: (context) => {
                                            const label = context.dataset.label || '';
                                            return `${label}: ${context.raw.toLocaleString()}`;
                                        }
                                    }
                                },
                                datalabels: {
                                    display: (context) => context.datasetIndex <= 3,
                                    anchor: 'center',
                                    align: 'center',
                                    font: { size: 7, weight: 'bold' },
                                    color: '#111827',
                                    textStrokeColor: 'rgba(255,255,255,0.8)',
                                    textStrokeWidth: 2,
                                    formatter: (value, context) => {
                                        const idx = context.dataIndex;
                                        const city = cityDataArray[idx];
                                        const total = context.datasetIndex < 2 ? 
                                            (city.decCars + city.decBikes) : (city.janCars + city.janBikes);
                                        const pct = total ? ((value / total) * 100).toFixed(0) : '0';
                                        return value.toLocaleString() + '\n(' + pct + '%)';
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                    ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 0 }
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    grace: '15%',
                                    ticks: { callback: (value) => value.toLocaleString() },
                                    title: { display: true, text: 'Target Riders', font: { weight: 'bold' } }
                                }
                            }
                        },
                        plugins: [{
                            id: 'trendLabels',
                            afterDatasetsDraw: function(chart) {
                                const ctx = chart.ctx;
                                const meta4 = chart.getDatasetMeta(4); // Jan trend
                                const meta5 = chart.getDatasetMeta(5); // Feb trend
                                
                                ctx.save();
                                ctx.font = 'bold 9px Arial';
                                ctx.textAlign = 'center';
                                
                                // Draw Jan trend labels only if dataset is visible
                                if (!meta4.hidden) {
                                    meta4.data.forEach((point, i) => {
                                        const total = decTotals[i];
                                        ctx.fillStyle = '#1f2937';
                                        ctx.fillText(total.toLocaleString(), point.x, point.y - 8);
                                    });
                                }
                                
                                // Draw Feb trend labels only if dataset is visible
                                if (!meta5.hidden) {
                                    meta5.data.forEach((point, i) => {
                                        const total = janTotals[i];
                                        ctx.fillStyle = '#6b7280';
                                        ctx.fillText(total.toLocaleString(), point.x + 15, point.y - 8);
                                    });
                                }
                                
                                ctx.restore();
                            }
                        }]
                    });
                } else {
                    // Trend line chart showing total Cars and Bikes for the tier
                    document.getElementById('vehicleChartTitle').textContent = `Vehicle Type Trends - ${tierLabel}`;
                    
                    // Calculate tier totals
                    const totalDecCars = cityDataArray.reduce((sum, c) => sum + c.decCars, 0);
                    const totalDecBikes = cityDataArray.reduce((sum, c) => sum + c.decBikes, 0);
                    const totalJanCars = cityDataArray.reduce((sum, c) => sum + c.janCars, 0);
                    const totalJanBikes = cityDataArray.reduce((sum, c) => sum + c.janBikes, 0);
                    
                    // Intermediate points for curved lines
                    const carsMid1 = Math.round(totalDecCars * 0.85 + totalJanCars * 0.15);
                    const carsMid2 = Math.round(totalDecCars * 0.5 + totalJanCars * 0.5);
                    const carsMid3 = Math.round(totalDecCars * 0.15 + totalJanCars * 0.85);
                    const bikesMid1 = Math.round(totalDecBikes * 0.85 + totalJanBikes * 0.15);
                    const bikesMid2 = Math.round(totalDecBikes * 0.5 + totalJanBikes * 0.5);
                    const bikesMid3 = Math.round(totalDecBikes * 0.15 + totalJanBikes * 0.85);
                    
                    const gradientCars = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientCars.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                    gradientCars.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
                    
                    const gradientBikes = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientBikes.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                    gradientBikes.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
                    
                    vehicleTypeChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan 2026', '', 'Mid', '', 'Feb 2026'],
                            datasets: [{
                                label: '🚗 Cars',
                                data: [totalDecCars, carsMid1, carsMid2, carsMid3, totalJanCars],
                                borderColor: '#3b82f6',
                                backgroundColor: gradientCars,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: ['#2563eb', 'transparent', 'transparent', 'transparent', '#2563eb'],
                                pointBorderColor: ['#fff', 'transparent', 'transparent', 'transparent', '#fff'],
                                pointBorderWidth: [2, 0, 0, 0, 2],
                                pointRadius: [8, 0, 0, 0, 8],
                                pointHoverRadius: [12, 0, 0, 0, 12]
                            }, {
                                label: '🏍️ Bikes',
                                data: [totalDecBikes, bikesMid1, bikesMid2, bikesMid3, totalJanBikes],
                                borderColor: '#10b981',
                                backgroundColor: gradientBikes,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: ['#059669', 'transparent', 'transparent', 'transparent', '#059669'],
                                pointBorderColor: ['#fff', 'transparent', 'transparent', 'transparent', '#fff'],
                                pointBorderWidth: [2, 0, 0, 0, 2],
                                pointRadius: [8, 0, 0, 0, 8],
                                pointHoverRadius: [12, 0, 0, 0, 12]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: { padding: { top: 40, right: 20 } },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    position: 'top',
                                    labels: { font: { size: 12, weight: 'bold' }, boxWidth: 16, padding: 15 }
                                },
                                tooltip: { 
                                    backgroundColor: 'rgba(31, 41, 55, 0.95)', 
                                    padding: 12,
                                    filter: (item) => item.dataIndex === 0 || item.dataIndex === 4
                                },
                                datalabels: {
                                    display: (context) => context.dataIndex === 0 || context.dataIndex === 4,
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 6,
                                    font: { size: 11, weight: 'bold' },
                                    color: (context) => context.dataset.borderColor,
                                    formatter: (value, context) => {
                                        const ds = context.dataset.data;
                                        const total = ds[0] + ds[4];
                                        const pct = total ? ((value / (ds[0] + context.chart.data.datasets[1].data[context.dataIndex === 0 ? 0 : 4])) * 100).toFixed(1) : '0';
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grace: '15%',
                                    ticks: { callback: (value) => value.toLocaleString() },
                                    title: { display: true, text: 'Target Riders', font: { weight: 'bold' } }
                                }
                            }
                        }
                    });
                }
            }
            
            function renderVehicleTypeChart(data, cityLabel) {
                const canvas = document.getElementById('vehicleTypeChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                if (vehicleTypeChartInstance) {
                    try { vehicleTypeChartInstance.destroy(); } catch(e) {}
                }
                
                if (!data) {
                    data = vehicleCityData[vehicleSelectedCity] || vehicleCityData.all;
                }
                if (!cityLabel) {
                    cityLabel = vehicleSelectedCity === 'all' ? 'All Cities' : vehicleSelectedCity;
                }
                
                const decTotal = data.dec.cars + data.dec.bikes;
                const janTotal = data.jan.cars + data.jan.bikes;
                
                if (vehicleViewMode === 'comparison') {
                    // Bar chart comparing Dec vs Jan for Cars and Bikes
                    document.getElementById('vehicleChartTitle').textContent = `Vehicle Type Target Comparison - ${cityLabel}`;
                    
                    vehicleTypeChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['🚗 Cars', '🏍️ Bikes', '📊 Total'],
                            datasets: [{
                                label: 'Jan 2026',
                                data: [data.dec.cars, data.dec.bikes, decTotal],
                                backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                                borderColor: ['#3b82f6', '#10b981', '#8b5cf6'],
                                borderWidth: 2
                            }, {
                                label: 'Feb 2026',
                                data: [data.jan.cars, data.jan.bikes, janTotal],
                                backgroundColor: ['rgba(59, 130, 246, 0.5)', 'rgba(16, 185, 129, 0.5)', 'rgba(139, 92, 246, 0.5)'],
                                borderColor: ['#3b82f6', '#10b981', '#8b5cf6'],
                                borderWidth: 2,
                                borderDash: [5, 5]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: { padding: { top: 35 } },
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                    padding: 12
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 4,
                                    font: { size: 10, weight: 'bold' },
                                    color: '#1f2937',
                                    formatter: (value, context) => {
                                        const ds = context.dataset;
                                        const total = ds.data[2];
                                        const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return value.toLocaleString() + ' (' + pct + '%)';
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grace: '10%',
                                    ticks: { callback: (value) => value.toLocaleString() },
                                    title: { display: true, text: 'Target Riders', font: { weight: 'bold' } }
                                }
                            }
                        }
                    });
                } else {
                    // Trend line chart
                    document.getElementById('vehicleChartTitle').textContent = `Vehicle Type Target Trend - ${cityLabel}`;
                    
                    const gradientCars = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientCars.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                    gradientCars.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
                    
                    const gradientBikes = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradientBikes.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                    gradientBikes.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
                    
                    // Create intermediate points for curved line effect
                    const carsMid1 = Math.round(data.dec.cars * 0.85 + data.jan.cars * 0.15);
                    const carsMid2 = Math.round(data.dec.cars * 0.5 + data.jan.cars * 0.5);
                    const carsMid3 = Math.round(data.dec.cars * 0.15 + data.jan.cars * 0.85);
                    const bikesMid1 = Math.round(data.dec.bikes * 0.85 + data.jan.bikes * 0.15);
                    const bikesMid2 = Math.round(data.dec.bikes * 0.5 + data.jan.bikes * 0.5);
                    const bikesMid3 = Math.round(data.dec.bikes * 0.15 + data.jan.bikes * 0.85);
                    
                    vehicleTypeChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan 2026', '', 'Mid', '', 'Feb 2026'],
                            datasets: [{
                                label: '🚗 Cars',
                                data: [data.dec.cars, carsMid1, carsMid2, carsMid3, data.jan.cars],
                                borderColor: '#3b82f6',
                                backgroundColor: gradientCars,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: ['#2563eb', 'transparent', 'transparent', 'transparent', '#2563eb'],
                                pointBorderColor: ['#fff', 'transparent', 'transparent', 'transparent', '#fff'],
                                pointBorderWidth: [2, 0, 0, 0, 2],
                                pointRadius: [8, 0, 0, 0, 8],
                                pointHoverRadius: [12, 0, 0, 0, 12]
                            }, {
                                label: '🏍️ Bikes',
                                data: [data.dec.bikes, bikesMid1, bikesMid2, bikesMid3, data.jan.bikes],
                                borderColor: '#10b981',
                                backgroundColor: gradientBikes,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: ['#059669', 'transparent', 'transparent', 'transparent', '#059669'],
                                pointBorderColor: ['#fff', 'transparent', 'transparent', 'transparent', '#fff'],
                                pointBorderWidth: [2, 0, 0, 0, 2],
                                pointRadius: [8, 0, 0, 0, 8],
                                pointHoverRadius: [12, 0, 0, 0, 12]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: { padding: { top: 50 } },
                            interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    position: 'top',
                                    labels: { usePointStyle: true, padding: 25 }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                    padding: 14,
                                    borderWidth: 1,
                                    filter: function(tooltipItem) {
                                        return tooltipItem.dataIndex === 0 || tooltipItem.dataIndex === 4;
                                    }
                                },
                                datalabels: {
                                    display: function(context) {
                                        return context.dataIndex === 0 || context.dataIndex === 4;
                                    },
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 8,
                                    font: { size: 11, weight: 'bold' },
                                    color: '#1f2937',
                                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                    borderRadius: 4,
                                    padding: { top: 4, bottom: 4, left: 8, right: 8 },
                                    formatter: (value, context) => {
                                        const ds = context.dataset;
                                        const total = ds.data[0] + ds.data[4];
                                        const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return value.toLocaleString() + ' (' + pct + '%)';
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grace: '15%',
                                    grid: { color: 'rgba(0, 0, 0, 0.06)' },
                                    ticks: { callback: (value) => value.toLocaleString() },
                                    title: { display: true, text: 'Target Riders', font: { weight: 'bold' } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { 
                                        font: { size: 13, weight: '600' },
                                        callback: function(value, index) {
                                            if (index === 0) return 'Jan 2026';
                                            if (index === 4) return 'Feb 2026';
                                            return '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // City Level filter handler
            document.querySelectorAll('.vehicle-city-level-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    vehicleCityLevel = this.getAttribute('data-level');
                    vehicleSelectedCity = 'all';
                    
                    // Reset city level button styles
                    document.querySelectorAll('.vehicle-city-level-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#10b981';
                    this.style.color = 'white';
                    this.style.borderColor = '#10b981';
                    
                    // Reset individual city button styles
                    document.querySelectorAll('.vehicle-city-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    
                    initVehicleTypeCharts();
                    psUpdateSummaryCards(true);
                });
            });
            
            // Individual City filter handler
            document.querySelectorAll('.vehicle-city-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    vehicleSelectedCity = this.getAttribute('data-city');
                    vehicleCityLevel = 'single';
                    
                    // Reset city level button styles
                    document.querySelectorAll('.vehicle-city-level-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    
                    // Reset individual city button styles and highlight current
                    document.querySelectorAll('.vehicle-city-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#3b82f6';
                    this.style.color = 'white';
                    this.style.borderColor = '#3b82f6';
                    
                    initVehicleTypeCharts();
                    psUpdateSummaryCards(true);
                });
            });
            
            // View toggle handler
            document.querySelectorAll('.vehicle-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    vehicleViewMode = this.getAttribute('data-view');
                    document.querySelectorAll('.vehicle-view-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    this.style.background = '#10b981';
                    this.style.color = 'white';
                    this.style.borderColor = '#10b981';
                    initVehicleTypeCharts();
                    psUpdateSummaryCards(true);
                });
            });

            // Performance Chart - REMOVED (chart element deleted)
            // const perfJan = [12349, 8330, 1534, 240];
            // const perfFeb = [10192, 8414, 370, 389];
            // const perfMomPlugin = createBarMomLabelPlugin(perfJan, perfFeb, 9);
            // new Chart(document.getElementById('performanceChart').getContext('2d'), {...});

            // Manual vs Automated Target Adjustment (Good/Average/Bad)
            const manualLabels = ['Good', 'Average', 'Bad', 'Total'];
            const janRule = [10664, 8434, 144, 19242];
            const afterManual = [10192, 8414, 370, 18976];
            const manualDelta = [-472, -20, 226, -266];
            const manualIncDec = [-4, 0, 157, -1];
            const manualVariance = afterManual.map((v, i) => v - janRule[i]);
            const isCompactOverview = window.innerWidth <= 1200;
            const isMobileOverview = window.innerWidth <= 768;
            const ovTickFont = isMobileOverview ? 9 : (isCompactOverview ? 10 : 11);
            const ovLabelFont = isMobileOverview ? 9 : (isCompactOverview ? 10 : 11);
            const ovLegendFont = isMobileOverview ? 10 : 12;
            const ovTooltipFont = isMobileOverview ? 11 : 12;

            const changeLabels = ['Partners with Increases', 'Partners with Same Target', 'Partners with Decreases'];
            const changeCounts = [153, 114, 284];
            const totalPartnersWithTarget = 551;
            const increasePct = ((changeCounts[0] / totalPartnersWithTarget) * 100).toFixed(1);
            const samePct = ((changeCounts[1] / totalPartnersWithTarget) * 100).toFixed(1);
            const decreasePct = ((changeCounts[2] / totalPartnersWithTarget) * 100).toFixed(1);

            document.getElementById('overviewInsightNet').textContent = `${manualDelta[3] > 0 ? '+' : ''}${manualDelta[3].toLocaleString()} riders`;
            document.getElementById('overviewInsightNetSub').textContent = `${manualIncDec[3] > 0 ? '+' : ''}${manualIncDec[3]}% vs rule target total`;
            document.getElementById('overviewInsightInc').textContent = `${changeCounts[0].toLocaleString()} (${increasePct}%)`;
            document.getElementById('overviewInsightIncSub').textContent = `of ${totalPartnersWithTarget.toLocaleString()} partners with target`;
            document.getElementById('overviewInsightDec').textContent = `${changeCounts[2].toLocaleString()} (${decreasePct}%)`;
            document.getElementById('overviewInsightDecSub').textContent = `${changeCounts[2] - changeCounts[0] >= 0 ? '+' : ''}${changeCounts[2] - changeCounts[0]} more than increases`;
            document.getElementById('overviewInsightShift').textContent = `Bad: +${manualDelta[2].toLocaleString()}`;
            document.getElementById('overviewInsightShiftSub').textContent = `${manualIncDec[2] > 0 ? '+' : ''}${manualIncDec[2]}% while Good fell ${Math.abs(manualIncDec[0])}%`;

            // Changes Chart (enhanced)
            new Chart(document.getElementById('changesChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: changeLabels,
                    datasets: [{
                        label: 'Active Partner Count',
                        data: changeCounts,
                        backgroundColor: ['#10b981', '#60a5fa', '#ef4444'],
                        borderColor: ['#059669', '#3b82f6', '#dc2626'],
                        borderWidth: 1.2,
                        borderRadius: 6,
                        barPercentage: 0.72,
                        categoryPercentage: 0.76
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: { top: isMobileOverview ? 14 : 26 }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                font: { size: isMobileOverview ? 9 : (ovLegendFont - 1) },
                                boxWidth: isMobileOverview ? 12 : 16,
                                padding: isMobileOverview ? 8 : 10
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            titleFont: { size: ovTooltipFont, weight: 'bold' },
                            bodyFont: { size: ovTooltipFont },
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed.y;
                                    const pct = totalPartnersWithTarget ? ((value / totalPartnersWithTarget) * 100).toFixed(1) : '0.0';
                                    return `${context.label}: ${value.toLocaleString()} partners (${pct}%)`;
                                },
                                afterBody: () => [`Total partners with target: ${totalPartnersWithTarget.toLocaleString()}`, `Net skew to decreases: +${(changeCounts[2] - changeCounts[0]).toLocaleString()}`]
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 2,
                            color: '#1f2937',
                            font: { size: ovLabelFont, weight: '700' },
                            formatter: (value) => {
                                const pct = totalPartnersWithTarget ? ((value / totalPartnersWithTarget) * 100).toFixed(1) : '0.0';
                                return `${value.toLocaleString()}\n(${pct}%)`;
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value.toLocaleString(), font: { size: ovTickFont } },
                            title: { display: true, text: 'Partner Count', font: { size: isMobileOverview ? 10 : 12, weight: 'bold' } },
                            grid: { color: 'rgba(107,114,128,0.16)' }
                        },
                        x: {
                            ticks: { font: { size: ovTickFont, weight: '600' } },
                            grid: { display: false }
                        }
                    }
                }
            });

            new Chart(document.getElementById('manualAdjustChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: manualLabels,
                    datasets: [{
                        label: 'Feb target (our rule)',
                        data: janRule,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1.5
                    }, {
                        label: 'Feb target (after manual adjustment)',
                        data: afterManual,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1.5
                    }, {
                        type: 'line',
                        label: 'Manual variance (After - Rule)',
                        data: manualVariance,
                        yAxisID: 'y1',
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.25,
                        pointRadius: 4,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: { top: isMobileOverview ? 14 : 26 }
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                font: { size: isMobileOverview ? 9 : (ovLegendFont - 1) },
                                boxWidth: isMobileOverview ? 12 : 16,
                                padding: isMobileOverview ? 8 : 10
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            titleFont: { size: ovTooltipFont, weight: 'bold' },
                            bodyFont: { size: ovTooltipFont },
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    if (context.datasetIndex === 0) {
                                        return `Feb target (our rule): ${janRule[idx].toLocaleString()}`;
                                    }
                                    if (context.datasetIndex === 1) {
                                        const inc = manualIncDec[idx];
                                        const signInc = inc > 0 ? '+' : '';
                                        return `After manual: ${afterManual[idx].toLocaleString()} (${signInc}${inc}%)`;
                                    }
                                    if (context.datasetIndex === 2) {
                                        const sign = manualVariance[idx] > 0 ? '+' : '';
                                        return `Manual variance line: ${sign}${manualVariance[idx].toLocaleString()} riders`;
                                    }
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: function(context) {
                                return context.datasetIndex === 2 ? 'top' : 'end';
                            },
                            offset: 4,
                            color: function(context) {
                                if (context.datasetIndex === 2) {
                                    const delta = manualVariance[context.dataIndex];
                                    return delta > 0 ? '#16a34a' : (delta < 0 ? '#dc2626' : '#6b7280');
                                }
                                if (context.datasetIndex === 1) {
                                    const inc = manualIncDec[context.dataIndex];
                                    if (inc > 0) return '#16a34a';
                                    if (inc < 0) return '#dc2626';
                                    return '#6b7280';
                                }
                                return '#111827';
                            },
                            font: function(context) {
                                if (context.datasetIndex === 2) {
                                    return { size: ovLabelFont - 1, weight: 'bold' };
                                }
                                return { size: ovLabelFont, weight: 'bold' };
                            },
                            formatter: function(value, context) {
                                if (context.datasetIndex === 2) {
                                    const sign = value > 0 ? '+' : '';
                                    return `${sign}${value.toLocaleString()}`;
                                }
                                if (context.datasetIndex === 1) {
                                    const inc = manualIncDec[context.dataIndex];
                                    const signInc = inc > 0 ? '+' : '';
                                    return `${value.toLocaleString()}\n(${signInc}${inc}%)`;
                                }
                                return value.toLocaleString();
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => value.toLocaleString(),
                                font: { size: ovTickFont }
                            },
                            title: {
                                display: true,
                                text: 'Riders',
                                font: { size: isMobileOverview ? 10 : 12, weight: 'bold' }
                            }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false },
                            ticks: {
                                callback: (value) => value.toLocaleString(),
                                font: { size: ovTickFont - 1 },
                                color: '#92400e'
                            },
                            title: {
                                display: true,
                                text: 'Variance Riders',
                                font: { size: isMobileOverview ? 9 : 11, weight: 'bold' },
                                color: '#92400e'
                            }
                        },
                        x: {
                            ticks: { font: { size: ovTickFont, weight: 'bold' } }
                        }
                    }
                }
            });

            // ========================================
            // FR & DRIVER CARD RANGE IMPACT CHARTS
            // ========================================
            
            // Helper function to get color based on percentage value
            // High % = Green (significant), Low % = Red (minimal)
            function getPctColor(pct) {
                const pctNum = parseFloat(pct);
                if (pctNum >= 35) return '#16a34a'; // Green for high %
                if (pctNum >= 25) return '#65a30d'; // Lime-green
                if (pctNum >= 15) return '#ca8a04'; // Yellow/Amber
                if (pctNum >= 5) return '#ea580c';  // Orange
                return '#dc2626'; // Red for low %
            }

            const impactPartnerTotalsByMetric = {
                fr: { all: 643, withtarget: 551, new: 158, old: 485 },
                dc: { all: 643, withtarget: 551, new: 158, old: 485 }
            };

            const impactTargetData = {
                fr: {
                    all: { dec: [418, 181, 434, 1231, 1632, 8466, 10091], jan: [369, 0, 19, 0, 11, 628, 18338] },
                    withtarget: { dec: [418, 181, 434, 1231, 1632, 8466, 10091], jan: [369, 0, 19, 0, 11, 628, 18338] },
                    new: { dec: [305, 91, 195, 227, 642, 1596, 1898], jan: [359, 0, 19, 0, 0, 115, 2469] },
                    old: { dec: [113, 90, 239, 1004, 990, 6870, 8193], jan: [10, 0, 0, 0, 11, 513, 15869] }
                },
                dc: {
                    all: { dec: [13126, 1800, 988, 759, 838, 1127, 3815], jan: [8347, 1567, 1318, 800, 978, 1402, 4953] },
                    withtarget: { dec: [13126, 1800, 988, 759, 838, 1127, 3815], jan: [8347, 1567, 1318, 800, 978, 1402, 4953] },
                    new: { dec: [3073, 475, 207, 136, 43, 238, 782], jan: [1360, 249, 70, 78, 129, 201, 875] },
                    old: { dec: [10053, 1325, 781, 623, 795, 889, 3033], jan: [6987, 1318, 1248, 722, 849, 1201, 4078] }
                }
            };

            function sumArray(values = []) {
                return values.reduce((sum, v) => sum + v, 0);
            }

            function getImpactTargetTotals(metric, filter) {
                const data = impactTargetData[metric] || impactTargetData.fr;
                if (filter === 'both') {
                    const newData = data.new || {};
                    const oldData = data.old || {};
                    const dec = (newData.dec && oldData.dec)
                        ? newData.dec.map((v, i) => v + (oldData.dec[i] || 0))
                        : null;
                    const jan = (newData.jan || oldData.jan)
                        ? (newData.jan || []).map((v, i) => v + ((oldData.jan || [])[i] || 0))
                        : null;
                    return { dec, jan };
                }
                return data[filter] || data.all;
            }

            function updateImpactFilterLabels(metric) {
                const totalsByMetric = impactPartnerTotalsByMetric[metric] || impactPartnerTotalsByMetric.fr;
                const allBtn = document.querySelector('.impact-filter-btn[data-filter="all"]');
                const withTargetBtn = document.querySelector('.impact-filter-btn[data-filter="withtarget"]');
                const newBtn = document.querySelector('.impact-filter-btn[data-filter="new"]');
                const oldBtn = document.querySelector('.impact-filter-btn[data-filter="old"]');

                if (allBtn) allBtn.innerHTML = `📊 All Partners (${totalsByMetric.all.toLocaleString()})`;
                if (withTargetBtn) withTargetBtn.innerHTML = `✅ With Target (${totalsByMetric.withtarget.toLocaleString()})`;
                if (newBtn) newBtn.innerHTML = `🆕 New Partners (${totalsByMetric.new.toLocaleString()})`;
                if (oldBtn) oldBtn.innerHTML = `👥 Old Partners (${totalsByMetric.old.toLocaleString()})`;
            }

            function updateImpactKpiCards(metric, filter) {
                updateImpactFilterLabels(metric);
                const totalsByMetric = impactPartnerTotalsByMetric[metric] || impactPartnerTotalsByMetric.fr;
                const totalAll = totalsByMetric.all;
                const newCount = totalsByMetric.new;
                const oldCount = totalsByMetric.old;
                const filterCount = filter === 'both'
                    ? (newCount + oldCount)
                    : (totalsByMetric[filter] ?? totalAll);
                const filterPct = totalAll ? (filterCount / totalAll) * 100 : 0;

                const partnersValueEl = document.getElementById('impactPartnersValue');
                const partnersSubEl = document.getElementById('impactPartnersSub');
                const partnersSplitEl = document.getElementById('impactPartnersSplit');

                const newPct = totalAll ? (newCount / totalAll) * 100 : 0;
                const oldPct = totalAll ? (oldCount / totalAll) * 100 : 0;

                if (partnersValueEl && partnersSubEl && partnersSplitEl) {
                    if (filter === 'both') {
                        partnersValueEl.textContent = `${newCount.toLocaleString()} / ${oldCount.toLocaleString()}`;
                        partnersSubEl.textContent = 'New vs Old partners (count)';
                    } else {
                        partnersValueEl.textContent = `${filterCount.toLocaleString()} (${filterPct.toFixed(1)}%)`;
                        const label = filter === 'withtarget'
                            ? 'Partners with Target'
                            : (filter === 'new' ? 'New Partners' : (filter === 'old' ? 'Old Partners' : 'All Partners'));
                        partnersSubEl.textContent = `${label} of total ${totalAll.toLocaleString()}`;
                    }
                    partnersSplitEl.textContent = `New: ${newCount.toLocaleString()} (${newPct.toFixed(1)}%) • Old: ${oldCount.toLocaleString()} (${oldPct.toFixed(1)}%)`;
                }

                const targetsValueEl = document.getElementById('impactTargetsValue');
                const targetsSubEl = document.getElementById('impactTargetsSub');
                const targetsChangeEl = document.getElementById('impactTargetsChange');

                const totals = getImpactTargetTotals(metric, filter);
                const decTotal = totals.dec ? sumArray(totals.dec) : null;
                const janTotal = totals.jan ? sumArray(totals.jan) : null;

                if (targetsValueEl && targetsSubEl && targetsChangeEl) {
                    if (decTotal === null || janTotal === null) {
                        const janText = janTotal !== null ? janTotal.toLocaleString() : '—';
                        targetsValueEl.textContent = `Feb Total: ${janText}`;
                        targetsSubEl.textContent = 'Jan Total: — (N/A for this view)';
                        targetsChangeEl.textContent = 'Net Change: —';
                    } else {
                        const delta = janTotal - decTotal;
                        const deltaPct = decTotal ? (delta / decTotal) * 100 : 0;
                        const sign = delta > 0 ? '+' : '';
                        const deltaColor = delta > 0 ? '#16a34a' : (delta < 0 ? '#dc2626' : '#6b7280');
                        targetsValueEl.textContent = `Jan ${decTotal.toLocaleString()} → Feb ${janTotal.toLocaleString()}`;
                        targetsSubEl.textContent = 'Total Target Riders (All Ranges)';
                        targetsChangeEl.innerHTML = `Net Change: <span style="color: ${deltaColor}; font-weight: 700;">${sign}${delta.toLocaleString()} (${sign}${deltaPct.toFixed(1)}%)</span>`;
                    }
                }
            }
            window.updateImpactKpiCards = updateImpactKpiCards;
            window.updateImpactFilterLabels = updateImpactFilterLabels;
            
            // FR Impact - New Partners Bar Chart (Dec vs Jan) - Single View
            // Impact Chart - Single View (New Partners)
            window.impactChartSingle = null; // Global reference for chart
            window.initImpactChartSingle = function(metric = 'fr', filter = 'new') {
                console.log('initImpactChartSingle called with:', metric, filter);
                const canvas = document.getElementById('impactChartSingleCanvas');
                if (!canvas) {
                    console.error('Canvas impactChartSingleCanvas not found');
                    return;
                }
                const ctx = canvas.getContext('2d');
                
                let data, color, title;
                if (metric === 'fr') {
                    if (filter === 'new') {
                        data = { dec: [305, 91, 195, 227, 642, 1596, 1898], jan: [359, 0, 19, 0, 0, 115, 2469] };
                        title = 'New Partners (<3 months) - FR Range Impact';
                    } else {
                        data = { dec: [113, 90, 239, 1004, 990, 6870, 8193], jan: [10, 0, 0, 0, 11, 513, 15869] };
                        title = 'Old Partners (≥3 months) - FR Range Impact';
                    }
                    color = '#3b82f6';
                } else {
                    if (filter === 'new') {
                        data = { dec: [3073, 475, 207, 136, 43, 238, 782], jan: [1360, 249, 70, 78, 129, 201, 875] };
                        title = 'New Partners (<3 months) - Driver Card Range Impact';
                    } else {
                        data = { dec: [10053, 1325, 781, 623, 795, 889, 3033], jan: [6987, 1318, 1248, 722, 849, 1201, 4078] };
                        title = 'Old Partners (≥3 months) - Driver Card Range Impact';
                    }
                    color = '#f97316';
                }
                
                // Destroy existing chart using global reference
                if (window.impactChartSingle) {
                    try { window.impactChartSingle.destroy(); } catch(e) {}
                }
                
                // Build datasets (include Dec when available)
                const hasDec = Array.isArray(data.dec);
                let datasets = [];
                if (hasDec) {
                    datasets.push({
                        label: 'Jan Target',
                        data: data.dec,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1.5
                    });
                }
                datasets.push({
                    label: 'Feb Target',
                    data: data.jan,
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1.5
                });
                
                console.log('Creating chart with data:', data);
                window.impactChartSingle = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.8,
                        layout: {
                            padding: { top: 30 }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 10,
                                callbacks: {
                                    label: function(context) {
                                        const dataset = context.chart.data.datasets[context.datasetIndex];
                                        const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                        const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                labels: {
                                    value: {
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 2,
                                        font: { size: 11, weight: 'bold' },
                                        color: '#111827',
                                        formatter: (value) => value.toLocaleString()
                                    },
                                    pct: {
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 16,
                                        font: { size: 10, weight: 'bold' },
                                        color: function(context) {
                                            const dataset = context.chart.data.datasets[context.datasetIndex];
                                            const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                            const pct = total ? ((context.dataset.data[context.dataIndex] / total) * 100).toFixed(1) : '0.0';
                                            return getPctColor(pct);
                                        },
                                        formatter: (value, context) => {
                                            const dataset = context.chart.data.datasets[context.datasetIndex];
                                            const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                            const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                            return '(' + pct + '%)';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => value.toLocaleString(), font: { size: 11 } },
                                title: { display: true, text: 'Target Riders', font: { size: 12, weight: 'bold' } }
                            },
                            x: {
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false,
                                    padding: 8
                                }
                            }
                        }
                    }
                });
                console.log('Chart created successfully');
            };

            // Impact Chart - Dual View (New vs Old)
            let impactChartNew = null, impactChartOld = null;
            window.initImpactChartDual = function(metric = 'fr') {
                console.log('initImpactChartDual called with:', metric);
                const canvasNew = document.getElementById('impactChartNewBar');
                const canvasOld = document.getElementById('impactChartOldBar');
                if (!canvasNew || !canvasOld) {
                    console.error('Canvas elements not found');
                    return;
                }
                const ctxNew = canvasNew.getContext('2d');
                const ctxOld = canvasOld.getContext('2d');
                
                let dataNew, dataOld, color;
                if (metric === 'fr') {
                    dataNew = { dec: [195, 218, 298, 253, 705, 1726, 1827], jan: [305, 91, 195, 227, 642, 1596, 1898] };
                    dataOld = { dec: [260, 198, 377, 1209, 1180, 7190, 8546], jan: [113, 90, 239, 1004, 990, 6870, 8193] };
                    color = '#3b82f6';
                } else {
                    dataNew = { dec: [3358, 497, 206, 122, 50, 229, 760], jan: [3073, 475, 207, 136, 43, 238, 782] };
                    dataOld = { dec: [0, 0, 0, 0, 0, 0, 18960], jan: [10053, 1325, 781, 623, 795, 889, 3033] };
                    color = '#f97316';
                }
                
                if (impactChartNew) {
                    try { impactChartNew.destroy(); } catch(e) {}
                }
                if (impactChartOld) {
                    try { impactChartOld.destroy(); } catch(e) {}
                }
                console.log('Creating dual charts with metric:', metric, 'dataNew:', dataNew, 'dataOld:', dataOld);
                
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.8,
                    layout: {
                        padding: { top: 30 }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct}%)`;
                                }
                            }
                        },
                        datalabels: {
                            labels: {
                                value: {
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 2,
                                    font: { size: 10, weight: 'bold' },
                                    color: '#111827',
                                    formatter: (value) => value.toLocaleString()
                                },
                                pct: {
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 14,
                                    font: { size: 9, weight: 'bold' },
                                    color: function(context) {
                                        const dataset = context.chart.data.datasets[context.datasetIndex];
                                        const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                        const pct = total ? ((context.dataset.data[context.dataIndex] / total) * 100).toFixed(1) : '0.0';
                                        return getPctColor(pct);
                                    },
                                    formatter: (value, context) => {
                                        const dataset = context.chart.data.datasets[context.datasetIndex];
                                        const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                        const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return '(' + pct + '%)';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => value.toLocaleString(), font: { size: 11 } },
                            title: { display: true, text: 'Target Riders', font: { size: 12, weight: 'bold' } }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: false,
                                padding: 8
                            }
                        }
                    }
                };
                
                // Build datasets (include Dec when available)
                const hasDecNew = Array.isArray(dataNew.dec);
                const hasDecOld = Array.isArray(dataOld.dec);
                let datasetsNew = [];
                let datasetsOld = [];

                if (hasDecNew) {
                    datasetsNew.push({
                        label: 'Jan Target',
                        data: dataNew.dec,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1.5
                    });
                }
                datasetsNew.push({
                    label: 'Feb Target',
                    data: dataNew.jan,
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1.5
                });

                if (hasDecOld) {
                    datasetsOld.push({
                        label: 'Jan Target',
                        data: dataOld.dec,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1.5
                    });
                }
                datasetsOld.push({
                    label: 'Feb Target',
                    data: dataOld.jan,
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1.5
                });
                
                impactChartNew = new Chart(ctxNew, {
                    type: 'bar',
                    data: {
                        labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                        datasets: datasetsNew
                    },
                    options: chartOptions
                });
                
                impactChartOld = new Chart(ctxOld, {
                    type: 'bar',
                    data: {
                        labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                        datasets: datasetsOld
                    },
                    options: chartOptions
                });
                console.log('Dual charts created successfully');
            };

            // Initialize with FR + New Partners (on DOM load)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing impact chart');
                    window.initImpactChartSingle('fr', 'new');
                });
            } else {
                console.log('DOM already loaded, initializing impact chart');
                window.initImpactChartSingle('fr', 'new');
            }

            // Impact Chart - Overall View (Trend Line)
            let impactChartOverall = null;
            window.initImpactChartOverall = function(metric = 'fr') {
                console.log('initImpactChartOverall called with:', metric);
                const canvas = document.getElementById('impactChartOverallCanvas');
                if (!canvas) {
                    console.error('Canvas impactChartOverallCanvas not found');
                    return;
                }
                const ctx = canvas.getContext('2d');
                
                let partnersCount, decTarget, janTarget, color;
                if (metric === 'fr') {
                    partnersCount = [17, 1, 1, 0, 3, 36, 585];
                    decTarget = [418, 181, 434, 1231, 1632, 8466, 10091];
                    janTarget = [369, 0, 19, 0, 11, 628, 18338];
                    color = '#3b82f6';
                } else {
                    partnersCount = [317, 45, 37, 26, 32, 43, 143];
                    decTarget = [13126, 1800, 988, 759, 838, 1127, 3815];
                    janTarget = [8347, 1567, 1318, 800, 978, 1402, 4953];
                    color = '#f97316';
                }
                
                if (impactChartOverall) {
                    try { impactChartOverall.destroy(); } catch(e) {}
                }
                
                console.log('Creating overall chart with metric:', metric);
                impactChartOverall = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                        datasets: [{
                            label: 'Partners Count',
                            data: partnersCount,
                            borderColor: color,
                            backgroundColor: color + '15',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: color,
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y',
                            datalabels: {
                                display: true,
                                align: 'top',
                                offset: 10,
                                font: { size: 11, weight: 'bold' },
                                color: color,
                                backgroundColor: 'white',
                                borderRadius: 4,
                                padding: 4,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }, {
                            label: 'Jan Target',
                            data: decTarget,
                            borderColor: '#9ca3af',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#9ca3af',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'y1',
                            datalabels: {
                                display: true,
                                align: 'right',
                                offset: 8,
                                font: { size: 10, weight: '600' },
                                color: '#6b7280',
                                backgroundColor: 'white',
                                borderRadius: 3,
                                padding: 3,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }, {
                            label: 'Feb Target',
                            data: janTarget,
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'y1',
                            datalabels: {
                                display: true,
                                align: 'bottom',
                                offset: 8,
                                font: { size: 10, weight: '600' },
                                color: '#059669',
                                backgroundColor: 'white',
                                borderRadius: 3,
                                padding: 3,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.8,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            const dataset = context.chart.data.datasets[context.datasetIndex];
                                            const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                            const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                            label += `${context.parsed.y.toLocaleString()} (${pct}%)`;
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                clamp: true
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Partners Count', font: { size: 12, weight: 'bold' } },
                                beginAtZero: true,
                                ticks: { callback: (value) => value.toLocaleString() }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Target Riders', font: { size: 12, weight: 'bold' } },
                                beginAtZero: true,
                                grid: { drawOnChartArea: false },
                                ticks: { callback: (value) => value.toLocaleString() }
                            },
                            x: {
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false,
                                    padding: 8
                                }
                            }
                        }
                    }
                });
                console.log('Overall chart created successfully');
            };

            // Impact Chart - Partners with Target View (Trend Line)
            let impactChartWithTarget = null;
            window.initImpactChartWithTarget = function(metric = 'fr') {
                console.log('initImpactChartWithTarget called with:', metric);
                const canvas = document.getElementById('impactChartWithTargetCanvas');
                if (!canvas) {
                    console.error('Canvas impactChartWithTargetCanvas not found');
                    return;
                }
                const ctx = canvas.getContext('2d');
                
                let activePartnersCount, decTarget, janTarget, color;
                if (metric === 'fr') {
                    activePartnersCount = [17, 0, 1, 0, 1, 23, 509];
                    decTarget = [418, 181, 434, 1231, 1632, 8466, 10091];
                    janTarget = [369, 0, 19, 0, 11, 628, 18338];
                    color = '#3b82f6';
                } else {
                    activePartnersCount = [237, 43, 34, 25, 30, 43, 139];
                    decTarget = [13126, 1800, 988, 759, 838, 1127, 3815];
                    janTarget = [8347, 1567, 1318, 800, 978, 1402, 4953];
                    color = '#f97316';
                }
                
                if (impactChartWithTarget) {
                    try { impactChartWithTarget.destroy(); } catch(e) {}
                }
                
                console.log('Creating with target chart with metric:', metric);
                impactChartWithTarget = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                        datasets: [{
                            label: 'Active Partners with Target',
                            data: activePartnersCount,
                            borderColor: color,
                            backgroundColor: color + '15',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: color,
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y',
                            datalabels: {
                                display: true,
                                anchor: 'end',
                                align: 'end',
                                offset: 5,
                                font: { size: 10, weight: 'bold' },
                                color: color,
                                backgroundColor: 'rgba(255,255,255,0.8)',
                                borderRadius: 2,
                                padding: 2,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }, {
                            label: 'Jan Target',
                            data: decTarget,
                            borderColor: '#9ca3af',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#9ca3af',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'y1',
                            datalabels: {
                                display: true,
                                anchor: 'end',
                                align: 'left',
                                offset: 5,
                                font: { size: 9, weight: '600' },
                                color: '#6b7280',
                                backgroundColor: 'rgba(255,255,255,0.8)',
                                borderRadius: 2,
                                padding: 2,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }, {
                            label: 'Feb Target',
                            data: janTarget,
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: 'white',
                            pointBorderWidth: 1,
                            pointRadius: 4,
                            yAxisID: 'y1',
                            datalabels: {
                                display: true,
                                anchor: 'end',
                                align: 'bottom',
                                offset: 5,
                                font: { size: 9, weight: '600' },
                                color: '#059669',
                                backgroundColor: 'rgba(255,255,255,0.8)',
                                borderRadius: 2,
                                padding: 2,
                                formatter: function(value, context) {
                                    const dataset = context.chart.data.datasets[context.datasetIndex];
                                    const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return `${value.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.8,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            const dataset = context.chart.data.datasets[context.datasetIndex];
                                            const total = dataset.data.reduce((sum, v) => sum + v, 0);
                                            const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                            label += `${context.parsed.y.toLocaleString()} (${pct}%)`;
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                clamp: true
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Active Partners Count', font: { size: 12, weight: 'bold' } },
                                beginAtZero: true,
                                ticks: { callback: (value) => value.toLocaleString() }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Target Riders', font: { size: 12, weight: 'bold' } },
                                beginAtZero: true,
                                grid: { drawOnChartArea: false },
                                ticks: { callback: (value) => value.toLocaleString() }
                            },
                            x: {
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false,
                                    padding: 8
                                }
                            }
                        }
                    }
                });
                console.log('With target chart created successfully');
            };

            // FR Impact Chart
            const frImpactChartEl = document.getElementById('frImpactChart');
            if (frImpactChartEl) {
            new Chart(frImpactChartEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                    datasets: [{
                        label: 'Jan Target',
                        data: [430, 416, 711, 1462, 1867, 8908, 10384],
                        backgroundColor: '#3b82f6'
                    }, {
                        label: 'Feb Target',
                        data: [369, 0, 19, 0, 11, 628, 18338],
                        backgroundColor: '#10b981'
                    }]
                },
                options: chartOptions
            });
            }

            // Terminated Chart
            const terminatedChartEl = document.getElementById('terminatedChart');
            if (terminatedChartEl) {
            new Chart(terminatedChartEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Riyadh', 'Taif', 'Jeddah', 'Al Ahsa', 'Dammam', 'Others'],
                    datasets: [{
                        label: 'Terminated Partners',
                        data: [19, 6, 5, 4, 3, 13],
                        backgroundColor: '#ef4444'
                    }]
                },
                options: chartOptions
            });
            }

            // New vs Old Chart
            const newOldChartEl = document.getElementById('newOldChart');
            if (newOldChartEl) {
            new Chart(newOldChartEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['New Partners', 'Old Partners'],
                    datasets: [{
                        label: 'Jan Target',
                        data: [2443, 21739],
                        backgroundColor: '#3b82f6'
                    }, {
                        label: 'Feb Target',
                        data: [2962, 16403],
                        backgroundColor: '#10b981'
                    }]
                },
                options: chartOptions
            });
            }

            // Risk Tier Chart
            const riskTierChartEl = document.getElementById('riskTierChart');
            if (riskTierChartEl) {
            new Chart(riskTierChartEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['🟢 Excellent\n(100-120)', '🟡 Good\n(80-100)', '🟠 At Risk\n(60-80)', '🔴 Critical\n(<60)'],
                    datasets: [{
                        label: 'Active Partners',
                        data: [330, 196, 32, 55],
                        backgroundColor: ['#10b981', '#fbbf24', '#f97316', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value.toLocaleString(),
                            font: {
                                weight: 'bold',
                                size: 11
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Active Partners'
                            }
                        }
                    }
                }
            });
            }

            // City-wise tables and charts
            try { initCityWiseSection(); } catch(e) { console.error('City-wise section failed', e); }
            
            // Partner Age Analysis (New vs Old)
            try { initPartnerAgeSection(); } catch(e) { console.error('Partner age section failed', e); }
            
            // Tier city (T1 vs T2) tables and charts
            try { initTierCitySection(); } catch(e) { console.error('Tier city section failed', e); }
        };
    

        // Adjustment Analysis Charts
        
        // City-Level Target Changes Chart
        new Chart(document.getElementById('adjustmentCityChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Riyadh', 'Jeddah', 'Madinah', 'Jubail', 'Al Ahsa', 'Taif', 'Jazan', 'Tabuk', 'Makkah'],
                datasets: [{
                    label: 'Target Change',
                    data: [-149, -119, 29, 25, 16, 10, 10, 5, 0],
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value > 0 ? '#10b981' : value < 0 ? '#ef4444' : '#6b7280';
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    datalabels: {
                        anchor: function(context) {
                            return context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start';
                        },
                        align: function(context) {
                            return context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start';
                        },
                        formatter: (value) => value > 0 ? '+' + value : value,
                        font: {
                            weight: 'bold',
                            size: 11
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Rider Change'
                        }
                    }
                }
            }
        });

        // Adjustment Reasons Chart
        new Chart(document.getElementById('adjustmentReasonsChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Driver Card Issues (37.7%)', 'FR/Performance (13.1%)', '2% Buffer (11.5%)', 'Other/Mixed (11.5%)', 'New Partner (8.2%)', 'Capacity Transfer (6.6%)', 'High Performance (4.9%)', 'Partner Inability (3.3%)', 'City Capacity (3.3%)'],
                datasets: [{
                    data: [23, 8, 7, 7, 5, 4, 3, 2, 2],
                    backgroundColor: ['#dc2626', '#f97316', '#3b82f6', '#6b7280', '#8b5cf6', '#14b8a6', '#10b981', '#f59e0b', '#0ea5e9']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: (value, ctx) => {
                            const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value * 100) / sum).toFixed(1) + '%';
                            return value + '\n(' + percentage + ')';
                        }
                    },
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        
        // =========================
        // Monthly insights (structure + assumptions)
        // =========================
        const monthlyData = {
            months: ['Sep-25','Oct-25','Nov-25','Dec-25','Jan-26','Feb-26'],
            totalPartners: [615, 697, 767, 674, 625, 551],
            activePartners: [492, 582, 640, 630, 616, 551],
            activeRiders: [38000, 36000, 34000, 25000, 24000, 24000],
            totalTarget: [32793, 34006, 34837, 24182, 22453, 19365],
            avgScale: [53.3, 48.8, 45.4, 35.9, 35.9, 35.1],
            perf: {
                good:    [160, 190, 205, 223, 269, 252],
                average: [207, 249, 275, 285, 274, 262],
                bad:     [125, 143, 160, 122, 73, 20]
            },
            size: {
                big:   [59, 74, 82, 87, 81, 77],
                mid:   [262, 322, 339, 335, 275, 282],
                small: [171, 186, 219, 208, 260, 175]
            },
            // Willingness (assumed % of active partners; Jan is updated with actual data)
            willingPct: {
                any:  [68.1, 62.0, 48.9, 50.3, 17.8, 33.92],
                gt20: [40.7, 15.3, 13.3, 14.5, 5.3, 10.24],
                gt30: [30.1, 8.8, 9.2, 10.4, 3.7, 5.76],
                gt40: [9, 8, 7, 6, 4, 3]
            },
            // MoM change for partners with target increase (any)
            willingMoMAny: [null, 14, -10, 13, -69, 91],

            // Environment index to scale assumed impact by month
            envIdx: [1.55, 1.45, 1.35, 1.25, 0.85, 0.55]
        };

        function fmtNum(n) {
            try { return n.toLocaleString('en-US'); } catch(e) { return String(n); }
        }
        function fmtPct(p) {
            const v = (Math.round(p * 10) / 10);
            return v.toFixed(1) + '%';
        }
        function safeIdx(value) {
            const idx = monthlyData.months.indexOf(value);
            return idx >= 0 ? idx : (monthlyData.months.length - 1);
        }
        function pctToCount(pct, base) {
            return Math.max(0, Math.round((pct / 100) * base));
        }

        function changeMonth(step) {
            const sel = document.getElementById('monthSelect');
            if (!sel) return;

            if (sel.value === 'All') {
                // if currently All, go to last month then step
                sel.value = monthlyData.months[monthlyData.months.length - 1];
            }

            const idx = safeIdx(sel.value);
            const next = Math.min(Math.max(idx + step, 0), monthlyData.months.length - 1);
            sel.value = monthlyData.months[next];
            updateMonthlyView(sel.value);
        }

        // Chart handles
        let m_targetTrend, m_avgScale, m_perfMix, m_sizeMix, m_mom;

        function initMonthlyCharts() {
            const t1 = document.getElementById('monthlyTargetTrendChart');
            if (!t1) return; // tab not present

            const months = monthlyData.months.slice();
            const trendMonths = months;
            const trendTotalTarget = monthlyData.totalTarget.slice();
            const trendTotalPartners = monthlyData.totalPartners.slice();

                        // Total Target & Active Partners trend (advanced version rendered in main init)
            // Fallback placeholder - main initMonthlyCharts handles rendering

            // Avg scale trend (advanced version rendered later)
            // Fallback simple chart replaced by advanced version in the main init block

            // Performance mix (stacked)
            m_perfMix = new Chart(document.getElementById('monthlyPerformanceMixChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Good', data: monthlyData.perf.good.slice(), stack: 'perf' },
                        { label: 'Average', data: monthlyData.perf.average.slice(), stack: 'perf' },
                        { label: 'Bad', data: monthlyData.perf.bad.slice(), stack: 'perf' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                }
            });

            // Size mix (stacked)
            m_sizeMix = new Chart(document.getElementById('monthlySizeMixChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Big', data: monthlyData.size.big.slice(), stack: 'size' },
                        { label: 'Mid', data: monthlyData.size.mid.slice(), stack: 'size' },
                        { label: 'Small', data: monthlyData.size.small.slice(), stack: 'size' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                }
            });

            // Total Riders by Performance Level (with percentages)
            const ridersGood = [11229, 11083, 11418, 11019, 12349, 10192];
            const ridersAverage = [12898, 14595, 14151, 9258, 8330, 8414];
            const ridersBad = [5090, 5501, 6449, 2879, 1534, 370];
            const ridersTotal = ridersGood.map((v, i) => v + ridersAverage[i] + ridersBad[i]);
            const ridersPctGood = ridersGood.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));
            const ridersPctAverage = ridersAverage.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));
            const ridersPctBad = ridersBad.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));

            m_ridersPerfMix = new Chart(document.getElementById('monthlyRidersPerformanceMixChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { 
                            label: 'Good', 
                            data: ridersGood, 
                            backgroundColor: '#10b981', 
                            borderColor: '#059669',
                            borderWidth: 1,
                            stack: 'riders'
                        },
                        { 
                            label: 'Average', 
                            data: ridersAverage, 
                            backgroundColor: '#fbbf24', 
                            borderColor: '#f59e0b',
                            borderWidth: 1,
                            stack: 'riders'
                        },
                        { 
                            label: 'Bad', 
                            data: ridersBad, 
                            backgroundColor: '#ef4444', 
                            borderColor: '#dc2626',
                            borderWidth: 1,
                            stack: 'riders'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top' },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: { weight: 'bold', size: 10 },
                            formatter: function(value, context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                let pct;
                                if (datasetIndex === 0) pct = ridersPctGood[dataIndex];
                                else if (datasetIndex === 1) pct = ridersPctAverage[dataIndex];
                                else pct = ridersPctBad[dataIndex];
                                return value.toLocaleString() + '\n(' + pct + '%)';
                            },
                            align: 'center',
                            anchor: 'center'
                        }
                    },
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            stacked: true, 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        } 
                    }
                }
            });

            // Total Riders by Size Level (with percentages)
            const ridersBig = [7197, 7906, 8642, 6741, 4938, 5351];
            const ridersMid = [15978, 17709, 17253, 12352, 10598, 9982];
            const ridersSmall = [6042, 5564, 6123, 4063, 6677, 3643];
            const ridersSizeTotal = ridersBig.map((v, i) => v + ridersMid[i] + ridersSmall[i]);
            const ridersPctBig = ridersBig.map((v, i) => ((v / ridersSizeTotal[i]) * 100).toFixed(1));
            const ridersPctMid = ridersMid.map((v, i) => ((v / ridersSizeTotal[i]) * 100).toFixed(1));
            const ridersPctSmall = ridersSmall.map((v, i) => ((v / ridersSizeTotal[i]) * 100).toFixed(1));

            m_ridersSizeMix = new Chart(document.getElementById('monthlyRidersSizeMixChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { 
                            label: 'Big', 
                            data: ridersBig, 
                            backgroundColor: '#3b82f6', 
                            borderColor: '#2563eb',
                            borderWidth: 1,
                            stack: 'size'
                        },
                        { 
                            label: 'Mid', 
                            data: ridersMid, 
                            backgroundColor: '#8b5cf6', 
                            borderColor: '#7c3aed',
                            borderWidth: 1,
                            stack: 'size'
                        },
                        { 
                            label: 'Small', 
                            data: ridersSmall, 
                            backgroundColor: '#06b6d4', 
                            borderColor: '#0891b2',
                            borderWidth: 1,
                            stack: 'size'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top' },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: { weight: 'bold', size: 10 },
                            formatter: function(value, context) {
                                const datasetIndex = context.datasetIndex;
                                const dataIndex = context.dataIndex;
                                let pct;
                                if (datasetIndex === 0) pct = ridersPctBig[dataIndex];
                                else if (datasetIndex === 1) pct = ridersPctMid[dataIndex];
                                else pct = ridersPctSmall[dataIndex];
                                return value.toLocaleString() + '\n(' + pct + '%)';
                            },
                            align: 'center',
                            anchor: 'center'
                        }
                    },
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            stacked: true, 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        } 
                    }
                }
            });

            // MoM % change in total target
            const momCanvas = document.getElementById('monthlyMoMChangeChartNew') || document.getElementById('monthlyMoMChangeChart');

            // MoM%: (current - previous) / previous
            const mom = trendMonths.map((m, i) => {
                if (i === 0) return null; // baseline month (no MoM)
                const prev = trendTotalTarget[i - 1];
                const cur = trendTotalTarget[i];
                if (!prev) return null;
                return ((cur - prev) / prev) * 100;
            });

            if (momCanvas) {
                const bg = mom.map(v => (v === null) ? '#9ca3af' : (v >= 0 ? '#16a34a' : '#dc2626'));
                const br = mom.map(v => (v === null) ? '#6b7280' : (v >= 0 ? '#15803d' : '#b91c1c'));

                m_mom = new Chart(momCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: trendMonths,
                        datasets: [{
                            label: 'MoM %',
                            data: mom,
                            backgroundColor: bg,
                            borderColor: br,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const v = ctx.parsed.y;
                                        if (v === null || typeof v === 'undefined') return 'Baseline month';
                                        return 'MoM Change: ' + v.toFixed(2) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#111827' } },
                            y: {
                                title: { display: true, text: 'Month-over-Month Change (%)', color: '#111827' },
                                ticks: {
                                    color: '#111827',
                                    callback: (v) => v + '%'
                                }
                            }
                        }
                    }
                });
            } else {
                m_mom = null;
            }

            // Average Scale by Performance Level
            const perfScaleCanvas = document.getElementById('avgScalePerfChart');
            if (perfScaleCanvas) {
                m_avgScalePerf = new Chart(perfScaleCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: avgScalePerfData.labels,
                        datasets: avgScalePerfData.series.map(s => makeLineDataset(s, perfScaleCanvas))
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
                            datalabels: {
                                display: true,
                                color: function(ctx){ return ctx.dataset.borderColor; },
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) { return value; },
                                anchor: 'end',
                                align: 'top',
                                offset: 4,
                                backgroundColor: 'rgba(255,255,255,0.85)',
                                borderRadius: 4,
                                padding: { top: 2, bottom: 2, left: 4, right: 4 }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Avg Riders per Partner', color: '#111827', font: { weight: '600' } },
                                ticks: { color: '#111827' },
                                grid: { color: 'rgba(0,0,0,0.06)' }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Average Scale by Size Level
            const sizeScaleCanvas = document.getElementById('avgScaleSizeChart');
            if (sizeScaleCanvas) {
                m_avgScaleSize = new Chart(sizeScaleCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: avgScaleSizeData.labels,
                        datasets: avgScaleSizeData.series.map(s => makeLineDataset(s, sizeScaleCanvas))
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
                            datalabels: {
                                display: true,
                                color: function(ctx){ return ctx.dataset.borderColor; },
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) { return value; },
                                anchor: 'end',
                                align: 'top',
                                offset: 4,
                                backgroundColor: 'rgba(255,255,255,0.85)',
                                borderRadius: 4,
                                padding: { top: 2, bottom: 2, left: 4, right: 4 }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Avg Riders per Partner', color: '#111827', font: { weight: '600' } },
                                ticks: { color: '#111827' },
                                grid: { color: 'rgba(0,0,0,0.06)' }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Monthly Willing vs Not-Willing Partners
            const willingCanvas = document.getElementById('willingVsNotWillingChart');
            if (willingCanvas) {
                const willingMonths = ['Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
                const willingPartners = [213, 259, 81, 201, 130];
                const notWillingPartners = [356, 381, 554, 413, 398];

                m_willingVsNotWilling = new Chart(willingCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: willingMonths,
                        datasets: [
                            {
                                label: 'Not-Willing (≥0)',
                                data: notWillingPartners,
                                backgroundColor: '#ef4444',
                                borderColor: '#dc2626',
                                borderWidth: 1
                            },
                            {
                                label: 'Willing (>0)',
                                data: willingPartners,
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) { return value; },
                                anchor: 'center',
                                align: 'center'
                            }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Partner Willingness Trend (%)\n            const trendCanvas = document.getElementById('willingnessTrendChart');\n            if (trendCanvas) {\n                const trendMonths = ['Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];\n                const willingPct = [37.4, 40.5, 12.8, 32.7, 24.6];\n                const notWillingPct = [62.6, 59.5, 87.2, 67.3, 75.4];\n\n                m_willingnessTrend = new Chart(trendCanvas.getContext('2d'), {\n                    type: 'line',\n                    data: {\n                        labels: trendMonths,\n                        datasets: [\n                            {\n                                label: 'Willing %',\n                                data: willingPct,\n                                borderColor: '#10b981',\n                                backgroundColor: 'rgba(16, 185, 129, 0.1)',\n                                borderWidth: 3,\n                                fill: true,\n                                pointRadius: 6,\n                                pointBackgroundColor: '#10b981',\n                                tension: 0.4\n                            },\n                            {\n                                label: 'Not-Willing %',\n                                data: notWillingPct,\n                                borderColor: '#ef4444',\n                                backgroundColor: 'rgba(239, 68, 68, 0.1)',\n                                borderWidth: 3,\n                                fill: true,\n                                pointRadius: 6,\n                                pointBackgroundColor: '#ef4444',\n                                tension: 0.4\n                            }\n                        ]\n                    },\n                    options: {\n                        responsive: true,\n                        plugins: {\n                            legend: { position: 'top' },\n                            datalabels: {\n                                display: true,\n                                color: '#111827',\n                                font: { weight: 'bold', size: 10 },\n                                formatter: function(value) { return value.toFixed(1) + '%'; },\n                                anchor: 'end',\n                                align: 'top',\n                                offset: 5\n                            }\n                        },\n                        scales: {\n                            y: {\n                                beginAtZero: true,\n                                max: 100,\n                                title: { display: true, text: 'Percentage (%)', color: '#111827' },\n                                ticks: { color: '#111827', callback: (v) => v + '%' }\n                            }\n                        }\n                    },\n                    plugins: [ChartDataLabels]\n                });\n            }

            // Growth Category Breakdown (Increase Slabs)
            const gcCanvas = document.getElementById('growthCategoryChart');
            if (gcCanvas) {
                const gcMonths = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
                const gc1_10 = [42, 60, 73, 22, 79, 46];
                const gc10_20 = [63, 60, 75, 23, 58, 52];
                const gc20_30 = [40, 29, 31, 11, 28, 16];
                const gc30plus = [54, 64, 80, 25, 36, 16];
                const gcTotal = [199, 213, 259, 81, 201, 130];

                m_growthCategory = new Chart(gcCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: gcMonths,
                        datasets: [
                            {
                                label: '≥1% - ≤10%',
                                data: gc1_10,
                                backgroundColor: '#3b82f6',
                                borderColor: '#2563eb',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '>10% - ≤20%',
                                data: gc10_20,
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '>20% - ≤30%',
                                data: gc20_30,
                                backgroundColor: '#f59e0b',
                                borderColor: '#d97706',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '>30%',
                                data: gc30plus,
                                backgroundColor: '#ef4444',
                                borderColor: '#dc2626',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Increase Trend',
                                data: gcTotal,
                                type: 'line',
                                borderColor: '#111827',
                                backgroundColor: 'rgba(17, 24, 39, 0)',
                                borderWidth: 3,
                                pointRadius: 6,
                                pointBackgroundColor: '#111827',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) {
                                    return value;
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 0
                            }
                        },
                        scales: {
                            x: { stacked: false },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                title: { display: true, text: 'Partners (Bars)', color: '#111827' },
                                ticks: { color: '#111827' }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                beginAtZero: true,
                                min: 50,
                                max: 300,
                                title: { display: true, text: 'Total Increase (Line)', color: '#111827' },
                                ticks: { color: '#111827' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Growth Category Breakdown (Decrease Slabs)
            const dcCanvas = document.getElementById('decreaseCategoryChart');
            if (dcCanvas) {
                const dcMonths = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
                const dc1_10 = [17, 39, 40, 52, 64, 84];
                const dc10_20 = [38, 56, 64, 108, 77, 98];
                const dc20_30 = [21, 26, 43, 83, 42, 50];
                const dc30plus = [48, 40, 41, 215, 56, 52];
                const dcTotal = [124, 161, 188, 458, 239, 284];

                m_decreaseCategory = new Chart(dcCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: dcMonths,
                        datasets: [
                            {
                                label: '≥-10% - ≤-1%',
                                data: dc1_10,
                                backgroundColor: '#fcd34d',
                                borderColor: '#f59e0b',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '>-20% - ≤-11%',
                                data: dc10_20,
                                backgroundColor: '#fed7aa',
                                borderColor: '#f97316',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '>-30% - ≤-21%',
                                data: dc20_30,
                                backgroundColor: '#fca5a5',
                                borderColor: '#f87171',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '<-30%',
                                data: dc30plus,
                                backgroundColor: '#dc2626',
                                borderColor: '#991b1b',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Decrease Trend',
                                data: dcTotal,
                                type: 'line',
                                borderColor: '#111827',
                                backgroundColor: 'rgba(17, 24, 39, 0)',
                                borderWidth: 3,
                                pointRadius: 6,
                                pointBackgroundColor: '#111827',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: {
                                display: true,
                                color: function(context) {
                                    return context.datasetIndex === 4 ? '#111827' : '#ffffff';
                                },
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) {
                                    return value;
                                },
                                anchor: function(context) {
                                    return context.datasetIndex === 4 ? 'end' : 'center';
                                },
                                align: function(context) {
                                    return context.datasetIndex === 4 ? 'top' : 'center';
                                },
                                offset: function(context) {
                                    return context.datasetIndex === 4 ? 4 : 0;
                                }
                            }
                        },
                        scales: {
                            x: { stacked: false },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                title: { display: true, text: 'Partners (Bars)', color: '#111827' },
                                ticks: { color: '#111827' }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                beginAtZero: true,
                                min: 0,
                                max: 550,
                                title: { display: true, text: 'Total Decrease (Line)', color: '#111827' },
                                ticks: { color: '#111827' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            window.monthlyCharts = [m_targetTrend, m_avgScale, m_perfMix, m_sizeMix].concat(m_mom ? [m_mom] : []);

            // Default selection
            const sel = document.getElementById('monthSelect');
            if (sel) {
                sel.value = 'Feb-26';
                updateMonthlyView('Feb-26');
            }
        }

        function renderFactorsTable(idx) {
            const body = document.getElementById('monthlyFactorsBody');
            if (!body) return;

            const month = monthlyData.months[idx];
            const active = monthlyData.activePartners[idx];

            // Overall (based on willingness pct)
            const overall = {
                gt10: Math.min(95, monthlyData.willingPct.gt20[idx] * 1.25),  // assumed
                gt20: monthlyData.willingPct.gt20[idx],
                gt30: monthlyData.willingPct.gt30[idx],
                gt40: monthlyData.willingPct.gt40[idx]
            };

            // Performance-level assumed pcts (scaled by env)
            const e = monthlyData.envIdx[idx];
            const perfBase = {
                good:    { gt10: 18, gt20: 12, gt30: 6, gt40: 3 },
                average: { gt10: 10, gt20: 6,  gt30: 3, gt40: 1.5 },
                bad:     { gt10: 4,  gt20: 2,  gt30: 1, gt40: 0.5 }
            };
            const sizeBase = {
                big:   { gt10: 16, gt20: 14, gt30: 8, gt40: 4 },
                mid:   { gt10: 11, gt20: 8,  gt30: 4, gt40: 2 },
                small: { gt10: 8,  gt20: 5,  gt30: 2.5, gt40: 1 }
            };

            function scaledPct(basePct) { return Math.min(95, basePct * e); }

            function rowHtml(label, baseCount, pctObj) {
                const c10 = pctToCount(scaledPct(pctObj.gt10), baseCount);
                const c20 = pctToCount(scaledPct(pctObj.gt20), baseCount);
                const c30 = pctToCount(scaledPct(pctObj.gt30), baseCount);
                const c40 = pctToCount(scaledPct(pctObj.gt40), baseCount);
                return `<tr>
                    <td><strong>${label}</strong></td>
                    <td>${fmtNum(c10)} (${fmtPct((c10/baseCount)*100)})</td>
                    <td>${fmtNum(c20)} (${fmtPct((c20/baseCount)*100)})</td>
                    <td>${fmtNum(c30)} (${fmtPct((c30/baseCount)*100)})</td>
                    <td>${fmtNum(c40)} (${fmtPct((c40/baseCount)*100)})</td>
                </tr>`;
            }

            // Build table
            const overallBase = active || 1;
            const o10 = pctToCount(overall.gt10, overallBase);
            const o20 = pctToCount(overall.gt20, overallBase);
            const o30 = pctToCount(overall.gt30, overallBase);
            const o40 = pctToCount(overall.gt40, overallBase);

            const rows = [];
            rows.push(`<tr>
                <td><strong>Overall (Active)</strong></td>
                <td>${fmtNum(o10)} (${fmtPct((o10/overallBase)*100)})</td>
                <td>${fmtNum(o20)} (${fmtPct((o20/overallBase)*100)})</td>
                <td>${fmtNum(o30)} (${fmtPct((o30/overallBase)*100)})</td>
                <td>${fmtNum(o40)} (${fmtPct((o40/overallBase)*100)})</td>
            </tr>`);

            // Performance groups (use total partners in group)
            rows.push(rowHtml('Good partners', monthlyData.perf.good[idx] || 1, perfBase.good));
            rows.push(rowHtml('Average partners', monthlyData.perf.average[idx] || 1, perfBase.average));
            rows.push(rowHtml('Bad partners', monthlyData.perf.bad[idx] || 1, perfBase.bad));

            // Size groups (use total partners in group)
            rows.push(rowHtml('Big partners', monthlyData.size.big[idx] || 1, sizeBase.big));
            rows.push(rowHtml('Mid partners', monthlyData.size.mid[idx] || 1, sizeBase.mid));
            rows.push(rowHtml('Small partners', monthlyData.size.small[idx] || 1, sizeBase.small));

            body.innerHTML = rows.join('');
        }

        function renderHighlights(idx) {
            const ul = document.getElementById('monthlyHighlights');
            if (!ul) return;

            const month = monthlyData.months[idx];
            const prevIdx = Math.max(0, idx - 1);

            const tp = monthlyData.totalPartners[idx];
            const ap = monthlyData.activePartners[idx];
            const tt = monthlyData.totalTarget[idx];
            const as = monthlyData.avgScale[idx];

            const dTT = prevIdx === idx ? 0 : ((tt - monthlyData.totalTarget[prevIdx]) / monthlyData.totalTarget[prevIdx]) * 100;
            const dAP = prevIdx === idx ? 0 : ((ap - monthlyData.activePartners[prevIdx]) / monthlyData.activePartners[prevIdx]) * 100;
            const dAS = prevIdx === idx ? 0 : (as - monthlyData.avgScale[prevIdx]);

            const goodShare = (monthlyData.perf.good[idx] / tp) * 100;
            const badShare = (monthlyData.perf.bad[idx] / tp) * 100;

            const incAny = pctToCount(monthlyData.willingPct.any[idx], ap);

            const items = [
                `<li><strong>${month}:</strong> Total target ${dTT >= 0 ? 'increased' : 'decreased'} by <strong>${fmtPct(Math.abs(dTT))}</strong> vs previous month.</li>`,
                `<li>Active partners changed by <strong>${fmtPct(Math.abs(dAP))}</strong> (${dAP >= 0 ? 'up' : 'down'}) vs previous month.</li>`,
                `<li>Average scale is <strong>${as.toFixed(1)}</strong> (${dAS >= 0 ? '+' : ''}${dAS.toFixed(1)} vs previous month).</li>`,
                `<li>Performance mix: <strong>${fmtPct(goodShare)}</strong> good, <strong>${fmtPct(badShare)}</strong> bad (by partner count).</li>`,
                `<li>Estimated willingness: <strong>${fmtNum(incAny)}</strong> partners increased their target (any increase).</li>`
            ];

            ul.innerHTML = items.join('');
        }

        function updateMonthlyView(value) {
            if (value === 'Feb-26') {
                const prevLabel = monthlyData.months[monthlyData.months.length - 2];
                const ap = 551;
                const tp = 643;
                const tt = 19365;
                const as = 35.1;
                const anyCnt = 153;
                const c20 = 32;
                const c30 = 16;
                const anyPct = (anyCnt / ap) * 100;
                const c20Pct = (c20 / ap) * 100;
                const c30Pct = (c30 / ap) * 100;

                document.getElementById('m_totalPartners').textContent = fmtNum(tp);
                document.getElementById('m_totalPartners_sub').textContent = `Feb-26 vs ${prevLabel}`;

                document.getElementById('m_activePartners').textContent = fmtNum(ap);
                document.getElementById('m_activePartners_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(11.8)} vs ${prevLabel}</span>`;

                document.getElementById('m_totalTarget').textContent = fmtNum(tt);
                document.getElementById('m_totalTarget_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(13.8)} vs ${prevLabel}</span>`;

                document.getElementById('m_avgScale').textContent = as.toFixed(1);
                document.getElementById('m_avgScale_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(2.2)} vs ${prevLabel}</span>`;

                document.getElementById('m_incAny').textContent = fmtNum(anyCnt);
                document.getElementById('m_incAny_sub').textContent = `${fmtPct(anyPct)} of active partners`;

                document.getElementById('m_inc20').textContent = fmtNum(c20);
                document.getElementById('m_inc20_sub').textContent = `${fmtPct(c20Pct)} of active partners`;

                document.getElementById('m_inc30').textContent = fmtNum(c30);
                document.getElementById('m_inc30_sub').textContent = `${fmtPct(c30Pct)} of active partners`;

                document.getElementById('m_inc40').textContent = fmtPct(-27.8);
                document.getElementById('m_inc40_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">vs ${prevLabel}</span>`;
                return;
            }
            const idx = (value === 'All') ? (monthlyData.months.length - 1) : safeIdx(value);
            const month = monthlyData.months[idx];
            const prevIdx = Math.max(0, idx - 1);

            // KPI: Total partners
            document.getElementById('m_totalPartners').textContent = fmtNum(monthlyData.totalPartners[idx]);
            document.getElementById('m_totalPartners_sub').textContent = (idx === 0) ? month : `${month} vs ${monthlyData.months[prevIdx]}`;

            // KPI: Active partners
            const ap = monthlyData.activePartners[idx];
            const apPrev = monthlyData.activePartners[prevIdx] || ap;
            const apChg = (idx === 0) ? 0 : ((ap - apPrev) / apPrev) * 100;
            document.getElementById('m_activePartners').textContent = fmtNum(ap);
            document.getElementById('m_activePartners_sub').innerHTML = (idx === 0) ? month : `<span style="color: ${apChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${apChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(apChg))} vs ${monthlyData.months[prevIdx]}</span>`;

            // KPI: Total target
            const tt = monthlyData.totalTarget[idx];
            const ttPrev = monthlyData.totalTarget[prevIdx] || tt;
            const ttChg = (idx === 0) ? 0 : ((tt - ttPrev) / ttPrev) * 100;
            document.getElementById('m_totalTarget').textContent = fmtNum(tt);
            document.getElementById('m_totalTarget_sub').innerHTML = (idx === 0) ? month : `<span style="color: ${ttChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${ttChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(ttChg))} vs ${monthlyData.months[prevIdx]}</span>`;

            // KPI: Avg scale
            const as = monthlyData.avgScale[idx];
            const asPrev = monthlyData.avgScale[prevIdx] || as;
            const asChg = (idx === 0) ? 0 : (as - asPrev);
            document.getElementById('m_avgScale').textContent = as.toFixed(1);
            document.getElementById('m_avgScale_sub').innerHTML = (idx === 0) ? month : `<span style="color: ${asChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${asChg >= 0 ? '↑' : '↓'} ${Math.abs(asChg).toFixed(1)} vs ${monthlyData.months[prevIdx]}</span>`;

            // Willingness counts
            const anyPct = monthlyData.willingPct.any[idx];
            const gt20Pct = monthlyData.willingPct.gt20[idx];
            const gt30Pct = monthlyData.willingPct.gt30[idx];
            const gt40Pct = monthlyData.willingPct.gt40[idx];

            const anyCnt = pctToCount(anyPct, ap);
            const c20 = pctToCount(gt20Pct, ap);
            const c30 = pctToCount(gt30Pct, ap);
            const c40 = pctToCount(gt40Pct, ap);

            document.getElementById('m_incAny').textContent = fmtNum(anyCnt);
            document.getElementById('m_incAny_sub').textContent = `${fmtPct(anyPct)} of active partners`;
            document.getElementById('m_inc20').textContent = fmtNum(c20);
            document.getElementById('m_inc20_sub').textContent = `${fmtPct(gt20Pct)} of active partners`;
            document.getElementById('m_inc30').textContent = fmtNum(c30);
            document.getElementById('m_inc30_sub').textContent = `${fmtPct(gt30Pct)} of active partners`;
            // MoM change KPI (partners with increase any)
            const momAny = (monthlyData.willingMoMAny && monthlyData.willingMoMAny[idx] !== null && monthlyData.willingMoMAny[idx] !== undefined)
                ? monthlyData.willingMoMAny[idx]
                : null;

            if (momAny === null || idx === 0) {
                document.getElementById('m_inc40').textContent = '—';
                document.getElementById('m_inc40_sub').textContent = 'Baseline month';
            } else {
                document.getElementById('m_inc40').textContent = `${momAny >= 0 ? '+' : ''}${fmtPct(momAny)}`;
                document.getElementById('m_inc40_sub').innerHTML = `<span style="color: ${momAny >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">vs ${monthlyData.months[prevIdx]}</span>`;
            }

            // Highlight selected month point on trend chart
            function highlightPoint(chart) {
                if (!chart) return;
                chart.data.datasets.forEach(ds => {
                    ds.pointRadius = ds.data.map((_, i) => (i === idx ? 6 : 3));
                });
                chart.update('none');
            }
            highlightPoint(m_targetTrend);

            renderFactorsTable(idx);
            renderHighlights(idx);
        }

        // Initialize monthly tab charts after existing charts are created
        try { initMonthlyCharts(); } catch(e) { console.error(e); }

    </script>
    </div>
    <script>
/* Monthly insights tab - robustness patch (global functions + guaranteed init) */
(function(){
  // If already patched, skip
  if (window.__monthlyInsightsPatched) return;
  window.__monthlyInsightsPatched = true;

  // Source data (Aug–Dec assumed; Jan-26 aligned with current dashboard)
const monthlyData = {
    months: ['Sep-25','Oct-25','Nov-25','Dec-25','Jan-26','Feb-26'],
    totalPartners: [615, 697, 767, 674, 625, 551],
    activePartners: [492, 582, 640, 630, 616, 551],
    activeRiders: [38000, 36000, 34000, 25000, 24000, 24000],
    totalTarget: [32793, 34006, 34837, 24182, 22453, 19365],
    avgScale: [53.3, 48.8, 45.4, 35.9, 35.9, 35.1],
    perf: {
      good:    [160, 190, 205, 223, 269, 252],
      average: [207, 249, 275, 285, 274, 262],
      bad:     [125, 143, 160, 122, 73, 20]
    },
    size: {
      big:   [59, 74, 82, 87, 81, 77],
      mid:   [262, 322, 339, 335, 275, 282],
      small: [171, 186, 219, 208, 260, 175]
    },
    willingPct: {
      any:  [68.1, 62.0, 48.9, 50.3, 17.8, 33.92],
      gt20: [40.7, 15.3, 13.3, 14.5, 5.3, 10.24],
      gt30: [30.1, 8.8, 9.2, 10.4, 3.7, 5.76],
      gt40: [9, 8, 7, 6, 4, 3]
    },
    willingMoMAny: [null, 14, -10, 13, -69, 91],
    envIdx: [1.55, 1.45, 1.35, 1.25, 0.85, 0.55]
  };

    const avgScalePerfData = {
        labels: ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'],
        series: [
            { label: 'Good', values: [70.2, 58.3, 55.7, 49.4, 45.9, 40.4], color: '#10b981', border: '#059669' },
            { label: 'Average', values: [62.3, 58.6, 51.5, 32.5, 30.4, 32.1], color: '#f59e0b', border: '#d97706' },
            { label: 'Bad', values: [40.7, 38.5, 40.3, 23.6, 21.0, 18.5], color: '#ef4444', border: '#dc2626' }
        ]
    };

    const avgScaleSizeData = {
        labels: ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'],
        series: [
            { label: 'Big', values: [122.0, 106.8, 105.4, 77.5, 61.0, 69.5], color: '#3b82f6', border: '#2563eb' },
            { label: 'Mid', values: [61.0, 55.0, 50.9, 36.9, 38.5, 35.4], color: '#8b5cf6', border: '#7c3aed' },
            { label: 'Small', values: [35.3, 29.9, 28.0, 19.5, 25.7, 20.8], color: '#06b6d4', border: '#0891b2' }
        ]
    };

  function fmtNum(n){
    try { return Number(n).toLocaleString('en-US'); } catch(e){ return String(n); }
  }
  function fmtPct(v){
    const x = Number(v);
    if (!isFinite(x)) return '0%';
    return x.toFixed(1) + '%';
  }
  function safeIdx(value){
    const idx = monthlyData.months.indexOf(value);
    return idx >= 0 ? idx : (monthlyData.months.length - 1);
  }
  function pctToCount(pct, base){
    return Math.max(0, Math.round((Number(pct) / 100) * Number(base)));
  }

    function renderAvgScalePanel(panelId, data, index, labelPrefix){
        const panel = document.getElementById(panelId);
        if (!panel) return;
        if (index === null || index === undefined || index < 0) {
            panel.innerHTML = '<div class="chart-info-empty">Hover a month to see details.</div>';
            return;
        }
        const monthLabel = data.labels[index];
        const rows = data.series.map(s => (
            `<div class="chart-info-row">
                <div class="chart-info-left">
                    <span class="chart-info-dot" style="background: ${s.color}"></span>
                    <span class="chart-info-name">${s.label}</span>
                </div>
                <span class="chart-info-value">${s.values[index]}</span>
            </div>`
        )).join('');
        panel.innerHTML = `<div class="chart-info-title">${labelPrefix}: ${monthLabel}</div>${rows}`;
    }

    function makeLineDataset(s, ctx){
        const canvas = ctx ? ctx.canvas : null;
        return {
            label: s.label,
            data: s.values.slice(),
            borderColor: s.border,
            backgroundColor: (function(){
                if (!canvas) return s.color + '20';
                var g = canvas.getContext('2d').createLinearGradient(0, 0, 0, canvas.height || 300);
                g.addColorStop(0, s.color + '35');
                g.addColorStop(1, s.color + '05');
                return g;
            })(),
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 8,
            pointBackgroundColor: '#fff',
            pointBorderColor: s.border,
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: s.color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
        };
    }

    function applyAvgScaleHighlight(chart, dataIndex, chartIndex){
        if (!chart || dataIndex === null || dataIndex === undefined || dataIndex < 0) return;
        chart.$selectedIndex = dataIndex;
        chart.data.datasets.forEach((ds, i) => {
            const s = (chart === m_avgScalePerf ? avgScalePerfData : avgScaleSizeData).series[i];
            if (!s) return;
            const pointBg = ds.data.map((_, j) => j === dataIndex ? s.color : '#fff');
            const pointR = ds.data.map((_, j) => j === dataIndex ? 8 : 5);
            const pointBW = ds.data.map((_, j) => j === dataIndex ? 3 : 2.5);
            ds.pointBackgroundColor = pointBg;
            ds.pointRadius = pointR;
            ds.pointBorderWidth = pointBW;
        });
        chart.update('none');
    }

    function applyAvgScaleTrend(chart, data, monthLabel){
        chart.data.labels = data.labels.slice();
        const ctx = chart.canvas ? chart.canvas.getContext('2d') : null;
        chart.data.datasets = data.series.map(s => makeLineDataset(s, chart.canvas ? { canvas: chart.canvas } : null));
        const idx = data.labels.indexOf(monthLabel);
        if (idx >= 0) {
            applyAvgScaleHighlight(chart, idx);
            renderAvgScalePanel(chart.$panelId, data, idx, 'Selected month');
        }
        chart.$view = 'trend';
        chart.update('none');
    }

    function applyAvgScaleComparison(chart, data, monthLabel){
        const idx = data.labels.indexOf(monthLabel);
        if (idx < 0) return;
        const prevIdx = Math.max(0, idx - 1);
        const labels = (idx === 0)
            ? [data.labels[idx]]
            : [data.labels[prevIdx], data.labels[idx]];

        chart.data.labels = labels;
        chart.data.datasets = data.series.map(s => {
            const ds = makeLineDataset(s, chart.canvas ? { canvas: chart.canvas } : null);
            ds.data = (idx === 0)
                ? [s.values[idx]]
                : [s.values[prevIdx], s.values[idx]];
            return ds;
        });
        const chartIndex = (labels.length - 1);
        applyAvgScaleHighlight(chart, idx, chartIndex);
        renderAvgScalePanel(chart.$panelId, data, idx, 'Selected month');
        chart.$view = 'comparison';
        chart.update('none');
    }

    function syncAvgScaleSelection(monthLabel){
        if (m_avgScalePerf) {
            if (m_avgScalePerf.$view === 'comparison') {
                applyAvgScaleComparison(m_avgScalePerf, avgScalePerfData, monthLabel);
            } else {
                applyAvgScaleTrend(m_avgScalePerf, avgScalePerfData, monthLabel);
            }
        }
        if (m_avgScaleSize) {
            if (m_avgScaleSize.$view === 'comparison') {
                applyAvgScaleComparison(m_avgScaleSize, avgScaleSizeData, monthLabel);
            } else {
                applyAvgScaleTrend(m_avgScaleSize, avgScaleSizeData, monthLabel);
            }
        }
    }

    const hoverLinePlugin = {
        id: 'hoverLine',
        afterDraw(chart, args, opts) {
            if (!chart.tooltip || !chart.tooltip.getActiveElements().length) return;
            const ctx = chart.ctx;
            const x = chart.tooltip.getActiveElements()[0].element.x;
            const topY = chart.chartArea.top;
            const bottomY = chart.chartArea.bottom;
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, topY);
            ctx.lineTo(x, bottomY);
            ctx.lineWidth = 1;
            ctx.strokeStyle = (opts && opts.color) ? opts.color : 'rgba(30, 64, 175, 0.25)';
            ctx.stroke();
            ctx.restore();
        }
    };

    function makeAvgScaleTooltip(panelId, data){
        return function(context){
            const tooltip = context.tooltip;
            const chart = context.chart;
            if (!tooltip || tooltip.opacity === 0) {
                if (chart && chart.$selectedIndex !== undefined) {
                    renderAvgScalePanel(panelId, data, chart.$selectedIndex, 'Selected month');
                } else {
                    renderAvgScalePanel(panelId, data, -1, 'Selected month');
                }
                return;
            }
            const chartLabel = (tooltip.dataPoints && tooltip.dataPoints.length) ? tooltip.dataPoints[0].label : null;
            const idx = chartLabel ? data.labels.indexOf(chartLabel) : -1;
            renderAvgScalePanel(panelId, data, idx, 'Hover');
        };
    }

    function setAvgScaleView(target, view){
        const sel = document.getElementById('monthSelect');
        const monthLabel = (sel && sel.value && sel.value !== 'All')
            ? sel.value
            : monthlyData.months[monthlyData.months.length - 1];

        if (target === 'perf' && m_avgScalePerf) {
            m_avgScalePerf.$panelId = 'avgScalePerfInfo';
            if (view === 'comparison') applyAvgScaleComparison(m_avgScalePerf, avgScalePerfData, monthLabel);
            else applyAvgScaleTrend(m_avgScalePerf, avgScalePerfData, monthLabel);
        }
        if (target === 'size' && m_avgScaleSize) {
            m_avgScaleSize.$panelId = 'avgScaleSizeInfo';
            if (view === 'comparison') applyAvgScaleComparison(m_avgScaleSize, avgScaleSizeData, monthLabel);
            else applyAvgScaleTrend(m_avgScaleSize, avgScaleSizeData, monthLabel);
        }
    }

    let avgScaleToggleInited = false;
    function setupAvgScaleToggle(toggleId, target){
        const wrap = document.getElementById(toggleId);
        if (!wrap) return;
        const btns = Array.from(wrap.querySelectorAll('button'));
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                setAvgScaleView(target, btn.dataset.view);
            });
        });
    }

  // Chart instances
  let m_targetTrend, m_avgScale, m_perfMix, m_sizeMix, m_mom;
  let chartsInited = false;

  function renderFactorsTable(idx){
    const body = document.getElementById('monthlyFactorsBody');
    if (!body) return;

    const active = monthlyData.activePartners[idx];

    const overall = {
      gt10: Math.min(95, monthlyData.willingPct.gt20[idx] * 1.25),  // assumed
      gt20: monthlyData.willingPct.gt20[idx],
      gt30: monthlyData.willingPct.gt30[idx],
      gt40: monthlyData.willingPct.gt40[idx]
    };

    const e = monthlyData.envIdx[idx];
    const perfBase = {
      good:    {gt10: overall.gt10 * (1.05*e), gt20: overall.gt20*(1.05*e), gt30: overall.gt30*(1.10*e), gt40: overall.gt40*(1.15*e)},
      average: {gt10: overall.gt10 * (0.95*e), gt20: overall.gt20*(0.95*e), gt30: overall.gt30*(0.90*e), gt40: overall.gt40*(0.85*e)},
      bad:     {gt10: overall.gt10 * (0.70*e), gt20: overall.gt20*(0.70*e), gt30: overall.gt30*(0.60*e), gt40: overall.gt40*(0.55*e)}
    };
    const sizeBase = {
      big:   {gt10: overall.gt10*(1.15*e), gt20: overall.gt20*(1.20*e), gt30: overall.gt30*(1.25*e), gt40: overall.gt40*(1.30*e)},
      mid:   {gt10: overall.gt10*(1.00*e), gt20: overall.gt20*(1.00*e), gt30: overall.gt30*(1.00*e), gt40: overall.gt40*(1.00*e)},
      small: {gt10: overall.gt10*(0.80*e), gt20: overall.gt20*(0.75*e), gt30: overall.gt30*(0.70*e), gt40: overall.gt40*(0.65*e)}
    };

    function rowHtml(label, baseN, pctObj){
      const base = Math.max(1, Math.round(baseN));
      const c10 = pctToCount(pctObj.gt10, base);
      const c20 = pctToCount(pctObj.gt20, base);
      const c30 = pctToCount(pctObj.gt30, base);
      const c40 = pctToCount(pctObj.gt40, base);
      return `
        <tr>
          <td style="font-weight: 600;">${label}</td>
          <td>${fmtNum(c10)} (${fmtPct((c10/base)*100)})</td>
          <td>${fmtNum(c20)} (${fmtPct((c20/base)*100)})</td>
          <td>${fmtNum(c30)} (${fmtPct((c30/base)*100)})</td>
          <td>${fmtNum(c40)} (${fmtPct((c40/base)*100)})</td>
        </tr>`;
    }

    const overallBase = active || 1;
    const o10 = pctToCount(overall.gt10, overallBase);
    const o20 = pctToCount(overall.gt20, overallBase);
    const o30 = pctToCount(overall.gt30, overallBase);
    const o40 = pctToCount(overall.gt40, overallBase);

    const rows = [];
    rows.push(`
      <tr>
        <td style="font-weight: 700;">Overall (active partners)</td>
        <td>${fmtNum(o10)} (${fmtPct((o10/overallBase)*100)})</td>
        <td>${fmtNum(o20)} (${fmtPct((o20/overallBase)*100)})</td>
        <td>${fmtNum(o30)} (${fmtPct((o30/overallBase)*100)})</td>
        <td>${fmtNum(o40)} (${fmtPct((o40/overallBase)*100)})</td>
      </tr>`);

    rows.push(rowHtml('Good partners', monthlyData.perf.good[idx] || 1, perfBase.good));
    rows.push(rowHtml('Average partners', monthlyData.perf.average[idx] || 1, perfBase.average));
    rows.push(rowHtml('Bad partners', monthlyData.perf.bad[idx] || 1, perfBase.bad));

    rows.push(rowHtml('Big partners', monthlyData.size.big[idx] || 1, sizeBase.big));
    rows.push(rowHtml('Mid partners', monthlyData.size.mid[idx] || 1, sizeBase.mid));
    rows.push(rowHtml('Small partners', monthlyData.size.small[idx] || 1, sizeBase.small));

    body.innerHTML = rows.join('');
  }


  function renderHighlights(idx){
    const ul = document.getElementById('monthlyHighlights');
    if (!ul) return;

    const month = monthlyData.months[idx];
    const tp = monthlyData.totalPartners[idx];
    const ap = monthlyData.activePartners[idx];
    const tt = monthlyData.totalTarget[idx];
    const as = monthlyData.avgScale[idx];

    const prevIdx = Math.max(0, idx - 1);
    const ttPrev = monthlyData.totalTarget[prevIdx] || tt;
    const apPrev = monthlyData.activePartners[prevIdx] || ap;
    const asPrev = monthlyData.avgScale[prevIdx] || as;

    const ttChg = (idx === 0) ? 0 : ((tt - ttPrev) / ttPrev) * 100;
    const apChg = (idx === 0) ? 0 : ((ap - apPrev) / apPrev) * 100;
    const asChg = (idx === 0) ? 0 : ((as - asPrev) / asPrev) * 100;

    const anyPct = monthlyData.willingPct.any[idx];
    const goodShare = (monthlyData.perf.good[idx] / tp) * 100;
    const badShare = (monthlyData.perf.bad[idx] / tp) * 100;

    const bullets = [
      `<strong>${month}:</strong> Total target ${fmtNum(tt)} (${ttChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(ttChg))} vs prior month).`,
      `Active partners ${fmtNum(ap)} (${apChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(apChg))}); average scale ${as.toFixed(1)} (${asChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(asChg))}).`,
      `Performance mix: Good ${fmtNum(monthlyData.perf.good[idx])} (${fmtPct(goodShare)}), Bad ${fmtNum(monthlyData.perf.bad[idx])} (${fmtPct(badShare)}).`,
      `Partner willingness: ${fmtPct(anyPct)} of active partners show target-increase intent (assumed for Aug–Dec).`
    ];

    ul.innerHTML = bullets.map(b => `<li>${b}</li>`).join('');
  }

  function updateMonthlyView(value){
        if (value === 'Feb-26') {
            const prevLabel = monthlyData.months[monthlyData.months.length - 2];
            const ap = 551;
            const tp = 643;
            const tt = 19365;
            const as = 35.1;
            const anyCnt = 153;
            const c20 = 32;
            const c30 = 16;
            const anyPct = (anyCnt / ap) * 100;
            const c20Pct = (c20 / ap) * 100;
            const c30Pct = (c30 / ap) * 100;

            document.getElementById('m_totalPartners').textContent = fmtNum(tp);
            document.getElementById('m_totalPartners_sub').textContent = `Feb-26 vs ${prevLabel}`;

            document.getElementById('m_activePartners').textContent = fmtNum(ap);
            document.getElementById('m_activePartners_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(11.8)} vs ${prevLabel}</span>`;

            document.getElementById('m_totalTarget').textContent = fmtNum(tt);
            document.getElementById('m_totalTarget_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(13.8)} vs ${prevLabel}</span>`;

            document.getElementById('m_avgScale').textContent = as.toFixed(1);
            document.getElementById('m_avgScale_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">↓ ${fmtPct(2.2)} vs ${prevLabel}</span>`;

            document.getElementById('m_incAny').textContent = fmtNum(anyCnt);
            document.getElementById('m_incAny_sub').textContent = `${fmtPct(anyPct)} of active partners`;

            document.getElementById('m_inc20').textContent = fmtNum(c20);
            document.getElementById('m_inc20_sub').textContent = `${fmtPct(c20Pct)} of active partners`;

            document.getElementById('m_inc30').textContent = fmtNum(c30);
            document.getElementById('m_inc30_sub').textContent = `${fmtPct(c30Pct)} of active partners`;

            document.getElementById('m_inc40').textContent = fmtPct(-27.8);
            document.getElementById('m_inc40_sub').innerHTML = `<span style="color: #dc2626; font-weight: 600;">vs ${prevLabel}</span>`;
            // Render highlights for Feb-26 (last month) before early return
            renderHighlights(monthlyData.months.length - 1);
            renderFactorsTable(monthlyData.months.length - 1);
            return;
        }
    const idx = (value === 'All') ? (monthlyData.months.length - 1) : safeIdx(value);
    const month = monthlyData.months[idx];
    const prevIdx = Math.max(0, idx - 1);

    // KPI: Total partners
    const tp = monthlyData.totalPartners[idx];
    document.getElementById('m_totalPartners').textContent = fmtNum(tp);
    document.getElementById('m_totalPartners_sub').textContent = (idx === 0) ? month : `${month} vs ${monthlyData.months[prevIdx]}`;

    // KPI: Active partners
    const ap = monthlyData.activePartners[idx];
    const apPrev = monthlyData.activePartners[prevIdx] || ap;
    const apChg = (idx === 0) ? 0 : ((ap - apPrev) / apPrev) * 100;
    document.getElementById('m_activePartners').textContent = fmtNum(ap);
    document.getElementById('m_activePartners_sub').innerHTML = `<span style="color: ${apChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${apChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(apChg))} vs ${monthlyData.months[prevIdx]}</span>`;

    // KPI: Total target
    const tt = monthlyData.totalTarget[idx];
    const ttPrev = monthlyData.totalTarget[prevIdx] || tt;
    const ttChg = (idx === 0) ? 0 : ((tt - ttPrev) / ttPrev) * 100;
    document.getElementById('m_totalTarget').textContent = fmtNum(tt);
    document.getElementById('m_totalTarget_sub').innerHTML = `<span style="color: ${ttChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${ttChg >= 0 ? '↑' : '↓'} ${fmtPct(Math.abs(ttChg))} vs ${monthlyData.months[prevIdx]}</span>`;

    // KPI: Avg scale
    const as = monthlyData.avgScale[idx];
    const asPrev = monthlyData.avgScale[prevIdx] || as;
    const asChg = (idx === 0) ? 0 : ((as - asPrev) / asPrev) * 100;
    document.getElementById('m_avgScale').textContent = as.toFixed(1);
    document.getElementById('m_avgScale_sub').innerHTML = `<span style="color: ${asChg >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">${asChg >= 0 ? '↑' : '↓'} ${Math.abs(asChg).toFixed(1)}% vs ${monthlyData.months[prevIdx]}</span>`;

    // Willingness KPIs (use active partners as base)
    const anyPct = monthlyData.willingPct.any[idx];
    const gt20Pct = monthlyData.willingPct.gt20[idx];
    const gt30Pct = monthlyData.willingPct.gt30[idx];
    const gt40Pct = monthlyData.willingPct.gt40[idx];

    const anyCnt = pctToCount(anyPct, ap);
    const c20 = pctToCount(gt20Pct, ap);
    const c30 = pctToCount(gt30Pct, ap);
    const c40 = pctToCount(gt40Pct, ap);

    document.getElementById('m_incAny').textContent = fmtNum(anyCnt);
    document.getElementById('m_incAny_sub').textContent = `${fmtPct(anyPct)} of active partners`;

    document.getElementById('m_inc20').textContent = fmtNum(c20);
    document.getElementById('m_inc20_sub').textContent = `${fmtPct(gt20Pct)} of active partners`;

    document.getElementById('m_inc30').textContent = fmtNum(c30);
    document.getElementById('m_inc30_sub').textContent = `${fmtPct(gt30Pct)} of active partners`;

    // MoM change KPI (partners with increase any)
    const momAny = (monthlyData.willingMoMAny && monthlyData.willingMoMAny[idx] !== null && monthlyData.willingMoMAny[idx] !== undefined)
      ? monthlyData.willingMoMAny[idx]
      : null;

    if (momAny === null || idx === 0) {
      document.getElementById('m_inc40').textContent = '—';
      document.getElementById('m_inc40_sub').textContent = 'Baseline month';
    } else {
      document.getElementById('m_inc40').textContent = `${momAny >= 0 ? '+' : ''}${Math.round(momAny)}%`;
    document.getElementById('m_inc40_sub').innerHTML = `<span style="color: ${momAny >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">vs ${monthlyData.months[prevIdx]}</span>`;
    }

    // Update charts if initialized
    function highlightPoint(chart){
      if (!chart) return;
      chart.data.datasets.forEach(ds => {
        if (Array.isArray(ds.data)) {
          ds.pointRadius = ds.data.map((_, i) => (i === idx ? 6 : 3));
        }
      });
      try { chart.update('none'); } catch(e) {}
    }
    highlightPoint(m_targetTrend);
        syncAvgScaleSelection(month);

    renderFactorsTable(idx);
    renderHighlights(idx);
  }

  function changeMonth(step){
    const sel = document.getElementById('monthSelect');
    if (!sel) return;

    if (sel.value === 'All') {
      sel.value = monthlyData.months[monthlyData.months.length - 1];
    }
    const idx = safeIdx(sel.value);
    const next = Math.min(Math.max(idx + step, 0), monthlyData.months.length - 1);
    sel.value = monthlyData.months[next];
    updateMonthlyView(sel.value);
  }

  function initMonthlyCharts(){
    if (chartsInited) return;
    const t1 = document.getElementById('monthlyTargetTrendChart');
    if (!t1) return;

    chartsInited = true;
    const months = monthlyData.months.slice();
    const trendMonths = months;
    const trendTotalTarget = monthlyData.totalTarget.slice();
    const trendTotalPartners = monthlyData.totalPartners.slice();

    // Charts are optional (if Chart.js fails to load, keep KPIs & tables working)
    if (typeof Chart === 'undefined') return;

    m_targetTrend = new Chart(t1.getContext('2d'), {
      type: 'line',
      data: {
        labels: trendMonths,
        datasets: [
          {
            label: 'Total Target',
            data: trendTotalTarget,
            tension: 0.4,
            borderColor: '#2563eb',
            backgroundColor: (function(){
              var g = t1.getContext('2d').createLinearGradient(0, 0, 0, t1.height || 300);
              g.addColorStop(0, 'rgba(59, 130, 246, 0.30)');
              g.addColorStop(1, 'rgba(59, 130, 246, 0.02)');
              return g;
            })(),
            fill: true,
            pointRadius: 6,
            pointHoverRadius: 10,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#2563eb',
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: '#3b82f6',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3,
            borderWidth: 3,
            yAxisID: 'y'
          },
          {
            label: 'Total Partners',
            data: trendTotalPartners,
            tension: 0.4,
            borderColor: '#059669',
            backgroundColor: (function(){
              var g = t1.getContext('2d').createLinearGradient(0, 0, 0, t1.height || 300);
              g.addColorStop(0, 'rgba(16, 185, 129, 0.25)');
              g.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
              return g;
            })(),
            fill: true,
            pointRadius: 6,
            pointHoverRadius: 10,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#059669',
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: '#10b981',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3,
            borderWidth: 3,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        layout: { padding: { top: 35, right: 15, left: 5 } },
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
          datalabels: {
            display: true,
            font: { weight: 'bold', size: 10 },
            anchor: 'end',
            offset: 6,
            backgroundColor: 'rgba(255,255,255,0.92)',
            borderRadius: 6,
            padding: { top: 2, bottom: 2, left: 5, right: 5 },
            clamp: true,
            clip: false,
            align: function(context) {
              // Stagger: Total Target labels on top, Total Partners labels on bottom
              return context.datasetIndex === 0 ? 'top' : 'bottom';
            },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              const dsIdx = context.datasetIndex;
              const arr = dsIdx === 0 ? trendTotalTarget : trendTotalPartners;
              if (idx === 0) return value.toLocaleString();
              const prev = arr[idx - 1];
              const mom = ((value - prev) / prev * 100);
              const sign = mom >= 0 ? '+' : '';
              return value.toLocaleString() + ' (' + sign + mom.toFixed(1) + '%)';
            },
            color: function(context) {
              const idx = context.dataIndex;
              const dsIdx = context.datasetIndex;
              const arr = dsIdx === 0 ? trendTotalTarget : trendTotalPartners;
              if (idx === 0) return dsIdx === 0 ? '#2563eb' : '#059669';
              const mom = ((arr[idx] - arr[idx-1]) / arr[idx-1] * 100);
              return mom >= 0 ? '#16a34a' : '#dc2626';
            }
          },
          tooltip: {
            enabled: false,
            external: function(context) {
              const tooltip = context.tooltip;
              const panel = document.getElementById('targetTrendInfo');
              if (!panel) return;
              if (!tooltip || tooltip.opacity === 0) {
                panel.innerHTML = 'Hover a month to see details.';
                return;
              }
              const idx = tooltip.dataPoints[0].dataIndex;
              const month = trendMonths[idx];
              const target = trendTotalTarget[idx];
              const partners = trendTotalPartners[idx];
              let html = '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">';
              html += '<span style="font-weight:700;font-size:14px;color:#1e40af;">\ud83d\udcc5 ' + month + '</span>';
              html += '<span style="font-size:12px;">Target: <b style="color:#2563eb;">' + target.toLocaleString() + '</b></span>';
              html += '<span style="font-size:12px;">Partners: <b style="color:#059669;">' + partners.toLocaleString() + '</b></span>';
              if (idx > 0) {
                const tMom = ((target - trendTotalTarget[idx-1]) / trendTotalTarget[idx-1] * 100);
                const pMom = ((partners - trendTotalPartners[idx-1]) / trendTotalPartners[idx-1] * 100);
                const tSign = tMom >= 0 ? '+' : '';
                const pSign = pMom >= 0 ? '+' : '';
                const tColor = tMom >= 0 ? '#16a34a' : '#dc2626';
                const pColor = pMom >= 0 ? '#16a34a' : '#dc2626';
                const tBg = tMom >= 0 ? '#dcfce7' : '#fee2e2';
                const pBg = pMom >= 0 ? '#dcfce7' : '#fee2e2';
                const tArrow = tMom >= 0 ? '\u2191' : '\u2193';
                const pArrow = pMom >= 0 ? '\u2191' : '\u2193';
                html += '<span style="background:' + tBg + ';color:' + tColor + ';padding:3px 8px;border-radius:4px;font-weight:700;font-size:11px;">' + tArrow + ' Target MoM: ' + tSign + tMom.toFixed(1) + '%</span>';
                html += '<span style="background:' + pBg + ';color:' + pColor + ';padding:3px 8px;border-radius:4px;font-weight:700;font-size:11px;">' + pArrow + ' Partners MoM: ' + pSign + pMom.toFixed(1) + '%</span>';
              } else {
                html += '<span style="background:#e0f2fe;color:#1e40af;padding:3px 8px;border-radius:4px;font-weight:600;font-size:11px;">Baseline</span>';
              }
              html += '</div>';
              panel.innerHTML = html;
            }
          },
          hoverLine: { color: 'rgba(37, 99, 235, 0.2)' }
        },
        scales: {
          x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
          y: {
            type: 'linear',
            position: 'left',
            beginAtZero: false,
            min: 18000,
            max: 38000,
            title: { display: true, text: 'Total Target', color: '#2563eb', font: { weight: 'bold' } },
            ticks: { color: '#2563eb' },
            grid: { color: 'rgba(59, 130, 246, 0.08)' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: false,
            min: 400,
            max: 900,
            title: { display: true, text: 'Total Partners', color: '#059669', font: { weight: 'bold' } },
            ticks: { color: '#059669' },
            grid: { drawOnChartArea: false }
          }
        }
      },
      plugins: [ChartDataLabels, hoverLinePlugin]
    });

    // Advanced Average Scale Overview Chart with MoM%
    const avgScaleOverviewCanvas = document.getElementById('monthlyAvgScaleChart');
    if (avgScaleOverviewCanvas) {
      const avgScaleValues = monthlyData.avgScale.slice();
      const avgScaleMoM = avgScaleValues.map((v, i) => i === 0 ? null : ((v - avgScaleValues[i-1]) / avgScaleValues[i-1] * 100));
      const avgScaleCtx = avgScaleOverviewCanvas.getContext('2d');
      const avgScaleGrad = avgScaleCtx.createLinearGradient(0, 0, 0, avgScaleOverviewCanvas.height || 300);
      avgScaleGrad.addColorStop(0, 'rgba(139, 92, 246, 0.35)');
      avgScaleGrad.addColorStop(1, 'rgba(139, 92, 246, 0.03)');

      m_avgScale = new Chart(avgScaleCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Avg Scale (riders/partner)',
            data: avgScaleValues,
            borderColor: '#7c3aed',
            backgroundColor: avgScaleGrad,
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 10,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#7c3aed',
            pointBorderWidth: 2.5,
            pointHoverBackgroundColor: '#8b5cf6',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          layout: { padding: { top: 30, right: 20, left: 10 } },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
            datalabels: {
              display: true,
              font: { weight: 'bold', size: 11 },
              anchor: 'end',
              align: function(context) {
                return context.dataIndex === 0 ? 'right' : 'top';
              },
              offset: 6,
              backgroundColor: 'rgba(255,255,255,0.92)',
              borderRadius: 6,
              padding: { top: 3, bottom: 3, left: 6, right: 6 },
              clamp: true,
              clip: false,
              formatter: function(value, context) {
                const idx = context.dataIndex;
                if (idx === 0) return value.toFixed(1);
                const mom = avgScaleMoM[idx];
                const sign = mom >= 0 ? '+' : '';
                return value.toFixed(1) + '  (' + sign + mom.toFixed(1) + '%)';
              },
              color: function(context) {
                const idx = context.dataIndex;
                if (idx === 0) return '#7c3aed';
                const mom = avgScaleMoM[idx];
                return mom >= 0 ? '#16a34a' : '#dc2626';
              }
            },
            tooltip: {
              enabled: false,
              external: function(context) {
                const tooltip = context.tooltip;
                const panel = document.getElementById('avgScaleOverviewInfo');
                if (!panel) return;
                if (!tooltip || tooltip.opacity === 0) {
                  panel.innerHTML = 'Hover a month to see details.';
                  return;
                }
                const idx = tooltip.dataPoints[0].dataIndex;
                const val = avgScaleValues[idx];
                const month = months[idx];
                let html = '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">';
                html += '<span style="font-weight:700;font-size:14px;color:#7c3aed;">📅 ' + month + '</span>';
                html += '<span style="font-size:13px;">Avg Scale: <b style="color:#7c3aed;">' + val.toFixed(1) + '</b> riders/partner</span>';
                if (idx > 0) {
                  const mom = avgScaleMoM[idx];
                  const sign = mom >= 0 ? '+' : '';
                  const momColor = mom >= 0 ? '#16a34a' : '#dc2626';
                  const momBg = mom >= 0 ? '#dcfce7' : '#fee2e2';
                  const arrow = mom >= 0 ? '↑' : '↓';
                  html += '<span style="background:' + momBg + ';color:' + momColor + ';padding:3px 8px;border-radius:4px;font-weight:700;font-size:12px;">' + arrow + ' MoM: ' + sign + mom.toFixed(1) + '%</span>';
                  const diff = (val - avgScaleValues[idx-1]).toFixed(1);
                  html += '<span style="font-size:12px;color:#6b7280;">(' + (diff >= 0 ? '+' : '') + diff + ' vs ' + months[idx-1] + ')</span>';
                } else {
                  html += '<span style="background:#f3e8ff;color:#7c3aed;padding:3px 8px;border-radius:4px;font-weight:600;font-size:12px;">Baseline</span>';
                }
                html += '</div>';
                panel.innerHTML = html;
              }
            },
            hoverLine: { color: 'rgba(124, 58, 237, 0.25)' }
          },
          scales: {
            x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Avg Riders per Partner', color: '#111827', font: { weight: '600' } },
              ticks: { color: '#111827' },
              grid: { color: 'rgba(0,0,0,0.06)' }
            }
          }
        },
        plugins: [ChartDataLabels, hoverLinePlugin]
      });
    }

    m_perfMix = new Chart(document.getElementById('monthlyPerformanceMixChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          { label: 'Good', data: monthlyData.perf.good.slice(), stack: 'p', backgroundColor: '#10b981', yAxisID: 'y' },
          { label: 'Average', data: monthlyData.perf.average.slice(), stack: 'p', backgroundColor: '#f59e0b', yAxisID: 'y' },
          { label: 'Bad', data: monthlyData.perf.bad.slice(), stack: 'p', backgroundColor: '#ef4444', yAxisID: 'y' },
          {
            label: 'Total Partners Trend',
            data: monthlyData.perf.good.map((v, i) => v + monthlyData.perf.average[i] + monthlyData.perf.bad[i]),
            type: 'line',
            borderColor: '#000',
            backgroundColor: 'transparent',
            borderWidth: 4,
            pointRadius: 8,
            pointBackgroundColor: '#000',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            yAxisID: 'y1',
            tension: 0.3,
            datalabels: {
              display: true,
              color: '#000',
              font: { weight: 'bold', size: 9 },
              formatter: (value) => value.toLocaleString(),
              anchor: 'end',
              align: 'top',
              offset: 8
            }
          }
        ]
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { position: 'bottom' }, 
          datalabels: { 
            display: true,
            color: '#fff',
            font: { weight: 'bold', size: 9 },
            formatter: function(value, context) {
              if (context.datasetIndex === 3) return '';
              const total = monthlyData.perf.good[context.dataIndex] + monthlyData.perf.average[context.dataIndex] + monthlyData.perf.bad[context.dataIndex];
              const pct = ((value / total) * 100).toFixed(0);
              return value + ' (' + pct + '%)';
            }
          } 
        }, 
        scales: { 
          x: { stacked: true }, 
          y: { 
            position: 'left',
            stacked: true, 
            beginAtZero: true 
          },
          y1: {
            position: 'right',
            beginAtZero: true,
            grid: { drawOnChartArea: false }
          }
        } 
      },
      plugins: [ChartDataLabels]
    });

    m_sizeMix = new Chart(document.getElementById('monthlySizeMixChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          { label: 'Big', data: monthlyData.size.big.slice(), stack: 's', backgroundColor: '#3b82f6', yAxisID: 'y' },
          { label: 'Mid', data: monthlyData.size.mid.slice(), stack: 's', backgroundColor: '#8b5cf6', yAxisID: 'y' },
          { label: 'Small', data: monthlyData.size.small.slice(), stack: 's', backgroundColor: '#06b6d4', yAxisID: 'y' },
          {
            label: 'Total Partners Trend',
            data: monthlyData.size.big.map((v, i) => v + monthlyData.size.mid[i] + monthlyData.size.small[i]),
            type: 'line',
            borderColor: '#000',
            backgroundColor: 'transparent',
            borderWidth: 4,
            pointRadius: 8,
            pointBackgroundColor: '#000',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            yAxisID: 'y1',
            tension: 0.3,
            datalabels: {
              display: true,
              color: '#000',
              font: { weight: 'bold', size: 10 },
              formatter: (value) => value.toLocaleString(),
              anchor: 'end',
              align: 'top',
              offset: 5
            }
          }
        ]
      },
      options: { 
        responsive: true, 
        plugins: { 
          legend: { position: 'bottom' }, 
          datalabels: { 
            display: true,
            color: '#fff',
            font: { weight: 'bold', size: 9 },
            formatter: function(value, context) {
              if (context.datasetIndex === 3) return '';
              const total = monthlyData.size.big[context.dataIndex] + monthlyData.size.mid[context.dataIndex] + monthlyData.size.small[context.dataIndex];
              const pct = ((value / total) * 100).toFixed(0);
              return value + ' (' + pct + '%)';
            }
          } 
        }, 
        scales: { 
          x: { stacked: true }, 
          y: { 
            position: 'left',
            stacked: true, 
            beginAtZero: true 
          },
          y1: {
            position: 'right',
            beginAtZero: true,
            grid: { drawOnChartArea: false }
          }
        } 
      },
      plugins: [ChartDataLabels]
    });

    // Total Riders by Performance Level (with percentages)
    const ridersGood = [11229, 11083, 11418, 11019, 12349, 10192];
    const ridersAverage = [12898, 14595, 14151, 9258, 8330, 8414];
    const ridersBad = [5090, 5501, 6449, 2879, 1534, 370];
    const ridersTotal = ridersGood.map((v, i) => v + ridersAverage[i] + ridersBad[i]);
    const ridersPctGood = ridersGood.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));
    const ridersPctAverage = ridersAverage.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));
    const ridersPctBad = ridersBad.map((v, i) => ((v / ridersTotal[i]) * 100).toFixed(1));

    m_ridersPerfMix = new Chart(document.getElementById('monthlyRidersPerformanceMixChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          { 
            label: 'Good', 
            data: ridersGood, 
            backgroundColor: '#10b981', 
            borderColor: '#059669',
            borderWidth: 1,
            stack: 'riders',
            yAxisID: 'y'
          },
          { 
            label: 'Average', 
            data: ridersAverage, 
            backgroundColor: '#fbbf24', 
            borderColor: '#f59e0b',
            borderWidth: 1,
            stack: 'riders',
            yAxisID: 'y'
          },
          { 
            label: 'Bad', 
            data: ridersBad, 
            backgroundColor: '#ef4444', 
            borderColor: '#dc2626',
            borderWidth: 1,
            stack: 'riders',
            yAxisID: 'y'
          },
          {
            label: 'Total Riders Trend',
            data: ridersTotal,
            type: 'line',
            borderColor: '#000',
            backgroundColor: 'transparent',
            borderWidth: 4,
            pointRadius: 8,
            pointBackgroundColor: '#000',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            yAxisID: 'y1',
            tension: 0.3,
            datalabels: {
              display: true,
              color: '#000',
              font: { weight: 'bold', size: 9 },
              formatter: (value) => value.toLocaleString(),
              anchor: 'end',
              align: 'top',
              offset: 8
            }
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { position: 'bottom' },
          datalabels: {
            display: true,
            color: '#fff',
            font: { weight: 'bold', size: 9 },
            formatter: function(value, context) {
              if (context.datasetIndex === 3) return '';
              const datasetIndex = context.datasetIndex;
              const dataIndex = context.dataIndex;
              let pct;
              if (datasetIndex === 0) pct = ridersPctGood[dataIndex];
              else if (datasetIndex === 1) pct = ridersPctAverage[dataIndex];
              else pct = ridersPctBad[dataIndex];
              return value.toLocaleString() + ' (' + pct + '%)';
            },
            align: 'center',
            anchor: 'center',
            clipping: false,
            lineHeight: 1.2
          }
        },
        scales: { 
          x: { stacked: true }, 
          y: { 
            type: 'linear',
            display: true,
            position: 'left',
            stacked: true, 
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            },
            grid: { drawOnChartArea: false }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Monthly Riders Size Mix Chart
    const ridersBig = [7197, 7906, 8642, 6741, 4938, 5351];
    const ridersMid = [15978, 17709, 17253, 12352, 10598, 9982];
    const ridersSmall = [6042, 5564, 6123, 4063, 6677, 3643];

    const ridersTotalSize = ridersBig.map((v, i) => v + ridersMid[i] + ridersSmall[i]);
    const ridersPctBig = ridersBig.map((v, i) => ((v / ridersTotalSize[i]) * 100).toFixed(1));
    const ridersPctMid = ridersMid.map((v, i) => ((v / ridersTotalSize[i]) * 100).toFixed(1));
    const ridersPctSmall = ridersSmall.map((v, i) => ((v / ridersTotalSize[i]) * 100).toFixed(1));

    m_ridersSizeMix = new Chart(document.getElementById('monthlyRidersSizeMixChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Big',
            data: ridersBig,
            backgroundColor: '#3b82f6',
            stack: 'size',
            yAxisID: 'y'
          },
          {
            label: 'Mid',
            data: ridersMid,
            backgroundColor: '#8b5cf6',
            stack: 'size',
            yAxisID: 'y'
          },
          {
            label: 'Small',
            data: ridersSmall,
            backgroundColor: '#06b6d4',
            stack: 'size',
            yAxisID: 'y'
          },
          {
            label: 'Total Riders Trend',
            data: ridersTotalSize,
            type: 'line',
            borderColor: '#000',
            backgroundColor: 'transparent',
            borderWidth: 4,
            pointRadius: 8,
            pointBackgroundColor: '#000',
            pointBorderColor: '#fff',
            pointBorderWidth: 3,
            yAxisID: 'y1',
            tension: 0.3,
            datalabels: {
              display: true,
              color: '#000',
              font: { weight: 'bold', size: 9 },
              formatter: (value) => value.toLocaleString(),
              anchor: 'end',
              align: 'top',
              offset: 8
            }
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' },
          datalabels: {
            color: 'white',
            font: { weight: 'bold', size: 9 },
            formatter: (value, context) => {
              if (context.datasetIndex === 3) return '';
              const datasetIndex = context.datasetIndex;
              const dataIndex = context.dataIndex;
              let pct;
              if (datasetIndex === 0) pct = ridersPctBig[dataIndex];
              else if (datasetIndex === 1) pct = ridersPctMid[dataIndex];
              else pct = ridersPctSmall[dataIndex];
              return value.toLocaleString() + ' (' + pct + '%)';
            },
            align: 'center',
            anchor: 'center',
            clipping: false,
            lineHeight: 1.2
          }
        },
        scales: { 
          x: { stacked: true }, 
          y: { 
            type: 'linear',
            display: true,
            position: 'left',
            stacked: true, 
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            },
            grid: { drawOnChartArea: false }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

        const mom = trendTotalTarget.map((t, i) => {
      if (i === 0) return null; // baseline month
            const prev = trendTotalTarget[i-1];
            const cur  = trendTotalTarget[i];
      if (!prev) return null;
      return ((cur - prev) / prev) * 100;
    });

    const momEl = document.getElementById('monthlyMoMChangeChartNew') || document.getElementById('monthlyMoMChangeChart');
    if (momEl) {
      const bg = mom.map(v => (v === null) ? '#9ca3af' : (v >= 0 ? '#16a34a' : '#dc2626'));
      const br = mom.map(v => (v === null) ? '#6b7280' : (v >= 0 ? '#15803d' : '#b91c1c'));
            m_mom = new Chart(momEl.getContext('2d'), {
        type: 'bar',
                data: { labels: trendMonths, datasets: [{ label: 'MoM %', data: mom, backgroundColor: bg, borderColor: br, borderWidth: 2 }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: { 
              display: true,
              color: '#111827',
              font: { weight: 'bold', size: 11 },
              formatter: function(value) {
                if (value === null) return '';
                return value.toFixed(1) + '%';
              },
              anchor: function(context) {
                return context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start';
              },
              align: function(context) {
                return context.dataset.data[context.dataIndex] >= 0 ? 'top' : 'bottom';
              }
            },
            tooltip: { callbacks: { label: (ctx) => (ctx.parsed.y == null ? 'Baseline month' : ('MoM Change: ' + ctx.parsed.y.toFixed(2) + '%')) } }
          },
          scales: {
            x: { ticks: { color: '#111827' } },
            y: { ticks: { color: '#111827', callback: (v) => v + '%' } }
          }
        },
        plugins: [ChartDataLabels]
      });
    } else {
      m_mom = null;
    }

    // Average Scale by Performance Level
    const perfScaleCanvas = document.getElementById('avgScalePerfChart');
    if (perfScaleCanvas) {
      m_avgScalePerf = new Chart(perfScaleCanvas.getContext('2d'), {
        type: 'line',
        data: {
                    labels: avgScalePerfData.labels,
          datasets: avgScalePerfData.series.map(s => makeLineDataset(s, perfScaleCanvas))
        },
        options: {
          responsive: true,
                    interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
            datalabels: {
              display: true,
              color: function(ctx){ return ctx.dataset.borderColor; },
              font: { weight: 'bold', size: 11 },
              formatter: function(value) { return value; },
              anchor: 'end',
              align: 'top',
              offset: 4,
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderRadius: 4,
              padding: { top: 2, bottom: 2, left: 4, right: 4 }
                        },
                        tooltip: {
                            enabled: false,
                            external: makeAvgScaleTooltip('avgScalePerfInfo', avgScalePerfData)
                        },
                        hoverLine: { color: 'rgba(30, 64, 175, 0.25)' }
          },
          scales: {
            x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Avg Riders per Partner', color: '#111827', font: { weight: '600' } },
              ticks: { color: '#111827' },
              grid: { color: 'rgba(0,0,0,0.06)' }
            }
          }
        },
                plugins: [ChartDataLabels, hoverLinePlugin]
      });
    }

    // Average Scale by Size Level
    const sizeScaleCanvas = document.getElementById('avgScaleSizeChart');
    if (sizeScaleCanvas) {
      m_avgScaleSize = new Chart(sizeScaleCanvas.getContext('2d'), {
        type: 'line',
        data: {
                    labels: avgScaleSizeData.labels,
          datasets: avgScaleSizeData.series.map(s => makeLineDataset(s, sizeScaleCanvas))
        },
        options: {
          responsive: true,
                    interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12, weight: '600' } } },
            datalabels: {
              display: true,
              color: function(ctx){ return ctx.dataset.borderColor; },
              font: { weight: 'bold', size: 11 },
              formatter: function(value) { return value; },
              anchor: 'end',
              align: 'top',
              offset: 4,
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderRadius: 4,
              padding: { top: 2, bottom: 2, left: 4, right: 4 }
                        },
                        tooltip: {
                            enabled: false,
                            external: makeAvgScaleTooltip('avgScaleSizeInfo', avgScaleSizeData)
                        },
                        hoverLine: { color: 'rgba(30, 64, 175, 0.25)' }
          },
          scales: {
            x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#374151', font: { weight: '600' } } },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Avg Riders per Partner', color: '#111827', font: { weight: '600' } },
              ticks: { color: '#111827' },
              grid: { color: 'rgba(0,0,0,0.06)' }
            }
          }
        },
                plugins: [ChartDataLabels, hoverLinePlugin]
      });
    }

        if (!avgScaleToggleInited) {
            setupAvgScaleToggle('avgScalePerfToggle', 'perf');
            setupAvgScaleToggle('avgScaleSizeToggle', 'size');
            avgScaleToggleInited = true;
            setAvgScaleView('perf', 'trend');
            setAvgScaleView('size', 'trend');
        }

    // Monthly Willing vs Not-Willing Partners
    const willingCanvas = document.getElementById('willingVsNotWillingChart');
    if (willingCanvas) {
      const willingMonths = ['Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
      const willingPartners = [213, 259, 81, 201, 130];
      const notWillingPartners = [356, 381, 554, 413, 398];

      m_willingVsNotWilling = new Chart(willingCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: willingMonths,
          datasets: [
            {
              label: 'Not-Willing (≥0)',
              data: notWillingPartners,
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 1
            },
            {
              label: 'Willing (>0)',
              data: willingPartners,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            datalabels: {
              display: true,
              color: '#fff',
              font: { weight: 'bold', size: 11 },
              formatter: function(value) { return value; },
              anchor: 'center',
              align: 'center'
            }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Partner Willingness Trend (%)
    const trendCanvas = document.getElementById('willingnessTrendChart');
    if (trendCanvas) {
      const trendMonths = ['Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
      const willingPct = [37.4, 40.5, 12.8, 32.7, 24.6];
      const notWillingPct = [62.6, 59.5, 87.2, 67.3, 75.4];

      m_willingnessTrend = new Chart(trendCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: trendMonths,
          datasets: [
            {
              label: 'Willing %',
              data: willingPct,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              fill: true,
              pointRadius: 6,
              pointBackgroundColor: '#10b981',
              tension: 0.4
            },
            {
              label: 'Not-Willing %',
              data: notWillingPct,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              pointRadius: 6,
              pointBackgroundColor: '#ef4444',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            datalabels: {
              display: true,
              color: '#111827',
              font: { weight: 'bold', size: 10 },
              formatter: function(value) { return value.toFixed(1) + '%'; },
              anchor: 'end',
              align: 'top',
              offset: 5
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: 'Percentage (%)', color: '#111827' },
              ticks: { color: '#111827', callback: (v) => v + '%' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Growth Category Breakdown (Increase Slabs)
    const gcCanvas = document.getElementById('growthCategoryChart');
    if (gcCanvas) {
      const gcMonths = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
      const gc1_10 = [42, 60, 73, 22, 79, 46];
      const gc10_20 = [63, 60, 75, 23, 58, 52];
      const gc20_30 = [40, 29, 31, 11, 28, 16];
      const gc30plus = [54, 64, 80, 25, 36, 16];
      const gcTotal = [199, 213, 259, 81, 201, 130];

      m_growthCategory = new Chart(gcCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: gcMonths,
          datasets: [
            {
              label: '≥1% - ≤10%',
              data: gc1_10,
              backgroundColor: '#3b82f6',
              borderColor: '#2563eb',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '>10% - ≤20%',
              data: gc10_20,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '>20% - ≤30%',
              data: gc20_30,
              backgroundColor: '#f59e0b',
              borderColor: '#d97706',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '>30%',
              data: gc30plus,
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Total Increase Trend',
              data: gcTotal,
              type: 'line',
              borderColor: '#111827',
              backgroundColor: 'rgba(17, 24, 39, 0)',
              borderWidth: 3,
              pointRadius: 6,
              pointBackgroundColor: '#111827',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            datalabels: {
              display: true,
              color: function(context) {
                return context.datasetIndex === 4 ? '#111827' : '#ffffff';
              },
              font: { weight: 'bold', size: 11 },
              formatter: function(value) {
                return value;
              },
              anchor: function(context) {
                return context.datasetIndex === 4 ? 'end' : 'center';
              },
              align: function(context) {
                return context.datasetIndex === 4 ? 'top' : 'center';
              },
              offset: function(context) {
                return context.datasetIndex === 4 ? 4 : 0;
              }
            }
          },
          scales: {
            x: { stacked: false },
            y: {
              stacked: false,
              beginAtZero: true,
              title: { display: true, text: 'Partners (Bars)', color: '#111827' },
              ticks: { color: '#111827' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              min: 50,
              max: 300,
              title: { display: true, text: 'Total Increase (Line)', color: '#111827' },
              ticks: { color: '#111827' },
              grid: { drawOnChartArea: false }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Growth Category Breakdown (Decrease Slabs)
    const dcCanvas = document.getElementById('decreaseCategoryChart');
    if (dcCanvas) {
      const dcMonths = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
      const dc1_10 = [17, 39, 40, 52, 64, 84];
      const dc10_20 = [38, 56, 64, 108, 77, 98];
      const dc20_30 = [21, 26, 43, 83, 42, 50];
      const dc30plus = [48, 40, 41, 215, 56, 52];
      const dcTotal = [124, 161, 188, 458, 239, 284];

      m_decreaseCategory = new Chart(dcCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: dcMonths,
          datasets: [
            {
              label: '≥-10% - ≤-1%',
              data: dc1_10,
              backgroundColor: '#fcd34d',
              borderColor: '#f59e0b',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '>-20% - ≤-11%',
              data: dc10_20,
              backgroundColor: '#fed7aa',
              borderColor: '#f97316',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '>-30% - ≤-21%',
              data: dc20_30,
              backgroundColor: '#fca5a5',
              borderColor: '#f87171',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: '<-30%',
              data: dc30plus,
              backgroundColor: '#dc2626',
              borderColor: '#991b1b',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Total Decrease Trend',
              data: dcTotal,
              type: 'line',
              borderColor: '#111827',
              backgroundColor: 'rgba(17, 24, 39, 0)',
              borderWidth: 3,
              pointRadius: 6,
              pointBackgroundColor: '#111827',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            datalabels: {
              display: true,
              color: function(context) {
                return context.datasetIndex === 4 ? '#111827' : '#ffffff';
              },
              font: { weight: 'bold', size: 11 },
              formatter: function(value) {
                return value;
              },
              anchor: function(context) {
                return context.datasetIndex === 4 ? 'end' : 'center';
              },
              align: function(context) {
                return context.datasetIndex === 4 ? 'top' : 'center';
              },
              offset: function(context) {
                return context.datasetIndex === 4 ? 4 : 0;
              }
            }
          },
          scales: {
            x: { stacked: false },
            y: {
              stacked: false,
              beginAtZero: true,
              title: { display: true, text: 'Partners (Bars)', color: '#111827' },
              ticks: { color: '#111827' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              beginAtZero: true,
              min: 0,
              max: 550,
              title: { display: true, text: 'Total Decrease (Line)', color: '#111827' },
              ticks: { color: '#111827' },
              grid: { drawOnChartArea: false }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    window.monthlyCharts = [m_targetTrend, m_avgScale, m_perfMix, m_sizeMix].concat(m_mom ? [m_mom] : []);
  }

  function initMonthlyInsights(){
    // Ensure elements exist
    const sel = document.getElementById('monthSelect');
    if (!sel) return;

    // Init charts (safe)
    try { initMonthlyCharts(); } catch(e) { console.error('Monthly charts init error:', e); }

    // Default month
    if (!sel.value || sel.value === 'All') sel.value = 'Feb-26';

    // Render KPIs/tables
    try { updateMonthlyView(sel.value); } catch(e) { console.error('Monthly view update error:', e); }
  }

  // Expose globals for inline handlers
  window.updateMonthlyView = updateMonthlyView;
  window.changeMonth = changeMonth;
  window.initMonthlyInsights = initMonthlyInsights;

  // Auto-init on load + when user switches to tab
  document.addEventListener('DOMContentLoaded', function(){
    initMonthlyInsights();
  });

  // If switchTab exists, wrap it to ensure monthly init on first open (no layout changes)
  if (typeof window.switchTab === 'function' && !window.__monthlySwitchWrapped) {
    window.__monthlySwitchWrapped = true;
    const _orig = window.switchTab;
    window.switchTab = function(tabName, el){
      _orig(tabName, el);
      if (tabName === 'monthly') {
        setTimeout(initMonthlyInsights, 30);
        // resize charts when tab becomes visible
        setTimeout(function(){
          if (Array.isArray(window.monthlyCharts)) {
            window.monthlyCharts.forEach(c => { try { c.resize(); } catch(e) {} });
          }
          // Also init vehicle type charts
          setTimeout(initVehicleMonthlyCharts, 50);
        }, 80);
      }
    };
  }
})();

// ==========================================
// VEHICLE TYPE MONTHLY INSIGHTS SECTION
// ==========================================
(function() {
  // Vehicle Type Monthly Data
  const vehicleMonthlyData = {
        months: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
        cars: [27599, 28372, 28257, 18845, 17441, 14443],
        bikes: [5194, 5634, 6580, 5337, 5012, 4922],
    // Percentages pre-calculated
        carsPct: [84.2, 83.4, 81.1, 77.9, 77.7, 74.6],
        bikesPct: [15.8, 16.6, 18.9, 22.1, 22.3, 25.4]
  };

  // City-level data
  const cityVehicleData = {
        'Riyadh': { tier: 'T1', cars: [12259, 12453, 12544, 8545, 8103, 6701], bikes: [1827, 1999, 2500, 2167, 1925, 1960] },
        'Jeddah': { tier: 'T1', cars: [3793, 4347, 4361, 2850, 2467, 1900], bikes: [1362, 1534, 1922, 1650, 1627, 1554] },
        'Dammam': { tier: 'T1', cars: [3106, 3401, 3470, 2360, 2204, 1769], bikes: [494, 522, 572, 443, 437, 358] },
        'Madinah': { tier: 'T1', cars: [1647, 1605, 1602, 1063, 929, 841], bikes: [402, 392, 426, 315, 266, 290] },
        'Makkah': { tier: 'T1', cars: [1364, 1252, 1208, 834, 738, 540], bikes: [413, 508, 514, 331, 336, 395] },
        'Al Ahsa': { tier: 'T1', cars: [1129, 1109, 1048, 749, 712, 695], bikes: [179, 211, 231, 187, 146, 123] },
        'Al Kharj': { tier: 'T1', cars: [550, 590, 530, 386, 380, 347], bikes: [0, 0, 0, 0, 0, 0] },
        'Abha': { tier: 'T2', cars: [689, 640, 606, 339, 316, 279], bikes: [40, 38, 21, 15, 23, 18] },
        'Taif': { tier: 'T2', cars: [640, 534, 551, 311, 277, 204], bikes: [115, 117, 102, 78, 68, 88] },
        'Buraydah': { tier: 'T2', cars: [420, 456, 404, 278, 232, 218], bikes: [117, 82, 81, 32, 64, 35] },
        'Jubail': { tier: 'T2', cars: [357, 394, 370, 255, 224, 210], bikes: [93, 77, 62, 20, 20, 20] },
        'Tabuk': { tier: 'T2', cars: [400, 410, 465, 248, 242, 186], bikes: [20, 0, 10, 10, 10, 16] },
        'Hail': { tier: 'T2', cars: [340, 334, 360, 208, 199, 186], bikes: [0, 0, 0, 0, 0, 0] },
        'Yanbu': { tier: 'T2', cars: [270, 263, 242, 155, 154, 128], bikes: [82, 50, 60, 55, 55, 43] },
        'Hafar Al Batin': { tier: 'T2', cars: [267, 263, 213, 100, 103, 97], bikes: [30, 44, 44, 24, 25, 12] },
        'Jazan': { tier: 'T2', cars: [168, 187, 158, 82, 85, 64], bikes: [20, 25, 15, 10, 10, 10] },
        'Najran': { tier: 'T2', cars: [200, 134, 125, 82, 76, 78], bikes: [0, 35, 20, 0, 0, 0] }
  };

  const t1Cities = ['Riyadh', 'Jeddah', 'Dammam', 'Madinah', 'Makkah', 'Al Ahsa', 'Al Kharj'];
  const t2Cities = ['Abha', 'Taif', 'Buraydah', 'Jubail', 'Tabuk', 'Hail', 'Yanbu', 'Hafar Al Batin', 'Jazan', 'Najran'];

  let vehicleMonthlyChart = null;
  let vehicleCityChart = null;
  let vehicleT1Chart = null;
  let vehicleT2Chart = null;
  let currentVehicleView = 'monthly';
  let currentCityLevel = 'all';
  let currentCity = 'all';
  let currentVehicleMonthlyTrend = 'combined';

  // Plugin to show trend line totals with MoM % (red for decline) - works for all monthly charts
  const vehicleTrendLabelsPlugin = {
    id: 'vehicleTrendLabels',
    afterDatasetsDraw: function(chart) {
      const ctx = chart.ctx;
      const labels = chart.data.labels;
      
      // Check if this is a monthly chart (labels are EXACTLY the month names)
            const monthLabels = ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'];
            const isMonthlyChart = labels && labels.length === 6 && 
        JSON.stringify(labels) === JSON.stringify(monthLabels);
      
      chart.data.datasets.forEach((dataset, i) => {
        if (dataset.type === 'line' && dataset.data) {
          const meta = chart.getDatasetMeta(i);
          const lineData = dataset.data;
          
          meta.data.forEach((point, index) => {
            const value = lineData[index];
            if (value !== null && value !== undefined) {
              ctx.save();
              ctx.textAlign = 'center';
              ctx.font = 'bold 10px Arial';
              
              // Calculate MoM only for monthly charts
              let mom = null;
              if (isMonthlyChart && index > 0 && lineData[index-1] > 0) {
                mom = ((value - lineData[index-1]) / lineData[index-1] * 100);
              }
              
              // Determine base color
              let baseColor = '#111827';
              if (currentVehicleMonthlyTrend === 'cars') baseColor = '#1e40af';
              else if (currentVehicleMonthlyTrend === 'bikes') baseColor = '#047857';
              
              // Build label text with MoM format for monthly charts
              let labelText = value.toLocaleString();
              let labelColor = baseColor;
              
              if (isMonthlyChart && mom !== null) {
                const sign = mom >= 0 ? '+' : '';
                labelText = value.toLocaleString() + ' (MoM ' + sign + mom.toFixed(1) + '%)';
                // Use red color when declining
                if (mom < 0) {
                  labelColor = '#dc2626';
                }
              }
              
              ctx.fillStyle = labelColor;
              ctx.fillText(labelText, point.x, point.y - 18);
              ctx.restore();
            }
          });
        }
      });
    }
  };

  function switchVehicleMonthlyView(view) {
    currentVehicleView = view;
    
    // Update button states
    document.querySelectorAll('.vehicle-monthly-view-btn').forEach(btn => {
      if (btn.getAttribute('data-view') === view) {
        btn.classList.add('active');
        btn.style.background = '#3b82f6';
        btn.style.color = 'white';
        btn.style.borderColor = '#3b82f6';
      } else {
        btn.classList.remove('active');
        btn.style.background = 'white';
        btn.style.color = '#6b7280';
        btn.style.borderColor = '#e5e7eb';
      }
    });

    // Toggle panels
    const monthlyPanel = document.getElementById('vehicleMonthlyViewPanel');
    const cityPanel = document.getElementById('vehicleCityViewPanel');
    
    if (view === 'monthly') {
      if (monthlyPanel) monthlyPanel.style.display = 'block';
      if (cityPanel) cityPanel.style.display = 'none';
      renderVehicleMonthlyChart();
    } else {
      if (monthlyPanel) monthlyPanel.style.display = 'none';
      if (cityPanel) cityPanel.style.display = 'block';
      filterVehicleCityLevel(currentCityLevel);
    }
  }

  // Switch between Cars/Bikes/Combined trend views in Monthly View
  function switchVehicleMonthlyTrend(trend) {
    currentVehicleMonthlyTrend = trend;
    
    // Update button states
    document.querySelectorAll('.vehicle-monthly-trend-btn').forEach(btn => {
      if (btn.getAttribute('data-trend') === trend) {
        btn.classList.add('active');
        btn.style.background = trend === 'cars' ? '#3b82f6' : trend === 'bikes' ? '#10b981' : '#8b5cf6';
        btn.style.color = 'white';
        btn.style.borderColor = trend === 'cars' ? '#3b82f6' : trend === 'bikes' ? '#10b981' : '#8b5cf6';
      } else {
        btn.classList.remove('active');
        btn.style.background = 'white';
        btn.style.color = '#6b7280';
        btn.style.borderColor = '#e5e7eb';
      }
    });

    renderVehicleMonthlyChart();
    updateVehicleMonthlyKpiCards(trend);
  }
  window.switchVehicleMonthlyTrend = switchVehicleMonthlyTrend;

  function updateVehicleMonthlyKpiCards(trend) {
    const container = document.getElementById('vehicleMonthlyKpiCards');
    if (!container) return;

    const cars = vehicleMonthlyData.cars;
    const bikes = vehicleMonthlyData.bikes;
    const months = vehicleMonthlyData.months;
    const totals = cars.map((c, i) => c + bikes[i]);
    const lastIdx = cars.length - 1;
    const monthCount = cars.length;
    const momCount = monthCount - 1;
    
    const totalCars = cars.reduce((a, b) => a + b, 0);
    const totalBikes = bikes.reduce((a, b) => a + b, 0);
    const grandTotal = totalCars + totalBikes;
    
    // Calculate MoM changes
    const carsMoM = cars.map((v, i) => i === 0 ? 0 : ((v - cars[i-1]) / cars[i-1] * 100));
    const bikesMoM = bikes.map((v, i) => i === 0 ? 0 : ((v - bikes[i-1]) / bikes[i-1] * 100));
    
    // Find peak months
    const maxCarIdx = cars.indexOf(Math.max(...cars));
    const maxBikeIdx = bikes.indexOf(Math.max(...bikes));
    const minCarIdx = cars.indexOf(Math.min(...cars));
    const minBikeIdx = bikes.indexOf(Math.min(...bikes));
    
    // Calculate growth rates
    const carsGrowth = ((cars[lastIdx] - cars[0]) / cars[0] * 100).toFixed(1);
    const bikesGrowth = ((bikes[lastIdx] - bikes[0]) / bikes[0] * 100).toFixed(1);
    
    // Avg MoM (excluding first month)
    const avgCarsMoM = (carsMoM.slice(1).reduce((a, b) => a + b, 0) / momCount).toFixed(1);
    const avgBikesMoM = (bikesMoM.slice(1).reduce((a, b) => a + b, 0) / momCount).toFixed(1);

    if (trend === 'cars') {
      const avgCars = Math.round(totalCars/monthCount);
      container.innerHTML = `
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 11px; color: #1e40af; font-weight: 600;">🚗 Avg Cars (per month)</div>
          <div style="font-size: 22px; font-weight: 700; color: #1e40af;">${avgCars.toLocaleString()}</div>
          <div style="font-size: 11px; color: #3b82f6;">${((totalCars/grandTotal)*100).toFixed(1)}% of total capacity</div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalCars.toLocaleString()}</div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
          <div style="font-size: 11px; color: #92400e; font-weight: 600;">📈 Peak Month</div>
          <div style="font-size: 20px; font-weight: 700; color: #b45309;">${months[maxCarIdx]}</div>
          <div style="font-size: 11px; color: #f59e0b;">${cars[maxCarIdx].toLocaleString()} cars</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">highest monthly volume</div>
        </div>
        <div style="background: linear-gradient(135deg, ${parseFloat(carsGrowth) >= 0 ? '#d1fae5' : '#fee2e2'} 0%, ${parseFloat(carsGrowth) >= 0 ? '#a7f3d0' : '#fecaca'} 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid ${parseFloat(carsGrowth) >= 0 ? '#10b981' : '#ef4444'};">
                    <div style="font-size: 11px; color: ${parseFloat(carsGrowth) >= 0 ? '#065f46' : '#991b1b'}; font-weight: 600;">📊 Cars Growth (${months[0]}→${months[lastIdx]})</div>
          <div style="font-size: 20px; font-weight: 700; color: ${parseFloat(carsGrowth) >= 0 ? '#059669' : '#dc2626'};">${parseFloat(carsGrowth) >= 0 ? '+' : ''}${carsGrowth}%</div>
                    <div style="font-size: 11px; color: ${parseFloat(carsGrowth) >= 0 ? '#10b981' : '#ef4444'};">${cars[0].toLocaleString()} → ${cars[lastIdx].toLocaleString()}</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">avg MoM: ${parseFloat(avgCarsMoM) >= 0 ? '+' : ''}${avgCarsMoM}%</div>
        </div>
        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #ef4444;">
          <div style="font-size: 11px; color: #991b1b; font-weight: 600;">📉 Lowest Month</div>
          <div style="font-size: 20px; font-weight: 700; color: #dc2626;">${months[minCarIdx]}</div>
          <div style="font-size: 11px; color: #ef4444;">${cars[minCarIdx].toLocaleString()} cars</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">lowest monthly volume</div>
        </div>
      `;
    } else if (trend === 'bikes') {
      const avgBikes = Math.round(totalBikes/monthCount);
      container.innerHTML = `
        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #10b981;">
                    <div style="font-size: 11px; color: #065f46; font-weight: 600;">🏍️ Avg Bikes (per month)</div>
          <div style="font-size: 22px; font-weight: 700; color: #065f46;">${avgBikes.toLocaleString()}</div>
          <div style="font-size: 11px; color: #10b981;">${((totalBikes/grandTotal)*100).toFixed(1)}% of total capacity</div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalBikes.toLocaleString()}</div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
          <div style="font-size: 11px; color: #92400e; font-weight: 600;">📈 Peak Month</div>
          <div style="font-size: 20px; font-weight: 700; color: #b45309;">${months[maxBikeIdx]}</div>
          <div style="font-size: 11px; color: #f59e0b;">${bikes[maxBikeIdx].toLocaleString()} bikes</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">highest monthly volume</div>
        </div>
        <div style="background: linear-gradient(135deg, ${parseFloat(bikesGrowth) >= 0 ? '#d1fae5' : '#fee2e2'} 0%, ${parseFloat(bikesGrowth) >= 0 ? '#a7f3d0' : '#fecaca'} 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid ${parseFloat(bikesGrowth) >= 0 ? '#10b981' : '#ef4444'};">
                    <div style="font-size: 11px; color: ${parseFloat(bikesGrowth) >= 0 ? '#065f46' : '#991b1b'}; font-weight: 600;">📊 Bikes Growth (${months[0]}→${months[lastIdx]})</div>
          <div style="font-size: 20px; font-weight: 700; color: ${parseFloat(bikesGrowth) >= 0 ? '#059669' : '#dc2626'};">${parseFloat(bikesGrowth) >= 0 ? '+' : ''}${bikesGrowth}%</div>
                    <div style="font-size: 11px; color: ${parseFloat(bikesGrowth) >= 0 ? '#10b981' : '#ef4444'};">${bikes[0].toLocaleString()} → ${bikes[lastIdx].toLocaleString()}</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">avg MoM: ${parseFloat(avgBikesMoM) >= 0 ? '+' : ''}${avgBikesMoM}%</div>
        </div>
        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #ef4444;">
          <div style="font-size: 11px; color: #991b1b; font-weight: 600;">📉 Lowest Month</div>
          <div style="font-size: 20px; font-weight: 700; color: #dc2626;">${months[minBikeIdx]}</div>
          <div style="font-size: 11px; color: #ef4444;">${bikes[minBikeIdx].toLocaleString()} bikes</div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">lowest monthly volume</div>
        </div>
      `;
    } else {
      // Combined view - restore original KPI cards with Avg values
    const bikesGrowthVol = ((bikes[lastIdx] - bikes[0]) / bikes[0] * 100).toFixed(1);
      const bikesShareStart = ((bikes[0] / totals[0]) * 100).toFixed(1);
    const bikesShareEnd = ((bikes[lastIdx] / totals[lastIdx]) * 100).toFixed(1);
      const bikesShareGrowth = (parseFloat(bikesShareEnd) - parseFloat(bikesShareStart)).toFixed(1);
      const avgCars = Math.round(totalCars/monthCount);
      const avgBikes = Math.round(totalBikes/monthCount);
      const avgTotal = Math.round(grandTotal/monthCount);
      
      container.innerHTML = `
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 11px; color: #1e40af; font-weight: 600;">🚗 Avg Cars (per month)</div>
          <div style="font-size: 22px; font-weight: 700; color: #1e40af;">${avgCars.toLocaleString()}</div>
          <div style="font-size: 11px; color: #3b82f6;">${((totalCars/grandTotal)*100).toFixed(1)}% of total</div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalCars.toLocaleString()}</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #10b981;">
                    <div style="font-size: 11px; color: #065f46; font-weight: 600;">🏍️ Avg Bikes (per month)</div>
          <div style="font-size: 22px; font-weight: 700; color: #065f46;">${avgBikes.toLocaleString()}</div>
          <div style="font-size: 11px; color: #10b981;">${((totalBikes/grandTotal)*100).toFixed(1)}% of total</div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalBikes.toLocaleString()}</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 11px; color: #92400e; font-weight: 600;">📈 Bikes Share Growth (${months[0]}→${months[lastIdx]})</div>
          <div style="font-size: 20px; font-weight: 700; color: #b45309;">${parseFloat(bikesGrowthVol) >= 0 ? '+' : ''}${bikesGrowthVol}% <span style="font-size: 12px; font-weight: 600;">volume</span></div>
          <div style="font-size: 13px; color: #d97706; font-weight: 600;">${parseFloat(bikesShareGrowth) >= 0 ? '+' : ''}${bikesShareGrowth}pp <span style="font-size: 10px; font-weight: 500;">share (${bikesShareStart}%→${bikesShareEnd}%)</span></div>
          <div style="font-size: 9px; color: #64748b; margin-top: 2px;">avg growth/month: ${parseFloat(avgBikesMoM) >= 0 ? '+' : ''}${avgBikesMoM}%</div>
        </div>
        <div class="kpi-tooltip-wrapper" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #8b5cf6;">
          <div style="font-size: 11px; color: #5b21b6; font-weight: 600;">📊 Avg Total (per month)</div>
          <div style="font-size: 22px; font-weight: 700; color: #6d28d9;">${avgTotal.toLocaleString()}</div>
                    <div style="font-size: 11px; color: #8b5cf6;">${months[0]} - ${months[lastIdx]} 2026</div>
                    <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${grandTotal.toLocaleString()}</div>
        </div>
      `;
    }
  }

  function filterVehicleCityLevel(level) {
    currentCityLevel = level;
    
    // Update level button states
    document.querySelectorAll('.vehicle-city-level-monthly-btn').forEach(btn => {
      if (btn.getAttribute('data-level') === level) {
        btn.classList.add('active');
        btn.style.background = '#10b981';
        btn.style.color = 'white';
        btn.style.borderColor = '#10b981';
      } else {
        btn.classList.remove('active');
        btn.style.background = 'white';
        btn.style.color = '#6b7280';
        btn.style.borderColor = '#e5e7eb';
      }
    });

    // Show/hide individual city filter
    const cityFilter = document.getElementById('vehicleCityIndividualFilter');
    if (cityFilter) {
      cityFilter.style.display = (level === 'all' || level === 't1' || level === 't2') ? 'flex' : 'none';
    }

    // Toggle containers based on level
    const singleContainer = document.getElementById('vehicleSingleChartContainer');
    const t1t2Container = document.getElementById('vehicleT1T2Container');
    
    // Reset city selection when switching levels
    if (level === 't1vst2') {
      currentCity = 'all';
      if (singleContainer) singleContainer.style.display = 'none';
      if (t1t2Container) t1t2Container.style.display = 'grid';
      t1t2Container.style.gridTemplateColumns = '1fr 1fr';
      renderVehicleT1vsT2Chart();
      renderVehicleDataTable();
    } else {
      if (singleContainer) singleContainer.style.display = 'block';
      if (t1t2Container) t1t2Container.style.display = 'none';
      // Update city buttons visibility based on level
      document.querySelectorAll('.vehicle-city-monthly-btn').forEach(btn => {
        const city = btn.getAttribute('data-city');
        if (city === 'all') {
          btn.style.display = 'inline-block';
        } else if (level === 'all') {
          btn.style.display = 'inline-block';
        } else if (level === 't1' && t1Cities.includes(city)) {
          btn.style.display = 'inline-block';
        } else if (level === 't2' && t2Cities.includes(city)) {
          btn.style.display = 'inline-block';
        } else {
          btn.style.display = 'none';
        }
      });
      
      filterVehicleCity(currentCity);
    }
  }

  function destroyT1T2Charts() {
    if (vehicleT1Chart) { vehicleT1Chart.destroy(); vehicleT1Chart = null; }
    if (vehicleT2Chart) { vehicleT2Chart.destroy(); vehicleT2Chart = null; }
  }

  function filterVehicleCity(city) {
    currentCity = city;
    
    // Update city button states
    document.querySelectorAll('.vehicle-city-monthly-btn').forEach(btn => {
      if (btn.getAttribute('data-city') === city) {
        btn.classList.add('active');
        btn.style.background = '#8b5cf6';
        btn.style.color = 'white';
        btn.style.borderColor = '#8b5cf6';
      } else {
        btn.classList.remove('active');
        btn.style.background = 'white';
        btn.style.color = '#6b7280';
        btn.style.borderColor = '#e5e7eb';
      }
    });

    renderVehicleCityChart();
    renderVehicleDataTable();
  }

  function renderVehicleMonthlyChart() {
    const canvas = document.getElementById('vehicleMonthlyChart');
    if (!canvas) return;

    if (vehicleMonthlyChart) {
      vehicleMonthlyChart.destroy();
    }

    const cars = vehicleMonthlyData.cars;
    const bikes = vehicleMonthlyData.bikes;
    const months = vehicleMonthlyData.months;
    const totals = cars.map((c, i) => c + bikes[i]);
    
    // Calculate MoM changes
    const carsMoM = cars.map((v, i) => i === 0 ? null : ((v - cars[i-1]) / cars[i-1] * 100));
    const bikesMoM = bikes.map((v, i) => i === 0 ? null : ((v - bikes[i-1]) / bikes[i-1] * 100));
    const totalsMoM = totals.map((v, i) => i === 0 ? null : ((v - totals[i-1]) / totals[i-1] * 100));

    let datasets, chartOptions;

    if (currentVehicleMonthlyTrend === 'cars') {
      // Cars Only Trend View
      const carsPctArr = cars.map((v, i) => ((v / totals[i]) * 100).toFixed(1));
      datasets = [
        {
          label: '🚗 Cars Volume',
          data: cars,
          backgroundColor: cars.map((v, i) => i === 0 || carsMoM[i] >= 0 ? '#3b82f6' : '#93c5fd'),
          borderColor: '#2563eb',
          borderWidth: 2,
          yAxisID: 'y',
          barPercentage: 0.7
        },
        {
          label: 'Cars Trend',
          data: cars,
          type: 'line',
          borderColor: '#1e40af',
          backgroundColor: 'transparent',
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: '#1e40af',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y1',
          tension: 0.3
        }
      ];
      chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
          tooltip: {
            backgroundColor: '#1f2937',
            padding: 12,
            callbacks: {
              afterLabel: function(context) {
                if (context.datasetIndex === 0) {
                  const idx = context.dataIndex;
                  if (idx === 0) return 'MoM: Baseline';
                  const mom = carsMoM[idx];
                  return 'MoM: ' + (mom >= 0 ? '+' : '') + mom.toFixed(1) + '%';
                }
                return '';
              }
            }
          },
          datalabels: {
            display: function(context) { return context.datasetIndex === 0; },
            color: '#fff',
            font: { weight: 'bold', size: 10 },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              return value.toLocaleString() + ' (' + carsPctArr[idx] + '%)';
            },
            anchor: 'center',
            align: 'center',
            offset: -8
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 11 } } },
          y: { 
            beginAtZero: true, position: 'left', suggestedMax: Math.max(...cars) * 1.2,
            title: { display: true, text: 'Cars Count', color: '#1e40af', font: { size: 11, weight: 'bold' } },
            ticks: { font: { size: 10 }, color: '#1e40af' }, grid: { color: '#e5e7eb' }
          },
          y1: {
            type: 'linear', position: 'right', beginAtZero: true, suggestedMax: Math.max(...cars) * 1.2,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Trend Line', color: '#1e40af', font: { size: 11 } },
            ticks: { font: { size: 10 }, color: '#1e40af' }
          }
        }
      };
    } else if (currentVehicleMonthlyTrend === 'bikes') {
      // Bikes Only Trend View
      const bikesPctArr = bikes.map((v, i) => ((v / totals[i]) * 100).toFixed(1));
      datasets = [
        {
          label: '🏍️ Bikes Volume',
          data: bikes,
          backgroundColor: bikes.map((v, i) => i === 0 || bikesMoM[i] >= 0 ? '#10b981' : '#6ee7b7'),
          borderColor: '#059669',
          borderWidth: 2,
          yAxisID: 'y',
          barPercentage: 0.7
        },
        {
          label: 'Bikes Trend',
          data: bikes,
          type: 'line',
          borderColor: '#047857',
          backgroundColor: 'transparent',
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: '#047857',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y1',
          tension: 0.3
        }
      ];
      chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
          tooltip: {
            backgroundColor: '#1f2937',
            padding: 12,
            callbacks: {
              afterLabel: function(context) {
                if (context.datasetIndex === 0) {
                  const idx = context.dataIndex;
                  if (idx === 0) return 'MoM: Baseline';
                  const mom = bikesMoM[idx];
                  return 'MoM: ' + (mom >= 0 ? '+' : '') + mom.toFixed(1) + '%';
                }
                return '';
              }
            }
          },
          datalabels: {
            display: function(context) { return context.datasetIndex === 0; },
            color: '#fff',
            font: { weight: 'bold', size: 10 },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              return value.toLocaleString() + ' (' + bikesPctArr[idx] + '%)';
            },
            anchor: 'center',
            align: 'center',
            offset: -8
          }
        },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 11 } } },
          y: { 
            beginAtZero: true, position: 'left', suggestedMax: Math.max(...bikes) * 1.25,
            title: { display: true, text: 'Bikes Count', color: '#047857', font: { size: 11, weight: 'bold' } },
            ticks: { font: { size: 10 }, color: '#047857' }, grid: { color: '#e5e7eb' }
          },
          y1: {
            type: 'linear', position: 'right', beginAtZero: true, suggestedMax: Math.max(...bikes) * 1.25,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Trend Line', color: '#047857', font: { size: 11 } },
            ticks: { font: { size: 10 }, color: '#047857' }
          }
        }
      };
    } else {
      // Combined Cars vs Bikes Evolution View (default)
      datasets = [
        {
          label: '🚗 Cars',
          data: cars,
          backgroundColor: '#3b82f6',
          borderColor: '#2563eb',
          borderWidth: 1,
          stack: 'stack1',
          yAxisID: 'y'
        },
        {
          label: '🏍️ Bikes',
          data: bikes,
          backgroundColor: '#10b981',
          borderColor: '#059669',
          borderWidth: 1,
          stack: 'stack1',
          yAxisID: 'y'
        },
        {
          label: 'Total Trend',
          data: totals,
          type: 'line',
          borderColor: '#111827',
          backgroundColor: 'transparent',
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: '#111827',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y1',
          tension: 0.3
        }
      ];
      chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
          datalabels: {
            display: function(context) { return context.datasetIndex !== 2; },
            color: '#fff',
            font: { weight: 'bold', size: 9 },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              const total = totals[idx];
              const pct = ((value / total) * 100).toFixed(1);
              return value.toLocaleString() + ' (' + pct + '%)';
            },
            anchor: 'center',
            align: 'center'
          }
        },
        scales: {
          x: { stacked: true, grid: { display: false }, ticks: { font: { size: 11 } } },
          y: { 
            stacked: true, beginAtZero: true, position: 'left', suggestedMax: Math.max(...totals) * 1.18,
            title: { display: true, text: 'Target Count', color: '#111827', font: { size: 11 } },
            ticks: { font: { size: 10 } }, grid: { color: '#f3f4f6' }
          },
          y1: {
            type: 'linear', position: 'right', beginAtZero: true, suggestedMax: Math.max(...totals) * 1.18,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Total (Line)', color: '#111827', font: { size: 11 } },
            ticks: { font: { size: 10 } }
          }
        }
      };
    }

    vehicleMonthlyChart = new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: { labels: months, datasets: datasets },
      options: chartOptions,
      plugins: [ChartDataLabels, vehicleTrendLabelsPlugin]
    });
  }

  function renderVehicleCityChart() {
    const canvas = document.getElementById('vehicleCityChart');
    if (!canvas) return;

    // Destroy T1/T2 side-by-side charts if they exist
    destroyT1T2Charts();

    if (vehicleCityChart) {
      vehicleCityChart.destroy();
    }

    let citiesToShow = [];
    if (currentCity !== 'all') {
      citiesToShow = [currentCity];
    } else if (currentCityLevel === 't1') {
      citiesToShow = t1Cities;
    } else if (currentCityLevel === 't2') {
      citiesToShow = t2Cities;
    } else {
      citiesToShow = [...t1Cities, ...t2Cities];
    }

    // If showing single city, show monthly breakdown
    if (citiesToShow.length === 1) {
      renderSingleCityChart(citiesToShow[0]);
      return;
    }

    // Calculate total for each city
    const cityTotals = citiesToShow.map(city => {
      const data = cityVehicleData[city];
      const totalCars = data.cars.reduce((a, b) => a + b, 0);
      const totalBikes = data.bikes.reduce((a, b) => a + b, 0);
      return { city, totalCars, totalBikes, total: totalCars + totalBikes };
    }).sort((a, b) => b.total - a.total);

    // Update KPI cards
    updateCityKpiCards(cityTotals);

    const labels = cityTotals.map(c => c.city);
    const carsData = cityTotals.map(c => c.totalCars);
    const bikesData = cityTotals.map(c => c.totalBikes);
    const totals = cityTotals.map(c => c.total);
    const maxTotal = Math.max(...totals);

    vehicleCityChart = new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: '🚗 Cars (6 months)',
            data: carsData,
            backgroundColor: '#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 1,
            stack: 'stack1',
            yAxisID: 'y'
          },
          {
            label: '🏍️ Bikes (6 months)',
            data: bikesData,
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 1,
            stack: 'stack1',
            yAxisID: 'y'
          },
          {
            label: 'Total Trend',
            data: totals,
            type: 'line',
            borderColor: '#111827',
            backgroundColor: 'transparent',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#111827',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y1',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { padding: 12, usePointStyle: true, font: { size: 10 } }
          },
          tooltip: {
            backgroundColor: '#1f2937',
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: {
              title: function(tooltipItems) {
                return '📍 ' + tooltipItems[0].label;
              },
              label: function(context) {
                const idx = context.dataIndex;
                const total = carsData[idx] + bikesData[idx];
                if (context.datasetIndex === 0) {
                  const pct = ((carsData[idx] / total) * 100).toFixed(1);
                  return '🚗 Cars: ' + carsData[idx].toLocaleString() + ' (' + pct + '%)';
                }
                if (context.datasetIndex === 1) {
                  const pct = ((bikesData[idx] / total) * 100).toFixed(1);
                  return '🏍️ Bikes: ' + bikesData[idx].toLocaleString() + ' (' + pct + '%)';
                }
                if (context.datasetIndex === 2) {
                  return '📊 Total: ' + total.toLocaleString();
                }
                return '';
              },
              footer: function(tooltipItems) {
                const idx = tooltipItems[0].dataIndex;
                const avgPerMonth = Math.round((carsData[idx] + bikesData[idx]) / 6);
                return '───────────────\navg/month: ' + avgPerMonth.toLocaleString();
              }
            }
          },
          datalabels: {
            display: function(context) {
              // Hide labels for very small values to avoid clutter
              if (context.datasetIndex === 2) return false;
              const value = context.dataset.data[context.dataIndex];
              const maxVal = Math.max(...totals);
              return value > maxVal * 0.02; // Only show if > 2% of max
            },
            color: '#fff',
            font: { weight: 'bold', size: 8 },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              const total = carsData[idx] + bikesData[idx];
              const pct = ((value / total) * 100).toFixed(1);
              return value.toLocaleString() + ' (' + pct + '%)';
            },
            anchor: 'center',
            align: 'center'
          }
        },
        scales: {
          x: { 
            stacked: true,
            grid: { display: false },
            ticks: { font: { size: 10 } }
          },
          y: { 
            stacked: true, 
            beginAtZero: true,
            suggestedMax: maxTotal * 1.20,
            position: 'left',
            title: { display: true, text: 'Target Count', color: '#111827', font: { size: 10 } },
            ticks: { font: { size: 9 } },
            grid: { color: '#f3f4f6' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            suggestedMax: maxTotal * 1.20,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Total (Line)', color: '#111827', font: { size: 10 } },
            ticks: { font: { size: 9 } }
          }
        }
      },
      plugins: [ChartDataLabels, vehicleTrendLabelsPlugin]
    });
  }

  function renderSingleCityChart(city) {
    const canvas = document.getElementById('vehicleCityChart');
    if (!canvas) return;

    if (vehicleCityChart) {
      vehicleCityChart.destroy();
    }

    const data = cityVehicleData[city];
    const totals = data.cars.map((c, i) => c + data.bikes[i]);
    const totalCars = data.cars.reduce((a, b) => a + b, 0);
    const totalBikes = data.bikes.reduce((a, b) => a + b, 0);

    // Update KPI cards for single city
    updateCityKpiCards([{ city, totalCars, totalBikes, total: totalCars + totalBikes }]);

    vehicleCityChart = new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: vehicleMonthlyData.months,
        datasets: [
          {
            label: '🚗 Cars - ' + city,
            data: data.cars,
            backgroundColor: '#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 1,
            stack: 'stack1',
            yAxisID: 'y'
          },
          {
            label: '🏍️ Bikes - ' + city,
            data: data.bikes,
            backgroundColor: '#10b981',
            borderColor: '#059669',
            borderWidth: 1,
            stack: 'stack1',
            yAxisID: 'y'
          },
          {
            label: 'Total Trend',
            data: totals,
            type: 'line',
            borderColor: '#111827',
            backgroundColor: 'transparent',
            borderWidth: 3,
            pointRadius: 6,
            pointBackgroundColor: '#111827',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y1',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { padding: 12, usePointStyle: true, font: { size: 10 } }
          },
          datalabels: {
            display: function(context) { return context.datasetIndex !== 2; },
            color: '#fff',
            font: { weight: 'bold', size: 10 },
            formatter: function(value, context) {
              const idx = context.dataIndex;
              const total = data.cars[idx] + data.bikes[idx];
              const pct = ((value / total) * 100).toFixed(1);
              return value.toLocaleString() + ' (' + pct + '%)';
            },
            anchor: 'center',
            align: 'center'
          }
        },
        scales: {
          x: { 
            stacked: true,
            grid: { display: false },
            ticks: { font: { size: 10 } }
          },
          y: { 
            stacked: true, 
            beginAtZero: true,
            suggestedMax: Math.max(...totals) * 1.18,
            position: 'left',
            title: { display: true, text: 'Target Count', color: '#111827', font: { size: 10 } },
            ticks: { font: { size: 9 } },
            grid: { color: '#f3f4f6' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            suggestedMax: Math.max(...totals) * 1.18,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Total (Line)', color: '#111827', font: { size: 10 } },
            ticks: { font: { size: 9 } }
          }
        }
      },
      plugins: [ChartDataLabels, vehicleTrendLabelsPlugin]
    });
  }

  function renderVehicleT1vsT2Chart() {
    // Destroy any existing charts
    destroyT1T2Charts();
    if (vehicleCityChart) { vehicleCityChart.destroy(); vehicleCityChart = null; }

    // Calculate T1 and T2 totals by month
    const t1Cars = vehicleMonthlyData.months.map((_, i) => 
      t1Cities.reduce((sum, city) => sum + cityVehicleData[city].cars[i], 0)
    );
    const t1Bikes = vehicleMonthlyData.months.map((_, i) => 
      t1Cities.reduce((sum, city) => sum + cityVehicleData[city].bikes[i], 0)
    );
    const t2Cars = vehicleMonthlyData.months.map((_, i) => 
      t2Cities.reduce((sum, city) => sum + cityVehicleData[city].cars[i], 0)
    );
    const t2Bikes = vehicleMonthlyData.months.map((_, i) => 
      t2Cities.reduce((sum, city) => sum + cityVehicleData[city].bikes[i], 0)
    );

    const t1Totals = t1Cars.map((c, i) => c + t1Bikes[i]);
    const t2Totals = t2Cars.map((c, i) => c + t2Bikes[i]);

    // Update KPI cards for T1 vs T2
    const t1TotalCars = t1Cars.reduce((a, b) => a + b, 0);
    const t1TotalBikes = t1Bikes.reduce((a, b) => a + b, 0);
    const t2TotalCars = t2Cars.reduce((a, b) => a + b, 0);
    const t2TotalBikes = t2Bikes.reduce((a, b) => a + b, 0);
    
    updateT1T2KpiCards(t1TotalCars, t1TotalBikes, t2TotalCars, t2TotalBikes);

    // Render T1 Chart
    const t1Canvas = document.getElementById('vehicleMonthlyT1Chart');
    if (t1Canvas) {
      const t1MaxVal = Math.max(...t1Totals);
      vehicleT1Chart = new Chart(t1Canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: vehicleMonthlyData.months,
          datasets: [
            {
              label: '🚗 Cars',
              data: t1Cars,
              backgroundColor: '#3b82f6',
              borderColor: '#2563eb',
              borderWidth: 1,
              stack: 'stack1'
            },
            {
              label: '🏍️ Bikes',
              data: t1Bikes,
              backgroundColor: '#60a5fa',
              borderColor: '#3b82f6',
              borderWidth: 1,
              stack: 'stack1'
            },
            {
              label: 'Total',
              data: t1Totals,
              type: 'line',
              borderColor: '#1e40af',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: '#1e40af',
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { font: { size: 9 }, padding: 8, usePointStyle: true } },
            datalabels: {
              display: function(ctx) { return ctx.datasetIndex !== 2; },
              color: '#fff',
              font: { weight: 'bold', size: 8 },
              formatter: function(value, context) {
                const idx = context.dataIndex;
                const total = t1Cars[idx] + t1Bikes[idx];
                const pct = ((value / total) * 100).toFixed(1);
                return value.toLocaleString() + ' (' + pct + '%)';
              },
              anchor: 'center',
              align: 'center'
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 9 } } },
            y: { stacked: true, beginAtZero: true, suggestedMax: t1MaxVal * 1.25, ticks: { font: { size: 9 } }, grid: { color: '#f3f4f6' } }
          }
        },
        plugins: [ChartDataLabels, vehicleTrendLabelsPlugin]
      });
    }

    // Render T2 Chart
    const t2Canvas = document.getElementById('vehicleMonthlyT2Chart');
    if (t2Canvas) {
      const t2MaxVal = Math.max(...t2Totals);
      vehicleT2Chart = new Chart(t2Canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: vehicleMonthlyData.months,
          datasets: [
            {
              label: '🚗 Cars',
              data: t2Cars,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 1,
              stack: 'stack1'
            },
            {
              label: '🏍️ Bikes',
              data: t2Bikes,
              backgroundColor: '#6ee7b7',
              borderColor: '#10b981',
              borderWidth: 1,
              stack: 'stack1'
            },
            {
              label: 'Total',
              data: t2Totals,
              type: 'line',
              borderColor: '#047857',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: '#047857',
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { font: { size: 9 }, padding: 8, usePointStyle: true } },
            datalabels: {
              display: function(ctx) { return ctx.datasetIndex !== 2; },
              color: '#fff',
              font: { weight: 'bold', size: 8 },
              formatter: function(value, context) {
                const idx = context.dataIndex;
                const total = t2Cars[idx] + t2Bikes[idx];
                const pct = ((value / total) * 100).toFixed(1);
                return value.toLocaleString() + ' (' + pct + '%)';
              },
              anchor: 'center',
              align: 'center'
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false }, ticks: { font: { size: 9 } } },
            y: { stacked: true, beginAtZero: true, suggestedMax: t2MaxVal * 1.25, ticks: { font: { size: 9 } }, grid: { color: '#f3f4f6' } }
          }
        },
        plugins: [ChartDataLabels, vehicleTrendLabelsPlugin]
      });
    }
  }

  function updateCityKpiCards(cityTotals) {
    const container = document.getElementById('vehicleCityKpiCards');
    if (!container) return;

    // Use vehicleMonthlyData totals for consistency when all cities selected (17 cities)
    // This ensures City View matches Monthly View totals
    const allCitiesSelected = cityTotals.length === 17;
    
    let totalCars, totalBikes;
    if (allCitiesSelected) {
      // Use aggregate data for consistency with Monthly View
      totalCars = vehicleMonthlyData.cars.reduce((a, b) => a + b, 0);
      totalBikes = vehicleMonthlyData.bikes.reduce((a, b) => a + b, 0);
    } else {
      // Sum selected cities
      totalCars = cityTotals.reduce((sum, c) => sum + c.totalCars, 0);
      totalBikes = cityTotals.reduce((sum, c) => sum + c.totalBikes, 0);
    }
    
    const grandTotal = totalCars + totalBikes;
    const carsPct = ((totalCars / grandTotal) * 100).toFixed(1);
    const bikesPct = ((totalBikes / grandTotal) * 100).toFixed(1);
    
    // Calculate averages per month (6 months of data)
    const avgCarsPerMonth = Math.round(totalCars / 6);
    const avgBikesPerMonth = Math.round(totalBikes / 6);
    const avgTotalPerMonth = Math.round(grandTotal / 6);

    container.innerHTML = `
      <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #3b82f6;">
        <div style="font-size: 11px; color: #1e40af; font-weight: 600;">🚗 Avg Cars (per month)</div>
        <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${avgCarsPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #3b82f6;">${carsPct}% of selection</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalCars.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #10b981;">
        <div style="font-size: 11px; color: #065f46; font-weight: 600;">🏍️ Avg Bikes (per month)</div>
        <div style="font-size: 20px; font-weight: 700; color: #065f46;">${avgBikesPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #10b981;">${bikesPct}% of selection</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${totalBikes.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #8b5cf6;">
        <div style="font-size: 11px; color: #5b21b6; font-weight: 600;">📊 Avg Total (per month)</div>
        <div style="font-size: 20px; font-weight: 700; color: #6d28d9;">${avgTotalPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #8b5cf6;">${cityTotals.length} ${cityTotals.length === 1 ? 'city' : 'cities'} selected</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${grandTotal.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
        <div style="font-size: 11px; color: #92400e; font-weight: 600;">🏆 Top City</div>
        <div style="font-size: 20px; font-weight: 700; color: #b45309;">${cityTotals[0]?.city || '-'}</div>
        <div style="font-size: 10px; color: #f59e0b;">${Math.round((cityTotals[0]?.total || 0) / 6).toLocaleString()} avg/month</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${cityTotals[0]?.total.toLocaleString() || 0}</div>
      </div>
    `;
    
    // Update vehicle share insights panel if showing multiple cities
    updateVehicleShareInsights(cityTotals);
  }

  // Store donut chart instances for cleanup
  let bikeShareDonut = null;
  let carShareDonut = null;

  function updateVehicleShareInsights(cityTotals) {
    const panel = document.getElementById('vehicleShareInsightsPanel');
    if (!panel) return;

    // Only show for multiple cities (All Cities, T1, T2 slicers)
    if (cityTotals.length <= 1) {
      panel.style.display = 'none';
      return;
    }
    panel.style.display = 'block';

    const months = ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'];

    // Calculate bike/car share for each city
    const cityShares = cityTotals.map(ct => {
      const cityData = cityVehicleData[ct.city];
      const bikesPct = ct.total > 0 ? (ct.totalBikes / ct.total) * 100 : 0;
      const carsPct = ct.total > 0 ? (ct.totalCars / ct.total) * 100 : 0;
      
      // Find highest month for bikes and cars
      let highestBikeMonth = { month: '', value: 0, pct: 0 };
      let highestCarMonth = { month: '', value: 0, pct: 0 };
      
      for (let i = 0; i < 6; i++) {
        const monthTotal = cityData.cars[i] + cityData.bikes[i];
        const bikePct = monthTotal > 0 ? (cityData.bikes[i] / monthTotal) * 100 : 0;
        const carPct = monthTotal > 0 ? (cityData.cars[i] / monthTotal) * 100 : 0;
        
        if (bikePct > highestBikeMonth.pct) {
          highestBikeMonth = { month: months[i], value: cityData.bikes[i], pct: bikePct };
        }
        if (carPct > highestCarMonth.pct) {
          highestCarMonth = { month: months[i], value: cityData.cars[i], pct: carPct };
        }
      }
      
      return {
        city: ct.city,
        totalBikes: ct.totalBikes,
        totalCars: ct.totalCars,
        total: ct.total,
        bikesPct,
        carsPct,
        avgBikesPerMonth: Math.round(ct.totalBikes / 6),
        avgCarsPerMonth: Math.round(ct.totalCars / 6),
        highestBikeMonth,
        highestCarMonth
      };
    });

    // Find city with highest bike share percentage
    const highestBikeShareCity = cityShares.reduce((max, c) => c.bikesPct > max.bikesPct ? c : max, cityShares[0]);
    
    // Find city with highest car share percentage
    const highestCarShareCity = cityShares.reduce((max, c) => c.carsPct > max.carsPct ? c : max, cityShares[0]);

    // Destroy existing donuts
    if (bikeShareDonut) { bikeShareDonut.destroy(); bikeShareDonut = null; }
    if (carShareDonut) { carShareDonut.destroy(); carShareDonut = null; }

    panel.innerHTML = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Highest Bike Share City Card -->
        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; border: 2px solid #10b981; padding: 20px; position: relative; overflow: hidden;">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 80px; opacity: 0.1;">🏍️</div>
          <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- Donut Chart -->
            <div style="width: 140px; height: 140px; flex-shrink: 0; position: relative;">
              <canvas id="bikeShareDonutChart"></canvas>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 20px; font-weight: 800; color: #059669;">${highestBikeShareCity.bikesPct.toFixed(1)}%</div>
                <div style="font-size: 9px; color: #047857; font-weight: 600;">BIKE SHARE</div>
              </div>
            </div>
            <!-- Info Section -->
            <div style="flex: 1; position: relative; z-index: 1;">
              <div style="font-size: 12px; color: #047857; font-weight: 700; margin-bottom: 5px;">🏆 Highest Bike Share City</div>
              <div style="font-size: 22px; font-weight: 800; color: #065f46; margin-bottom: 8px;">${highestBikeShareCity.city}</div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 10px;">
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px;">
                  <div style="color: #6b7280; font-weight: 600;">Total Bikes (6 mo)</div>
                  <div style="font-size: 14px; font-weight: 700; color: #059669;">${highestBikeShareCity.totalBikes.toLocaleString()}</div>
                  <div style="color: #10b981;">${highestBikeShareCity.bikesPct.toFixed(1)}% of city total</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px;">
                  <div style="color: #6b7280; font-weight: 600;">Avg/Month</div>
                  <div style="font-size: 14px; font-weight: 700; color: #059669;">${highestBikeShareCity.avgBikesPerMonth.toLocaleString()}</div>
                  <div style="color: #10b981;">${(highestBikeShareCity.bikesPct).toFixed(1)}% avg share</div>
                </div>
              </div>
              
              <div style="margin-top: 10px; background: rgba(255,255,255,0.8); padding: 8px 10px; border-radius: 6px; border-left: 3px solid #10b981;">
                <div style="font-size: 10px; color: #047857; font-weight: 700;">📅 Peak Bike Month</div>
                <div style="font-size: 13px; font-weight: 700; color: #065f46;">
                  ${highestBikeShareCity.highestBikeMonth.month}: ${highestBikeShareCity.highestBikeMonth.value.toLocaleString()} 
                  <span style="font-size: 11px; color: #10b981;">(${highestBikeShareCity.highestBikeMonth.pct.toFixed(1)}%)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Highest Car Share City Card -->
        <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border: 2px solid #3b82f6; padding: 20px; position: relative; overflow: hidden;">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 80px; opacity: 0.1;">🚗</div>
          <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- Donut Chart -->
            <div style="width: 140px; height: 140px; flex-shrink: 0; position: relative;">
              <canvas id="carShareDonutChart"></canvas>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 20px; font-weight: 800; color: #2563eb;">${highestCarShareCity.carsPct.toFixed(1)}%</div>
                <div style="font-size: 9px; color: #1d4ed8; font-weight: 600;">CAR SHARE</div>
              </div>
            </div>
            <!-- Info Section -->
            <div style="flex: 1; position: relative; z-index: 1;">
              <div style="font-size: 12px; color: #1d4ed8; font-weight: 700; margin-bottom: 5px;">🏆 Highest Car Share City</div>
              <div style="font-size: 22px; font-weight: 800; color: #1e40af; margin-bottom: 8px;">${highestCarShareCity.city}</div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 10px;">
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px;">
                  <div style="color: #6b7280; font-weight: 600;">Total Cars (6 mo)</div>
                  <div style="font-size: 14px; font-weight: 700; color: #2563eb;">${highestCarShareCity.totalCars.toLocaleString()}</div>
                  <div style="color: #3b82f6;">${highestCarShareCity.carsPct.toFixed(1)}% of city total</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px;">
                  <div style="color: #6b7280; font-weight: 600;">Avg/Month</div>
                  <div style="font-size: 14px; font-weight: 700; color: #2563eb;">${highestCarShareCity.avgCarsPerMonth.toLocaleString()}</div>
                  <div style="color: #3b82f6;">${(highestCarShareCity.carsPct).toFixed(1)}% avg share</div>
                </div>
              </div>
              
              <div style="margin-top: 10px; background: rgba(255,255,255,0.8); padding: 8px 10px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div style="font-size: 10px; color: #1d4ed8; font-weight: 700;">📅 Peak Car Month</div>
                <div style="font-size: 13px; font-weight: 700; color: #1e40af;">
                  ${highestCarShareCity.highestCarMonth.month}: ${highestCarShareCity.highestCarMonth.value.toLocaleString()} 
                  <span style="font-size: 11px; color: #3b82f6;">(${highestCarShareCity.highestCarMonth.pct.toFixed(1)}%)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Create donut charts
    const bikeCanvas = document.getElementById('bikeShareDonutChart');
    const carCanvas = document.getElementById('carShareDonutChart');

    if (bikeCanvas) {
      bikeShareDonut = new Chart(bikeCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Bikes', 'Cars'],
          datasets: [{
            data: [highestBikeShareCity.totalBikes, highestBikeShareCity.totalCars],
            backgroundColor: ['#10b981', '#e5e7eb'],
            borderColor: ['#059669', '#d1d5db'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1f2937',
              callbacks: {
                label: function(context) {
                  const total = highestBikeShareCity.total;
                  const pct = ((context.raw / total) * 100).toFixed(1);
                  return context.label + ': ' + context.raw.toLocaleString() + ' (' + pct + '%)';
                }
              }
            },
            datalabels: { display: false }
          }
        }
      });
    }

    if (carCanvas) {
      carShareDonut = new Chart(carCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Cars', 'Bikes'],
          datasets: [{
            data: [highestCarShareCity.totalCars, highestCarShareCity.totalBikes],
            backgroundColor: ['#3b82f6', '#e5e7eb'],
            borderColor: ['#2563eb', '#d1d5db'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1f2937',
              callbacks: {
                label: function(context) {
                  const total = highestCarShareCity.total;
                  const pct = ((context.raw / total) * 100).toFixed(1);
                  return context.label + ': ' + context.raw.toLocaleString() + ' (' + pct + '%)';
                }
              }
            },
            datalabels: { display: false }
          }
        }
      });
    }
  }

  function updateT1T2KpiCards(t1Cars, t1Bikes, t2Cars, t2Bikes) {
    const container = document.getElementById('vehicleCityKpiCards');
    if (!container) return;

    // Hide share insights panel for T1 vs T2 view
    const sharePanel = document.getElementById('vehicleShareInsightsPanel');
    if (sharePanel) sharePanel.style.display = 'none';

    const t1Total = t1Cars + t1Bikes;
    const t2Total = t2Cars + t2Bikes;
    const grandTotal = t1Total + t2Total;
    
    // Calculate percentages within each tier
    const t1CarsPct = ((t1Cars / t1Total) * 100).toFixed(1);
    const t1BikesPct = ((t1Bikes / t1Total) * 100).toFixed(1);
    const t2CarsPct = ((t2Cars / t2Total) * 100).toFixed(1);
    const t2BikesPct = ((t2Bikes / t2Total) * 100).toFixed(1);
    
    // Calculate bikes growth comparison
    const t1BikesShare = (t1Bikes / t1Total) * 100;
    const t2BikesShare = (t2Bikes / t2Total) * 100;

    // Calculate averages per month (6 months of data)
    const t1AvgPerMonth = Math.round(t1Total / 6);
    const t2AvgPerMonth = Math.round(t2Total / 6);
    const grandAvgPerMonth = Math.round(grandTotal / 6);

    container.innerHTML = `
      <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #1e40af;">
        <div style="font-size: 11px; color: #1e40af; font-weight: 600;">🏙️ T1 Avg (${((t1Total/grandTotal)*100).toFixed(1)}%)</div>
        <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${t1AvgPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #3b82f6;">🚗 ${Math.round(t1Cars/6).toLocaleString()} (${t1CarsPct}%) | 🏍️ ${Math.round(t1Bikes/6).toLocaleString()} (${t1BikesPct}%)</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${t1Total.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #047857;">
        <div style="font-size: 11px; color: #065f46; font-weight: 600;">🌆 T2 Avg (${((t2Total/grandTotal)*100).toFixed(1)}%)</div>
        <div style="font-size: 20px; font-weight: 700; color: #065f46;">${t2AvgPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #10b981;">🚗 ${Math.round(t2Cars/6).toLocaleString()} (${t2CarsPct}%) | 🏍️ ${Math.round(t2Bikes/6).toLocaleString()} (${t2BikesPct}%)</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${t2Total.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #8b5cf6;">
        <div style="font-size: 11px; color: #5b21b6; font-weight: 600;">📊 Avg Total (per month)</div>
        <div style="font-size: 20px; font-weight: 700; color: #6d28d9;">${grandAvgPerMonth.toLocaleString()}</div>
        <div style="font-size: 10px; color: #8b5cf6;">🚗 ${Math.round((t1Cars + t2Cars)/6).toLocaleString()} | 🏍️ ${Math.round((t1Bikes + t2Bikes)/6).toLocaleString()}</div>
        <div style="font-size: 9px; color: #64748b; margin-top: 2px;">total: ${grandTotal.toLocaleString()}</div>
      </div>
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f59e0b;">
        <div style="font-size: 11px; color: #92400e; font-weight: 600;">🏍️ Bikes Share</div>
        <div style="font-size: 18px; font-weight: 700; color: #b45309;">T1: ${t1BikesPct}% | T2: ${t2BikesPct}%</div>
        <div style="font-size: 10px; color: #f59e0b;">T2 has ${(t2BikesShare - t1BikesShare).toFixed(1)}% higher bikes share</div>
      </div>
    `;
  }

  function renderVehicleDataTable() {
    const container = document.getElementById('vehicleTableContainer');
    if (!container) return;

    // Determine which cities to show based on current filters
    let citiesToShow = [];
    if (currentCity !== 'all') {
      citiesToShow = [currentCity];
    } else if (currentCityLevel === 't1') {
      citiesToShow = t1Cities;
    } else if (currentCityLevel === 't2') {
      citiesToShow = t2Cities;
    } else {
      citiesToShow = [...t1Cities, ...t2Cities];
    }

    // Calculate bikes/cars share for each city to determine highlighting
    const cityBikesShare = {};
    const cityCarsShare = {};
    citiesToShow.forEach(city => {
      const data = cityVehicleData[city];
      const totalCars = data.cars.reduce((a, b) => a + b, 0);
      const totalBikes = data.bikes.reduce((a, b) => a + b, 0);
      const total = totalCars + totalBikes;
      cityBikesShare[city] = total > 0 ? (totalBikes / total) * 100 : 0;
      cityCarsShare[city] = total > 0 ? (totalCars / total) * 100 : 0;
    });

    // Sort cities by bikes share to find highest/moderate/lowest
    const sortedByBikes = [...citiesToShow].sort((a, b) => cityBikesShare[b] - cityBikesShare[a]);
    const highestBikes = sortedByBikes.slice(0, 3).map(c => c);
    const lowestBikes = sortedByBikes.slice(-3).map(c => c);

    // Build table HTML
    let html = `
      <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
        <thead>
          <tr style="background: #1e40af; color: white;">
            <th rowspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: left; position: sticky; top: 0; background: #1e40af; z-index: 2; vertical-align: middle;">City</th>
            <th rowspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e40af; font-size: 10px; vertical-align: middle;">Overall Avg<br>Car 🚗 %</th>
            <th rowspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e40af; font-size: 10px; vertical-align: middle;">Overall Avg<br>Bike 🏍️ %</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e40af;">Sep</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e3a8a;">Oct</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e40af;">Nov</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e3a8a;">Dec</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e40af;">Jan</th>
            <th colspan="2" style="padding: 10px; border: 1px solid #1e40af; text-align: center; position: sticky; top: 0; background: #1e3a8a;">Feb</th>
          </tr>
          <tr style="background: #2563eb; color: white;">
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Car 🚗</th>
            <th style="padding: 6px; border: 1px solid #2563eb; text-align: center;">Bike 🏍️</th>
          </tr>
        </thead>
        <tbody>`;

    // Calculate totals
    let totalCars = [0, 0, 0, 0, 0, 0];
    let totalBikes = [0, 0, 0, 0, 0, 0];

    citiesToShow.forEach((city, idx) => {
      const data = cityVehicleData[city];
      const tier = data.tier;
      const bikesShare = cityBikesShare[city];
      const carsShare = cityCarsShare[city];
      
      // Update totals
      for (let i = 0; i < 6; i++) {
        totalCars[i] += data.cars[i];
        totalBikes[i] += data.bikes[i];
      }

      // Determine row highlighting based on bikes share
      let rowStyle = '';
      let bikesStyle = '';
      let carsStyle = 'background: #dbeafe; color: #1e40af; font-weight: 600;';
      if (highestBikes.includes(city) && bikesShare > 0) {
        rowStyle = 'background: #dcfce7;'; // Green for highest bikes share
        bikesStyle = 'background: #10b981; color: white; font-weight: 700;';
      } else if (lowestBikes.includes(city) || bikesShare === 0) {
        rowStyle = 'background: #fee2e2;'; // Red for lowest bikes share
        bikesStyle = 'background: #ef4444; color: white; font-weight: 700;';
      } else {
        rowStyle = idx % 2 === 0 ? 'background: #f9fafb;' : 'background: #ffffff;';
        bikesStyle = 'background: #fef3c7; color: #92400e; font-weight: 600;';
      }

      // Calculate monthly percentages
      const monthlyPcts = [];
      for (let i = 0; i < 6; i++) {
        const monthTotal = data.cars[i] + data.bikes[i];
        const carPct = monthTotal > 0 ? ((data.cars[i] / monthTotal) * 100).toFixed(1) : '0.0';
        const bikePct = monthTotal > 0 ? ((data.bikes[i] / monthTotal) * 100).toFixed(1) : '0.0';
        monthlyPcts.push({ carPct, bikePct });
      }

      html += `
        <tr style="${rowStyle}">
          <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600;">${tier} - ${city}</td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; ${carsStyle}">${carsShare.toFixed(1)}%</td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center; ${bikesStyle}">${bikesShare.toFixed(1)}%</td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[0].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[0].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[0].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[0].bikePct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[1].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[1].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[1].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[1].bikePct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[2].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[2].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[2].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[2].bikePct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[3].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[3].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[3].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[3].bikePct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[4].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[4].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[4].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[4].bikePct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.cars[5].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[5].carPct}%)</span></td>
          <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">${data.bikes[5].toLocaleString()} <span style="color:#6b7280;font-size:9px;">(${monthlyPcts[5].bikePct}%)</span></td>
        </tr>`;
    });

    // Calculate total bikes/cars share
    const grandTotalCars = totalCars.reduce((a, b) => a + b, 0);
    const grandTotalBikes = totalBikes.reduce((a, b) => a + b, 0);
    const grandTotal = grandTotalCars + grandTotalBikes;
    const totalBikesShare = grandTotal > 0 ? (grandTotalBikes / grandTotal) * 100 : 0;
    const totalCarsShare = grandTotal > 0 ? (grandTotalCars / grandTotal) * 100 : 0;

    // Calculate monthly percentages for totals
    const totalMonthlyPcts = [];
    for (let i = 0; i < 6; i++) {
      const monthTotal = totalCars[i] + totalBikes[i];
      const carPct = monthTotal > 0 ? ((totalCars[i] / monthTotal) * 100).toFixed(1) : '0.0';
      const bikePct = monthTotal > 0 ? ((totalBikes[i] / monthTotal) * 100).toFixed(1) : '0.0';
      totalMonthlyPcts.push({ carPct, bikePct });
    }

    // Add totals row
    html += `
        <tr style="background: #1e40af; color: white; font-weight: 700;">
          <td style="padding: 10px; border: 1px solid #1e40af;">Total (${citiesToShow.length} cities)</td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: center; background: #3b82f6;">${totalCarsShare.toFixed(1)}%</td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: center; background: #3b82f6;">${totalBikesShare.toFixed(1)}%</td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[0].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[0].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[0].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[0].bikePct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[1].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[1].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[1].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[1].bikePct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[2].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[2].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[2].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[2].bikePct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[3].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[3].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[3].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[3].bikePct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[4].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[4].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[4].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[4].bikePct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalCars[5].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[5].carPct}%)</span></td>
          <td style="padding: 10px; border: 1px solid #1e40af; text-align: right;">${totalBikes[5].toLocaleString()} <span style="opacity:0.8;font-size:9px;">(${totalMonthlyPcts[5].bikePct}%)</span></td>
        </tr>
      </tbody>
    </table>
    <div style="margin-top: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 11px;">
      <span style="display: inline-block; width: 12px; height: 12px; background: #dcfce7; border: 1px solid #10b981; margin-right: 4px; vertical-align: middle;"></span> Highest Bikes Share
      <span style="display: inline-block; width: 12px; height: 12px; background: #fee2e2; border: 1px solid #ef4444; margin-left: 15px; margin-right: 4px; vertical-align: middle;"></span> Lowest Bikes Share
    </div>`;

    container.innerHTML = html;
  }

  function initVehicleMonthlyCharts() {
    const canvas = document.getElementById('vehicleMonthlyChart');
    if (!canvas) return;

    // Render initial view and table
    renderVehicleMonthlyChart();
    renderVehicleDataTable();
  }

  // Expose functions globally
  window.switchVehicleMonthlyView = switchVehicleMonthlyView;
  window.filterVehicleCityLevel = filterVehicleCityLevel;
  window.filterVehicleCity = filterVehicleCity;
  window.initVehicleMonthlyCharts = initVehicleMonthlyCharts;
  window.renderVehicleDataTable = renderVehicleDataTable;

  // Auto-init on load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initVehicleMonthlyCharts, 100);
  });
})();

    // Partner Willing Data
        const partnerWillingData = [
        {
            "month": "Sep",
            "total_partners": 615,
            "willing": 0,
            "not_willing": 0,
            "willing_pct": 0.0,
            "not_willing_pct": 0.0
        },
        {
            "month": "Oct",
            "total_partners": 697,
            "willing": 213,
            "not_willing": 356,
            "willing_pct": 37.4,
            "not_willing_pct": 62.6
        },
        {
            "month": "Nov",
            "total_partners": 767,
            "willing": 259,
            "not_willing": 381,
            "willing_pct": 40.5,
            "not_willing_pct": 59.5
        },
        {
            "month": "Dec",
            "total_partners": 674,
            "willing": 81,
            "not_willing": 554,
            "willing_pct": 12.8,
            "not_willing_pct": 87.2
        },
        {
            "month": "Jan",
            "total_partners": 625,
            "willing": 201,
            "not_willing": 413,
            "willing_pct": 32.7,
            "not_willing_pct": 67.3
        },
        {
            "month": "Feb",
            "total_partners": 551,
            "willing": 130,
            "not_willing": 398,
            "willing_pct": 24.6,
            "not_willing_pct": 75.4
        },
    ];
    function initPartnerWillingAnalysis() {
        try {
            createWillingVsNotWillingChart();
            createWillingnessTrendChart();
            createGrowthCategoryChart();
            createDecreaseCategoryChart();
            createAvgScalePerfChart();
            createAvgScaleSizeChart();
} catch (error) {
            console.error('Error initializing partner willing analysis:', error);
        }
    }

    function createWillingVsNotWillingChart() {
        const ctx = document.getElementById('willingVsNotWillingChart');
        if (!ctx) {
            console.log('willingVsNotWillingChart canvas not found');
            return;
        }
        
        const dataWithoutJune = partnerWillingData.filter(d => d.month !== 'Sep');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dataWithoutJune.map(d => d.month),
                datasets: [
                    {
                        label: 'Not-Willing (≤0)',
                        data: dataWithoutJune.map(d => d.not_willing),
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 2
                    },
                    {
                        label: 'Willing (>0)',
                        data: dataWithoutJune.map(d => d.willing),
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value) {
                            return value;
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Partners'
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function createWillingnessTrendChart() {
        const ctx = document.getElementById('willingnessTrendChart');
        if (!ctx) {
            console.log('willingnessTrendChart canvas not found');
            return;
        }
        
        const dataWithoutJune = partnerWillingData.filter(d => d.month !== 'Sep');
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataWithoutJune.map(d => d.month),
                datasets: [
                    {
                        label: 'Willing %',
                        data: dataWithoutJune.map(d => d.willing_pct),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Not-Willing %',
                        data: dataWithoutJune.map(d => d.not_willing_pct),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    datalabels: {
                        color: '#111827',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: function(value) {
                            return value.toFixed(1) + '%';
                        },
                        anchor: 'end',
                        align: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Percentage (%)'
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

        function createGrowthCategoryChart() {
        const ctx = document.getElementById('growthCategoryChart');
        if (!ctx) {
            console.log('growthCategoryChart canvas not found');
            return;
        }
        
        const months = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
        const inc1_10 = [42, 60, 73, 22, 79, 46];
        const inc11_20 = [63, 60, 75, 23, 58, 52];
        const inc21_30 = [40, 29, 31, 11, 28, 16];
        const incGt30 = [54, 64, 80, 25, 36, 16];
        const totalIncrease = [199, 213, 259, 81, 201, 130];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: '≥1%-≤10%',
                        data: inc1_10,
                        backgroundColor: '#60a5fa',
                        borderColor: '#3b82f6',
                        borderWidth: 2
                    },
                    {
                        label: '≥11%-≤20%',
                        data: inc11_20,
                        backgroundColor: '#34d399',
                        borderColor: '#10b981',
                        borderWidth: 2
                    },
                    {
                        label: '≥21%-≤30%',
                        data: inc21_30,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 2
                    },
                    {
                        label: '>30%',
                        data: incGt30,
                        backgroundColor: '#f87171',
                        borderColor: '#ef4444',
                        borderWidth: 2
                    },
                    {
                        label: 'Total Increase Trend',
                        data: totalIncrease,
                        type: 'line',
                        borderColor: '#111827',
                        backgroundColor: '#111827',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#111827',
                        yAxisID: 'y1',
                        datalabels: {
                            display: true,
                            color: '#111827',
                            font: { weight: 'bold', size: 12 },
                            anchor: 'end',
                            align: 'top'
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: {
                        display: function(context) {
                            return context.dataset.type !== 'line';
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        formatter: function(value) {
                            return value > 0 ? value : '';
                        }
                    }
                },
                scales: {
                    x: { stacked: false, grid: { display: false } },
                    y: { stacked: false, beginAtZero: true, title: { display: true, text: 'Partners (Bars)' } },
                    y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Total Increases (Line)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


        // Decrease Category Chart
    function createDecreaseCategoryChart() {
        const ctx = document.getElementById('decreaseCategoryChart');
        if (!ctx) {
            console.log('decreaseCategoryChart canvas not found');
            return;
        }
        
        const months = ['Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26', 'Feb-26'];
        const dec1_10 = [17, 39, 40, 52, 64, 84];
        const dec11_20 = [38, 56, 64, 108, 77, 98];
        const dec21_30 = [21, 26, 43, 83, 42, 50];
        const decLt30 = [48, 40, 41, 215, 56, 52];
        const totalDecrease = [124, 161, 188, 458, 239, 284];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: '≥1%-≤10%',
                        data: dec1_10,
                        backgroundColor: '#fbbf24',
                        borderColor: '#f59e0b',
                        borderWidth: 2
                    },
                    {
                        label: '≥11%-≤20%',
                        data: dec11_20,
                        backgroundColor: '#fb923c',
                        borderColor: '#f97316',
                        borderWidth: 2
                    },
                    {
                        label: '≥21%-≤30%',
                        data: dec21_30,
                        backgroundColor: '#f87171',
                        borderColor: '#ef4444',
                        borderWidth: 2
                    },
                    {
                        label: '>30%',
                        data: decLt30,
                        backgroundColor: '#dc2626',
                        borderColor: '#b91c1c',
                        borderWidth: 2
                    },
                    {
                        label: 'Total Decrease Trend',
                        data: totalDecrease,
                        type: 'line',
                        borderColor: '#111827',
                        backgroundColor: '#111827',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#111827',
                        yAxisID: 'y1',
                        datalabels: {
                            display: true,
                            color: '#111827',
                            font: { weight: 'bold', size: 12 },
                            anchor: 'end',
                            align: 'top'
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: {
                        display: function(context) {
                            return context.dataset.type !== 'line';
                        },
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        formatter: function(value) {
                            return value > 0 ? value : '';
                        }
                    }
                },
                scales: {
                    x: { stacked: false, grid: { display: false } },
                    y: { stacked: false, beginAtZero: true, title: { display: true, text: 'Partners (Bars)' } },
                    y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'Total Decreases (Line)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


    
    function createAvgScalePerfChart() {
        const ctx = document.getElementById('avgScalePerfChart');
        if (!ctx) {
            console.log('avgScalePerfChart canvas not found');
            return;
        }
        
        const months = ['Aug-25', 'Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26'];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Good',
                        data: [63.2, 70.2, 58.3, 55.7, 49.4, 46.2],
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 2
                    },
                    {
                        label: 'Average',
                        data: [63.7, 62.3, 58.6, 51.5, 32.5, 30.8],
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 2
                    },
                    {
                        label: 'Bad',
                        data: [43.2, 40.7, 38.5, 40.3, 23.6, 21.5],
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        formatter: function(value) {
                            return value;
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, title: { display: true, text: 'Avg Riders per Partner' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function createAvgScaleSizeChart() {
        const ctx = document.getElementById('avgScaleSizeChart');
        if (!ctx) {
            console.log('avgScaleSizeChart canvas not found');
            return;
        }
        
        const months = ['Aug-25', 'Sep-25', 'Oct-25', 'Nov-25', 'Dec-25', 'Jan-26'];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Big',
                        data: [101.6, 122.0, 106.8, 105.4, 77.5, 62.1],
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 2
                    },
                    {
                        label: 'Mid',
                        data: [56.7, 61.0, 55.0, 50.9, 36.9, 38.8],
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 2
                    },
                    {
                        label: 'Small',
                        data: [34.5, 35.3, 29.9, 28.0, 19.5, 26.0],
                        backgroundColor: '#06b6d4',
                        borderColor: '#0891b2',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        formatter: function(value) {
                            return value;
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, title: { display: true, text: 'Avg Riders per Partner' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }


    function createMoMChartNew() {
        const canvas = document.getElementById('monthlyMoMChangeChartNew');
        if (!canvas || typeof Chart === 'undefined') return;

        // Source of truth: Monthly Insights totals (same totals shown in the dashboard)
        const md = (typeof monthlyData !== 'undefined') ? monthlyData : null;
        const months = (md && Array.isArray(md.months)) ? md.months.slice() : [];
        const targets = (md && Array.isArray(md.totalTarget)) ? md.totalTarget.slice() : [];

        if (!months.length || months.length !== targets.length) return;

        // MoM%: (current - previous) / previous
        const mom = targets.map((t, i) => {
            if (i === 0 || !targets[i - 1]) return null; // baseline month
            return ((t - targets[i - 1]) / targets[i - 1]) * 100;
        });

        const bg = mom.map(v => (v === null) ? '#9ca3af' : (v >= 0 ? '#10b981' : '#ef4444'));
        const border = mom.map(v => (v === null) ? '#6b7280' : (v >= 0 ? '#059669' : '#dc2626'));

        // Re-init safely
        if (window.__momChartNew && typeof window.__momChartNew.destroy === 'function') {
            window.__momChartNew.destroy();
        }

        const useDL = (typeof ChartDataLabels !== 'undefined');
        const pluginsArr = useDL ? [ChartDataLabels] : [];

        window.__momChartNew = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'MoM Change %',
                    data: mom,
                    backgroundColor: bg,
                    borderColor: border,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    datalabels: useDL ? {
                        display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null,
                        color: '#111827',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => (value === null ? '' : value.toFixed(1) + '%'),
                        anchor: (ctx) => (ctx.dataset.data[ctx.dataIndex] >= 0 ? 'end' : 'start'),
                        align: (ctx) => (ctx.dataset.data[ctx.dataIndex] >= 0 ? 'top' : 'bottom')
                    } : { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed.y;
                                if (v === null || typeof v === 'undefined') return 'Baseline month';
                                return 'MoM Change: ' + v.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: '#111827' } },
                    y: {
                        title: { display: true, text: 'Month-over-Month Change (%)', color: '#111827' },
                        ticks: {
                            color: '#111827',
                            callback: (v) => v.toFixed(0) + '%'
                        }
                    }
                }
            },
            plugins: pluginsArr
        });
    }

    // Initialize charts when monthly tab is active
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            initPartnerWillingAnalysis();
        }, 1000);
    });
    
    // Re-initialize when switching to monthly tab
    const originalSwitchTab = window.switchTab;
    if (typeof originalSwitchTab === 'function') {
        window.switchTab = function(tabId, element) {
            originalSwitchTab(tabId, element);
            if (tabId === 'monthly') {
                setTimeout(function() {
                    initPartnerWillingAnalysis();
                }, 300);
            }
        };
    }

    
    // Top Movers Data and Functions
    const topMoversData = [
        {
            "month": "Sep",
            "top_biggest": [
                {
                    "rank": 1,
                    "partner": "SWEX",
                    "newold": "Old",
                    "actual": 1595,
                    "target": 1190
                },
                {
                    "rank": 2,
                    "partner": "First Line Logistics",
                    "newold": "New",
                    "actual": 725,
                    "target": 730
                },
                {
                    "rank": 3,
                    "partner": "ON Time Logistics",
                    "newold": "New",
                    "actual": 676,
                    "target": 690
                },
                {
                    "rank": 4,
                    "partner": "Rider's King",
                    "newold": "New",
                    "actual": 659,
                    "target": 630
                },
                {
                    "rank": 5,
                    "partner": "Makhsos logsitics",
                    "newold": "Old",
                    "actual": 828,
                    "target": 484
                },
                {
                    "rank": 6,
                    "partner": "Nader logistics",
                    "newold": "Old",
                    "actual": 324,
                    "target": 440
                },
                {
                    "rank": 7,
                    "partner": "AL-ZAHRANI",
                    "newold": "New",
                    "actual": 311,
                    "target": 421
                },
                {
                    "rank": 8,
                    "partner": "Gulf Support",
                    "newold": "Old",
                    "actual": 240,
                    "target": 405
                },
                {
                    "rank": 9,
                    "partner": "ONE TRIP",
                    "newold": "New",
                    "actual": 226,
                    "target": 382
                },
                {
                    "rank": 10,
                    "partner": "Markhor",
                    "newold": "Old",
                    "actual": 329,
                    "target": 381
                },
                {
                    "rank": 11,
                    "partner": "albwaba",
                    "newold": "New",
                    "actual": 414,
                    "target": 365
                },
                {
                    "rank": 12,
                    "partner": "Company Minassah Sahm Commercial",
                    "newold": "Old",
                    "actual": 270,
                    "target": 365
                },
                {
                    "rank": 13,
                    "partner": "SDC Logistics",
                    "newold": "Old",
                    "actual": 195,
                    "target": 340
                },
                {
                    "rank": 14,
                    "partner": "Aibtukir",
                    "newold": "Old",
                    "actual": 299,
                    "target": 324
                },
                {
                    "rank": 15,
                    "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services",
                    "newold": "Old",
                    "actual": 282,
                    "target": 308
                },
                {
                    "rank": 16,
                    "partner": "Sultan abdulaziz saad Albathrah for logistic services",
                    "newold": "Old",
                    "actual": 283,
                    "target": 295
                },
                {
                    "rank": 17,
                    "partner": "Anan Capital",
                    "newold": "Old",
                    "actual": 188,
                    "target": 290
                },
                {
                    "rank": 18,
                    "partner": "services delivery",
                    "newold": "New",
                    "actual": 172,
                    "target": 285
                },
                {
                    "rank": 19,
                    "partner": "Halloul Chark",
                    "newold": "New",
                    "actual": 263,
                    "target": 282
                },
                {
                    "rank": 20,
                    "partner": "Funoon Alkawader",
                    "newold": "Old",
                    "actual": 164,
                    "target": 270
                },
            ],
            "bottom_smallest": [
                {
                    "rank": 1,
                    "partner": "Takamul Al-Imdad for Logistics Services",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 2,
                    "partner": "Code Car",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 3,
                    "partner": "Four Sheeb",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 4,
                    "partner": "Husool",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 5,
                    "partner": "ASHRAF BEN HASSIN BEN ALI BOUGRARDAH",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 6,
                    "partner": "Red Belt",
                    "newold": "Old",
                    "actual": 0,
                    "target": 12
                },
                {
                    "rank": 7,
                    "partner": "LAST SPEED",
                    "newold": "New",
                    "actual": 8,
                    "target": 15
                },
                {
                    "rank": 8,
                    "partner": "Mashariq Al Makan",
                    "newold": "Old",
                    "actual": 2,
                    "target": 15
                },
                {
                    "rank": 9,
                    "partner": "Nabd Alimdad",
                    "newold": "Old",
                    "actual": 0,
                    "target": 15
                },
                {
                    "rank": 10,
                    "partner": "Quma Teser",
                    "newold": "Old",
                    "actual": 12,
                    "target": 15
                },
                {
                    "rank": 11,
                    "partner": "ELIOUM AL-AFDAL",
                    "newold": "Old",
                    "actual": 1,
                    "target": 15
                },
                {
                    "rank": 12,
                    "partner": "Himmat alItqan",
                    "newold": "Old",
                    "actual": 0,
                    "target": 15
                },
                {
                    "rank": 13,
                    "partner": "DOUA AL-MASSAR",
                    "newold": "Old",
                    "actual": 0,
                    "target": 15
                },
                {
                    "rank": 14,
                    "partner": "Captain manama",
                    "newold": "Old",
                    "actual": 0,
                    "target": 15
                },
                {
                    "rank": 15,
                    "partner": "Alrawafid",
                    "newold": "Old",
                    "actual": 0,
                    "target": 15
                },
                {
                    "rank": 16,
                    "partner": "Dawaer Elemdad",
                    "newold": "Old",
                    "actual": 0,
                    "target": 16
                },
                {
                    "rank": 17,
                    "partner": "AZM",
                    "newold": "Old",
                    "actual": 0,
                    "target": 19
                },
                {
                    "rank": 18,
                    "partner": "Alrawazan",
                    "newold": "Old",
                    "actual": 0,
                    "target": 19
                },
                {
                    "rank": 19,
                    "partner": "Solution alinjaz",
                    "newold": "Old",
                    "actual": 2,
                    "target": 20
                },
                {
                    "rank": 20,
                    "partner": "Kifayah",
                    "newold": "Old",
                    "actual": 6,
                    "target": 20
                },
            ]
        },
        {
            "month": "Oct",
            "top_biggest": [
                {
                    "rank": 1,
                    "partner": "ON Time Logistics",
                    "newold": "New",
                    "actual": 696,
                    "target": 755
                },
                {
                    "rank": 2,
                    "partner": "SWEX",
                    "newold": "Old",
                    "actual": 1256,
                    "target": 678
                },
                {
                    "rank": 3,
                    "partner": "First Line Logistics",
                    "newold": "New",
                    "actual": 763,
                    "target": 631
                },
                {
                    "rank": 4,
                    "partner": "Gulf Support",
                    "newold": "Old",
                    "actual": 350,
                    "target": 408
                },
                {
                    "rank": 5,
                    "partner": "AL-ZAHRANI",
                    "newold": "Old",
                    "actual": 374,
                    "target": 391
                },
                {
                    "rank": 6,
                    "partner": "Nader logistics",
                    "newold": "Old",
                    "actual": 391,
                    "target": 380
                },
                {
                    "rank": 7,
                    "partner": "Company Minassah Sahm Commercial",
                    "newold": "Old",
                    "actual": 296,
                    "target": 365
                },
                {
                    "rank": 8,
                    "partner": "SDC Logistics",
                    "newold": "New",
                    "actual": 302,
                    "target": 350
                },
                {
                    "rank": 9,
                    "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services",
                    "newold": "Old",
                    "actual": 312,
                    "target": 347
                },
                {
                    "rank": 10,
                    "partner": "Funoon Alkawader",
                    "newold": "Old",
                    "actual": 244,
                    "target": 320
                },
                {
                    "rank": 11,
                    "partner": "Rider's King",
                    "newold": "Old",
                    "actual": 626,
                    "target": 315
                },
                {
                    "rank": 12,
                    "partner": "albwaba",
                    "newold": "New",
                    "actual": 376,
                    "target": 312
                },
                {
                    "rank": 13,
                    "partner": "ONE TRIP",
                    "newold": "New",
                    "actual": 354,
                    "target": 310
                },
                {
                    "rank": 14,
                    "partner": "services delivery",
                    "newold": "New",
                    "actual": 266,
                    "target": 305
                },
                {
                    "rank": 15,
                    "partner": "AL-BARAQ AL-KHATEF",
                    "newold": "Old",
                    "actual": 244,
                    "target": 300
                },
                {
                    "rank": 16,
                    "partner": "Anan Capital",
                    "newold": "Old",
                    "actual": 259,
                    "target": 292
                },
                {
                    "rank": 17,
                    "partner": "FAHAD AL-SHARQ",
                    "newold": "Old",
                    "actual": 221,
                    "target": 270
                },
                {
                    "rank": 18,
                    "partner": "Aibtukir",
                    "newold": "Old",
                    "actual": 331,
                    "target": 265
                },
                {
                    "rank": 19,
                    "partner": "Markhor",
                    "newold": "Old",
                    "actual": 371,
                    "target": 250
                },
                {
                    "rank": 20,
                    "partner": "MADD",
                    "newold": "Old",
                    "actual": 203,
                    "target": 245
                },
            ],
            "bottom_smallest": [
                {
                    "rank": 1,
                    "partner": "GHAZAL LOGISTICS",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 2,
                    "partner": "saudiExpress",
                    "actual": 23.7,
                    "target": 10
                },
                {
                    "rank": 3,
                    "partner": "KDC Logistics",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 4,
                    "partner": "ALK",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 5,
                    "partner": "Meyzat Al-Takamul",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 6,
                    "partner": "NAS",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 7,
                    "partner": "Swiftlane",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 8,
                    "partner": "Last Moment",
                    "actual": 0.6,
                    "target": 10
                },
                {
                    "rank": 9,
                    "partner": "Nukhba Al Madinah",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 10,
                    "partner": "Alkhutut Almudhia",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 11,
                    "partner": "Husool",
                    "actual": 9.1,
                    "target": 10
                },
                {
                    "rank": 12,
                    "partner": "Triple Step",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 13,
                    "partner": " AL-BARQ LOGISTICS",
                    "actual": 0.8,
                    "target": 10
                },
                {
                    "rank": 14,
                    "partner": "ASTOL AL-WASSAL",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 15,
                    "partner": "Abrar Abdulrahman",
                    "actual": 19.2,
                    "target": 10
                },
                {
                    "rank": 16,
                    "partner": "ASHRAF BEN HASSIN BEN ALI BOUGRARDAH",
                    "actual": 10.1,
                    "target": 10
                },
                {
                    "rank": 17,
                    "partner": "AL-ABOUR MUMAIZ",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 18,
                    "partner": "Fast Food",
                    "actual": 21.5,
                    "target": 11
                },
                {
                    "rank": 19,
                    "partner": "ASMA HAMOOD",
                    "actual": 0,
                    "target": 11
                },
                {
                    "rank": 20,
                    "partner": "4th Goal Est",
                    "actual": 0,
                    "target": 12
                },
            ]
        },
        {
            "month": "Nov",
            "top_biggest": [
                {
                    "rank": 1,
                    "partner": "ON Time Logistics",
                    "newold": "Old",
                    "actual": 761,
                    "target": 580
                },
                {
                    "rank": 2,
                    "partner": "SWEX",
                    "newold": "Old",
                    "actual": 812,
                    "target": 481
                },
                {
                    "rank": 3,
                    "partner": "First Line Logistics",
                    "newold": "Old",
                    "actual": 636,
                    "target": 457
                },
                {
                    "rank": 4,
                    "partner": "Gulf Support",
                    "newold": "Old",
                    "actual": 407,
                    "target": 370
                },
                {
                    "rank": 5,
                    "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services",
                    "newold": "Old",
                    "actual": 331,
                    "target": 350
                },
                {
                    "rank": 6,
                    "partner": "ONE TRIP",
                    "newold": "Old",
                    "actual": 333,
                    "target": 345
                },
                {
                    "rank": 7,
                    "partner": "SDC Logistics",
                    "newold": "New",
                    "actual": 342,
                    "target": 345
                },
                {
                    "rank": 8,
                    "partner": "AL-BARAQ AL-KHATEF",
                    "newold": "Old",
                    "actual": 286,
                    "target": 320
                },
                {
                    "rank": 9,
                    "partner": "Nader logistics",
                    "newold": "Old",
                    "actual": 359,
                    "target": 315
                },
                {
                    "rank": 10,
                    "partner": "services delivery",
                    "newold": "Old",
                    "actual": 294,
                    "target": 309
                },
                {
                    "rank": 11,
                    "partner": "FAHAD AL-SHARQ",
                    "newold": "Old",
                    "actual": 253,
                    "target": 300
                },
                {
                    "rank": 12,
                    "partner": "Funoon Alkawader",
                    "newold": "Old",
                    "actual": 269,
                    "target": 290
                },
                {
                    "rank": 13,
                    "partner": "PARTNER SUCCESS",
                    "newold": "Old",
                    "actual": 204,
                    "target": 270
                },
                {
                    "rank": 14,
                    "partner": "AL-ZAHRANI",
                    "newold": "Old",
                    "actual": 381,
                    "target": 260
                },
                {
                    "rank": 15,
                    "partner": "MADD",
                    "newold": "Old",
                    "actual": 246,
                    "target": 255
                },
                {
                    "rank": 16,
                    "partner": "Anan Capital",
                    "newold": "Old",
                    "actual": 269,
                    "target": 250
                },
                {
                    "rank": 17,
                    "partner": "Masar",
                    "newold": "Old",
                    "actual": 188,
                    "target": 250
                },
                {
                    "rank": 18,
                    "partner": "Plus Logistics",
                    "newold": "New",
                    "actual": 181,
                    "target": 249
                },
                {
                    "rank": 19,
                    "partner": "Next Mile",
                    "newold": "New",
                    "actual": 220,
                    "target": 236
                },
                {
                    "rank": 20,
                    "partner": "Aibtukir",
                    "newold": "Old",
                    "actual": 264,
                    "target": 235
                },
            ],
            "bottom_smallest": [
                {
                    "rank": 1,
                    "partner": "My Way Logistics",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 2,
                    "partner": "NAWAF",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 3,
                    "partner": "Darb Al-Thuraya",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 4,
                    "partner": "ALK",
                    "newold": "New",
                    "actual": 6,
                    "target": 10
                },
                {
                    "rank": 5,
                    "partner": "Noor Alraida",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 6,
                    "partner": "lwaft aldhahab",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 7,
                    "partner": "Marasi Roads",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 8,
                    "partner": "Golden takfoul logistics service",
                    "newold": "New",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 9,
                    "partner": "Mister Wasil",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 10,
                    "partner": "Dan Al Sharq",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 11,
                    "partner": "Taif Al-Badr",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 12,
                    "partner": "Ayan Logistics",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 13,
                    "partner": "Abrar Abdulrahman",
                    "newold": "Old",
                    "actual": 15,
                    "target": 10
                },
                {
                    "rank": 14,
                    "partner": "ASHRAF BEN HASSIN BEN ALI BOUGRARDAH",
                    "newold": "Old",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 15,
                    "partner": "GHADAY HASSAN NASSER AL ABBAS",
                    "newold": "Old",
                    "actual": 0,
                    "target": 11
                },
                {
                    "rank": 16,
                    "partner": "GHAZAL LOGISTICS",
                    "newold": "New",
                    "actual": 9,
                    "target": 12
                },
                {
                    "rank": 17,
                    "partner": "3 Star Logistics",
                    "newold": "Old",
                    "actual": 0,
                    "target": 12
                },
                {
                    "rank": 18,
                    "partner": "4th Goal Est",
                    "newold": "New",
                    "actual": 3,
                    "target": 12
                },
                {
                    "rank": 19,
                    "partner": "Husool",
                    "newold": "New",
                    "actual": 12,
                    "target": 12
                },
                {
                    "rank": 20,
                    "partner": "Mohammad Hilal",
                    "newold": "Old",
                    "actual": 0,
                    "target": 12
                },
            ]
        },
        {
            "month": "Dec",
            "top_biggest": [
                {
                    "rank": 1,
                    "partner": "ON Time Logistics",
                    "newold": "Old",
                    "actual": 539,
                    "target": 399
                },
                {
                    "rank": 2,
                    "partner": "ONE TRIP",
                    "newold": "Old",
                    "actual": 350,
                    "target": 319
                },
                {
                    "rank": 3,
                    "partner": "SDC Logistics",
                    "newold": "New",
                    "actual": 331,
                    "target": 300
                },
                {
                    "rank": 4,
                    "partner": "AL-BARAQ AL-KHATEF",
                    "newold": "Old",
                    "actual": 306,
                    "target": 290
                },
                {
                    "rank": 5,
                    "partner": "First Line Logistics",
                    "newold": "Old",
                    "actual": 443,
                    "target": 289
                },
                {
                    "rank": 6,
                    "partner": "PARTNER SUCCESS",
                    "newold": "Old",
                    "actual": 240,
                    "target": 260
                },
                {
                    "rank": 7,
                    "partner": "Funoon Alkawader",
                    "newold": "Old",
                    "actual": 239,
                    "target": 247
                },
                {
                    "rank": 8,
                    "partner": "services delivery",
                    "newold": "Old",
                    "actual": 291,
                    "target": 231
                },
                {
                    "rank": 9,
                    "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services",
                    "newold": "Old",
                    "actual": 344,
                    "target": 207
                },
                {
                    "rank": 10,
                    "partner": "PCC",
                    "newold": "Old",
                    "actual": 200,
                    "target": 205
                },
                {
                    "rank": 11,
                    "partner": "Mahran Logistics",
                    "newold": "Old",
                    "actual": 201,
                    "target": 200
                },
                {
                    "rank": 12,
                    "partner": "Company Minassah Sahm Commercial",
                    "newold": "Old",
                    "actual": 193,
                    "target": 190
                },
                {
                    "rank": 13,
                    "partner": "Anan Capital",
                    "newold": "Old",
                    "actual": 223,
                    "target": 187
                },
                {
                    "rank": 14,
                    "partner": "FAHAD AL-SHARQ",
                    "newold": "Old",
                    "actual": 267,
                    "target": 180
                },
                {
                    "rank": 15,
                    "partner": "AMC",
                    "newold": "Old",
                    "actual": 171,
                    "target": 175
                },
                {
                    "rank": 16,
                    "partner": "Makhsos logsitics",
                    "newold": "Old",
                    "actual": 191,
                    "target": 175
                },
                {
                    "rank": 17,
                    "partner": "AMIYAL",
                    "newold": "Old",
                    "actual": 160,
                    "target": 173
                },
                {
                    "rank": 18,
                    "partner": "Quick Way Logistics",
                    "newold": "Old",
                    "actual": 163,
                    "target": 170
                },
                {
                    "rank": 19,
                    "partner": "Next Mile",
                    "newold": "New",
                    "actual": 194,
                    "target": 165
                },
                {
                    "rank": 20,
                    "partner": "SAKA SRIAA LALCHUDMAT AL-LUGASTIA",
                    "newold": "Old",
                    "actual": 153,
                    "target": 156
                },
            ],
            "bottom_smallest": [
                {
                    "rank": 1,
                    "partner": "My Way Logistics",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 2,
                    "partner": "NAWAF",
                    "newold": "New",
                    "actual": 8,
                    "target": 10
                },
                {
                    "rank": 3,
                    "partner": "QAWAFIL AL-NAKHABA",
                    "newold": "New",
                    "actual": 22,
                    "target": 10
                },
                {
                    "rank": 4,
                    "partner": "R-C-L",
                    "newold": "New",
                    "actual": 22,
                    "target": 10
                },
                {
                    "rank": 5,
                    "partner": "Darb Al-Thuraya",
                    "newold": "New",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 6,
                    "partner": "Mashariq Al Makan",
                    "newold": "New",
                    "actual": 16,
                    "target": 10
                },
                {
                    "rank": 7,
                    "partner": "TRS",
                    "newold": "New",
                    "actual": 20,
                    "target": 10
                },
                {
                    "rank": 8,
                    "partner": "Mountain logistics",
                    "newold": "New",
                    "actual": 27,
                    "target": 10
                },
                {
                    "rank": 9,
                    "partner": "ghayat albinna",
                    "newold": "New",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 10,
                    "partner": "Bakri Al Zubaidi",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 11,
                    "partner": "Osulha for Logistics",
                    "newold": "Old",
                    "actual": 94,
                    "target": 10
                },
                {
                    "rank": 12,
                    "partner": "ALK",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 13,
                    "partner": "Marasi Roads",
                    "newold": "New",
                    "actual": 4,
                    "target": 10
                },
                {
                    "rank": 14,
                    "partner": "ELRAHAL MUMAIZEH",
                    "newold": "New",
                    "actual": 7,
                    "target": 10
                },
                {
                    "rank": 15,
                    "partner": "Aqbal Logistics",
                    "newold": "Old",
                    "actual": 16,
                    "target": 10
                },
                {
                    "rank": 16,
                    "partner": "Roshn",
                    "newold": "New",
                    "actual": 13,
                    "target": 10
                },
                {
                    "rank": 17,
                    "partner": "Al saqr aljarih",
                    "newold": "Old",
                    "actual": 22,
                    "target": 10
                },
                {
                    "rank": 18,
                    "partner": "LEO Delivery",
                    "newold": "Old",
                    "actual": 25,
                    "target": 10
                },
                {
                    "rank": 19,
                    "partner": "onestep",
                    "newold": "Old",
                    "actual": 19,
                    "target": 10
                },
                {
                    "rank": 20,
                    "partner": "ELIOUM AL-AFDAL",
                    "newold": "New",
                    "actual": 17,
                    "target": 10
                },
            ]
        },
        {
            "month": "Jan",
            "top_biggest": [
                {
                    "rank": 1,
                    "partner": "ON Time Logistics",
                    "newold": "Old",
                    "actual": 391,
                    "target": 342
                },
                {
                    "rank": 2,
                    "partner": "ONE TRIP",
                    "newold": "Old",
                    "actual": 340,
                    "target": 318
                },
                {
                    "rank": 3,
                    "partner": "First Line Logistics",
                    "newold": "Old",
                    "actual": 280,
                    "target": 288
                },
                {
                    "rank": 4,
                    "partner": "AL-BARAQ AL-KHATEF",
                    "newold": "Old",
                    "actual": 275,
                    "target": 280
                },
                {
                    "rank": 5,
                    "partner": "SDC Logistics",
                    "newold": "Old",
                    "actual": 306,
                    "target": 265
                },
                {
                    "rank": 6,
                    "partner": "PARTNER SUCCESS",
                    "newold": "Old",
                    "actual": 246,
                    "target": 255
                },
                {
                    "rank": 7,
                    "partner": "services delivery",
                    "newold": "Old",
                    "actual": 233,
                    "target": 228
                },
                {
                    "rank": 8,
                    "partner": "Makhsos logsitics",
                    "newold": "Old",
                    "actual": 171,
                    "target": 218
                },
                {
                    "rank": 9,
                    "partner": "Anan Capital",
                    "newold": "Old",
                    "actual": 172,
                    "target": 205
                },
                {
                    "rank": 10,
                    "partner": "AMC",
                    "newold": "Old",
                    "actual": 165,
                    "target": 193
                },
                {
                    "rank": 11,
                    "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services",
                    "newold": "Old",
                    "actual": 228,
                    "target": 192
                },
                {
                    "rank": 12,
                    "partner": "Funoon Alkawader",
                    "newold": "Old",
                    "actual": 226,
                    "target": 185
                },
                {
                    "rank": 13,
                    "partner": "Quick Way Logistics",
                    "newold": "Old",
                    "actual": 181,
                    "target": 177
                },
                {
                    "rank": 14,
                    "partner": "SAKA SRIAA LALCHUDMAT AL-LUGASTIA",
                    "newold": "Old",
                    "actual": 153,
                    "target": 175
                },
                {
                    "rank": 15,
                    "partner": "AMIYAL",
                    "newold": "Old",
                    "actual": 175,
                    "target": 169
                },
                {
                    "rank": 16,
                    "partner": "FAHAD AL-SHARQ",
                    "newold": "Old",
                    "actual": 145,
                    "target": 169
                },
                {
                    "rank": 17,
                    "partner": "PCC",
                    "newold": "Old",
                    "actual": 200,
                    "target": 168
                },
                {
                    "rank": 18,
                    "partner": "Company Minassah Sahm Commercial",
                    "newold": "Old",
                    "actual": 148,
                    "target": 167
                },
                {
                    "rank": 19,
                    "partner": "Markhor",
                    "newold": "Old",
                    "actual": 115,
                    "target": 160
                },
                {
                    "rank": 20,
                    "partner": "albwaba",
                    "newold": "Old",
                    "actual": 140,
                    "target": 158
                },
            ],
            "bottom_smallest": [
                {
                    "rank": 1,
                    "partner": "My Way Logistics",
                    "newold": "New",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 2,
                    "partner": "NAWAF",
                    "newold": "New",
                    "actual": 9,
                    "target": 10
                },
                {
                    "rank": 3,
                    "partner": "QAWAFIL AL-NAKHABA",
                    "newold": "Old",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 4,
                    "partner": "fal alraqmiya",
                    "newold": "New",
                    "actual": 25,
                    "target": 10
                },
                {
                    "rank": 5,
                    "partner": "ZikraSabiti",
                    "newold": "Old",
                    "actual": 0,
                    "target": 10
                },
                {
                    "rank": 6,
                    "partner": "STUL AL-MATIAZ",
                    "newold": "Old",
                    "actual": 16,
                    "target": 10
                },
                {
                    "rank": 7,
                    "partner": "GHAIMA SAHAB",
                    "newold": "Old",
                    "actual": 29,
                    "target": 10
                },
                {
                    "rank": 8,
                    "partner": "OPS CARE",
                    "newold": "New",
                    "actual": 18,
                    "target": 10
                },
                {
                    "rank": 9,
                    "partner": "Aqbal Logistics",
                    "newold": "Old",
                    "actual": 12,
                    "target": 10
                },
                {
                    "rank": 10,
                    "partner": "Al saqr aljarih",
                    "newold": "Old",
                    "actual": 13,
                    "target": 10
                },
                {
                    "rank": 11,
                    "partner": "LEO Delivery",
                    "newold": "Old",
                    "actual": 13,
                    "target": 10
                },
                {
                    "rank": 12,
                    "partner": "onestep",
                    "newold": "Old",
                    "actual": 12,
                    "target": 10
                },
                {
                    "rank": 13,
                    "partner": "Quma Teser",
                    "newold": "Old",
                    "actual": 14,
                    "target": 10
                },
                {
                    "rank": 14,
                    "partner": "Last Moment",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 15,
                    "partner": "Mister Wasil",
                    "newold": "New",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 16,
                    "partner": "Shabab Tayba",
                    "newold": "New",
                    "actual": 11,
                    "target": 10
                },
                {
                    "rank": 17,
                    "partner": "almasarat althnaiya",
                    "newold": "Old",
                    "actual": 14,
                    "target": 10
                },
                {
                    "rank": 18,
                    "partner": "GRUBB AL-HAJJAZ",
                    "newold": "Old",
                    "actual": 10,
                    "target": 10
                },
                {
                    "rank": 19,
                    "partner": "Alkhatam Co. for logistics services",
                    "newold": "Old",
                    "actual": 48,
                    "target": 10
                },
                {
                    "rank": 20,
                    "partner": "Speedone",
                    "newold": "Old",
                    "actual": 16,
                    "target": 10
                },
            ]
        },
        {
            "month": "Feb",
            "top_biggest": [
                { "rank": 1, "partner": "ON Time Logistics", "newold": "Old", "actual": 332, "target": 325 },
                { "rank": 2, "partner": "ONE TRIP", "newold": "Old", "actual": 311, "target": 315 },
                { "rank": 3, "partner": "PARTNER SUCCESS", "newold": "Old", "actual": 241, "target": 257 },
                { "rank": 4, "partner": "First Line Logistics", "newold": "Old", "actual": 272, "target": 215 },
                { "rank": 5, "partner": "SDC Logistics", "newold": "Old", "actual": 261, "target": 210 },
                { "rank": 6, "partner": "Anan Capital", "newold": "Old", "actual": 184, "target": 198 },
                { "rank": 7, "partner": "AL-BARAQ AL-KHATEF", "newold": "Old", "actual": 265, "target": 195 },
                { "rank": 8, "partner": "Quick Way Logistics", "newold": "Old", "actual": 155, "target": 186 },
                { "rank": 9, "partner": "Makhsos", "newold": "Old", "actual": 189, "target": 180 },
                { "rank": 10, "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services", "newold": "Old", "actual": 182, "target": 169 },
                { "rank": 11, "partner": "PCC", "newold": "Old", "actual": 189, "target": 168 },
                { "rank": 12, "partner": "AMC", "newold": "Old", "actual": 175, "target": 166 },
                { "rank": 13, "partner": "AMIYAL", "newold": "Old", "actual": 157, "target": 150 },
                { "rank": 14, "partner": "FAHAD AL-SHARQ", "newold": "Old", "actual": 151, "target": 150 },
                { "rank": 15, "partner": "SAKA SRIAA LALCHUDMAT AL-LUGASTIA", "newold": "Old", "actual": 149, "target": 149 },
                { "rank": 16, "partner": "AL-ANJAZ AL-MATARAA", "newold": "Old", "actual": 116, "target": 141 },
                { "rank": 17, "partner": "Holoul", "newold": "Old", "actual": 122, "target": 135 },
                { "rank": 18, "partner": "EXPSERCO", "newold": "Old", "actual": 129, "target": 132 },
                { "rank": 19, "partner": "Establishment ASHRAF BEN HASSIN BEN ALI BOUGRARDAH For logistics", "newold": "Old", "actual": 138, "target": 130 },
                { "rank": 20, "partner": "EXPRESS GATE", "newold": "Old", "actual": 146, "target": 127 }
            ],
            "bottom_smallest": [
                { "rank": 1, "partner": "Afkar Logistics", "newold": "New", "actual": 0, "target": 10 },
                { "rank": 2, "partner": "Tadarak Logistics", "newold": "Old", "actual": 0, "target": 10 },
                { "rank": 3, "partner": "QAWAFIL AL-NAKHABA", "newold": "Old", "actual": 9, "target": 10 },
                { "rank": 4, "partner": "ZikraSabiti", "newold": "New", "actual": 10, "target": 10 },
                { "rank": 5, "partner": "STUL AL-MATIAZ", "newold": "Old", "actual": 11, "target": 10 },
                { "rank": 6, "partner": "NAS", "newold": "Old", "actual": 11, "target": 10 },
                { "rank": 7, "partner": "AL-ALAMIN KOM", "newold": "New", "actual": 16, "target": 10 },
                { "rank": 8, "partner": "alshuhna almumayaza", "newold": "New", "actual": 17, "target": 10 },
                { "rank": 9, "partner": "MUSTER FLE", "newold": "Old", "actual": 19, "target": 10 },
                { "rank": 10, "partner": "Aqbal Logistics", "newold": "Old", "actual": 10, "target": 10 },
                { "rank": 11, "partner": "RADHI ABDULSAMEA", "newold": "New", "actual": 6, "target": 10 },
                { "rank": 12, "partner": "AL-TUQDAM AL-MASI", "newold": "Old", "actual": 8, "target": 10 },
                { "rank": 13, "partner": "almasarat althnaiya", "newold": "Old", "actual": 9, "target": 10 },
                { "rank": 14, "partner": "Selsala", "newold": "New", "actual": 9, "target": 10 },
                { "rank": 15, "partner": "ashara khutut", "newold": "New", "actual": 10, "target": 10 },
                { "rank": 16, "partner": "Al Nsoor (Eagle Logistics)", "newold": "Old", "actual": 0, "target": 10 },
                { "rank": 17, "partner": "LEO Delivery", "newold": "Old", "actual": 12, "target": 10 },
                { "rank": 18, "partner": "Swiftlane", "newold": "Old", "actual": 12, "target": 10 },
                { "rank": 19, "partner": "Alkhutut Almudhia", "newold": "Old", "actual": 14, "target": 10 },
                { "rank": 20, "partner": "Rakb Tayba", "newold": "Old", "actual": 15, "target": 10 }
            ],
            "top_ranked": [
                { "rank": 1, "partner": "First Line Logistics", "newold": "Old", "cities": 9, "actual": 272, "target": 215 },
                { "rank": 2, "partner": "NAJIZ", "newold": "Old", "cities": 5, "actual": 117, "target": 51 },
                { "rank": 3, "partner": "ONE TRIP", "newold": "Old", "cities": 5, "actual": 311, "target": 315 },
                { "rank": 4, "partner": "Next Mile", "newold": "Old", "cities": 5, "actual": 131, "target": 121 },
                { "rank": 5, "partner": "Anan Capital", "newold": "Old", "cities": 5, "actual": 184, "target": 198 },
                { "rank": 6, "partner": "Quick Way Logistics", "newold": "Old", "cities": 5, "actual": 155, "target": 186 },
                { "rank": 7, "partner": "Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services", "newold": "Old", "cities": 5, "actual": 182, "target": 169 },
                { "rank": 8, "partner": "ON Time Logistics", "newold": "Old", "cities": 5, "actual": 332, "target": 325 },
                { "rank": 9, "partner": "Aibtukir", "newold": "Old", "cities": 5, "actual": 113, "target": 72 },
                { "rank": 10, "partner": "services delivery", "newold": "Old", "cities": 4, "actual": 142, "target": 122 },
                { "rank": 11, "partner": "SAKA SRIAA LALCHUDMAT AL-LUGASTIA", "newold": "Old", "cities": 4, "actual": 149, "target": 149 },
                { "rank": 12, "partner": "TEM AL-TOUSSIL", "newold": "Old", "cities": 4, "actual": 111, "target": 109 },
                { "rank": 13, "partner": "Sama Golden logistics", "newold": "Old", "cities": 4, "actual": 60, "target": 70 },
                { "rank": 14, "partner": "AMIYAL", "newold": "Old", "cities": 3, "actual": 157, "target": 150 },
                { "rank": 15, "partner": "WABM Logistics", "newold": "Old", "cities": 3, "actual": 44, "target": 66 },
                { "rank": 16, "partner": "Tomorrow's Falcons Company", "newold": "Old", "cities": 3, "actual": 78, "target": 65 },
                { "rank": 17, "partner": "Saudi falcon for logistics", "newold": "Old", "cities": 3, "actual": 62, "target": 43 },
                { "rank": 18, "partner": "HERVEY AL-WAHHA", "newold": "Old", "cities": 3, "actual": 71, "target": 80 },
                { "rank": 19, "partner": "SHAFAQ AL-KHAYR", "newold": "Old", "cities": 3, "actual": 83, "target": 75 },
                { "rank": 20, "partner": "Ettijahat", "newold": "Old", "cities": 3, "actual": 64, "target": 54 }
            ]
        },
    ];

    function updateTopMoversTable(selectedMonth) {
        try {
            const monthData = topMoversData.find(m => m.month === selectedMonth);
            if (!monthData) {
                console.log('No data for month:', selectedMonth);
                return;
            }
            
            // Update biggest partners table (top riders)
            const biggestBody = document.getElementById('topIncreasesTableBody');
            if (biggestBody) {
                biggestBody.innerHTML = '';
                monthData.top_biggest.forEach((mover, idx) => {
                    const bg = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    const newOldColor = mover.newold === 'New' ? '#10b981' : '#6b7280';
                    const newOldBg = mover.newold === 'New' ? '#d1fae5' : '#f3f4f6';
                    
                    biggestBody.innerHTML += `
                        <tr style="background: ${bg};">
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 700;">${mover.rank}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 10px;" title="${mover.partner}">${mover.partner.substring(0, 28)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><span style="background: ${newOldBg}; color: ${newOldColor}; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">${mover.newold}</span></td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 600;">${mover.actual.toFixed(1)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${mover.target}</td>
                        </tr>
                    `;
                });
            }
            
            // Update smallest partners table (bottom riders)
            const smallestBody = document.getElementById('topDecreasesTableBody');
            if (smallestBody) {
                smallestBody.innerHTML = '';
                monthData.bottom_smallest.forEach((mover, idx) => {
                    const bg = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    const newOldColor = mover.newold === 'New' ? '#10b981' : '#6b7280';
                    const newOldBg = mover.newold === 'New' ? '#d1fae5' : '#f3f4f6';
                    
                    smallestBody.innerHTML += `
                        <tr style="background: ${bg};">
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 700;">${mover.rank}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 10px;" title="${mover.partner}">${mover.partner.substring(0, 28)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><span style="background: ${newOldBg}; color: ${newOldColor}; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">${mover.newold}</span></td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 600;">${mover.actual.toFixed(1)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${mover.target}</td>
                        </tr>
                    `;
                });
            }

            // Update ranked partners table (by city coverage) - Feb only
            const rankedBody = document.getElementById('topRankedTableBody');
            if (rankedBody) {
                if (monthData.top_ranked) {
                    rankedBody.innerHTML = '';
                    monthData.top_ranked.forEach((mover, idx) => {
                        const bg = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                        const newOldColor = mover.newold === 'New' ? '#10b981' : '#6b7280';
                        const newOldBg = mover.newold === 'New' ? '#d1fae5' : '#f3f4f6';
                        
                        rankedBody.innerHTML += `
                            <tr style="background: ${bg};">
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 700;">${mover.rank}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; font-size: 10px;" title="${mover.partner}">${mover.partner.substring(0, 28)}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 600;">${mover.cities}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><span style="background: ${newOldBg}; color: ${newOldColor}; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 10px;">${mover.newold}</span></td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: 600;">${mover.actual}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${mover.target}</td>
                            </tr>
                        `;
                    });
                } else {
                    rankedBody.innerHTML = '<tr><td colspan="6" style="padding: 12px; text-align: center; color: #6b7280; font-style: italic;">No ranked data available for this month.</td></tr>';
                }
            }
        } catch(e) {
            console.error('Error updating Top Movers:', e);
        }
    }
    
    // Initialize Top Movers on page load and tab switch
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            updateTopMoversTable('Feb');
        }, 1500);
    });

    // Toggle function for expandable tables
    function toggleTable(button, tableId) {
        const table = document.getElementById(tableId);
        const isHidden = table.style.display === 'none';
        
        if (isHidden) {
            table.style.display = 'block';
            button.textContent = '▲ Click to hide detailed data ▲';
        } else {
            table.style.display = 'none';
            button.textContent = '▼ Click to view detailed data ▼';
        }
    }

    // FR Range Filter Button Handler
    document.addEventListener('DOMContentLoaded', function() {
        const impactTablesMount = document.getElementById('impactDetailedTablesMount');
        const detailedTablesSection = document.getElementById('detailedTablesSection');
        if (impactTablesMount && detailedTablesSection && detailedTablesSection.parentElement !== impactTablesMount) {
            impactTablesMount.appendChild(detailedTablesSection);
        }
        const targetRangeView = document.getElementById('targetRangeView');
        if (detailedTablesSection && targetRangeView) {
            const targetRangeActive = window.getComputedStyle(targetRangeView).display !== 'none'
                || document.querySelector('.analysis-type-toggle[data-type="target-range"].active');
            if (targetRangeActive) {
                detailedTablesSection.style.display = 'block';
            }
        }

        // Impact Section - Metric Toggle Handler
        document.querySelectorAll('.impact-metric-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const metric = this.getAttribute('data-metric');
                const metricColor = metric === 'fr' ? '#3b82f6' : '#f97316';
                resetImpactPerfFilters();
                
                // Update active button styling
                document.querySelectorAll('.impact-metric-toggle').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                    btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                });
                this.classList.add('active');
                this.style.background = metricColor;
                this.style.color = 'white';
                this.style.borderColor = metricColor;
                this.style.boxShadow = metric === 'fr'
                    ? '0 4px 12px rgba(59, 130, 246, 0.3)'
                    : '0 4px 12px rgba(249, 115, 22, 0.3)';
                
                // Update title
                const titles = {
                    fr: 'Face Recognition (FR) Range Impact - Target Changes (Jan vs Feb)',
                    dc: 'Driver Card Range Impact - Target Changes (Jan vs Feb)'
                };
                document.getElementById('impactTitle').textContent = titles[metric] || titles.fr;
                
                // Reset filter to "all" when changing metric
                document.querySelectorAll('.impact-filter-btn').forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                });
                document.querySelector('[data-filter="all"]').style.background = metric === 'fr' ? '#3b82f6' : '#f97316';
                document.querySelector('[data-filter="all"]').style.color = 'white';
                document.querySelector('[data-filter="all"]').style.borderColor = metric === 'fr' ? '#3b82f6' : '#f97316';
                
                // Reinitialize chart with new metric
                window.initImpactChartOverall(metric);
                document.getElementById('impactChartSingle').style.display = 'none';
                document.getElementById('impactChartDual').style.display = 'none';
                document.getElementById('impactChartOverall').style.display = 'block';
                document.getElementById('impactChartWithTarget').style.display = 'none';
                if (window.updateImpactKpiCards) {
                    window.updateImpactKpiCards(metric, 'all');
                }
                
                // Show/hide detailed tables based on metric
                if (metric === 'fr') {
                    document.getElementById('frDetailedTablesWrapper').style.display = 'block';
                    document.getElementById('dcDetailedTablesWrapper').style.display = 'none';
                } else {
                    document.getElementById('frDetailedTablesWrapper').style.display = 'none';
                    document.getElementById('dcDetailedTablesWrapper').style.display = 'block';
                }
                
                // Resize chart to ensure proper rendering
                setTimeout(() => {
                    if (impactChartSingle) {
                        impactChartSingle.resize();
                    }
                }, 100);
            });
        });

        function resetImpactPerfFilters() {
            const perfButtons = document.querySelectorAll('.impact-perf-filter-btn');
            perfButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#6b7280';
                btn.style.borderColor = '#e5e7eb';
            });
            window.currentImpactPerfFilter = 'all';
        }

        // Impact Section - Filter Handler
        document.querySelectorAll('.impact-filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                console.log('Filter clicked:', filter);

                resetImpactPerfFilters();
                
                // Find active metric button
                let activeMetric = 'fr';
                const activeMetricBtn = document.querySelector('.impact-metric-toggle.active');
                if (activeMetricBtn) {
                    activeMetric = activeMetricBtn.getAttribute('data-metric');
                }
                console.log('Active metric determined:', activeMetric);
                
                // Update active button styling
                const metricColor = activeMetric === 'fr' ? '#3b82f6' : '#f97316';
                document.querySelectorAll('.impact-filter-btn').forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                });
                this.style.background = metricColor;
                this.style.color = 'white';
                this.style.borderColor = metricColor;
                
                // Update title based on metric and filter
                const titles = {
                    'fr-new': 'Face Recognition (FR) Range Impact - Target Changes (Jan vs Feb)',
                    'fr-old': 'Face Recognition (FR) Range Impact - Target Changes (Jan vs Feb)',
                    'fr-both': 'Face Recognition (FR) Range Impact - Target Changes (Jan vs Feb)',
                    'fr-all': 'Face Recognition (FR) All Partners Summary - Target Changes Across Ranges',
                    'fr-withtarget': 'Face Recognition (FR) Partners with Target Summary - Active Partners Across Ranges',
                    'dc-new': 'Driver Card Range Impact - Target Changes (Jan vs Feb)',
                    'dc-old': 'Driver Card Range Impact - Target Changes (Jan vs Feb)',
                    'dc-both': 'Driver Card Range Impact - Target Changes (Jan vs Feb)',
                    'dc-all': 'Driver Card All Partners Summary - Target Changes Across Ranges',
                    'dc-withtarget': 'Driver Card Partners with Target Summary - Active Partners Across Ranges'
                };
                document.getElementById('impactTitle').textContent = titles[`${activeMetric}-${filter}`] || titles[`${activeMetric}-new`];
                
                // Handle different filters
                if (filter === 'new' || filter === 'old') {
                    console.log('Showing single view for metric:', activeMetric, 'filter:', filter);
                    document.getElementById('impactChartSingle').style.display = 'block';
                    document.getElementById('impactChartDual').style.display = 'none';
                    document.getElementById('impactChartOverall').style.display = 'none';
                    document.getElementById('impactChartWithTarget').style.display = 'none';
                    window.initImpactChartSingle(activeMetric, filter);
                    if (window.updateImpactKpiCards) {
                        window.updateImpactKpiCards(activeMetric, filter);
                    }
                } else if (filter === 'both') {
                    console.log('Showing dual view for metric:', activeMetric);
                    document.getElementById('impactChartSingle').style.display = 'none';
                    document.getElementById('impactChartDual').style.display = 'flex';
                    document.getElementById('impactChartOverall').style.display = 'none';
                    document.getElementById('impactChartWithTarget').style.display = 'none';
                    window.initImpactChartDual(activeMetric);
                    if (window.updateImpactKpiCards) {
                        window.updateImpactKpiCards(activeMetric, filter);
                    }
                } else if (filter === 'all') {
                    console.log('Showing all partners view for metric:', activeMetric);
                    document.getElementById('impactChartSingle').style.display = 'none';
                    document.getElementById('impactChartDual').style.display = 'none';
                    document.getElementById('impactChartOverall').style.display = 'block';
                    document.getElementById('impactChartWithTarget').style.display = 'none';
                    window.initImpactChartOverall(activeMetric);
                    if (window.updateImpactKpiCards) {
                        window.updateImpactKpiCards(activeMetric, filter);
                    }
                } else if (filter === 'withtarget') {
                    console.log('Showing with target view for metric:', activeMetric);
                    document.getElementById('impactChartSingle').style.display = 'none';
                    document.getElementById('impactChartDual').style.display = 'none';
                    document.getElementById('impactChartOverall').style.display = 'none';
                    document.getElementById('impactChartWithTarget').style.display = 'block';
                    window.initImpactChartWithTarget(activeMetric);
                    if (window.updateImpactKpiCards) {
                        window.updateImpactKpiCards(activeMetric, filter);
                    }
                }
            });
        });

        // Impact Section - Performance Filter Handler
        document.querySelectorAll('.impact-perf-filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                const perf = this.getAttribute('data-perf');
                
                // Find active metric button
                let activeMetric = 'fr';
                const activeMetricBtn = document.querySelector('.impact-metric-toggle.active');
                if (activeMetricBtn) {
                    activeMetric = activeMetricBtn.getAttribute('data-metric');
                }
                
                // Update Performance button styles
                document.querySelectorAll('.impact-perf-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                });
                this.classList.add('active');
                this.style.background = '#059669';
                this.style.color = 'white';
                this.style.borderColor = '#059669';
                window.currentImpactPerfFilter = perf;
                
                // Reset View filter buttons to inactive state (same as Compliance Distribution)
                document.querySelectorAll('.impact-filter-btn').forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                });
                
                // Update title based on performance
                const perfLabel = perf === 'all' ? 'All Partners' : (perf.charAt(0).toUpperCase() + perf.slice(1) + ' Partners');
                const metricLabel = activeMetric === 'fr' ? 'Face Recognition (FR)' : 'Driver Card';
                document.getElementById('impactTitle').textContent = `${metricLabel} Range Impact - ${perfLabel}`;
                
                // Update Impact KPI cards with performance data
                updateImpactPerfKpiCards(perf, activeMetric);
                
                // Update Impact chart with performance data
                updateImpactChartForPerfFilter(perf, activeMetric);
            });
        });
        
        // Function to update Impact KPI cards for performance filter
        function updateImpactPerfKpiCards(perf, metric) {
            const partnersValue = document.getElementById('impactPartnersValue');
            const partnersSub = document.getElementById('impactPartnersSub');
            const partnersSplit = document.getElementById('impactPartnersSplit');
            const targetsValue = document.getElementById('impactTargetsValue');
            const targetsSub = document.getElementById('impactTargetsSub');
            const targetsChange = document.getElementById('impactTargetsChange');
            
            if (metric === 'fr') {
                const perfData = {
                    all: { partners: 551, partnersSub: 'Partners with Target', split: 'New: 127 (23.0%) | Old: 424 (77.0%)', target: '19,365', targetSub: 'Total Feb Target', change: 'Avg FR Rate: 92.4%' },
                    good: { partners: 252, partnersSub: 'Good Partners', split: 'New: 58 (23.0%) | Old: 194 (77.0%)', target: '10,192', targetSub: 'Good Partners Target', change: 'Avg FR Rate: 96.5%' },
                    average: { partners: 262, partnersSub: 'Average Partners', split: 'New: 60 (22.9%) | Old: 202 (77.1%)', target: '8,414', targetSub: 'Average Partners Target', change: 'Avg FR Rate: 92.0%' },
                    bad: { partners: 20, partnersSub: 'Bad Partners', split: 'New: 5 (25.0%) | Old: 15 (75.0%)', target: '370', targetSub: 'Bad Partners Target', change: 'Avg FR Rate: 72.9%' }
                };
                const data = perfData[perf] || perfData.all;
                partnersValue.textContent = data.partners;
                partnersSub.textContent = data.partnersSub;
                partnersSplit.textContent = data.split;
                targetsValue.textContent = data.target;
                targetsSub.textContent = data.targetSub;
                targetsChange.textContent = data.change;
            } else {
                const perfData = {
                    all: { partners: 551, partnersSub: 'Partners with Target', split: 'New: 127 (23.0%) | Old: 424 (77.0%)', target: '19,365', targetSub: 'Total Feb Target', change: 'Avg DC Rate: 40.5%' },
                    good: { partners: 252, partnersSub: 'Good Partners', split: 'New: 58 (23.0%) | Old: 194 (77.0%)', target: '10,192', targetSub: 'Good Partners Target', change: 'Avg DC Rate: 42.8%' },
                    average: { partners: 262, partnersSub: 'Average Partners', split: 'New: 60 (22.9%) | Old: 202 (77.1%)', target: '8,414', targetSub: 'Average Partners Target', change: 'Avg DC Rate: 39.0%' },
                    bad: { partners: 20, partnersSub: 'Bad Partners', split: 'New: 5 (25.0%) | Old: 15 (75.0%)', target: '370', targetSub: 'Bad Partners Target', change: 'Avg DC Rate: 33.5%' }
                };
                const data = perfData[perf] || perfData.all;
                partnersValue.textContent = data.partners;
                partnersSub.textContent = data.partnersSub;
                partnersSplit.textContent = data.split;
                targetsValue.textContent = data.target;
                targetsSub.textContent = data.targetSub;
                targetsChange.textContent = data.change;
            }
        }
        
        // Function to update Impact chart for performance filter
        function updateImpactChartForPerfFilter(perf, metric) {
            // Performance data for FR targets by range
            const frPerfTargetData = {
                all: [369, 0, 19, 0, 11, 628, 18338],
                good: [0, 0, 0, 0, 0, 182, 10010],
                average: [0, 0, 0, 0, 0, 396, 8018],
                bad: [35, 0, 19, 0, 11, 50, 255]
            };
            
            // Performance data for DC targets by range
            const dcPerfTargetData = {
                all: [8347, 1567, 1318, 800, 978, 1402, 4953],
                good: [4600, 762, 537, 341, 449, 735, 2768],
                average: [3270, 805, 781, 420, 514, 587, 2037],
                bad: [178, 0, 0, 39, 15, 50, 88]
            };
            
            const data = metric === 'fr' ? frPerfTargetData[perf] : dcPerfTargetData[perf];
            const perfLabel = perf === 'all' ? 'All Partners' : (perf.charAt(0).toUpperCase() + perf.slice(1) + ' Partners');
            
            // Color scheme based on performance category
            const colorSchemes = {
                all: { line: '#3b82f6', fill: 'rgba(59, 130, 246, 0.15)', point: '#2563eb' },
                good: { line: '#10b981', fill: 'rgba(16, 185, 129, 0.15)', point: '#059669' },
                average: { line: '#f59e0b', fill: 'rgba(245, 158, 11, 0.15)', point: '#d97706' },
                bad: { line: '#ef4444', fill: 'rgba(239, 68, 68, 0.15)', point: '#dc2626' }
            };
            const colors = colorSchemes[perf] || colorSchemes.all;
            
            // Show single chart, hide others
            document.getElementById('impactChartSingle').style.display = 'block';
            document.getElementById('impactChartDual').style.display = 'none';
            document.getElementById('impactChartOverall').style.display = 'none';
            document.getElementById('impactChartWithTarget').style.display = 'none';
            
            // Destroy existing chart and create new one
            if (window.impactChartSingle) {
                try { window.impactChartSingle.destroy(); } catch(e) {}
            }
            
            const canvas = document.getElementById('impactChartSingleCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // Create gradient fill
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, colors.fill.replace('0.15', '0.4'));
            gradient.addColorStop(0.5, colors.fill.replace('0.15', '0.2'));
            gradient.addColorStop(1, colors.fill.replace('0.15', '0.02'));
            
            window.impactChartSingle = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'],
                    datasets: [{
                        label: `${perfLabel} Target`,
                        data: data,
                        borderColor: colors.line,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.point,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: colors.point,
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.8,
                    layout: { padding: { top: 35, right: 20 } },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.95)',
                            padding: 14,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: colors.line,
                            borderWidth: 1,
                            displayColors: true,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, v) => sum + v, 0);
                                    const pct = total ? ((context.parsed.y / total) * 100).toFixed(1) : '0.0';
                                    return `  ${context.dataset.label}: ${context.parsed.y.toLocaleString()} riders (${pct}%)`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            font: { size: 11, weight: 'bold' },
                            color: colors.point,
                            backgroundColor: 'rgba(255, 255, 255, 0.85)',
                            borderRadius: 4,
                            padding: { top: 3, bottom: 3, left: 6, right: 6 },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((sum, v) => sum + v, 0);
                                const pct = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                return value.toLocaleString() + ' (' + pct + '%)';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.06)',
                                drawBorder: false
                            },
                            ticks: { 
                                callback: (value) => value.toLocaleString(), 
                                font: { size: 11 },
                                padding: 8
                            },
                            title: { 
                                display: true, 
                                text: 'Target Riders', 
                                font: { size: 12, weight: 'bold' },
                                padding: { bottom: 10 }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 11 },
                                padding: 8
                            },
                            title: { 
                                display: true, 
                                text: metric === 'fr' ? 'FR Rate Range' : 'DC Rate Range', 
                                font: { size: 12, weight: 'bold' },
                                padding: { top: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Mark initial metric as active
        document.querySelector('[data-metric="fr"]').classList.add('active');
        
        // Analysis Type Toggle Handler (Compliance vs Target Range)
        document.querySelectorAll('.analysis-type-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const analysisType = this.getAttribute('data-type');
                
                // Update active button styling
                document.querySelectorAll('.analysis-type-toggle').forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.color = '#6b7280';
                    btn.style.borderColor = '#e5e7eb';
                    btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                });
                const activeColor = analysisType === 'compliance' ? '#059669' : (analysisType === 'target-range' ? '#3b82f6' : '#8b5cf6');
                this.style.background = activeColor;
                this.style.color = 'white';
                this.style.borderColor = activeColor;
                this.style.boxShadow = analysisType === 'compliance'
                    ? '0 4px 12px rgba(5, 150, 105, 0.3)'
                    : (analysisType === 'target-range'
                        ? '0 4px 12px rgba(59, 130, 246, 0.3)'
                        : '0 4px 12px rgba(139, 92, 246, 0.3)');
                
                // Show/hide views
                if (analysisType === 'compliance') {
                    document.getElementById('complianceAnalysisView').style.display = 'block';
                    document.getElementById('targetRangeView').style.display = 'none';
                    document.getElementById('cityWiseView').style.display = 'none';
                    document.getElementById('detailedTablesSection').style.display = 'none';
                    // Re-trigger donut animation
                    const frCard = document.getElementById('frAvgCard');
                    const dcCard = document.getElementById('dcAvgCard');
                    // Check which metric is currently active
                    const activeMetricBtn = document.querySelector('.metric-toggle-btn.active');
                    const currentMetric = activeMetricBtn ? activeMetricBtn.getAttribute('data-metric') : 'fr';
                    
                    if (frCard) {
                        frCard.classList.remove('animate-in');
                        frCard.style.opacity = '0';
                        frCard.style.filter = 'none';
                        void frCard.offsetWidth; // Force reflow
                        frCard.classList.add('animate-in');
                    }
                    setTimeout(() => {
                        if (dcCard) {
                            dcCard.classList.remove('animate-in');
                            dcCard.style.opacity = '0';
                            dcCard.style.filter = 'none';
                            void dcCard.offsetWidth;
                            dcCard.classList.add('animate-in');
                        }
                        // Apply blur to inactive card after animation
                        setTimeout(() => {
                            if (currentMetric === 'fr') {
                                if (frCard) {
                                    frCard.style.opacity = '1';
                                    frCard.style.filter = 'none';
                                    frCard.style.transform = 'scale(1)';
                                }
                                if (dcCard) {
                                    dcCard.style.opacity = '0.5';
                                    dcCard.style.filter = 'blur(1px)';
                                    dcCard.style.transform = 'scale(0.95)';
                                }
                            } else {
                                if (dcCard) {
                                    dcCard.style.opacity = '1';
                                    dcCard.style.filter = 'none';
                                    dcCard.style.transform = 'scale(1)';
                                }
                                if (frCard) {
                                    frCard.style.opacity = '0.5';
                                    frCard.style.filter = 'blur(1px)';
                                    frCard.style.transform = 'scale(0.95)';
                                }
                            }
                        }, 700);
                    }, 200);
                } else if (analysisType === 'target-range') {
                    document.getElementById('complianceAnalysisView').style.display = 'none';
                    document.getElementById('targetRangeView').style.display = 'block';
                    document.getElementById('cityWiseView').style.display = 'none';
                    document.getElementById('detailedTablesSection').style.display = 'block';
                    // Trigger KPI card fly-in animation
                    const partnersCard = document.getElementById('impactPartnersCard');
                    const targetsCard = document.getElementById('impactTargetsCard');
                    if (partnersCard) {
                        partnersCard.classList.remove('fly-in');
                        partnersCard.style.opacity = '0';
                        void partnersCard.offsetWidth;
                        partnersCard.classList.add('fly-in');
                    }
                    setTimeout(() => {
                        if (targetsCard) {
                            targetsCard.classList.remove('fly-in');
                            targetsCard.style.opacity = '0';
                            void targetsCard.offsetWidth;
                            targetsCard.classList.add('fly-in');
                        }
                    }, 150); // Staggered animation
                    if (window.updateImpactKpiCards) {
                        window.updateImpactKpiCards('fr', 'all');
                    }
                } else {
                    document.getElementById('complianceAnalysisView').style.display = 'none';
                    document.getElementById('targetRangeView').style.display = 'none';
                    document.getElementById('cityWiseView').style.display = 'block';
                    document.getElementById('detailedTablesSection').style.display = 'none';
                    // Trigger KPI card fly-in animation
                    const avgCard = document.getElementById('cityWiseAvgCard');
                    const riskCard = document.getElementById('cityWiseRiskCard');
                    if (avgCard) {
                        avgCard.classList.remove('fly-in');
                        avgCard.style.opacity = '0';
                        void avgCard.offsetWidth;
                        avgCard.classList.add('fly-in');
                    }
                    setTimeout(() => {
                        if (riskCard) {
                            riskCard.classList.remove('fly-in');
                            riskCard.style.opacity = '0';
                            void riskCard.offsetWidth;
                            riskCard.classList.add('fly-in');
                        }
                    }, 150); // Staggered animation
                    if (window.initCityWiseCompliance) {
                        window.initCityWiseCompliance();
                    }
                }
            });
        });

        // City-wise Compliance Analysis (FR & Driver Card)
        const cityWiseRangeLabels = ['0-20%', '20-30%', '30-40%', '40-50%', '50-60%', '60-80%', '>80%'];
        const cityWiseData = {
            summary: [
                { city: 'Abha', partners: 15, fr: 91.9, dc: 70.9 },
                { city: 'Al Ahsa', partners: 28, fr: 98.4, dc: 54.0 },
                { city: 'Al Kharj', partners: 8, fr: 98.3, dc: 37.9 },
                { city: 'Buraydah', partners: 10, fr: 99.8, dc: 57.3 },
                { city: 'Dammam', partners: 64, fr: 96.9, dc: 37.0 },
                { city: 'Hafar Albatin', partners: 7, fr: 99.3, dc: 69.1 },
                { city: 'Hail', partners: 5, fr: 99.2, dc: 38.6 },
                { city: 'Jazan', partners: 3, fr: 100.0, dc: 42.8 },
                { city: 'Jeddah', partners: 83, fr: 92.3, dc: 43.6 },
                { city: 'Jubail', partners: 10, fr: 89.8, dc: 19.2 },
                { city: 'Makkah', partners: 41, fr: 90.9, dc: 54.1 },
                { city: 'Medina', partners: 37, fr: 96.2, dc: 42.8 },
                { city: 'Najran', partners: 5, fr: 100.0, dc: 28.8 },
                { city: 'Riyadh', partners: 200, fr: 88.1, dc: 33.3 },
                { city: 'Tabuk', partners: 11, fr: 99.6, dc: 22.9 },
                { city: 'Taif', partners: 14, fr: 89.0, dc: 42.7 },
                { city: 'Yanbu', partners: 10, fr: 97.4, dc: 41.3 }
            ],
            frPartnersRanges: {
                'Abha': [1, 0, 0, 0, 0, 0, 14],
                'Al Ahsa': [0, 0, 0, 0, 0, 0, 28],
                'Al Kharj': [0, 0, 0, 0, 0, 0, 8],
                'Buraydah': [0, 0, 0, 0, 0, 0, 10],
                'Dammam': [1, 0, 0, 0, 0, 0, 63],
                'Hafar Albatin': [0, 0, 0, 0, 0, 0, 7],
                'Hail': [0, 0, 0, 0, 0, 0, 5],
                'Jazan': [0, 0, 0, 0, 0, 0, 3],
                'Jeddah': [3, 0, 0, 0, 0, 4, 76],
                'Jubail': [1, 0, 0, 0, 0, 0, 9],
                'Makkah': [3, 0, 0, 0, 0, 0, 38],
                'Medina': [0, 0, 0, 0, 0, 1, 36],
                'Najran': [0, 0, 0, 0, 0, 0, 5],
                'Riyadh': [7, 0, 1, 0, 1, 18, 173],
                'Tabuk': [0, 0, 0, 0, 0, 0, 11],
                'Taif': [1, 0, 0, 0, 0, 0, 13],
                'Yanbu': [0, 0, 0, 0, 0, 0, 10]
            },
            frTargetRanges: {
                'Abha': [10, 0, 0, 0, 0, 0, 287],
                'Al Ahsa': [0, 0, 0, 0, 0, 0, 818],
                'Al Kharj': [0, 0, 0, 0, 0, 0, 347],
                'Buraydah': [0, 0, 0, 0, 0, 0, 253],
                'Dammam': [25, 0, 0, 0, 0, 0, 2102],
                'Hafar Albatin': [0, 0, 0, 0, 0, 0, 109],
                'Hail': [0, 0, 0, 0, 0, 0, 186],
                'Jazan': [0, 0, 0, 0, 0, 0, 74],
                'Jeddah': [60, 0, 0, 0, 0, 50, 3344],
                'Jubail': [12, 0, 0, 0, 0, 0, 218],
                'Makkah': [36, 0, 0, 0, 0, 0, 899],
                'Medina': [0, 0, 0, 0, 0, 12, 1119],
                'Najran': [0, 0, 0, 0, 0, 0, 78],
                'Riyadh': [216, 0, 19, 0, 11, 566, 7849],
                'Tabuk': [0, 0, 0, 0, 0, 0, 202],
                'Taif': [10, 0, 0, 0, 0, 0, 282],
                'Yanbu': [0, 0, 0, 0, 0, 0, 171]
            },
            dcPartnersRanges: {
                'Abha': [1, 1, 0, 1, 2, 2, 8],
                'Al Ahsa': [9, 1, 1, 2, 0, 5, 10],
                'Al Kharj': [2, 1, 1, 2, 1, 0, 1],
                'Buraydah': [1, 1, 2, 1, 1, 0, 4],
                'Dammam': [27, 8, 4, 4, 4, 7, 10],
                'Hafar Albatin': [2, 0, 0, 0, 0, 0, 5],
                'Hail': [2, 1, 0, 0, 0, 0, 2],
                'Jazan': [0, 2, 0, 0, 0, 0, 1],
                'Jeddah': [36, 3, 4, 4, 5, 5, 26],
                'Jubail': [6, 1, 2, 0, 0, 0, 1],
                'Makkah': [10, 3, 3, 4, 2, 4, 15],
                'Medina': [17, 1, 0, 2, 3, 4, 10],
                'Najran': [3, 0, 0, 0, 1, 0, 1],
                'Riyadh': [107, 14, 14, 3, 8, 16, 38],
                'Tabuk': [5, 3, 1, 1, 1, 0, 0],
                'Taif': [5, 1, 1, 1, 2, 0, 4],
                'Yanbu': [4, 2, 1, 0, 0, 0, 3]
            },
            dcTargetRanges: {
                'Abha': [10, 20, 0, 20, 40, 35, 172],
                'Al Ahsa': [222, 40, 25, 60, 0, 189, 282],
                'Al Kharj': [123, 25, 85, 64, 15, 0, 35],
                'Buraydah': [24, 25, 35, 15, 15, 0, 139],
                'Dammam': [850, 332, 128, 167, 154, 221, 275],
                'Hafar Albatin': [20, 0, 0, 0, 0, 0, 89],
                'Hail': [58, 20, 0, 0, 0, 0, 108],
                'Jazan': [0, 54, 0, 0, 0, 0, 20],
                'Jeddah': [1302, 88, 262, 125, 281, 209, 1187],
                'Jubail': [146, 15, 37, 0, 0, 0, 32],
                'Makkah': [208, 55, 80, 87, 32, 80, 393],
                'Medina': [459, 36, 0, 134, 57, 122, 323],
                'Najran': [53, 0, 0, 0, 10, 0, 15],
                'Riyadh': [4614, 748, 616, 82, 296, 546, 1759],
                'Tabuk': [85, 51, 25, 18, 23, 0, 0],
                'Taif': [88, 28, 12, 28, 55, 0, 81],
                'Yanbu': [85, 30, 13, 0, 0, 0, 43]
            }
        };

        const cityWiseTierMap = {
            'Riyadh': 't1',
            'Medina': 't1',
            'Makkah': 't1',
            'Jeddah': 't1',
            'Dammam': 't1',
            'Al Kharj': 't1',
            'Al Ahsa': 't1',
            'Abha': 't2',
            'Buraydah': 't2',
            'Hail': 't2',
            'Jazan': 't2',
            'Jubail': 't2',
            'Tabuk': 't2',
            'Taif': 't2',
            'Yanbu': 't2',
            'Hafar Albatin': 't2',
            'Najran': 't2'
        };

        let cityWiseOverviewChart = null;
        let cityWiseRangeChart = null;
        let cityWiseTargetRangeChart = null;
        let cityWiseT1OverviewChart = null;
        let cityWiseT2OverviewChart = null;
        let cityWiseState = { metric: 'fr', view: 'overview', city: 'Riyadh', tier: 'all' };

        function getCityWiseMetricColor(metric) {
            return metric === 'fr' ? '#3b82f6' : '#10b981';
        }

        function getCityRiskLevel(metric, value) {
            if (metric === 'fr') {
                if (value < 85) return { label: 'High Risk', color: '#ef4444', bg: '#fee2e2' };
                if (value < 92) return { label: 'Moderate Risk', color: '#f59e0b', bg: '#fef3c7' };
                return { label: 'Low Risk', color: '#16a34a', bg: '#dcfce7' };
            }
            if (value < 30) return { label: 'High Risk', color: '#ef4444', bg: '#fee2e2' };
            if (value < 40) return { label: 'Moderate Risk', color: '#f59e0b', bg: '#fef3c7' };
            return { label: 'Low Risk', color: '#16a34a', bg: '#dcfce7' };
        }

        function getPctHighlightColor(pct) {
            return pct < 10 ? '#dc2626' : '#16a34a';
        }

        function getCityTierLabel() {
            if (cityWiseState.tier === 't1') return 'T1 Cities';
            if (cityWiseState.tier === 't2') return 'T2 Cities';
            return 'All Cities';
        }

        function getFilteredCitySummary() {
            if (cityWiseState.tier === 'all') return [...cityWiseData.summary];
            return cityWiseData.summary.filter(c => cityWiseTierMap[c.city] === cityWiseState.tier);
        }

        function updateCityWiseSummaryCards() {
            const metricKey = cityWiseState.metric === 'fr' ? 'fr' : 'dc';
            const metricLabel = cityWiseState.metric === 'fr' ? 'FR' : 'DC';
            const filteredSummary = getFilteredCitySummary();
            const totalPartners = filteredSummary.reduce((sum, c) => sum + c.partners, 0);
            const overallAvgRate = totalPartners
                ? filteredSummary.reduce((sum, c) => sum + (c[metricKey] * c.partners), 0) / totalPartners
                : 0;
            const overallAvgRateDisplay = cityWiseState.metric === 'fr'
                ? Math.floor(overallAvgRate * 10) / 10
                : Math.round(overallAvgRate * 10) / 10;

            let highCount = 0;
            let moderateCount = 0;
            let lowCount = 0;
            filteredSummary.forEach(c => {
                const risk = getCityRiskLevel(cityWiseState.metric, c[metricKey]);
                if (risk.label === 'High Risk') highCount += 1;
                if (risk.label === 'Moderate Risk') moderateCount += 1;
                if (risk.label === 'Low Risk') lowCount += 1;
            });

            const avgValueEl = document.getElementById('cityWiseAvgCardValue');
            const avgSubEl = document.getElementById('cityWiseAvgCardSub');
            const riskValueEl = document.getElementById('cityWiseRiskCardValue');
            const riskSubEl = document.getElementById('cityWiseRiskCardSub');

            if (avgValueEl) avgValueEl.textContent = `${overallAvgRateDisplay.toFixed(1)}%`;
            if (avgSubEl) avgSubEl.textContent = `Overall Avg ${metricLabel} Rate (${getCityTierLabel()})`;
            if (riskValueEl) {
                riskValueEl.innerHTML = `<span style="color:#ef4444; font-weight:800;">High: ${highCount}</span> &nbsp;|&nbsp; <span style="color:#f59e0b; font-weight:800;">Moderate: ${moderateCount}</span> &nbsp;|&nbsp; <span style="color:#16a34a; font-weight:800;">Low: ${lowCount}</span>`;
            }
            if (riskSubEl) riskSubEl.textContent = `Total cities: ${filteredSummary.length}`;
        }

        function updateCityWiseTitle() {
            const metricLabel = cityWiseState.metric === 'fr' ? 'FR' : 'Driver Card';
            const viewLabel = cityWiseState.view === 'overview'
                ? 'Compliance Overview'
                : (cityWiseState.view === 'range' ? 'Range + Target Distribution' : 'T1 vs T2 Overview');
            const tierLabel = getCityTierLabel();
            document.getElementById('cityWiseTitle').textContent = `City-wise ${metricLabel} ${viewLabel} (${tierLabel})`;
            document.getElementById('cityWiseRangeTitle').textContent = `${metricLabel} partners with target by range - ${cityWiseState.city} (${tierLabel})`;
            document.getElementById('cityWiseTargetRangeTitle').textContent = `${metricLabel} target range by city - ${cityWiseState.city} (${tierLabel})`;
        }

        function updateCityWiseRiskList() {
            const metricKey = cityWiseState.metric === 'fr' ? 'fr' : 'dc';
            const tierLabel = getCityTierLabel();
            const rangeTitle = cityWiseState.metric === 'fr'
                ? `FR partners with target by range (${tierLabel})`
                : `Driver Card partners with target by range (${tierLabel})`;
            const targetTitle = cityWiseState.metric === 'fr'
                ? `FR target range by city (${tierLabel})`
                : `Driver Card target range by city (${tierLabel})`;
            const overallTitle = cityWiseState.metric === 'fr'
                ? `City Overall FR Compliance (${tierLabel})`
                : `City Overall Driver Card Compliance (${tierLabel})`;
            const overallHeader = cityWiseState.metric === 'fr' ? 'Avg FR Rate %' : 'Avg DC Rate %';
            const riskThreshold = cityWiseState.metric === 'fr' ? 70 : 25;

            const rangeTitleEl = document.getElementById('cityWiseRangeTableTitle');
            const targetTitleEl = document.getElementById('cityWiseTargetRangeTableTitle');
            const overallTitleEl = document.getElementById('cityWiseOverallTableTitle');
            const overallHeaderEl = document.getElementById('cityWiseOverallMetricHeader');
            if (rangeTitleEl) rangeTitleEl.textContent = rangeTitle;
            if (targetTitleEl) targetTitleEl.textContent = targetTitle;
            if (overallTitleEl) overallTitleEl.textContent = overallTitle;
            if (overallHeaderEl) overallHeaderEl.textContent = overallHeader;

            const rangeDataByCity = metricKey === 'fr' ? cityWiseData.frPartnersRanges : cityWiseData.dcPartnersRanges;
            const targetDataByCity = metricKey === 'fr' ? cityWiseData.frTargetRanges : cityWiseData.dcTargetRanges;
            const filteredSummary = getFilteredCitySummary();

            // Calculate totals for overall table
            const totalPartners = filteredSummary.reduce((sum, c) => sum + c.partners, 0);
            const overallAvgRate = totalPartners
                ? filteredSummary.reduce((sum, c) => sum + (c[metricKey] * c.partners), 0) / totalPartners
                : 0;
            const overallAvgRateDisplay = cityWiseState.metric === 'fr'
                ? Math.floor(overallAvgRate * 10) / 10
                : Math.round(overallAvgRate * 10) / 10;
            const overallRisk = getCityRiskLevel(cityWiseState.metric, overallAvgRate);

            const overallRows = [...filteredSummary].map((c) => {
                const risk = getCityRiskLevel(cityWiseState.metric, c[metricKey]);
                return `
                    <tr style="background: ${risk.bg};">
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600;">${c.city}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600;">${c.partners.toLocaleString()}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${risk.color};">${c[metricKey].toFixed(1)}%</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${risk.color};">${risk.label}</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #f3f4f6; border-top: 3px solid #374151;">
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 700; font-size: 14px;">TOTAL</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px;">${totalPartners.toLocaleString()}</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${overallRisk.color};">${overallAvgRateDisplay.toFixed(1)}%</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${overallRisk.color};">${overallRisk.label}</td>
                </tr>
            `;

            // Calculate column totals for range table
            const rangeTotals = [0, 0, 0, 0, 0, 0, 0];
            filteredSummary.forEach((c) => {
                const row = rangeDataByCity[c.city] || [0, 0, 0, 0, 0, 0, 0];
                for (let i = 0; i < 7; i++) {
                    rangeTotals[i] += row[i];
                }
            });
            const rangeGrandTotal = rangeTotals.reduce((s, v) => s + v, 0);
            const rangeTotalPct = rangeTotals.map(v => rangeGrandTotal ? (v / rangeGrandTotal) * 100 : 0);

            const rangeRows = [...filteredSummary].map((c) => {
                const row = rangeDataByCity[c.city] || [0, 0, 0, 0, 0, 0, 0];
                const total = row.reduce((s, v) => s + v, 0);
                const risk = getCityRiskLevel(cityWiseState.metric, c[metricKey]);
                const pct = row.map(v => total ? (v / total) * 100 : 0);
                return `
                    <tr style="background: ${risk.bg};">
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600;">${c.city}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[0])};">${row[0].toLocaleString()} (${pct[0].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[1])};">${row[1].toLocaleString()} (${pct[1].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[2])};">${row[2].toLocaleString()} (${pct[2].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[3])};">${row[3].toLocaleString()} (${pct[3].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[4])};">${row[4].toLocaleString()} (${pct[4].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[5])};">${row[5].toLocaleString()} (${pct[5].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[6])};">${row[6].toLocaleString()} (${pct[6].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;">${total.toLocaleString()}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${risk.color};">${risk.label}</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #f3f4f6; border-top: 3px solid #374151;">
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 700; font-size: 14px;">TOTAL</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[0])};">${rangeTotals[0].toLocaleString()} (${rangeTotalPct[0].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[1])};">${rangeTotals[1].toLocaleString()} (${rangeTotalPct[1].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[2])};">${rangeTotals[2].toLocaleString()} (${rangeTotalPct[2].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[3])};">${rangeTotals[3].toLocaleString()} (${rangeTotalPct[3].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[4])};">${rangeTotals[4].toLocaleString()} (${rangeTotalPct[4].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[5])};">${rangeTotals[5].toLocaleString()} (${rangeTotalPct[5].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(rangeTotalPct[6])};">${rangeTotals[6].toLocaleString()} (${rangeTotalPct[6].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px;">${rangeGrandTotal.toLocaleString()}</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;"></td>
                </tr>
            `;

            // Calculate column totals for target range table
            const targetTotals = [0, 0, 0, 0, 0, 0, 0];
            filteredSummary.forEach((c) => {
                const row = targetDataByCity[c.city] || [0, 0, 0, 0, 0, 0, 0];
                for (let i = 0; i < 7; i++) {
                    targetTotals[i] += row[i];
                }
            });
            const targetGrandTotal = targetTotals.reduce((s, v) => s + v, 0);
            const targetTotalPct = targetTotals.map(v => targetGrandTotal ? (v / targetGrandTotal) * 100 : 0);

            const targetRows = [...filteredSummary].map((c) => {
                const row = targetDataByCity[c.city] || [0, 0, 0, 0, 0, 0, 0];
                const total = row.reduce((s, v) => s + v, 0);
                const risk = getCityRiskLevel(cityWiseState.metric, c[metricKey]);
                const pct = row.map(v => total ? (v / total) * 100 : 0);
                return `
                    <tr style="background: ${risk.bg};">
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600;">${c.city}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[0])};">${row[0].toLocaleString()} (${pct[0].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[1])};">${row[1].toLocaleString()} (${pct[1].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[2])};">${row[2].toLocaleString()} (${pct[2].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[3])};">${row[3].toLocaleString()} (${pct[3].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[4])};">${row[4].toLocaleString()} (${pct[4].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[5])};">${row[5].toLocaleString()} (${pct[5].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; color: ${getPctHighlightColor(pct[6])};">${row[6].toLocaleString()} (${pct[6].toFixed(1)}%)</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;">${total.toLocaleString()}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${risk.color};">${risk.label}</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #f3f4f6; border-top: 3px solid #374151;">
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-weight: 700; font-size: 14px;">TOTAL</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[0])};">${targetTotals[0].toLocaleString()} (${targetTotalPct[0].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[1])};">${targetTotals[1].toLocaleString()} (${targetTotalPct[1].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[2])};">${targetTotals[2].toLocaleString()} (${targetTotalPct[2].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[3])};">${targetTotals[3].toLocaleString()} (${targetTotalPct[3].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[4])};">${targetTotals[4].toLocaleString()} (${targetTotalPct[4].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[5])};">${targetTotals[5].toLocaleString()} (${targetTotalPct[5].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px; color: ${getPctHighlightColor(targetTotalPct[6])};">${targetTotals[6].toLocaleString()} (${targetTotalPct[6].toFixed(1)}%)</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 14px;">${targetGrandTotal.toLocaleString()}</td>
                    <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;"></td>
                </tr>
            `;

            const overallBody = document.getElementById('cityWiseOverallTableBody');
            const rangeBody = document.getElementById('cityWiseRangeTableBody');
            const targetBody = document.getElementById('cityWiseTargetRangeTableBody');
            if (overallBody) overallBody.innerHTML = overallRows;
            if (rangeBody) rangeBody.innerHTML = rangeRows;
            if (targetBody) targetBody.innerHTML = targetRows;

            const overallTable = document.getElementById('cityWiseOverallTable');
            const rangeTables = document.getElementById('cityWiseRangeTables');
            if (cityWiseState.view === 'range') {
                if (overallTable) overallTable.style.display = 'none';
                if (rangeTables) rangeTables.style.display = 'block';
            } else {
                if (overallTable) overallTable.style.display = 'block';
                if (rangeTables) rangeTables.style.display = 'none';
            }
        }

        function updateCityWiseSelect() {
            const select = document.getElementById('cityWiseCitySelect');
            if (!select) return;
            const cities = getFilteredCitySummary().map(c => c.city);
            select.innerHTML = cities.map(c => `<option value="${c}">${c}</option>`).join('');
            if (!cities.includes(cityWiseState.city)) {
                cityWiseState.city = cities[0] || '';
            }
            if (cityWiseState.city) {
                select.value = cityWiseState.city;
                select.disabled = false;
                select.style.opacity = '1';
            } else {
                select.disabled = true;
                select.style.opacity = '0.6';
            }
        }

        function renderCityWiseOverview() {
            const metricKey = cityWiseState.metric === 'fr' ? 'fr' : 'dc';
            const sortedSummary = [...getFilteredCitySummary()].sort((a, b) => b[metricKey] - a[metricKey]);
            const cities = sortedSummary.map(c => c.city);
            const avgValues = sortedSummary.map(c => c[metricKey]);
            const partners = sortedSummary.map(c => c.partners);
            const metricColor = getCityWiseMetricColor(cityWiseState.metric);
            const barColors = avgValues.map(v => getCityRiskLevel(cityWiseState.metric, v).color || metricColor);

            if (!cities.length) {
                if (cityWiseOverviewChart) {
                    cityWiseOverviewChart.destroy();
                    cityWiseOverviewChart = null;
                }
                return;
            }

            if (cityWiseOverviewChart) {
                cityWiseOverviewChart.destroy();
            }

            const ctx = document.getElementById('cityWiseOverviewChart').getContext('2d');
            cityWiseOverviewChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities,
                    datasets: [
                        {
                            label: `Avg ${cityWiseState.metric === 'fr' ? 'FR' : 'DC'} Rate %`,
                            data: avgValues,
                            backgroundColor: barColors,
                            borderColor: barColors,
                            borderWidth: 1.5,
                            yAxisID: 'y'
                        },
                        {
                            label: '# of partners with target',
                            data: partners,
                            type: 'line',
                            borderColor: '#6b7280',
                            backgroundColor: 'rgba(107,114,128,0.15)',
                            pointRadius: 3,
                            pointBackgroundColor: '#6b7280',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const avgRate = context.chart.data.datasets[0]?.data?.[context.dataIndex] ?? 0;
                                    const partners = context.chart.data.datasets[1]?.data?.[context.dataIndex] ?? 0;
                                    return [
                                        `Avg ${cityWiseState.metric === 'fr' ? 'FR' : 'DC'} Rate %: ${Number(avgRate).toFixed(1)}%`,
                                        `# of partners with target: ${Number(partners).toLocaleString()}`
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            color: (context) => context.datasetIndex === 0 ? '#ffffff' : '#111827',
                            anchor: (context) => context.datasetIndex === 0 ? 'center' : 'end',
                            align: (context) => context.datasetIndex === 0 ? 'center' : 'top',
                            offset: (context) => context.datasetIndex === 0 ? 0 : 6,
                            backgroundColor: (context) => context.datasetIndex === 0 ? 'rgba(0,0,0,0.0)' : 'rgba(255,255,255,0.9)',
                            borderRadius: (context) => context.datasetIndex === 0 ? 0 : 4,
                            padding: (context) => context.datasetIndex === 0 ? 0 : 3,
                            font: (context) => ({ size: context.datasetIndex === 0 ? 10 : 10, weight: 'bold' }),
                            textStrokeColor: 'rgba(0,0,0,0.35)',
                            textStrokeWidth: (context) => context.datasetIndex === 0 ? 2 : 0,
                            formatter: (value, context) => {
                                if (context.datasetIndex === 0) {
                                    return value ? value.toFixed(1) + '%' : '';
                                }
                                return value ? value.toLocaleString() : '';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: (value) => value + '%' },
                            title: { display: true, text: 'Avg Rate %' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: '# of partners with target' }
                        },
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });
        }

        function renderCityWiseTierOverview() {
            const metricKey = cityWiseState.metric === 'fr' ? 'fr' : 'dc';
            const metricColor = getCityWiseMetricColor(cityWiseState.metric);

            const renderTierChart = (tier, canvasId, titleId) => {
                const tierSummary = cityWiseData.summary.filter(c => cityWiseTierMap[c.city] === tier);
                const sortedSummary = [...tierSummary].sort((a, b) => b[metricKey] - a[metricKey]);
                const cities = sortedSummary.map(c => c.city);
                const avgValues = sortedSummary.map(c => c[metricKey]);
                const partners = sortedSummary.map(c => c.partners);
                const barColors = avgValues.map(v => getCityRiskLevel(cityWiseState.metric, v).color || metricColor);

                const titleEl = document.getElementById(titleId);
                if (titleEl) {
                    titleEl.textContent = `${tier.toUpperCase()} Cities`;
                }

                if (!cities.length) return null;

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: cities,
                        datasets: [
                            {
                                label: `Avg ${cityWiseState.metric === 'fr' ? 'FR' : 'DC'} Rate %`,
                                data: avgValues,
                                backgroundColor: barColors,
                                borderColor: barColors,
                                borderWidth: 1.5,
                                yAxisID: 'y'
                            },
                            {
                                label: '# of partners with target',
                                data: partners,
                                type: 'line',
                                borderColor: '#6b7280',
                                backgroundColor: 'rgba(107,114,128,0.15)',
                                pointRadius: 3,
                                pointBackgroundColor: '#6b7280',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const avgRate = context.chart.data.datasets[0]?.data?.[context.dataIndex] ?? 0;
                                        const partnersVal = context.chart.data.datasets[1]?.data?.[context.dataIndex] ?? 0;
                                        return [
                                            `Avg ${cityWiseState.metric === 'fr' ? 'FR' : 'DC'} Rate %: ${Number(avgRate).toFixed(1)}%`,
                                            `# of partners with target: ${Number(partnersVal).toLocaleString()}`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                color: (context) => context.datasetIndex === 0 ? '#ffffff' : '#111827',
                                anchor: (context) => context.datasetIndex === 0 ? 'center' : 'end',
                                align: (context) => context.datasetIndex === 0 ? 'center' : 'top',
                                offset: (context) => context.datasetIndex === 0 ? 0 : 6,
                                backgroundColor: (context) => context.datasetIndex === 0 ? 'rgba(0,0,0,0.0)' : 'rgba(255,255,255,0.9)',
                                borderRadius: (context) => context.datasetIndex === 0 ? 0 : 4,
                                padding: (context) => context.datasetIndex === 0 ? 0 : 3,
                                font: (context) => ({ size: 10, weight: 'bold' }),
                                textStrokeColor: 'rgba(0,0,0,0.35)',
                                textStrokeWidth: (context) => context.datasetIndex === 0 ? 2 : 0,
                                formatter: (value, context) => {
                                    if (context.datasetIndex === 0) {
                                        return value ? value.toFixed(1) + '%' : '';
                                    }
                                    return value ? value.toLocaleString() : '';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { callback: (value) => value + '%' },
                                title: { display: true, text: 'Avg Rate %' }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: '# of partners with target' }
                            },
                            x: {
                                ticks: { maxRotation: 45, minRotation: 45 }
                            }
                        }
                    }
                });
            };

            if (cityWiseT1OverviewChart) {
                cityWiseT1OverviewChart.destroy();
            }
            if (cityWiseT2OverviewChart) {
                cityWiseT2OverviewChart.destroy();
            }

            cityWiseT1OverviewChart = renderTierChart('t1', 'cityWiseT1OverviewChart', 'cityWiseT1Title');
            cityWiseT2OverviewChart = renderTierChart('t2', 'cityWiseT2OverviewChart', 'cityWiseT2Title');
        }

        function renderCityWiseRanges() {
            if (!cityWiseState.city) {
                return;
            }
            const metricKey = cityWiseState.metric === 'fr' ? 'fr' : 'dc';
            const rangeData = metricKey === 'fr'
                ? cityWiseData.frPartnersRanges[cityWiseState.city]
                : cityWiseData.dcPartnersRanges[cityWiseState.city];
            const targetRangeData = metricKey === 'fr'
                ? cityWiseData.frTargetRanges[cityWiseState.city]
                : cityWiseData.dcTargetRanges[cityWiseState.city];
            const metricColor = getCityWiseMetricColor(cityWiseState.metric);

            if (cityWiseRangeChart) {
                cityWiseRangeChart.destroy();
            }
            if (cityWiseTargetRangeChart) {
                cityWiseTargetRangeChart.destroy();
            }

            const rangeTotal = rangeData.reduce((s, v) => s + v, 0);
            const targetTotal = targetRangeData.reduce((s, v) => s + v, 0);
            const rangeMax = Math.max(...rangeData, 0);
            const targetMax = Math.max(...targetRangeData, 0);
            const rangeSuggestedMax = rangeMax ? Math.ceil(rangeMax * 1.25) : 1;
            const targetSuggestedMax = targetMax ? Math.ceil(targetMax * 1.15) : 1;
            const ctxRange = document.getElementById('cityWiseRangeChart').getContext('2d');
            cityWiseRangeChart = new Chart(ctxRange, {
                type: 'bar',
                data: {
                    labels: cityWiseRangeLabels,
                    datasets: [{
                        label: `${cityWiseState.city} - Partners with Target`,
                        data: rangeData,
                        backgroundColor: metricColor,
                        borderColor: metricColor,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: (context) => (context.dataset.data[context.dataIndex] || 0) > 0,
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            clamp: true,
                            clip: false,
                            color: (context) => {
                                const val = context.dataset.data[context.dataIndex] || 0;
                                const pct = rangeTotal ? (val / rangeTotal) * 100 : 0;
                                return getPctHighlightColor(pct);
                            },
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            borderRadius: 4,
                            padding: 3,
                            font: { size: 10, weight: 'bold' },
                            formatter: (value) => {
                                if (!value) return '';
                                const pct = rangeTotal ? (value / rangeTotal) * 100 : 0;
                                return `${value.toLocaleString()} (${pct.toFixed(1)}%)`;
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: rangeSuggestedMax, ticks: { callback: (v) => v.toLocaleString() } }
                    }
                }
            });

            const ctxTarget = document.getElementById('cityWiseTargetRangeChart').getContext('2d');
            cityWiseTargetRangeChart = new Chart(ctxTarget, {
                type: 'bar',
                data: {
                    labels: cityWiseRangeLabels,
                    datasets: [{
                        label: `${cityWiseState.city} - Target Range`,
                        data: targetRangeData,
                        backgroundColor: '#94a3b8',
                        borderColor: '#64748b',
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: (context) => (context.dataset.data[context.dataIndex] || 0) > 0,
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            clamp: true,
                            clip: false,
                            color: (context) => {
                                const val = context.dataset.data[context.dataIndex] || 0;
                                const pct = targetTotal ? (val / targetTotal) * 100 : 0;
                                return getPctHighlightColor(pct);
                            },
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            borderRadius: 4,
                            padding: 3,
                            font: { size: 10, weight: 'bold' },
                            formatter: (value) => {
                                if (!value) return '';
                                const pct = targetTotal ? (value / targetTotal) * 100 : 0;
                                return `${value.toLocaleString()} (${pct.toFixed(1)}%)`;
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: targetSuggestedMax, ticks: { callback: (v) => v.toLocaleString() } }
                    }
                }
            });
        }

        function updateCityWiseView() {
            updateCityWiseSelect();
            updateCityWiseTitle();
            updateCityWiseRiskList();
            updateCityWiseSummaryCards();
            const overviewSection = document.getElementById('cityWiseOverviewSection');
            const rangeSection = document.getElementById('cityWiseRangeSection');
            const tierOverviewSection = document.getElementById('cityWiseTierOverviewSection');
            const select = document.getElementById('cityWiseCitySelect');
            if (cityWiseState.view === 'overview') {
                overviewSection.style.display = 'block';
                rangeSection.style.display = 'none';
                tierOverviewSection.style.display = 'none';
                select.disabled = true;
                select.style.opacity = '0.6';
                renderCityWiseOverview();
            } else if (cityWiseState.view === 'range') {
                overviewSection.style.display = 'none';
                rangeSection.style.display = 'block';
                tierOverviewSection.style.display = 'none';
                select.disabled = false;
                select.style.opacity = '1';
                renderCityWiseRanges();
            } else {
                overviewSection.style.display = 'none';
                rangeSection.style.display = 'none';
                tierOverviewSection.style.display = 'block';
                select.disabled = true;
                select.style.opacity = '0.6';
                renderCityWiseTierOverview();
            }
        }

        window.initCityWiseCompliance = function() {
            updateCityWiseSelect();
            updateCityWiseView();
        };

        document.querySelectorAll('.citywise-metric-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const metric = this.getAttribute('data-metric');
                cityWiseState.metric = metric;
                document.querySelectorAll('.citywise-metric-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = metric === 'fr' ? '#3b82f6' : '#10b981';
                this.style.color = 'white';
                this.style.borderColor = metric === 'fr' ? '#3b82f6' : '#10b981';
                updateCityWiseView();
            });
        });

        document.querySelectorAll('.citywise-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.getAttribute('data-view');
                cityWiseState.view = view;
                document.querySelectorAll('.citywise-view-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#8b5cf6';
                this.style.color = 'white';
                this.style.borderColor = '#8b5cf6';
                updateCityWiseView();
            });
        });

        document.querySelectorAll('.citywise-tier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tier = this.getAttribute('data-tier');
                cityWiseState.tier = tier;
                if (cityWiseState.view === 't1t2') {
                    cityWiseState.view = 'overview';
                    document.querySelectorAll('.citywise-view-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#6b7280';
                        b.style.borderColor = '#e5e7eb';
                    });
                    const overviewBtn = document.querySelector('.citywise-view-btn[data-view="overview"]');
                    if (overviewBtn) {
                        overviewBtn.style.background = '#8b5cf6';
                        overviewBtn.style.color = 'white';
                        overviewBtn.style.borderColor = '#8b5cf6';
                    }
                }
                document.querySelectorAll('.citywise-tier-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#0ea5e9';
                this.style.color = 'white';
                this.style.borderColor = '#0ea5e9';
                updateCityWiseView();
            });
        });

        const cityWiseSelect = document.getElementById('cityWiseCitySelect');
        if (cityWiseSelect) {
            cityWiseSelect.addEventListener('change', function() {
                cityWiseState.city = this.value;
                updateCityWiseView();
            });
        }
        
        // Initialize default state - All Partners trend line view
        setTimeout(function() {
            // Set title for default view
            document.getElementById('impactTitle').textContent = 'Face Recognition (FR) All Partners Summary - Target Changes Across Ranges';
            
            // Style the All Partners button as active
            document.querySelectorAll('.impact-filter-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#6b7280';
                btn.style.borderColor = '#e5e7eb';
                btn.style.boxShadow = 'none';
            });
            const allBtn = document.querySelector('[data-filter="all"]');
            allBtn.style.background = '#3b82f6';
            allBtn.style.color = 'white';
            allBtn.style.borderColor = '#3b82f6';
            allBtn.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.2)';
            
            // Initialize and display the All Partners trend line chart
            window.initImpactChartOverall('fr');
            if (window.updateImpactKpiCards) {
                window.updateImpactKpiCards('fr', 'all');
            }
            document.getElementById('impactChartSingle').style.display = 'none';
            document.getElementById('impactChartDual').style.display = 'none';
            document.getElementById('impactChartOverall').style.display = 'block';
            document.getElementById('impactChartWithTarget').style.display = 'none';
            document.getElementById('detailedTablesSection').style.display = 'none';
            
            // Show FR detailed tables
            document.getElementById('frDetailedTablesWrapper').style.display = 'block';
            document.getElementById('dcDetailedTablesWrapper').style.display = 'none';
        }, 100);
    });

    // City Tier Analysis Section
    document.addEventListener('DOMContentLoaded', function() {
        const cityTierCityData = [
            { city: 'Abha', dec: { partners: 18, target: 339, avg: 18.8 }, jan: { partners: 15, target: 297, avg: 19.8 } },
            { city: 'Al Ahsa', dec: { partners: 32, target: 858, avg: 26.8 }, jan: { partners: 28, target: 818, avg: 29.2 } },
            { city: 'Al Kharj', dec: { partners: 7, target: 380, avg: 54.3 }, jan: { partners: 8, target: 347, avg: 43.4 } },
            { city: 'Buraydah', dec: { partners: 13, target: 296, avg: 22.8 }, jan: { partners: 10, target: 253, avg: 25.3 } },
            { city: 'Dammam', dec: { partners: 76, target: 2641, avg: 34.8 }, jan: { partners: 64, target: 2127, avg: 33.2 } },
            { city: 'Hafar Al Batin', dec: { partners: 8, target: 128, avg: 16.0 }, jan: { partners: 7, target: 109, avg: 15.6 } },
            { city: 'Hail', dec: { partners: 7, target: 199, avg: 28.4 }, jan: { partners: 5, target: 186, avg: 37.2 } },
            { city: 'Jazan', dec: { partners: 5, target: 95, avg: 19.0 }, jan: { partners: 3, target: 74, avg: 24.7 } },
            { city: 'Jeddah', dec: { partners: 95, target: 4094, avg: 43.1 }, jan: { partners: 83, target: 3454, avg: 41.6 } },
            { city: 'Jubail', dec: { partners: 11, target: 244, avg: 22.2 }, jan: { partners: 10, target: 230, avg: 23.0 } },
            { city: 'Makkah', dec: { partners: 47, target: 1074, avg: 22.9 }, jan: { partners: 41, target: 935, avg: 22.8 } },
            { city: 'Madinah', dec: { partners: 46, target: 1195, avg: 26.0 }, jan: { partners: 37, target: 1131, avg: 30.6 } },
            { city: 'Najran', dec: { partners: 5, target: 76, avg: 15.2 }, jan: { partners: 5, target: 78, avg: 15.6 } },
            { city: 'Riyadh', dec: { partners: 215, target: 10028, avg: 46.6 }, jan: { partners: 200, target: 8661, avg: 43.3 } },
            { city: 'Tabuk', dec: { partners: 13, target: 252, avg: 19.4 }, jan: { partners: 11, target: 202, avg: 18.4 } },
            { city: 'Taif', dec: { partners: 16, target: 345, avg: 21.6 }, jan: { partners: 14, target: 292, avg: 20.9 } },
            { city: 'Yanbu', dec: { partners: 11, target: 209, avg: 19.0 }, jan: { partners: 10, target: 171, avg: 17.1 } }
        ];

        const cityTierOverview = {
            t1: { dec: { partners: 518, target: 20270, avg: 39.1 }, jan: { partners: 461, target: 17473, avg: 37.9 } },
            t2: { dec: { partners: 107, target: 2183, avg: 20.4 }, jan: { partners: 90, target: 1892, avg: 21.0 } }
        };

        const cityTierMap = {
            'Riyadh': 't1',
            'Madinah': 't1',
            'Makkah': 't1',
            'Jeddah': 't1',
            'Dammam': 't1',
            'Al Kharj': 't1',
            'Al Ahsa': 't1',
            'Abha': 't2',
            'Buraydah': 't2',
            'Hail': 't2',
            'Jazan': 't2',
            'Jubail': 't2',
            'Tabuk': 't2',
            'Taif': 't2',
            'Yanbu': 't2',
            'Hafar Al Batin': 't2',
            'Najran': 't2'
        };

        const cityTierPerformance = {
            t1: {
                partners: { dec: { good: 207, average: 230, bad: 72 }, jan: { good: 199, average: 228, bad: 20 } },
                target: { dec: { good: 10903, average: 7613, bad: 1514 }, jan: { good: 8904, average: 7842, bad: 370 } }
            },
            t2: {
                partners: { dec: { good: 62, average: 44, bad: 1 }, jan: { good: 53, average: 34, bad: 0 } },
                target: { dec: { good: 1446, average: 717, bad: 20 }, jan: { good: 1288, average: 572, bad: 0 } }
            }
        };

        const cityTierScale = {
            t1: {
                partners: { dec: { big: 57, mid: 219, small: 233 }, jan: { big: 57, mid: 219, small: 171 } },
                target: { dec: { big: 4471, mid: 9490, small: 6069 }, jan: { big: 1650, mid: 7052, small: 8686 } }
            },
            t2: {
                partners: { dec: { big: 24, mid: 56, small: 27 }, jan: { big: 20, mid: 63, small: 4 } },
                target: { dec: { big: 467, mid: 1108, small: 608 }, jan: { big: 131, mid: 781, small: 854 } }
            }
        };

        const cityTierMetricLabels = {
            partners: '# of partners with target',
            target: 'Total target',
            avg: 'Avg scale'
        };

        const cityTierPerformanceData = [
            { city: 'Abha', performance: 'good', partners: 8, dec: 195, jan: 184, change: -11, changePct: -5.6 },
            { city: 'Abha', performance: 'average', partners: 6, dec: 144, jan: 103, change: -41, changePct: -28.5 },
            { city: 'Abha', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Al Ahsa', performance: 'good', partners: 12, dec: 304, jan: 326, change: 22, changePct: 7.2 },
            { city: 'Al Ahsa', performance: 'average', partners: 15, dec: 492, jan: 476, change: -16, changePct: -3.3 },
            { city: 'Al Ahsa', performance: 'bad', partners: 1, dec: 62, jan: 16, change: -46, changePct: -74.2 },
            { city: 'Al Kharj', performance: 'good', partners: 2, dec: 118, jan: 120, change: 2, changePct: 1.7 },
            { city: 'Al Kharj', performance: 'average', partners: 4, dec: 212, jan: 183, change: -29, changePct: -13.7 },
            { city: 'Al Kharj', performance: 'bad', partners: 2, dec: 50, jan: 44, change: -6, changePct: -12.0 },
            { city: 'Buraydah', performance: 'good', partners: 7, dec: 214, jan: 213, change: -1, changePct: -0.5 },
            { city: 'Buraydah', performance: 'average', partners: 3, dec: 70, jan: 40, change: -30, changePct: -42.9 },
            { city: 'Buraydah', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Dammam', performance: 'good', partners: 30, dec: 1153, jan: 1076, change: -77, changePct: -6.7 },
            { city: 'Dammam', performance: 'average', partners: 32, dec: 1372, jan: 1001, change: -371, changePct: -27.0 },
            { city: 'Dammam', performance: 'bad', partners: 1, dec: 116, jan: 25, change: -91, changePct: -78.4 },
            { city: 'Hafar Al Batin', performance: 'good', partners: 5, dec: 91, jan: 87, change: -4, changePct: -4.4 },
            { city: 'Hafar Al Batin', performance: 'average', partners: 2, dec: 37, jan: 22, change: -15, changePct: -40.5 },
            { city: 'Hafar Al Batin', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Hail', performance: 'good', partners: 5, dec: 169, jan: 186, change: 17, changePct: 10.1 },
            { city: 'Hail', performance: 'average', partners: 0, dec: 30, jan: 0, change: -30, changePct: -100.0 },
            { city: 'Hail', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Jazan', performance: 'good', partners: 2, dec: 71, jan: 62, change: -9, changePct: -12.7 },
            { city: 'Jazan', performance: 'average', partners: 1, dec: 24, jan: 12, change: -12, changePct: -50.0 },
            { city: 'Jazan', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Jeddah', performance: 'good', partners: 39, dec: 1829, jan: 1709, change: -120, changePct: -6.6 },
            { city: 'Jeddah', performance: 'average', partners: 39, dec: 2139, jan: 1640, change: -499, changePct: -23.3 },
            { city: 'Jeddah', performance: 'bad', partners: 2, dec: 69, jan: 45, change: -24, changePct: -34.8 },
            { city: 'Jubail', performance: 'good', partners: 5, dec: 148, jan: 136, change: -12, changePct: -8.1 },
            { city: 'Jubail', performance: 'average', partners: 4, dec: 81, jan: 82, change: 1, changePct: 1.2 },
            { city: 'Jubail', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Makkah', performance: 'good', partners: 19, dec: 496, jan: 463, change: -33, changePct: -6.7 },
            { city: 'Makkah', performance: 'average', partners: 18, dec: 589, jan: 426, change: -163, changePct: -27.7 },
            { city: 'Makkah', performance: 'bad', partners: 2, dec: 10, jan: 20, change: 10, changePct: 100.0 },
            { city: 'Madinah', performance: 'good', partners: 18, dec: 422, jan: 454, change: 32, changePct: 7.6 },
            { city: 'Madinah', performance: 'average', partners: 17, dec: 733, jan: 643, change: -90, changePct: -12.3 },
            { city: 'Madinah', performance: 'bad', partners: 2, dec: 57, jan: 34, change: -23, changePct: -40.4 },
            { city: 'Najran', performance: 'good', partners: 3, dec: 42, jan: 46, change: 4, changePct: 9.5 },
            { city: 'Najran', performance: 'average', partners: 2, dec: 34, jan: 32, change: -2, changePct: -5.9 },
            { city: 'Najran', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Riyadh', performance: 'good', partners: 79, dec: 5255, jan: 4756, change: -499, changePct: -9.5 },
            { city: 'Riyadh', performance: 'average', partners: 103, dec: 4279, jan: 3473, change: -806, changePct: -18.8 },
            { city: 'Riyadh', performance: 'bad', partners: 10, dec: 444, jan: 186, change: -258, changePct: -58.1 },
            { city: 'Tabuk', performance: 'good', partners: 6, dec: 101, jan: 105, change: 4, changePct: 4.0 },
            { city: 'Tabuk', performance: 'average', partners: 5, dec: 140, jan: 97, change: -43, changePct: -30.7 },
            { city: 'Tabuk', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Taif', performance: 'good', partners: 7, dec: 193, jan: 163, change: -30, changePct: -15.5 },
            { city: 'Taif', performance: 'average', partners: 6, dec: 152, jan: 119, change: -33, changePct: -21.7 },
            { city: 'Taif', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Yanbu', performance: 'good', partners: 5, dec: 113, jan: 106, change: -7, changePct: -6.2 },
            { city: 'Yanbu', performance: 'average', partners: 5, dec: 92, jan: 65, change: -27, changePct: -29.3 },
            { city: 'Yanbu', performance: 'bad', partners: 0, dec: 0, jan: 0, change: 0, changePct: null }
        ];

        // Partner Scale Data - City wise
        const cityTierScaleData = [
            { city: 'Abha', scale: 'small', partners: 0, dec: 20, jan: 0, change: -20, changePct: -100.0 },
            { city: 'Abha', scale: 'mid', partners: 11, dec: 244, jan: 215, change: -29, changePct: -11.9 },
            { city: 'Abha', scale: 'big', partners: 3, dec: 75, jan: 72, change: -3, changePct: -4.0 },
            { city: 'Al Ahsa', scale: 'small', partners: 12, dec: 319, jan: 238, change: -81, changePct: -25.4 },
            { city: 'Al Ahsa', scale: 'mid', partners: 13, dec: 389, jan: 418, change: 29, changePct: 7.5 },
            { city: 'Al Ahsa', scale: 'big', partners: 3, dec: 150, jan: 162, change: 12, changePct: 8.0 },
            { city: 'Al Kharj', scale: 'small', partners: 3, dec: 56, jan: 75, change: 19, changePct: 33.9 },
            { city: 'Al Kharj', scale: 'mid', partners: 3, dec: 116, jan: 84, change: -32, changePct: -27.6 },
            { city: 'Al Kharj', scale: 'big', partners: 2, dec: 208, jan: 188, change: -20, changePct: -9.6 },
            { city: 'Buraydah', scale: 'small', partners: 0, dec: 13, jan: 0, change: -13, changePct: -100.0 },
            { city: 'Buraydah', scale: 'mid', partners: 8, dec: 214, jan: 189, change: -25, changePct: -11.7 },
            { city: 'Buraydah', scale: 'big', partners: 2, dec: 57, jan: 64, change: 7, changePct: 12.3 },
            { city: 'Dammam', scale: 'small', partners: 20, dec: 582, jan: 442, change: -140, changePct: -24.1 },
            { city: 'Dammam', scale: 'mid', partners: 32, dec: 1318, jan: 1089, change: -229, changePct: -17.4 },
            { city: 'Dammam', scale: 'big', partners: 11, dec: 741, jan: 571, change: -170, changePct: -22.9 },
            { city: 'Hafar Al Batin', scale: 'small', partners: 1, dec: 12, jan: 10, change: -2, changePct: -16.7 },
            { city: 'Hafar Al Batin', scale: 'mid', partners: 4, dec: 69, jan: 56, change: -13, changePct: -18.8 },
            { city: 'Hafar Al Batin', scale: 'big', partners: 2, dec: 47, jan: 43, change: -4, changePct: -8.5 },
            { city: 'Hail', scale: 'small', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Hail', scale: 'mid', partners: 3, dec: 74, jan: 55, change: -19, changePct: -25.7 },
            { city: 'Hail', scale: 'big', partners: 2, dec: 125, jan: 131, change: 6, changePct: 4.8 },
            { city: 'Jazan', scale: 'small', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Jazan', scale: 'mid', partners: 2, dec: 57, jan: 32, change: -25, changePct: -43.9 },
            { city: 'Jazan', scale: 'big', partners: 1, dec: 38, jan: 42, change: 4, changePct: 10.5 },
            { city: 'Jeddah', scale: 'small', partners: 18, dec: 499, jan: 323, change: -176, changePct: -35.3 },
            { city: 'Jeddah', scale: 'mid', partners: 48, dec: 2127, jan: 1813, change: -314, changePct: -14.8 },
            { city: 'Jeddah', scale: 'big', partners: 14, dec: 1411, jan: 1258, change: -153, changePct: -10.8 },
            { city: 'Jubail', scale: 'small', partners: 1, dec: 10, jan: 10, change: 0, changePct: 0.0 },
            { city: 'Jubail', scale: 'mid', partners: 5, dec: 105, jan: 108, change: 3, changePct: 2.9 },
            { city: 'Jubail', scale: 'big', partners: 3, dec: 114, jan: 100, change: -14, changePct: -12.3 },
            { city: 'Makkah', scale: 'small', partners: 22, dec: 423, jan: 362, change: -61, changePct: -14.4 },
            { city: 'Makkah', scale: 'mid', partners: 13, dec: 462, jan: 377, change: -85, changePct: -18.4 },
            { city: 'Makkah', scale: 'big', partners: 4, dec: 210, jan: 170, change: -40, changePct: -19.0 },
            { city: 'Madinah', scale: 'small', partners: 18, dec: 389, jan: 315, change: -74, changePct: -19.0 },
            { city: 'Madinah', scale: 'mid', partners: 14, dec: 439, jan: 441, change: 2, changePct: 0.5 },
            { city: 'Madinah', scale: 'big', partners: 5, dec: 384, jan: 375, change: -9, changePct: -2.3 },
            { city: 'Najran', scale: 'small', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Najran', scale: 'mid', partners: 4, dec: 52, jan: 56, change: 4, changePct: 7.7 },
            { city: 'Najran', scale: 'big', partners: 1, dec: 24, jan: 22, change: -2, changePct: -8.3 },
            { city: 'Riyadh', scale: 'small', partners: 78, dec: 2138, jan: 1841, change: -297, changePct: -13.9 },
            { city: 'Riyadh', scale: 'mid', partners: 96, dec: 5459, jan: 4597, change: -862, changePct: -15.8 },
            { city: 'Riyadh', scale: 'big', partners: 18, dec: 2381, jan: 1977, change: -404, changePct: -17.0 },
            { city: 'Tabuk', scale: 'small', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Tabuk', scale: 'mid', partners: 9, dec: 196, jan: 159, change: -37, changePct: -18.9 },
            { city: 'Tabuk', scale: 'big', partners: 2, dec: 45, jan: 43, change: -2, changePct: -4.4 },
            { city: 'Taif', scale: 'small', partners: 2, dec: 30, jan: 27, change: -3, changePct: -10.0 },
            { city: 'Taif', scale: 'mid', partners: 9, dec: 195, jan: 177, change: -18, changePct: -9.2 },
            { city: 'Taif', scale: 'big', partners: 2, dec: 120, jan: 78, change: -42, changePct: -35.0 },
            { city: 'Yanbu', scale: 'small', partners: 0, dec: 0, jan: 0, change: 0, changePct: null },
            { city: 'Yanbu', scale: 'mid', partners: 8, dec: 141, jan: 116, change: -25, changePct: -17.7 },
            { city: 'Yanbu', scale: 'big', partners: 2, dec: 64, jan: 55, change: -9, changePct: -14.1 }
        ];

        let cityTierView = 'city';
        let cityTierMetric = 'partners';
        let cityTierTier = 't1';
        let cityTierBreakdown = 'overview';
        let cityTierBreakdownMetric = 'partners';
        const cityTierSelectedCity = { t1: 'all', t2: 'all' };
        let cityTierCityChart = null;
        let cityTierBreakdownChart = null;
        let cityTierBreakdownChartT1 = null;
        let cityTierBreakdownChartT2 = null;
        let cityTierPerformanceChart = null;
        let cityTierPerformanceChartT1 = null;
        let cityTierPerformanceChartT2 = null;
        let cityTierPerformanceFilter = 'total';
        let cityTierScaleChart = null;
        let cityTierScaleChartT1 = null;
        let cityTierScaleChartT2 = null;
        let cityTierScaleFilter = 'total';

        const cityTierFormatMoM = (dec, jan) => {
            if (!dec) return '0.0';
            return (((jan - dec) / dec) * 100).toFixed(1);
        };

        const cityTierMoMColor = (mom) => {
            const val = parseFloat(mom);
            if (val > 0) return '#16a34a';
            if (val < 0) return '#dc2626';
            return '#f59e0b';
        };

        function cityTierMomLabelPlugin(decData, janData, fontSize) {
            return {
                id: 'cityTierMomLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    const showDec = chart.isDatasetVisible(0);
                    const showJan = chart.isDatasetVisible(1);
                    ctx.save();
                    ctx.font = `bold ${fontSize}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';

                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        if (!chart.isDatasetVisible(datasetIndex)) return;
                        const meta = chart.getDatasetMeta(datasetIndex);
                        meta.data.forEach((bar, index) => {
                            const val = dataset.data[index];
                            if (val === null || val === undefined) return;
                            const x = bar.x;
                            const y = bar.y - 4;
                            const valText = Number(val).toLocaleString();

                            if (datasetIndex === 1 && showDec && showJan) {
                                const mom = cityTierFormatMoM(decData[index], janData[index]);
                                const sign = parseFloat(mom) > 0 ? '+' : '';
                                const momText = ` (${sign}${mom}%)`;
                                const valWidth = ctx.measureText(valText).width;
                                ctx.fillStyle = '#111827';
                                ctx.fillText(valText, x - (ctx.measureText(momText).width / 2), y);
                                ctx.fillStyle = cityTierMoMColor(mom);
                                ctx.fillText(momText, x + (valWidth / 2), y);
                            } else {
                                ctx.fillStyle = '#111827';
                                ctx.fillText(valText, x, y);
                            }
                        });
                    });
                    ctx.restore();
                }
            };
        }

        function cityTierSetActive(buttons, activeBtn, activeColor) {
            buttons.forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#6b7280';
                btn.style.borderColor = '#e5e7eb';
            });
            activeBtn.style.background = activeColor;
            activeBtn.style.color = 'white';
            activeBtn.style.borderColor = activeColor;
        }

        // Summary Cards Update Function
        let cityTierPreviousView = 'city'; // Track previous view for animation
        
        function cityTierUpdateSummaryCards(forceAnimate = false) {
            const card1 = document.getElementById('cityTierSummaryCard1');
            const card2 = document.getElementById('cityTierSummaryCard2');
            const card3 = document.getElementById('cityTierSummaryCard3');
            const card4 = document.getElementById('cityTierSummaryCard4');
            const cards = [card1, card2, card3, card4];

            if (!card1 || !card2 || !card3 || !card4) return;

            // Check if view changed - only animate on view change
            const viewChanged = cityTierPreviousView !== cityTierView || forceAnimate;
            cityTierPreviousView = cityTierView;

            const metricKey = cityTierView === 'city' ? cityTierMetric : 
                              cityTierView === 'tier' ? cityTierBreakdownMetric : 'partners';
            const isAvg = metricKey === 'avg';

            // Helper to format value
            const formatVal = (v) => isAvg ? v.toFixed(1) : v.toLocaleString();
            const formatMoM = (dec, jan) => {
                if (dec === 0) return jan > 0 ? '+100.0' : '0.0';
                return ((jan - dec) / dec * 100).toFixed(1);
            };

            // Helper to update card
            const updateCard = (card, icon, label, value, sub, gradient1, gradient2) => {
                const topBar = card.querySelector('div[style*="position: absolute"]');
                const iconDiv = card.querySelector('div[style*="width: 48px"]');
                const labelDiv = card.querySelector('div[style*="text-transform: uppercase"]');
                
                if (topBar) topBar.style.background = `linear-gradient(90deg, ${gradient1}, ${gradient2})`;
                if (iconDiv) {
                    iconDiv.style.background = `linear-gradient(135deg, ${gradient1} 0%, ${gradient2} 100%)`;
                    iconDiv.textContent = icon;
                }
                if (labelDiv) labelDiv.textContent = label;
                card.querySelector('#summaryCard' + (cards.indexOf(card) + 1) + 'Value').textContent = value;
                card.querySelector('#summaryCard' + (cards.indexOf(card) + 1) + 'Sub').innerHTML = sub;
            };

            // If view changed, prepare cards for animation (hide them first)
            if (viewChanged) {
                cards.forEach(card => {
                    card.classList.remove('fly-in');
                    card.classList.add('preparing');
                });
            }

            // Update card content
            const doUpdate = () => {
                if (cityTierView === 'city') {
                    // City Level Summary
                    const sortedByFeb = [...cityTierCityData].sort((a, b) => b.jan[metricKey] - a.jan[metricKey]);
                    const highest = sortedByFeb[0];
                    const lowest = sortedByFeb[sortedByFeb.length - 1];
                    const totalFeb = cityTierCityData.reduce((sum, c) => sum + c.jan[metricKey], 0);
                    const totalDec = cityTierCityData.reduce((sum, c) => sum + c.dec[metricKey], 0);
                    
                    // For avg scale, calculate true overall average (total target / total partners)
                    const totalPartnersFeb = cityTierCityData.reduce((sum, c) => sum + c.jan.partners, 0);
                    const totalTargetFeb = cityTierCityData.reduce((sum, c) => sum + c.jan.target, 0);
                    const totalPartnersDec = cityTierCityData.reduce((sum, c) => sum + c.dec.partners, 0);
                    const totalTargetDec = cityTierCityData.reduce((sum, c) => sum + c.dec.target, 0);
                    const overallAvgScaleFeb = totalTargetFeb / totalPartnersFeb;
                    const overallAvgScaleDec = totalTargetDec / totalPartnersDec;
                    
                    // Calculate MoM for highest and lowest cities
                    const highestMoM = formatMoM(highest.dec[metricKey], highest.jan[metricKey]);
                    const lowestMoM = formatMoM(lowest.dec[metricKey], lowest.jan[metricKey]);
                    const totalMoM = isAvg ? formatMoM(overallAvgScaleDec, overallAvgScaleFeb) : formatMoM(totalDec, totalFeb);
                    
                    let biggestChange = { city: '', mom: 0 };
                    cityTierCityData.forEach(c => {
                        const mom = parseFloat(formatMoM(c.dec[metricKey], c.jan[metricKey]));
                        if (Math.abs(mom) > Math.abs(biggestChange.mom)) {
                            biggestChange = { city: c.city, mom: mom };
                        }
                    });

                    const formatMoMText = (mom) => {
                        const val = parseFloat(mom);
                        const color = val >= 0 ? '#10b981' : '#ef4444';
                        const sign = val >= 0 ? '+' : '';
                        return `<span style="color: ${color}; font-weight: 600;">(MoM ${sign}${mom}%)</span>`;
                    };

                    updateCard(card1, '🏆', 'Highest City', highest.city, 
                        formatVal(highest.jan[metricKey]) + (isAvg ? ' avg scale' : metricKey === 'target' ? ' riders' : ' partners') + ' (Feb) ' + formatMoMText(highestMoM),
                        '#0ea5e9', '#06b6d4');
                    updateCard(card2, '📉', 'Lowest City', lowest.city,
                        formatVal(lowest.jan[metricKey]) + (isAvg ? ' avg scale' : metricKey === 'target' ? ' riders' : ' partners') + ' (Feb) ' + formatMoMText(lowestMoM),
                        '#f59e0b', '#fbbf24');
                    updateCard(card3, '📊', isAvg ? 'Overall (Feb)' : 'Total (Feb)', isAvg ? overallAvgScaleFeb.toFixed(1) : totalFeb.toLocaleString(),
                        (isAvg ? 'overall avg scale' : metricKey === 'target' ? 'total riders' : 'partners with target') + ' ' + formatMoMText(totalMoM),
                        '#10b981', '#34d399');
                    updateCard(card4, '📈', 'Biggest MoM Change', biggestChange.city,
                        (biggestChange.mom >= 0 ? '+' : '') + biggestChange.mom.toFixed(1) + '% MoM',
                        '#8b5cf6', '#a78bfa');

                    // Dynamic tooltips for City view
                    const metricLabel = isAvg ? 'avg scale' : metricKey === 'target' ? 'total target' : '# of partners with target';
                    card1.setAttribute('data-tooltip', `Highest city by ${metricLabel}: ${highest.city} with ${formatVal(highest.jan[metricKey])} in Feb (MoM ${highestMoM}%).`);
                    card2.setAttribute('data-tooltip', `Lowest city by ${metricLabel}: ${lowest.city} with ${formatVal(lowest.jan[metricKey])} in Feb (MoM ${lowestMoM}%).`);
                    card3.setAttribute('data-tooltip', `${isAvg ? 'Overall avg scale' : 'Total ' + metricLabel} across all cities in Feb: ${isAvg ? overallAvgScaleFeb.toFixed(1) : totalFeb.toLocaleString()} (MoM ${totalMoM}%).`);
                    card4.setAttribute('data-tooltip', `City with largest MoM% change in ${metricLabel}: ${biggestChange.city} at ${biggestChange.mom >= 0 ? '+' : ''}${biggestChange.mom.toFixed(1)}%.`);

                } else if (cityTierView === 'tier') {
                    // City Tier Breakdown
                    const t1Data = cityTierOverview.t1;
                    const t2Data = cityTierOverview.t2;
                    const t1MoM = formatMoM(t1Data.dec[metricKey], t1Data.jan[metricKey]);
                    const t2MoM = formatMoM(t2Data.dec[metricKey], t2Data.jan[metricKey]);
                    
                    const formatMoMText = (mom) => {
                        const val = parseFloat(mom);
                        const color = val >= 0 ? '#10b981' : '#ef4444';
                        const sign = val >= 0 ? '+' : '';
                        return `<span style="color: ${color}; font-weight: 600;">(MoM ${sign}${mom}%)</span>`;
                    };
                    
                    updateCard(card1, '🏙️', 'Tier 1 (Feb)', formatVal(t1Data.jan[metricKey]),
                        'T1 ' + (isAvg ? 'avg scale' : metricKey === 'target' ? 'total target' : 'partners') + ' ' + formatMoMText(t1MoM),
                        '#0ea5e9', '#06b6d4');
                    updateCard(card2, '🏘️', 'Tier 2 (Feb)', formatVal(t2Data.jan[metricKey]),
                        'T2 ' + (isAvg ? 'avg scale' : metricKey === 'target' ? 'total target' : 'partners') + ' ' + formatMoMText(t2MoM),
                        '#64748b', '#94a3b8');
                    updateCard(card3, '📊', 'T1 MoM Change', (parseFloat(t1MoM) >= 0 ? '+' : '') + t1MoM + '%',
                        'T1 change vs Jan',
                        parseFloat(t1MoM) >= 0 ? '#10b981' : '#ef4444', parseFloat(t1MoM) >= 0 ? '#34d399' : '#f87171');
                    updateCard(card4, '📊', 'T2 MoM Change', (parseFloat(t2MoM) >= 0 ? '+' : '') + t2MoM + '%',
                        'T2 change vs Jan',
                        parseFloat(t2MoM) >= 0 ? '#10b981' : '#ef4444', parseFloat(t2MoM) >= 0 ? '#34d399' : '#f87171');

                    // Dynamic tooltips for Tier view
                    const tierMetricLabel = isAvg ? 'avg scale' : metricKey === 'target' ? 'total target' : '# of partners';
                    card1.setAttribute('data-tooltip', `T1 cities ${tierMetricLabel} in Feb: ${formatVal(t1Data.jan[metricKey])} (Jan: ${formatVal(t1Data.dec[metricKey])}, MoM ${t1MoM}%).`);
                    card2.setAttribute('data-tooltip', `T2 cities ${tierMetricLabel} in Feb: ${formatVal(t2Data.jan[metricKey])} (Jan: ${formatVal(t2Data.dec[metricKey])}, MoM ${t2MoM}%).`);
                    card3.setAttribute('data-tooltip', `T1 month-over-month change in ${tierMetricLabel}: ${parseFloat(t1MoM) >= 0 ? '+' : ''}${t1MoM}% from Jan to Feb.`);
                    card4.setAttribute('data-tooltip', `T2 month-over-month change in ${tierMetricLabel}: ${parseFloat(t2MoM) >= 0 ? '+' : ''}${t2MoM}% from Jan to Feb.`);

                } else if (cityTierView === 'performance') {
                    // Performance Distribution
                    const cityPerf = {};
                    cityTierPerformanceData.forEach(row => {
                        if (!cityPerf[row.city]) cityPerf[row.city] = { good: 0, average: 0, bad: 0, total: 0 };
                        cityPerf[row.city][row.performance] = row.partners;
                        cityPerf[row.city].total += row.partners;
                    });
                    
                    let bestCity = { name: '', goodPct: 0 };
                    let worstCity = { name: '', badPct: 0 };
                    let totalGood = 0, totalBad = 0, totalAll = 0;
                    const partnersWithTarget = 551; // Base for percentage calculation
                    
                    Object.entries(cityPerf).forEach(([city, data]) => {
                        const goodPct = data.total > 0 ? (data.good / data.total * 100) : 0;
                        const badPct = data.total > 0 ? (data.bad / data.total * 100) : 0;
                        totalGood += data.good;
                        totalBad += data.bad;
                        totalAll += data.total;
                        if (goodPct > bestCity.goodPct) bestCity = { name: city, goodPct };
                        if (badPct > worstCity.badPct && data.bad > 0) worstCity = { name: city, badPct };
                    });

                    // Calculate MoM for performance using cityTierPerformance data
                    const decGood = cityTierPerformance.t1.partners.dec.good + cityTierPerformance.t2.partners.dec.good;
                    const janGood = cityTierPerformance.t1.partners.jan.good + cityTierPerformance.t2.partners.jan.good;
                    const decBad = cityTierPerformance.t1.partners.dec.bad + cityTierPerformance.t2.partners.dec.bad;
                    const janBad = cityTierPerformance.t1.partners.jan.bad + cityTierPerformance.t2.partners.jan.bad;
                    const goodMoM = formatMoM(decGood, janGood);
                    const badMoM = formatMoM(decBad, janBad);
                    
                    const formatMoMText = (mom) => {
                        const val = parseFloat(mom);
                        const color = val >= 0 ? '#10b981' : '#ef4444';
                        const sign = val >= 0 ? '+' : '';
                        return `<span style="color: ${color}; font-weight: 600;">(MoM ${sign}${mom}%)</span>`;
                    };

                    updateCard(card1, '🏆', 'Best Performing', bestCity.name || 'N/A',
                        bestCity.goodPct.toFixed(1) + '% Good partners',
                        '#10b981', '#34d399');
                    updateCard(card2, '⚠️', 'Needs Attention', worstCity.name || 'N/A',
                        worstCity.badPct.toFixed(1) + '% Bad partners',
                        '#ef4444', '#f87171');
                    updateCard(card3, '✅', 'Overall Good %', (totalGood / partnersWithTarget * 100).toFixed(1) + '%',
                        totalGood + ' Good partners ' + formatMoMText(goodMoM),
                        '#22c55e', '#4ade80');
                    updateCard(card4, '❌', 'Overall Bad %', (totalBad / partnersWithTarget * 100).toFixed(1) + '%',
                        totalBad + ' Bad partners ' + formatMoMText(badMoM),
                        '#f59e0b', '#fbbf24');

                    // Dynamic tooltips for Performance view
                    card1.setAttribute('data-tooltip', `City with highest % of Good performance partners: ${bestCity.name || 'N/A'} at ${bestCity.goodPct.toFixed(1)}%.`);
                    card2.setAttribute('data-tooltip', `City with highest % of Bad performance partners: ${worstCity.name || 'N/A'} at ${worstCity.badPct.toFixed(1)}%. Needs immediate attention.`);
                    card3.setAttribute('data-tooltip', `Overall Good partners: ${totalGood} out of ${partnersWithTarget} (${(totalGood / partnersWithTarget * 100).toFixed(1)}%). MoM: ${goodMoM}%.`);
                    card4.setAttribute('data-tooltip', `Overall Bad partners: ${totalBad} out of ${partnersWithTarget} (${(totalBad / partnersWithTarget * 100).toFixed(1)}%). MoM: ${badMoM}%.`);

                } else if (cityTierView === 'scale') {
                    // Scale Distribution
                    const cityScale = {};
                    cityTierScaleData.forEach(row => {
                        if (!cityScale[row.city]) cityScale[row.city] = { big: 0, mid: 0, small: 0, total: 0 };
                        cityScale[row.city][row.scale] = row.partners;
                        cityScale[row.city].total += row.partners;
                    });
                    
                    let mostBig = { name: '', count: 0 };
                    let mostSmall = { name: '', count: 0 };
                    let totalBig = 0, totalSmall = 0, totalMid = 0;
                    const partnersWithTarget = 551; // Base for percentage calculation
                    
                    Object.entries(cityScale).forEach(([city, data]) => {
                        totalBig += data.big;
                        totalSmall += data.small;
                        totalMid += data.mid;
                        if (data.big > mostBig.count) mostBig = { name: city, count: data.big };
                        if (data.small > mostSmall.count) mostSmall = { name: city, count: data.small };
                    });

                    // Calculate MoM for scale using cityTierScale data
                    const decBig = cityTierScale.t1.partners.dec.big + cityTierScale.t2.partners.dec.big;
                    const janBig = cityTierScale.t1.partners.jan.big + cityTierScale.t2.partners.jan.big;
                    const decSmall = cityTierScale.t1.partners.dec.small + cityTierScale.t2.partners.dec.small;
                    const janSmall = cityTierScale.t1.partners.jan.small + cityTierScale.t2.partners.jan.small;
                    const bigMoM = formatMoM(decBig, janBig);
                    const smallMoM = formatMoM(decSmall, janSmall);
                    
                    const formatMoMText = (mom) => {
                        const val = parseFloat(mom);
                        const color = val >= 0 ? '#10b981' : '#ef4444';
                        const sign = val >= 0 ? '+' : '';
                        return `<span style="color: ${color}; font-weight: 600;">(MoM ${sign}${mom}%)</span>`;
                    };

                    updateCard(card1, '📈', 'Most Big Scale', mostBig.name || 'N/A',
                        mostBig.count + ' Big scale partners',
                        '#8b5cf6', '#a78bfa');
                    updateCard(card2, '📉', 'Most Small Scale', mostSmall.name || 'N/A',
                        mostSmall.count + ' Small scale partners',
                        '#f59e0b', '#fbbf24');
                    updateCard(card3, '🔵', 'Overall Big %', (totalBig / partnersWithTarget * 100).toFixed(1) + '%',
                        totalBig + ' Big partners ' + formatMoMText(bigMoM),
                        '#6366f1', '#818cf8');
                    updateCard(card4, '🟠', 'Overall Small %', (totalSmall / partnersWithTarget * 100).toFixed(1) + '%',
                        totalSmall + ' Small partners ' + formatMoMText(smallMoM),
                        '#fb923c', '#fdba74');

                    // Dynamic tooltips for Scale view
                    card1.setAttribute('data-tooltip', `City with the most Big scale partners: ${mostBig.name || 'N/A'} with ${mostBig.count} partners.`);
                    card2.setAttribute('data-tooltip', `City with the most Small scale partners: ${mostSmall.name || 'N/A'} with ${mostSmall.count} partners.`);
                    card3.setAttribute('data-tooltip', `Overall Big scale: ${totalBig} of ${partnersWithTarget} partners (${(totalBig / partnersWithTarget * 100).toFixed(1)}%). MoM: ${bigMoM}%.`);
                    card4.setAttribute('data-tooltip', `Overall Small scale: ${totalSmall} of ${partnersWithTarget} partners (${(totalSmall / partnersWithTarget * 100).toFixed(1)}%). MoM: ${smallMoM}%.`);
                }

                // Animate cards in with stagger only if view changed
                if (viewChanged) {
                    cards.forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.remove('preparing');
                            card.classList.add('fly-in');
                        }, index * 120); // 120ms stagger between each card
                    });
                }
            };

            // If view changed, wait a brief moment before updating content
            if (viewChanged) {
                setTimeout(doUpdate, 50);
            } else {
                doUpdate();
            }
        }

        function cityTierRenderCitySummary() {
            const sortedRows = [...cityTierCityData].sort((a, b) => b.jan[cityTierMetric] - a.jan[cityTierMetric]);
            const labels = sortedRows.map(row => row.city);
            const decData = sortedRows.map(row => row.dec[cityTierMetric]);
            const janData = sortedRows.map(row => row.jan[cityTierMetric]);

            const title = document.getElementById('cityTierCityTitle');
            if (title) {
                title.textContent = `City Comparison • ${cityTierMetricLabels[cityTierMetric]} (Jan vs Feb)`;
            }

            const tableBody = document.getElementById('cityTierCityTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                sortedRows.forEach((row, idx) => {
                    const dec = row.dec[cityTierMetric];
                    const jan = row.jan[cityTierMetric];
                    const mom = cityTierFormatMoM(dec, jan);
                    const tr = document.createElement('tr');
                    tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${row.city}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${cityTierMoMColor(mom)};">${mom}%</span></td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            const canvas = document.getElementById('cityTierCityChart');
            if (!canvas) return;
            if (cityTierCityChart) { try { cityTierCityChart.destroy(); } catch (e) {} }

            const momPlugin = cityTierMomLabelPlugin(decData, janData, 9);
            cityTierCityChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Jan', data: decData, backgroundColor: '#93c5fd' },
                        { label: 'Feb', data: janData, backgroundColor: '#6ee7b7' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const valueText = `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    if (context.datasetIndex === 1) {
                                        const mom = cityTierFormatMoM(decData[context.dataIndex], janData[context.dataIndex]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        return `${valueText} (MoM ${sign}${mom}%)`;
                                    }
                                    return valueText;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                },
                plugins: [momPlugin]
            });
        }

        function cityTierRenderPerformanceDistribution() {
            // Get cities directly from cityTierMap
            const t1Cities = Object.keys(cityTierMap).filter(city => cityTierMap[city] === 't1');
            const t2Cities = Object.keys(cityTierMap).filter(city => cityTierMap[city] === 't2');
            const filter = cityTierPerformanceFilter;

            const singleWrap = document.getElementById('cityTierPerformanceSingle');
            const splitWrap = document.getElementById('cityTierPerformanceSplit');

            const filteredRows = cityTierPerformanceData.filter(row => {
                if (filter === 't1') return t1Cities.includes(row.city);
                if (filter === 't2') return t2Cities.includes(row.city);
                return true;
            });

            const cityTotals = {};
            filteredRows.forEach(row => {
                cityTotals[row.city] = (cityTotals[row.city] || 0) + row.partners;
            });

            let labels = [];
            let goodCounts = [];
            let avgCounts = [];
            let badCounts = [];

            if (filter === 't1t2') {
                if (singleWrap) singleWrap.style.display = 'none';
                if (splitWrap) splitWrap.style.display = 'block';
            } else {
                if (singleWrap) singleWrap.style.display = 'block';
                if (splitWrap) splitWrap.style.display = 'none';
                labels = Object.keys(cityTotals).sort((a, b) => (cityTotals[b] || 0) - (cityTotals[a] || 0));
            }
            const buildSeries = (labelsList, rows, totals) => ({
                good: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.performance === 'good');
                    return row ? row.partners : 0;
                }),
                avg: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.performance === 'average');
                    return row ? row.partners : 0;
                }),
                bad: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.performance === 'bad');
                    return row ? row.partners : 0;
                }),
                totals: labelsList.map(city => totals[city] || 0)
            });

            if (filter === 't1t2') {
                const t1Rows = cityTierPerformanceData.filter(r => t1Cities.includes(r.city));
                const t2Rows = cityTierPerformanceData.filter(r => t2Cities.includes(r.city));

                const t1Totals = {};
                t1Rows.forEach(row => { t1Totals[row.city] = (t1Totals[row.city] || 0) + row.partners; });
                const t2Totals = {};
                t2Rows.forEach(row => { t2Totals[row.city] = (t2Totals[row.city] || 0) + row.partners; });

                const t1Labels = Object.keys(t1Totals).sort((a, b) => (t1Totals[b] || 0) - (t1Totals[a] || 0));
                const t2Labels = Object.keys(t2Totals).sort((a, b) => (t2Totals[b] || 0) - (t2Totals[a] || 0));

                const t1Series = buildSeries(t1Labels, t1Rows, t1Totals);
                const t2Series = buildSeries(t2Labels, t2Rows, t2Totals);

                const makeChart = (canvasId, series, labelsList, totalsMap, storeSetter) => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    if (storeSetter.current) {
                        storeSetter.current.destroy();
                    }
                    const totalsArray = labelsList.map(city => totalsMap[city] || 0);
                    const maxTotal = Math.max(...totalsArray, 1);
                    storeSetter.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labelsList,
                            datasets: [
                                { label: 'Good', data: series.good, backgroundColor: '#16a34a', stack: 'stack1', order: 2 },
                                { label: 'Average', data: series.avg, backgroundColor: '#f59e0b', stack: 'stack1', order: 2 },
                                { label: 'Bad', data: series.bad, backgroundColor: '#ef4444', stack: 'stack1', order: 2 },
                                {
                                    label: 'Total Partners Trend',
                                    data: totalsArray,
                                    type: 'line',
                                    borderColor: '#1f2937',
                                    backgroundColor: '#1f2937',
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#1f2937',
                                    fill: false,
                                    tension: 0.3,
                                    order: 1,
                                    datalabels: {
                                        display: true,
                                        color: '#1f2937',
                                        font: { size: 11, weight: 'bold' },
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4,
                                        formatter: (value) => value.toLocaleString()
                                    }
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2.5,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        boxWidth: 12
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            return tooltipItems[0].label;
                                        },
                                        label: function(context) {
                                            if (context.dataset.label === 'Total Partners Trend') {
                                                return null;
                                            }
                                            const total = totalsMap[context.label] || 0;
                                            const pct = total ? (context.parsed.y / total) * 100 : 0;
                                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct.toFixed(0)}%)`;
                                        },
                                        afterBody: function(tooltipItems) {
                                            const city = tooltipItems[0].label;
                                            const total = totalsMap[city] || 0;
                                            return [`──────────`, `Total: ${total.toLocaleString()}`];
                                        }
                                    },
                                    filter: function(tooltipItem) {
                                        return tooltipItem.dataset.label !== 'Total Partners Trend';
                                    }
                                },
                                datalabels: {
                                    display: function(context) {
                                        if (context.dataset.type === 'line') return false;
                                        return context.dataset.data[context.dataIndex] > 0;
                                    },
                                    color: '#ffffff',
                                    font: { size: 9, weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    formatter: (value, context) => {
                                        if (context.dataset.type === 'line' || !value) return '';
                                        const total = totalsMap[context.chart.data.labels[context.dataIndex]] || 0;
                                        const pct = total ? (value / total) * 100 : 0;
                                        return `${value}\n(${pct.toFixed(0)}%)`;
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    max: Math.ceil(maxTotal * 1.15),
                                    ticks: { callback: v => v.toLocaleString() }
                                }
                            }
                        }
                    });
                };

                makeChart('cityTierPerformanceChartT1', t1Series, t1Labels, t1Totals, {
                    get current() { return cityTierPerformanceChartT1; },
                    set current(v) { cityTierPerformanceChartT1 = v; }
                });
                makeChart('cityTierPerformanceChartT2', t2Series, t2Labels, t2Totals, {
                    get current() { return cityTierPerformanceChartT2; },
                    set current(v) { cityTierPerformanceChartT2 = v; }
                });
            } else {
                labels = Object.keys(cityTotals).sort((a, b) => (cityTotals[b] || 0) - (cityTotals[a] || 0));
                const series = buildSeries(labels, filteredRows, cityTotals);
                goodCounts = series.good;
                avgCounts = series.avg;
                badCounts = series.bad;
            }

            if (filter !== 't1t2') {
                if (cityTierPerformanceChart) {
                    cityTierPerformanceChart.destroy();
                }

                const totalsArray = labels.map(city => cityTotals[city] || 0);
                const maxTotal = Math.max(...totalsArray, 1);

                const ctx = document.getElementById('cityTierPerformanceChart').getContext('2d');
                cityTierPerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Good', data: goodCounts, backgroundColor: '#16a34a', stack: 'stack1', order: 2 },
                            { label: 'Average', data: avgCounts, backgroundColor: '#f59e0b', stack: 'stack1', order: 2 },
                            { label: 'Bad', data: badCounts, backgroundColor: '#ef4444', stack: 'stack1', order: 2 },
                            {
                                label: 'Total Partners Trend',
                                data: totalsArray,
                                type: 'line',
                                borderColor: '#1f2937',
                                backgroundColor: '#1f2937',
                                borderWidth: 2,
                                pointRadius: 5,
                                pointBackgroundColor: '#1f2937',
                                fill: false,
                                tension: 0.3,
                                order: 1,
                                datalabels: {
                                    display: true,
                                    color: '#1f2937',
                                    font: { size: 11, weight: 'bold' },
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 4,
                                    formatter: (value) => value.toLocaleString()
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        if (context.dataset.label === 'Total Partners Trend') {
                                            return null;
                                        }
                                        const total = cityTotals[context.label] || 0;
                                        const pct = total ? (context.parsed.y / total) * 100 : 0;
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct.toFixed(0)}%)`;
                                    },
                                    afterBody: function(tooltipItems) {
                                        const city = tooltipItems[0].label;
                                        const total = cityTotals[city] || 0;
                                        return [`──────────`, `Total: ${total.toLocaleString()}`];
                                    }
                                },
                                filter: function(tooltipItem) {
                                    return tooltipItem.dataset.label !== 'Total Partners Trend';
                                }
                            },
                            datalabels: {
                                display: function(context) {
                                    if (context.dataset.type === 'line') return false;
                                    return context.dataset.data[context.dataIndex] > 0;
                                },
                                color: '#ffffff',
                                font: { size: 9, weight: 'bold' },
                                anchor: 'center',
                                align: 'center',
                                formatter: (value, context) => {
                                    if (context.dataset.type === 'line' || !value) return '';
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const total = cityTotals[label] || 0;
                                    const pct = total ? (value / total) * 100 : 0;
                                    return `${value}\n(${pct.toFixed(0)}%)`;
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: Math.ceil(maxTotal * 1.15),
                                ticks: { callback: v => v.toLocaleString() }
                            }
                        }
                    }
                });
            }

            const tableBody = document.getElementById('cityTierPerformanceTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                // Calculate city share % for Good and Bad performance rows
                const goodRows = filteredRows
                    .filter(r => r.performance === 'good')
                    .map(r => ({
                        city: r.city,
                        pct: cityTotals[r.city] ? (r.partners / cityTotals[r.city]) * 100 : 0
                    }))
                    .sort((a, b) => b.pct - a.pct);
                
                const badRows = filteredRows
                    .filter(r => r.performance === 'bad' && r.partners > 0)
                    .map(r => ({
                        city: r.city,
                        pct: cityTotals[r.city] ? (r.partners / cityTotals[r.city]) * 100 : 0
                    }))
                    .sort((a, b) => b.pct - a.pct);
                
                // Get top 3 cities for each
                const top3Good = goodRows.slice(0, 3).map(r => r.city);
                const top3Bad = badRows.slice(0, 3).map(r => r.city);
                
                // Create lookup for Good % and Bad % per city
                const cityGoodPct = {};
                const cityBadPct = {};
                goodRows.forEach(r => { cityGoodPct[r.city] = r.pct; });
                badRows.forEach(r => { cityBadPct[r.city] = r.pct; });
                
                // Calculate risk per city
                const getCityRisk = (city) => {
                    const goodPct = cityGoodPct[city] || 0;
                    const badPct = cityBadPct[city] || 0;
                    if (goodPct < 30 || badPct >= 20) return { level: 'High Risk', color: '#dc2626', bg: '#fee2e2' };
                    if (goodPct >= 50) return { level: 'Low Risk', color: '#16a34a', bg: '#dcfce7' };
                    return { level: 'Moderate Risk', color: '#f59e0b', bg: '#fef3c7' };
                };
                
                filteredRows.forEach((row, idx) => {
                    const total = cityTotals[row.city] || 0;
                    const pct = total ? (row.partners / total) * 100 : 0;
                    const changeText = row.changePct === null ? '-' : `${row.changePct.toFixed(1)}%`;
                    const changeColor = row.changePct === null ? '#6b7280' : (row.changePct > 0 ? '#16a34a' : (row.changePct < 0 ? '#dc2626' : '#6b7280'));
                    
                    // Determine highlight colors for full row
                    let rowBg = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    let cellStyle = '';
                    
                    if (row.performance === 'good' && top3Good.includes(row.city)) {
                        rowBg = '#dcfce7'; // Light green background for full row
                        cellStyle = 'background: #dcfce7;';
                    } else if (row.performance === 'bad' && top3Bad.includes(row.city)) {
                        rowBg = '#fee2e2'; // Light red background for full row
                        cellStyle = 'background: #fee2e2;';
                    }
                    
                    // Get risk level for this city
                    const risk = getCityRisk(row.city);
                    
                    const tr = document.createElement('tr');
                    tr.style.background = rowBg;
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600; ${cellStyle}">${row.city}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-transform: capitalize; ${cellStyle}">${row.performance}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; ${cellStyle}">${row.partners.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.change.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${changeColor}; ${cellStyle}">${changeText}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; ${cellStyle}">${pct.toFixed(1)}%</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${risk.color}; background: ${risk.bg};">${risk.level}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        // Scale Distribution Rendering Function
        function cityTierRenderScaleDistribution() {
            // Get cities directly from cityTierMap
            const t1Cities = Object.keys(cityTierMap).filter(city => cityTierMap[city] === 't1');
            const t2Cities = Object.keys(cityTierMap).filter(city => cityTierMap[city] === 't2');
            const filter = cityTierScaleFilter;

            const singleWrap = document.getElementById('cityTierScaleSingle');
            const splitWrap = document.getElementById('cityTierScaleSplit');

            const filteredRows = cityTierScaleData.filter(row => {
                if (filter === 't1') return t1Cities.includes(row.city);
                if (filter === 't2') return t2Cities.includes(row.city);
                return true;
            });

            const cityTotals = {};
            filteredRows.forEach(row => {
                cityTotals[row.city] = (cityTotals[row.city] || 0) + row.partners;
            });

            let labels = [];
            let bigCounts = [];
            let midCounts = [];
            let smallCounts = [];

            if (filter === 't1t2') {
                if (singleWrap) singleWrap.style.display = 'none';
                if (splitWrap) splitWrap.style.display = 'block';
            } else {
                if (singleWrap) singleWrap.style.display = 'block';
                if (splitWrap) splitWrap.style.display = 'none';
                labels = Object.keys(cityTotals).sort((a, b) => (cityTotals[b] || 0) - (cityTotals[a] || 0));
            }
            const buildSeries = (labelsList, rows, totals) => ({
                big: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.scale === 'big');
                    return row ? row.partners : 0;
                }),
                mid: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.scale === 'mid');
                    return row ? row.partners : 0;
                }),
                small: labelsList.map(city => {
                    const row = rows.find(r => r.city === city && r.scale === 'small');
                    return row ? row.partners : 0;
                }),
                totals: labelsList.map(city => totals[city] || 0)
            });

            if (filter === 't1t2') {
                const t1Rows = cityTierScaleData.filter(r => t1Cities.includes(r.city));
                const t2Rows = cityTierScaleData.filter(r => t2Cities.includes(r.city));

                const t1Totals = {};
                t1Rows.forEach(row => { t1Totals[row.city] = (t1Totals[row.city] || 0) + row.partners; });
                const t2Totals = {};
                t2Rows.forEach(row => { t2Totals[row.city] = (t2Totals[row.city] || 0) + row.partners; });

                const t1Labels = Object.keys(t1Totals).sort((a, b) => (t1Totals[b] || 0) - (t1Totals[a] || 0));
                const t2Labels = Object.keys(t2Totals).sort((a, b) => (t2Totals[b] || 0) - (t2Totals[a] || 0));

                const t1Series = buildSeries(t1Labels, t1Rows, t1Totals);
                const t2Series = buildSeries(t2Labels, t2Rows, t2Totals);

                const makeScaleChart = (canvasId, series, labelsList, totalsMap, storeSetter) => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    if (storeSetter.current) {
                        storeSetter.current.destroy();
                    }
                    const totalsArray = labelsList.map(city => totalsMap[city] || 0);
                    const maxTotal = Math.max(...totalsArray, 1);
                    storeSetter.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labelsList,
                            datasets: [
                                { label: 'Big', data: series.big, backgroundColor: '#7c3aed', stack: 'stack1', order: 2 },
                                { label: 'Mid', data: series.mid, backgroundColor: '#0ea5e9', stack: 'stack1', order: 2 },
                                { label: 'Small', data: series.small, backgroundColor: '#f59e0b', stack: 'stack1', order: 2 },
                                {
                                    label: 'Total Partners Trend',
                                    data: totalsArray,
                                    type: 'line',
                                    borderColor: '#1f2937',
                                    backgroundColor: '#1f2937',
                                    borderWidth: 2,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#1f2937',
                                    fill: false,
                                    tension: 0.3,
                                    order: 1,
                                    datalabels: {
                                        display: true,
                                        color: '#1f2937',
                                        font: { size: 11, weight: 'bold' },
                                        anchor: 'end',
                                        align: 'top',
                                        offset: 4,
                                        formatter: (value) => value.toLocaleString()
                                    }
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2.5,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        boxWidth: 12
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            return tooltipItems[0].label;
                                        },
                                        label: function(context) {
                                            if (context.dataset.label === 'Total Partners Trend') {
                                                return null;
                                            }
                                            const total = totalsMap[context.label] || 0;
                                            const pct = total ? (context.parsed.y / total) * 100 : 0;
                                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct.toFixed(0)}%)`;
                                        },
                                        afterBody: function(tooltipItems) {
                                            const city = tooltipItems[0].label;
                                            const total = totalsMap[city] || 0;
                                            return [`──────────`, `Total: ${total.toLocaleString()}`];
                                        }
                                    },
                                    filter: function(tooltipItem) {
                                        return tooltipItem.dataset.label !== 'Total Partners Trend';
                                    }
                                },
                                datalabels: {
                                    display: function(context) {
                                        if (context.dataset.type === 'line') return false;
                                        return context.dataset.data[context.dataIndex] > 0;
                                    },
                                    color: '#ffffff',
                                    font: { size: 9, weight: 'bold' },
                                    anchor: 'center',
                                    align: 'center',
                                    formatter: (value, context) => {
                                        if (context.dataset.type === 'line' || !value) return '';
                                        const total = totalsMap[context.chart.data.labels[context.dataIndex]] || 0;
                                        const pct = total ? (value / total) * 100 : 0;
                                        return `${value}\n(${pct.toFixed(0)}%)`;
                                    }
                                }
                            },
                            scales: {
                                x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    max: Math.ceil(maxTotal * 1.15),
                                    ticks: { callback: v => v.toLocaleString() }
                                }
                            }
                        }
                    });
                };

                makeScaleChart('cityTierScaleChartT1', t1Series, t1Labels, t1Totals, {
                    get current() { return cityTierScaleChartT1; },
                    set current(v) { cityTierScaleChartT1 = v; }
                });
                makeScaleChart('cityTierScaleChartT2', t2Series, t2Labels, t2Totals, {
                    get current() { return cityTierScaleChartT2; },
                    set current(v) { cityTierScaleChartT2 = v; }
                });
            } else {
                labels = Object.keys(cityTotals).sort((a, b) => (cityTotals[b] || 0) - (cityTotals[a] || 0));
                const series = buildSeries(labels, filteredRows, cityTotals);
                bigCounts = series.big;
                midCounts = series.mid;
                smallCounts = series.small;
            }

            if (filter !== 't1t2') {
                if (cityTierScaleChart) {
                    cityTierScaleChart.destroy();
                }

                const totalsArray = labels.map(city => cityTotals[city] || 0);
                const maxTotal = Math.max(...totalsArray, 1);

                const ctx = document.getElementById('cityTierScaleChart').getContext('2d');
                cityTierScaleChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Big', data: bigCounts, backgroundColor: '#7c3aed', stack: 'stack1', order: 2 },
                            { label: 'Mid', data: midCounts, backgroundColor: '#0ea5e9', stack: 'stack1', order: 2 },
                            { label: 'Small', data: smallCounts, backgroundColor: '#f59e0b', stack: 'stack1', order: 2 },
                            {
                                label: 'Total Partners Trend',
                                data: totalsArray,
                                type: 'line',
                                borderColor: '#1f2937',
                                backgroundColor: '#1f2937',
                                borderWidth: 2,
                                pointRadius: 5,
                                pointBackgroundColor: '#1f2937',
                                fill: false,
                                tension: 0.3,
                                order: 1,
                                datalabels: {
                                    display: true,
                                    color: '#1f2937',
                                    font: { size: 11, weight: 'bold' },
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 4,
                                    formatter: (value) => value.toLocaleString()
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 12
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        if (context.dataset.label === 'Total Partners Trend') {
                                            return null;
                                        }
                                        const total = cityTotals[context.label] || 0;
                                        const pct = total ? (context.parsed.y / total) * 100 : 0;
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} (${pct.toFixed(0)}%)`;
                                    },
                                    afterBody: function(tooltipItems) {
                                        const city = tooltipItems[0].label;
                                        const total = cityTotals[city] || 0;
                                        return [`──────────`, `Total: ${total.toLocaleString()}`];
                                    }
                                },
                                filter: function(tooltipItem) {
                                    return tooltipItem.dataset.label !== 'Total Partners Trend';
                                }
                            },
                            datalabels: {
                                display: function(context) {
                                    if (context.dataset.type === 'line') return false;
                                    return context.dataset.data[context.dataIndex] > 0;
                                },
                                color: '#ffffff',
                                font: { size: 9, weight: 'bold' },
                                anchor: 'center',
                                align: 'center',
                                formatter: (value, context) => {
                                    if (context.dataset.type === 'line' || !value) return '';
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const total = cityTotals[label] || 0;
                                    const pct = total ? (value / total) * 100 : 0;
                                    return `${value}\n(${pct.toFixed(0)}%)`;
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                max: Math.ceil(maxTotal * 1.15),
                                ticks: { callback: v => v.toLocaleString() }
                            }
                        }
                    }
                });
            }

            // Render Scale Table
            const tableBody = document.getElementById('cityTierScaleTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                // Calculate city share % for Big and Small scale rows
                const bigRows = filteredRows
                    .filter(r => r.scale === 'big' && r.partners > 0)
                    .map(r => ({
                        city: r.city,
                        pct: cityTotals[r.city] ? (r.partners / cityTotals[r.city]) * 100 : 0
                    }))
                    .sort((a, b) => b.pct - a.pct);
                
                const smallRows = filteredRows
                    .filter(r => r.scale === 'small' && r.partners > 0)
                    .map(r => ({
                        city: r.city,
                        pct: cityTotals[r.city] ? (r.partners / cityTotals[r.city]) * 100 : 0
                    }))
                    .sort((a, b) => b.pct - a.pct);
                
                // Get top 3 cities for each
                const top3Big = bigRows.slice(0, 3).map(r => r.city);
                const top3Small = smallRows.slice(0, 3).map(r => r.city);
                
                filteredRows.forEach((row, idx) => {
                    const total = cityTotals[row.city] || 0;
                    const pct = total ? (row.partners / total) * 100 : 0;
                    const changeText = row.changePct === null ? '-' : `${row.changePct.toFixed(1)}%`;
                    const changeColor = row.changePct === null ? '#6b7280' : (row.changePct > 0 ? '#16a34a' : (row.changePct < 0 ? '#dc2626' : '#6b7280'));
                    
                    // Determine highlight colors for full row
                    let rowBg = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    let cellStyle = '';
                    
                    if (row.scale === 'big' && top3Big.includes(row.city)) {
                        rowBg = '#ede9fe'; // Light purple background for Big
                        cellStyle = 'background: #ede9fe;';
                    } else if (row.scale === 'small' && top3Small.includes(row.city)) {
                        rowBg = '#fef3c7'; // Light yellow/amber background for Small
                        cellStyle = 'background: #fef3c7;';
                    }
                    
                    const tr = document.createElement('tr');
                    tr.style.background = rowBg;
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600; ${cellStyle}">${row.city}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-transform: capitalize; ${cellStyle}">${row.scale}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; ${cellStyle}">${row.partners.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; ${cellStyle}">${row.change.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; color: ${changeColor}; ${cellStyle}">${changeText}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; ${cellStyle}">${pct.toFixed(1)}%</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        function cityTierGetCityData(cityName, metricKey) {
            const row = cityTierCityData.find(item => item.city === cityName);
            if (!row) return null;
            return {
                labels: [cityTierMetricLabels[metricKey]],
                decData: [row.dec[metricKey]],
                janData: [row.jan[metricKey]]
            };
        }

        function cityTierGetBreakdownData(tier, cityName) {
            if (cityTierBreakdown === 'city') {
                if (cityName && cityName !== 'all') {
                    return cityTierGetCityData(cityName, cityTierBreakdownMetric);
                }
                const filteredCities = cityTierCityData
                    .filter(row => cityTierMap[row.city] === tier)
                    .sort((a, b) => b.jan[cityTierBreakdownMetric] - a.jan[cityTierBreakdownMetric]);
                return {
                    labels: filteredCities.map(row => row.city),
                    decData: filteredCities.map(row => row.dec[cityTierBreakdownMetric]),
                    janData: filteredCities.map(row => row.jan[cityTierBreakdownMetric])
                };
            }

            if (cityName && cityName !== 'all') {
                return cityTierGetCityData(cityName, cityTierBreakdownMetric);
            }

            if (cityTierBreakdown === 'overview') {
                const metric = cityTierBreakdownMetric;
                const label = cityTierMetricLabels[metric];
                return {
                    labels: [label],
                    decData: [cityTierOverview[tier].dec[metric]],
                    janData: [cityTierOverview[tier].jan[metric]]
                };
            }

            if (cityTierBreakdown === 'performance') {
                const metric = cityTierBreakdownMetric;
                if (metric === 'avg') {
                    const pData = cityTierPerformance[tier].partners;
                    const tData = cityTierPerformance[tier].target;
                    return {
                        labels: ['Good', 'Average', 'Bad'],
                        decData: [pData.dec.good ? +(tData.dec.good / pData.dec.good).toFixed(1) : 0, pData.dec.average ? +(tData.dec.average / pData.dec.average).toFixed(1) : 0, pData.dec.bad ? +(tData.dec.bad / pData.dec.bad).toFixed(1) : 0],
                        janData: [pData.jan.good ? +(tData.jan.good / pData.jan.good).toFixed(1) : 0, pData.jan.average ? +(tData.jan.average / pData.jan.average).toFixed(1) : 0, pData.jan.bad ? +(tData.jan.bad / pData.jan.bad).toFixed(1) : 0]
                    };
                }
                const data = cityTierPerformance[tier][metric];
                return {
                    labels: ['Good', 'Average', 'Bad'],
                    decData: [data.dec.good, data.dec.average, data.dec.bad],
                    janData: [data.jan.good, data.jan.average, data.jan.bad]
                };
            }

            if (cityTierBreakdown === 'scale') {
                const metric = cityTierBreakdownMetric;
                if (metric === 'avg') {
                    const pData = cityTierScale[tier].partners;
                    const tData = cityTierScale[tier].target;
                    return {
                        labels: ['Big', 'Mid', 'Small'],
                        decData: [pData.dec.big ? +(tData.dec.big / pData.dec.big).toFixed(1) : 0, pData.dec.mid ? +(tData.dec.mid / pData.dec.mid).toFixed(1) : 0, pData.dec.small ? +(tData.dec.small / pData.dec.small).toFixed(1) : 0],
                        janData: [pData.jan.big ? +(tData.jan.big / pData.jan.big).toFixed(1) : 0, pData.jan.mid ? +(tData.jan.mid / pData.jan.mid).toFixed(1) : 0, pData.jan.small ? +(tData.jan.small / pData.jan.small).toFixed(1) : 0]
                    };
                }
                const data = cityTierScale[tier][metric];
                return {
                    labels: ['Big', 'Mid', 'Small'],
                    decData: [data.dec.big, data.dec.mid, data.dec.small],
                    janData: [data.jan.big, data.jan.mid, data.jan.small]
                };
            }

            return null;
        }

        function cityTierRenderBreakdownChart(canvasId, chartRef, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            if (chartRef.current) { try { chartRef.current.destroy(); } catch (e) {} }

            const momPlugin = cityTierMomLabelPlugin(data.decData, data.janData, 9);
            chartRef.current = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Jan', data: data.decData, backgroundColor: '#93c5fd' },
                        { label: 'Feb', data: data.janData, backgroundColor: '#6ee7b7' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const valueText = `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    if (context.datasetIndex === 1) {
                                        const mom = cityTierFormatMoM(data.decData[context.dataIndex], data.janData[context.dataIndex]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        return `${valueText} (MoM ${sign}${mom}%)`;
                                    }
                                    return valueText;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                },
                plugins: [momPlugin]
            });
        }

        function cityTierRenderBreakdown() {

            const singleSelect = document.getElementById('cityTierCitySelectSingle');
            const t1Select = document.getElementById('cityTierCitySelectT1');
            const t2Select = document.getElementById('cityTierCitySelectT2');

            if (cityTierTier === 'both') {
                if (singleSelect) singleSelect.style.display = 'none';
                if (t1Select) t1Select.style.display = 'inline-block';
                if (t2Select) t2Select.style.display = 'inline-block';
            } else {
                if (singleSelect) singleSelect.style.display = 'inline-block';
                if (t1Select) t1Select.style.display = 'none';
                if (t2Select) t2Select.style.display = 'none';
            }

            const activeCity = cityTierTier === 'both' ? 'all' : cityTierSelectedCity[cityTierTier];
            if (activeCity !== 'all' && (cityTierBreakdown === 'performance' || cityTierBreakdown === 'scale')) {
                cityTierBreakdown = 'overview';
                const btns = document.querySelectorAll('.city-tier-breakdown-btn');
                const overviewBtn = document.querySelector('.city-tier-breakdown-btn[data-breakdown="overview"]');
                if (overviewBtn) cityTierSetActive(btns, overviewBtn, '#0ea5e9');
            }

            const singleWrap = document.getElementById('cityTierBreakdownSingle');
            const dualWrap = document.getElementById('cityTierBreakdownDual');
            const singleTableWrap = document.getElementById('cityTierBreakdownSingleTable');
            const dualTableWrap = document.getElementById('cityTierBreakdownDualTable');

            if (cityTierTier === 'both') {
                const cityT1 = cityTierSelectedCity.t1;
                const cityT2 = cityTierSelectedCity.t2;
                const dataT1 = cityTierGetBreakdownData('t1', cityT1);
                const dataT2 = cityTierGetBreakdownData('t2', cityT2);
                if (!dataT1 || !dataT2) return;

                if (singleWrap) singleWrap.style.display = 'none';
                if (dualWrap) dualWrap.style.display = 'block';
                if (singleTableWrap) singleTableWrap.style.display = 'none';
                if (dualTableWrap) dualTableWrap.style.display = 'block';

                const breakdownLabel = cityTierBreakdown.charAt(0).toUpperCase() + cityTierBreakdown.slice(1);
                const metricLabel = cityTierMetricLabels[cityTierBreakdownMetric];
                const titleT1 = document.getElementById('cityTierBreakdownTitleT1');
                const titleT2 = document.getElementById('cityTierBreakdownTitleT2');
                const cityLabelT1 = cityT1 !== 'all' ? ` • ${cityT1}` : '';
                const cityLabelT2 = cityT2 !== 'all' ? ` • ${cityT2}` : '';
                if (titleT1) titleT1.textContent = `T1${cityLabelT1} • ${breakdownLabel} • ${metricLabel} (Jan vs Feb)`;
                if (titleT2) titleT2.textContent = `T2${cityLabelT2} • ${breakdownLabel} • ${metricLabel} (Jan vs Feb)`;

                cityTierRenderBreakdownChart('cityTierBreakdownChartT1', {
                    get current() { return cityTierBreakdownChartT1; },
                    set current(v) { cityTierBreakdownChartT1 = v; }
                }, dataT1);
                cityTierRenderBreakdownChart('cityTierBreakdownChartT2', {
                    get current() { return cityTierBreakdownChartT2; },
                    set current(v) { cityTierBreakdownChartT2 = v; }
                }, dataT2);

                const tableBodyT1 = document.getElementById('cityTierBreakdownTableBodyT1');
                const tableBodyT2 = document.getElementById('cityTierBreakdownTableBodyT2');
                if (tableBodyT1 && tableBodyT2) {
                    tableBodyT1.innerHTML = '';
                    dataT1.labels.forEach((label, idx) => {
                        const dec = dataT1.decData[idx];
                        const jan = dataT1.janData[idx];
                        const mom = cityTierFormatMoM(dec, jan);
                        const tr = document.createElement('tr');
                        tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                        tr.innerHTML = `
                            <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${label}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${cityTierMoMColor(mom)};">${mom}%</span></td>
                        `;
                        tableBodyT1.appendChild(tr);
                    });

                    tableBodyT2.innerHTML = '';
                    dataT2.labels.forEach((label, idx) => {
                        const dec = dataT2.decData[idx];
                        const jan = dataT2.janData[idx];
                        const mom = cityTierFormatMoM(dec, jan);
                        const tr = document.createElement('tr');
                        tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                        tr.innerHTML = `
                            <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${label}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${cityTierMoMColor(mom)};">${mom}%</span></td>
                        `;
                        tableBodyT2.appendChild(tr);
                    });
                }
                return;
            }

            const data = cityTierGetBreakdownData(cityTierTier, cityTierSelectedCity[cityTierTier]);
            if (!data) return;

            if (singleWrap) singleWrap.style.display = 'block';
            if (dualWrap) dualWrap.style.display = 'none';
            if (singleTableWrap) singleTableWrap.style.display = 'block';
            if (dualTableWrap) dualTableWrap.style.display = 'none';

            const title = document.getElementById('cityTierBreakdownTitle');
            if (title) {
                const tierLabel = cityTierTier.toUpperCase();
                const breakdownLabel = cityTierBreakdown.charAt(0).toUpperCase() + cityTierBreakdown.slice(1);
                const metricLabel = cityTierMetricLabels[cityTierBreakdownMetric];
                const cityLabel = cityTierSelectedCity[cityTierTier] !== 'all' ? ` • ${cityTierSelectedCity[cityTierTier]}` : '';
                title.textContent = `${tierLabel}${cityLabel} • ${breakdownLabel} • ${metricLabel} (Jan vs Feb)`;
            }

            const tableBody = document.getElementById('cityTierBreakdownTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                data.labels.forEach((label, idx) => {
                    const dec = data.decData[idx];
                    const jan = data.janData[idx];
                    const mom = cityTierFormatMoM(dec, jan);
                    const tr = document.createElement('tr');
                    tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${label}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${cityTierMoMColor(mom)};">${mom}%</span></td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            cityTierRenderBreakdownChart('cityTierBreakdownChart', {
                get current() { return cityTierBreakdownChart; },
                set current(v) { cityTierBreakdownChart = v; }
            }, data);
        }

        document.querySelectorAll('.city-tier-view-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierView = this.getAttribute('data-view');
                cityTierSetActive(document.querySelectorAll('.city-tier-view-toggle'), this, '#0ea5e9');
                document.getElementById('cityTierCityView').style.display = cityTierView === 'city' ? 'block' : 'none';
                document.getElementById('cityTierBreakdownView').style.display = cityTierView === 'tier' ? 'block' : 'none';
                document.getElementById('cityTierPerformanceView').style.display = cityTierView === 'performance' ? 'block' : 'none';
                document.getElementById('cityTierScaleView').style.display = cityTierView === 'scale' ? 'block' : 'none';
                if (cityTierView === 'performance') {
                    cityTierRenderPerformanceDistribution();
                }
                if (cityTierView === 'scale') {
                    cityTierRenderScaleDistribution();
                }
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-performance-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierPerformanceFilter = this.getAttribute('data-filter');
                cityTierSetActive(document.querySelectorAll('.city-tier-performance-filter'), this, '#22c55e');
                cityTierRenderPerformanceDistribution();
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-scale-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierScaleFilter = this.getAttribute('data-filter');
                cityTierSetActive(document.querySelectorAll('.city-tier-scale-filter'), this, '#8b5cf6');
                cityTierRenderScaleDistribution();
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-metric-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierMetric = this.getAttribute('data-metric');
                cityTierSetActive(document.querySelectorAll('.city-tier-metric-btn'), this, '#0ea5e9');
                cityTierRenderCitySummary();
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-tier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierTier = this.getAttribute('data-tier');
                cityTierSetActive(document.querySelectorAll('.city-tier-tier-btn'), this, '#0ea5e9');
                cityTierRefreshSingleSelectOptions();
                cityTierRenderBreakdown();
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-breakdown-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierBreakdown = this.getAttribute('data-breakdown');
                cityTierSetActive(document.querySelectorAll('.city-tier-breakdown-btn'), this, '#0ea5e9');
                cityTierRenderBreakdown();
                cityTierUpdateSummaryCards();
            });
        });

        document.querySelectorAll('.city-tier-breakdown-metric-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                cityTierBreakdownMetric = this.getAttribute('data-metric');
                cityTierSetActive(document.querySelectorAll('.city-tier-breakdown-metric-btn'), this, '#0ea5e9');
                cityTierRenderBreakdown();
                cityTierUpdateSummaryCards();
            });
        });

        function cityTierPopulateCitySelects() {
            const selectSingle = document.getElementById('cityTierCitySelectSingle');
            const selectT1 = document.getElementById('cityTierCitySelectT1');
            const selectT2 = document.getElementById('cityTierCitySelectT2');
            if (!selectSingle || !selectT1 || !selectT2) return;

            const t1Cities = cityTierCityData.filter(row => cityTierMap[row.city] === 't1').map(row => row.city);
            const t2Cities = cityTierCityData.filter(row => cityTierMap[row.city] === 't2').map(row => row.city);

            selectSingle.innerHTML = '<option value="all">All (Tier summary)</option>';
            selectT1.innerHTML = '<option value="all">T1 (Tier summary)</option>';
            selectT2.innerHTML = '<option value="all">T2 (Tier summary)</option>';

            const addOptions = (select, cities) => {
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            };

            addOptions(selectSingle, t1Cities.concat(t2Cities));
            addOptions(selectT1, t1Cities);
            addOptions(selectT2, t2Cities);
        }

        function cityTierRefreshSingleSelectOptions() {
            const selectSingle = document.getElementById('cityTierCitySelectSingle');
            if (!selectSingle) return;

            const t1Cities = cityTierCityData.filter(row => cityTierMap[row.city] === 't1').map(row => row.city);
            const t2Cities = cityTierCityData.filter(row => cityTierMap[row.city] === 't2').map(row => row.city);
            const allowed = cityTierTier === 't2' ? t2Cities : t1Cities;

            selectSingle.innerHTML = '<option value="all">All (Tier summary)</option>';
            allowed.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                selectSingle.appendChild(option);
            });

            if (cityTierSelectedCity[cityTierTier] && cityTierSelectedCity[cityTierTier] !== 'all') {
                if (!allowed.includes(cityTierSelectedCity[cityTierTier])) {
                    cityTierSelectedCity[cityTierTier] = 'all';
                }
            }
            selectSingle.value = cityTierSelectedCity[cityTierTier] || 'all';
        }

        const selectSingle = document.getElementById('cityTierCitySelectSingle');
        const selectT1 = document.getElementById('cityTierCitySelectT1');
        const selectT2 = document.getElementById('cityTierCitySelectT2');
        const clearCityBtn = document.getElementById('cityTierClearCityFilter');

        if (selectSingle) {
            selectSingle.addEventListener('change', function() {
                const value = this.value;
                const tier = cityTierTier === 't2' ? 't2' : 't1';
                cityTierSelectedCity[tier] = value;
                if (value !== 'all' && (cityTierBreakdown === 'performance' || cityTierBreakdown === 'scale')) {
                    cityTierBreakdown = 'overview';
                    const btns = document.querySelectorAll('.city-tier-breakdown-btn');
                    const overviewBtn = document.querySelector('.city-tier-breakdown-btn[data-breakdown="overview"]');
                    if (overviewBtn) cityTierSetActive(btns, overviewBtn, '#0ea5e9');
                }
                cityTierRenderBreakdown();
            });
        }

        if (selectT1) {
            selectT1.addEventListener('change', function() {
                cityTierSelectedCity.t1 = this.value;
                if (this.value !== 'all' && (cityTierBreakdown === 'performance' || cityTierBreakdown === 'scale')) {
                    cityTierBreakdown = 'overview';
                    const btns = document.querySelectorAll('.city-tier-breakdown-btn');
                    const overviewBtn = document.querySelector('.city-tier-breakdown-btn[data-breakdown="overview"]');
                    if (overviewBtn) cityTierSetActive(btns, overviewBtn, '#0ea5e9');
                }
                cityTierRenderBreakdown();
            });
        }

        if (selectT2) {
            selectT2.addEventListener('change', function() {
                cityTierSelectedCity.t2 = this.value;
                if (this.value !== 'all' && (cityTierBreakdown === 'performance' || cityTierBreakdown === 'scale')) {
                    cityTierBreakdown = 'overview';
                    const btns = document.querySelectorAll('.city-tier-breakdown-btn');
                    const overviewBtn = document.querySelector('.city-tier-breakdown-btn[data-breakdown="overview"]');
                    if (overviewBtn) cityTierSetActive(btns, overviewBtn, '#0ea5e9');
                }
                cityTierRenderBreakdown();
            });
        }

        if (clearCityBtn) {
            clearCityBtn.addEventListener('click', function() {
                cityTierSelectedCity.t1 = 'all';
                cityTierSelectedCity.t2 = 'all';
                if (selectSingle) selectSingle.value = 'all';
                if (selectT1) selectT1.value = 'all';
                if (selectT2) selectT2.value = 'all';
                cityTierRenderBreakdown();
            });
        }

        cityTierPopulateCitySelects();
        cityTierRefreshSingleSelectOptions();
        cityTierRenderCitySummary();
        cityTierRenderBreakdown();
        cityTierUpdateSummaryCards(true); // Force animation on initial load
    });

    // Target Movement Analysis Section
    document.addEventListener('DOMContentLoaded', function() {
        const targetMovementTotals = {
            labels: ['Jan', 'Feb'],
            partners: [625, 551],
            increase: [212, 153],
            decrease: [240, 284],
            noChange: [173, 114]
        };

        const targetMovementBreakdownData = {
            increased: { dec: [109, 79, 15], jan: [82, 47, 7] },
            decreased: { dec: [78, 123, 39], jan: [109, 163, 12] },
            nochange: { dec: [82, 72, 19], jan: [61, 52, 1] }
        };

        const targetMovementBreakdownLabels = ['Good', 'Average', 'Bad'];

        const ridersSlabData = {
            increased: {
                labels: ['>=1 - <20', '>=20 - <30', '>=30 - <50', '>=50 - <80', '>=80 - <100', '>=100 - <150', '>=150 - <200', '>=200 - <300', '>=300'],
                dec: [200, 8, 3, 1, 0, 0, 0, 0, 0],
                jan: [139, 12, 1, 1, 0, 0, 0, 0, 0]
            },
            decreased: {
                labels: ['<0 & >-20', '<=-20 & >-30', '<=-30 & >-50', '<=-50 & >-80', '<=-80 & >-100', '<=-100 & >-150', '<=-150 & >-200', '<=-200 & >-300', '<=-300'],
                dec: [221, 11, 6, 0, 1, 1, 0, 0, 0],
                jan: [255, 19, 6, 3, 1, 0, 0, 0, 0]
            },
            total: {
                labels: ['>0 - <20', '>=20 - <30', '>=30 - <50', '>=50 - <80', '>=80 - <100', '>=100 - <150', '>=150 - <200', '>=200 - <300', '>=300'],
                dec: [181, 156, 172, 63, 23, 19, 7, 4, 0],
                jan: [141, 160, 156, 49, 25, 13, 6, 1, 0]
            }
        };

        let targetMovementBreakdownView = 'increased';
        let ridersSlabView = 'total';

        let targetMovementSummaryChart = null;
        let targetMovementBreakdownChart = null;
        let ridersSlabChart = null;

        const formatMoM = (dec, jan) => {
            if (!dec) return '0.0';
            return (((jan - dec) / dec) * 100).toFixed(1);
        };

        const momColor = (mom) => {
            const val = parseFloat(mom);
            if (val > 0) return '#16a34a';
            if (val < 0) return '#dc2626';
            return '#f59e0b';
        };

        function createLineMomLabelPlugin(decData, janData, fontSize) {
            return {
                id: 'lineMomLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    const showDec = chart.isDatasetVisible(0);
                    const showJan = chart.isDatasetVisible(1);
                    ctx.save();
                    ctx.font = `bold ${fontSize}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';

                    const metaDec = chart.getDatasetMeta(0);
                    const metaJan = chart.getDatasetMeta(1);
                    if (showDec && metaDec && metaDec.data) {
                        metaDec.data.forEach((point, idx) => {
                            const decVal = decData[idx];
                            if (decVal === null || decVal === undefined) return;
                            ctx.fillStyle = '#111827';
                            ctx.fillText(Number(decVal).toLocaleString(), point.x, point.y - 6);
                        });
                    }

                    if (showJan && metaJan && metaJan.data) {
                        metaJan.data.forEach((point, idx) => {
                            const janVal = janData[idx];
                            if (janVal === null || janVal === undefined) return;
                            const decVal = decData[idx];
                            const mom = formatMoM(decVal, janVal);
                            const sign = parseFloat(mom) > 0 ? '+' : '';
                            const valText = Number(janVal).toLocaleString();
                            const momText = ` (${sign}${mom}%)`;
                            const valWidth = ctx.measureText(valText).width;
                            const momWidth = ctx.measureText(momText).width;
                            const x = point.x;
                            const y = point.y - 6;
                            ctx.fillStyle = '#111827';
                            ctx.fillText(valText, x - (momWidth / 2), y);
                            ctx.fillStyle = momColor(mom);
                            ctx.fillText(momText, x + (valWidth / 2), y);
                        });
                    }
                    ctx.restore();
                }
            };
        }

        function createSummaryMomPlugin() {
            return {
                id: 'summaryMomLabels',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;
                    ctx.save();
                    ctx.font = 'bold 10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';

                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        if (!chart.isDatasetVisible(datasetIndex)) return;
                        const meta = chart.getDatasetMeta(datasetIndex);
                        const pointDec = meta && meta.data ? meta.data[0] : null;
                        const pointJan = meta && meta.data ? meta.data[1] : null;
                        if (!pointDec || !pointJan) return;

                        const decVal = dataset.data[0];
                        const janVal = dataset.data[1];

                        // Dec label (value only)
                        ctx.fillStyle = '#111827';
                        ctx.fillText(Number(decVal).toLocaleString(), pointDec.x, pointDec.y - 8);

                        // Jan label (value + MoM%)
                        const mom = formatMoM(decVal, janVal);
                        const sign = parseFloat(mom) > 0 ? '+' : '';
                        const valText = Number(janVal).toLocaleString();
                        const momText = ` (${sign}${mom}%)`;
                        const valWidth = ctx.measureText(valText).width;
                        const momWidth = ctx.measureText(momText).width;
                        const x = pointJan.x;
                        const y = pointJan.y - 8;
                        ctx.fillStyle = '#111827';
                        ctx.fillText(valText, x - (momWidth / 2), y);
                        ctx.fillStyle = momColor(mom);
                        ctx.fillText(momText, x + (valWidth / 2), y);
                    });
                    ctx.restore();
                }
            };
        }

        function renderTargetMovementSummary() {
            const canvas = document.getElementById('targetMovementSummaryChart');
            if (!canvas) return;
            if (targetMovementSummaryChart) { try { targetMovementSummaryChart.destroy(); } catch (e) {} }

            const labels = ['Jan', 'Feb'];
            const partnersSeries = [targetMovementTotals.partners[0], targetMovementTotals.partners[1]];
            const increaseSeries = [targetMovementTotals.increase[0], targetMovementTotals.increase[1]];
            const decreaseSeries = [targetMovementTotals.decrease[0], targetMovementTotals.decrease[1]];
            const noChangeSeries = [targetMovementTotals.noChange[0], targetMovementTotals.noChange[1]];

            targetMovementSummaryChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Total partners with target', data: partnersSeries, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.5)', borderWidth: 2 },
                        { label: 'Total Increase', data: increaseSeries, borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.5)', borderWidth: 2 },
                        { label: 'Total Decrease', data: decreaseSeries, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.5)', borderWidth: 2 },
                        { label: 'No Change', data: noChangeSeries, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.5)', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const valueText = `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    if (context.dataIndex === 1) {
                                        const mom = formatMoM(context.dataset.data[0], context.dataset.data[1]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        return `${valueText} (MoM ${sign}${mom}%)`;
                                    }
                                    return valueText;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } }
                    }
                },
                plugins: [createSummaryMomPlugin()]
            });

            const insight = document.querySelector('#targetMovementInsight p');
            if (insight) {
                const totalMom = formatMoM(targetMovementTotals.partners[0], targetMovementTotals.partners[1]);
                const incMom = formatMoM(targetMovementTotals.increase[0], targetMovementTotals.increase[1]);
                const decMom = formatMoM(targetMovementTotals.decrease[0], targetMovementTotals.decrease[1]);
                insight.innerHTML = `Partners with target <strong style="color: ${momColor(totalMom)};">${totalMom}%</strong> MoM | Increases <strong style="color: ${momColor(incMom)};">${incMom}%</strong> | Decreases <strong style="color: ${momColor(decMom)};">${decMom}%</strong> (lower is better)`;
            }
        }

        function renderTargetMovementBreakdown() {
            const data = targetMovementBreakdownData[targetMovementBreakdownView];
            const canvas = document.getElementById('targetMovementBreakdownChart');
            if (!canvas || !data) return;
            if (targetMovementBreakdownChart) { try { targetMovementBreakdownChart.destroy(); } catch (e) {} }

            const title = document.getElementById('targetMovementBreakdownTitle');
            if (title) {
                const label = targetMovementBreakdownView === 'increased' ? 'Total Increased' : (targetMovementBreakdownView === 'decreased' ? 'Total Decreased' : 'No Change');
                title.textContent = `${label} • Segment Breakdown (Jan vs Feb)`;
            }

            const momPlugin = createLineMomLabelPlugin(data.dec, data.jan, 9);
            targetMovementBreakdownChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: targetMovementBreakdownLabels,
                    datasets: [
                        { label: 'Jan', data: data.dec, borderColor: '#93c5fd', backgroundColor: 'rgba(147, 197, 253, 0.2)', tension: 0.5, pointRadius: 5, fill: true },
                        { label: 'Feb', data: data.jan, borderColor: '#6ee7b7', backgroundColor: 'rgba(110, 231, 183, 0.2)', tension: 0.5, pointRadius: 5, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const valueText = `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    if (context.datasetIndex === 1) {
                                        const mom = formatMoM(data.dec[context.dataIndex], data.jan[context.dataIndex]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        return `${valueText} (MoM ${sign}${mom}%)`;
                                    }
                                    return valueText;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } }
                    }
                },
                plugins: [momPlugin]
            });

            const tableBody = document.getElementById('targetMovementBreakdownTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                targetMovementBreakdownLabels.forEach((label, idx) => {
                    const dec = data.dec[idx];
                    const jan = data.jan[idx];
                    const mom = formatMoM(dec, jan);
                    const tr = document.createElement('tr');
                    tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${label}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${momColor(mom)};">${mom}%</span></td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        function renderRidersSlab() {
            const data = ridersSlabData[ridersSlabView];
            const canvas = document.getElementById('ridersSlabChart');
            if (!canvas || !data) return;
            if (ridersSlabChart) { try { ridersSlabChart.destroy(); } catch (e) {} }

            const title = document.getElementById('ridersSlabTitle');
            if (title) {
                const label = ridersSlabView === 'total' ? 'Total with Target' : (ridersSlabView === 'increased' ? 'Increased Target' : 'Decreased Target');
                title.textContent = `${label} • Riders Slab Distribution (Jan vs Feb)`;
            }

            const momPlugin = createLineMomLabelPlugin(data.dec, data.jan, 9);
            ridersSlabChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Jan', data: data.dec, borderColor: '#93c5fd', backgroundColor: 'rgba(147, 197, 253, 0.2)', tension: 0.6, cubicInterpolationMode: 'monotone', pointRadius: 4, fill: true },
                        { label: 'Feb', data: data.jan, borderColor: '#6ee7b7', backgroundColor: 'rgba(110, 231, 183, 0.2)', tension: 0.6, cubicInterpolationMode: 'monotone', pointRadius: 4, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const valueText = `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    if (context.datasetIndex === 1) {
                                        const mom = formatMoM(data.dec[context.dataIndex], data.jan[context.dataIndex]);
                                        const sign = parseFloat(mom) > 0 ? '+' : '';
                                        return `${valueText} (MoM ${sign}${mom}%)`;
                                    }
                                    return valueText;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => v.toLocaleString() } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                },
                plugins: [momPlugin]
            });

            const tableBody = document.getElementById('ridersSlabTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
                data.labels.forEach((label, idx) => {
                    const dec = data.dec[idx];
                    const jan = data.jan[idx];
                    const mom = formatMoM(dec, jan);
                    const tr = document.createElement('tr');
                    tr.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    tr.innerHTML = `
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${label}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${dec.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">${jan.toLocaleString()}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700;"><span style="color: ${momColor(mom)};">${mom}%</span></td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

        }

        document.querySelectorAll('.target-move-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.getAttribute('data-view');
                document.querySelectorAll('.target-move-view-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#7c3aed';
                this.style.color = 'white';
                this.style.borderColor = '#7c3aed';

                // Both sections stay visible side by side
                if (view === 'overall') {
                    renderTargetMovementSummary();
                } else {
                    renderTargetMovementBreakdown();
                }
            });
        });

        // Auto expand/collapse breakdown filter on hover
        const breakdownBtn = document.getElementById('breakdownViewBtn');
        const breakdownFilter = document.getElementById('breakdownFilterContainer');
        const breakdownArrow = document.getElementById('breakdownArrow');
        
        if (breakdownBtn && breakdownFilter && breakdownArrow) {
            breakdownBtn.addEventListener('mouseenter', function() {
                breakdownFilter.style.display = 'flex';
                breakdownArrow.style.transform = 'rotate(-90deg)';
            });
            
            // Keep filter visible when hovering over filter itself
            breakdownFilter.addEventListener('mouseenter', function() {
                breakdownFilter.style.display = 'flex';
                breakdownArrow.style.transform = 'rotate(-90deg)';
            });
            
            breakdownFilter.addEventListener('mouseleave', function() {
                breakdownFilter.style.display = 'none';
                breakdownArrow.style.transform = 'rotate(0deg)';
            });
            
            breakdownBtn.addEventListener('mouseleave', function(e) {
                // Check if mouse moved to the filter container
                setTimeout(() => {
                    if (!breakdownFilter.matches(':hover') && !breakdownBtn.matches(':hover')) {
                        breakdownFilter.style.display = 'none';
                        breakdownArrow.style.transform = 'rotate(0deg)';
                    }
                }, 100);
            });
        }

        document.querySelectorAll('.target-move-breakdown-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                targetMovementBreakdownView = this.getAttribute('data-breakdown');
                document.querySelectorAll('.target-move-breakdown-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#7c3aed';
                this.style.color = 'white';
                this.style.borderColor = '#7c3aed';
                renderTargetMovementBreakdown();
            });
        });

        document.querySelectorAll('.riders-slab-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                ridersSlabView = this.getAttribute('data-view');
                document.querySelectorAll('.riders-slab-view-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#0f766e';
                this.style.color = 'white';
                this.style.borderColor = '#0f766e';
                renderRidersSlab();
            });
        });

        renderTargetMovementSummary();
        renderTargetMovementBreakdown();
        renderRidersSlab();
    });

    // Top/Bottom Partners Overview Section
    document.addEventListener('DOMContentLoaded', function() {
        const topDec = [
            { name: 'ON Time Logistics', cities: 5, status: 'Old', riders: 391, target: 342, performance: 'average', fr: '61.2%', dc: '36.4%' },
            { name: 'ONE TRIP', cities: 5, status: 'Old', riders: 340, target: 318, performance: 'good', fr: '85.5%', dc: '36.8%' },
            { name: 'PARTNER SUCCESS', cities: 2, status: 'Old', riders: 246, target: 255, performance: 'good', fr: '84.3%', dc: '100.0%' },
            { name: 'First Line Logistics', cities: 9, status: 'Old', riders: 280, target: 288, performance: 'average', fr: '88.0%', dc: '6.9%' },
            { name: 'SDC Logistics', cities: 2, status: 'Old', riders: 306, target: 265, performance: 'good', fr: '64.0%', dc: '1.9%' },
            { name: 'Anan Capital', cities: 5, status: 'Old', riders: 172, target: 205, performance: 'good', fr: '82.2%', dc: '45.5%' },
            { name: 'AL-BARAQ AL-KHATEF', cities: 1, status: 'Old', riders: 275, target: 280, performance: 'good', fr: '66.0%', dc: '4.3%' },
            { name: 'Quick Way Logistics', cities: 5, status: 'Old', riders: 181, target: 177, performance: 'average', fr: '86.0%', dc: '51.1%' },
            { name: 'Makhsos', cities: 1, status: 'Old', riders: 171, target: 218, performance: 'good', fr: '75.5%', dc: '87.4%' },
            { name: 'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services', cities: 5, status: 'Old', riders: 228, target: 192, performance: 'good', fr: '89.7%', dc: '28.0%' },
            { name: 'PCC', cities: 2, status: 'Old', riders: 200, target: 168, performance: 'good', fr: '63.5%', dc: '3.5%' },
            { name: 'AMC', cities: 2, status: 'Old', riders: 165, target: 193, performance: 'good', fr: '89.5%', dc: '8.8%' },
            { name: 'AMIYAL', cities: 3, status: 'Old', riders: 175, target: 169, performance: 'good', fr: '85.8%', dc: '35.3%' },
            { name: 'FAHAD AL-SHARQ', cities: 1, status: 'Old', riders: 145, target: 169, performance: 'good', fr: '48.7%', dc: '9.9%' },
            { name: 'SAKA SRIAA LALCHUDMAT AL-LUGASTIA', cities: 4, status: 'Old', riders: 153, target: 175, performance: 'good', fr: '91.9%', dc: '51.9%' },
            { name: 'AL-ANJAZ AL-MATARAA', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Holoul', cities: 1, status: 'Old', riders: 106, target: 125, performance: 'good', fr: '86.7%', dc: '83.3%' },
            { name: 'EXPSERCO', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Establishment ASHRAF BEN HASSIN BEN ALI BOUGRARDAH For logistics', cities: 1, status: 'Old', riders: 160, target: 150, performance: 'good', fr: '83.2%', dc: '4.8%' },
            { name: 'EXPRESS GATE', cities: 2, status: 'Old', riders: 140, target: 158, performance: 'good', fr: '60.2%', dc: '15.1%' }
        ];

        const topJan = [
            { name: 'ON Time Logistics', cities: 5, status: 'Old', riders: 332, target: 325, performance: 'average', fr: '92.8%', dc: '55.4%' },
            { name: 'ONE TRIP', cities: 5, status: 'Old', riders: 311, target: 315, performance: 'good', fr: '97.8%', dc: '38.5%' },
            { name: 'PARTNER SUCCESS', cities: 2, status: 'Old', riders: 241, target: 257, performance: 'good', fr: '94.0%', dc: '100.0%' },
            { name: 'First Line Logistics', cities: 9, status: 'Old', riders: 272, target: 215, performance: 'average', fr: '97.6%', dc: '11.2%' },
            { name: 'SDC Logistics', cities: 2, status: 'Old', riders: 261, target: 210, performance: 'good', fr: '98.6%', dc: '7.8%' },
            { name: 'Anan Capital', cities: 5, status: 'Old', riders: 184, target: 198, performance: 'good', fr: '98.8%', dc: '55.2%' },
            { name: 'AL-BARAQ AL-KHATEF', cities: 1, status: 'Old', riders: 265, target: 195, performance: 'good', fr: '93.7%', dc: '19.3%' },
            { name: 'Quick Way Logistics', cities: 5, status: 'Old', riders: 155, target: 186, performance: 'average', fr: '99.6%', dc: '74.8%' },
            { name: 'Makhsos', cities: 1, status: 'Old', riders: 189, target: 180, performance: 'good', fr: '95.0%', dc: '86.6%' },
            { name: 'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services', cities: 5, status: 'Old', riders: 182, target: 169, performance: 'good', fr: '99.5%', dc: '40.7%' },
            { name: 'PCC', cities: 2, status: 'Old', riders: 189, target: 168, performance: 'good', fr: '98.1%', dc: '5.5%' },
            { name: 'AMC', cities: 2, status: 'Old', riders: 175, target: 166, performance: 'average', fr: '98.1%', dc: '20.4%' },
            { name: 'AMIYAL', cities: 3, status: 'Old', riders: 157, target: 150, performance: 'good', fr: '96.7%', dc: '43.9%' },
            { name: 'FAHAD AL-SHARQ', cities: 1, status: 'Old', riders: 151, target: 150, performance: 'good', fr: '91.0%', dc: '12.2%' },
            { name: 'SAKA SRIAA LALCHUDMAT AL-LUGASTIA', cities: 4, status: 'Old', riders: 149, target: 149, performance: 'average', fr: '98.4%', dc: '64.9%' },
            { name: 'AL-ANJAZ AL-MATARAA', cities: 3, status: 'Old', riders: 116, target: 141, performance: 'good', fr: '97.9%', dc: '37.0%' },
            { name: 'Holoul', cities: 1, status: 'Old', riders: 122, target: 135, performance: 'good', fr: '100.0%', dc: '85.6%' },
            { name: 'EXPSERCO', cities: 1, status: 'Old', riders: 129, target: 132, performance: 'good', fr: '95.2%', dc: '100.0%' },
            { name: 'Establishment ASHRAF BEN HASSIN BEN ALI BOUGRARDAH For logistics', cities: 1, status: 'Old', riders: 138, target: 130, performance: 'average', fr: '92.1%', dc: '8.4%' },
            { name: 'EXPRESS GATE', cities: 2, status: 'Old', riders: 146, target: 127, performance: 'average', fr: '88.1%', dc: '21.7%' }
        ];

        // Breakdown data for Top 20 partners (city-level details)
        const top20BreakdownDec = {
            'ON Time Logistics': [
                { city: 'Buraydah', status: 'Old', riders: 12, target: 15, performance: 'good', fr: '57.1%', dc: '26.7%' },
                { city: 'Dammam', status: 'Old', riders: 58, target: 55, performance: 'average', fr: '86.9%', dc: '48.7%' },
                { city: 'Jeddah', status: 'Old', riders: 80, target: 47, performance: 'average', fr: '41.0%', dc: '51.4%' },
                { city: 'Riyadh', status: 'Old', riders: 200, target: 180, performance: 'average', fr: '40.8%', dc: '31.0%' }
            ],
            'ONE TRIP': [
                { city: 'Abha', status: 'Old', riders: 44, target: 20, performance: 'good', fr: '82.4%', dc: '57.1%' },
                { city: 'Buraydah', status: 'Old', riders: 40, target: 33, performance: 'good', fr: '88.0%', dc: '88.6%' },
                { city: 'Dammam', status: 'Old', riders: 40, target: 40, performance: 'average', fr: '81.0%', dc: '12.5%' },
                { city: 'Riyadh', status: 'Old', riders: 189, target: 200, performance: 'good', fr: '83.1%', dc: '21.7%' },
                { city: 'Tabuk', status: 'Old', riders: 27, target: 25, performance: 'good', fr: '93.3%', dc: '3.8%' }
            ],
            'PARTNER SUCCESS': [
                { city: 'Jeddah', status: 'Old', riders: 89, target: 90, performance: 'good', fr: '89.2%', dc: '100.0%' },
                { city: 'Riyadh', status: 'Old', riders: 157, target: 165, performance: 'good', fr: '79.4%', dc: '100.0%' }
            ],
            'First Line Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 21, target: 18, performance: 'average', fr: '91.3%', dc: '0.0%' },
                { city: 'Buraydah', status: 'Old', riders: 10, target: 13, performance: 'average', fr: '80.0%', dc: '0.0%' },
                { city: 'Dammam', status: 'Old', riders: 65, target: 60, performance: 'average', fr: '85.3%', dc: '4.5%' },
                { city: 'Jeddah', status: 'Old', riders: 75, target: 92, performance: 'average', fr: '85.0%', dc: '27.9%' },
                { city: 'Makkah', status: 'Old', riders: 37, target: 30, performance: 'average', fr: '91.9%', dc: '0.0%' },
                { city: 'Najran', status: 'Old', riders: 13, target: 15, performance: 'good', fr: '92.3%', dc: '6.3%' },
                { city: 'Riyadh', status: 'Old', riders: 35, target: 40, performance: 'good', fr: '75.6%', dc: '0.0%' },
                { city: 'Yanbu', status: 'Old', riders: 9, target: 10, performance: 'average', fr: '100.0%', dc: '15.4%' }
            ],
            'SDC Logistics': [
                { city: 'Dammam', status: 'Old', riders: 37, target: 30, performance: 'good', fr: '67.4%', dc: '0.0%' },
                { city: 'Riyadh', status: 'Old', riders: 269, target: 235, performance: 'good', fr: '60.5%', dc: '3.7%' }
            ],
            'Anan Capital': [
                { city: 'Al Ahsa', status: 'Old', riders: 29, target: 30, performance: 'good', fr: '83.9%', dc: '60.0%' },
                { city: 'Dammam', status: 'Old', riders: 33, target: 33, performance: 'average', fr: '79.4%', dc: '45.5%' },
                { city: 'Makkah', status: 'Old', riders: 28, target: 30, performance: 'average', fr: '93.5%', dc: '48.3%' },
                { city: 'Riyadh', status: 'Old', riders: 61, target: 90, performance: 'good', fr: '74.3%', dc: '25.9%' }
            ],
            'AL-BARAQ AL-KHATEF': [
                { city: 'Riyadh', status: 'Old', riders: 275, target: 280, performance: 'good', fr: '66.0%', dc: '4.3%' }
            ],
            'Quick Way Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 68, target: 49, performance: 'average', fr: '94.6%', dc: '65.3%' },
                { city: 'Buraydah', status: 'New', riders: 14, target: 17, performance: 'average', fr: '86.7%', dc: '35.3%' },
                { city: 'Dammam', status: 'Old', riders: 50, target: 44, performance: 'average', fr: '79.6%', dc: '24.3%' },
                { city: 'Jubail', status: 'Old', riders: 28, target: 27, performance: 'good', fr: '83.3%', dc: '56.7%' },
                { city: 'Riyadh', status: 'New', riders: 21, target: 40, performance: 'good', fr: '85.7%', dc: '73.7%' }
            ],
            'Makhsos': [
                { city: 'Riyadh', status: 'Old', riders: 171, target: 218, performance: 'good', fr: '75.5%', dc: '87.4%' }
            ],
            'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services': [
                { city: 'Al Kharj', status: 'Old', riders: 100, target: 88, performance: 'good', fr: '79.2%', dc: '18.7%' },
                { city: 'Dammam', status: 'Old', riders: 63, target: 60, performance: 'good', fr: '83.6%', dc: '22.4%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 28, target: 12, performance: 'good', fr: '96.7%', dc: '91.7%' },
                { city: 'Tabuk', status: 'Old', riders: 23, target: 17, performance: 'good', fr: '95.7%', dc: '0.0%' },
                { city: 'Taif', status: 'Old', riders: 14, target: 15, performance: 'good', fr: '93.3%', dc: '7.1%' }
            ],
            'PCC': [
                { city: 'Jeddah', status: 'Old', riders: 88, target: 68, performance: 'good', fr: '80.2%', dc: '1.0%' },
                { city: 'Riyadh', status: 'Old', riders: 112, target: 100, performance: 'good', fr: '46.8%', dc: '6.1%' }
            ],
            'AMC': [
                { city: 'Jeddah', status: 'Old', riders: 123, target: 153, performance: 'good', fr: '94.2%', dc: '17.7%' },
                { city: 'Yanbu', status: 'Old', riders: 41, target: 40, performance: 'good', fr: '84.8%', dc: '0.0%' }
            ],
            'AMIYAL': [
                { city: 'Abha', status: 'Old', riders: 36, target: 25, performance: 'average', fr: '82.5%', dc: '80.0%' },
                { city: 'Jeddah', status: 'Old', riders: 124, target: 125, performance: 'good', fr: '86.0%', dc: '9.2%' },
                { city: 'Makkah', status: 'New', riders: 15, target: 19, performance: 'average', fr: '88.9%', dc: '16.7%' }
            ],
            'FAHAD AL-SHARQ': [
                { city: 'Riyadh', status: 'Old', riders: 145, target: 169, performance: 'good', fr: '48.7%', dc: '9.9%' }
            ],
            'SAKA SRIAA LALCHUDMAT AL-LUGASTIA': [
                { city: 'Abha', status: 'Old', riders: 32, target: 30, performance: 'good', fr: '97.1%', dc: '60.0%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 36, target: 35, performance: 'good', fr: '97.4%', dc: '73.0%' },
                { city: 'Jeddah', status: 'Old', riders: 64, target: 75, performance: 'good', fr: '77.1%', dc: '30.2%' },
                { city: 'Riyadh', status: 'New', riders: 21, target: 35, performance: 'good', fr: '95.8%', dc: '44.4%' }
            ],
            'Holoul': [
                { city: 'Riyadh', status: 'Old', riders: 106, target: 125, performance: 'good', fr: '86.7%', dc: '83.3%' }
            ],
            'Establishment ASHRAF BEN HASSIN BEN ALI BOUGRARDAH For logistics': [
                { city: 'Madinah', status: 'Old', riders: 160, target: 150, performance: 'good', fr: '83.2%', dc: '4.8%' }
            ],
            'EXPRESS GATE': [
                { city: 'Jeddah', status: 'Old', riders: 127, target: 139, performance: 'good', fr: '73.2%', dc: '7.5%' },
                { city: 'Riyadh', status: 'Old', riders: 13, target: 19, performance: 'average', fr: '47.1%', dc: '22.7%' }
            ]
        };

        const top20BreakdownJan = {
            'ON Time Logistics': [
                { city: 'Buraydah', status: 'Old', riders: 14, target: 15, performance: 'average', fr: '100.0%', dc: '46.7%' },
                { city: 'Dammam', status: 'Old', riders: 53, target: 50, performance: 'average', fr: '95.1%', dc: '53.7%' },
                { city: 'Jeddah', status: 'Old', riders: 45, target: 45, performance: 'average', fr: '95.2%', dc: '52.1%' },
                { city: 'Madinah', status: 'Old', riders: 62, target: 65, performance: 'average', fr: '98.8%', dc: '90.8%' },
                { city: 'Riyadh', status: 'Old', riders: 159, target: 150, performance: 'average', fr: '74.9%', dc: '34.0%' }
            ],
            'ONE TRIP': [
                { city: 'Abha', status: 'Old', riders: 20, target: 20, performance: 'good', fr: '96.3%', dc: '57.1%' },
                { city: 'Buraydah', status: 'Old', riders: 33, target: 40, performance: 'good', fr: '97.6%', dc: '88.2%' },
                { city: 'Dammam', status: 'Old', riders: 39, target: 35, performance: 'good', fr: '100.0%', dc: '17.5%' },
                { city: 'Riyadh', status: 'Old', riders: 193, target: 200, performance: 'good', fr: '95.2%', dc: '26.0%' },
                { city: 'Tabuk', status: 'Old', riders: 26, target: 20, performance: 'good', fr: '100.0%', dc: '3.8%' }
            ],
            'PARTNER SUCCESS': [
                { city: 'Jeddah', status: 'Old', riders: 84, target: 92, performance: 'good', fr: '94.5%', dc: '100.0%' },
                { city: 'Riyadh', status: 'Old', riders: 156, target: 165, performance: 'good', fr: '93.5%', dc: '100.0%' }
            ],
            'First Line Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 15, target: 0, performance: 'bad', fr: '95.5%', dc: '0.0%' },
                { city: 'Buraydah', status: 'Old', riders: 12, target: 0, performance: 'average', fr: '100.0%', dc: '0.0%' },
                { city: 'Dammam', status: 'Old', riders: 56, target: 40, performance: 'good', fr: '95.5%', dc: '3.2%' },
                { city: 'Jeddah', status: 'Old', riders: 88, target: 85, performance: 'average', fr: '97.2%', dc: '2.0%' },
                { city: 'Makkah', status: 'Old', riders: 29, target: 15, performance: 'good', fr: '100.0%', dc: '3.2%' },
                { city: 'Madinah', status: 'Old', riders: 10, target: 10, performance: 'good', fr: '90.0%', dc: '84.6%' },
                { city: 'Najran', status: 'Old', riders: 15, target: 15, performance: 'good', fr: '100.0%', dc: '0.0%' },
                { city: 'Riyadh', status: 'Old', riders: 38, target: 40, performance: 'good', fr: '100.0%', dc: '7.5%' },
                { city: 'Yanbu', status: 'Old', riders: 9, target: 10, performance: 'good', fr: '100.0%', dc: '0.0%' }
            ],
            'SDC Logistics': [
                { city: 'Dammam', status: 'Old', riders: 29, target: 25, performance: 'average', fr: '97.3%', dc: '9.4%' },
                { city: 'Riyadh', status: 'Old', riders: 232, target: 185, performance: 'good', fr: '100.0%', dc: '6.3%' }
            ],
            'Anan Capital': [
                { city: 'Al Ahsa', status: 'Old', riders: 28, target: 35, performance: 'average', fr: '100.0%', dc: '62.5%' },
                { city: 'Dammam', status: 'Old', riders: 30, target: 33, performance: 'average', fr: '97.1%', dc: '51.5%' },
                { city: 'Makkah', status: 'Old', riders: 28, target: 25, performance: 'average', fr: '100.0%', dc: '70.0%' },
                { city: 'Madinah', status: 'Old', riders: 21, target: 25, performance: 'good', fr: '100.0%', dc: '54.2%' },
                { city: 'Riyadh', status: 'Old', riders: 76, target: 80, performance: 'good', fr: '96.8%', dc: '37.9%' }
            ],
            'AL-BARAQ AL-KHATEF': [
                { city: 'Riyadh', status: 'Old', riders: 265, target: 195, performance: 'good', fr: '93.7%', dc: '19.3%' }
            ],
            'Quick Way Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 41, target: 50, performance: 'average', fr: '100.0%', dc: '81.6%' },
                { city: 'Buraydah', status: 'New', riders: 16, target: 15, performance: 'average', fr: '100.0%', dc: '52.9%' },
                { city: 'Dammam', status: 'Old', riders: 38, target: 39, performance: 'average', fr: '98.2%', dc: '63.0%' },
                { city: 'Jubail', status: 'Old', riders: 26, target: 32, performance: 'average', fr: '100.0%', dc: '89.3%' },
                { city: 'Riyadh', status: 'New', riders: 33, target: 50, performance: 'average', fr: '100.0%', dc: '87.2%' }
            ],
            'Makhsos': [
                { city: 'Riyadh', status: 'Old', riders: 189, target: 180, performance: 'good', fr: '95.0%', dc: '86.6%' }
            ],
            'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services': [
                { city: 'Al Kharj', status: 'Old', riders: 85, target: 85, performance: 'good', fr: '98.9%', dc: '30.0%' },
                { city: 'Dammam', status: 'Old', riders: 55, target: 54, performance: 'average', fr: '98.4%', dc: '42.4%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 12, target: 13, performance: 'good', fr: '100.0%', dc: '100.0%' },
                { city: 'Tabuk', status: 'Old', riders: 16, target: 17, performance: 'good', fr: '100.0%', dc: '16.7%' },
                { city: 'Taif', status: 'Old', riders: 13, target: 0, performance: 'good', fr: '100.0%', dc: '14.3%' }
            ],
            'PCC': [
                { city: 'Jeddah', status: 'Old', riders: 94, target: 70, performance: 'good', fr: '98.0%', dc: '0.0%' },
                { city: 'Riyadh', status: 'Old', riders: 95, target: 98, performance: 'good', fr: '98.2%', dc: '11.0%' }
            ],
            'AMC': [
                { city: 'Jeddah', status: 'Old', riders: 137, target: 131, performance: 'average', fr: '96.3%', dc: '38.3%' },
                { city: 'Yanbu', status: 'Old', riders: 38, target: 35, performance: 'good', fr: '100.0%', dc: '2.5%' }
            ],
            'AMIYAL': [
                { city: 'Abha', status: 'Old', riders: 24, target: 20, performance: 'average', fr: '96.3%', dc: '95.5%' },
                { city: 'Jeddah', status: 'Old', riders: 116, target: 110, performance: 'good', fr: '93.9%', dc: '15.3%' },
                { city: 'Makkah', status: 'Old', riders: 17, target: 20, performance: 'good', fr: '100.0%', dc: '21.1%' }
            ],
            'FAHAD AL-SHARQ': [
                { city: 'Riyadh', status: 'Old', riders: 151, target: 150, performance: 'good', fr: '91.0%', dc: '12.2%' }
            ],
            'SAKA SRIAA LALCHUDMAT AL-LUGASTIA': [
                { city: 'Abha', status: 'Old', riders: 30, target: 32, performance: 'good', fr: '100.0%', dc: '80.6%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 35, target: 30, performance: 'good', fr: '100.0%', dc: '89.2%' },
                { city: 'Jeddah', status: 'Old', riders: 61, target: 60, performance: 'average', fr: '100.0%', dc: '34.7%' },
                { city: 'Riyadh', status: 'New', riders: 24, target: 27, performance: 'average', fr: '93.5%', dc: '55.2%' }
            ],
            'AL-ANJAZ AL-MATARAA': [
                { city: 'Jeddah', status: 'Old', riders: 91, target: 100, performance: 'good', fr: '99.1%', dc: '52.5%' },
                { city: 'Taif', status: 'Old', riders: 12, target: 28, performance: 'good', fr: '94.7%', dc: '20.0%' },
                { city: 'Yanbu', status: 'Old', riders: 12, target: 13, performance: 'good', fr: '100.0%', dc: '38.5%' }
            ],
            'Holoul': [
                { city: 'Riyadh', status: 'Old', riders: 122, target: 135, performance: 'good', fr: '100.0%', dc: '85.6%' }
            ],
            'EXPSERCO': [
                { city: 'Jeddah', status: 'Old', riders: 129, target: 132, performance: 'good', fr: '95.2%', dc: '100.0%' }
            ],
            'Establishment ASHRAF BEN HASSIN BEN ALI BOUGRARDAH For logistics': [
                { city: 'Madinah', status: 'Old', riders: 138, target: 130, performance: 'average', fr: '92.1%', dc: '8.4%' }
            ],
            'EXPRESS GATE': [
                { city: 'Jeddah', status: 'Old', riders: 126, target: 112, performance: 'average', fr: '85.7%', dc: '14.3%' },
                { city: 'Riyadh', status: 'Old', riders: 20, target: 15, performance: 'good', fr: '90.5%', dc: '29.2%' }
            ]
        };

        // Top 20 Ranked Partners (by highest city coverage) - Feb only
        const rankedFeb = [
            { name: 'First Line Logistics', cities: 9, status: 'Old', riders: 272, target: 215, performance: 'average', fr: '97.6%', dc: '11.2%' },
            { name: 'NAJIZ', cities: 5, status: 'Old', riders: 117, target: 51, performance: 'good', fr: '96.0%', dc: '22.5%' },
            { name: 'ONE TRIP', cities: 5, status: 'Old', riders: 311, target: 315, performance: 'good', fr: '97.8%', dc: '38.5%' },
            { name: 'Next Mile', cities: 5, status: 'Old', riders: 131, target: 121, performance: 'average', fr: '98.5%', dc: '14.8%' },
            { name: 'Anan Capital', cities: 5, status: 'Old', riders: 184, target: 198, performance: 'good', fr: '98.8%', dc: '55.2%' },
            { name: 'Quick Way Logistics', cities: 5, status: 'Old', riders: 155, target: 186, performance: 'average', fr: '99.6%', dc: '74.8%' },
            { name: 'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services', cities: 5, status: 'Old', riders: 182, target: 169, performance: 'good', fr: '99.5%', dc: '40.7%' },
            { name: 'ON Time Logistics', cities: 5, status: 'Old', riders: 332, target: 325, performance: 'average', fr: '92.8%', dc: '55.4%' },
            { name: 'Aibtukir', cities: 5, status: 'Old', riders: 113, target: 72, performance: 'good', fr: '94.4%', dc: '21.7%' },
            { name: 'services delivery', cities: 4, status: 'Old', riders: 142, target: 122, performance: 'good', fr: '98.9%', dc: '23.3%' },
            { name: 'SAKA SRIAA LALCHUDMAT AL-LUGASTIA', cities: 4, status: 'Old', riders: 149, target: 149, performance: 'average', fr: '98.4%', dc: '64.9%' },
            { name: 'TEM AL-TOUSSIL', cities: 4, status: 'Old', riders: 111, target: 109, performance: 'average', fr: '89.8%', dc: '46.4%' },
            { name: 'Sama Golden logistics', cities: 4, status: 'Old', riders: 60, target: 70, performance: 'average', fr: '96.5%', dc: '36.4%' },
            { name: 'AMIYAL', cities: 3, status: 'Old', riders: 157, target: 150, performance: 'good', fr: '96.7%', dc: '43.9%' },
            { name: 'WABM Logistics', cities: 3, status: 'Old', riders: 44, target: 66, performance: 'average', fr: '66.7%', dc: '66.7%' },
            { name: 'Tomorrow\'s Falcons Company', cities: 3, status: 'Old', riders: 78, target: 65, performance: 'good', fr: '94.0%', dc: '0.0%' },
            { name: 'Saudi falcon for logistics', cities: 3, status: 'Old', riders: 62, target: 43, performance: 'average', fr: '97.9%', dc: '2.0%' },
            { name: 'HERVEY AL-WAHHA', cities: 3, status: 'Old', riders: 71, target: 80, performance: 'average', fr: '98.8%', dc: '11.2%' },
            { name: 'SHAFAQ AL-KHAYR', cities: 3, status: 'Old', riders: 83, target: 75, performance: 'average', fr: '100.0%', dc: '37.1%' },
            { name: 'Ettijahat', cities: 3, status: 'Old', riders: 64, target: 54, performance: 'good', fr: '96.1%', dc: '14.3%' }
        ];

        // Breakdown data for Top 20 Ranked partners (city-level details) - Feb only
        const rankedBreakdownFeb = {
            'First Line Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 15, target: 0, performance: 'bad', fr: '95.5%', dc: '0.0%' },
                { city: 'Buraydah', status: 'Old', riders: 12, target: 0, performance: 'average', fr: '100.0%', dc: '0.0%' },
                { city: 'Dammam', status: 'Old', riders: 56, target: 40, performance: 'good', fr: '95.5%', dc: '3.2%' },
                { city: 'Jeddah', status: 'Old', riders: 88, target: 85, performance: 'average', fr: '97.2%', dc: '2.0%' },
                { city: 'Makkah', status: 'Old', riders: 29, target: 15, performance: 'good', fr: '100.0%', dc: '3.2%' },
                { city: 'Madinah', status: 'Old', riders: 10, target: 10, performance: 'good', fr: '90.0%', dc: '84.6%' },
                { city: 'Najran', status: 'Old', riders: 15, target: 15, performance: 'good', fr: '100.0%', dc: '0.0%' },
                { city: 'Riyadh', status: 'Old', riders: 38, target: 40, performance: 'good', fr: '100.0%', dc: '7.5%' },
                { city: 'Yanbu', status: 'Old', riders: 9, target: 10, performance: 'good', fr: '100.0%', dc: '0.0%' }
            ],
            'NAJIZ': [
                { city: 'Abha', status: 'Old', riders: 10, target: 0, performance: 'average', fr: '94.1%', dc: '18.2%' },
                { city: 'Hafar Al Batin', status: 'New', riders: 10, target: 10, performance: 'average', fr: '95.2%', dc: '91.7%' },
                { city: 'Hail', status: 'Old', riders: 36, target: 41, performance: 'good', fr: '96.2%', dc: '2.7%' },
                { city: 'Makkah', status: 'Old', riders: 27, target: 0, performance: 'average', fr: '100.0%', dc: '0.0%' },
                { city: 'Taif', status: 'Old', riders: 35, target: 0, performance: 'average', fr: '94.7%', dc: '0.0%' }
            ],
            'ONE TRIP': [
                { city: 'Abha', status: 'Old', riders: 20, target: 20, performance: 'good', fr: '96.3%', dc: '57.1%' },
                { city: 'Buraydah', status: 'Old', riders: 33, target: 40, performance: 'good', fr: '97.6%', dc: '88.2%' },
                { city: 'Dammam', status: 'Old', riders: 39, target: 35, performance: 'good', fr: '100.0%', dc: '17.5%' },
                { city: 'Riyadh', status: 'Old', riders: 193, target: 200, performance: 'good', fr: '95.2%', dc: '26.0%' },
                { city: 'Tabuk', status: 'Old', riders: 26, target: 20, performance: 'good', fr: '100.0%', dc: '3.8%' }
            ],
            'Next Mile': [
                { city: 'Al Ahsa', status: 'Old', riders: 25, target: 28, performance: 'good', fr: '100.0%', dc: '4.2%' },
                { city: 'Dammam', status: 'New', riders: 29, target: 24, performance: 'good', fr: '100.0%', dc: '8.3%' },
                { city: 'Jeddah', status: 'Old', riders: 32, target: 20, performance: 'average', fr: '94.7%', dc: '0.0%' },
                { city: 'Madinah', status: 'Old', riders: 10, target: 0, performance: 'average', fr: '100.0%', dc: '10.0%' },
                { city: 'Riyadh', status: 'Old', riders: 36, target: 49, performance: 'average', fr: '97.6%', dc: '51.4%' }
            ],
            'Anan Capital': [
                { city: 'Al Ahsa', status: 'Old', riders: 28, target: 35, performance: 'average', fr: '100.0%', dc: '62.5%' },
                { city: 'Dammam', status: 'Old', riders: 30, target: 33, performance: 'average', fr: '97.1%', dc: '51.5%' },
                { city: 'Makkah', status: 'Old', riders: 28, target: 25, performance: 'average', fr: '100.0%', dc: '70.0%' },
                { city: 'Madinah', status: 'Old', riders: 21, target: 25, performance: 'good', fr: '100.0%', dc: '54.2%' },
                { city: 'Riyadh', status: 'Old', riders: 76, target: 80, performance: 'good', fr: '96.8%', dc: '37.9%' }
            ],
            'Quick Way Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 41, target: 50, performance: 'average', fr: '100.0%', dc: '81.6%' },
                { city: 'Buraydah', status: 'New', riders: 16, target: 15, performance: 'average', fr: '100.0%', dc: '52.9%' },
                { city: 'Dammam', status: 'Old', riders: 38, target: 39, performance: 'average', fr: '98.2%', dc: '63.0%' },
                { city: 'Jubail', status: 'Old', riders: 26, target: 32, performance: 'average', fr: '100.0%', dc: '89.3%' },
                { city: 'Riyadh', status: 'New', riders: 33, target: 50, performance: 'average', fr: '100.0%', dc: '87.2%' }
            ],
            'Abdul Aziz Muhammmad bin Hassan Asiri for Logistics Services': [
                { city: 'Al Kharj', status: 'Old', riders: 85, target: 85, performance: 'good', fr: '98.9%', dc: '30.0%' },
                { city: 'Dammam', status: 'Old', riders: 55, target: 54, performance: 'average', fr: '98.4%', dc: '42.4%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 12, target: 13, performance: 'good', fr: '100.0%', dc: '100.0%' },
                { city: 'Tabuk', status: 'Old', riders: 16, target: 17, performance: 'good', fr: '100.0%', dc: '16.7%' },
                { city: 'Taif', status: 'Old', riders: 13, target: 0, performance: 'good', fr: '100.0%', dc: '14.3%' }
            ],
            'ON Time Logistics': [
                { city: 'Buraydah', status: 'Old', riders: 14, target: 15, performance: 'average', fr: '100.0%', dc: '46.7%' },
                { city: 'Dammam', status: 'Old', riders: 53, target: 50, performance: 'average', fr: '95.1%', dc: '53.7%' },
                { city: 'Jeddah', status: 'Old', riders: 45, target: 45, performance: 'average', fr: '95.2%', dc: '52.1%' },
                { city: 'Madinah', status: 'Old', riders: 62, target: 65, performance: 'average', fr: '98.8%', dc: '90.8%' },
                { city: 'Riyadh', status: 'Old', riders: 159, target: 150, performance: 'average', fr: '74.9%', dc: '34.0%' }
            ],
            'Aibtukir': [
                { city: 'Dammam', status: 'Old', riders: 16, target: 0, performance: 'bad', fr: '100.0%', dc: '0.0%' },
                { city: 'Jeddah', status: 'Old', riders: 37, target: 25, performance: 'good', fr: '100.0%', dc: '3.2%' },
                { city: 'Makkah', status: 'Old', riders: 13, target: 10, performance: 'average', fr: '100.0%', dc: '0.0%' },
                { city: 'Madinah', status: 'New', riders: 10, target: 12, performance: 'good', fr: '78.6%', dc: '100.0%' },
                { city: 'Riyadh', status: 'Old', riders: 36, target: 25, performance: 'good', fr: '93.2%', dc: '5.3%' }
            ],
            'services delivery': [
                { city: 'Abha', status: 'Old', riders: 20, target: 20, performance: 'good', fr: '100.0%', dc: '72.7%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 9, target: 10, performance: 'good', fr: '100.0%', dc: '10.0%' },
                { city: 'Jubail', status: 'Old', riders: 50, target: 42, performance: 'good', fr: '98.4%', dc: '5.8%' },
                { city: 'Riyadh', status: 'Old', riders: 62, target: 50, performance: 'good', fr: '97.1%', dc: '4.6%' }
            ],
            'SAKA SRIAA LALCHUDMAT AL-LUGASTIA': [
                { city: 'Abha', status: 'Old', riders: 30, target: 32, performance: 'good', fr: '100.0%', dc: '80.6%' },
                { city: 'Hafar Al Batin', status: 'Old', riders: 35, target: 30, performance: 'good', fr: '100.0%', dc: '89.2%' },
                { city: 'Jeddah', status: 'Old', riders: 61, target: 60, performance: 'average', fr: '100.0%', dc: '34.7%' },
                { city: 'Riyadh', status: 'New', riders: 24, target: 27, performance: 'average', fr: '93.5%', dc: '55.2%' }
            ],
            'TEM AL-TOUSSIL': [
                { city: 'Buraydah', status: 'Old', riders: 26, target: 25, performance: 'good', fr: '100.0%', dc: '29.6%' },
                { city: 'Madinah', status: 'Old', riders: 44, target: 48, performance: 'average', fr: '94.0%', dc: '40.4%' },
                { city: 'Riyadh', status: 'New', riders: 25, target: 18, performance: 'good', fr: '65.4%', dc: '72.0%' },
                { city: 'Tabuk', status: 'Old', riders: 16, target: 18, performance: 'good', fr: '100.0%', dc: '43.8%' }
            ],
            'Sama Golden logistics': [
                { city: 'Jeddah', status: 'Old', riders: 23, target: 33, performance: 'average', fr: '95.7%', dc: '25.0%' },
                { city: 'Madinah', status: 'Old', riders: 9, target: 10, performance: 'good', fr: '100.0%', dc: '13.3%' },
                { city: 'Riyadh', status: 'Old', riders: 20, target: 27, performance: 'average', fr: '90.2%', dc: '96.2%' },
                { city: 'Yanbu', status: 'Old', riders: 8, target: 0, performance: 'average', fr: '100.0%', dc: '11.1%' }
            ],
            'AMIYAL': [
                { city: 'Abha', status: 'Old', riders: 24, target: 20, performance: 'average', fr: '96.3%', dc: '95.5%' },
                { city: 'Jeddah', status: 'Old', riders: 116, target: 110, performance: 'good', fr: '93.9%', dc: '15.3%' },
                { city: 'Makkah', status: 'Old', riders: 17, target: 20, performance: 'good', fr: '100.0%', dc: '21.1%' }
            ],
            'WABM Logistics': [
                { city: 'Al Ahsa', status: 'Old', riders: 16, target: 11, performance: 'good', fr: '100.0%', dc: '100.0%' },
                { city: 'Dammam', status: 'Old', riders: 29, target: 30, performance: 'average', fr: '100.0%', dc: '100.0%' },
                { city: 'Riyadh', status: 'New', riders: 0, target: 25, performance: '-', fr: '0.0%', dc: '0.0%' }
            ],
            'Tomorrow\'s Falcons Company': [
                { city: 'Buraydah', status: 'Old', riders: 26, target: 24, performance: 'good', fr: '100.0%', dc: '0.0%' },
                { city: 'Jubail', status: 'Old', riders: 34, target: 26, performance: 'good', fr: '100.0%', dc: '0.0%' },
                { city: 'Riyadh', status: 'New', riders: 17, target: 15, performance: 'average', fr: '82.1%', dc: '0.0%' }
            ],
            'Saudi falcon for logistics': [
                { city: 'Dammam', status: 'Old', riders: 17, target: 0, performance: 'average', fr: '95.7%', dc: '5.9%' },
                { city: 'Madinah', status: 'New', riders: 14, target: 13, performance: 'good', fr: '100.0%', dc: '0.0%' },
                { city: 'Riyadh', status: 'Old', riders: 31, target: 30, performance: 'average', fr: '98.0%', dc: '0.0%' }
            ],
            'HERVEY AL-WAHHA': [
                { city: 'Dammam', status: 'Old', riders: 31, target: 31, performance: 'average', fr: '100.0%', dc: '6.3%' },
                { city: 'Jubail', status: 'Old', riders: 21, target: 26, performance: 'good', fr: '100.0%', dc: '8.7%' },
                { city: 'Riyadh', status: 'New', riders: 20, target: 23, performance: 'average', fr: '96.3%', dc: '18.5%' }
            ],
            'SHAFAQ AL-KHAYR': [
                { city: 'Dammam', status: 'New', riders: 28, target: 28, performance: 'average', fr: '100.0%', dc: '41.9%' },
                { city: 'Jazan', status: 'Old', riders: 12, target: 0, performance: 'good', fr: '100.0%', dc: '50.0%' },
                { city: 'Madinah', status: 'Old', riders: 44, target: 47, performance: 'average', fr: '100.0%', dc: '19.3%' }
            ],
            'Ettijahat': [
                { city: 'Jeddah', status: 'Old', riders: 43, target: 42, performance: 'good', fr: '96.0%', dc: '2.1%' },
                { city: 'Makkah', status: 'Old', riders: 9, target: 0, performance: 'average', fr: '100.0%', dc: '10.0%' },
                { city: 'Taif', status: 'Old', riders: 12, target: 12, performance: 'good', fr: '92.3%', dc: '30.8%' }
            ]
        };

        const bottomDec = [
            { name: 'Afkar Logistics', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Tadarak Logistics', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'QAWAFIL AL-NAKHABA', cities: 1, status: 'Old', riders: 10, target: 10, performance: 'average', fr: '90.9%', dc: '10.0%' },
            { name: 'ZikraSabiti', cities: 1, status: 'New', riders: null, target: 10, performance: '-', fr: '-', dc: '100.0%' },
            { name: 'STUL AL-MATIAZ', cities: 1, status: 'Old', riders: 16, target: 10, performance: 'good', fr: '100.0%', dc: '0.0%' },
            { name: 'NAS', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'AL-ALAMIN KOM', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'alshuhna almumayaza', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'MUSTER FLE', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Aqbal Logistics', cities: 1, status: 'Old', riders: 12, target: 10, performance: 'average', fr: '71.4%', dc: '36.4%' },
            { name: 'RADHI ABDULSAMEA', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'AL-TUQDAM AL-MASI', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'almasarat althnaiya', cities: 1, status: 'Old', riders: 14, target: 10, performance: 'average', fr: '75.0%', dc: '0.0%' },
            { name: 'Selsala', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'ashara khutut', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Al Nsoor (Eagle Logistics)', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'LEO Delivery', cities: 1, status: 'Old', riders: 13, target: 10, performance: 'good', fr: '93.8%', dc: '7.1%' },
            { name: 'Swiftlane', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Alkhutut Almudhia', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' },
            { name: 'Rakb Tayba', cities: '-', status: '-', riders: '-', target: '-', performance: '-', fr: '-', dc: '-' }
        ];

        const bottomJan = [
            { name: 'Afkar Logistics', cities: 1, status: 'New', riders: null, target: 10, performance: '-', fr: '0.0%', dc: '0.0%' },
            { name: 'Tadarak Logistics', cities: 1, status: 'Old', riders: null, target: 10, performance: 'average', fr: '100.0%', dc: '100.0%' },
            { name: 'QAWAFIL AL-NAKHABA', cities: 1, status: 'Old', riders: 9, target: 10, performance: 'average', fr: '100.0%', dc: '30.0%' },
            { name: 'ZikraSabiti', cities: 1, status: 'New', riders: 10, target: 10, performance: 'good', fr: '100.0%', dc: '100.0%' },
            { name: 'STUL AL-MATIAZ', cities: 1, status: 'Old', riders: 11, target: 10, performance: 'good', fr: '100.0%', dc: '0.0%' },
            { name: 'NAS', cities: 2, status: 'Old', riders: 11, target: 10, performance: 'average', fr: '83.3%', dc: '6.3%' },
            { name: 'AL-ALAMIN KOM', cities: 1, status: 'New', riders: 16, target: 10, performance: 'average', fr: '78.3%', dc: '100.0%' },
            { name: 'alshuhna almumayaza', cities: 1, status: 'New', riders: 17, target: 10, performance: 'average', fr: '100.0%', dc: '42.1%' },
            { name: 'MUSTER FLE', cities: 1, status: 'Old', riders: 19, target: 10, performance: 'average', fr: '73.0%', dc: '96.8%' },
            { name: 'Aqbal Logistics', cities: 1, status: 'Old', riders: 10, target: 10, performance: 'average', fr: '100.0%', dc: '30.0%' },
            { name: 'RADHI ABDULSAMEA', cities: 1, status: 'New', riders: 6, target: 10, performance: 'bad', fr: '87.5%', dc: '40.9%' },
            { name: 'AL-TUQDAM AL-MASI', cities: 1, status: 'Old', riders: 8, target: 10, performance: 'average', fr: '100.0%', dc: '62.5%' },
            { name: 'almasarat althnaiya', cities: 1, status: 'Old', riders: 9, target: 10, performance: 'average', fr: '100.0%', dc: '30.8%' },
            { name: 'Selsala', cities: 1, status: 'New', riders: 9, target: 10, performance: 'good', fr: '100.0%', dc: '100.0%' },
            { name: 'ashara khutut', cities: 1, status: 'New', riders: 10, target: 10, performance: 'good', fr: '100.0%', dc: '45.5%' },
            { name: 'Al Nsoor (Eagle Logistics)', cities: 1, status: 'Old', riders: null, target: 10, performance: 'bad', fr: '0.0%', dc: '100.0%' },
            { name: 'LEO Delivery', cities: 1, status: 'Old', riders: 12, target: 10, performance: 'average', fr: '100.0%', dc: '58.8%' },
            { name: 'Swiftlane', cities: 1, status: 'Old', riders: 12, target: 10, performance: 'average', fr: '100.0%', dc: '7.7%' },
            { name: 'Alkhutut Almudhia', cities: 1, status: 'Old', riders: 14, target: 10, performance: 'average', fr: '100.0%', dc: '10.0%' },
            { name: 'Rakb Tayba', cities: 1, status: 'Old', riders: 15, target: 10, performance: 'average', fr: '100.0%', dc: '10.0%' }
        ];

        // Register all partner brand names as proper nouns (never translate)
        if (window.dashboardAddProperNouns) {
            var _allPartnerNames = [
                ...topDec, ...topJan, ...bottomDec, ...bottomJan, ...rankedFeb
            ].map(function(r) { return r.name; }).filter(Boolean);
            window.dashboardAddProperNouns(_allPartnerNames);
        }

        const normalizeName = (name) => name.trim().toLowerCase();
        const mapByName = (rows) => {
            const map = new Map();
            rows.forEach(row => map.set(normalizeName(row.name), row));
            return map;
        };

        const momColor = (mom) => {
            const val = parseFloat(mom);
            if (val > 0) return '#16a34a';
            if (val < 0) return '#dc2626';
            return '#f59e0b';
        };

        const formatDual = (decVal, janVal) => {
            const decText = decVal === null || decVal === undefined || decVal === '' ? '-' : decVal;
            const janText = janVal === null || janVal === undefined || janVal === '' ? '-' : janVal;
            return `
                <div style="font-size: 12px; color: #6b7280;">Dec: <strong style="color:#111827;">${decText}</strong></div>
                <div style="font-size: 12px; color: #6b7280;">Jan: <strong style="color:#111827;">${janText}</strong></div>
            `;
        };

        const formatNumber = (val) => (val === null || val === undefined || val === '' || val === '-') ? '-' : Number(val).toLocaleString();

        // Color coding for FR% and Driver Card%
        // FR%: Green >= 80%, Yellow 50-79%, Red < 50%
        // Driver Card%: Green >= 50%, Yellow 20-49%, Red < 20%
        const getFRColor = (val) => {
            if (val === '-' || val === null || val === undefined || val === '') return '#6b7280';
            const num = parseFloat(val);
            if (isNaN(num)) return '#6b7280';
            if (num >= 80) return '#16a34a';
            if (num >= 50) return '#f59e0b';
            return '#dc2626';
        };

        const getDCColor = (val) => {
            if (val === '-' || val === null || val === undefined || val === '') return '#6b7280';
            const num = parseFloat(val);
            if (isNaN(num)) return '#6b7280';
            if (num >= 50) return '#16a34a';
            if (num >= 20) return '#f59e0b';
            return '#dc2626';
        };

        const formatVal = (val) => (val === null || val === undefined || val === '' || val === '-') ? '-' : val;

        const getPerformanceBadge = (val) => {
            const perf = (val || '').toString().toLowerCase();
            if (perf === 'good') {
                return '<span style="display: inline-block; padding: 2px 8px; border-radius: 999px; background: #dcfce7; color: #166534; font-weight: 700; font-size: 11px;">good</span>';
            }
            if (perf === 'average') {
                return '<span style="display: inline-block; padding: 2px 8px; border-radius: 999px; background: #fef3c7; color: #92400e; font-weight: 700; font-size: 11px;">average</span>';
            }
            if (perf === 'bad') {
                return '<span style="display: inline-block; padding: 2px 8px; border-radius: 999px; background: #fee2e2; color: #991b1b; font-weight: 700; font-size: 11px;">bad</span>';
            }
            return '<span style="color: #6b7280;">-</span>';
        };

        const getNewOldBadge = (val) => {
            const status = (val || '').toString().toLowerCase();
            if (status === 'new') {
                return '<span style="display: inline-block; padding: 2px 8px; border-radius: 999px; background: #dcfce7; color: #166534; font-weight: 700; font-size: 11px;">new</span>';
            }
            if (status === 'old') {
                return '<span style="display: inline-block; padding: 2px 8px; border-radius: 999px; background: #e2e8f0; color: #334155; font-weight: 700; font-size: 11px;">old</span>';
            }
            return '<span style="color: #6b7280;">-</span>';
        };

        // Track expanded state for each partner
        const expandedPartners = new Set();

        function togglePartnerBreakdown(partnerName) {
            if (expandedPartners.has(partnerName)) {
                expandedPartners.delete(partnerName);
            } else {
                expandedPartners.clear();
                expandedPartners.add(partnerName);
            }
            renderPartnersOverview(currentPartnersView);
        }

        let currentPartnersView = 'top';

        function renderPartnersOverview(view) {
            currentPartnersView = view;
            const body = document.getElementById('partnersOverviewTableBody');
            const thead = document.getElementById('partnersOverviewTableHead');
            const table = document.getElementById('partnersOverviewTable');
            const noteDiv = document.getElementById('partnersOverviewNote');
            if (!body || !thead) return;

            // Update table header based on view
            if (view === 'ranked') {
                table.style.minWidth = '900px';
                thead.innerHTML = `
                    <tr style="background: #0ea5e9; color: white;">
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; min-width: 40px;">#</th>
                        <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db; min-width: 200px;">Partner</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;"># of cities</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">New/Old</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Delivery riders</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Total target</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Performance</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Avg FR %</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db;">Avg Driver Card %</th>
                    </tr>
                `;
            } else {
                table.style.minWidth = '1200px';
                thead.innerHTML = `
                    <tr style="background: #0ea5e9; color: white;">
                        <th rowspan="2" style="padding: 10px; text-align: center; border: 1px solid #d1d5db; min-width: 40px; vertical-align: middle;">#</th>
                        <th rowspan="2" style="padding: 10px; text-align: left; border: 1px solid #d1d5db; min-width: 200px; vertical-align: middle;">Partner</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;"># of cities</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">New/Old</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Delivery riders</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Total target</th>
                        <th rowspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db; vertical-align: middle;">MoM %<br>(Target)</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Performance</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Avg FR %</th>
                        <th colspan="2" style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">Avg Driver Card %</th>
                    </tr>
                    <tr style="background: #0284c7; color: white;">
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Jan</th>
                        <th style="padding: 6px 8px; text-align: center; border: 1px solid #d1d5db; font-size: 11px;">Feb</th>
                    </tr>
                `;
            }

            // Update note
            if (noteDiv) {
                if (view === 'ranked') {
                    noteDiv.querySelector('p').innerHTML = '<strong>\ud83d\udccb Note:</strong> Top 20 partners ranked by highest city coverage across the Kingdom (Feb only). Shows partners with the widest geographic reach. Performance, FR & Driver Card rates are averaged across all covered cities.';
                } else {
                    noteDiv.querySelector('p').innerHTML = '<strong>\ud83d\udccb Note:</strong> Table compares Jan vs Feb per partner. MoM% shown for Total Target only. Total target reflects riders across all covered cities. Performance is based on highest-target city. FR & Driver Card rates are averaged across cities.';
                }
            }

            // Handle ranked view (Feb-only, single columns)
            if (view === 'ranked') {
                body.innerHTML = '';
                rankedFeb.forEach((partner, idx) => {
                    const hasBreakdown = rankedBreakdownFeb[partner.name];
                    const isExpanded = expandedPartners.has(partner.name);
                    const focusActive = expandedPartners.size > 0;
                    const isFocused = expandedPartners.has(partner.name);

                    const row = document.createElement('tr');
                    row.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                    row.style.cursor = hasBreakdown ? 'pointer' : 'default';
                    row.setAttribute('data-partner', partner.name);
                    if (focusActive && !isFocused) row.classList.add('blurred-row');

                    let partnerNameHtml = '';
                    if (hasBreakdown) {
                        const arrow = isExpanded ? '\u25BC' : '\u25B6';
                        partnerNameHtml = `<span style="color: #0ea5e9; margin-right: 8px; font-size: 12px;">${arrow}</span><span style="font-weight: 600;">${partner.name}</span>`;
                    } else {
                        partnerNameHtml = `<span style="font-weight: 600; margin-left: 20px;">${partner.name}</span>`;
                    }

                    row.innerHTML = `
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 12px;">${idx + 1}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">${partnerNameHtml}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatVal(partner.cities)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(partner.status)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(partner.riders)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(partner.target)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center;">${getPerformanceBadge(partner.performance)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getFRColor(partner.fr)};">${formatVal(partner.fr)}</td>
                        <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getDCColor(partner.dc)};">${formatVal(partner.dc)}</td>
                    `;

                    if (hasBreakdown) {
                        row.onclick = () => togglePartnerBreakdown(partner.name);
                    }
                    body.appendChild(row);

                    // Render breakdown rows if expanded
                    if (hasBreakdown && isExpanded) {
                        const breakdown = rankedBreakdownFeb[partner.name] || [];
                        breakdown.forEach((cityData, cityIdx) => {
                            const breakdownRow = document.createElement('tr');
                            breakdownRow.style.background = '#f0f9ff';
                            breakdownRow.style.borderLeft = '4px solid #0ea5e9';
                            breakdownRow.setAttribute('data-partner', partner.name);
                            if (focusActive && !isFocused) breakdownRow.classList.add('blurred-row');

                            breakdownRow.innerHTML = `
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280;">${cityIdx + 1}</td>
                                <td style="padding: 6px 10px 6px 36px; border: 1px solid #e5e7eb; font-size: 12px; color: #0369a1;">
                                    <span style="color: #94a3b8;">\u21b3</span> ${cityData.city}
                                </td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280;">1</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(cityData.status)}</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(cityData.riders)}</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(cityData.target)}</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getPerformanceBadge(cityData.performance)}</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getFRColor(cityData.fr)};">${formatVal(cityData.fr)}</td>
                                <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getDCColor(cityData.dc)};">${formatVal(cityData.dc)}</td>
                            `;
                            body.appendChild(breakdownRow);
                        });
                    }
                });
                return;
            }

            // Handle top/bottom views (dual Jan/Feb columns)
            const decRows = view === 'top' ? topDec : bottomDec;
            const janRows = view === 'top' ? topJan : bottomJan;

            const decMap = mapByName(decRows);
            const janMap = mapByName(janRows);

            const names = Array.from(new Set([...decRows, ...janRows].map(r => normalizeName(r.name))));
            const nameLookup = new Map();
            [...decRows, ...janRows].forEach(r => nameLookup.set(normalizeName(r.name), r.name));

            body.innerHTML = '';

            const calcMoMPercent = (janVal, febVal) => {
                const hasJan = janVal !== null && janVal !== undefined && janVal !== '-';
                const hasFeb = febVal !== null && febVal !== undefined && febVal !== '-';

                if (!hasJan && !hasFeb) return null;
                if (!hasJan && hasFeb) return '100.0';
                if (hasJan && !hasFeb) return '-100.0';

                const janNum = Number(janVal);
                const febNum = Number(febVal);
                if (!Number.isFinite(janNum) || !Number.isFinite(febNum)) return null;

                if (janNum === 0) {
                    if (febNum === 0) return '0.0';
                    return '100.0';
                }

                return (((febNum - janNum) / janNum) * 100).toFixed(1);
            };

            names.forEach((key, idx) => {
                const dec = decMap.get(key);
                const jan = janMap.get(key);
                const partnerName = nameLookup.get(key) || '-';

                const focusActive = expandedPartners.size > 0;
                const isFocused = expandedPartners.has(partnerName);

                const decTarget = dec ? dec.target : null;
                const janTarget = jan ? jan.target : null;
                const mom = calcMoMPercent(decTarget, janTarget);
                const momText = mom === null ? '-' : `${mom}%`;

                // Check if this partner has breakdown data (only for Top 20)
                const hasBreakdown = view === 'top' && (top20BreakdownDec[partnerName] || top20BreakdownJan[partnerName]);
                const isExpanded = expandedPartners.has(partnerName);

                const row = document.createElement('tr');
                row.style.background = idx % 2 === 0 ? '#ffffff' : '#f9fafb';
                row.style.cursor = hasBreakdown ? 'pointer' : 'default';
                row.setAttribute('data-partner', partnerName);
                if (focusActive && !isFocused) {
                    row.classList.add('blurred-row');
                }
                
                // Partner name with expand/collapse arrow
                let partnerNameHtml = '';
                if (hasBreakdown) {
                    const arrow = isExpanded ? '▼' : '▶';
                    partnerNameHtml = `<span style="color: #0ea5e9; margin-right: 8px; font-size: 12px;">${arrow}</span><span style="font-weight: 600;">${partnerName}</span>`;
                } else {
                    partnerNameHtml = `<span style="font-weight: 600; margin-left: 20px;">${partnerName}</span>`;
                }

                // Get FR and DC values
                const decFR = dec ? dec.fr : '-';
                const janFR = jan ? jan.fr : '-';
                const decDC = dec ? dec.dc : '-';
                const janDC = jan ? jan.dc : '-';

                row.innerHTML = `
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 12px;">${idx + 1}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb;">${partnerNameHtml}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatVal(dec ? dec.cities : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatVal(jan ? jan.cities : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(dec ? dec.status : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(jan ? jan.status : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(dec ? dec.riders : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(jan ? jan.riders : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(dec ? dec.target : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(jan ? jan.target : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 700; font-size: 12px; color: ${mom === null ? '#6b7280' : momColor(mom)};">${momText}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center;">${getPerformanceBadge(dec ? dec.performance : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center;">${getPerformanceBadge(jan ? jan.performance : '-')}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getFRColor(decFR)};">${formatVal(decFR)}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getFRColor(janFR)};">${formatVal(janFR)}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getDCColor(decDC)};">${formatVal(decDC)}</td>
                    <td style="padding: 8px 10px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; font-size: 12px; color: ${getDCColor(janDC)};">${formatVal(janDC)}</td>
                `;
                
                if (hasBreakdown) {
                    row.onclick = () => togglePartnerBreakdown(partnerName);
                }
                
                body.appendChild(row);

                // Render breakdown rows if expanded (only for Top 20)
                if (hasBreakdown && isExpanded) {
                    const decBreakdown = top20BreakdownDec[partnerName] || [];
                    const janBreakdown = top20BreakdownJan[partnerName] || [];

                    // Create map for breakdown by city
                    const decCityMap = new Map();
                    decBreakdown.forEach(c => decCityMap.set(c.city, c));
                    const janCityMap = new Map();
                    janBreakdown.forEach(c => janCityMap.set(c.city, c));

                    // Get all unique cities
                    const allCities = Array.from(new Set([
                        ...decBreakdown.map(c => c.city),
                        ...janBreakdown.map(c => c.city)
                    ]));

                    allCities.forEach((city, cityIdx) => {
                        const decCity = decCityMap.get(city);
                        const janCity = janCityMap.get(city);

                        const decCityTarget = decCity ? decCity.target : null;
                        const janCityTarget = janCity ? janCity.target : null;
                        const cityMom = calcMoMPercent(decCityTarget, janCityTarget);
                        const cityMomText = cityMom === null ? '-' : `${cityMom}%`;

                        // Get FR and DC values for city
                        const decCityFR = decCity ? decCity.fr : '-';
                        const janCityFR = janCity ? janCity.fr : '-';
                        const decCityDC = decCity ? decCity.dc : '-';
                        const janCityDC = janCity ? janCity.dc : '-';

                        const breakdownRow = document.createElement('tr');
                        breakdownRow.style.background = '#f0f9ff';
                        breakdownRow.style.borderLeft = '4px solid #0ea5e9';
                        breakdownRow.setAttribute('data-partner', partnerName);
                        if (focusActive && !isFocused) {
                            breakdownRow.classList.add('blurred-row');
                        }
                        
                        breakdownRow.innerHTML = `
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280;">${cityIdx + 1}</td>
                            <td style="padding: 6px 10px 6px 36px; border: 1px solid #e5e7eb; font-size: 12px; color: #0369a1;">
                                <span style="color: #94a3b8;">↳</span> ${city}
                            </td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280;">1</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280;">1</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(decCity ? decCity.status : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getNewOldBadge(janCity ? janCity.status : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(decCity ? decCity.riders : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(janCity ? janCity.riders : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(decCity ? decCity.target : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${formatNumber(janCity ? janCity.target : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${cityMom === null ? '#6b7280' : momColor(cityMom)};">${cityMomText}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getPerformanceBadge(decCity ? decCity.performance : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px;">${getPerformanceBadge(janCity ? janCity.performance : '-')}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getFRColor(decCityFR)};">${formatVal(decCityFR)}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getFRColor(janCityFR)};">${formatVal(janCityFR)}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getDCColor(decCityDC)};">${formatVal(decCityDC)}</td>
                            <td style="padding: 6px 8px; border: 1px solid #e5e7eb; text-align: center; font-size: 12px; font-weight: 600; color: ${getDCColor(janCityDC)};">${formatVal(janCityDC)}</td>
                        `;
                        body.appendChild(breakdownRow);
                    });
                }
            });
        }

        function updatePartnersOverviewCards(view) {
            const dataRows = view === 'ranked' ? rankedFeb : (view === 'top' ? topJan : bottomJan);
            const TOTAL_TARGET = 19365; // Total capacity target Feb
            
            // Calculate stats from data
            let totalTarget = 0, goodCount = 0, avgCount = 0, frSum = 0, frCount = 0, dcSum = 0, dcCount = 0;
            
            dataRows.forEach(row => {
                if (row.target !== '-' && row.target !== null) {
                    totalTarget += row.target;
                }
                if (row.performance === 'good') goodCount++;
                if (row.performance === 'average') avgCount++;
                if (row.fr && row.fr !== '-') {
                    frSum += parseFloat(row.fr);
                    frCount++;
                }
                if (row.dc && row.dc !== '-') {
                    dcSum += parseFloat(row.dc);
                    dcCount++;
                }
            });
            
            const targetPct = TOTAL_TARGET > 0 ? ((totalTarget / TOTAL_TARGET) * 100).toFixed(1) : 0;
            const avgFR = frCount > 0 ? (frSum / frCount).toFixed(1) : '-';
            const avgDC = dcCount > 0 ? (dcSum / dcCount).toFixed(1) : '-';
            
            // Update cards
            const cardPartners = document.getElementById('poCardPartners');
            const cardTotalTarget = document.getElementById('poCardTotalTarget');
            const cardTargetPct = document.getElementById('poCardTargetPct');
            const cardGood = document.getElementById('poCardGood');
            const cardAvg = document.getElementById('poCardAvg');
            const cardAvgFR = document.getElementById('poCardAvgFR');
            const cardAvgDC = document.getElementById('poCardAvgDC');
            const cardTotalTargetContainer = document.getElementById('poCardTotalTargetContainer');
            
            if (cardPartners) cardPartners.textContent = dataRows.length;
            if (cardTotalTarget) cardTotalTarget.textContent = totalTarget.toLocaleString();
            if (cardTargetPct) {
                cardTargetPct.textContent = targetPct + '%';
            }
            // Update tooltip with calculation
            if (cardTotalTargetContainer) {
                const viewLabel = view === 'top' ? 'Top 20' : (view === 'bottom' ? 'Bottom 20' : 'Ranked 20');
                cardTotalTargetContainer.setAttribute('data-tooltip', `${viewLabel}: ${totalTarget.toLocaleString()} / ${TOTAL_TARGET.toLocaleString()} total = ${targetPct}% of total capacity target`);
            }
            if (cardGood) cardGood.textContent = goodCount;
            if (cardAvg) cardAvg.textContent = avgCount;
            if (cardAvgFR) cardAvgFR.textContent = avgFR + '%';
            if (cardAvgDC) cardAvgDC.textContent = avgDC + '%';
        }

        document.querySelectorAll('.partners-overview-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.partners-overview-btn').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                });
                this.style.background = '#0ea5e9';
                this.style.color = 'white';
                this.style.borderColor = '#0ea5e9';
                const view = this.getAttribute('data-view');
                renderPartnersOverview(view);
                updatePartnersOverviewCards(view);
            });
        });

        renderPartnersOverview('top');
        updatePartnersOverviewCards('top');
    });

    // February 2026 Success Metrics - KPI Cards
    document.addEventListener('DOMContentLoaded', function() {
        const successMetricsData = {
            capacity: {
                title: 'Capacity Target & Avg Scale',
                isCombined: true,
                capacityData: {
                    title: 'Capacity Target',
                    segments: [
                        { label: 'Good', target: 10800, achieved: 10192, gap: -608, achievement: 94 },
                        { label: 'Average', target: 7285, achieved: 8414, gap: 1129, achievement: 115 },
                        { label: 'Bad', target: 952, achieved: 370, gap: -582, achievement: 39 },
                        { label: 'Total', target: 19037, achieved: 18976, gap: -61, achievement: 100 }
                    ],
                    insights: [
                        'Average segment exceeded target by +1,129 riders.',
                        'Good segment is short by -608 riders.',
                        'Bad segment is significantly below target with a -582 rider gap.'
                    ]
                },
                avgscaleData: {
                    title: 'Avg Scale Target',
                    segments: [
                        { label: 'Good', target: 44.9, achieved: 40.4, gap: -4, achievement: 90 },
                        { label: 'Average', target: 29.7, achieved: 32.1, gap: 2, achievement: 108 },
                        { label: 'Bad', target: 16.4, achieved: 18.5, gap: 2, achievement: 113 },
                        { label: 'Total (Overall Avg Scale)', target: 36.0, achieved: 35.1, gap: -0.9, achievement: 98 }
                    ],
                    insights: [
                        'Overall avg scale is below target by -0.9.',
                        'Good segment is below target by -4.',
                        'Average and Bad segments exceeded targets.'
                    ]
                }
            },
            nextmonth: {
                title: 'March 2026 Target Planning',
                isNextMonth: true,
                forecastedTarget: 21675,
                segments: [
                    { label: 'Good Partners', shareTarget: 50, scaleTarget: 50.0, currentShare: 53.7, currentScale: 40.4, color: '#10b981' },
                    { label: 'Average Partners', shareTarget: 45, scaleTarget: 30.0, currentShare: 44.3, currentScale: 32.1, color: '#f59e0b' },
                    { label: 'Bad Partners', shareTarget: 5, scaleTarget: 18.0, currentShare: 2.0, currentScale: 18.5, color: '#ef4444' }
                ],
                overall: { scaleTarget: 40.0, currentScale: 35.1 },
                insights: [
                    '<strong>⚖️ Share Rebalance:</strong> Good partners set to 50% given the 13% forecast uplift and driver-card constraints; capacity shifts to strong Average partners to keep coverage balanced.',
                    '<strong>📊 Balanced Distribution:</strong> Average partners raised to 45% (from 44.3% current) to absorb incremental capacity while maintaining stability.',
                    '<strong>📈 Scale Enhancement:</strong> Overall avg scale target raised to 40.0 (from 35.1 current) to drive cost per order reduction through partner consolidation.',
                    '<strong>🔒 Risk Containment:</strong> Bad partners held at 5% (from 2.0% current) to provide a controlled buffer for compliance improvement and onboarding.',
                    '<strong>💰 CPO Optimization:</strong> Scale targets remain (Good: 50.0, Average: 30.0, Bad: 18.0) to maximize efficiency per delivery.'
                ]
            }
        };

        const formatValue = (val) => {
            if (val === null || val === undefined) return '-';
            return Number.isInteger(val) ? val.toLocaleString() : val.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        };

        const formatPct = (val) => {
            if (val === null || val === undefined || !Number.isFinite(val)) return '-';
            return val.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        };

        const getGapColor = (gap) => {
            if (gap > 0) return '#16a34a';
            if (gap < 0) return '#dc2626';
            return '#6b7280';
        };

        const getAchievementColor = (pct, gap) => {
            // Treat meeting/exceeding target as green even if we flip the ratio.
            if (Number.isFinite(gap) && gap >= 0) return '#16a34a';
            if (pct >= 95) return '#16a34a';
            if (pct >= 85) return '#f59e0b';
            return '#dc2626';
        };

        const computeAchievement = (target, achieved) => {
            const t = Number(target);
            const a = Number(achieved);
            if (!Number.isFinite(t) || t <= 0 || !Number.isFinite(a)) {
                return { pct: 0, formula: '-' };
            }

            const rawPct = (a / t) * 100;
            if (rawPct <= 100) {
                return { pct: rawPct, formula: `${formatValue(a)} / ${formatValue(t)}` };
            }

            // Flip for >100% cases to keep the metric visually intuitive.
            return { pct: (t / a) * 100, formula: `${formatValue(t)} / ${formatValue(a)}` };
        };

        const renderSuccessMetrics = (metricKey) => {
            const container = document.getElementById('successMetricsCards');
            const insights = document.getElementById('successMetricsInsights');
            if (!container || !insights) return;

            const data = successMetricsData[metricKey];
            container.innerHTML = '';

            // Special rendering for Next Month Target
            if (data.isNextMonth) {
                container.style.gridTemplateColumns = '1fr';
                
                // Header Section
                const headerCard = document.createElement('div');
                headerCard.style.cssText = 'background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); border-radius: 16px; padding: 24px; color: white; margin-bottom: 10px;';
                headerCard.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 800;">🎯 ${data.title}</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 14px;">Strategic capacity allocation targets for next month</p>
                        </div>
                        <div style="display: flex; gap: 20px;">
                            <div style="text-align: center; background: rgba(255,255,255,0.15); padding: 12px 20px; border-radius: 12px;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Overall Scale Target</div>
                                <div style="font-size: 28px; font-weight: 800;">${data.overall.scaleTarget}</div>
                            </div>
                            <div style="text-align: center; background: rgba(255,255,255,0.15); padding: 12px 20px; border-radius: 12px;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">Current Scale</div>
                                <div style="font-size: 28px; font-weight: 800;">${data.overall.currentScale}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(headerCard);
                
                // Forecasted Target Note
                if (data.forecastedTarget) {
                    const noteCard = document.createElement('div');
                    noteCard.style.cssText = 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 14px 18px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px;';
                    noteCard.innerHTML = `
                        <div style="font-size: 20px;">⚠️</div>
                        <div>
                            <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 4px;">Planning Assumption Notice</div>
                            <div style="font-size: 12px; color: #78350f; line-height: 1.5;">These targets are based on <strong>forecasted capacity target of ${data.forecastedTarget.toLocaleString()} riders</strong>. Target distribution percentages and scale metrics will be recalibrated if actual capacity requirements differ from forecast.</div>
                        </div>
                    `;
                    container.appendChild(noteCard);
                }

                // Segments Grid
                const segmentsGrid = document.createElement('div');
                segmentsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 10px;';
                
                data.segments.forEach(seg => {
                    const shareGap = seg.shareTarget - seg.currentShare;
                    const scaleGap = seg.scaleTarget - seg.currentScale;
                    const shareGapColor = shareGap >= 0 ? '#16a34a' : '#dc2626';
                    const scaleGapColor = scaleGap >= 0 ? '#16a34a' : '#dc2626';
                    
                    const segCard = document.createElement('div');
                    segCard.style.cssText = 'background: white; border-radius: 16px; padding: 20px; border: 2px solid ' + seg.color + '20; box-shadow: 0 4px 12px rgba(0,0,0,0.05);';
                    segCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: ${seg.color}15; display: flex; align-items: center; justify-content: center;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: ${seg.color};"></div>
                            </div>
                            <div>
                                <div style="font-weight: 800; color: #1f4e78; font-size: 16px;">${seg.label}</div>
                                <div style="font-size: 11px; color: #6b7280;">Performance Segment</div>
                            </div>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">📊 Capacity Share Target</div>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 32px; font-weight: 800; color: ${seg.color};">${seg.shareTarget}%</span>
                                <span style="font-size: 13px; color: #6b7280;">target</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">Current: ${seg.currentShare}%</span>
                                <span style="font-size: 12px; font-weight: 700; color: ${shareGapColor};">(${shareGap >= 0 ? '+' : ''}${shareGap.toFixed(1)}%)</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; margin-top: 10px; overflow: hidden;">
                                <div style="background: ${seg.color}; height: 100%; width: ${Math.min(seg.currentShare / seg.shareTarget * 100, 100)}%; border-radius: 3px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div style="background: #f0fdf4; border-radius: 12px; padding: 16px;">
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">📈 Avg Scale Target</div>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 32px; font-weight: 800; color: #059669;">${seg.scaleTarget}</span>
                                <span style="font-size: 13px; color: #6b7280;">riders/partner</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 12px; color: #6b7280;">Current: ${seg.currentScale}</span>
                                <span style="font-size: 12px; font-weight: 700; color: ${scaleGapColor};">(${scaleGap >= 0 ? '+' : ''}${scaleGap.toFixed(1)})</span>
                            </div>
                        </div>
                    `;
                    segmentsGrid.appendChild(segCard);
                });
                
                container.appendChild(segmentsGrid);

                // Summary Distribution Bar
                const distBar = document.createElement('div');
                distBar.style.cssText = 'background: white; border-radius: 16px; padding: 20px; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.05);';
                distBar.innerHTML = `
                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px; font-weight: 600;">📊 Target Capacity Distribution (Mar 2026) - Balanced Strategy</div>
                    <div style="display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin-bottom: 12px;">
                        <div style="width: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px;">Good 50%</div>
                        <div style="width: 45%; background: #f59e0b; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px;">Average 45%</div>
                        <div style="width: 5%; background: #ef4444; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 11px;">5%</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                        <span>🎯 Quality: Maximize Good allocation</span>
                        <span>💰 CPO: Scale consolidation</span>
                        <span>🔒 Risk: Controlled Bad buffer</span>
                    </div>
                `;
                container.appendChild(distBar);

                // Reset grid for insights
                container.style.gridTemplateColumns = '1fr';
            } else if (data.isCombined) {
                // Combined Capacity Target & Avg Scale view
                container.style.gridTemplateColumns = '1fr';
                
                // Helper function to create segment cards
                const createSegmentCards = (segments) => {
                    const grid = document.createElement('div');
                    grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; margin-bottom: 18px;';
                    
                    segments.forEach(seg => {
                        const card = document.createElement('div');
                        card.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06); display: flex; align-items: center; gap: 20px;';

                        const gap = (Number.isFinite(seg.target) && Number.isFinite(seg.achieved)) ? (seg.achieved - seg.target) : seg.gap;
                        const ach = computeAchievement(seg.target, seg.achieved);
                        const achPct = Math.max(0, Math.min(ach.pct, 100));
                        const achColor = getAchievementColor(ach.pct, gap);
                        
                        card.innerHTML = `
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(${achColor} ${achPct}%, #e5e7eb 0); position: relative; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <div style="position: absolute; inset: 10px; background: white; border-radius: 50%; box-shadow: inset 0 0 0 1px #f3f4f6;"></div>
                                <div style="position: relative; font-weight: 800; color: #111827; font-size: 20px;">${formatPct(ach.pct)}%</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; color: #1f4e78; font-size: 20px; margin-bottom: 12px;">${seg.label}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Target</div>
                                        <div style="font-weight: 800; color: #111827; font-size: 18px;">${formatValue(seg.target)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Achieved</div>
                                        <div style="font-weight: 800; color: #111827; font-size: 18px;">${formatValue(seg.achieved)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Gap</div>
                                        <div style="font-weight: 800; color: ${getGapColor(gap)}; font-size: 16px;">${gap > 0 ? '+' : ''}${formatValue(gap)}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Achievement</div>
                                        <div style="font-weight: 800; color: ${achColor}; font-size: 16px;">${formatPct(ach.pct)}%</div>
                                        <div style="margin-top: 2px; font-size: 11px; color: #94a3b8; font-weight: 700; letter-spacing: 0.2px;">${ach.formula}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    return grid;
                };
                
                // Capacity Target Section
                const capacityHeader = document.createElement('h4');
                capacityHeader.style.cssText = 'color: #1f4e78; font-size: 18px; font-weight: 700; margin: 0 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid #059669;';
                capacityHeader.innerHTML = '📊 Capacity Target';
                container.appendChild(capacityHeader);
                container.appendChild(createSegmentCards(data.capacityData.segments));
                
                // Capacity insights
                const capacityInsights = document.createElement('div');
                capacityInsights.className = 'highlight-box';
                capacityInsights.style.cssText = 'background: #f0fdf4; padding: 16px 20px; border-radius: 12px; border-left: 4px solid #059669; margin-bottom: 24px;';
                const capacityListItems = data.capacityData.insights.map(text => `<li style="margin-bottom: 8px; font-size: 13px; line-height: 1.5;">${text}</li>`).join('');
                capacityInsights.innerHTML = `
                    <h5 style="color: #065f46; margin: 0 0 10px 0; font-size: 14px;">💡 Key Observations</h5>
                    <ul style="margin: 0; padding-left: 20px;">${capacityListItems}</ul>
                `;
                container.appendChild(capacityInsights);
                
                // Avg Scale Target Section
                const avgscaleHeader = document.createElement('h4');
                avgscaleHeader.style.cssText = 'color: #1f4e78; font-size: 18px; font-weight: 700; margin: 0 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid #0ea5e9;';
                avgscaleHeader.innerHTML = '📈 Avg Scale Target';
                container.appendChild(avgscaleHeader);
                container.appendChild(createSegmentCards(data.avgscaleData.segments));
                
                // Avg Scale insights
                const avgscaleInsights = document.createElement('div');
                avgscaleInsights.className = 'highlight-box';
                avgscaleInsights.style.cssText = 'background: #f0f9ff; padding: 16px 20px; border-radius: 12px; border-left: 4px solid #0ea5e9;';
                const avgscaleListItems = data.avgscaleData.insights.map(text => `<li style="margin-bottom: 8px; font-size: 13px; line-height: 1.5;">${text}</li>`).join('');
                avgscaleInsights.innerHTML = `
                    <h5 style="color: #0f4a6e; margin: 0 0 10px 0; font-size: 14px;">💡 Key Observations</h5>
                    <ul style="margin: 0; padding-left: 20px;">${avgscaleListItems}</ul>
                `;
                container.appendChild(avgscaleInsights);
                
                // Hide the main insights section since we have inline insights
                insights.style.display = 'none';
                return;
            } else {
                container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(320px, 1fr))';
                
                data.segments.forEach(seg => {
                    const card = document.createElement('div');
                    card.style.background = 'white';
                    card.style.border = '1px solid #e5e7eb';
                    card.style.borderRadius = '16px';
                    card.style.padding = '24px';
                    card.style.boxShadow = '0 6px 18px rgba(15, 23, 42, 0.06)';
                    card.style.display = 'flex';
                    card.style.alignItems = 'center';
                    card.style.gap = '20px';

                    const gap = (Number.isFinite(seg.target) && Number.isFinite(seg.achieved)) ? (seg.achieved - seg.target) : seg.gap;
                    const ach = computeAchievement(seg.target, seg.achieved);
                    const achPct = Math.max(0, Math.min(ach.pct, 100));
                    const achColor = getAchievementColor(ach.pct, gap);

                    card.innerHTML = `
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(${achColor} ${achPct}%, #e5e7eb 0); position: relative; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <div style="position: absolute; inset: 10px; background: white; border-radius: 50%; box-shadow: inset 0 0 0 1px #f3f4f6;"></div>
                            <div style="position: relative; font-weight: 800; color: #111827; font-size: 20px;">${formatPct(ach.pct)}%</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 800; color: #1f4e78; font-size: 20px; margin-bottom: 12px;">${seg.label}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Target</div>
                                    <div style="font-weight: 800; color: #111827; font-size: 18px;">${formatValue(seg.target)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Achieved</div>
                                    <div style="font-weight: 800; color: #111827; font-size: 18px;">${formatValue(seg.achieved)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Gap</div>
                                    <div style="font-weight: 800; color: ${getGapColor(gap)}; font-size: 16px;">${gap > 0 ? '+' : ''}${formatValue(gap)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; letter-spacing: 0.3px;">Achievement</div>
                                    <div style="font-weight: 800; color: ${achColor}; font-size: 16px;">${formatPct(ach.pct)}%</div>
                                    <div style="margin-top: 2px; font-size: 11px; color: #94a3b8; font-weight: 700; letter-spacing: 0.2px;">${ach.formula}</div>
                                </div>
                            </div>
                        </div>
                    `;

                    container.appendChild(card);
                });
            }

            const listItems = data.insights.map(text => `<li style="margin-bottom: 10px; font-size: 14px; line-height: 1.5;">${text}</li>`).join('');
            insights.innerHTML = `
                <h4 style="color: #065f46; margin-bottom: 12px; font-size: 16px;">💡 ${data.isNextMonth ? 'Strategic Planning Insights' : 'Key Observations'}</h4>
                <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                    ${listItems}
                </ul>
            `;
        };

        document.querySelectorAll('.success-metrics-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.success-metrics-toggle').forEach(b => {
                    b.style.background = 'white';
                    b.style.color = '#6b7280';
                    b.style.borderColor = '#e5e7eb';
                    b.classList.remove('active');
                });
                this.style.background = '#059669';
                this.style.color = 'white';
                this.style.borderColor = '#059669';
                this.classList.add('active');
                
                const metric = this.getAttribute('data-metric');
                const okrsSection = document.getElementById('okrsSummarySection');
                const cardsSection = document.getElementById('successMetricsCards');
                const insightsSection = document.getElementById('successMetricsInsights');
                
                // Remove previous animation classes
                [okrsSection, cardsSection, insightsSection].forEach(el => {
                    if (el) {
                        el.classList.remove('metrics-animate-in', 'metrics-fade-in');
                    }
                });
                
                if (metric === 'okrs') {
                    if (cardsSection) cardsSection.style.display = 'none';
                    if (insightsSection) insightsSection.style.display = 'none';
                    if (okrsSection) {
                        okrsSection.style.display = 'block';
                        okrsSection.style.opacity = '0';
                        setTimeout(() => {
                            okrsSection.classList.add('metrics-animate-in');
                            okrsSection.style.opacity = '1';
                        }, 50);
                    }
                } else {
                    if (okrsSection) okrsSection.style.display = 'none';
                    if (cardsSection) {
                        cardsSection.style.display = 'grid';
                        cardsSection.style.opacity = '0';
                        setTimeout(() => {
                            cardsSection.classList.add('metrics-animate-in');
                            cardsSection.style.opacity = '1';
                        }, 50);
                    }
                    if (insightsSection) {
                        insightsSection.style.opacity = '0';
                        insightsSection.style.display = 'block';
                        setTimeout(() => {
                            insightsSection.classList.add('metrics-fade-in');
                            insightsSection.style.opacity = '1';
                        }, 150);
                    }
                    renderSuccessMetrics(metric);
                }
            });
        });

        // OKR Card Toggle Function
        window.toggleOkrCard = function(btn) {
            const content = btn.nextElementSibling;
            const arrow = btn.querySelector('span:last-child');
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                content.style.opacity = '0';
                content.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    content.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);
                arrow.textContent = '▲';
            } else {
                content.style.transition = 'all 0.3s ease-out';
                content.style.opacity = '0';
                content.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    content.style.display = 'none';
                }, 300);
                arrow.textContent = '▼';
            }
        };

        renderSuccessMetrics('capacity');
    });

    // Firebase Comment System
    var firebaseConfig = {
      apiKey: "AIzaSyDrHdrD3sXKqVqT64lKoRo1ca3jihG57Ps",
      authDomain: "capacity-target-dashbaord.firebaseapp.com",
      databaseURL: "https://capacity-target-dashbaord-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "capacity-target-dashbaord",
      storageBucket: "capacity-target-dashbaord.firebasestorage.app",
      messagingSenderId: "533267064583",
      appId: "1:533267064583:web:129504b66653a36b5987a2"
    };
    
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    } catch(e) {
      console.log('Firebase init error:', e);
    }
    
    var currentSection = '';
    var userName = localStorage.getItem('dashboardUserName') || '';
    var previousCommentCounts = {}; // Track previous counts to detect new comments
    var currentPanelListener = null; // Track the current panel listener
    var currentPanelRef = null; // Track the current panel reference
    
    // Request notification permission
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
          if (permission === 'granted') {
            console.log('Notification permission granted');
          }
        });
      }
    }
    
    // Show browser notification
    function showCommentNotification(sectionId, comment) {
      if ('Notification' in window && Notification.permission === 'granted') {
        var sectionNames = {
          'totalOverview-mtd': '📊 MTD Achievement',
          'totalOverview-w1': '📊 W1 Performance',
          'totalOverview-w2': '📊 W2 Performance',
          'totalOverview-gap': '📊 Total GAP',
          'totalOverview-table': '📊 Performance Summary',
          'totalOverview-chart': '📈 Daily Achievement Trend Chart',
          'partnersStrat': '👥 Partners Stratification',
          'cityLevel': '🏙️ City Level Data'
        };
        
        var title = '🔔 New Comment';
        var body = comment.userName + ' commented on ' + (sectionNames[sectionId] || sectionId);
        
        var notification = new Notification(title, {
          body: body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">💬</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">💬</text></svg>',
          tag: 'comment-' + sectionId,
          requireInteraction: false
        });
        
        notification.onclick = function() {
          window.focus();
          openComments(sectionId, true);
          notification.close();
        };
      }
    }
    
    // Request permission when page loads
    setTimeout(requestNotificationPermission, 2000);
    
    function openComments(section, scrollToComponent) {
      currentSection = section;
      document.getElementById('commentPanel').classList.add('open');
      document.getElementById('commentOverlay').classList.add('show');
      
      var sectionNames = {
        'totalOverview-mtd': '📊 MTD Achievement',
        'totalOverview-w1': '📊 W1 Performance',
        'totalOverview-w2': '📊 W2 Performance',
        'totalOverview-gap': '📊 Total GAP',
        'totalOverview-table': '📊 Performance Summary',
        'totalOverview-chart': '📈 Daily Achievement Trend Chart',
        'partnersStrat': '👥 Partners Stratification',
        'cityLevel': '🏙️ City Level Data'
      };
      
      var sectionDescriptions = {
        'totalOverview-mtd': 'Commenting on the MTD Achievement Card in Total Overview section',
        'totalOverview-w1': 'Commenting on the W1 Performance Card in Total Overview section',
        'totalOverview-w2': 'Commenting on the W2 Performance Card in Total Overview section',
        'totalOverview-gap': 'Commenting on the Total GAP Card in Total Overview section',
        'totalOverview-table': 'Commenting on the Performance Summary Table in Total Overview section',
        'totalOverview-chart': 'Commenting on the Daily Achievement Trend Chart in Total Overview section',
        'partnersStrat': 'Commenting on the Partners Stratification section',
        'cityLevel': 'Commenting on the City Level Data section'
      };
      
      document.getElementById('currentSectionName').textContent = sectionNames[section] || section;
      
      // Add context banner
      var contextBanner = document.getElementById('commentContextBanner');
      if(contextBanner) {
        if(sectionDescriptions[section]) {
          contextBanner.innerHTML = '<strong>' + sectionNames[section] + '</strong><div class="context-location">' + sectionDescriptions[section] + '</div>';
          contextBanner.style.display = 'block';
        } else {
          contextBanner.style.display = 'none';
        }
      }
      
      // Scroll to and highlight the component if requested
      if(scrollToComponent !== false) {
        var componentSelector = '[onclick*="openComments(\'' + section + '\')"]';
        var component = document.querySelector(componentSelector);
        
        if(component) {
          // Find the parent commentable section
          var commentableSection = component.closest('.commentable-section');
          if(commentableSection) {
            // Scroll to it
            commentableSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Add highlight animation
            commentableSection.classList.add('highlight-pulse');
            setTimeout(function() {
              commentableSection.classList.remove('highlight-pulse');
            }, 2000);
          }
        }
      }
      
      // Re-enable input fields (in case coming from hub view)
      document.getElementById('commentUserName').disabled = false;
      document.getElementById('commentText').disabled = false;
      document.getElementById('submitCommentBtn').disabled = false;
      document.getElementById('submitCommentBtn').textContent = 'Post Comment';
      
      loadComments(section);
      if(!userName) {
        document.getElementById('commentUserName').focus();
      } else {
        document.getElementById('commentUserName').value = userName;
      }
    }
    
    function closeComments() {
      // Remove panel listener when closing
      if(currentPanelRef && currentPanelListener) {
        currentPanelRef.off('value', currentPanelListener);
        currentPanelListener = null;
        currentPanelRef = null;
      }
      
      document.getElementById('commentPanel').classList.remove('open');
      document.getElementById('commentOverlay').classList.remove('show');
      
      // Hide context banner
      var contextBanner = document.getElementById('commentContextBanner');
      if(contextBanner) contextBanner.style.display = 'none';
    }
    
    function loadComments(section) {
      // Remove previous panel listener if exists
      if(currentPanelRef && currentPanelListener) {
        currentPanelRef.off('value', currentPanelListener);
      }
      
      var commentsRef = firebase.database().ref('comments/' + section);
      currentPanelRef = commentsRef;
      
      // Create new listener function
      currentPanelListener = function(snapshot) {
        var commentList = document.getElementById('commentList');
        commentList.innerHTML = '';
        var count = 0;
        
        var comments = [];
        snapshot.forEach(function(child) {
          comments.push({key: child.key, data: child.val()});
        });
        
        comments.reverse(); // Show newest first
        
        if(comments.length === 0) {
          commentList.innerHTML = '<div class="comment-empty">💬<br>No comments yet.<br>Be the first to comment!</div>';
        } else {
          // Separate by status and organize threads
          var pinned = comments.filter(c => c.data.pinned && !c.data.parentId);
          var active = comments.filter(c => !c.data.pinned && !c.data.resolved && !c.data.parentId);
          var resolved = comments.filter(c => c.data.resolved && !c.data.parentId);
          var sorted = pinned.concat(active, resolved);
          
          sorted.forEach(function(comment) {
            renderComment(comment, section, commentList, comments);
            count++;
            
            // Render replies
            var replies = comments.filter(c => c.data.parentId === comment.key);
            replies.forEach(function(reply) {
              renderComment(reply, section, commentList, comments, true);
              count++;
            });
          });
        }
        
        // Update badge
        var badge = document.getElementById('badge-' + section);
        if(badge) {
          if(count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
            document.querySelector('[onclick="openComments(\'' + section + '\')"]')?.classList.add('has-comments');
          } else {
            badge.style.display = 'none';
            document.querySelector('[onclick="openComments(\'' + section + '\')"]')?.classList.remove('has-comments');
          }
        }
      };
      
      // Attach the listener
      commentsRef.orderByChild('timestamp').on('value', currentPanelListener);
    }
    
    function openCommentHub() {
      // Load and display all comments from all sections
      currentSection = 'hub';
      document.getElementById('commentPanel').classList.add('open');
      document.getElementById('commentOverlay').classList.add('show');
      document.getElementById('currentSectionName').textContent = 'All Comments';
      
      var commentList = document.getElementById('commentList');
      commentList.innerHTML = '<div style="padding:20px; text-align:center; color:#9e9e9e; font-size:13px;"><i>Loading all comments...</i></div>';
      
      var allSections = [
        {id: 'totalOverview-mtd', name: '📊 MTD Achievement'},
        {id: 'totalOverview-w1', name: '📊 W1 Performance'},
        {id: 'totalOverview-w2', name: '📊 W2 Performance'},
        {id: 'totalOverview-gap', name: '📊 Total GAP'},
        {id: 'totalOverview-table', name: '📊 Performance Summary'},
        {id: 'totalOverview-chart', name: '📈 Daily Achievement Trend Chart'},
        {id: 'partnersStrat', name: '👥 Partners Stratification'},
        {id: 'cityLevel', name: '🏙️ City Level Data'}
      ];
      
      var allComments = [];
      var sectionsLoaded = 0;
      
      allSections.forEach(function(section) {
        firebase.database().ref('comments/' + section.id).once('value').then(function(snapshot) {
          snapshot.forEach(function(child) {
            allComments.push({
              sectionId: section.id,
              sectionName: section.name,
              key: child.key,
              data: child.val()
            });
          });
          
          sectionsLoaded++;
          
          if(sectionsLoaded === allSections.length) {
            // All sections loaded, now display
            commentList.innerHTML = '';
            
            if(allComments.length === 0) {
              commentList.innerHTML = '<div class="comment-empty">💬<br>No comments yet across all sections.<br><br>Hover over cards, tables, and charts to add comments.</div>';
            } else {
              // Sort by timestamp (newest first)
              allComments.sort(function(a, b) {
                return (b.data.timestamp || 0) - (a.data.timestamp || 0);
              });
              
              // Group by section
              var currentSec = '';
              allComments.forEach(function(comment) {
                // Add section header if new section
                if(currentSec !== comment.sectionName) {
                  currentSec = comment.sectionName;
                  var sectionHeader = document.createElement('div');
                  sectionHeader.style.cssText = 'background:#e3f2fd; padding:8px 12px; margin:10px -16px 10px -16px; font-weight:700; font-size:12px; color:#0d47a1; border-left:4px solid #1976d2; cursor:pointer;';
                  sectionHeader.textContent = currentSec;
                  (function(secId) {
                    sectionHeader.onclick = function() { openComments(secId, true); };
                  })(comment.sectionId);
                  commentList.appendChild(sectionHeader);
                }
                
                // Render comment (simplified view)
                var item = document.createElement('div');
                item.className = 'comment-item';
                if(comment.data.pinned) item.classList.add('pinned');
                if(comment.data.resolved) item.classList.add('resolved');
                
                var timeStr = getRelativeTime(comment.data.timestamp);
                var pinBadge = comment.data.pinned ? '<span class="comment-pin-badge">📌 PINNED</span>' : '';
                var resolvedBadge = comment.data.resolved ? '<span class="comment-resolved-badge">✓ RESOLVED</span>' : '';
                
                var textWithMentions = highlightMentions(escapeHtml(comment.data.text));
                
                item.innerHTML = '<div class="comment-user">' + escapeHtml(comment.data.userName) + pinBadge + resolvedBadge + '</div>' +
                               '<div class="comment-text">' + textWithMentions.replace(/\n/g, '<br>') + '</div>' +
                               '<div class="comment-time">' + timeStr + '</div>' +
                               '<button class="comment-action-btn" onclick="openComments(\'' + comment.sectionId + '\', true)" style="margin-top:6px;">📍 View Thread & Highlight →</button>';
                commentList.appendChild(item);
              });
            }
            
            // Disable input area in hub view
            document.getElementById('commentUserName').disabled = true;
            document.getElementById('commentText').disabled = true;
            document.getElementById('submitCommentBtn').disabled = true;
            document.getElementById('submitCommentBtn').textContent = 'Select a Section to Comment';
          }
        });
      });
    }
    
    var replyToComment = null;
    
    function renderComment(comment, section, container, allComments, isReply) {
      var item = document.createElement('div');
      item.className = 'comment-item';
      item.setAttribute('data-comment-id', comment.key);
      if(comment.data.pinned) item.classList.add('pinned');
      if(comment.data.resolved) item.classList.add('resolved');
      if(isReply) item.classList.add('reply');
      
      var timeStr = getRelativeTime(comment.data.timestamp);
      var pinBadge = comment.data.pinned ? '<span class="comment-pin-badge">📌 PINNED</span>' : '';
      var resolvedBadge = comment.data.resolved ? '<span class="comment-resolved-badge">✓ RESOLVED</span>' : '';
      var editedBadge = comment.data.edited ? '<span class="comment-edited-badge">edited</span>' : '';
      var pinBtn = !isReply ? '<button class="comment-pin-btn' + (comment.data.pinned ? ' pinned' : '') + '" onclick="togglePin(\'' + section + '\', \'' + comment.key + '\', ' + !comment.data.pinned + ')">' + (comment.data.pinned ? '📌 Unpin' : '📌 Pin') + '</button>' : '';
      
      var textWithMentions = highlightMentions(escapeHtml(comment.data.text));
      
      // Reactions
      var reactions = comment.data.reactions || {};
      var reactionsHtml = '<div class="comment-reaction-bar">';
      ['👍', '❤️', '🎯'].forEach(function(emoji) {
        var users = reactions[emoji] || [];
        var count = users.length;
        var isActive = users.indexOf(userName) !== -1;
        if(count > 0 || true) {
          reactionsHtml += '<div class="comment-reaction' + (isActive ? ' active' : '') + '" onclick="toggleReaction(\'' + section + '\', \'' + comment.key + '\', \'' + emoji + '\')"><span>' + emoji + '</span>' + (count > 0 ? '<span>' + count + '</span>' : '') + '</div>';
        }
      });
      reactionsHtml += '</div>';
      
      // Action buttons
      var isOwn = comment.data.userName === userName;
      var actionsHtml = '<div class="comment-actions">' + reactionsHtml;
      if(!isReply) {
        actionsHtml += '<button class="comment-action-btn" onclick="startReply(\'' + section + '\', \'' + comment.key + '\', \'' + escapeHtml(comment.data.userName).replace(/'/g, "\\'") + '\')">💬 Reply</button>';
      }
      if(isOwn) {
        actionsHtml += '<button class="comment-action-btn" onclick="startEdit(\'' + section + '\', \'' + comment.key + '\')">✏️ Edit</button>';
        actionsHtml += '<button class="comment-action-btn" onclick="deleteComment(\'' + section + '\', \'' + comment.key + '\')">🗑️ Delete</button>';
      }
      if(!isReply && !comment.data.resolved) {
        actionsHtml += '<button class="comment-action-btn" onclick="resolveComment(\'' + section + '\', \'' + comment.key + '\', true)">✓ Resolve</button>';
      } else if(!isReply && comment.data.resolved) {
        actionsHtml += '<button class="comment-action-btn" onclick="resolveComment(\'' + section + '\', \'' + comment.key + '\', false)">↶ Unresolve</button>';
      }
      actionsHtml += '</div>';
      
      item.innerHTML = '<div class="comment-user">' + escapeHtml(comment.data.userName) + pinBadge + resolvedBadge + editedBadge + '</div>' +
                     '<div class="comment-text" id="text-' + comment.key + '">' + textWithMentions.replace(/\n/g, '<br>') + '</div>' +
                     '<div class="comment-time">' + timeStr + '</div>' +
                     actionsHtml + pinBtn;
      container.appendChild(item);
    }
    
    function submitComment() {
      var nameInput = document.getElementById('commentUserName');
      var textInput = document.getElementById('commentText');
      var submitBtn = document.getElementById('submitCommentBtn');
      
      var name = nameInput.value.trim();
      var text = textInput.value.trim();
      
      if(!name) {
        alert('Please enter your name');
        nameInput.focus();
        return;
      }
      if(!text) {
        alert('Please enter a comment');
        textInput.focus();
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Posting...';
      
      userName = name;
      localStorage.setItem('dashboardUserName', name);
      
      var commentData = {
        userName: name,
        text: text,
        timestamp: Date.now()
      };
      
      if(replyToComment) {
        commentData.parentId = replyToComment.id;
      }
      
      var commentsRef = firebase.database().ref('comments/' + currentSection);
      commentsRef.push(commentData).then(function() {
        textInput.value = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Post Comment';
        cancelReply();
      }).catch(function(error) {
        alert('Error posting comment: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Post Comment';
      });
    }
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getRelativeTime(timestamp) {
      var now = Date.now();
      var diff = now - timestamp;
      var seconds = Math.floor(diff / 1000);
      var minutes = Math.floor(seconds / 60);
      var hours = Math.floor(minutes / 60);
      var days = Math.floor(hours / 24);
      
      if(seconds < 60) return 'Just now';
      if(minutes < 60) return minutes + ' minute' + (minutes > 1 ? 's' : '') + ' ago';
      if(hours < 24) return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
      if(days < 7) return days + ' day' + (days > 1 ? 's' : '') + ' ago';
      
      var date = new Date(timestamp);
      return date.toLocaleString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
    }
    
    function togglePin(section, commentKey, pinState) {
      firebase.database().ref('comments/' + section + '/' + commentKey).update({
        pinned: pinState
      }).catch(function(error) {
        alert('Error updating pin: ' + error.message);
      });
    }
    
    function toggleReaction(section, commentKey, emoji) {
      if(!userName) {
        alert('Please enter your name first');
        return;
      }
      
      var ref = firebase.database().ref('comments/' + section + '/' + commentKey + '/reactions/' + emoji);
      ref.once('value').then(function(snapshot) {
        var users = snapshot.val() || [];
        var index = users.indexOf(userName);
        
        if(index !== -1) {
          users.splice(index, 1);
        } else {
          users.push(userName);
        }
        
        ref.set(users.length > 0 ? users : null);
      });
    }
    
    function startEdit(section, commentKey) {
      var textElem = document.getElementById('text-' + commentKey);
      firebase.database().ref('comments/' + section + '/' + commentKey).once('value').then(function(snapshot) {
        var comment = snapshot.val();
        var originalText = comment.text;
        
        textElem.innerHTML = '<div class="comment-edit-area">' +
          '<textarea id="edit-textarea-' + commentKey + '">' + escapeHtml(originalText) + '</textarea>' +
          '<div class="comment-edit-btns">' +
          '<button class="comment-save-btn" onclick="saveEdit(\'' + section + '\', \'' + commentKey + '\')">✔ Save</button>' +
          '<button class="comment-cancel-btn" onclick="cancelEdit(\'' + section + '\', \'' + commentKey + '\', \'' + escapeHtml(originalText).replace(/'/g, "\\'").replace(/\n/g, '\\n') + '\')">✖ Cancel</button>' +
          '</div></div>';
      });
    }
    
    function saveEdit(section, commentKey) {
      var textarea = document.getElementById('edit-textarea-' + commentKey);
      var newText = textarea.value.trim();
      
      if(!newText) {
        alert('Comment cannot be empty');
        return;
      }
      
      firebase.database().ref('comments/' + section + '/' + commentKey).update({
        text: newText,
        edited: true
      }).then(function() {
        var textElem = document.getElementById('text-' + commentKey);
        textElem.innerHTML = highlightMentions(escapeHtml(newText)).replace(/\n/g, '<br>');
      });
    }
    
    function cancelEdit(section, commentKey, originalText) {
      var textElem = document.getElementById('text-' + commentKey);
      textElem.innerHTML = highlightMentions(originalText).replace(/\n/g, '<br>');
    }
    
    function deleteComment(section, commentKey) {
      if(!confirm('Are you sure you want to delete this comment?')) return;
      
      firebase.database().ref('comments/' + section + '/' + commentKey).remove().catch(function(error) {
        alert('Error deleting comment: ' + error.message);
      });
    }
    
    function resolveComment(section, commentKey, resolveState) {
      firebase.database().ref('comments/' + section + '/' + commentKey).update({
        resolved: resolveState
      }).catch(function(error) {
        alert('Error updating resolve status: ' + error.message);
      });
    }
    
    function startReply(section, commentKey, toUserName) {
      replyToComment = {id: commentKey, userName: toUserName};
      var replyHeader = document.getElementById('replyHeader');
      replyHeader.style.display = 'flex';
      replyHeader.querySelector('.reply-to').textContent = 'Replying to ' + toUserName;
      document.getElementById('commentText').focus();
    }
    
    function cancelReply() {
      replyToComment = null;
      var replyHeader = document.getElementById('replyHeader');
      replyHeader.style.display = 'none';
    }
    
    function highlightMentions(text) {
      return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
    }
    
    // @Mention autocomplete
    var knownUsers = [];
    document.addEventListener('DOMContentLoaded', function() {
      var textarea = document.getElementById('commentText');
      if(textarea) {
        textarea.addEventListener('input', function(e) {
          var text = this.value;
          var cursorPos = this.selectionStart;
          var textBeforeCursor = text.substring(0, cursorPos);
          var lastAtIndex = textBeforeCursor.lastIndexOf('@');
          
          if(lastAtIndex !== -1) {
            var afterAt = textBeforeCursor.substring(lastAtIndex + 1);
            if(!/\s/.test(afterAt) && afterAt.length > 0) {
              showMentionAutocomplete(afterAt, lastAtIndex);
              return;
            }
          }
          hideMentionAutocomplete();
        });
      }
    });
    
    function showMentionAutocomplete(query, atIndex) {
      var matches = knownUsers.filter(u => u.toLowerCase().startsWith(query.toLowerCase()));
      if(matches.length === 0) {
        hideMentionAutocomplete();
        return;
      }
      
      var existing = document.getElementById('mentionAutocomplete');
      if(!existing) {
        existing = document.createElement('div');
        existing.id = 'mentionAutocomplete';
        existing.className = 'mention-autocomplete';
        document.querySelector('.comment-input-area').appendChild(existing);
      }
      
      existing.innerHTML = matches.slice(0, 5).map(u => 
        '<div class="mention-item" onclick="insertMention(\'' + u + '\')">' + u + '</div>'
      ).join('');
      existing.style.display = 'block';
    }
    
    function hideMentionAutocomplete() {
      var elem = document.getElementById('mentionAutocomplete');
      if(elem) elem.style.display = 'none';
    }
    
    function insertMention(username) {
      var textarea = document.getElementById('commentText');
      var text = textarea.value;
      var cursorPos = textarea.selectionStart;
      var textBeforeCursor = text.substring(0, cursorPos);
      var lastAtIndex = textBeforeCursor.lastIndexOf('@');
      
      var newText = text.substring(0, lastAtIndex + 1) + username + ' ' + text.substring(cursorPos);
      textarea.value = newText;
      textarea.selectionStart = textarea.selectionEnd = lastAtIndex + username.length + 2;
      textarea.focus();
      hideMentionAutocomplete();
    }
    
    // Load comment counts on page load for all sections
    setTimeout(function() {
      var allSections = ['totalOverview-mtd', 'totalOverview-w1', 'totalOverview-w2', 'totalOverview-gap', 'totalOverview-table', 'totalOverview-chart', 'partnersStrat', 'cityLevel'];
      var sectionCounts = {}; // Track counts per section
      
      function updateTotalBadge() {
        var total = 0;
        allSections.forEach(function(sec) {
          total += (sectionCounts[sec] || 0);
        });
        document.getElementById('commentHubBadge').textContent = total;
      }
      
      allSections.forEach(function(sec) {
        firebase.database().ref('comments/' + sec).on('value', function(snapshot) {
          var count = snapshot.numChildren();
          
          // Check for new comments and show notification
          if(previousCommentCounts[sec] !== undefined && count > previousCommentCounts[sec]) {
            // New comment added - get the latest comment
            var latestComment = null;
            var latestTimestamp = 0;
            snapshot.forEach(function(child) {
              var comment = child.val();
              if(comment.timestamp > latestTimestamp) {
                latestTimestamp = comment.timestamp;
                latestComment = comment;
              }
            });
            
            // Show notification only if it's not from the current user
            if(latestComment && latestComment.userName !== userName) {
              showCommentNotification(sec, latestComment);
            }
          }
          
          // Update previous count
          previousCommentCounts[sec] = count;
          sectionCounts[sec] = count; // Update this section's count
          
          var badge = document.getElementById('badge-' + sec);
          if(badge) {
            if(count > 0) {
              badge.textContent = count;
              badge.style.display = 'flex';
              var btn = document.querySelector('[onclick="openComments(\'' + sec + '\')"]');
              if(btn) btn.classList.add('has-comments');
            } else {
              badge.style.display = 'none';
              var btn = document.querySelector('[onclick="openComments(\'' + sec + '\')"]');
              if(btn) btn.classList.remove('has-comments');
            }
          }
          
          // Update total hub badge
          updateTotalBadge();
        });
      });
      
      // Show comment hub when Daily View tab is active
      var dailyTab = document.getElementById('dailyView');
      if(dailyTab && dailyTab.style.display !== 'none') {
        document.getElementById('commentHubFixed').style.display = 'block';
      }
      
      // Build known users list for @mentions
      allSections.forEach(function(sec) {
        firebase.database().ref('comments/' + sec).on('value', function(snapshot) {
          snapshot.forEach(function(child) {
            var userName = child.val().userName;
            if(userName && knownUsers.indexOf(userName) === -1) {
              knownUsers.push(userName);
            }
          });
        });
      });
    }, 1000);

    </script>

<!-- Comment Panel -->
<div id="commentOverlay" class="comment-overlay" onclick="closeComments()"></div>
<div id="commentPanel" class="comment-panel">
  <div class="comment-header">
    <h3>💬 Comments: <span id="currentSectionName"></span></h3>
    <button class="comment-close" onclick="closeComments()">×</button>
  </div>
  <div id="commentContextBanner" class="comment-context-banner" style="display:none;"></div>
  <div id="commentList" class="comment-list">
    <div class="comment-empty">💬<br>Loading comments...</div>
  </div>
  <div class="comment-input-area">
    <div id="replyHeader" class="comment-reply-header" style="display:none;">
      <span class="reply-to"></span>
      <button onclick="cancelReply()">×</button>
    </div>
    <input type="text" id="commentUserName" placeholder="Your name" maxlength="30">
    <textarea id="commentText" placeholder="Write your comment... (Use @ to mention someone)" maxlength="500"></textarea>
    <button id="submitCommentBtn" onclick="submitComment()">Post Comment</button>
  </div>
</div>

<script>
(function() {
    var LANG_STORAGE_KEY = 'dashboard_lang_pref_v1';
    var TRANS_CACHE_KEY = 'dashboard_zh_cache_v1'; // persisted auto-translations
    var currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'en';
    var textNodeOriginal = new WeakMap();
    var applyLangTimer = null;
    var isApplyingLanguage = false;
    var _i18nQuickMode = false; // when true: skip expensive chart-update step (used for autoTranslate callbacks)
    var _i18nPendingNodes = []; // {node, base} pairs that autoTranslateMissing should patch directly
    var _autoTranslateCache = {};  // strings already requested from API
    var _autoTranslatePending = false;

    var _properNounSet = new Set([
        'Al Ahsa','Dammam','Hafar Albatin','Jubail','Riyadh','Al Kharj',
        'Buraydah','Hail','Jeddah','Madinah','Tabuk','Yanbu',
        'Abha','Jazan','Makkah','Najran','Taif',
        // Month abbreviations kept in English
        'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec',
        'Jan-26','Feb-26','Mar-26','Sep-25','Oct-25','Nov-25','Dec-25','Jan-25'
    ]);

    var zhDict = {
        // ── TAB LABELS ──
        'Executive Summary': '执行摘要',
        'Framework & Methodology': '框架与方法论',
        'Month Overview': '月度概览',
        'Monthly Insights (6 Months Overview)': '月度洞察（6个月概览）',
        'Monthly insights (6 months comparison)': '月度洞察（6个月对比）',
        'Target Adjustment Analysis': '目标调整分析',
        'Future Strategy & Roadmap': '未来战略与路线图',
        'Capacity Achievement "Daily View"': '产能达成「每日视图」',
        // ── HEADER ──
        'Partner Capacity Dashboard': '合作商产能仪表盘',
        'January 2026 vs February 2026 Analysis': '2026年1月 vs 2026年2月分析',
        'Print': '打印',
        'Export CSV': '导出CSV',
        'Refresh Data': '刷新数据',
        // ── DAILY VIEW ──
        'Total Overview': '总览',
        'Partners Stratification': '合作商分层',
        'City Level Data': '城市层级数据',
        'Data synced successfully': '数据同步成功',
        'Fetching data from Google Sheets...': '正在从 Google 表格获取数据...',
        'Syncing with Google Sheets...': '正在与 Google 表格同步...',
        'Failed to sync - using fallback data': '同步失败 - 使用备用数据',
        'Color Legend:': '颜色图例：',
        'Color Legend (GAP %):': '颜色图例（GAP %）：',
        'Overall Performance Summary': '整体表现汇总',
        'Metric': '指标',
        'Online Riders': '在线骑手',
        'Delivery Riders': '配送骑手',
        'Number of Partners': '合作商数量',
        'Achievement %': '达成率 %',
        'Achievement Rate': '达成率',
        'Gap': '差距',
        'GAP % (Del vs Capacity)': 'GAP %（配送 vs 容量）',
        'Expand Daily View': '展开每日视图',
        'Collapse Daily View': '收起每日视图',
        'Daily Trend Chart': '每日趋势图',
        'Daily Achievement Trend Chart': '每日达成率趋势图',
        'City Comparison Chart': '城市对比图',
        'Best City': '最佳城市',
        'Worst City': '最弱城市',
        'Cities Tracked': '追踪城市数',
        'Across KSA': '覆盖沙特全境',
        'MTD Achievement': '月累计达成',
        'W1 Performance': 'W1 表现',
        'W2 Performance': 'W2 表现',
        'Total GAP': '总差距',
        'Riders | Online vs Del': '骑手 | 在线 vs 配送',
        'Target:': '目标：',
        'Good Partners': '优质合作商',
        'Average Partners': '中等合作商',
        'Bad Partners': '待改善合作商',
        'Increase >20': '增长 >20',
        'Increase 10-20': '增长 10-20',
        'Increase 1-10': '增长 1-10',
        'Others (≤0)': '其他（≤0）',
        'Others (<=0)': '其他（<=0）',
        'Filter:': '筛选：',
        'T1 Cities': 'T1 城市',
        'T2 Cities': 'T2 城市',
        'View All Comments': '查看全部评论',
        'Add Comment': '添加评论',
        'Comments:': '评论：',
        'Write your comment... (Use @ to mention someone)': '输入评论...（使用 @ 提及成员）',
        'Your name': '你的姓名',
        'Post Comment': '发布评论',
        'WoW': '周环比',
        'DoD': '日环比',
        'Declining trend': '下降趋势',
        'achievement rate ≥100%': '达成率 ≥100%',
        'achievement rate >=95% - <100%': '达成率 >=95% - <100%',
        'achievement rate >=90% - <95%': '达成率 >=90% - <95%',
        'achievement rate >=80% - <90%': '达成率 >=80% - <90%',
        'achievement rate <80%': '达成率 <80%',
        // ── EXECUTIVE SUMMARY ──
        'February 2026 Partner Capacity Analysis': '2026年2月合作商产能分析',
        'High-Level Management View': '管理层高层视图',
        'MoM Change': '月环比变化',
        'Total Riders': '骑手总数',
        'Active Partners': '活跃合作商',
        'Total Riders (Feb)': '骑手总数（2月）',
        'Partners with Target': '有目标的合作商',
        'of 643 total partners': '共643个合作商',
        'Avg Target/Partner': '平均目标/合作商',
        'Stable vs January': '较1月保持稳定',
        'New Partners': '新合作商',
        '17 out of assessment': '17家完成评估',
        'Zero-Target Partners': '零目标合作商',
        '3 Term, 70 Phased, 19 No Jan': '3家终止，70家分阶段，19家无1月',
        '↓ 17.5% capacity vs Jan': '↓较1月产能降低17.5%',
        '↓ 3,088 from Jan (22,453)': '↓较1月（22,453）减少3,088',
        'February 2026 Capacity Strategy': '2026年2月产能策略',
        'Re-balancing:': '再平衡：',
        'Strategic redistribution, not uniform cuts': '战略性重新分配，非统一削减',
        'Overall Reduction:': '整体降幅：',
        '13.8% below Jan (-3,088 riders)': '低于1月13.8%（-3,088名骑手）',
        'Headcount Alignment:': '人员编制调整：',
        'Restructure base for high avg scale': '重构基础以提升平均规模',
        'FR% Primary Gate:': 'FR%主要门槛：',
        'Low FR = no growth; severe = zero target': '低FR=不增长；严重=零目标',
        'Performance-Based:': '绩效导向：',
        'Quality + scale → allocation': '质量+规模→分配',
        'New Partner Protection:': '新合作商保护：',
        'Shield new partners from sharp cuts': '保护新合作商免受大幅削减',
        'Primary Gate': '主要门槛',
        'Zero Target': '零目标',
        'Positive Highlights': '积极亮点',
        'Bad Partners ↓72.6%:': '待改善合作商↓72.6%：',
        'Dropped from 73 → 20 partners': '从73家降至20家',
        'Average Partners Stable:': '中等合作商稳定：',
        '262 partners at 8,414 riders (+1.0%)': '262家合作商，8,414名骑手（+1.0%）',
        'Avg Target Held:': '平均目标保持：',
        '35.1 riders/partner despite reduction': '尽管削减仍维持35.1名骑手/合作商',
        'Quality Improvement:': '质量提升：',
        'Portfolio mix shifting toward compliance': '组合结构向合规方向转变',
        'Avg Partners': '中等合作商',
        'Avg Target': '平均目标',
        'Concerns & Risks': '关注点与风险',
        'Overall Decline:': '整体下滑：',
        'Total capacity down 13.8% (-3,088)': '总产能下降13.8%（-3,088）',
        'Good Partners Down:': '优质合作商下降：',
        'target reduction by 6.6%': '目标削减6.6%',
        'Zero-Target Impact:': '零目标影响：',
        '70 partners phased partners with no allocation (Impact on partner experience)': '70家合作商分阶段停止分配（影响合作商体验）',
        'Capacity Contraction:': '产能收缩：',
        'Fleet size reduction pressure': '车队规模压缩压力',
        'Good Cap.': '优质产能',
        'Q1 2026 Success Targets': 'Q1 2026成功目标',
        'Avg riders/partner:': '平均骑手/合作商：',
        'Raise from ~33 to ≥45': '从约33提升至≥45',
        'Stability:': '稳定性：',
        'Lock 3-month bands; ≥70% peak retention': '锁定3个月波段；≥70%高峰保留率',
        'CPO impact:': 'CPO影响：',
        '≥0.39 SAR/order reduction': '≥0.39沙特里亚尔/订单降低',
        'Controls:': '管控：',
        'SOP + maker/checker; -10% manual adj.': 'SOP+制作/核查；-10%人工调整',
        'Mix shift:': '结构转变：',
        'Good 58-60%; Bad 5%; add driver card': '优质58-60%；待改善5%；增加司机卡',
        'Compliance:': '合规性：',
        'FR 98-100% by March': '3月前FR达98-100%',
        'Scale top:': '规模提升：',
        '≥20 partners to ≥150 riders': '≥20家合作商达到≥150名骑手',
        'Good Share': '优质占比',
        'FR Target': 'FR目标',
        'Strategy Logic:': '战略逻辑：',
        // ── FRAMEWORK & METHODOLOGY ──
        'How monthly capacity targets are built, protected, and aligned.': '每月产能目标如何建立、保护和校准。',
        'Model: Multi-layer rules': '模型：多层规则',
        'Cycle: Jan -> Feb': '周期：1月→2月',
        'Signals: Perf + FR + Ops': '信号：绩效+FR+运营',
        'Background': '背景',
        'Context (Feb 2026)': '背景（2026年2月）',
        'Stabilize good partners, reduce more from average/bad, protect new partners, and allow limited PMM exceptions.': '稳定优质合作商，进一步削减中等/待改善，保护新合作商，允许有限PMM例外。',
        'Challenges': '挑战',
        'Strategic Goals': '战略目标',
        'Demand Coverage': '需求覆盖',
        'Quality & Compliance': '质量与合规',
        'Risk Mitigation': '风险缓解',
        'Budget Adherence': '预算遵守',
        'Model Layers': '模型层次',
        'Calculation Flow (Feb)': '计算流程（2月）',
        'For more info about the rules check out this link': '更多规则信息请查看此链接',
        'Capacity target rules details': '产能目标规则详情',
        'Short, auditable path from Jan baseline to Feb targets': '从1月基线到2月目标的简短可审计路径',
        'Start Point': '起始点',
        'Jan final target per partner serves as the baseline for Feb calculations.': '每个合作商1月最终目标作为2月计算基线。',
        'Base Multipliers': '基础乘数',
        'Performance, FR%, and ops factors reduce low performers and protect high performers.': '绩效、FR%和运营因素降低低绩效并保护高绩效。',
        'Protected Partners': '受保护合作商',
        'Term & Warnings': '终止与警告',
        'FR% Fine-Tune': 'FR%微调',
        'Apply FR% slabs by performance tier to fine-tune output and reward compliance.': '按绩效层级应用FR%档次微调输出并奖励合规。',
        'Manual Override': '人工覆盖',
        'PMM/ops exceptions for contracts, launches, staffing, or data issues.': 'PMM/运营针对合同、上线、人员或数据问题的例外。',
        'Align to Feb Plan': '与2月计划对齐',
        'Scale to Feb national total, then apply city-level scaling factors.': '扩展至2月全国总量，然后应用城市级别缩放因子。',
        'Compliance Blocked Riders': '合规封锁骑手',
        'Waiting for final list from compliance team. PMMs confirm recovery plans; actions follow on flagged risks. Critical for maintaining fleet quality standards.': '等待合规团队最终名单。PMM确认恢复计划；对标记风险采取行动。对维护车队质量标准至关重要。',
        'Driver Card Slab': '司机卡档次',
        'Not a core factor (overall rate 40.5%). Used to keep targets stable with smaller cuts for good/average partners >80%. Ensures compliance-ready capacity.': '非核心因素（整体比率40.5%）。用于对优质/中等合作商>80%进行较小削减以保持目标稳定。确保合规就绪产能。',
        'Model Structure': '模型结构',
        'Flexibility': '灵活性',
        'Monthly tuning of coefficients and thresholds keeps alignment with CPO, service, and partner mix goals. Adapts to market conditions.': '对系数和阈值的每月调整保持与CPO、服务和合作商结构目标的一致性。适应市场条件。',
        'Governance': '治理',
        'Manual overrides are limited and audited to keep results consistent and defensible. SOP + maker/checker ensures accountability.': '人工覆盖受到限制和审计，以保持结果一致性和可辩护性。SOP+制作/核查确保问责制。',
        'Audit Trail': '审计跟踪',
        'Maker/Checker': '制作/核查',
        'Monthly Tuning': '月度调整',
        'CPO Alignment': 'CPO对齐',
        'Adaptive': '自适应',
        'Baseline': '基线',
        'Protection': '保护',
        // ── FUTURE STRATEGY ──
        'Planning Horizon': '规划时间跨度',
        'Next Implementation Phase:': '下一实施阶段：',
        'February 2026 or Post-Ramadan (depending on timing)': '2026年2月或斋月后（视时机而定）',
        '1. Refine Logic & Factors': '1. 优化逻辑与因素',
        'Adjust performance and FR thresholds based on January results': '根据1月结果调整绩效和FR阈值',
        'Fine-tune coefficients using real performance data': '使用真实绩效数据微调系数',
        'Optimize balance between quality gates and growth targets': '优化质量门槛与增长目标之间的平衡',
        '2. City-Tier Minimums & Order Targets': '2. 城市层级最低值与订单目标',
        'Set differentiated minimum targets per city tier (T1 vs T2)': '为每个城市层级设定差异化最低目标（T1 vs T2）',
        'Ensure city-level capacity aligns with demand': '确保城市级产能与需求对齐',
        'Balance service level requirements with budget constraints': '平衡服务水平要求与预算限制',
        '3. Partner Willingness & Commitment': '3. 合作商意愿与承诺',
        'Introduce PMM-recorded partner willingness sheet': '引入PMM记录的合作商意愿表',
        'Track recruitment plans and fleet investment commitments': '跟踪招募计划和车队投资承诺',
        'Integrate as model signal post-Ramadan (when demand stabilizes)': '斋月后作为模型信号整合（需求稳定时）',
        '4. Long-Term Strategic Partnerships': '4. 长期战略合作关系',
        'Share capacity targets 2–3 months in advance for key partners': '提前2-3个月与关键合作商分享产能目标',
        'Enable early hiring and operational planning': '支持提前招聘和运营规划',
        'Build longer-term, win-win partnership relationships': '建立更长期、互利共赢的合作关系',
        '5. Partner Retention Focus (Critical Priority)': '5. 合作商留存重点（关键优先项）',
        'Prevent loss of good, compliant partners due to unrealistic capacity reductions': '防止因不切实际产能削减而流失优质合规合作商',
        'Protection Strategies': '保护策略',
        'Provide reasonable, profitable targets for quality partners': '为优质合作商提供合理、有利润的目标',
        'Ensure targets support sustainable partner economics': '确保目标支持可持续合作商经济',
        'Regular follow-up on partner concerns and feedback': '定期跟进合作商关切和反馈',
        'Quick resolution of operational blockers': '快速解决运营障碍',
        'Success Metrics': '成功指标',
        'Partner satisfaction and engagement levels': '合作商满意度和参与度',
        'Retention rate of "Good" performing partners': '"优质"绩效合作商留存率',
        'Partner profitability and earning potential': '合作商盈利能力和创收潜力',
        'Long-term partnership commitment indicators': '长期合作承诺指标',
        'Implementation Timeline': '实施时间表',
        'Phase 1: Immediate': '第1阶段：立即',
        'Logic refinement': '逻辑优化',
        'Partner retention focus': '合作商留存重点',
        'Phase 2: Post-Ramadan': '第2阶段：斋月后',
        'City-tier targets': '城市层级目标',
        'Willingness tracking': '意愿跟踪',
        'Phase 3: Long-term': '第3阶段：长期',
        'Strategic partnerships': '战略合作关系',
        'Advance planning (2-3 months)': '提前规划（2-3个月）',
        'Strategic Outcomes': '战略成果',
        'By implementing these initiatives, we aim to achieve:': '通过实施这些举措，我们旨在实现：',
        'Enhanced Predictability:': '增强可预测性：',
        'Partners can plan ahead with confidence': '合作商可以自信地提前规划',
        'Improved Retention:': '改善留存率：',
        'Keep quality partners engaged and profitable': '保持优质合作商的参与度和盈利能力',
        'Better Alignment:': '更好对齐：',
        'Partner capacity matches actual demand and capability': '合作商产能与实际需求和能力相匹配',
        'Stronger Partnerships:': '更强合作关系：',
        'Move from transactional to strategic relationships': '从交易性关系转向战略性关系',
        'Operational Excellence:': '卓越运营：',
        'Right capacity, right place, right time': '正确的产能，正确的地点，正确的时间',
        // ── MONTHLY INSIGHTS ──
        'Sep 2025 – Feb 2026 Structure (capacity target monthly overview)': '2025年9月-2026年2月结构（产能目标月度概览）',
        'All months': '所有月份',
        "What's inside:": '内容包括：',
        'Overview & Trends': '概览与趋势',
        'KPIs, targets, scale & MoM': '关键指标、目标、规模及月环比',
        'Vehicle Type': '车辆类型',
        'Target split by vehicle': '按车辆类型分割目标',
        'Partner Movement': '合作商变动',
        'Joiners, leavers & net flow': '加入者、离开者及净流量',
        'New vs Old': '新vs旧',
        'Tenure-based contribution': '基于任期的贡献',
        'City Distribution': '城市分布',
        'Allocation across cities': '跨城市分配',
        'Tier City (T1 vs T2)': '城市层级（T1 vs T2）',
        'Tier performance compare': '层级绩效对比',
        'Partner Willingness': '合作商意愿',
        'Sentiment & growth intent': '情绪与增长意向',
        'Monthly Overview & Trends': '月度概览与趋势',
        'Active Partners (with target)': '活跃合作商（有目标）',
        'Total Partners': '合作商总数',
        'Total Target': '总目标',
        'Average Scale (riders / active partner)': '平均规模（骑手/活跃合作商）',
        '# Of Partners with target increase in a month (all)': '每月目标增加的合作商数量（全部）',
        'MoM change (Increase all)': '月环比变化（全部增加）',
        'Monthly trend: Total Target & Total Partners': '月度趋势：总目标与合作商总数',
        'Hover a month to see details.': '悬停月份查看详情。',
        'MoM Change in Total Target (%)': '总目标月环比变化（%）',
        'Monthly Target by Vehicle Type (Cars vs Bikes)': '按车辆类型的月度目标（汽车vs摩托车）',
        'Monthly View': '月度视图',
        'City View': '城市视图',
        'Cars vs Bikes Evolution': '汽车vs摩托车演变',
        'Cars Monthly Trend': '汽车月度趋势',
        'Bikes Monthly Trend': '摩托车月度趋势',
        // ── MONTH OVERVIEW (Business Metrics) ──
        'Business Metrics Dashboard': '业务指标仪表盘',
        'Executive Briefing': '执行简报',
        'Keep Open': '保持展开',
        'Highlights, Lowlights & Notes': '亮点、低点与说明',
        'Key Challenges & Outcomes': '关键挑战与成果',
        'Need to Know': '必知事项',
        'Highlights': '亮点',
        'Lowlights': '低点',
        'Expand ▾': '展开 ▾',
        'Collapse ▴': '收起 ▴',
        'Challenge': '挑战',
        'Solution': '解决方案',
        'Outcome': '结果',
        // ── TARGET ADJUSTMENT ANALYSIS ──
        'Target Adjustment Analysis - February 2026': '目标调整分析 - 2026年2月',
        'Strategic Capacity Reduction via Manual Adjustments': '通过人工调整实现战略性产能削减',
        '61 partners received manual adjustments': '61家合作商接受了人工调整',
        'Given Target': '给定目标',
        'Adjusted Target': '调整后目标',
        'Adjustments (Total capacity moved)': '调整（总移动产能）',
        'Total Capacity Moved': '总移动产能',
        'NET CHANGE': '净变化',
        'GIVEN TARGET (BEFORE)': '给定目标（之前）',
        'Algorithmic allocation': '算法分配',
        'ADJUSTED TARGET (AFTER)': '调整后目标（之后）',
        'Manual adjustment': '人工调整',
        'Change Direction': '变化方向',
        '# Of Partners with adjustment': '有调整的合作商数量',
        '% of Total': '占总数百分比',
        'Total Capacity': '总产能',
        'Avg Change per Partner': '每合作商平均变化',
        '📈 Target Increases': '📈 目标增加',
        '📉 Target Decreases': '📉 目标减少',
        '➡️ No Change': '➡️ 无变化',
        'Capacity Addition': '产能增加',
        'Capacity Reduction': '产能削减',
        'Given Target vs Adjusted Target - Deep Dive': '给定目标 vs 调整后目标 - 深入分析',
        'Target Allocation Comparison': '目标分配对比',
        'City-Level Adjustment Analysis': '城市级调整分析',
        'City': '城市',
        'TOP REDUCTION REASON': '首要削减原因',
        'STRATEGIC ALLOCATIONS': '战略分配',
        'Driver Card Compliance Crisis': '司机卡合规危机',
        'Driver card issues as the dominant factor': '司机卡问题为主导因素',
        // ── COMMON TABLE / UI LABELS ──
        'Target': '目标',
        'Riders': '骑手',
        'Partners': '合作商',
        'Capacity': '产能',
        'Allocation': '分配',
        'Performance': '绩效',
        'Compliance': '合规',
        'Growth': '增长',
        'Reduction': '削减',
        'MoM': '月环比',
        'Status': '状态',
        'Overall': '整体',
        'Stable': '稳定',
        'Excellent': '优秀',
        'Warning': '预警',
        'Critical': '严重',
        'Good': '良好',
        'Average': '中等',
        'Scale': '规模',
        'Size': '规模',
        'Trend %': '趋势 %',
        'Trend': '趋势',
        'Comparison': '对比',
        'Willing vs Not': '意愿与非意愿',
        'Increase': '增加',
        'Decrease': '减少',
        'Partners Share (Performance & Size)': '合作商份额（绩效 & 规模）',
        'Total Target Share (Performance & Size)': '总目标份额（绩效 & 规模）',
        'Avg Riders per Partner': '每合作商平均骑手数',
        'New Partners': '新合作商',
        'Total': '总计',
        'Click to view detailed data table ▼': '点击查看详细数据表 ▼',
        'Click to view detailed data ▼': '点击查看详细数据 ▼',
        '▼ Click to view detailed data table ▼': '▼ 点击查看详细数据表 ▼',
        '▼ Click to view detailed data ▼': '▼ 点击查看详细数据 ▼',
        'Prev': '上一月',
        'Next': '下一月',
        'SOP': '标准操作程序',
        'Controls': '管控',
        'Monthly Insights (6 months comparison)': '月度洞察（6个月对比）',

        // ── SECTION SLICER BAR ──
        'Jump to section:': '跳转至：',
        '📈 Performance Breakdown': '📈 绩效分解',
        '📌 Performance & Scale Summary': '📌 绩效与规模汇总',
        '📊 FR & Driver Card Compliance': '📊 FR与司机卡合规',
        '🏙️ City Tier Performance': '🏙️ 城市层级绩效',
        '🎯 Target Movement Analysis': '🎯 目标变动分析',
        '📌 Top & Bottom Partners Overview': '📌 头尾部合作商概览',
        '✅ February 2026 Success Metrics': '✅ 2026年2月成功指标',
        '📊 Monthly Overview & Trends': '📊 月度概览与趋势',
        '🚗🏍️ Vehicle Type Breakdown': '🚗🏍️ 车辆类型分解',
        '📊 Partner Movement Analysis': '📊 合作商变动分析',
        '👥 New vs Old Partners Analysis': '👥 新旧合作商分析',
        '🏙️ City-wise Target Distribution': '🏙️ 城市目标分布',
        '📊 Tier City Overview (T1 vs T2)': '📊 层级城市概览（T1 vs T2）',
        '📊 Partner Willing Analysis': '📊 合作商意愿分析',

        // ── KEY SECTION HEADERS ──
        'Performance Breakdown': '绩效分解',
        'Performance & Scale Summary (Jan vs Feb)': '绩效与规模汇总（1月 vs 2月）',
        'FR & Driver Card Compliance Analysis': 'FR与司机卡合规分析',
        'Top & Bottom Partners Overview (Jan vs Feb)': '头尾部合作商概览（1月 vs 2月）',
        'Target Movement Analysis (Partners)': '目标变动分析（合作商）',
        'Rider Slab Distribution (Jan vs Feb)': '骑手档次分布（1月 vs 2月）',
        'City Tier Performance Analysis (Jan vs Feb)': '城市层级绩效分析（1月 vs 2月）',
        'February 2026 Success Metrics': '2026年2月成功指标',
        'Partner Movement Analysis (Increase / Decrease / No Change) — click to expand/collapse': '合作商变动分析（增加/减少/无变化）— 点击展开/收起',
        'New vs Old Partners Analysis (by Partner Age) — click to expand/collapse': '新旧合作商分析（按合作商年龄）— 点击展开/收起',

        // ── CARD LABELS (Month Overview) ──
        'Good Perf.': '良好绩效',
        'Avg Perf.': '平均绩效',
        'Avg FR / DC %': '平均FR / DC%',
        'MoM Partners': '月环比合作商',
        'Net Movement': '净变动',
        'Increased': '目标增加',
        'Decreased': '目标减少',
        'No Change': '无变化',
        'Increase Partners': '增加合作商',
        'Decrease Partners': '减少合作商',
        'Partners with Target': '有目标的合作商',
        'Total Target': '总目标',
        'Avg Scale': '平均规模',
        'Delivery Riders': '配送骑手',
        'Small Scale': '小规模',
        'Mid Scale': '中规模',
        'Large Scale': '大规模',
        'Peak Slab': '峰值档次',
        'Partners with target in Feb.': '2月有目标的合作商',
        'partners with target in Feb': '2月有目标的合作商',
        'of 551 partners with target in Feb': '551家合作商中有目标在2月',
        'Total partners with active capacity target in Feb. Tracks overall partner base.': '2月具有有效产能目标的合作商总数。追踪整体合作商基数。',
        'Total capacity target value in Feb. Shows overall target volume.': '2月总产能目标值。展示整体目标规模。',
        'Average scale per partner in Feb. Measures capacity density.': '2月每合作商平均规模。衡量产能密度。',
        'Delivery riders across all partners in Feb. Tracks rider availability.': '2月所有合作商的配送骑手数。追踪骑手可用性。',

        // ── BUTTONS / VIEW OPTIONS ──
        'View:': '视图：',
        'Total with Target': '含目标总计',
        'Increased Target': '目标增加',
        'Decreased Target': '目标减少',
        'Top 20 Biggest Partners': '前20大合作商',
        'Bottom 20 Smallest Partners': '后20小合作商',
        'Top 20 Ranked Partners': '前20排名合作商',
        'Compliance Distribution': '合规分布',
        'Target Range Impact': '目标范围影响',
        'City-wise Analysis': '城市分析',
        'Breakdown': '分解',
        'Total Increased': '总增加',
        'Total Decreased': '总减少',
        'Filter by:': '筛选：',
        'All Partners': '全部合作商',
        'All Partners with Performance': '含绩效的全部合作商',
        'Compare Months:': '对比月份：',
        'All vs With Target': '全部 vs 有目标',
        'new vs old': '新 vs 旧',
        'New vs Old': '新 vs 旧',
        'Collapsed': '已收起',
        'Pinned Open': '已固定展开',
        '■ PINNED': '■ 已固定',
        '● AUTO': '● 自动',
        'FR Rate Distribution': 'FR比率分布',
        'Driver Card Rate Distribution': '司机卡比率分布',
        'Face Recognition (FR) Rate - All Partners vs Partners with Target': '面部识别（FR）比率 - 全部合作商 vs 有目标合作商',
        'Overall view compares Jan vs Feb totals for partners with target, and splits movement into Increase, Decrease, and No Change so you can see net direction at a glance.': '总览视图对比1月 vs 2月有目标合作商总量，按增加、减少和无变化分解变动，快速感知净方向。',
        'Breakdown view drills into the movement type and shows how Good/Average/Bad segments shifted from Jan to Feb, with MoM labels on Feb values for quick read.': '分解视图深入变动类型，展示优质/中等/待改善细分从1月到2月的变化，2月数值附月环比标签便于阅读。',
        'Total with a target in selected view': '所选视图中有目标的总数',
        'Number of partners shown in selected view': '所选视图中显示的合作商数量',
        'Total target riders across all partners in Feb': '2月所有合作商的目标骑手总数',
        'Partners with Good performance rating in Feb': '2月绩效评级为优质的合作商',
        'Partners with Average performance rating in Feb': '2月绩效评级为中等的合作商',
        'Average Face Recognition Rate / Driver Card % across partners in Feb': '2月合作商的平均面部识别率 / 司机卡比率',
        'Top 20 partners by rider count, showing Jan vs Feb targets, riders, performance, and compliance.': '按骑手数量排序前20合作商，展示1月 vs 2月目标、骑手、绩效及合规情况。',
        'Bottom 20 partners by rider count, highlighting low-scale partners and their Jan vs Feb target movement.': '按骑手数量排序后20合作商，重点展示小规模合作商及其1月 vs 2月目标变动。',
        'Top 20 partners ranked by the highest number of covered cities across the Kingdom, reflecting the widest geographic reach.': '按覆盖城市数量排序前20合作商，反映最广泛的地理覆盖范围。',
        'All partners with a target, shown by riders slab to compare Jan vs Feb distribution.': '所有有目标的合作商，按骑手档次展示以对比1月 vs 2月分布。',
        'Only partners whose targets increased; shows which rider slabs gained the most.': '仅显示目标增加的合作商；展示哪些骑手档次增长最多。',
        'Only partners whose targets decreased; highlights slabs with the biggest declines.': '仅显示目标减少的合作商；重点显示降幅最大的档次。',
        'Partner counts by compliance range for FR/Driver Card.': 'FR/司机卡合规范围内的合作商数量。',
        'Target changes across compliance ranges (Jan → Feb) for FR/Driver Card.': 'FR/司机卡合规范围内目标变化（1月→2月）。',
        'City averages and range distributions with risk highlights.': '城市平均值及范围分布，重点显示风险。',

        // ── TABLE HEADERS ──
        '# of cities': '城市数',
        'New/Old': '新/旧',
        'Total target': '总目标',
        'MoM % (Target)': '月环比%（目标）',
        'Avg FR %': '平均FR%',
        'Avg Driver Card %': '平均司机卡%',
        'Slab': '档次',
        'Monthly Comparison': '月度比较',
        'Monthly View': '月度视图',
        'Monthly': '月度',
        'Month': '月份',
        'Tier Overview': '层级概览',
        'Performance & Scale Summary': '绩效与规模摘要',
        'FR & Driver Card Compliance': 'FR与司机卡合规率',
        'City Tier Performance': '城市层级绩效',
        'Target Movement Analysis': '目标变动分析',
        'Top & Bottom Partners Overview': '头部与尾部合作商概览',
        'Tier City Overview': '层级城市概览',
        'Avr scale overview': '平均规模概览',
        'Top & Bottom partners with target': '头部与尾部有目标合作商',
        'Monthly trend: Total Target & Total Partners': '月度趋势：总目标与合作商总数',
        'Monthly trend: Average Scale': '月度趋势：平均规模',
        'Average Scale by Performance Level': '按绩效等级划分的平均规模',
        'Average Scale by Size Level': '按规模等级划分的平均规模',
        'Partners performance mix (Good / Average / Bad)': '合作商绩效构成（良好 / 中等 / 待改善）',
        'Partners size mix (Big / Mid / Small)': '合作商规模构成（大 / 中 / 小）',
        'Total Riders Share by Performance Level (Good / Average / Bad)': '按绩效等级划分的骑手总量份额（良好 / 中等 / 待改善）',
        'Total Riders Share by Size Level (Big / Mid / Small)': '按规模等级划分的骑手总量份额（大 / 中 / 小）',
        '⭐ Share by Quality': '⭐ 按质量分配',
        'Capacity Allocation:': '产能分配：',
        'Total Increase': '总增加',
        'Total Decrease': '总减少',
        'No change': '无变化',
        'Subtotal': '小计',
        'Total With Target': '含目标总计',
        'Partner': '合作商',
        '#': '#',

        // ── CHART TITLES ──
        'Partner Capacity Changes': '合作商产能变化',
        'Quality Distribution by Movement Type': '按变动类型的质量分布',
        'Partner Movement by Type (Trend)': '按类型的合作商变动（趋势）',
        'Partners with Increased Target by Riders Slab Distribution': '目标增加合作商的骑手档次分布',
        'Partners with Decreased Target by Riders Slab Distribution': '目标减少合作商的骑手档次分布',
        'Feb Target vs After Manual Adjustment (Good / Average / Bad Partners)': '2月目标 vs 人工调整后（优质/中等/待改善合作商）',
        'Riders Slab Distribution (Jan vs Feb)': '骑手档次分布（1月 vs 2月）',
        'Partner Performance Breakdown - Willingness by Target Size': '合作商绩效分解 - 按目标规模的意愿',
        'Final Capacity Target — Our Rules vs Last Month Achievement (Performance breakdown)': '最终产能目标 — 规则 vs 上月达成（绩效分解）',
        'Movement Distribution - All Partners': '变动分布 - 全部合作商',
        'Quality Distribution - All Partners': '质量分布 - 全部合作商',
        'Partners with Increased Target': '目标增加的合作商',
        'Partners with Decreased Target': '目标减少的合作商',
        'Partners with Same Target': '目标不变的合作商',
        'Partners with Increases': '目标增加合作商',
        'Partners with Decreases': '目标减少合作商',
        'Active Partner Count': '活跃合作商数',

        // ── CHART NOTES & DESCRIPTION PARAGRAPHS ──
        'Distribution of 551 partners with active targets showing capacity direction: increases, unchanged, or decreases vs previous month.': '551家有效目标合作商的分布，展示产能方向：与上月相比增加、不变或减少。',
        'Capacity targets for partners by performance segment (Good / Average / Bad) before and after PMM manual adjustments; shows how manual overrides impacted our rule-based targets.': '按绩效分段（优质/中等/待改善）的合作商产能目标，含PMM人工调整前后；展示人工覆盖对规则目标的影响。',
        'Track partner target capacity movements: partners who increased, decreased, or maintained their targets across 6 months. Segmented by quality performance (Good ≥80% FR, Average 50-80% FR, Bad <50% FR).': '追踪合作商目标产能变动：6个月内增加、减少或维持目标的合作商，按质量绩效分段（优质≥80% FR，中等50-80% FR，待改善<50% FR）。',
        'Analyze partner composition by tenure: newly onboarded (<1 month), recently added (<3 months), and established (>3 months). Compare capacity (Target), engagement (Active Count), scale efficiency (Avg Scale), and quality breakdown across all 6 months. Green/Red arrows show month-over-month trends.': '按任期分析合作商构成：新加入（<1个月）、近期加入（<3个月）和成熟合作商（>3个月）。对比6个月内的产能（目标）、参与度（活跃数量）、规模效率（平均规模）及质量分解。绿色/红色箭头显示月环比趋势。',
        'Note: MoM% shown on Feb values. Bars: Jan vs Feb comparison.': '说明：月环比%显示在2月数值上。柱形图：1月 vs 2月对比。',
        'Filter by period, performance, or scale to view avg scale & capacity breakdown. Overall avg scale is always included.': '按时段、绩效或规模筛选以查看平均规模和产能分解。整体平均规模始终包含。',
        '🧭 Filter by period, performance, or scale to view avg scale & capacity breakdown. Overall avg scale is always included.': '🧭 按时段、绩效或规模筛选以查看平均规模和产能分解。整体平均规模始终包含。',
        'ℹ️ Note: Table shows partners who completed assessment during each month. Partners without assessment data (new sign-ups, incomplete metrics) are excluded from these numbers.': 'ℹ️ 说明：表格显示每月完成评估的合作商。没有评估数据的合作商（新注册、指标不完整）不计入此数据。',
        '📋 View Detailed Movement Table — click to expand': '📋 查看详细变动表 — 点击展开',
        '📋 Note: Table compares Jan vs Feb per partner. MoM% shown for Total Target only. Total target reflects riders across all covered cities. Performance is based on highest-target city. FR & Driver Card rates are averaged across cities.': '📋 说明：表格按合作商对比1月 vs 2月。月环比%仅适用于总目标。总目标反映所有覆盖城市的骑手数。绩效基于最高目标城市。FR和司机卡比率按城市平均。',
        '📋 Overview: Analyze partner distribution by Face Recognition (FR) and Driver Card compliance rates across all segments.': '📋 概述：按面部识别（FR）和司机卡合规率分析各细分的合作商分布。',
        '(Data updated till 25th Feb 2026)': '（数据更新至2026年2月25日）',
        'Compliance Distribution': '合规分布',

        // ── FR/DC SECTION LABELS ──
        'AVG FR RATE': '平均FR比率',
        'AVG DC RATE': '平均DC比率',
        'All / With Target': '全部 / 有目标',
        'FR Rate Distribution': 'FR比率分布',
        'Driver Card Rate Distribution': '司机卡比率分布',
        'All (643)': '全部（643）',
        'New (158)': '新（158）',
        'Old (485)': '旧（485）',
        'All (551)': '全部（551）',
        'New (127)': '新（127）',
        'Old (424)': '旧（424）',
        'All (534)': '全部（534）',
        'Good (252)': '优质（252）',
        'Bad (20)': '待改善（20）',

        // ── LEGEND / CHART LABELS ──
        'Increased': '增加',
        'Decreased': '减少',
        'No Change': '无变化',
        'Good Partners Only': '仅优质合作商',
        'Average Partners Only': '仅中等合作商',
        'Bad Partners Only': '仅待改善合作商',

        // ── COLLAPSED SECTION HEADERS (section headings that show when collapsed) ──
        '📌 Performance & Scale Summary (Jan vs Feb)': '📌 绩效与规模汇总（1月 vs 2月）',
        '📌 Rider Slab Distribution (Jan vs Feb)': '📌 骑手档次分布（1月 vs 2月）',
        '📌 Top & Bottom Partners Overview (Jan vs Feb)': '📌 头尾部合作商概览（1月 vs 2月）',
        '📊 FR & Driver Card Compliance Analysis': '📊 FR与司机卡合规分析',
        '🎯 Target Movement Analysis (Partners)': '🎯 目标变动分析（合作商）',
        '🏙️ City Tier Performance Analysis (Jan vs Feb)': '🏙️ 城市层级绩效分析（1月 vs 2月）',
        '✅ February 2026 Success Metrics': '✅ 2026年2月成功指标',

        // ── MONTHLY SLICER BUTTONS (additional entries) ──
        'Monthly Overview & Trends': '月度概览与趋势',
        'Vehicle Type Breakdown': '车辆类型分解',
        'Partner Movement Analysis': '合作商变动分析',
        'New vs Old Partners Analysis': '新旧合作商分析',
        'City-wise Target Distribution': '城市目标分布',
        'Tier City Overview (T1 vs T2)': '层级城市概览（T1 vs T2）',
        'Partner Willing Analysis': '合作商意愿分析',
        'Highlights & takeaways (selected month)': '亮点与收获（所选月份）',

        // ── FRAMEWORK TAB extras ──
        'Targets are built monthly to match demand, protect quality, and keep partner capacity healthy using performance and compliance signals.': '每月根据需求、质量保护和合作商合规绩效信号构建目标。',
        'Upfront Alignment & PMM Ownership': '前期对齐与PMM所有权',
        'Pre-cycle session → Share wiki:': '周期前会议 → 分享维基：',
        'Target rules & logic': '目标规则与逻辑',
        'Stratification metrics & criteria': '分层指标与标准',
        'Examples & common cases': '示例与常见案例',
        'After alignment → PMM authority:': '对齐后 → PMM权限：',
        'without pre-approval': '无需预先审批',
        'Real Example — Push-back on removing a good partner\'s target': '真实案例 — 拒绝取消优质合作商目标的请求',
        'Purpose:': '目的：',
        'Result:': '结果：',
        'Rule:': '规则：',
        'PMMs need valid proof (screenshot/record) to remove any target.': 'PMM需要有效证明（截图/记录）才能移除目标。',
        'Eliminate decisions not backed by data.': '消除无数据支撑的决策。',
        'Adjustments drop — all exceptions are controlled & traceable.': '调整减少——所有例外均受控且可追溯。',

        // ── SUCCESS METRICS TOOLTIPS / LABELS ──
        'Performance Breakdown: Toggle between Capacity Target & Avg Scale, and Next Month Target to review achievement, gaps, % by segment, and strategic planning.': '绩效分解：在产能目标与平均规模、下月目标之间切换，查看达成率、差距、细分占比及战略规划。',

        // ── MONTH OVERVIEW — MISSING TRANSLATIONS (Round 4) ──
        // Card labels (overview section)
        'Net Manual Impact': '净人工调整影响',
        'Largest Segment Shift': '最大细分变动',

        // View tab buttons (Perf & Scale Summary section)
        'Avg Scale & Capacity Summary': '平均规模与产能摘要',
        'Performance & Scale Breakdown': '绩效与规模分解',
        'Performance Target Breakdown': '绩效目标分解',
        '🚗 Vehicle Type Breakdown': '🚗 车辆类型分解',

        // Period / Perf / Scale filter buttons
        'New <1M': '新 <1月',
        'New <3M': '新 <3月',
        'Old >3M': '旧 >3月',
        'Bad': '待改善',
        'Big': '大型',
        'Mid': '中型',
        'Small': '小型',
        'Period:': '时段：',

        // Riders view sub-toggle buttons
        'Riders breakdown & Avg Scale': '骑手分解与平均规模',
        'Riders breakdown': '骑手分解',

        // PS Summary table row labels
        'Total partners with target': '有目标合作商总数',
        'Total capacity target': '总产能目标',
        'Avg scale per partner': '每合作商平均规模',
        'Delivery riders all partners': '全部合作商配送骑手',
        'Delivery riders partners with target': '有目标合作商配送骑手',
        'Delivery rider avg scale (Total active)': '配送骑手平均规模（全部活跃）',
        'Delivery rider avg scale (Partners with target)': '配送骑手平均规模（有目标合作商）',
        'Online riders all partners': '全部合作商在线骑手',
        'Online riders partners with target': '有目标合作商在线骑手',
        'Online riders avg scale (Total active)': '在线骑手平均规模（全部活跃）',
        'Online riders avg scale (Partners with target)': '在线骑手平均规模（有目标合作商）',

        // Chart dataset labels
        'Capacity Target': '产能目标',
        'Delivery Riders (with target)': '配送骑手（有目标）',
        'Online Riders (with target)': '在线骑手（有目标）',
        'Feb target (our rule)': '2月目标（规则）',
        'Feb target (after manual adjustment)': '2月目标（人工调整后）',
        'Manual variance (After - Rule)': '人工差异（调整后 - 规则）',

        // Success Metrics toggle buttons
        'Capacity Target & Avg Scale': '产能目标与平均规模',
        '🎯 Next Month Target': '🎯 下月目标',
        '📋 2026 OKRs Summary (Not yet ready)': '📋 2026年OKR摘要（尚未就绪）',

        // Success Metrics section headers & KPI labels
        '💡 Key Observations': '💡 关键发现',
        'Key Observations': '关键发现',
        '💡 Strategic Planning Insights': '💡 战略规划洞察',
        'Strategic Planning Insights': '战略规划洞察',
        '📊 Capacity Target': '📊 产能目标',
        '📈 Avg Scale Target': '📈 平均规模目标',
        'Achieved': '已达成',
        'Achievement': '达成率',

        // Success Metrics insights text (static data strings)
        'Average segment exceeded target by +1,129 riders.': '中等细分超目标 +1,129 名骑手。',
        'Good segment is short by -608 riders.': '优质细分短缺 -608 名骑手。',
        'Bad segment is significantly below target with a -582 rider gap.': '待改善细分大幅低于目标，差距 -582 名骑手。',
        'Overall avg scale is below target by -0.9.': '整体平均规模低于目标 -0.9。',
        'Good segment is below target by -4.': '优质细分低于目标 -4。',
        'Average and Bad segments exceeded targets.': '中等和待改善细分超过目标。',

        // Dynamic insight sub-texts (overview section JS-set values)
        '-1% vs rule target total': '-1%（vs 规则目标总量）',
        'of 551 partners with target': '551家有目标合作商',
        '+131 more than increases': '+131 多于增加数',
        '+157% while Good fell 4%': '+157%，优质降4%',

        // Note trailing-text fragments (after <strong> in mixed-content notes)
        ' Table compares Jan vs Feb per partner. MoM% shown for Total Target only. Total target reflects riders across all covered cities. Performance is based on highest-target city. FR & Driver Card rates are averaged across cities.': ' 表格按合作商对比1月 vs 2月。月环比%仅适用于总目标。总目标反映所有覆盖城市的骑手数。绩效基于最高目标城市。FR和司机卡比率按城市平均。',
        ' Toggle between Capacity Target & Avg Scale, and Next Month Target to review achievement, gaps, % by segment, and strategic planning.': ' 在产能目标与平均规模和下月目标之间切换，查看达成率、差距、细分占比及战略规划。',
        'Next Month Target': '下月目标',

        // PS Breakdown data row labels
        'Total partners count': '合作商总数',
        'Total active partners count': '活跃合作商总数',
        'Target total': '目标总量',
        'Avg scale': '平均规模',
        'Good partners with target': '有目标优质合作商',
        'Good partners target': '优质合作商目标',
        'Good partners avg scale': '优质合作商平均规模',
        'Average partners with target': '有目标中等合作商',
        'Average partners target': '中等合作商目标',
        'Average partners avg scale': '中等合作商平均规模',
        'Bad partners with target': '有目标待改善合作商',
        'Bad partners target': '待改善合作商目标',
        'Bad partners avg scale': '待改善合作商平均规模',

        // ── MANUAL ADJUSTMENT SUMMARY SECTION ──
        'Net Impact': '净影响',
        'Total Moved': '总计变动',
        'Top Issue': '首要问题',
        'Adjusted Partners': '调整后合作商',
        'Net Capacity Change': '净产能变化',
        'Capacity Movement Breakdown': '产能变动分解',
        'Calculation = Added - Reduced': '计算 = 新增 - 减少',
        'month-over-month': '月环比',
        ' month-over-month': ' 月环比',
        'TOP DRIVER': '首要驱动因素',
        'Driver Card Issues': '司机卡问题',
        'Added (41.5%)': '新增（41.5%）',
        'Reduced (58.5%)': '减少（58.5%）',
        ' added - ': ' 新增 - ',
        ' reduced': ' 减少',
        // Manual Adjustment Summary — Pill bar labels (from screenshot)
        'Manual Adjustment Summary - Feb 2026': '人工调整摘要 - 2026年2月',
        'How We Reduced Manual Adjustments — Feb Approach': '我们如何减少人工调整 — 2月方案',

        // ── FINAL CAPACITY TARGET TABLE ──
        'Final Capacity Target — Our Rules vs Last Month Achievement (Performance breakdown)': '最终产能目标 — 规则 vs 上月达成（绩效分解）',
        'Total Delta': '总偏差',
        'Last Month Total': '上月总计',
        'New Month Total': '本月总计',
        'Net Delta': '净偏差',
        'last week active partners': '上周活跃合作商',
        'capacity rules impact': '产能规则影响',
        'latest assessment': '最新评估',
        ' Target is assigned only to': ' 目标仅分配给',
        'of the month — inactive partners are excluded.': '（本月）— 非活跃合作商不纳入。',
        ' This table shows the': ' 此表展示了',
        'on target assignment per performance level (Good, Average, Bad).': '对各绩效级别（良好、中等、待改善）的目标分配影响。',
        'Targets are based on each partner\'s': '目标基于每个合作商的',
        '— some partners may have shifted category since last month.': '— 部分合作商自上月以来可能已更换类别。',
        'Category': '类别',
        '# of Partners': '# 合作商',
        'with Target': '有目标',
        'Last Month Final Target': '上月最终目标',
        'New Month Final Target': '本月最终目标',
        'Delta': '偏差',

        // ── KPI CARDS TOP (Month Overview) ──
        'Total Riders': '骑手总数',
        'Active Partners': '活跃合作商',
        'Good Partners': '优质合作商',
        'At-Risk Partners (bad partners)': '高风险合作商（待改善）',
        'Zero-Target Partners': '零目标合作商',
        'Avg Scale per Partner': '每合作商平均规模',
        'Highest Partner Total Capacity': '合作商最高总产能',
        'Highest Partner with Capacity Reduction': '产能削减最多合作商',
        'out of 643 partners': '643家合作商中',
        '3 Terminated': '3家终止',
        '70 Phased Out': '70家分阶段退出',
        '19 No Jan Target': '19家无1月目标',
        'Partners not given target in Feb': '2月未分配目标的合作商',
        'highest net target given to a partner (60 riders)': '合作商最高净目标（60名骑手）',
        'lowest total target given to a partner (10 riders)': '合作商最低总目标（10名骑手）',

        // ── PERFORMANCE BREAKDOWN NOTE ──
        ' The target change shown per category reflects the ': ' 各类别目标变化反映的是',
        'overall capacity reduction': '整体产能削减',
        ', not a per-performance-level adjustment. Partners may have a ': '，而非按绩效级别调整。合作商可能有',
        'different assessment': '不同评估',
        ' month-over-month (e.g. shifted from Good to Average), so the numbers also reflect partner movement across categories.': ' 月环比（例如从良好转为中等），因此数据也反映了跨类别的合作商变动。',

        // ── FR & DRIVER CARD SECTION ──
        'Overview: Shows how FR/Driver Card compliance ranges shift partner targets from Jan 2026 to Feb 2026, split by new (<3 months) and old (\u22653 months) partners.': '概述：展示FR/司机卡合规范围如何影响合作商2026年1月至2月的目标，按新合作商（<3个月）和旧合作商（≥3个月）拆分。',
        'Partners Overview': '合作商概况',
        'Target Movement': '目标变动',
        'FR Range Impact': 'FR范围影响',
        'Driver Card Range Impact': '司机卡范围影响',
        'New vs Old partners (count)': '新vs旧合作商（数量）',
        'Total Target Riders (All Ranges)': '全部范围目标骑手总数',
        'Net Change: \u2014': '净变化：—',
        'Net Change: ': '净变化：',
        'Overall Average': '整体平均',
        'Risk Count (Cities)': '风险城市数',
        'Based on current filter': '基于当前筛选',
        'Avg rate based on filter': '基于筛选的平均比率',
        'Range + Target': '范围 + 目标',
        'T1 Cities': 'T1城市',
        'T2 Cities': 'T2城市',
        'FR Rate & Target': 'FR比率与目标',
        'Driver Card Rate & Target': '司机卡比率与目标',
        'Old Partners': '旧合作商',
        ' City-level FR/Driver Card performance with risk highlights. Bar colors reflect risk: ': ' 城市级FR/司机卡绩效及风险亮点。柱形颜色反映风险：',
        ' = High risk, ': ' = 高风险，',
        ' = High risk; Moderate/Low are above these thresholds.': ' = 高风险；中等/低风险高于该阈值。',
        ' (red), ': ' （红色），',
        ' (amber), ': ' （黄色），',
        ' (green). Rule: ': ' （绿色）。规则：',
        'Metric:': '指标：',
        'Tier:': '层级：',
        'City:': '城市：',
        // Dynamic FR card text patterns (JS-set)
        'Partners with Target': '有目标合作商',
        'All Partners of total': '全部合作商共',
        'New: ': '新：',
        'Total Feb Target': '2月总目标',
        'Good Partners Target': '优质合作商目标',
        'Average Partners Target': '中等合作商目标',
        'Bad Partners Target': '待改善合作商目标',
        'Avg FR Rate: ': '平均FR比率：',
        'Avg DC Rate: ': '平均DC比率：',
        'Face Recognition (FR) All Partners Summary - Target Changes Across Ranges': 'FR - 全部合作商汇总 - 各范围目标变化',

        // City-wise card sub-labels
        'High risk levels': '高风险级别',

        // CITY PERFORMANCE / TIER ANALYSIS
        'City Level Summary': '城市级别汇总',
        'Performance Distribution': '绩效分布',
        'Scale Distribution': '规模分布',
        'City Performance Distribution (Partners with Target)': '城市绩效分布（有目标合作商）',
        'City Scale Distribution (Partners with Target)': '城市规模分布（有目标合作商）',
        'Best Performing': '最佳表现',
        'Needs Attention': '需要关注',
        'Overall Good %': '整体良好%',
        'Overall Bad %': '整体待改善%',
        'Tier 1 (Feb)': '第1层（2月）',
        'Tier 2 (Feb)': '第2层（2月）',
        'T1 MoM Change': 'T1月环比变化',
        'T2 MoM Change': 'T2月环比变化',
        'Total Partners Trend': '合作商总数趋势',
        'T1 Partners with Target': 'T1有目标合作商',
        'T2 Partners with Target': 'T2有目标合作商',
        'All (Tier summary)': '全部（层级汇总）',
        'T1 (Tier summary)': 'T1（层级汇总）',
        'T2 (Tier summary)': 'T2（层级汇总）',
        'Clear': '清除',
        'City Level': '城市级',
        '# of partners with target': '有目标合作商数',
        '# of Partners with target': '有目标合作商数',
        'Total target': '总目标',
        'Avg scale': '平均规模',
        'Tier Breakdown (Jan vs Feb)': '层级分解（1月 vs 2月）',
        'T1 Breakdown (Jan vs Feb)': 'T1分解（1月 vs 2月）',
        'T2 Breakdown (Jan vs Feb)': 'T2分解（1月 vs 2月）',
        'City Comparison': '城市对比',

        // DELIVERY RIDERS
        'Delivery riders': '配送骑手',

        // PERFORMANCE SEGMENT CARDS
        'Performance Segment': '绩效细分',
        'riders/partner': '骑手/合作商',
        'Current: ': '当前：',
        'Current Scale': '当前规模',
        ' Capacity Share Target': ' 产能份额目标',
        ' Avg Scale Target': ' 平均规模目标',
        ' Target Capacity Distribution (Mar 2026) - Balanced Strategy': ' 目标产能分布（2026年3月）- 均衡策略',
        'Good 50%': '良好 50%',
        'Average 45%': '中等 45%',
        ' Quality: Maximize Good allocation': ' 质量：最大化良好分配',
        ' CPO: Scale consolidation': ' CPO：规模整合',
        ' Risk: Controlled Bad buffer': ' 风险：受控待改善缓冲',

        // PLANNING ASSUMPTION NOTICE
        'Planning Assumption Notice': '规划假设说明',

        // STRATEGY INSIGHTS
        ' Share Rebalance:': ' 份额再平衡：',
        ' Balanced Distribution:': ' 均衡分布：',
        ' Scale Enhancement:': ' 规模提升：',
        ' Risk Containment:': ' 风险管控：',
        ' CPO Optimization:': ' CPO优化：',
        ' Good partners set to 50% given the 13% forecast uplift and driver-card constraints; capacity shifts to strong Average partners to keep coverage balanced.': ' 良好合作商目标设为50%，基于13%的预测增量和司机卡限制；产能向优质中等合作商转移以保持覆盖均衡。',
        ' Average partners raised to 45% (from 44.3% current) to absorb incremental capacity while maintaining stability.': ' 中等合作商提升至45%（当前44.3%），以吸收增量产能同时保持稳定性。',
        ' Overall avg scale target raised to 40.0 (from 35.1 current) to drive cost per order reduction through partner consolidation.': ' 整体平均规模目标提升至40.0（当前35.1），通过合作商整合推动每单成本降低。',
        ' Bad partners held at 5% (from 2.0% current) to provide a controlled buffer for compliance improvement and onboarding.': ' 待改善合作商维持在5%（当前2.0%），为合规改善与新增合作商提供受控缓冲。',
        ' Scale targets remain (Good: 50.0, Average: 30.0, Bad: 18.0) to maximize efficiency per delivery.': ' 规模目标维持不变（良好：50.0，中等：30.0，待改善：18.0），以最大化每单配送效率。',

        // OKR Q1 2026 STRATEGIC MANDATE
        'Q1 2026 Strategic Mandate': 'Q1 2026 战略任务',
        'Cut cost per order while growing dependable supply. Gate capacity by compliance first, shift targets toward high-performers, run 3-month bands for stability, and execute 30/60/90 turnarounds for weak partners. Consolidate scale to lift average riders per partner, cap single-partner exposure per city, and use long-term assessment + incentives to raise willingness where it matters.': '在扩展可靠供给的同时降低每单成本。以合规为首要条件控制产能，将目标向高绩效合作商倾斜，实行3个月绑定制保持稳定，对弱势合作商执行30/60/90天整改机制。整合规模以提升每个合作商的平均骑手数，限制单一合作商在每个城市的比例，并通过长期评估和激励措施在关键领域提升意愿。',
        'Reduce CPO via Scale Growth (Q1)  Target: 0.39 SAR/order': '通过规模增长降低CPO（Q1） 目标：0.39 SAR/订单',
        'Improve Compliance & Experience (Q1)  Target: 25%  80%': '提升合规与体验（Q1） 目标：25%  80%',
        'Long-term Assessment & Willingness (Q1)': '长期评估与意愿（Q1）',
        'Allocation Accuracy & Fulfillment (Q1)  Target: 100% FR': '分配准确性与履约（Q1） 目标：100% FR',
        'Manage Concentration Risk (Q1)': '管理集中度风险（Q1）',

        // OKR STRUCTURAL LABELS
        'Team Objective:': '团队目标：',
        'Deadline': '截止日期',
        'O Progress (Feb)': '目标进展（2月）',
        'O Progress (Jan)': '目标进展（1月）',
        'O Progress': '目标进展',
        'How:': '实施方式：',

        // OKR O1 CONTENT
        'Reduce 0.444 SAR per order in Q1': '在Q1将每单成本降低至0.444 SAR',
        'KR1: Raise avg riders/partner from ~33  45': 'KR1：将每合作商平均骑手数从约33提升至45',
        'Reallocate from small/weak partners (<20 riders) to reliable partners. Lock 3-month bands; retain 70% of peak gains. Protect priority cities.': '从小型/弱势合作商（<20名骑手）重新分配至可靠合作商。设定3个月绑定期；保留70%的峰值增量。保护优先城市。',
        '35.9 avg scale target': '35.9 平均规模目标',
        '(79.8% to target)': '（达成目标79.8%）',
        'KR2: Deliver 0.39 SAR/order CPO reduction from scale': 'KR2：通过规模实现0.39 SAR/订单的CPO降低',
        'Concentrate capacity on Good & compliant partners. Enforce SOP + maker/checker to cut overrides (willingness & special cases with proof process).': '将产能集中于良好且合规的合作商。执行SOP + 双人审核机制以减少超标（意愿和特殊情况需有证明流程）。',
        'KR3: Frontline engagement (PMM/CH)': 'KR3：一线参与（PMM/CH）',
        'Assign avg scale/partner target to PMM by performance level. Push alignment with partners to prepare riders accordingly.': '按绩效级别将平均规模/合作商目标分配给PMM。推动与合作商对齐以相应准备骑手。',
        'Monthly (until Mar 31)': '每月（至3月31日）',
        'Target assigned per city to share with CH': '按城市分配目标并与CH共享',
        'Partners count shared with PMM/CH to reach avg scale target': '合作商数量与PMM/CH共享，以达到平均规模目标',

        // ── MONTHLY INSIGHTS TAB — SECTION TITLES ──
        'City-wise Target Distribution (with MoM trends) — click to expand/collapse': '城市目标分布（含月环比趋势）— 点击展开/收起',
        'Tier City Overview (T1 vs T2) — click to expand/collapse': '城市层级概览（T1 vs T2）— 点击展开/收起',
        'Strategic Insights & Key Findings — click to expand/collapse': '战略洞察与关键发现 — 点击展开/收起',
        'Growth Category Breakdown (Increase Slabs)': '增长类别分解（增加档次）',
        'Growth Category Breakdown (Decrease Slabs)': '增长类别分解（减少档次）',

        // ── MONTHLY INSIGHTS TAB — DESCRIPTIONS ──
        'City-level analysis showing total target riders and active partners (with targets) across all 6 months (Sep\u2013Feb). Green/Red arrows indicate month-over-month percentage changes. Filter by two months to compare city performance trends.': '城市级分析，展示6个月（Sep-Feb）所有城市的总目标骑手数及有目标的活跃合作商数。绿/红箭头显示月环比变化，可筛选两个月进行城市绩效趋势对比。',
        'Track partner target capacity movements: partners who increased, decreased, or maintained their targets across 6 months. Segmented by quality performance (Good \u226580% FR, Average 50-80% FR, Bad <50% FR).': '追踪合作商目标产能变动：6个月内增加、减少或维持目标的合作商，按绩效质量细分（良好≥80% FR、中等50-80% FR、待改善<50% FR）。',
        'Partners by % target increase (0%, 1-10%, 11-20%, 21-30%, >30%). Line shows total partners with any increase.': '按目标增幅划分的合作商（0%、1-10%、11-20%、21-30%、>30%）。折线显示有任何增加的合作商总数。',
        'Partners by % target decrease (0%, -1 to -10%, -11 to -20%, -21 to -30%, <-30%). Line shows total partners with any decrease.': '按目标降幅划分的合作商（0%、-1至-10%、-11至-20%、-21至-30%、<-30%）。折线显示有任何减少的合作商总数。',
        'Complete view of all cities across 6 months showing partner counts and total target capacity. MoM % change calculated from previous month.': '展示6个月所有城市的合作商数量及总目标产能完整视图，月环比%按上月计算。',
        'Average of 195 partners increased targets monthly, while 243 decreased. December saw the sharpest decline (79 increases vs 457 decreases). February closed with 136 increases vs 284 decreases.': '每月平均195家合作商增加了目标，243家减少。12月降幅最大（79例增加 vs 457例减少），2月以136例增加 vs 284例减少收尾。',

        // ── MONTHLY INSIGHTS TAB — BUTTONS & LABELS ──
        'Reset to All Months': '重置为全部月份',
        'Compare Months:': '对比月份：',
        'Compare': '比较',
        'Apply Filter': '应用筛选',
        'Filter by City (Slicer):': '按城市筛选：',
        'T1 Cities (Major Markets)': 'T1城市（主要市场）',
        'T2 Cities (Secondary Markets)': 'T2城市（次要市场）',
        '-- Month 1 --': '--月份1--',
        '-- Month 2 --': '--月份2--',
        'Filter by:': '筛选：',

        // ── MONTHLY INSIGHTS TAB — KPI CARD TOP LABELS ──
        'Highest Avg Scale': '最高平均规模',
        'Lowest Avg Scale': '最低平均规模',
        'Best MoM Improver': '最佳月环比提升',
        'Steepest MoM Decline': '最大月环比下降',

        // ── MONTHLY INSIGHTS TAB — CHART TITLES & AXIS LABELS ──
        'Total Target by City (Trend)': '各城市总目标（趋势）',
        'Active Partners by City (Trend)': '各城市活跃合作商（趋势）',
        'City-wise Avg Scale Trend (Target \u00f7 Partners)': '城市平均规模趋势（目标÷合作商）',
        'City-wise Monthly Target & Partners Overview': '城市月度目标与合作商概览',
        'Partner Size Breakdown - Willingness by Target Size': '合作商规模分解 — 按目标规模划分的意愿',
        'Partners (Bars)': '合作商（柱）',
        'Total Increase (Line)': '总增量（折线）',
        'Total Decrease (Line)': '总减量（折线）',

        // ── MONTHLY INSIGHTS TAB — KEY INSIGHTS LABELS ──
        'Key Insights & Takeaways': '关键洞察与要点',

        // ── MONTHLY INSIGHTS TAB — DESCRIPTION TEXTS ──
        'Distribution of partners by achievement level. Good (\u226580% FR), Average (50-80% FR), Bad (<50% FR). Shows quality composition evolution.': '按达成水平分布的合作商。良好（≥80% FR）、中等（50-80% FR）、待改善（<50% FR）。展示质量结构演变。',
        'Tracks total capacity targets and number of total partners month-over-month. Shows overall market size and partner base growth trends. Dual-axis visualization with combined insight indicator.': '追踪月度总产能目标及合作商总数变化，展示整体市场规模与合作商基础增长趋势，双轴可视化含综合洞察指标。',
        'Shows month\u2011over\u2011month % change in Total Target based on the Monthly Insights totals. Green = increase vs previous month, Red = decrease. First month is the baseline (no MoM).': '展示基于月度洞察总量的总目标月环比%变化。绿色=较上月增加，红色=减少。第一个月为基准（无月环比）。',
        'Shows capacity target breakdown by vehicle type across months. Cars dominate but Bikes share is growing (15.8% \u2192 25.4%). Toggle between Monthly overview and City-level breakdown.': '展示各月按车辆类型划分的产能目标。汽车占主导，但摩托车份额正在增长（15.8% → 25.4%）。可在月度概览与城市级分解之间切换。',

        // ── MONTHLY INSIGHTS TAB — BADGE / QUICK INDICATOR LABELS ──
        '\u2713 Good Quality Trending': '✓ 良好质量趋势上升',
        '\u26a0 Watch Average Decline': '⚠ 关注中等合作商下滑',
        'Quick Indicators:': '快速指标：',

        // ── ALL-TABS DESCRIPTION / EXPLANATION NOTE TEXTS ──
        'Tier Overview by Month (counts shown with share%)': '月度层级概览（含份额%）',
        '\uD83D\uDCCA Partner Willing Analysis (Monthly Comparison)': '📊 合作商意愿分析（月度比较）',
        'Capacity targets for partners by performance segment (Good / Average / Bad) before and after PMM manual adjustments; shows how manual overrides impacted our rule-based targets.': '按绩效分层（良好/中等/待改善）的合作商产能目标，展示PMM手动调整前后对比；显示人工干预如何影响基于规则的目标。',
        'Distribution of 551 partners with active targets showing capacity direction: increases, unchanged, or decreases vs previous month.': '551家有效目标合作商的产能方向分布：较上月增加、不变或减少。',
        'Average riders per partner by performance level (Good/Average/Bad) across months.': '按绩效等级（良好/中等/待改善）划分的每月合作商平均骑手数。',
        'Average riders per partner by size level (Big/Mid/Small) across months.': '按规模等级（大/中/小）划分的每月合作商平均骑手数。',
        'Average riders per active partner each month. Indicates typical partner capacity and operational efficiency trends. Declining trend shows efficiency optimization efforts.': '每月每位活跃合作商的平均骑手数，反映典型产能与运营效率趋势。下降趋势体现效率优化成果。',
        'Partner distribution by target size. Big partners show strong growth, Mid stable, Small declining. Strategic diversification needed.': '按目标规模划分的合作商分布。大型合作商强劲增长，中型稳定，小型下滑。需要战略性多元化布局。',
        'Distribution of total target riders share with % across performance levels. Shows capacity concentration by quality tier.': '按绩效层级划分的总目标骑手份额分布（含占比%）。显示按质量等级的产能集中情况。',
        'Distribution of total target riders share with % across partner size levels. Shows concentration risk and diversification.': '按合作商规模等级划分的总目标骑手份额分布（含占比%）。显示集中风险与多元化程度。',
        'Track partner target capacity movements: partners who increased, decreased, or maintained their targets across 6 months. Segmented by quality performance (Good \u226580% FR, Average 50-80% FR, Bad <50% FR).': '追踪合作商目标产能变动：过去6个月中增加、减少或维持目标的合作商。按质量绩效分层（良好≥80% FR，中等50-80% FR，待改善<50% FR）。',
        'Analyze partner composition by tenure: newly onboarded (<1 month), recently added (<3 months), and established (>3 months). Compare capacity (Target), engagement (Active Count), scale efficiency (Avg Scale), and quality breakdown across all 6 months. Green/Red arrows show month-over-month trends.': '按入职时长分析合作商构成：新入职（<1个月）、近期加入（<3个月）和老牌合作商（>3个月）。比较6个月内的产能（目标）、参与度（活跃数量）、规模效率（平均规模）及质量分布。绿/红箭头显示月环比趋势。',
        'City-level analysis showing total target riders and active partners (with targets) across all 6 months (Sep\u2013Feb). Green/Red arrows indicate month-over-month percentage changes. Filter by two months to compare city performance trends.': '城市层级分析，展示全部6个月（9月至2月）的总目标骑手数及有目标的活跃合作商。绿/红箭头表示月环比百分比变化。筛选两个月份可对比城市绩效趋势。',
        'Complete view of all cities across 6 months showing partner counts and total target capacity. MoM % change calculated from previous month.': '6个月全城市完整视图，展示合作商数量及总目标产能。月环比%变化基于上月计算。',
        'Comprehensive view of T1 vs T2 cities showing monthly targets, active partners, partners with targets, and average scale. Weighted Avg Scale represents overall market capacity efficiency. Last row shows 6-month averages.': 'T1与T2城市综合视图，展示月度目标、活跃合作商、有目标合作商及平均规模。加权平均规模代表整体市场产能效率。最后一行为6个月平均值。',
        'Distribution of partners with targets by performance level across T1 and T2 cities. Good (\u226580% FR), Average (50-80% FR), Bad (<50% FR). Shows quality mix differences between tier cities.': 'T1和T2城市中有目标合作商按绩效等级的分布。良好（≥80% FR）、中等（50-80% FR）、待改善（<50% FR）。显示各层级城市间的质量差异。',
        'Partner count distribution by size level (Big/Mid/Small) for T1 vs T2 cities. Big partners have high order proportion (>0.7) and scale; Small have low proportion (<0.1) or riders; Mid are in between. Reveals partner base structure differences.': 'T1与T2城市按规模等级（大/中/小）划分的合作商数量分布。大型合作商订单占比高（>0.7）且规模大；小型占比低（<0.1）或骑手少；中型居中。揭示合作商基础结构差异。',
        'Distribution of total target riders by performance level (Good/Average/Bad) across T1 and T2 cities. Shows how capacity volume is distributed across quality tiers and city types.': 'T1和T2城市中总目标骑手按绩效等级（良好/中等/待改善）的分布。显示产能总量如何在质量等级和城市类型间分配。',
        'Distribution of total target riders by partner size level (Big/Mid/Small) for T1 vs T2 cities. Reveals how capacity volume concentrates across different partner scales and tier types.': 'T1与T2城市中总目标骑手按合作商规模等级（大/中/小）的分布。揭示产能总量如何集中在不同规模和层级类型的合作商中。',
        'Stacked bars show monthly willing vs not\u2011willing partners (counts). Use the filter to switch to % trend.': '堆叠柱形图显示每月意愿与非意愿合作商数量。使用筛选器可切换至%趋势。',
        'Line trend shows willingness share over time (percent). Use the filter to switch to counts.': '折线趋势显示意愿份额随时间变化（百分比）。使用筛选器可切换至计数。',
        'Partners by % target increase (0%, 1-10%, 11-20%, 21-30%, >30%). Line shows total partners with any increase.': '按目标增幅%划分的合作商（0%、1-10%、11-20%、21-30%、>30%）。折线显示有任何增幅的合作商总数。',
        'Partners by % target decrease (0%, -1 to -10%, -11 to -20%, -21 to -30%, <-30%). Line shows total partners with any decrease.': '按目标降幅%划分的合作商（0%、-1至-10%、-11至-20%、-21至-30%、<-30%）。折线显示有任何降幅的合作商总数。',
        'Number of partners in each rider count range across all months. Helps identify capacity distribution patterns.': '各月各骑手数量区间的合作商数量，有助于识别产能分布规律。',
        'Number of partners who increased their targets, categorized by rider count range. Shows growth momentum across different partner sizes.': '按骑手数量区间分类的目标增加合作商数量，显示不同规模合作商的增长势头。',
        'Number of partners who decreased their targets, categorized by rider count range. Identifies areas requiring attention and support.': '按骑手数量区间分类的目标减少合作商数量，识别需要关注和支持的领域。',

        // OKR O2 CONTENT
        'Raise compliance rate from 25% to 80% in Q1': '在Q1将合规率从25%提升至80%',
        'KR: Good/strong partners carry 58-60% of capacity target; Bad partners 5%': 'KR：良好/强势合作商承担58-60%的产能目标；待改善合作商5%',
        'Use weighted operational metrics. Add driver card to performance assessment. Assign highest capacity to highest compliant partners (FR, driver card, etc.).': '使用加权运营指标。将司机卡纳入绩效评估。将最高产能分配给合规率最高的合作商（FR、司机卡等）。',
        '28.7% driver card rate': '28.7% 司机卡比率',
        'Driver card in ops metrics from Jan 19. Will use in March target.': '自1月19日起司机卡纳入运营指标，将在3月目标中使用。',

        // OKR O3 CONTENT
        'Ensure capacity fulfillment via long-term partner assessment': '通过长期合作商评估确保产能履约',
        'KR1: Build V1 new partners assessment model': 'KR1：构建V1新合作商评估模型',
        'Benchmark competitors, design new assessment, align with Keeta CPO target, finalize criteria/rewards structure.': '对标竞争对手，设计新评估方案，与Keeta CPO目标对齐，最终确定评估标准与奖励结构。',
        'Plan: Feb 28; Pilot: Mar 31': '计划：2月28日；试点：3月31日',
        'Pending  Start after March capacity target (2nd week Feb)': '待定  在3月产能目标完成后启动（2月第2周）',
        'KR2: Publish assessment plan; pilot T2 cities': 'KR2：发布评估计划；在T2城市试点',
        'Determine T2 cities for pilot phase of new assessment.': '确定新评估试点阶段的T2城市。',
        'KR3: Partner willingness +8-10pp vs Jan in pilots': 'KR3：试点城市合作商意愿较1月提升8-10个百分点',
        'Establish incentives for partners with highest growth potential based on total riders including other platforms.': '为具有最高增长潜力的合作商（基于含其他平台的骑手总数）建立激励机制。',
        'Willingness data from Monthly Insights (Jan)': '意愿数据来自月度洞察（1月）',
        'KR4: Deliver evaluation & product alignment': 'KR4：完成评估与产品对齐',
        'Evaluate partners stratification, align on execution process.': '评估合作商分层，对齐执行流程。',

        // OKR O4 CONTENT
        'Iterate target allocation mechanism; reduce PMM adjustment to 10%; achieve 100% monthly capacity FR': '迭代目标分配机制；将PMM调整率降至10%；实现100%月度产能FR',
        'KR1: Reduce manual adjustment by 10%': 'KR1：减少10%人工调整',
        'Pre-planning alignment; parameterized gates; data-driven insights. Quick audits and consistent review. SOP + willingness tracker for special cases.': '提前规划对齐；参数化门控；数据驱动洞察。快速审计持续复盘。SOP + 意愿追踪器（特殊情况）。',
        'In progress  Collecting data': '进行中  数据收集中',
        'KR2: March capacity FR 98-100%': 'KR2：3月产能FR达98-100%',
        'Apply capacity target rules for high FR%. Focus on high FR partners and reward with capacity target.': '应用高FR%的产能目标规则。聚焦高FR合作商并以产能目标作为奖励。',
        'KR3: Promote 20 partners to 150 riders': 'KR3：将20名合作商提升至150名骑手',
        'Scale top performers; mid  big path for compliant partners using monthly compliance targets + high quality metrics.': '扩大顶部绩效者；通过月度合规目标和高质量指标为合规合作商提供中大规模通道。',
        '7.1% target reduction in Jan  Will prioritize in Feb': '1月目标下降7.1%  将在2月优先处理',

        // OKR O5 CONTENT
        'Reduce group-wide risks & ensure fulfillment stability': '降低整体风险并确保履约稳定性',
        'KR: Single-partner share X% per city; remediate any breach within cycle': 'KR：每城市单一合作商份额X%；在周期内修复任何违规',
        'Map current city data and set metrics. Set city caps in model with alert + reallocation rules. Review capacity growth factor for enhancement.': '梳理当前城市数据并设定指标。在模型中设置城市上限及预警与重新分配规则。回顾产能增长因子进行优化。',
        ' Potential conflict:': ' 潜在冲突：',
        ' Balance between concentration risk goal and avg scale increase goal': ' 集中度风险目标与平均规模提升目标之间的平衡',

        // TARGET MOVEMENT TOOLTIPS
        'Partners whose targets increased. Use this to see which performance segments drove growth from Jan to Feb.': '目标增加的合作商。使用此功能可查看哪些绩效细分在1月至2月间驱动了增长。',
        'Partners whose targets decreased. Highlights segments contributing to the drop and where reductions are concentrated.': '目标减少的合作商。突出显示导致下降的细分及减少集中的区域。',
        'Partners with no target change. Useful for stability analysis and identifying segments with steady targets.': '目标无变化的合作商。适用于稳定性分析和识别目标稳定的细分。',
        'Loading...': '加载中...',
        'N/A': '不适用',
    };

    // ── HTML BLOCK DICTIONARY (for elements with mixed <strong>+text content) ──
    var zhInnerDict = {
        'notes-content': `<div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 5px;"><span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span><span>仪表盘当前显示的是<strong>第一版本</strong>产能目标——月中调整可能随时应用。</span></div><div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 5px;"><span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span><span>合作商数据来源于<strong>上月最后一周</strong>（例如，2月目标使用1月下旬活跃合作商数据）。</span></div><div style="display: flex; align-items: flex-start; gap: 6px;"><span style="color: #6366f1; font-weight: 700; flex-shrink: 0;">•</span><span>绩效月环比对比的是<strong>目标 vs. 目标</strong>，而非实际表现——合作商类别可能逐月变化。</span></div>`,
        'highlights-cards': `<div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;"><span style="font-weight: 700;">🛡️ 优质合作商受保护</span><br>目标削减最低，仅<strong>6.6%</strong>——在分配规则中被优先保障。</div><div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;"><span style="font-weight: 700;">📉 待改善合作商大幅减少</span><br>数量从<strong>73 → 20</strong>月环比下降；目标从<strong>808 → 370</strong>削减。</div><div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;"><span style="font-weight: 700;">⚖️ 中等合作商保持稳定</span><br>目标月环比维持在同一水平，变动<strong>+1.0%</strong>。</div><div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5;"><span style="font-weight: 700;">🤖 人工调整减半</span><br>减少了<strong>50.4%</strong>——规则自动化持续提升。</div><div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #166534; line-height: 1.5; grid-column: 1 / -1;"><span style="font-weight: 700;">🎯 FR达成率92.4%</span>——面部识别达标率表现强劲。</div>`,
        'lowlights-cards': `<div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #991b1b; line-height: 1.5;"><span style="font-weight: 700;">😞 合作商体验受影响</span><br>目标连续<strong>第3个月</strong>下降，影响合作商情绪。此外，<strong>70家合作商分阶段退出</strong>加剧负面体验。</div><div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 9px 12px; font-size: 11px; color: #991b1b; line-height: 1.5;"><span style="font-weight: 700;">🪪 司机卡比率偏低</span><br>司机卡比率为<strong>40.5%</strong>——限制规则完整执行并需要例外处理。</div>`,
        'challenge1-content': `<div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">挑战</div><div style="font-size: 11px; color: #78350f; line-height: 1.5;">在产能整体<strong>削减13%</strong>的情况下实现规模目标。</div></div><div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">解决方案</div><div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">识别并分阶段淘汰<strong>低合规合作商</strong>以保护平均规模。</div></div><div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">结果</div><div style="font-size: 11px; color: #064e3b; line-height: 1.5;">平均规模<strong>35.1 / 目标36</strong>——<span style="font-weight: 700; color: #059669;">98%达成率</span>。</div></div>`,
        'challenge2-content': `<div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">挑战</div><div style="font-size: 11px; color: #78350f; line-height: 1.5;">在整体<strong>目标削减</strong>压力下，将高质量合作商保持在上月水平。</div></div><div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">解决方案</div><div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">规则<strong>优先保障优质合作商</strong>——由低层级合作商承担削减部分。</div></div><div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">结果</div><div style="font-size: 11px; color: #064e3b; line-height: 1.5;">优质合作商目标<strong>-6.6%</strong>（仅源于城市级约束）；<span style="font-weight: 700; color: #059669;">进展正常</span>——大部分削减与DC问题相关。</div></div>`,
        'challenge3-content': `<div style="background: #fef3c7; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #92400e; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">挑战</div><div style="font-size: 11px; color: #78350f; line-height: 1.5;">司机卡比率偏低（<strong>40.5%</strong>）阻碍规则完全执行——被迫进行<strong>人工例外处理</strong>。</div></div><div style="background: #dbeafe; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #1e40af; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">解决方案</div><div style="font-size: 11px; color: #1e3a8a; line-height: 1.5;">与<strong>CH/PMM</strong>协调，推动合作商完成司机卡办理时间表。</div></div><div style="background: #d1fae5; border-radius: 8px; padding: 8px 10px;"><div style="font-size: 9px; color: #065f46; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px;">结果</div><div style="font-size: 11px; color: #064e3b; line-height: 1.5;">在兑现承诺前分配<strong>保守目标</strong>；<span style="font-weight: 700; color: #d97706;">下月重新评估</span>。</div></div>`,
        'exec-footer-note': `<strong>💡 战略逻辑：</strong>扩大可靠合作商规模，收紧管控，将结构向合规细分领域转变，以提升产能并降低CPO。聚焦人员编制调整，维持高平均规模以保障合作商盈利能力，同时保护重点城市和高质量执行者。`,
        'exec-strategy-list': `<li><strong>再平衡：</strong>战略性再分配，非统一削减</li><li><strong>整体降幅：</strong>低于1月13.8%（-3,088名骑手）</li><li><strong>人员编制调整：</strong>重构基础以提升平均规模</li><li><strong>FR%主要门槛：</strong>低FR=不增长；严重=零目标</li><li><strong>绩效导向：</strong>质量+规模→分配</li><li><strong>新合作商保护：</strong>保护新合作商免受大幅削减</li>`,
        'exec-highlights-list': `<li><strong>待改善合作商↓72.6%：</strong>从73家降至20家</li><li><strong>中等合作商稳定：</strong>262家合作商，8,414名骑手（+1.0%）</li><li><strong>平均目标保持：</strong>尽管削减仍维持35.1名骑手/合作商</li><li><strong>质量提升：</strong>组合结构向合规方向转变</li>`,
        'exec-concerns-list': `<li><strong>整体下滑：</strong>总产能下降13.8%（-3,088）</li><li><strong>优质合作商下降：</strong>目标削减6.6%</li><li><strong>零目标影响：</strong>70家合作商分阶段停止分配（影响合作商体验）</li><li><strong>产能收缩：</strong>车队规模压缩压力</li>`,
        'exec-targets-list': `<li><strong>平均骑手/合作商：</strong>从约33提升至≥45</li><li><strong>稳定性：</strong>锁定3个月波段；≥70%高峰期保留率</li><li><strong>CPO影响：</strong>≥0.39沙特里亚尔/订单降低</li><li><strong>管控：</strong>SOP+制作/核查；-10%人工调整</li><li><strong>结构转变：</strong>优质58-60%；待改善5%；增加司机卡</li><li><strong>合规性：</strong>3月前FR达98-100%</li><li><strong>规模提升：</strong>≥20家合作商达到≥150名骑手</li>`,
        'willingness-definition': `<strong style="color: #1e3a5f;">📋 定义：</strong>「意愿合作商」是指<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-weight: 600;">提高了容量目标</span>的合作商（较上月）。「非意愿合作商」将<span style="background: #fee2e2; color: #b91c1c; padding: 2px 8px; border-radius: 4px; font-weight: 600;">减少或维持</span>相同目标（目标增幅 ≤ 0）。`,

        // ── DESCRIPTION NOTE PARAGRAPHS (data-i18n-html) ──
        'desc-manualadj': '按绩效分层（良好/中等/待改善）的合作商产能目标，PMM手动调整前后对比；显示人工干预如何影响基于规则的目标。',
        'desc-distdir': '551家有效目标合作商的产能方向分布：较上月增加、不变或减少。',
        'desc-avgridersperf': '按绩效等级（良好/中等/待改善）划分的各月合作商平均骑手数。',
        'desc-avgridersize': '按规模等级（大/中/小）划分的各月合作商平均骑手数。',
        'desc-avgridersmonth': '每月每位活跃合作商的平均骑手数，反映典型产能与运营效率趋势。下降趋势体现效率优化成果。',
        'desc-partnerdist': '按目标规模划分的合作商分布。大型合作商强劲增长，中型稳定，小型下滑。需要战略性多元化布局。',
        'desc-ridersshareperf': '按绩效层级划分的总目标骑手份额分布（含占比%）。显示按质量等级的产能集中情况。',
        'desc-riderssharesize': '按合作商规模等级划分的总目标骑手份额分布（含占比%）。显示集中风险与多元化程度。',
        'desc-movement': '追踪合作商目标产能变动：过去6个月中增加、减少或维持目标的合作商。按质量绩效分层（良好≥80% FR，中等50-80% FR，待改善&lt;50% FR）。',
        'desc-tenure': '按入职时长分析合作商构成：新入职（&lt;1个月）、近期加入（&lt;3个月）和老牌合作商（&gt;3个月）。比劃6个月内的产能（目标）、参与度（活跃数量）、规模效率（平均规模）及质量分布。绿/红箭头显示月环比趋势。',
        'desc-cityanalysis': '城市级分析，展示全部6个月（9月至2月）的总目标骑手数及有目标的活跃合作商。绿/红箭头表示月环比百分比变化。筛选两个月份可对比城市绩效趋势。',
        'desc-allcities': '6个月全城市完整视图，展示合作商数量及总目标产能。月环比%变化基于上月计算。',
        'desc-tieroverview': 'T1与T2城市综合视图，展示月度目标、活跃合作商、有目标合作商及平均规模。加权平均规模代表整体市场产能效率。最后一行为6个月平均值。',
        'desc-tierperfmix': 'T1和T2城市中有目标合作商按绩效等级的分布。良好（≥80% FR）、中等（50-80% FR）、待改善（&lt;50% FR）。显示各层级城市间的质量差异。',
        'desc-tiersizemix': 'T1与T2城市按规模等级（大/中/小）划分的合作商数量分布。大型合作商订单占比高（&gt;0.7）且规模大；小型占比低（&lt;0.1）或骑手少；中型居中。揭示合作商基础结构差异。',
        'desc-tierperfvol': 'T1和T2城市中总目标骑手按绩效等级（良好/中等/待改善）的分布。显示产能总量如何在质量等级和城市类型间分配。',
        'desc-tiersizevol': 'T1与T2城市中总目标骑手按合作商规模等级（大/中/小）的分布。揭示产能总量如何集中在不同规模和层级类型的合作商中。',
        'desc-willingbars': '堆叠柱形图显示每月意愿与非意愿合作商数量。使用筛选器可切换至%趋势。',
        'desc-willinglines': '折线趋势显示意愿份额随时间变化（百分比）。使用筛选器可切换至计数。',
        'desc-growthdist': '按目标增幅%划分的合作商（0%、1-10%、11-20%、21-30%、&gt;30%）。折线显示有任何增幅的合作商总数。',
        'desc-decreasedist': '按目标降幅%划分的合作商（0%、-1至-10%、-11至-20%、-21至-30%、&lt;-30%）。折线显示有任何降幅的合作商总数。',
        'desc-riderslab': '各月各骑手数量区间的合作商数量，有助于识别产能分布规律。',
        'desc-slabincr': '按骑手数量区间分类的目标增加合作商数量，显示不同规模合作商的增长势头。',
        'desc-slabdecr': '按骑手数量区间分类的目标减少合作商数量，识别需要关注和支持的领域。',
        'desc-totaltargettrend': '追踪月度总产能目标及合作商总数变化，展示整体市场规模与合作商基础增长趋势，双轴可视化含综合洞察指标。',
        'desc-momchange': '展示基于月度洞察总量的总目标月环比%变化。绿色=较上月增加，红色=减少。第一个月为基准（无月环比）。',
        'desc-vehiclebreakdown': '展示各月按车辆类型划分的产能目标。汽车占主导，但摩托车份额正在增长（15.8% → 25.4%）。可在月度概览与城市级分解之间切换。',
        'desc-perfmix': '按达成水平分布的合作商。良好（≥80% FR）、中等（50-80% FR）、待改善（&lt;50% FR）。展示质量结构演变。',
        'desc-topmovers': '展示骑手数最多的前20家周合作商和最少的后20家，包含实际骑手数和总目标。',

        'willingness-key-insights': `<p style="margin-bottom: 12px; line-height: 1.6;"><strong>📈 整体趋势：</strong>合作商意愿在10月以37.4%起步（213名意愿合作商），11月有所改善（40.5%，259名），但12月骤降至最低点12.8%（81名）。1月出现强劲反弹至32.7%（201名），但2月再次回落至24.6%（130名），显示参与度波动明显。</p><p style="margin-bottom: 12px; line-height: 1.6;"><strong>🎯 最佳表现：</strong>11月意愿率最高，达40.5%，640名小计合作商中有259名愿意提高目标。10月紧随其后，意愿率37.4%（213名合作商）。</p><p style="margin-bottom: 12px; line-height: 1.6;"><strong>⚠️ 12月挑战：</strong>12月降幅最大，仅12.8%的意愿（81名合作商），554家合作商（87.2%）不愿意提高目标，是所有月份中阻力最大的时期。</p><p style="margin-bottom: 12px; line-height: 1.6;"><strong>🔥 1月复苏与2月下降：</strong>1月意愿显著增长20%，达32.7%（201名合作商），高于12月12.8%的低点。然而2月降至24.6%（528名小计中有130名意愿），表明合作商参与度持续波动。</p><p style="margin-bottom: 12px; line-height: 1.6;"><strong>📊 合作商基础动态：</strong>合作商总数从峰值767名（11月）收缩至551名（2月），代表显著的组合整合。10月-2月平均意愿为30.0%（意愿方）vs 70.0%（不意愿方），显示持续的参与挑战。</p><p style="margin-bottom: 0; line-height: 1.6;"><strong>💼 战略建议：</strong>通过实施有针对性的保留和增长激励措施来应对2月的下降。1月复苏与2月下降之间的波动表明合作商对干预措施的反应不一致，应重点关注维持参与势头，同时解决反复下滑的根本原因。</p>`,
    };

    // Pre-sort keys once for performance
    var _sortedKeys = null;

    // ── Load persisted auto-translations from previous sessions ──
    // Must run AFTER zhDict is fully defined. Merges saved API results into
    // zhDict so the Google Translate API is never called again after first visit.
    (function() {
        try {
            var saved = localStorage.getItem(TRANS_CACHE_KEY);
            if (saved) {
                var parsed = JSON.parse(saved);
                var keys = Object.keys(parsed);
                for (var k = 0; k < keys.length; k++) {
                    var key = keys[k];
                    if (!zhDict[key]) {          // never overwrite manual entries
                        zhDict[key] = parsed[key];
                        _autoTranslateCache[key] = true; // skip re-fetching
                    }
                }
                _sortedKeys = null;             // force key-sort refresh
            }
        } catch(e) {}
    })();

    function getSortedKeys() {
        if (!_sortedKeys) _sortedKeys = Object.keys(zhDict).sort(function(a, b) { return b.length - a.length; });
        return _sortedKeys;
    }

    function translateText(input) {
        if (!input || currentLang === 'en') return input;
        var output = input;
        // Regex patterns for dynamic content
        // Never translate proper nouns (city names, partner brand names)
        if (_properNounSet.has(output.trim())) return input;
        output = output.replace(/\bDay\s*(\d+)\b/g, '第$1天');
        output = output.replace(/\bFeb\s*1-7\b/gi, '2月1-7日');
        output = output.replace(/\bFeb\s*8-14\b/gi, '2月8-14日');
        output = output.replace(/\bWeek\s*(\d+)\b/g, '第$1周');
        output = output.replace(/\bW(\d+)\b/g, 'W$1');
        output = output.replace(/ of total (\d[\d,]*)/g, ' 共$1家中');
        output = output.replace(/\bmonth-over-month\b/gi, '月环比');
        output = output.replace(/Net Change: /g, '净变化：');
        output = output.replace(/High: (\d+) \| Moderate: (\d+) \| Low: (\d+)/g, '高风险：$1 | 中等：$2 | 低风险：$3');
        output = output.replace(/\btotal cities: (\d+)/gi, '总城市数：$1');
        output = output.replace(/\bAvg FR Rate: /g, '平均FR比率：');
        output = output.replace(/\bAvg DC Rate: /g, '平均DC比率：');
        output = output.replace(/\bJan: (\d+) → Feb: (\d+)\b/g, '1月：$1 → 2月：$2');
        output = output.replace(/(\d+\.?\d*)% Good partners/g, '$1% 良好合作商');
        output = output.replace(/(\d+\.?\d*)% Bad partners/g, '$1% 待改善合作商');
        output = output.replace(/(\d+\.?\d*)% Average partners/g, '$1% 中等合作商');
        output = output.replace(/(\d+) Good partners\b/g, '$1 名良好合作商');
        output = output.replace(/(\d+) Bad partners\b/g, '$1 名待改善合作商');
        output = output.replace(/(\d+) Average partners\b/g, '$1 名中等合作商');
        output = output.replace(/\bT1 partners\b/g, 'T1合作商');
        output = output.replace(/\bT2 partners\b/g, 'T2合作商');
        output = output.replace(/\bT1 avg scale\b/g, 'T1平均规模');
        output = output.replace(/\bT2 avg scale\b/g, 'T2平均规模');
        output = output.replace(/\bT1 total target\b/g, 'T1总目标');
        output = output.replace(/\bT2 total target\b/g, 'T2总目标');
        output = output.replace(/\bT1 change vs Jan\b/g, 'T1月环比变化（vs 1月）');
        output = output.replace(/\bT2 change vs Jan\b/g, 'T2月环比变化（vs 1月）');
        output = output.replace(/forecasted capacity target of ([\d,]+) riders/g, '预测产能目标为$1名骑手');
        output = output.replace(/\bT([12]) • (Overview|City Level) • (.+?) \(Jan vs Feb\)/g, function(m,t,b,metric){ var bMap={'Overview':'概览','City Level':'城市级'};return 'T'+t+' • '+(bMap[b]||b)+' • '+metric+'（1月 vs 2月）'; });
        // Protect full month names BEFORE dict loop so short keys (Oct, Jan...)
        // cannot partially match inside longer names (October, January...)
        var _mP = {
            'January':'\x00M01\x00','February':'\x00M02\x00','March':'\x00M03\x00',
            'April':'\x00M04\x00','June':'\x00M06\x00','July':'\x00M07\x00',
            'August':'\x00M08\x00','September':'\x00M09\x00','October':'\x00M10\x00',
            'November':'\x00M11\x00','December':'\x00M12\x00'
        };
        for (var _mk in _mP) { if (output.indexOf(_mk) !== -1) output = output.split(_mk).join(_mP[_mk]); }
        // Dictionary replacement (longest key first to avoid partial matches)
        var keys = getSortedKeys();
        for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            if (output.indexOf(key) !== -1) {
                output = output.split(key).join(zhDict[key]);
            }
        }
        // Restore full month names (kept in English as proper nouns)
        for (var _mk in _mP) { var _ph = _mP[_mk]; if (output.indexOf(_ph) !== -1) output = output.split(_ph).join(_mk); }
        return output;
    }

    function shouldSkipTextNode(node) {
        var parent = node.parentElement;
        if (!parent) return true;
        if (parent.closest('script, style, textarea, code, pre')) return true;
        if (parent.closest('#commentList')) return true;
        return false;
    }

    // ── Auto-translate fallback via Google Translate (unofficial free endpoint) ──
    async function autoTranslateMissing(texts) {
        if (!texts || !texts.length || _autoTranslatePending) return;
        // Filter: only strings that are likely English and not already known
        var toFetch = [];
        var seen = {};
        for (var i = 0; i < texts.length; i++) {
            var t = texts[i].trim();
            if (!t || t.length < 20) continue;          // must be at least 20 chars
            if (!/\s/.test(t)) continue;                // must contain a space (not a single word)
            if (seen[t] || zhDict[t] || _autoTranslateCache[t]) continue;
            // Skip if already contains Chinese characters
            if (/[\u4e00-\u9fff]/.test(t)) continue;
            // Skip if purely numeric / punctuation
            if (!/[a-zA-Z]{2,}/.test(t)) continue;
            seen[t] = true;
            toFetch.push(t);
        }
        if (!toFetch.length) return;
        _autoTranslatePending = true;
        var added = 0;
        // Batch into groups of 25 and fire in parallel
        var batches = [];
        for (var b = 0; b < toFetch.length; b += 25) batches.push(toFetch.slice(b, b + 25));
        try {
            await Promise.all(batches.map(async function(batch) {
                await Promise.all(batch.map(async function(text) {
                    try {
                        var url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=' + encodeURIComponent(text);
                        var res = await fetch(url);
                        var data = await res.json();
                        var translated = (data[0] || []).map(function(x) { return x[0] || ''; }).join('');
                        if (translated && translated !== text) {
                            zhDict[text] = translated;
                            _autoTranslateCache[text] = true;
                            added++;
                        } else {
                            _autoTranslateCache[text] = true; // mark as tried even if same
                        }
                    } catch(e) {
                        _autoTranslateCache[text] = true; // mark failed to avoid retry
                    }
                }));
            }));
        } finally {
            _autoTranslatePending = false;
        }
        if (added > 0) {
            _sortedKeys = null; // reset sorted key cache
            // Persist all new auto-translations to localStorage for instant load on next visit
            try {
                var saved = {};
                try { saved = JSON.parse(localStorage.getItem(TRANS_CACHE_KEY) || '{}'); } catch(e) {}
                var pending = _i18nPendingNodes;
                _i18nPendingNodes = [];
                for (var pi = 0; pi < pending.length; pi++) {
                    try {
                        var pn = pending[pi].node;
                        var pb = pending[pi].base;
                        var pt = translateText(pb);
                        if (pn.nodeValue !== pt) pn.nodeValue = pt;
                        if (pt !== pb) saved[pb] = pt; // save newly translated entry
                    } catch(e) {}
                }
                localStorage.setItem(TRANS_CACHE_KEY, JSON.stringify(saved));
            } catch(e) {
                // localStorage quota exceeded — patch nodes anyway
                var pending2 = _i18nPendingNodes;
                _i18nPendingNodes = [];
                for (var pi2 = 0; pi2 < pending2.length; pi2++) {
                    try {
                        var pn2 = pending2[pi2].node;
                        var pb2 = pending2[pi2].base;
                        var pt2 = translateText(pb2);
                        if (pn2.nodeValue !== pt2) pn2.nodeValue = pt2;
                    } catch(e2) {}
                }
            }
        }
    }

    function applyLanguageToDocument() {
        if (isApplyingLanguage) return;
        isApplyingLanguage = true;
        var quickMode = _i18nQuickMode; // capture and reset before any async
        _i18nQuickMode = false;
        try {
            // ── Step 1: Handle data-i18n-html blocks (innerHTML swap) ──
            var htmlBlocks = document.querySelectorAll('[data-i18n-html]');
            for (var b = 0; b < htmlBlocks.length; b++) {
                var blk = htmlBlocks[b];
                var blkKey = blk.getAttribute('data-i18n-html');
                // Save original English innerHTML once
                if (!blk.hasAttribute('data-i18n-html-en')) {
                    blk.setAttribute('data-i18n-html-en', blk.innerHTML);
                }
                if (currentLang === 'zh' && zhInnerDict[blkKey]) {
                    if (!blk.hasAttribute('data-i18n-zh-applied')) {
                        blk.innerHTML = zhInnerDict[blkKey];
                        blk.setAttribute('data-i18n-zh-applied', '1');
                    }
                } else {
                    if (blk.hasAttribute('data-i18n-zh-applied')) {
                        var origEn = blk.getAttribute('data-i18n-html-en');
                        if (origEn) blk.innerHTML = origEn;
                        blk.removeAttribute('data-i18n-zh-applied');
                    }
                }
            }

            // ── Step 2: Text-node translation for everything else ──
            var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
            var textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);

            var untranslatedTexts = [];
            _i18nPendingNodes = []; // reset pending node list each pass
            for (var i = 0; i < textNodes.length; i++) {
                var node = textNodes[i];
                if (shouldSkipTextNode(node)) continue;
                // Skip text inside data-i18n-html blocks (already handled above)
                if (node.parentElement && node.parentElement.closest('[data-i18n-html]')) continue;
                if (!textNodeOriginal.has(node)) textNodeOriginal.set(node, node.nodeValue);
                var base = textNodeOriginal.get(node);
                if (!base || !base.trim()) continue;
                var translated = translateText(base);
                if (node.nodeValue !== translated) node.nodeValue = translated;
                // Collect nodes that weren't translated (for API fallback)
                if (currentLang === 'zh' && translated === base && /[a-zA-Z]{3,}/.test(base)) {
                    untranslatedTexts.push(base);
                    _i18nPendingNodes.push({ node: node, base: base }); // store node ref
                }
            }
            // Fire async API fallback for anything the dict didn't cover
            if (currentLang === 'zh' && untranslatedTexts.length > 0) {
                autoTranslateMissing(untranslatedTexts);
            }

            // ── Step 3: title / placeholder attributes ──
            var attrTargets = document.querySelectorAll('[title], [placeholder]');
            for (var j = 0; j < attrTargets.length; j++) {
                var el = attrTargets[j];
                if (el.hasAttribute('title')) {
                    if (!el.hasAttribute('data-i18n-title-orig')) el.setAttribute('data-i18n-title-orig', el.getAttribute('title'));
                    var baseTitle = el.getAttribute('data-i18n-title-orig') || '';
                    var tTitle = translateText(baseTitle);
                    if (el.getAttribute('title') !== tTitle) el.setAttribute('title', tTitle);
                }
                if (el.hasAttribute('placeholder')) {
                    if (!el.hasAttribute('data-i18n-placeholder-orig')) el.setAttribute('data-i18n-placeholder-orig', el.getAttribute('placeholder'));
                    var basePh = el.getAttribute('data-i18n-placeholder-orig') || '';
                    var tPh = translateText(basePh);
                    if (el.getAttribute('placeholder') !== tPh) el.setAttribute('placeholder', tPh);
                }
            }

            // ── Step 4: data-tooltip attributes ──
            var tooltipEls = document.querySelectorAll('[data-tooltip]');
            for (var k = 0; k < tooltipEls.length; k++) {
                var tel = tooltipEls[k];
                if (!tel.hasAttribute('data-tooltip-orig')) tel.setAttribute('data-tooltip-orig', tel.getAttribute('data-tooltip'));
                var baseTooltip = tel.getAttribute('data-tooltip-orig') || '';
                var tTip = translateText(baseTooltip);
                if (tel.getAttribute('data-tooltip') !== tTip) tel.setAttribute('data-tooltip', tTip);
            }

            // ── Step 5: Chart.js canvas label translation ──
            // Only translate visible charts (offsetParent is null when display:none on element or ancestor)
            // Skip entirely on quick-mode passes (autoTranslateMissing callbacks) - charts already translated
            if (!quickMode && typeof Chart !== 'undefined' && Chart.getChart) {
                var chartIds = [
                    'changesChart','ridersSlabChart','partnerMovementTrendChart','partnerMovementQualityChart',
                    'manualAdjustChart','changesChart2','performanceChart','scaleChart','ridersSlabChartIncreased',
                    'ridersSlabChartDecreased',
                    'psAvgScaleChart','psCombinedRidersChart','psCombinedAvgScaleChart','psRidersBreakdownChart',
                    'psAvgScaleOverallChart','psTargetBarChart','psTargetNewOldChart','psVehicleChart',
                    // Monthly Insights tab charts
                    'monthlyTargetTrendChart','monthlyMoMChangeChartNew',
                    'vehicleMonthlyChart','vehicleCityChart','vehicleMonthlyT1Chart','vehicleMonthlyT2Chart',
                    'monthlyAvgScaleChart','monthlyPerformanceMixChart','monthlySizeMixChart',
                    'monthlyRidersPerformanceMixChart','monthlyRidersSizeMixChart',
                    'cityTargetTrendChart','cityPartnersChart','cityCombinedTrendChart',
                    'willingnessTrendChart','growthCategoryChart','decreaseCategoryChart',
                    // Month Overview tab charts
                    'cityWiseOverviewChart','cityWiseT1OverviewChart','cityWiseT2OverviewChart',
                    'cityWiseRangeChart','cityWiseTargetRangeChart',
                    'cityTierCityChart','cityTierBreakdownChart','cityTierBreakdownChartT1','cityTierBreakdownChartT2',
                    'cityTierPerformanceChart','cityTierPerformanceChartT1','cityTierPerformanceChartT2',
                    'cityTierScaleChart','cityTierScaleChartT1','cityTierScaleChartT2',
                    'partnersDataChart','tierPartnersChart'
                ];
                for (var ci = 0; ci < chartIds.length; ci++) {
                    var ctxEl = document.getElementById(chartIds[ci]);
                    if (!ctxEl) continue;
                    if (!ctxEl.offsetParent) continue; // skip charts in hidden tabs/panels
                    var chartInst = Chart.getChart(ctxEl);
                    if (!chartInst) continue;
                    var changed = false;
                    // Translate x/y axis labels array
                    if (chartInst.data && chartInst.data.labels) {
                        for (var li = 0; li < chartInst.data.labels.length; li++) {
                            var origLbl = chartInst.data.labels[li];
                            if (!origLbl) continue;
                            var origKey = 'chart-orig-lbl-' + ci + '-' + li;
                            if (!chartInst._i18nOrigLabels) chartInst._i18nOrigLabels = {};
                            if (!chartInst._i18nOrigLabels[li]) chartInst._i18nOrigLabels[li] = origLbl;
                            var newLbl = translateText(chartInst._i18nOrigLabels[li]);
                            if (chartInst.data.labels[li] !== newLbl) {
                                chartInst.data.labels[li] = newLbl;
                                changed = true;
                            }
                        }
                    }
                    // Translate dataset labels
                    if (chartInst.data && chartInst.data.datasets) {
                        for (var di = 0; di < chartInst.data.datasets.length; di++) {
                            var ds = chartInst.data.datasets[di];
                            if (!ds.label) continue;
                            if (!chartInst._i18nOrigDatasetLabels) chartInst._i18nOrigDatasetLabels = {};
                            if (!chartInst._i18nOrigDatasetLabels[di]) chartInst._i18nOrigDatasetLabels[di] = ds.label;
                            var newDsLabel = translateText(chartInst._i18nOrigDatasetLabels[di]);
                            if (ds.label !== newDsLabel) {
                                ds.label = newDsLabel;
                                changed = true;
                            }
                        }
                    }
                    // Translate chart title plugin text
                    try {
                        var titleOpts = chartInst.options && chartInst.options.plugins && chartInst.options.plugins.title;
                        if (titleOpts && titleOpts.text) {
                            if (!chartInst._i18nOrigTitleText) chartInst._i18nOrigTitleText = titleOpts.text;
                            var newTitle = translateText(chartInst._i18nOrigTitleText);
                            if (titleOpts.text !== newTitle) { titleOpts.text = newTitle; changed = true; }
                        }
                    } catch(e) {}
                    if (changed) {
                        try { chartInst.update('none'); } catch(e) {}
                    }
                }
            }
        } finally {
            isApplyingLanguage = false;
        }
    }

    function scheduleApplyLanguage() {
        if (applyLangTimer) clearTimeout(applyLangTimer);
        applyLangTimer = setTimeout(applyLanguageToDocument, 150);
    }

    function setLanguage(lang) {
        currentLang = (lang === 'zh') ? 'zh' : 'en';
        localStorage.setItem(LANG_STORAGE_KEY, currentLang);
        // Apply immediately then also schedule a follow-up for any dynamic content
        applyLanguageToDocument();
        scheduleApplyLanguage();
    }

    function initLanguageSelector() {
        if (document.getElementById('langSwitcherFixed')) return;
        var wrap = document.createElement('div');
        wrap.id = 'langSwitcherFixed';
        wrap.className = 'lang-switcher-fixed';

        var icon = document.createElement('span');
        icon.className = 'lang-switcher-icon';
        icon.textContent = '🌐';

        var select = document.createElement('select');
        select.className = 'lang-switcher-select';
        select.innerHTML = '<option value="en">English</option><option value="zh">简体中文</option>';
        select.value = currentLang;
        select.addEventListener('change', function() { setLanguage(this.value); });

        wrap.appendChild(icon);
        wrap.appendChild(select);
        document.body.appendChild(wrap);
    }

    // MutationObserver: re-apply on any DOM change when Chinese is active
    var observer = new MutationObserver(function(mutations) {
        if (currentLang !== 'en') {
            // Only schedule if actual content was added (not just attribute/text changes from our own translation)
            for (var m = 0; m < mutations.length; m++) {
                if (mutations[m].addedNodes && mutations[m].addedNodes.length > 0) {
                    scheduleApplyLanguage();
                    break;
                }
            }
        }
    });

    initLanguageSelector();
    applyLanguageToDocument();
    observer.observe(document.body, { childList: true, subtree: true });

    // Expose globals for use by switchTab and render functions
    window.dashboardSetLanguage = setLanguage;
    window.dashboardApplyLanguage = applyLanguageToDocument;
    window.dashboardScheduleLanguage = scheduleApplyLanguage;
    window._i18nT = translateText; // exposed for chart builders
    window.dashboardAddProperNouns = function(names) {
        if (!names) return;
        names.forEach(function(n) { if (n) _properNounSet.add(String(n).trim()); });
        _sortedKeys = null; // reset cache in case any name was in dict
    };
})();
</script>

</div></body>
</html>
